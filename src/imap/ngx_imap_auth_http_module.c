begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event_connect.h>
end_include

begin_include
include|#
directive|include
file|<ngx_imap.h>
end_include

begin_typedef
DECL|struct|__anon27b554870108
typedef|typedef
struct|struct
block|{
DECL|member|peers
name|ngx_peers_t
modifier|*
name|peers
decl_stmt|;
DECL|member|timeout
name|ngx_msec_t
name|timeout
decl_stmt|;
DECL|member|host_header
name|ngx_str_t
name|host_header
decl_stmt|;
DECL|member|uri
name|ngx_str_t
name|uri
decl_stmt|;
DECL|typedef|ngx_imap_auth_http_conf_t
block|}
name|ngx_imap_auth_http_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon27b554870208
typedef|typedef
struct|struct
block|{
DECL|member|request
name|ngx_buf_t
modifier|*
name|request
decl_stmt|;
DECL|member|peer
name|ngx_peer_connection_t
name|peer
decl_stmt|;
DECL|typedef|ngx_imap_auth_http_ctx_t
block|}
name|ngx_imap_auth_http_ctx_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|ngx_imap_auth_http_write_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_imap_auth_http_read_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_imap_auth_http_block_read
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_imap_auth_http_dummy_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_buf_t
modifier|*
name|ngx_imap_auth_http_create_request
parameter_list|(
name|ngx_imap_session_t
modifier|*
name|s
parameter_list|,
name|ngx_imap_auth_http_conf_t
modifier|*
name|ahcf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_imap_auth_http_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_imap_auth_http_merge_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_imap_auth_http
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_imap_auth_http_commands
specifier|static
name|ngx_command_t
name|ngx_imap_auth_http_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"auth_http"
argument_list|)
block|,
name|NGX_IMAP_MAIN_CONF
operator||
name|NGX_IMAP_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_imap_auth_http
block|,
name|NGX_IMAP_SRV_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"auth_http_timeout"
argument_list|)
block|,
name|NGX_IMAP_MAIN_CONF
operator||
name|NGX_IMAP_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_IMAP_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_imap_auth_http_conf_t
argument_list|,
name|timeout
argument_list|)
block|,
name|NULL
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_imap_auth_http_module_ctx
specifier|static
name|ngx_imap_module_t
name|ngx_imap_auth_http_module_ctx
init|=
block|{
name|NULL
block|,
comment|/* create main configuration */
name|NULL
block|,
comment|/* init main configuration */
name|ngx_imap_auth_http_create_conf
block|,
comment|/* create server configuration */
name|ngx_imap_auth_http_merge_conf
comment|/* merge server configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_imap_auth_http_module
name|ngx_module_t
name|ngx_imap_auth_http_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_imap_auth_http_module_ctx
block|,
comment|/* module context */
name|ngx_imap_auth_http_commands
block|,
comment|/* module directives */
name|NGX_IMAP_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init module */
name|NULL
comment|/* init process */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_imap_auth_http_protocol
specifier|static
name|char
modifier|*
name|ngx_imap_auth_http_protocol
index|[]
init|=
block|{
literal|"pop3"
block|,
literal|"imap"
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|ngx_imap_auth_http_init (ngx_imap_session_t * s)
name|ngx_imap_auth_http_init
parameter_list|(
name|ngx_imap_session_t
modifier|*
name|s
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_imap_auth_http_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_imap_auth_http_conf_t
modifier|*
name|ahcf
decl_stmt|;
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_imap_auth_http_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ngx_imap_close_connection
argument_list|(
name|s
operator|->
name|connection
argument_list|)
expr_stmt|;
return|return;
block|}
name|ahcf
operator|=
name|ngx_imap_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_imap_auth_http_module
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|request
operator|=
name|ngx_imap_auth_http_create_request
argument_list|(
name|s
argument_list|,
name|ahcf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|request
operator|==
name|NULL
condition|)
block|{
name|ngx_imap_close_connection
argument_list|(
name|s
operator|->
name|connection
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_imap_set_ctx
argument_list|(
name|s
argument_list|,
name|ctx
argument_list|,
name|ngx_imap_auth_http_module
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|peers
operator|=
name|ahcf
operator|->
name|peers
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|log
operator|=
name|s
operator|->
name|connection
operator|->
name|log
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|log_error
operator|=
name|NGX_ERROR_ERR
expr_stmt|;
name|rc
operator|=
name|ngx_event_connect_peer
argument_list|(
operator|&
name|ctx
operator|->
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_imap_close_connection
argument_list|(
name|s
operator|->
name|connection
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|data
operator|=
name|s
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|pool
operator|=
name|s
operator|->
name|connection
operator|->
name|pool
expr_stmt|;
name|s
operator|->
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_imap_auth_http_block_read
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_imap_auth_http_read_handler
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_imap_auth_http_write_handler
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
name|ngx_imap_auth_http_write_handler
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_add_timer
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
argument_list|,
name|ahcf
operator|->
name|timeout
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
name|ahcf
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_imap_auth_http_write_handler (ngx_event_t * wev)
name|ngx_imap_auth_http_write_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
block|{
name|ssize_t
name|n
decl_stmt|,
name|size
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_imap_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_imap_auth_http_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_imap_auth_http_conf_t
modifier|*
name|ahcf
decl_stmt|;
name|c
operator|=
name|wev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|ctx
operator|=
name|ngx_imap_get_module_ctx
argument_list|(
name|s
argument_list|,
name|ngx_imap_auth_http_module
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_IMAP
argument_list|,
name|wev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"imap auth http write handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|wev
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"auth http server timed out"
argument_list|)
expr_stmt|;
name|ngx_imap_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_imap_close_connection
argument_list|(
name|s
operator|->
name|connection
argument_list|)
expr_stmt|;
return|return;
block|}
name|size
operator|=
name|ctx
operator|->
name|request
operator|->
name|last
operator|-
name|ctx
operator|->
name|request
operator|->
name|pos
expr_stmt|;
name|n
operator|=
name|ngx_send
argument_list|(
name|c
argument_list|,
name|ctx
operator|->
name|request
operator|->
name|pos
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_imap_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_imap_close_connection
argument_list|(
name|s
operator|->
name|connection
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|ctx
operator|->
name|request
operator|->
name|pos
operator|+=
name|n
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|size
condition|)
block|{
name|wev
operator|->
name|handler
operator|=
name|ngx_imap_auth_http_dummy_handler
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|wev
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
if|if
condition|(
operator|!
name|wev
operator|->
name|timer_set
condition|)
block|{
name|ahcf
operator|=
name|ngx_imap_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_imap_auth_http_module
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|wev
argument_list|,
name|ahcf
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_imap_auth_http_read_handler (ngx_event_t * rev)
name|ngx_imap_auth_http_read_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ngx_peers_t
modifier|*
name|peers
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_imap_session_t
modifier|*
name|s
decl_stmt|;
if|#
directive|if
literal|0
block_content|ngx_imap_auth_http_ctx_t  *ctx;
endif|#
directive|endif
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
if|#
directive|if
literal|0
block_content|ctx = ngx_imap_get_module_ctx(s, ngx_imap_auth_http_module);
endif|#
directive|endif
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_IMAP
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"imap auth http read handler"
argument_list|)
expr_stmt|;
name|peers
operator|=
name|NULL
expr_stmt|;
name|ngx_imap_proxy_init
argument_list|(
name|s
argument_list|,
name|peers
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_imap_auth_http_block_read (ngx_event_t * rev)
name|ngx_imap_auth_http_block_read
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_imap_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_imap_auth_http_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_IMAP
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"imap auth http block read"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|ctx
operator|=
name|ngx_imap_get_module_ctx
argument_list|(
name|s
argument_list|,
name|ngx_imap_auth_http_module
argument_list|)
expr_stmt|;
name|ngx_imap_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_imap_close_connection
argument_list|(
name|s
operator|->
name|connection
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_imap_auth_http_dummy_handler (ngx_event_t * ev)
name|ngx_imap_auth_http_dummy_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_IMAP
argument_list|,
name|ev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"imap auth http dummy handler"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_buf_t
modifier|*
DECL|function|ngx_imap_auth_http_create_request (ngx_imap_session_t * s,ngx_imap_auth_http_conf_t * ahcf)
name|ngx_imap_auth_http_create_request
parameter_list|(
name|ngx_imap_session_t
modifier|*
name|s
parameter_list|,
name|ngx_imap_auth_http_conf_t
modifier|*
name|ahcf
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"GET "
argument_list|)
operator|-
literal|1
operator|+
name|ahcf
operator|->
name|uri
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
literal|" HTTP/1.0"
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Host: "
argument_list|)
operator|-
literal|1
operator|+
name|ahcf
operator|->
name|host_header
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-Method: plain"
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-User: "
argument_list|)
operator|-
literal|1
operator|+
name|s
operator|->
name|login
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-Pass: "
argument_list|)
operator|-
literal|1
operator|+
name|s
operator|->
name|passwd
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-Protocol: imap"
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Client-IP: "
argument_list|)
operator|-
literal|1
operator|+
name|s
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
expr_stmt|;
name|b
operator|=
name|ngx_create_temp_buf
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"GET "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"GET "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ahcf
operator|->
name|uri
operator|.
name|data
argument_list|,
name|ahcf
operator|->
name|uri
operator|.
name|len
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|" HTTP/1.0"
name|CRLF
argument_list|,
sizeof|sizeof
argument_list|(
literal|" HTTP/1.0"
name|CRLF
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Host: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Host: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ahcf
operator|->
name|host_header
operator|.
name|data
argument_list|,
name|ahcf
operator|->
name|host_header
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-Method: plain"
name|CRLF
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Method: plain"
name|CRLF
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-User: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-User: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|s
operator|->
name|login
operator|.
name|data
argument_list|,
name|s
operator|->
name|login
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-Pass: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Pass: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|s
operator|->
name|passwd
operator|.
name|data
argument_list|,
name|s
operator|->
name|passwd
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-Protocol: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Protocol: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ngx_imap_auth_http_protocol
index|[
name|s
operator|->
name|protocol
index|]
argument_list|,
sizeof|sizeof
argument_list|(
literal|"imap"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Client-IP: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Client-IP: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|s
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|data
argument_list|,
name|s
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
comment|/* add "\r\n" at the header end */
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
block|{
name|ngx_str_t
name|l
decl_stmt|;
name|l
operator|.
name|len
operator|=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|l
operator|.
name|data
operator|=
name|b
operator|->
name|pos
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"imap auth http header:\n\"%V\""
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_imap_auth_http_create_conf (ngx_conf_t * cf)
name|ngx_imap_auth_http_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_imap_auth_http_conf_t
modifier|*
name|ahcf
decl_stmt|;
name|ahcf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_imap_auth_http_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahcf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ahcf
operator|->
name|timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
return|return
name|ahcf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_imap_auth_http_merge_conf (ngx_conf_t * cf,void * parent,void * child)
name|ngx_imap_auth_http_merge_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
block|{
name|ngx_imap_auth_http_conf_t
modifier|*
name|prev
init|=
name|parent
decl_stmt|;
name|ngx_imap_auth_http_conf_t
modifier|*
name|conf
init|=
name|child
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|peers
operator|==
name|NULL
condition|)
block|{
name|conf
operator|->
name|peers
operator|=
name|prev
operator|->
name|peers
expr_stmt|;
name|conf
operator|->
name|host_header
operator|=
name|prev
operator|->
name|host_header
expr_stmt|;
name|conf
operator|->
name|uri
operator|=
name|prev
operator|->
name|uri
expr_stmt|;
block|}
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|timeout
argument_list|,
name|prev
operator|->
name|timeout
argument_list|,
literal|60000
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_imap_auth_http (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_imap_auth_http
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_imap_auth_http_conf_t
modifier|*
name|ahcf
init|=
name|conf
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|,
modifier|*
name|url
decl_stmt|;
name|ngx_inet_upstream_t
name|inet_upstream
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_UNIX_DOMAIN
operator|)
name|ngx_unix_domain_upstream_t
name|unix_upstream
decl_stmt|;
endif|#
directive|endif
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|url
operator|=
operator|&
name|value
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|ngx_strncasecmp
argument_list|(
name|url
operator|->
name|data
argument_list|,
literal|"unix:"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HAVE_UNIX_DOMAIN
operator|)
name|ngx_memzero
argument_list|(
operator|&
name|unix_upstream
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_unix_domain_upstream_t
argument_list|)
argument_list|)
expr_stmt|;
name|unix_upstream
operator|.
name|name
operator|=
operator|*
name|url
expr_stmt|;
name|unix_upstream
operator|.
name|url
operator|=
operator|*
name|url
expr_stmt|;
name|unix_upstream
operator|.
name|uri_part
operator|=
literal|1
expr_stmt|;
name|ahcf
operator|->
name|peers
operator|=
name|ngx_unix_upstream_parse
argument_list|(
name|cf
argument_list|,
operator|&
name|unix_upstream
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahcf
operator|->
name|peers
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ahcf
operator|->
name|peers
operator|->
name|peer
index|[
literal|0
index|]
operator|.
name|uri_separator
operator|=
literal|":"
expr_stmt|;
name|ahcf
operator|->
name|host_header
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"localhost"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|ahcf
operator|->
name|host_header
operator|.
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"localhost"
expr_stmt|;
name|ahcf
operator|->
name|uri
operator|=
name|unix_upstream
operator|.
name|uri
expr_stmt|;
else|#
directive|else
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the unix domain sockets are not supported "
literal|"on this platform"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
endif|#
directive|endif
block|}
else|else
block|{
name|ngx_memzero
argument_list|(
operator|&
name|inet_upstream
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_inet_upstream_t
argument_list|)
argument_list|)
expr_stmt|;
name|inet_upstream
operator|.
name|name
operator|=
operator|*
name|url
expr_stmt|;
name|inet_upstream
operator|.
name|url
operator|=
operator|*
name|url
expr_stmt|;
name|inet_upstream
operator|.
name|default_port_value
operator|=
literal|80
expr_stmt|;
name|inet_upstream
operator|.
name|uri_part
operator|=
literal|1
expr_stmt|;
name|ahcf
operator|->
name|peers
operator|=
name|ngx_inet_upstream_parse
argument_list|(
name|cf
argument_list|,
operator|&
name|inet_upstream
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahcf
operator|->
name|peers
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ahcf
operator|->
name|peers
operator|->
name|number
condition|;
name|i
operator|++
control|)
block|{
name|ahcf
operator|->
name|peers
operator|->
name|peer
index|[
name|i
index|]
operator|.
name|uri_separator
operator|=
literal|":"
expr_stmt|;
block|}
name|ahcf
operator|->
name|host_header
operator|=
name|inet_upstream
operator|.
name|host_header
expr_stmt|;
name|ahcf
operator|->
name|uri
operator|=
name|inet_upstream
operator|.
name|uri
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

end_unit

