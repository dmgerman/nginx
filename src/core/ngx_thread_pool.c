begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Nginx, Inc.  * Copyright (C) Valentin V. Bartenev  * Copyright (C) Ruslan Ermilov  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_thread_pool.h>
end_include

begin_typedef
DECL|struct|__anon29b016250108
typedef|typedef
struct|struct
block|{
DECL|member|pools
name|ngx_array_t
name|pools
decl_stmt|;
DECL|typedef|ngx_thread_pool_conf_t
block|}
name|ngx_thread_pool_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29b016250208
typedef|typedef
struct|struct
block|{
DECL|member|first
name|ngx_thread_task_t
modifier|*
name|first
decl_stmt|;
DECL|member|last
name|ngx_thread_task_t
modifier|*
modifier|*
name|last
decl_stmt|;
DECL|typedef|ngx_thread_pool_queue_t
block|}
name|ngx_thread_pool_queue_t
typedef|;
end_typedef

begin_define
DECL|macro|ngx_thread_pool_queue_init (q)
define|#
directive|define
name|ngx_thread_pool_queue_init
parameter_list|(
name|q
parameter_list|)
define|\
value|(q)->first = NULL;                                                        \     (q)->last =&(q)->first
end_define

begin_struct
DECL|struct|ngx_thread_pool_s
struct|struct
name|ngx_thread_pool_s
block|{
DECL|member|mtx
name|ngx_thread_mutex_t
name|mtx
decl_stmt|;
DECL|member|queue
name|ngx_thread_pool_queue_t
name|queue
decl_stmt|;
DECL|member|waiting
name|ngx_int_t
name|waiting
decl_stmt|;
DECL|member|cond
name|ngx_thread_cond_t
name|cond
decl_stmt|;
DECL|member|log
name|ngx_log_t
modifier|*
name|log
decl_stmt|;
DECL|member|name
name|ngx_str_t
name|name
decl_stmt|;
DECL|member|threads
name|ngx_uint_t
name|threads
decl_stmt|;
DECL|member|max_queue
name|ngx_int_t
name|max_queue
decl_stmt|;
DECL|member|file
name|u_char
modifier|*
name|file
decl_stmt|;
DECL|member|line
name|ngx_uint_t
name|line
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_thread_pool_init
parameter_list|(
name|ngx_thread_pool_t
modifier|*
name|tp
parameter_list|,
name|ngx_log_t
modifier|*
name|log
parameter_list|,
name|ngx_pool_t
modifier|*
name|pool
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_thread_pool_destroy
parameter_list|(
name|ngx_thread_pool_t
modifier|*
name|tp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_thread_pool_exit_handler
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|ngx_log_t
modifier|*
name|log
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_thread_pool_cycle
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_thread_pool_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_thread_pool
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_thread_pool_create_conf
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_thread_pool_init_conf
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_thread_pool_init_worker
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_thread_pool_exit_worker
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_thread_pool_commands
specifier|static
name|ngx_command_t
name|ngx_thread_pool_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"thread_pool"
argument_list|)
block|,
name|NGX_MAIN_CONF
operator||
name|NGX_DIRECT_CONF
operator||
name|NGX_CONF_TAKE23
block|,
name|ngx_thread_pool
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_thread_pool_module_ctx
specifier|static
name|ngx_core_module_t
name|ngx_thread_pool_module_ctx
init|=
block|{
name|ngx_string
argument_list|(
literal|"thread_pool"
argument_list|)
block|,
name|ngx_thread_pool_create_conf
block|,
name|ngx_thread_pool_init_conf
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_thread_pool_module
name|ngx_module_t
name|ngx_thread_pool_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_thread_pool_module_ctx
block|,
comment|/* module context */
name|ngx_thread_pool_commands
block|,
comment|/* module directives */
name|NGX_CORE_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|ngx_thread_pool_init_worker
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|ngx_thread_pool_exit_worker
block|,
comment|/* exit process */
name|NULL
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_thread_pool_default
specifier|static
name|ngx_str_t
name|ngx_thread_pool_default
init|=
name|ngx_string
argument_list|(
literal|"default"
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_thread_pool_task_id
specifier|static
name|ngx_uint_t
name|ngx_thread_pool_task_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_thread_pool_done_lock
specifier|static
name|ngx_atomic_t
name|ngx_thread_pool_done_lock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_thread_pool_done
specifier|static
name|ngx_thread_pool_queue_t
name|ngx_thread_pool_done
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_thread_pool_init (ngx_thread_pool_t * tp,ngx_log_t * log,ngx_pool_t * pool)
name|ngx_thread_pool_init
parameter_list|(
name|ngx_thread_pool_t
modifier|*
name|tp
parameter_list|,
name|ngx_log_t
modifier|*
name|log
parameter_list|,
name|ngx_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|pthread_t
name|tid
decl_stmt|;
name|ngx_uint_t
name|n
decl_stmt|;
name|pthread_attr_t
name|attr
decl_stmt|;
if|if
condition|(
name|ngx_notify
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
literal|0
argument_list|,
literal|"the configured event method cannot be used with thread pools"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_thread_pool_queue_init
argument_list|(
operator|&
name|tp
operator|->
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_thread_mutex_create
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_thread_cond_create
argument_list|(
operator|&
name|tp
operator|->
name|cond
argument_list|,
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_thread_mutex_destroy
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|log
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|tp
operator|->
name|log
operator|=
name|log
expr_stmt|;
name|err
operator|=
name|pthread_attr_init
argument_list|(
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|err
argument_list|,
literal|"pthread_attr_init() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|#
directive|if
literal|0
block_content|err = pthread_attr_setstacksize(&attr, PTHREAD_STACK_MIN);     if (err) {         ngx_log_error(NGX_LOG_ALERT, log, err,                       "pthread_attr_setstacksize() failed");         return NGX_ERROR;     }
endif|#
directive|endif
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|tp
operator|->
name|threads
condition|;
name|n
operator|++
control|)
block|{
name|err
operator|=
name|pthread_create
argument_list|(
operator|&
name|tid
argument_list|,
operator|&
name|attr
argument_list|,
name|ngx_thread_pool_cycle
argument_list|,
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|err
argument_list|,
literal|"pthread_create() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
operator|(
name|void
operator|)
name|pthread_attr_destroy
argument_list|(
operator|&
name|attr
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_thread_pool_destroy (ngx_thread_pool_t * tp)
name|ngx_thread_pool_destroy
parameter_list|(
name|ngx_thread_pool_t
modifier|*
name|tp
parameter_list|)
block|{
name|ngx_uint_t
name|n
decl_stmt|;
name|ngx_thread_task_t
name|task
decl_stmt|;
specifier|volatile
name|ngx_uint_t
name|lock
decl_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|task
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_thread_task_t
argument_list|)
argument_list|)
expr_stmt|;
name|task
operator|.
name|handler
operator|=
name|ngx_thread_pool_exit_handler
expr_stmt|;
name|task
operator|.
name|ctx
operator|=
operator|(
name|void
operator|*
operator|)
operator|&
name|lock
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|tp
operator|->
name|threads
condition|;
name|n
operator|++
control|)
block|{
name|lock
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_thread_task_post
argument_list|(
name|tp
argument_list|,
operator|&
name|task
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return;
block|}
while|while
condition|(
name|lock
condition|)
block|{
name|ngx_sched_yield
argument_list|()
expr_stmt|;
block|}
name|task
operator|.
name|event
operator|.
name|active
operator|=
literal|0
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|ngx_thread_cond_destroy
argument_list|(
operator|&
name|tp
operator|->
name|cond
argument_list|,
name|tp
operator|->
name|log
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_thread_mutex_destroy
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_thread_pool_exit_handler (void * data,ngx_log_t * log)
name|ngx_thread_pool_exit_handler
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|ngx_log_t
modifier|*
name|log
parameter_list|)
block|{
name|ngx_uint_t
modifier|*
name|lock
init|=
name|data
decl_stmt|;
operator|*
name|lock
operator|=
literal|0
expr_stmt|;
name|pthread_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ngx_thread_task_t
modifier|*
DECL|function|ngx_thread_task_alloc (ngx_pool_t * pool,size_t size)
name|ngx_thread_task_alloc
parameter_list|(
name|ngx_pool_t
modifier|*
name|pool
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|ngx_thread_task_t
modifier|*
name|task
decl_stmt|;
name|task
operator|=
name|ngx_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_thread_task_t
argument_list|)
operator|+
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|task
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|task
operator|->
name|ctx
operator|=
name|task
operator|+
literal|1
expr_stmt|;
return|return
name|task
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_thread_task_post (ngx_thread_pool_t * tp,ngx_thread_task_t * task)
name|ngx_thread_task_post
parameter_list|(
name|ngx_thread_pool_t
modifier|*
name|tp
parameter_list|,
name|ngx_thread_task_t
modifier|*
name|task
parameter_list|)
block|{
if|if
condition|(
name|task
operator|->
name|event
operator|.
name|active
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|tp
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"task #%ui already active"
argument_list|,
name|task
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_thread_mutex_lock
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|tp
operator|->
name|waiting
operator|>=
name|tp
operator|->
name|max_queue
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_thread_mutex_unlock
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|tp
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"thread pool \"%V\" queue overflow: %i tasks waiting"
argument_list|,
operator|&
name|tp
operator|->
name|name
argument_list|,
name|tp
operator|->
name|waiting
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|task
operator|->
name|event
operator|.
name|active
operator|=
literal|1
expr_stmt|;
name|task
operator|->
name|id
operator|=
name|ngx_thread_pool_task_id
operator|++
expr_stmt|;
name|task
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ngx_thread_cond_signal
argument_list|(
operator|&
name|tp
operator|->
name|cond
argument_list|,
name|tp
operator|->
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_thread_mutex_unlock
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|tp
operator|->
name|queue
operator|.
name|last
operator|=
name|task
expr_stmt|;
name|tp
operator|->
name|queue
operator|.
name|last
operator|=
operator|&
name|task
operator|->
name|next
expr_stmt|;
name|tp
operator|->
name|waiting
operator|++
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_thread_mutex_unlock
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_CORE
argument_list|,
name|tp
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"task #%ui added to thread pool \"%V\""
argument_list|,
name|task
operator|->
name|id
argument_list|,
operator|&
name|tp
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_thread_pool_cycle (void * data)
name|ngx_thread_pool_cycle
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_thread_pool_t
modifier|*
name|tp
init|=
name|data
decl_stmt|;
name|int
name|err
decl_stmt|;
name|sigset_t
name|set
decl_stmt|;
name|ngx_thread_task_t
modifier|*
name|task
decl_stmt|;
if|#
directive|if
literal|0
block_content|ngx_time_update();
endif|#
directive|endif
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_CORE
argument_list|,
name|tp
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"thread in pool \"%V\" started"
argument_list|,
operator|&
name|tp
operator|->
name|name
argument_list|)
expr_stmt|;
name|sigfillset
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|sigdelset
argument_list|(
operator|&
name|set
argument_list|,
name|SIGILL
argument_list|)
expr_stmt|;
name|sigdelset
argument_list|(
operator|&
name|set
argument_list|,
name|SIGFPE
argument_list|)
expr_stmt|;
name|sigdelset
argument_list|(
operator|&
name|set
argument_list|,
name|SIGSEGV
argument_list|)
expr_stmt|;
name|sigdelset
argument_list|(
operator|&
name|set
argument_list|,
name|SIGBUS
argument_list|)
expr_stmt|;
name|err
operator|=
name|pthread_sigmask
argument_list|(
name|SIG_BLOCK
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|tp
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"pthread_sigmask() failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|ngx_thread_mutex_lock
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* the number may become negative */
name|tp
operator|->
name|waiting
operator|--
expr_stmt|;
while|while
condition|(
name|tp
operator|->
name|queue
operator|.
name|first
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_thread_cond_wait
argument_list|(
operator|&
name|tp
operator|->
name|cond
argument_list|,
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_thread_mutex_unlock
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|task
operator|=
name|tp
operator|->
name|queue
operator|.
name|first
expr_stmt|;
name|tp
operator|->
name|queue
operator|.
name|first
operator|=
name|task
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|queue
operator|.
name|first
operator|==
name|NULL
condition|)
block|{
name|tp
operator|->
name|queue
operator|.
name|last
operator|=
operator|&
name|tp
operator|->
name|queue
operator|.
name|first
expr_stmt|;
block|}
if|if
condition|(
name|ngx_thread_mutex_unlock
argument_list|(
operator|&
name|tp
operator|->
name|mtx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|#
directive|if
literal|0
block_content|ngx_time_update();
endif|#
directive|endif
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_CORE
argument_list|,
name|tp
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"run task #%ui in thread pool \"%V\""
argument_list|,
name|task
operator|->
name|id
argument_list|,
operator|&
name|tp
operator|->
name|name
argument_list|)
expr_stmt|;
name|task
operator|->
name|handler
argument_list|(
name|task
operator|->
name|ctx
argument_list|,
name|tp
operator|->
name|log
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_CORE
argument_list|,
name|tp
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"complete task #%ui in thread pool \"%V\""
argument_list|,
name|task
operator|->
name|id
argument_list|,
operator|&
name|tp
operator|->
name|name
argument_list|)
expr_stmt|;
name|task
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|ngx_spinlock
argument_list|(
operator|&
name|ngx_thread_pool_done_lock
argument_list|,
literal|1
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
operator|*
name|ngx_thread_pool_done
operator|.
name|last
operator|=
name|task
expr_stmt|;
name|ngx_thread_pool_done
operator|.
name|last
operator|=
operator|&
name|task
operator|->
name|next
expr_stmt|;
name|ngx_memory_barrier
argument_list|()
expr_stmt|;
name|ngx_unlock
argument_list|(
operator|&
name|ngx_thread_pool_done_lock
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_notify
argument_list|(
name|ngx_thread_pool_handler
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_thread_pool_handler (ngx_event_t * ev)
name|ngx_thread_pool_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_event_t
modifier|*
name|event
decl_stmt|;
name|ngx_thread_task_t
modifier|*
name|task
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_CORE
argument_list|,
name|ev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"thread pool handler"
argument_list|)
expr_stmt|;
name|ngx_spinlock
argument_list|(
operator|&
name|ngx_thread_pool_done_lock
argument_list|,
literal|1
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|task
operator|=
name|ngx_thread_pool_done
operator|.
name|first
expr_stmt|;
name|ngx_thread_pool_done
operator|.
name|first
operator|=
name|NULL
expr_stmt|;
name|ngx_thread_pool_done
operator|.
name|last
operator|=
operator|&
name|ngx_thread_pool_done
operator|.
name|first
expr_stmt|;
name|ngx_memory_barrier
argument_list|()
expr_stmt|;
name|ngx_unlock
argument_list|(
operator|&
name|ngx_thread_pool_done_lock
argument_list|)
expr_stmt|;
while|while
condition|(
name|task
condition|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_CORE
argument_list|,
name|ev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"run completion handler for task #%ui"
argument_list|,
name|task
operator|->
name|id
argument_list|)
expr_stmt|;
name|event
operator|=
operator|&
name|task
operator|->
name|event
expr_stmt|;
name|task
operator|=
name|task
operator|->
name|next
expr_stmt|;
name|event
operator|->
name|complete
operator|=
literal|1
expr_stmt|;
name|event
operator|->
name|active
operator|=
literal|0
expr_stmt|;
name|event
operator|->
name|handler
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_thread_pool_create_conf (ngx_cycle_t * cycle)
name|ngx_thread_pool_create_conf
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
block|{
name|ngx_thread_pool_conf_t
modifier|*
name|tcf
decl_stmt|;
name|tcf
operator|=
name|ngx_pcalloc
argument_list|(
name|cycle
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_thread_pool_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|tcf
operator|->
name|pools
argument_list|,
name|cycle
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_thread_pool_t
operator|*
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|tcf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_thread_pool_init_conf (ngx_cycle_t * cycle,void * conf)
name|ngx_thread_pool_init_conf
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_thread_pool_conf_t
modifier|*
name|tcf
init|=
name|conf
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_thread_pool_t
modifier|*
modifier|*
name|tpp
decl_stmt|;
name|tpp
operator|=
name|tcf
operator|->
name|pools
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tcf
operator|->
name|pools
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tpp
index|[
name|i
index|]
operator|->
name|threads
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|tpp
index|[
name|i
index|]
operator|->
name|name
operator|.
name|len
operator|==
name|ngx_thread_pool_default
operator|.
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|tpp
index|[
name|i
index|]
operator|->
name|name
operator|.
name|data
argument_list|,
name|ngx_thread_pool_default
operator|.
name|data
argument_list|,
name|ngx_thread_pool_default
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tpp
index|[
name|i
index|]
operator|->
name|threads
operator|=
literal|32
expr_stmt|;
name|tpp
index|[
name|i
index|]
operator|->
name|max_queue
operator|=
literal|65536
expr_stmt|;
continue|continue;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown thread pool \"%V\" in %s:%ui"
argument_list|,
operator|&
name|tpp
index|[
name|i
index|]
operator|->
name|name
argument_list|,
name|tpp
index|[
name|i
index|]
operator|->
name|file
argument_list|,
name|tpp
index|[
name|i
index|]
operator|->
name|line
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_thread_pool (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_thread_pool
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_thread_pool_t
modifier|*
name|tp
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|tp
operator|=
name|ngx_thread_pool_add
argument_list|(
name|cf
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|tp
operator|->
name|threads
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate thread pool \"%V\""
argument_list|,
operator|&
name|tp
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|tp
operator|->
name|max_queue
operator|=
literal|65536
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|cf
operator|->
name|args
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"threads="
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|threads
operator|=
name|ngx_atoi
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|8
argument_list|,
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|threads
operator|==
operator|(
name|ngx_uint_t
operator|)
name|NGX_ERROR
operator|||
name|tp
operator|->
name|threads
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid threads value \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"max_queue="
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tp
operator|->
name|max_queue
operator|=
name|ngx_atoi
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|10
argument_list|,
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|->
name|max_queue
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid max_queue value \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
continue|continue;
block|}
block|}
if|if
condition|(
name|tp
operator|->
name|threads
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"\"%V\" must have \"threads\" parameter"
argument_list|,
operator|&
name|cmd
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
name|ngx_thread_pool_t
modifier|*
DECL|function|ngx_thread_pool_add (ngx_conf_t * cf,ngx_str_t * name)
name|ngx_thread_pool_add
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|)
block|{
name|ngx_thread_pool_t
modifier|*
name|tp
decl_stmt|,
modifier|*
modifier|*
name|tpp
decl_stmt|;
name|ngx_thread_pool_conf_t
modifier|*
name|tcf
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|name
operator|=
operator|&
name|ngx_thread_pool_default
expr_stmt|;
block|}
name|tp
operator|=
name|ngx_thread_pool_get
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
condition|)
block|{
return|return
name|tp
return|;
block|}
name|tp
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_thread_pool_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|tp
operator|->
name|name
operator|=
operator|*
name|name
expr_stmt|;
name|tp
operator|->
name|file
operator|=
name|cf
operator|->
name|conf_file
operator|->
name|file
operator|.
name|name
operator|.
name|data
expr_stmt|;
name|tp
operator|->
name|line
operator|=
name|cf
operator|->
name|conf_file
operator|->
name|line
expr_stmt|;
name|tcf
operator|=
operator|(
name|ngx_thread_pool_conf_t
operator|*
operator|)
name|ngx_get_conf
argument_list|(
name|cf
operator|->
name|cycle
operator|->
name|conf_ctx
argument_list|,
name|ngx_thread_pool_module
argument_list|)
expr_stmt|;
name|tpp
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|tcf
operator|->
name|pools
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpp
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
operator|*
name|tpp
operator|=
name|tp
expr_stmt|;
return|return
name|tp
return|;
block|}
end_function

begin_function
name|ngx_thread_pool_t
modifier|*
DECL|function|ngx_thread_pool_get (ngx_cycle_t * cycle,ngx_str_t * name)
name|ngx_thread_pool_get
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_thread_pool_t
modifier|*
modifier|*
name|tpp
decl_stmt|;
name|ngx_thread_pool_conf_t
modifier|*
name|tcf
decl_stmt|;
name|tcf
operator|=
operator|(
name|ngx_thread_pool_conf_t
operator|*
operator|)
name|ngx_get_conf
argument_list|(
name|cycle
operator|->
name|conf_ctx
argument_list|,
name|ngx_thread_pool_module
argument_list|)
expr_stmt|;
name|tpp
operator|=
name|tcf
operator|->
name|pools
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tcf
operator|->
name|pools
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tpp
index|[
name|i
index|]
operator|->
name|name
operator|.
name|len
operator|==
name|name
operator|->
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|tpp
index|[
name|i
index|]
operator|->
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|tpp
index|[
name|i
index|]
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_thread_pool_init_worker (ngx_cycle_t * cycle)
name|ngx_thread_pool_init_worker
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_thread_pool_t
modifier|*
modifier|*
name|tpp
decl_stmt|;
name|ngx_thread_pool_conf_t
modifier|*
name|tcf
decl_stmt|;
if|if
condition|(
name|ngx_process
operator|!=
name|NGX_PROCESS_WORKER
operator|&&
name|ngx_process
operator|!=
name|NGX_PROCESS_SINGLE
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|tcf
operator|=
operator|(
name|ngx_thread_pool_conf_t
operator|*
operator|)
name|ngx_get_conf
argument_list|(
name|cycle
operator|->
name|conf_ctx
argument_list|,
name|ngx_thread_pool_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|ngx_thread_pool_queue_init
argument_list|(
operator|&
name|ngx_thread_pool_done
argument_list|)
expr_stmt|;
name|tpp
operator|=
name|tcf
operator|->
name|pools
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tcf
operator|->
name|pools
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_thread_pool_init
argument_list|(
name|tpp
index|[
name|i
index|]
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
name|cycle
operator|->
name|pool
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_thread_pool_exit_worker (ngx_cycle_t * cycle)
name|ngx_thread_pool_exit_worker
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_thread_pool_t
modifier|*
modifier|*
name|tpp
decl_stmt|;
name|ngx_thread_pool_conf_t
modifier|*
name|tcf
decl_stmt|;
if|if
condition|(
name|ngx_process
operator|!=
name|NGX_PROCESS_WORKER
operator|&&
name|ngx_process
operator|!=
name|NGX_PROCESS_SINGLE
condition|)
block|{
return|return;
block|}
name|tcf
operator|=
operator|(
name|ngx_thread_pool_conf_t
operator|*
operator|)
name|ngx_get_conf
argument_list|(
name|cycle
operator|->
name|conf_ctx
argument_list|,
name|ngx_thread_pool_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcf
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|tpp
operator|=
name|tcf
operator|->
name|pools
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tcf
operator|->
name|pools
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|ngx_thread_pool_destroy
argument_list|(
name|tpp
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit

