begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_function
DECL|function|ngx_sprint_uchar (u_char * text,u_char c,size_t len)
name|ngx_inline
specifier|static
name|size_t
name|ngx_sprint_uchar
parameter_list|(
name|u_char
modifier|*
name|text
parameter_list|,
name|u_char
name|c
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|n
decl_stmt|;
name|ngx_uint_t
name|c1
decl_stmt|,
name|c2
decl_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
return|return
name|n
return|;
block|}
name|c1
operator|=
name|c
operator|/
literal|100
expr_stmt|;
if|if
condition|(
name|c1
condition|)
block|{
operator|*
name|text
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
name|c1
operator|+
literal|'0'
operator|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
return|return
name|n
return|;
block|}
block|}
name|c2
operator|=
operator|(
name|c
operator|%
literal|100
operator|)
operator|/
literal|10
expr_stmt|;
if|if
condition|(
name|c1
operator|||
name|c2
condition|)
block|{
operator|*
name|text
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
name|c2
operator|+
literal|'0'
operator|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
return|return
name|n
return|;
block|}
block|}
name|c2
operator|=
name|c
operator|%
literal|10
expr_stmt|;
operator|*
name|text
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
name|c2
operator|+
literal|'0'
operator|)
expr_stmt|;
name|n
operator|++
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_comment
comment|/* AF_INET only */
end_comment

begin_function
DECL|function|ngx_sock_ntop (int family,struct sockaddr * addr,u_char * text,size_t len)
name|size_t
name|ngx_sock_ntop
parameter_list|(
name|int
name|family
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|u_char
modifier|*
name|text
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|n
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|addr_in
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|family
operator|!=
name|AF_INET
condition|)
block|{
return|return
literal|0
return|;
block|}
name|addr_in
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
expr_stmt|;
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|addr_in
operator|->
name|sin_addr
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|INET_ADDRSTRLEN
condition|)
block|{
name|len
operator|=
name|INET_ADDRSTRLEN
expr_stmt|;
block|}
name|n
operator|=
name|ngx_sprint_uchar
argument_list|(
name|text
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
do|do
block|{
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
name|text
index|[
name|n
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n
return|;
block|}
name|text
index|[
name|n
operator|++
index|]
operator|=
literal|'.'
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
name|text
index|[
name|n
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n
return|;
block|}
name|n
operator|+=
name|ngx_sprint_uchar
argument_list|(
operator|&
name|text
index|[
name|n
index|]
argument_list|,
name|p
index|[
name|i
operator|++
index|]
argument_list|,
name|len
operator|-
name|n
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|<
literal|4
condition|)
do|;
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
name|text
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n
return|;
block|}
name|text
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n
return|;
if|#
directive|if
literal|0
block_content|return ngx_snprintf((char *) text,                         len> INET_ADDRSTRLEN ? INET_ADDRSTRLEN : len,                         "%u.%u.%u.%u", p[0], p[1], p[2], p[3]);
endif|#
directive|endif
block|}
end_function

begin_function
DECL|function|ngx_inet_ntop (int family,void * addr,u_char * text,size_t len)
name|size_t
name|ngx_inet_ntop
parameter_list|(
name|int
name|family
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|u_char
modifier|*
name|text
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|n
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|family
operator|!=
name|AF_INET
condition|)
block|{
return|return
literal|0
return|;
block|}
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|addr
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|INET_ADDRSTRLEN
condition|)
block|{
name|len
operator|=
name|INET_ADDRSTRLEN
expr_stmt|;
block|}
name|n
operator|=
name|ngx_sprint_uchar
argument_list|(
name|text
argument_list|,
name|p
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
do|do
block|{
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
name|text
index|[
name|n
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n
return|;
block|}
name|text
index|[
name|n
operator|++
index|]
operator|=
literal|'.'
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
name|text
index|[
name|n
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n
return|;
block|}
name|n
operator|+=
name|ngx_sprint_uchar
argument_list|(
operator|&
name|text
index|[
name|n
index|]
argument_list|,
name|p
index|[
name|i
operator|++
index|]
argument_list|,
name|len
operator|-
name|n
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|<
literal|4
condition|)
do|;
if|if
condition|(
name|len
operator|==
name|n
condition|)
block|{
name|text
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n
return|;
block|}
name|text
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|n
return|;
if|#
directive|if
literal|0
block_content|return ngx_snprintf((char *) text,                         len> INET_ADDRSTRLEN ? INET_ADDRSTRLEN : len,                         "%u.%u.%u.%u", p[0], p[1], p[2], p[3]);
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* AF_INET only */
end_comment

begin_function
DECL|function|ngx_ptocidr (ngx_str_t * text,void * cidr)
name|ngx_int_t
name|ngx_ptocidr
parameter_list|(
name|ngx_str_t
modifier|*
name|text
parameter_list|,
name|void
modifier|*
name|cidr
parameter_list|)
block|{
name|ngx_int_t
name|m
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_inet_cidr_t
modifier|*
name|in_cidr
decl_stmt|;
name|in_cidr
operator|=
name|cidr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|text
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|text
operator|->
name|data
index|[
name|i
index|]
operator|==
literal|'/'
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|text
operator|->
name|len
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|text
operator|->
name|data
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|in_cidr
operator|->
name|addr
operator|=
name|inet_addr
argument_list|(
operator|(
name|char
operator|*
operator|)
name|text
operator|->
name|data
argument_list|)
expr_stmt|;
name|text
operator|->
name|data
index|[
name|i
index|]
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
name|in_cidr
operator|->
name|addr
operator|==
name|INADDR_NONE
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|m
operator|=
name|ngx_atoi
argument_list|(
operator|&
name|text
operator|->
name|data
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|text
operator|->
name|len
operator|-
operator|(
name|i
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|m
operator|==
literal|0
condition|)
block|{
comment|/* the x86 compilers use the shl instruction that shifts by modulo 32 */
name|in_cidr
operator|->
name|mask
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|in_cidr
operator|->
name|mask
operator|=
name|htonl
argument_list|(
operator|(
name|ngx_uint_t
operator|)
operator|(
literal|0
operator|-
operator|(
literal|1
operator|<<
operator|(
literal|32
operator|-
name|m
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|ngx_int_t ngx_inet_addr_port(ngx_conf_t *cf, ngx_command_t *cmd,                              ngx_str_t *addr_port) {     u_char          *host;     ngx_int_t        port;     ngx_uint_t       p;     struct hostent  *h;      for (p = 0; p< addr_port->len; p++) {         if (addr_port->data[p] == ':') {             break;         }     }      in_addr->host.len = p;     if (!(in_addr->host.data = ngx_palloc(pool, p + 1))) {         return NGX_ERROR;     }      ngx_cpystrn(in_addr->host.data, addr_port->data, p + 1);      if (p == addr_port->len) {         p = 0;     }      port = ngx_atoi(&addr[p], args[1].len - p);     if (port == NGX_ERROR&& p == 0) {
comment|/* default port */
end_comment

begin_comment
unit|iap->port = 0;      } else if ((port == NGX_ERROR&& p != 0)
comment|/* "listen host:NONNUMBER" */
end_comment

begin_comment
unit||| (port< 1 || port> 65536)) {
comment|/* "listen 99999" */
end_comment

begin_endif
unit|ngx_conf_log_error(NGX_LOG_EMERG, cf, 0,                            "invalid port \"%s\" in \"%s\" directive, "                            "it must be a number between 1 and 65535",&addr[p], cmd->name.data);          return NGX_CONF_ERROR;      } else if (p == 0) {         ls->addr = INADDR_ANY;         ls->port = (in_port_t) port;         return NGX_CONF_OK;     }      return NGX_OK; }
endif|#
directive|endif
end_endif

end_unit

