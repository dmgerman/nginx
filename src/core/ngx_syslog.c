begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Nginx, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event.h>
end_include

begin_define
DECL|macro|NGX_SYSLOG_MAX_STR
define|#
directive|define
name|NGX_SYSLOG_MAX_STR
define|\
value|NGX_MAX_ERROR_STR + sizeof("<255>Jan 01 00:00:00 ") - 1                  \      + (NGX_MAXHOSTNAMELEN - 1) + 1
comment|/* space */
value|\      + 32
comment|/* tag */
value|+ 2
end_define

begin_comment
comment|/* colon, space */
end_comment

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_syslog_parse_args
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_syslog_peer_t
modifier|*
name|peer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_syslog_init_peer
parameter_list|(
name|ngx_syslog_peer_t
modifier|*
name|peer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_syslog_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|facilities
specifier|static
name|char
modifier|*
name|facilities
index|[]
init|=
block|{
literal|"kern"
block|,
literal|"user"
block|,
literal|"mail"
block|,
literal|"daemon"
block|,
literal|"auth"
block|,
literal|"intern"
block|,
literal|"lpr"
block|,
literal|"news"
block|,
literal|"uucp"
block|,
literal|"clock"
block|,
literal|"authpriv"
block|,
literal|"ftp"
block|,
literal|"ntp"
block|,
literal|"audit"
block|,
literal|"alert"
block|,
literal|"cron"
block|,
literal|"local0"
block|,
literal|"local1"
block|,
literal|"local2"
block|,
literal|"local3"
block|,
literal|"local4"
block|,
literal|"local5"
block|,
literal|"local6"
block|,
literal|"local7"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* note 'error/warn' like in nginx.conf, not 'err/warning' */
end_comment

begin_decl_stmt
DECL|variable|severities
specifier|static
name|char
modifier|*
name|severities
index|[]
init|=
block|{
literal|"emerg"
block|,
literal|"alert"
block|,
literal|"crit"
block|,
literal|"error"
block|,
literal|"warn"
block|,
literal|"notice"
block|,
literal|"info"
block|,
literal|"debug"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_syslog_dummy_log
specifier|static
name|ngx_log_t
name|ngx_syslog_dummy_log
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_syslog_dummy_event
specifier|static
name|ngx_event_t
name|ngx_syslog_dummy_event
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
DECL|function|ngx_syslog_process_conf (ngx_conf_t * cf,ngx_syslog_peer_t * peer)
name|ngx_syslog_process_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_syslog_peer_t
modifier|*
name|peer
parameter_list|)
block|{
name|peer
operator|->
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
name|peer
operator|->
name|facility
operator|=
name|NGX_CONF_UNSET_UINT
expr_stmt|;
name|peer
operator|->
name|severity
operator|=
name|NGX_CONF_UNSET_UINT
expr_stmt|;
if|if
condition|(
name|ngx_syslog_parse_args
argument_list|(
name|cf
argument_list|,
name|peer
argument_list|)
operator|!=
name|NGX_CONF_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|peer
operator|->
name|server
operator|.
name|sockaddr
operator|==
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"no syslog server specified"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|peer
operator|->
name|facility
operator|==
name|NGX_CONF_UNSET_UINT
condition|)
block|{
name|peer
operator|->
name|facility
operator|=
literal|23
expr_stmt|;
comment|/* local7 */
block|}
if|if
condition|(
name|peer
operator|->
name|severity
operator|==
name|NGX_CONF_UNSET_UINT
condition|)
block|{
name|peer
operator|->
name|severity
operator|=
literal|6
expr_stmt|;
comment|/* info */
block|}
if|if
condition|(
name|peer
operator|->
name|tag
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_str_set
argument_list|(
operator|&
name|peer
operator|->
name|tag
argument_list|,
literal|"nginx"
argument_list|)
expr_stmt|;
block|}
name|peer
operator|->
name|conn
operator|.
name|fd
operator|=
operator|(
name|ngx_socket_t
operator|)
operator|-
literal|1
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_syslog_parse_args (ngx_conf_t * cf,ngx_syslog_peer_t * peer)
name|ngx_syslog_parse_args
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_syslog_peer_t
modifier|*
name|peer
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|comma
decl_stmt|,
name|c
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_url_t
name|u
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|p
operator|=
name|value
index|[
literal|1
index|]
operator|.
name|data
operator|+
sizeof|sizeof
argument_list|(
literal|"syslog:"
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|comma
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ngx_strchr
argument_list|(
name|p
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|comma
operator|!=
name|NULL
condition|)
block|{
name|len
operator|=
name|comma
operator|-
name|p
expr_stmt|;
operator|*
name|comma
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|value
index|[
literal|1
index|]
operator|.
name|data
operator|+
name|value
index|[
literal|1
index|]
operator|.
name|len
operator|-
name|p
expr_stmt|;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|p
argument_list|,
literal|"server="
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|server
operator|.
name|sockaddr
operator|!=
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate syslog \"server\""
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|u
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|.
name|url
operator|.
name|data
operator|=
name|p
operator|+
literal|7
expr_stmt|;
name|u
operator|.
name|url
operator|.
name|len
operator|=
name|len
operator|-
literal|7
expr_stmt|;
name|u
operator|.
name|default_port
operator|=
literal|514
expr_stmt|;
if|if
condition|(
name|ngx_parse_url
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
operator|&
name|u
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|u
operator|.
name|err
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"%s in syslog server \"%V\""
argument_list|,
name|u
operator|.
name|err
argument_list|,
operator|&
name|u
operator|.
name|url
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|peer
operator|->
name|server
operator|=
name|u
operator|.
name|addrs
index|[
literal|0
index|]
expr_stmt|;
block|}
if|else if
condition|(
name|ngx_strncmp
argument_list|(
name|p
argument_list|,
literal|"facility="
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|facility
operator|!=
name|NGX_CONF_UNSET_UINT
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate syslog \"facility\""
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|facilities
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|p
operator|+
literal|9
argument_list|,
name|facilities
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|peer
operator|->
name|facility
operator|=
name|i
expr_stmt|;
goto|goto
name|next
goto|;
block|}
block|}
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"unknown syslog facility \"%s\""
argument_list|,
name|p
operator|+
literal|9
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|else if
condition|(
name|ngx_strncmp
argument_list|(
name|p
argument_list|,
literal|"severity="
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|severity
operator|!=
name|NGX_CONF_UNSET_UINT
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate syslog \"severity\""
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|severities
index|[
name|i
index|]
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|p
operator|+
literal|9
argument_list|,
name|severities
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|peer
operator|->
name|severity
operator|=
name|i
expr_stmt|;
goto|goto
name|next
goto|;
block|}
block|}
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"unknown syslog severity \"%s\""
argument_list|,
name|p
operator|+
literal|9
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|else if
condition|(
name|ngx_strncmp
argument_list|(
name|p
argument_list|,
literal|"tag="
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|tag
operator|.
name|data
operator|!=
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate syslog \"tag\""
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
comment|/*              * RFC 3164: the TAG is a string of ABNF alphanumeric characters              * that MUST NOT exceed 32 characters.              */
if|if
condition|(
name|len
operator|-
literal|4
operator|>
literal|32
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"syslog tag length exceeds 32"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|4
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
name|ngx_tolower
argument_list|(
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
argument_list|<
literal|'0'
operator|||
operator|(
name|c
operator|>
literal|'9'
operator|&&
name|c
operator|<
literal|'a'
operator|)
operator|||
name|c
argument_list|>
literal|'z'
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"syslog \"tag\" only allows "
literal|"alphanumeric characters"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|peer
operator|->
name|tag
operator|.
name|data
operator|=
name|p
operator|+
literal|4
expr_stmt|;
name|peer
operator|->
name|tag
operator|.
name|len
operator|=
name|len
operator|-
literal|4
expr_stmt|;
block|}
else|else
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"unknown syslog parameter \"%s\""
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|next
label|:
if|if
condition|(
name|comma
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|p
operator|=
name|comma
operator|+
literal|1
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
name|u_char
modifier|*
DECL|function|ngx_syslog_add_header (ngx_syslog_peer_t * peer,u_char * buf)
name|ngx_syslog_add_header
parameter_list|(
name|ngx_syslog_peer_t
modifier|*
name|peer
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|)
block|{
name|ngx_uint_t
name|pri
decl_stmt|;
name|pri
operator|=
name|peer
operator|->
name|facility
operator|*
literal|8
operator|+
name|peer
operator|->
name|severity
expr_stmt|;
return|return
name|ngx_sprintf
argument_list|(
name|buf
argument_list|,
literal|"<%ui>%V %V %V: "
argument_list|,
name|pri
argument_list|,
operator|&
name|ngx_cached_syslog_time
argument_list|,
operator|&
name|ngx_cycle
operator|->
name|hostname
argument_list|,
operator|&
name|peer
operator|->
name|tag
argument_list|)
return|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_syslog_writer (ngx_log_t * log,ngx_uint_t level,u_char * buf,size_t len)
name|ngx_syslog_writer
parameter_list|(
name|ngx_log_t
modifier|*
name|log
parameter_list|,
name|ngx_uint_t
name|level
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
name|msg
index|[
name|NGX_SYSLOG_MAX_STR
index|]
decl_stmt|;
name|ngx_uint_t
name|head_len
decl_stmt|;
name|ngx_syslog_peer_t
modifier|*
name|peer
decl_stmt|;
name|peer
operator|=
name|log
operator|->
name|wdata
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|processing
condition|)
block|{
return|return;
block|}
name|peer
operator|->
name|processing
operator|=
literal|1
expr_stmt|;
name|peer
operator|->
name|severity
operator|=
name|level
operator|-
literal|1
expr_stmt|;
name|p
operator|=
name|ngx_syslog_add_header
argument_list|(
name|peer
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|head_len
operator|=
name|p
operator|-
name|msg
expr_stmt|;
name|len
operator|-=
name|NGX_LINEFEED_SIZE
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|NGX_SYSLOG_MAX_STR
operator|-
name|head_len
condition|)
block|{
name|len
operator|=
name|NGX_SYSLOG_MAX_STR
operator|-
name|head_len
expr_stmt|;
block|}
name|p
operator|=
name|ngx_snprintf
argument_list|(
name|p
argument_list|,
name|len
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_syslog_send
argument_list|(
name|peer
argument_list|,
name|msg
argument_list|,
name|p
operator|-
name|msg
argument_list|)
expr_stmt|;
name|peer
operator|->
name|processing
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|ssize_t
DECL|function|ngx_syslog_send (ngx_syslog_peer_t * peer,u_char * buf,size_t len)
name|ngx_syslog_send
parameter_list|(
name|ngx_syslog_peer_t
modifier|*
name|peer
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|peer
operator|->
name|conn
operator|.
name|fd
operator|==
operator|(
name|ngx_socket_t
operator|)
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ngx_syslog_init_peer
argument_list|(
name|peer
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
if|if
condition|(
name|ngx_send
condition|)
block|{
return|return
name|ngx_send
argument_list|(
operator|&
name|peer
operator|->
name|conn
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
else|else
block|{
comment|/* event module has not yet set ngx_io */
return|return
name|ngx_os_io
operator|.
name|send
argument_list|(
operator|&
name|peer
operator|->
name|conn
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_syslog_init_peer (ngx_syslog_peer_t * peer)
name|ngx_syslog_init_peer
parameter_list|(
name|ngx_syslog_peer_t
modifier|*
name|peer
parameter_list|)
block|{
name|ngx_socket_t
name|fd
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|peer
operator|->
name|conn
operator|.
name|read
operator|=
operator|&
name|ngx_syslog_dummy_event
expr_stmt|;
name|peer
operator|->
name|conn
operator|.
name|write
operator|=
operator|&
name|ngx_syslog_dummy_event
expr_stmt|;
name|peer
operator|->
name|conn
operator|.
name|log
operator|=
operator|&
name|ngx_syslog_dummy_log
expr_stmt|;
name|ngx_syslog_dummy_event
operator|.
name|log
operator|=
operator|&
name|ngx_syslog_dummy_log
expr_stmt|;
name|fd
operator|=
name|ngx_socket
argument_list|(
name|peer
operator|->
name|server
operator|.
name|sockaddr
operator|->
name|sa_family
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|(
name|ngx_socket_t
operator|)
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
name|ngx_socket_n
literal|" failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_nonblocking
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
name|ngx_nonblocking_n
literal|" failed"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|connect
argument_list|(
name|fd
argument_list|,
name|peer
operator|->
name|server
operator|.
name|sockaddr
argument_list|,
name|peer
operator|->
name|server
operator|.
name|socklen
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"connect() failed"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|peer
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|cln
operator|->
name|data
operator|=
name|peer
expr_stmt|;
name|cln
operator|->
name|handler
operator|=
name|ngx_syslog_cleanup
expr_stmt|;
name|peer
operator|->
name|conn
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
return|return
name|NGX_OK
return|;
name|failed
label|:
if|if
condition|(
name|ngx_close_socket
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
name|ngx_close_socket_n
literal|" failed"
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_syslog_cleanup (void * data)
name|ngx_syslog_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_syslog_peer_t
modifier|*
name|peer
init|=
name|data
decl_stmt|;
if|if
condition|(
name|ngx_close_socket
argument_list|(
name|peer
operator|->
name|conn
operator|.
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
name|ngx_close_socket_n
literal|" failed"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit

