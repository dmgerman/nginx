begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_types.h>
end_include

begin_include
include|#
directive|include
file|<ngx_errno.h>
end_include

begin_include
include|#
directive|include
file|<ngx_log.h>
end_include

begin_include
include|#
directive|include
file|<ngx_listen.h>
end_include

begin_function
DECL|function|ngx_listen (struct sockaddr * addr,int backlog,ngx_log_t * log,char * addr_text)
name|ngx_socket_t
name|ngx_listen
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|addr
parameter_list|,
name|int
name|backlog
parameter_list|,
name|ngx_log_t
modifier|*
name|log
parameter_list|,
name|char
modifier|*
name|addr_text
parameter_list|)
block|{
name|ngx_socket_t
name|s
decl_stmt|;
name|int
name|reuseaddr
init|=
literal|1
decl_stmt|;
if|#
directive|if
operator|(
name|WIN32
operator|)
name|unsigned
name|long
name|nb
init|=
literal|1
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"socket failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_REUSEADDR
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|reuseaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"ngx_listen: setsockopt (SO_REUSEADDR) failed"
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|WIN32
operator|)
if|if
condition|(
name|ioctlsocket
argument_list|(
name|s
argument_list|,
name|FIONBIO
argument_list|,
operator|&
name|nb
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"ngx_listen: ioctlsocket (FIONBIO) failed"
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|fcntl
argument_list|(
name|s
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"ngx_listen: fcntl (O_NONBLOCK) failed"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"ngx_listen: bind to %s failed"
argument_list|,
name|addr_text
argument_list|)
expr_stmt|;
if|if
condition|(
name|listen
argument_list|(
name|s
argument_list|,
name|backlog
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"ngx_listen: listen to %s failed"
argument_list|,
name|addr_text
argument_list|)
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

end_unit

