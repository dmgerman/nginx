begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  * Copyright (C) Nginx, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_define
DECL|macro|NGX_SLAB_PAGE_MASK
define|#
directive|define
name|NGX_SLAB_PAGE_MASK
value|3
end_define

begin_define
DECL|macro|NGX_SLAB_PAGE
define|#
directive|define
name|NGX_SLAB_PAGE
value|0
end_define

begin_define
DECL|macro|NGX_SLAB_BIG
define|#
directive|define
name|NGX_SLAB_BIG
value|1
end_define

begin_define
DECL|macro|NGX_SLAB_EXACT
define|#
directive|define
name|NGX_SLAB_EXACT
value|2
end_define

begin_define
DECL|macro|NGX_SLAB_SMALL
define|#
directive|define
name|NGX_SLAB_SMALL
value|3
end_define

begin_if
if|#
directive|if
operator|(
name|NGX_PTR_SIZE
operator|==
literal|4
operator|)
end_if

begin_define
DECL|macro|NGX_SLAB_PAGE_FREE
define|#
directive|define
name|NGX_SLAB_PAGE_FREE
value|0
end_define

begin_define
DECL|macro|NGX_SLAB_PAGE_BUSY
define|#
directive|define
name|NGX_SLAB_PAGE_BUSY
value|0xffffffff
end_define

begin_define
DECL|macro|NGX_SLAB_PAGE_START
define|#
directive|define
name|NGX_SLAB_PAGE_START
value|0x80000000
end_define

begin_define
DECL|macro|NGX_SLAB_SHIFT_MASK
define|#
directive|define
name|NGX_SLAB_SHIFT_MASK
value|0x0000000f
end_define

begin_define
DECL|macro|NGX_SLAB_MAP_MASK
define|#
directive|define
name|NGX_SLAB_MAP_MASK
value|0xffff0000
end_define

begin_define
DECL|macro|NGX_SLAB_MAP_SHIFT
define|#
directive|define
name|NGX_SLAB_MAP_SHIFT
value|16
end_define

begin_define
DECL|macro|NGX_SLAB_BUSY
define|#
directive|define
name|NGX_SLAB_BUSY
value|0xffffffff
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* (NGX_PTR_SIZE == 8) */
end_comment

begin_define
DECL|macro|NGX_SLAB_PAGE_FREE
define|#
directive|define
name|NGX_SLAB_PAGE_FREE
value|0
end_define

begin_define
DECL|macro|NGX_SLAB_PAGE_BUSY
define|#
directive|define
name|NGX_SLAB_PAGE_BUSY
value|0xffffffffffffffff
end_define

begin_define
DECL|macro|NGX_SLAB_PAGE_START
define|#
directive|define
name|NGX_SLAB_PAGE_START
value|0x8000000000000000
end_define

begin_define
DECL|macro|NGX_SLAB_SHIFT_MASK
define|#
directive|define
name|NGX_SLAB_SHIFT_MASK
value|0x000000000000000f
end_define

begin_define
DECL|macro|NGX_SLAB_MAP_MASK
define|#
directive|define
name|NGX_SLAB_MAP_MASK
value|0xffffffff00000000
end_define

begin_define
DECL|macro|NGX_SLAB_MAP_SHIFT
define|#
directive|define
name|NGX_SLAB_MAP_SHIFT
value|32
end_define

begin_define
DECL|macro|NGX_SLAB_BUSY
define|#
directive|define
name|NGX_SLAB_BUSY
value|0xffffffffffffffff
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
DECL|macro|ngx_slab_slots (pool)
define|#
directive|define
name|ngx_slab_slots
parameter_list|(
name|pool
parameter_list|)
define|\
value|(ngx_slab_page_t *) ((u_char *) (pool) + sizeof(ngx_slab_pool_t))
end_define

begin_define
DECL|macro|ngx_slab_page_type (page)
define|#
directive|define
name|ngx_slab_page_type
parameter_list|(
name|page
parameter_list|)
value|((page)->prev& NGX_SLAB_PAGE_MASK)
end_define

begin_define
DECL|macro|ngx_slab_page_prev (page)
define|#
directive|define
name|ngx_slab_page_prev
parameter_list|(
name|page
parameter_list|)
define|\
value|(ngx_slab_page_t *) ((page)->prev& ~NGX_SLAB_PAGE_MASK)
end_define

begin_define
DECL|macro|ngx_slab_page_addr (pool,page)
define|#
directive|define
name|ngx_slab_page_addr
parameter_list|(
name|pool
parameter_list|,
name|page
parameter_list|)
define|\
value|((((page) - (pool)->pages)<< ngx_pagesize_shift)                         \      + (uintptr_t) (pool)->start)
end_define

begin_if
if|#
directive|if
operator|(
name|NGX_DEBUG_MALLOC
operator|)
end_if

begin_define
DECL|macro|ngx_slab_junk (p,size)
define|#
directive|define
name|ngx_slab_junk
parameter_list|(
name|p
parameter_list|,
name|size
parameter_list|)
value|ngx_memset(p, 0xA5, size)
end_define

begin_elif
elif|#
directive|elif
operator|(
name|NGX_HAVE_DEBUG_MALLOC
operator|)
end_elif

begin_define
DECL|macro|ngx_slab_junk (p,size)
define|#
directive|define
name|ngx_slab_junk
parameter_list|(
name|p
parameter_list|,
name|size
parameter_list|)
define|\
value|if (ngx_debug_malloc)          ngx_memset(p, 0xA5, size)
end_define

begin_else
else|#
directive|else
end_else

begin_define
DECL|macro|ngx_slab_junk (p,size)
define|#
directive|define
name|ngx_slab_junk
parameter_list|(
name|p
parameter_list|,
name|size
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|ngx_slab_page_t
modifier|*
name|ngx_slab_alloc_pages
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_uint_t
name|pages
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_slab_free_pages
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_slab_page_t
modifier|*
name|page
parameter_list|,
name|ngx_uint_t
name|pages
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_slab_error
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_uint_t
name|level
parameter_list|,
name|char
modifier|*
name|text
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_slab_max_size
specifier|static
name|ngx_uint_t
name|ngx_slab_max_size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_slab_exact_size
specifier|static
name|ngx_uint_t
name|ngx_slab_exact_size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_slab_exact_shift
specifier|static
name|ngx_uint_t
name|ngx_slab_exact_shift
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|ngx_slab_init (ngx_slab_pool_t * pool)
name|ngx_slab_init
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ngx_int_t
name|m
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|,
name|pages
decl_stmt|;
name|ngx_slab_page_t
modifier|*
name|slots
decl_stmt|,
modifier|*
name|page
decl_stmt|;
comment|/* STUB */
if|if
condition|(
name|ngx_slab_max_size
operator|==
literal|0
condition|)
block|{
name|ngx_slab_max_size
operator|=
name|ngx_pagesize
operator|/
literal|2
expr_stmt|;
name|ngx_slab_exact_size
operator|=
name|ngx_pagesize
operator|/
operator|(
literal|8
operator|*
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|ngx_slab_exact_size
init|;
name|n
operator|>>=
literal|1
condition|;
name|ngx_slab_exact_shift
operator|++
control|)
block|{
comment|/* void */
block|}
block|}
comment|/**/
name|pool
operator|->
name|min_size
operator|=
literal|1
operator|<<
name|pool
operator|->
name|min_shift
expr_stmt|;
name|slots
operator|=
name|ngx_slab_slots
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|slots
expr_stmt|;
name|size
operator|=
name|pool
operator|->
name|end
operator|-
name|p
expr_stmt|;
name|ngx_slab_junk
argument_list|(
name|p
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|n
operator|=
name|ngx_pagesize_shift
operator|-
name|pool
operator|->
name|min_shift
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
comment|/* only "next" is used in list head */
name|slots
index|[
name|i
index|]
operator|.
name|slab
operator|=
literal|0
expr_stmt|;
name|slots
index|[
name|i
index|]
operator|.
name|next
operator|=
operator|&
name|slots
index|[
name|i
index|]
expr_stmt|;
name|slots
index|[
name|i
index|]
operator|.
name|prev
operator|=
literal|0
expr_stmt|;
block|}
name|p
operator|+=
name|n
operator|*
sizeof|sizeof
argument_list|(
name|ngx_slab_page_t
argument_list|)
expr_stmt|;
name|size
operator|-=
name|n
operator|*
sizeof|sizeof
argument_list|(
name|ngx_slab_page_t
argument_list|)
expr_stmt|;
name|pages
operator|=
operator|(
name|ngx_uint_t
operator|)
operator|(
name|size
operator|/
operator|(
name|ngx_pagesize
operator|+
sizeof|sizeof
argument_list|(
name|ngx_slab_page_t
argument_list|)
operator|)
operator|)
expr_stmt|;
name|pool
operator|->
name|pages
operator|=
operator|(
name|ngx_slab_page_t
operator|*
operator|)
name|p
expr_stmt|;
name|ngx_memzero
argument_list|(
name|pool
operator|->
name|pages
argument_list|,
name|pages
operator|*
sizeof|sizeof
argument_list|(
name|ngx_slab_page_t
argument_list|)
argument_list|)
expr_stmt|;
name|page
operator|=
name|pool
operator|->
name|pages
expr_stmt|;
comment|/* only "next" is used in list head */
name|pool
operator|->
name|free
operator|.
name|slab
operator|=
literal|0
expr_stmt|;
name|pool
operator|->
name|free
operator|.
name|next
operator|=
name|page
expr_stmt|;
name|pool
operator|->
name|free
operator|.
name|prev
operator|=
literal|0
expr_stmt|;
name|page
operator|->
name|slab
operator|=
name|pages
expr_stmt|;
name|page
operator|->
name|next
operator|=
operator|&
name|pool
operator|->
name|free
expr_stmt|;
name|page
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|pool
operator|->
name|free
expr_stmt|;
name|pool
operator|->
name|start
operator|=
name|ngx_align_ptr
argument_list|(
name|p
operator|+
name|pages
operator|*
sizeof|sizeof
argument_list|(
name|ngx_slab_page_t
argument_list|)
argument_list|,
name|ngx_pagesize
argument_list|)
expr_stmt|;
name|m
operator|=
name|pages
operator|-
operator|(
name|pool
operator|->
name|end
operator|-
name|pool
operator|->
name|start
operator|)
operator|/
name|ngx_pagesize
expr_stmt|;
if|if
condition|(
name|m
operator|>
literal|0
condition|)
block|{
name|pages
operator|-=
name|m
expr_stmt|;
name|page
operator|->
name|slab
operator|=
name|pages
expr_stmt|;
block|}
name|pool
operator|->
name|last
operator|=
name|pool
operator|->
name|pages
operator|+
name|pages
expr_stmt|;
name|pool
operator|->
name|log_nomem
operator|=
literal|1
expr_stmt|;
name|pool
operator|->
name|log_ctx
operator|=
operator|&
name|pool
operator|->
name|zero
expr_stmt|;
name|pool
operator|->
name|zero
operator|=
literal|'\0'
expr_stmt|;
block|}
end_function

begin_function
name|void
modifier|*
DECL|function|ngx_slab_alloc (ngx_slab_pool_t * pool,size_t size)
name|ngx_slab_alloc
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|p
decl_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|pool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_slab_alloc_locked
argument_list|(
name|pool
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|pool
operator|->
name|mutex
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
name|void
modifier|*
DECL|function|ngx_slab_alloc_locked (ngx_slab_pool_t * pool,size_t size)
name|ngx_slab_alloc_locked
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|size_t
name|s
decl_stmt|;
name|uintptr_t
name|p
decl_stmt|,
name|n
decl_stmt|,
name|m
decl_stmt|,
name|mask
decl_stmt|,
modifier|*
name|bitmap
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|slot
decl_stmt|,
name|shift
decl_stmt|,
name|map
decl_stmt|;
name|ngx_slab_page_t
modifier|*
name|page
decl_stmt|,
modifier|*
name|prev
decl_stmt|,
modifier|*
name|slots
decl_stmt|;
if|if
condition|(
name|size
operator|>
name|ngx_slab_max_size
condition|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_ALLOC
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"slab alloc: %uz"
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|page
operator|=
name|ngx_slab_alloc_pages
argument_list|(
name|pool
argument_list|,
operator|(
name|size
operator|>>
name|ngx_pagesize_shift
operator|)
operator|+
operator|(
operator|(
name|size
operator|%
name|ngx_pagesize
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|page
condition|)
block|{
name|p
operator|=
name|ngx_slab_page_addr
argument_list|(
name|pool
argument_list|,
name|page
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
literal|0
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|size
operator|>
name|pool
operator|->
name|min_size
condition|)
block|{
name|shift
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|s
operator|=
name|size
operator|-
literal|1
init|;
name|s
operator|>>=
literal|1
condition|;
name|shift
operator|++
control|)
block|{
comment|/* void */
block|}
name|slot
operator|=
name|shift
operator|-
name|pool
operator|->
name|min_shift
expr_stmt|;
block|}
else|else
block|{
name|shift
operator|=
name|pool
operator|->
name|min_shift
expr_stmt|;
name|slot
operator|=
literal|0
expr_stmt|;
block|}
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_ALLOC
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"slab alloc: %uz slot: %ui"
argument_list|,
name|size
argument_list|,
name|slot
argument_list|)
expr_stmt|;
name|slots
operator|=
name|ngx_slab_slots
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|page
operator|=
name|slots
index|[
name|slot
index|]
operator|.
name|next
expr_stmt|;
if|if
condition|(
name|page
operator|->
name|next
operator|!=
name|page
condition|)
block|{
if|if
condition|(
name|shift
operator|<
name|ngx_slab_exact_shift
condition|)
block|{
do|do
block|{
name|bitmap
operator|=
operator|(
name|uintptr_t
operator|*
operator|)
name|ngx_slab_page_addr
argument_list|(
name|pool
argument_list|,
name|page
argument_list|)
expr_stmt|;
name|map
operator|=
operator|(
literal|1
operator|<<
operator|(
name|ngx_pagesize_shift
operator|-
name|shift
operator|)
operator|)
operator|/
operator|(
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|*
literal|8
operator|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|map
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|bitmap
index|[
name|n
index|]
operator|!=
name|NGX_SLAB_BUSY
condition|)
block|{
for|for
control|(
name|m
operator|=
literal|1
operator|,
name|i
operator|=
literal|0
init|;
name|m
condition|;
name|m
operator|<<=
literal|1
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bitmap
index|[
name|n
index|]
operator|&
name|m
condition|)
block|{
continue|continue;
block|}
name|bitmap
index|[
name|n
index|]
operator||=
name|m
expr_stmt|;
name|i
operator|=
operator|(
operator|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|*
literal|8
operator|)
operator|<<
name|shift
operator|)
operator|+
operator|(
name|i
operator|<<
name|shift
operator|)
expr_stmt|;
if|if
condition|(
name|bitmap
index|[
name|n
index|]
operator|==
name|NGX_SLAB_BUSY
condition|)
block|{
for|for
control|(
name|n
operator|=
name|n
operator|+
literal|1
init|;
name|n
operator|<
name|map
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|bitmap
index|[
name|n
index|]
operator|!=
name|NGX_SLAB_BUSY
condition|)
block|{
name|p
operator|=
operator|(
name|uintptr_t
operator|)
name|bitmap
operator|+
name|i
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|prev
operator|=
name|ngx_slab_page_prev
argument_list|(
name|page
argument_list|)
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|page
operator|->
name|next
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
name|page
operator|->
name|prev
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|page
operator|->
name|prev
operator|=
name|NGX_SLAB_SMALL
expr_stmt|;
block|}
name|p
operator|=
operator|(
name|uintptr_t
operator|)
name|bitmap
operator|+
name|i
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
block|}
name|page
operator|=
name|page
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|page
condition|)
do|;
block|}
if|else if
condition|(
name|shift
operator|==
name|ngx_slab_exact_shift
condition|)
block|{
do|do
block|{
if|if
condition|(
name|page
operator|->
name|slab
operator|!=
name|NGX_SLAB_BUSY
condition|)
block|{
for|for
control|(
name|m
operator|=
literal|1
operator|,
name|i
operator|=
literal|0
init|;
name|m
condition|;
name|m
operator|<<=
literal|1
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|page
operator|->
name|slab
operator|&
name|m
condition|)
block|{
continue|continue;
block|}
name|page
operator|->
name|slab
operator||=
name|m
expr_stmt|;
if|if
condition|(
name|page
operator|->
name|slab
operator|==
name|NGX_SLAB_BUSY
condition|)
block|{
name|prev
operator|=
name|ngx_slab_page_prev
argument_list|(
name|page
argument_list|)
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|page
operator|->
name|next
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
name|page
operator|->
name|prev
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|page
operator|->
name|prev
operator|=
name|NGX_SLAB_EXACT
expr_stmt|;
block|}
name|p
operator|=
name|ngx_slab_page_addr
argument_list|(
name|pool
argument_list|,
name|page
argument_list|)
operator|+
operator|(
name|i
operator|<<
name|shift
operator|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|page
operator|=
name|page
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|page
condition|)
do|;
block|}
else|else
block|{
comment|/* shift> ngx_slab_exact_shift */
name|n
operator|=
name|ngx_pagesize_shift
operator|-
operator|(
name|page
operator|->
name|slab
operator|&
name|NGX_SLAB_SHIFT_MASK
operator|)
expr_stmt|;
name|n
operator|=
literal|1
operator|<<
name|n
expr_stmt|;
name|n
operator|=
operator|(
operator|(
name|uintptr_t
operator|)
literal|1
operator|<<
name|n
operator|)
operator|-
literal|1
expr_stmt|;
name|mask
operator|=
name|n
operator|<<
name|NGX_SLAB_MAP_SHIFT
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
name|page
operator|->
name|slab
operator|&
name|NGX_SLAB_MAP_MASK
operator|)
operator|!=
name|mask
condition|)
block|{
for|for
control|(
name|m
operator|=
operator|(
name|uintptr_t
operator|)
literal|1
operator|<<
name|NGX_SLAB_MAP_SHIFT
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|&
name|mask
condition|;
name|m
operator|<<=
literal|1
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|page
operator|->
name|slab
operator|&
name|m
condition|)
block|{
continue|continue;
block|}
name|page
operator|->
name|slab
operator||=
name|m
expr_stmt|;
if|if
condition|(
operator|(
name|page
operator|->
name|slab
operator|&
name|NGX_SLAB_MAP_MASK
operator|)
operator|==
name|mask
condition|)
block|{
name|prev
operator|=
name|ngx_slab_page_prev
argument_list|(
name|page
argument_list|)
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|page
operator|->
name|next
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
name|page
operator|->
name|prev
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|page
operator|->
name|prev
operator|=
name|NGX_SLAB_BIG
expr_stmt|;
block|}
name|p
operator|=
name|ngx_slab_page_addr
argument_list|(
name|pool
argument_list|,
name|page
argument_list|)
operator|+
operator|(
name|i
operator|<<
name|shift
operator|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|page
operator|=
name|page
operator|->
name|next
expr_stmt|;
block|}
do|while
condition|(
name|page
condition|)
do|;
block|}
block|}
name|page
operator|=
name|ngx_slab_alloc_pages
argument_list|(
name|pool
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|page
condition|)
block|{
if|if
condition|(
name|shift
operator|<
name|ngx_slab_exact_shift
condition|)
block|{
name|bitmap
operator|=
operator|(
name|uintptr_t
operator|*
operator|)
name|ngx_slab_page_addr
argument_list|(
name|pool
argument_list|,
name|page
argument_list|)
expr_stmt|;
name|s
operator|=
literal|1
operator|<<
name|shift
expr_stmt|;
name|n
operator|=
operator|(
literal|1
operator|<<
operator|(
name|ngx_pagesize_shift
operator|-
name|shift
operator|)
operator|)
operator|/
literal|8
operator|/
name|s
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|n
operator|=
literal|1
expr_stmt|;
block|}
name|bitmap
index|[
literal|0
index|]
operator|=
operator|(
literal|2
operator|<<
name|n
operator|)
operator|-
literal|1
expr_stmt|;
name|map
operator|=
operator|(
literal|1
operator|<<
operator|(
name|ngx_pagesize_shift
operator|-
name|shift
operator|)
operator|)
operator|/
operator|(
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|*
literal|8
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|map
condition|;
name|i
operator|++
control|)
block|{
name|bitmap
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|page
operator|->
name|slab
operator|=
name|shift
expr_stmt|;
name|page
operator|->
name|next
operator|=
operator|&
name|slots
index|[
name|slot
index|]
expr_stmt|;
name|page
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|slots
index|[
name|slot
index|]
operator||
name|NGX_SLAB_SMALL
expr_stmt|;
name|slots
index|[
name|slot
index|]
operator|.
name|next
operator|=
name|page
expr_stmt|;
name|p
operator|=
name|ngx_slab_page_addr
argument_list|(
name|pool
argument_list|,
name|page
argument_list|)
operator|+
name|s
operator|*
name|n
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|else if
condition|(
name|shift
operator|==
name|ngx_slab_exact_shift
condition|)
block|{
name|page
operator|->
name|slab
operator|=
literal|1
expr_stmt|;
name|page
operator|->
name|next
operator|=
operator|&
name|slots
index|[
name|slot
index|]
expr_stmt|;
name|page
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|slots
index|[
name|slot
index|]
operator||
name|NGX_SLAB_EXACT
expr_stmt|;
name|slots
index|[
name|slot
index|]
operator|.
name|next
operator|=
name|page
expr_stmt|;
name|p
operator|=
name|ngx_slab_page_addr
argument_list|(
name|pool
argument_list|,
name|page
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
comment|/* shift> ngx_slab_exact_shift */
name|page
operator|->
name|slab
operator|=
operator|(
operator|(
name|uintptr_t
operator|)
literal|1
operator|<<
name|NGX_SLAB_MAP_SHIFT
operator|)
operator||
name|shift
expr_stmt|;
name|page
operator|->
name|next
operator|=
operator|&
name|slots
index|[
name|slot
index|]
expr_stmt|;
name|page
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|slots
index|[
name|slot
index|]
operator||
name|NGX_SLAB_BIG
expr_stmt|;
name|slots
index|[
name|slot
index|]
operator|.
name|next
operator|=
name|page
expr_stmt|;
name|p
operator|=
name|ngx_slab_page_addr
argument_list|(
name|pool
argument_list|,
name|page
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|p
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_ALLOC
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"slab alloc: %p"
argument_list|,
operator|(
name|void
operator|*
operator|)
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
name|p
return|;
block|}
end_function

begin_function
name|void
modifier|*
DECL|function|ngx_slab_calloc (ngx_slab_pool_t * pool,size_t size)
name|ngx_slab_calloc
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|p
decl_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|pool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_slab_calloc_locked
argument_list|(
name|pool
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|pool
operator|->
name|mutex
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
name|void
modifier|*
DECL|function|ngx_slab_calloc_locked (ngx_slab_pool_t * pool,size_t size)
name|ngx_slab_calloc_locked
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_slab_alloc_locked
argument_list|(
name|pool
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|ngx_memzero
argument_list|(
name|p
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
return|return
name|p
return|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_slab_free (ngx_slab_pool_t * pool,void * p)
name|ngx_slab_free
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|void
modifier|*
name|p
parameter_list|)
block|{
name|ngx_shmtx_lock
argument_list|(
operator|&
name|pool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|ngx_slab_free_locked
argument_list|(
name|pool
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|pool
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_slab_free_locked (ngx_slab_pool_t * pool,void * p)
name|ngx_slab_free_locked
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|void
modifier|*
name|p
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|uintptr_t
name|slab
decl_stmt|,
name|m
decl_stmt|,
modifier|*
name|bitmap
decl_stmt|;
name|ngx_uint_t
name|n
decl_stmt|,
name|type
decl_stmt|,
name|slot
decl_stmt|,
name|shift
decl_stmt|,
name|map
decl_stmt|;
name|ngx_slab_page_t
modifier|*
name|slots
decl_stmt|,
modifier|*
name|page
decl_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_ALLOC
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"slab free: %p"
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|u_char
operator|*
operator|)
name|p
argument_list|<
name|pool
operator|->
name|start
operator|||
operator|(
name|u_char
operator|*
operator|)
name|p
argument_list|>
name|pool
operator|->
name|end
condition|)
block|{
name|ngx_slab_error
argument_list|(
name|pool
argument_list|,
name|NGX_LOG_ALERT
argument_list|,
literal|"ngx_slab_free(): outside of pool"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|n
operator|=
operator|(
operator|(
name|u_char
operator|*
operator|)
name|p
operator|-
name|pool
operator|->
name|start
operator|)
operator|>>
name|ngx_pagesize_shift
expr_stmt|;
name|page
operator|=
operator|&
name|pool
operator|->
name|pages
index|[
name|n
index|]
expr_stmt|;
name|slab
operator|=
name|page
operator|->
name|slab
expr_stmt|;
name|type
operator|=
name|ngx_slab_page_type
argument_list|(
name|page
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|NGX_SLAB_SMALL
case|:
name|shift
operator|=
name|slab
operator|&
name|NGX_SLAB_SHIFT_MASK
expr_stmt|;
name|size
operator|=
literal|1
operator|<<
name|shift
expr_stmt|;
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|p
operator|&
operator|(
name|size
operator|-
literal|1
operator|)
condition|)
block|{
goto|goto
name|wrong_chunk
goto|;
block|}
name|n
operator|=
operator|(
operator|(
name|uintptr_t
operator|)
name|p
operator|&
operator|(
name|ngx_pagesize
operator|-
literal|1
operator|)
operator|)
operator|>>
name|shift
expr_stmt|;
name|m
operator|=
operator|(
name|uintptr_t
operator|)
literal|1
operator|<<
operator|(
name|n
operator|&
operator|(
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|*
literal|8
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|n
operator|/=
operator|(
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|*
literal|8
operator|)
expr_stmt|;
name|bitmap
operator|=
operator|(
name|uintptr_t
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|p
operator|&
operator|~
operator|(
operator|(
name|uintptr_t
operator|)
name|ngx_pagesize
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|bitmap
index|[
name|n
index|]
operator|&
name|m
condition|)
block|{
if|if
condition|(
name|page
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
name|slots
operator|=
name|ngx_slab_slots
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|slot
operator|=
name|shift
operator|-
name|pool
operator|->
name|min_shift
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|slots
index|[
name|slot
index|]
operator|.
name|next
expr_stmt|;
name|slots
index|[
name|slot
index|]
operator|.
name|next
operator|=
name|page
expr_stmt|;
name|page
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|slots
index|[
name|slot
index|]
operator||
name|NGX_SLAB_SMALL
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
name|page
operator||
name|NGX_SLAB_SMALL
expr_stmt|;
block|}
name|bitmap
index|[
name|n
index|]
operator|&=
operator|~
name|m
expr_stmt|;
name|n
operator|=
operator|(
literal|1
operator|<<
operator|(
name|ngx_pagesize_shift
operator|-
name|shift
operator|)
operator|)
operator|/
literal|8
operator|/
operator|(
literal|1
operator|<<
name|shift
operator|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|n
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|bitmap
index|[
literal|0
index|]
operator|&
operator|~
operator|(
operator|(
operator|(
name|uintptr_t
operator|)
literal|1
operator|<<
name|n
operator|)
operator|-
literal|1
operator|)
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|map
operator|=
operator|(
literal|1
operator|<<
operator|(
name|ngx_pagesize_shift
operator|-
name|shift
operator|)
operator|)
operator|/
operator|(
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|*
literal|8
operator|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|1
init|;
name|n
operator|<
name|map
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|bitmap
index|[
name|n
index|]
condition|)
block|{
goto|goto
name|done
goto|;
block|}
block|}
name|ngx_slab_free_pages
argument_list|(
name|pool
argument_list|,
name|page
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
goto|goto
name|chunk_already_free
goto|;
case|case
name|NGX_SLAB_EXACT
case|:
name|m
operator|=
operator|(
name|uintptr_t
operator|)
literal|1
operator|<<
operator|(
operator|(
operator|(
name|uintptr_t
operator|)
name|p
operator|&
operator|(
name|ngx_pagesize
operator|-
literal|1
operator|)
operator|)
operator|>>
name|ngx_slab_exact_shift
operator|)
expr_stmt|;
name|size
operator|=
name|ngx_slab_exact_size
expr_stmt|;
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|p
operator|&
operator|(
name|size
operator|-
literal|1
operator|)
condition|)
block|{
goto|goto
name|wrong_chunk
goto|;
block|}
if|if
condition|(
name|slab
operator|&
name|m
condition|)
block|{
if|if
condition|(
name|slab
operator|==
name|NGX_SLAB_BUSY
condition|)
block|{
name|slots
operator|=
name|ngx_slab_slots
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|slot
operator|=
name|ngx_slab_exact_shift
operator|-
name|pool
operator|->
name|min_shift
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|slots
index|[
name|slot
index|]
operator|.
name|next
expr_stmt|;
name|slots
index|[
name|slot
index|]
operator|.
name|next
operator|=
name|page
expr_stmt|;
name|page
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|slots
index|[
name|slot
index|]
operator||
name|NGX_SLAB_EXACT
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
name|page
operator||
name|NGX_SLAB_EXACT
expr_stmt|;
block|}
name|page
operator|->
name|slab
operator|&=
operator|~
name|m
expr_stmt|;
if|if
condition|(
name|page
operator|->
name|slab
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|ngx_slab_free_pages
argument_list|(
name|pool
argument_list|,
name|page
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
goto|goto
name|chunk_already_free
goto|;
case|case
name|NGX_SLAB_BIG
case|:
name|shift
operator|=
name|slab
operator|&
name|NGX_SLAB_SHIFT_MASK
expr_stmt|;
name|size
operator|=
literal|1
operator|<<
name|shift
expr_stmt|;
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|p
operator|&
operator|(
name|size
operator|-
literal|1
operator|)
condition|)
block|{
goto|goto
name|wrong_chunk
goto|;
block|}
name|m
operator|=
operator|(
name|uintptr_t
operator|)
literal|1
operator|<<
operator|(
operator|(
operator|(
operator|(
name|uintptr_t
operator|)
name|p
operator|&
operator|(
name|ngx_pagesize
operator|-
literal|1
operator|)
operator|)
operator|>>
name|shift
operator|)
operator|+
name|NGX_SLAB_MAP_SHIFT
operator|)
expr_stmt|;
if|if
condition|(
name|slab
operator|&
name|m
condition|)
block|{
if|if
condition|(
name|page
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
name|slots
operator|=
name|ngx_slab_slots
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|slot
operator|=
name|shift
operator|-
name|pool
operator|->
name|min_shift
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|slots
index|[
name|slot
index|]
operator|.
name|next
expr_stmt|;
name|slots
index|[
name|slot
index|]
operator|.
name|next
operator|=
name|page
expr_stmt|;
name|page
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|slots
index|[
name|slot
index|]
operator||
name|NGX_SLAB_BIG
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
name|page
operator||
name|NGX_SLAB_BIG
expr_stmt|;
block|}
name|page
operator|->
name|slab
operator|&=
operator|~
name|m
expr_stmt|;
if|if
condition|(
name|page
operator|->
name|slab
operator|&
name|NGX_SLAB_MAP_MASK
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|ngx_slab_free_pages
argument_list|(
name|pool
argument_list|,
name|page
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
goto|goto
name|chunk_already_free
goto|;
case|case
name|NGX_SLAB_PAGE
case|:
if|if
condition|(
operator|(
name|uintptr_t
operator|)
name|p
operator|&
operator|(
name|ngx_pagesize
operator|-
literal|1
operator|)
condition|)
block|{
goto|goto
name|wrong_chunk
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|slab
operator|&
name|NGX_SLAB_PAGE_START
operator|)
condition|)
block|{
name|ngx_slab_error
argument_list|(
name|pool
argument_list|,
name|NGX_LOG_ALERT
argument_list|,
literal|"ngx_slab_free(): page is already free"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|slab
operator|==
name|NGX_SLAB_PAGE_BUSY
condition|)
block|{
name|ngx_slab_error
argument_list|(
name|pool
argument_list|,
name|NGX_LOG_ALERT
argument_list|,
literal|"ngx_slab_free(): pointer to wrong page"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|n
operator|=
operator|(
operator|(
name|u_char
operator|*
operator|)
name|p
operator|-
name|pool
operator|->
name|start
operator|)
operator|>>
name|ngx_pagesize_shift
expr_stmt|;
name|size
operator|=
name|slab
operator|&
operator|~
name|NGX_SLAB_PAGE_START
expr_stmt|;
name|ngx_slab_free_pages
argument_list|(
name|pool
argument_list|,
operator|&
name|pool
operator|->
name|pages
index|[
name|n
index|]
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ngx_slab_junk
argument_list|(
name|p
argument_list|,
name|size
operator|<<
name|ngx_pagesize_shift
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* not reached */
return|return;
name|done
label|:
name|ngx_slab_junk
argument_list|(
name|p
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return;
name|wrong_chunk
label|:
name|ngx_slab_error
argument_list|(
name|pool
argument_list|,
name|NGX_LOG_ALERT
argument_list|,
literal|"ngx_slab_free(): pointer to wrong chunk"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
name|chunk_already_free
label|:
name|ngx_slab_error
argument_list|(
name|pool
argument_list|,
name|NGX_LOG_ALERT
argument_list|,
literal|"ngx_slab_free(): chunk is already free"
argument_list|)
expr_stmt|;
name|fail
label|:
return|return;
block|}
end_function

begin_function
specifier|static
name|ngx_slab_page_t
modifier|*
DECL|function|ngx_slab_alloc_pages (ngx_slab_pool_t * pool,ngx_uint_t pages)
name|ngx_slab_alloc_pages
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_uint_t
name|pages
parameter_list|)
block|{
name|ngx_slab_page_t
modifier|*
name|page
decl_stmt|,
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|page
operator|=
name|pool
operator|->
name|free
operator|.
name|next
init|;
name|page
operator|!=
operator|&
name|pool
operator|->
name|free
condition|;
name|page
operator|=
name|page
operator|->
name|next
control|)
block|{
if|if
condition|(
name|page
operator|->
name|slab
operator|>=
name|pages
condition|)
block|{
if|if
condition|(
name|page
operator|->
name|slab
operator|>
name|pages
condition|)
block|{
name|page
index|[
name|page
operator|->
name|slab
operator|-
literal|1
index|]
operator|.
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|page
index|[
name|pages
index|]
expr_stmt|;
name|page
index|[
name|pages
index|]
operator|.
name|slab
operator|=
name|page
operator|->
name|slab
operator|-
name|pages
expr_stmt|;
name|page
index|[
name|pages
index|]
operator|.
name|next
operator|=
name|page
operator|->
name|next
expr_stmt|;
name|page
index|[
name|pages
index|]
operator|.
name|prev
operator|=
name|page
operator|->
name|prev
expr_stmt|;
name|p
operator|=
operator|(
name|ngx_slab_page_t
operator|*
operator|)
name|page
operator|->
name|prev
expr_stmt|;
name|p
operator|->
name|next
operator|=
operator|&
name|page
index|[
name|pages
index|]
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|page
index|[
name|pages
index|]
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
operator|(
name|ngx_slab_page_t
operator|*
operator|)
name|page
operator|->
name|prev
expr_stmt|;
name|p
operator|->
name|next
operator|=
name|page
operator|->
name|next
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
name|page
operator|->
name|prev
expr_stmt|;
block|}
name|page
operator|->
name|slab
operator|=
name|pages
operator||
name|NGX_SLAB_PAGE_START
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|page
operator|->
name|prev
operator|=
name|NGX_SLAB_PAGE
expr_stmt|;
if|if
condition|(
operator|--
name|pages
operator|==
literal|0
condition|)
block|{
return|return
name|page
return|;
block|}
for|for
control|(
name|p
operator|=
name|page
operator|+
literal|1
init|;
name|pages
condition|;
name|pages
operator|--
control|)
block|{
name|p
operator|->
name|slab
operator|=
name|NGX_SLAB_PAGE_BUSY
expr_stmt|;
name|p
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|p
operator|->
name|prev
operator|=
name|NGX_SLAB_PAGE
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
return|return
name|page
return|;
block|}
block|}
if|if
condition|(
name|pool
operator|->
name|log_nomem
condition|)
block|{
name|ngx_slab_error
argument_list|(
name|pool
argument_list|,
name|NGX_LOG_CRIT
argument_list|,
literal|"ngx_slab_alloc() failed: no memory"
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_slab_free_pages (ngx_slab_pool_t * pool,ngx_slab_page_t * page,ngx_uint_t pages)
name|ngx_slab_free_pages
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_slab_page_t
modifier|*
name|page
parameter_list|,
name|ngx_uint_t
name|pages
parameter_list|)
block|{
name|ngx_slab_page_t
modifier|*
name|prev
decl_stmt|,
modifier|*
name|join
decl_stmt|;
name|page
operator|->
name|slab
operator|=
name|pages
operator|--
expr_stmt|;
if|if
condition|(
name|pages
condition|)
block|{
name|ngx_memzero
argument_list|(
operator|&
name|page
index|[
literal|1
index|]
argument_list|,
name|pages
operator|*
sizeof|sizeof
argument_list|(
name|ngx_slab_page_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|page
operator|->
name|next
condition|)
block|{
name|prev
operator|=
name|ngx_slab_page_prev
argument_list|(
name|page
argument_list|)
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|page
operator|->
name|next
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
name|page
operator|->
name|prev
expr_stmt|;
block|}
name|join
operator|=
name|page
operator|+
name|page
operator|->
name|slab
expr_stmt|;
if|if
condition|(
name|join
operator|<
name|pool
operator|->
name|last
condition|)
block|{
if|if
condition|(
name|ngx_slab_page_type
argument_list|(
name|join
argument_list|)
operator|==
name|NGX_SLAB_PAGE
condition|)
block|{
if|if
condition|(
name|join
operator|->
name|next
operator|!=
name|NULL
condition|)
block|{
name|pages
operator|+=
name|join
operator|->
name|slab
expr_stmt|;
name|page
operator|->
name|slab
operator|+=
name|join
operator|->
name|slab
expr_stmt|;
name|prev
operator|=
name|ngx_slab_page_prev
argument_list|(
name|join
argument_list|)
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|join
operator|->
name|next
expr_stmt|;
name|join
operator|->
name|next
operator|->
name|prev
operator|=
name|join
operator|->
name|prev
expr_stmt|;
name|join
operator|->
name|slab
operator|=
name|NGX_SLAB_PAGE_FREE
expr_stmt|;
name|join
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|join
operator|->
name|prev
operator|=
name|NGX_SLAB_PAGE
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|page
operator|>
name|pool
operator|->
name|pages
condition|)
block|{
name|join
operator|=
name|page
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_slab_page_type
argument_list|(
name|join
argument_list|)
operator|==
name|NGX_SLAB_PAGE
condition|)
block|{
if|if
condition|(
name|join
operator|->
name|slab
operator|==
name|NGX_SLAB_PAGE_FREE
condition|)
block|{
name|join
operator|=
name|ngx_slab_page_prev
argument_list|(
name|join
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|join
operator|->
name|next
operator|!=
name|NULL
condition|)
block|{
name|pages
operator|+=
name|join
operator|->
name|slab
expr_stmt|;
name|join
operator|->
name|slab
operator|+=
name|page
operator|->
name|slab
expr_stmt|;
name|prev
operator|=
name|ngx_slab_page_prev
argument_list|(
name|join
argument_list|)
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|join
operator|->
name|next
expr_stmt|;
name|join
operator|->
name|next
operator|->
name|prev
operator|=
name|join
operator|->
name|prev
expr_stmt|;
name|page
operator|->
name|slab
operator|=
name|NGX_SLAB_PAGE_FREE
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|page
operator|->
name|prev
operator|=
name|NGX_SLAB_PAGE
expr_stmt|;
name|page
operator|=
name|join
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|pages
condition|)
block|{
name|page
index|[
name|pages
index|]
operator|.
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
name|page
expr_stmt|;
block|}
name|page
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|pool
operator|->
name|free
expr_stmt|;
name|page
operator|->
name|next
operator|=
name|pool
operator|->
name|free
operator|.
name|next
expr_stmt|;
name|page
operator|->
name|next
operator|->
name|prev
operator|=
operator|(
name|uintptr_t
operator|)
name|page
expr_stmt|;
name|pool
operator|->
name|free
operator|.
name|next
operator|=
name|page
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_slab_error (ngx_slab_pool_t * pool,ngx_uint_t level,char * text)
name|ngx_slab_error
parameter_list|(
name|ngx_slab_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_uint_t
name|level
parameter_list|,
name|char
modifier|*
name|text
parameter_list|)
block|{
name|ngx_log_error
argument_list|(
name|level
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"%s%s"
argument_list|,
name|text
argument_list|,
name|pool
operator|->
name|log_ctx
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

