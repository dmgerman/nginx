begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_function
DECL|function|ngx_sigio_add_event (ngx_event_t * ev,int signal)
name|int
name|ngx_sigio_add_event
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|,
name|int
name|signal
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|c
operator|=
operator|(
name|ngx_connection_t
operator|*
operator|)
name|ev
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|fcntl
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|O_RDWR
operator||
name|O_NONBLOCK
operator||
name|O_ASYNC
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"fcntl(O_RDWR|O_NONBLOCK|O_ASYNC) failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|fcntl
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|F_SETSIG
argument_list|,
name|signal
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"fcntl(F_SETSIG) failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|fcntl
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|F_SETOWN
argument_list|,
name|pid
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"fcntl(F_SETOWN) failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|#
directive|if
operator|(
name|HAVE_ONESIGFD
operator|)
if|if
condition|(
name|fcntl
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|F_SETAUXFL
argument_list|,
name|O_ONESIGFD
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"fcntl(F_SETAUXFL) failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
endif|#
directive|endif
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
DECL|function|ngx_sigio_process_events (ngx_log_t * log)
name|int
name|ngx_sigio_process_events
parameter_list|(
name|ngx_log_t
modifier|*
name|log
parameter_list|)
block|{
name|struct
name|siginfo
name|si
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|timer
condition|)
block|{
name|sig
operator|=
name|sigtimedwait
argument_list|(
operator|&
name|sigio_set
argument_list|,
operator|&
name|si
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
if|if
condition|(
name|sig
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"sigtimedwait() failed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
block|}
else|else
block|{
name|sig
operator|=
name|sigwaitinfo
argument_list|(
operator|&
name|set
argument_list|,
operator|&
name|si
argument_list|)
expr_stmt|;
if|if
condition|(
name|sig
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"sigwaitinfo() failed"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sig
operator|==
name|rtsig
condition|)
block|{
name|c
operator|=
operator|&
name|ngx_connections
index|[
name|si
operator|.
name|si_fd
index|]
expr_stmt|;
if|if
condition|(
name|si
operator|.
name|si_band
operator|&
operator|(
name|POLLERR
operator||
name|POLLHUP
operator||
name|POLLNVAL
operator|)
condition|)
block|{
name|ev
operator|=
operator|???
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|active
condition|)
block|{
name|ev
operator|->
name|ready
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|event_handler
argument_list|(
name|ev
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ev
operator|->
name|close_handler
argument_list|(
name|ev
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|si
operator|.
name|si_band
operator|&
operator|(
name|POLLIN
operator|)
condition|)
block|{
name|ev
operator|=
name|c
operator|->
name|read
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|active
condition|)
block|{
name|ev
operator|->
name|ready
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|event_handler
argument_list|(
name|ev
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ev
operator|->
name|close_handler
argument_list|(
name|ev
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|si
operator|.
name|si_band
operator|&
operator|(
name|POLLOUT
operator|)
condition|)
block|{
name|ev
operator|=
name|c
operator|->
name|write
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|active
condition|)
block|{
name|ev
operator|->
name|ready
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|event_handler
argument_list|(
name|ev
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ev
operator|->
name|close_handler
argument_list|(
name|ev
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|else if
condition|(
name|sig
operator|==
name|SIGIO
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"Signal queue overflowed: "
literal|"SIGIO, fd:%d, band:%d"
argument_list|,
name|si
operator|.
name|si_fd
argument_list|,
name|si
operator|.
name|si_band
argument_list|)
expr_stmt|;
comment|/* flush queue: method #1 (dphttpd) */
name|ts
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|ts
operator|.
name|tv_nsec
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sigtimedwait
argument_list|(
operator|&
name|sigio_set
argument_list|,
operator|&
name|si
argument_list|,
operator|&
name|ts
argument_list|)
operator|>
literal|0
condition|)
empty_stmt|;
comment|/* flush queue: method #2 (dkftpbench) */
name|signal
argument_list|(
name|m_signum
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|m_signum
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
comment|/* do poll */
block|}
else|else
block|{
block|}
block|}
end_function

unit|}
end_unit

