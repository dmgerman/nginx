begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event.h>
end_include

begin_define
DECL|macro|NGX_MAX_PENDING_CONN
define|#
directive|define
name|NGX_MAX_PENDING_CONN
value|10
end_define

begin_decl_stmt
DECL|variable|connect_lock
specifier|static
name|CRITICAL_SECTION
name|connect_lock
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|nconnects
specifier|static
name|int
name|nconnects
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|pending_connects
specifier|static
name|ngx_connection_t
name|pending_connects
index|[
name|NGX_MAX_PENDING_CONN
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|pending_connect_event
specifier|static
name|HANDLE
name|pending_connect_event
decl_stmt|;
end_decl_stmt

begin_macro
name|__declspec
argument_list|(
argument|thread
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nevents
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_macro
name|__declspec
argument_list|(
argument|thread
argument_list|)
end_macro

begin_decl_stmt
name|WSAEVENT
name|events
index|[
name|WSA_MAXIMUM_WAIT_EVENTS
index|]
decl_stmt|;
end_decl_stmt

begin_macro
name|__declspec
argument_list|(
argument|thread
argument_list|)
end_macro

begin_decl_stmt
name|ngx_connection_t
modifier|*
name|conn
index|[
name|WSA_MAXIMUM_WAIT_EVENTS
index|]
decl_stmt|;
end_decl_stmt

begin_function
DECL|function|ngx_iocp_wait_connect (ngx_connection_t * c)
name|int
name|ngx_iocp_wait_connect
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
name|EnterCriticalSection
argument_list|(
operator|&
name|connect_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconnects
operator|<
name|NGX_MAX_PENDING_CONN
condition|)
block|{
name|pending_connects
index|[
operator|--
name|nconnects
index|]
operator|=
name|c
expr_stmt|;
name|LeaveCriticalSection
argument_list|(
operator|&
name|connect_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|SetEvent
argument_list|(
name|pending_connect_event
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"SetEvent() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
break|break;
block|}
name|LeaveCriticalSection
argument_list|(
operator|&
name|connect_lock
argument_list|)
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_NOTICE
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"max number of pending connect()s is %d"
argument_list|,
name|NGX_MAX_PENDING_CONN
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|started
condition|)
block|{
if|if
condition|(
name|ngx_iocp_new_thread
argument_list|(
literal|1
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|started
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
name|int
name|ngx_iocp_new_thread
argument_list|(
name|int
expr|main
argument_list|)
block|{
name|u_int
name|id
decl_stmt|;
if|if
condition|(
expr|main
condition|)
block|{
name|pending_connect_event
operator|=
name|CreateEvent
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending_connect_event
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"CreateThread() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
if|if
condition|(
name|CreateThread
argument_list|(
name|NULL
argument_list|,
literal|0
argument_list|,
name|ngx_iocp_wait_events
argument_list|,
expr|main
argument_list|,
literal|0
argument_list|,
operator|&
name|id
argument_list|)
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"CreateThread() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|SetEvent
argument_list|(
argument|event
argument_list|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"SetEvent() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
name|int
name|ngx_iocp_new_connect
parameter_list|()
block|{
name|EnterCriticalSection
argument_list|(
operator|&
name|connect_lock
argument_list|)
expr_stmt|;
name|c
operator|=
name|pending_connects
index|[
operator|--
name|nconnects
index|]
expr_stmt|;
name|LeaveCriticalSection
argument_list|(
operator|&
name|connect_lock
argument_list|)
expr_stmt|;
name|conn
index|[
name|nevents
index|]
operator|=
name|c
expr_stmt|;
name|events
index|[
name|nevents
index|]
operator|=
name|WSACreateEvent
argument_list|()
expr_stmt|;
if|if
condition|(
name|events
index|[
name|nevents
index|]
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"WSACreateEvent() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|WSAEventSelect
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|events
index|[
name|nevents
index|]
argument_list|,
name|FD_CONNECT
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"WSAEventSelect() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|nevents
operator|++
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_decl_stmt
DECL|function|ngx_iocp_wait_events (int main)
name|void
name|ngx_iocp_wait_events
argument_list|(
name|int
expr|main
argument_list|)
block|{
name|WSANETWORKEVENTS
name|ne
decl_stmt|;
name|nevents
operator|=
literal|1
expr_stmt|;
name|events
index|[
literal|0
index|]
operator|=
name|pending_connect_event
expr_stmt|;
name|conn
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|offset
operator|=
operator|(
name|nevents
operator|==
name|WSA_MAXIMUM_WAIT_EVENTS
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|timeout
operator|=
operator|(
name|nevents
operator|==
literal|1
operator|&&
operator|!
name|first
operator|)
condition|?
literal|60000
else|:
name|INFINITE
expr_stmt|;
name|n
operator|=
name|WSAWaitForMultipleEvents
argument_list|(
name|nevents
operator|-
name|offset
argument_list|,
name|events
index|[
name|offset
index|]
argument_list|,
literal|0
argument_list|,
name|timeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|WAIT_FAILED
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"WSAWaitForMultipleEvents() failed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|n
operator|==
name|WAIT_TIMEOUT
condition|)
block|{
if|if
condition|(
name|nevents
operator|==
literal|1
operator|&&
operator|!
expr|main
condition|)
block|{
name|ExitThread
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
literal|0
argument_list|,
literal|"WSAWaitForMultipleEvents() "
literal|"returned unexpected WAIT_TIMEOUT"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|n
operator|-=
name|WSA_WAIT_EVENT_0
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
comment|/* the first event is pending_connect_event */
if|if
condition|(
name|nevents
operator|==
name|WSA_MAXIMUM_WAIT_EVENTS
condition|)
block|{
name|ngx_iocp_new_thread
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_iocp_new_connect
argument_list|()
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|WSAEnumNetworkEvents
argument_list|(
name|c
index|[
name|n
index|]
operator|.
name|fd
argument_list|,
name|events
index|[
name|n
index|]
argument_list|,
operator|&
name|ne
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"WSAEnumNetworkEvents() failed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ne
operator|.
name|lNetworkEvents
operator|&
name|FD_CONNECT
condition|)
block|{
name|conn
index|[
name|n
index|]
operator|.
name|write
operator|->
name|ovlp
operator|.
name|error
operator|=
name|ne
operator|.
name|iErrorCode
index|[
name|FD_CONNECT_BIT
index|]
expr_stmt|;
if|if
condition|(
name|PostQueuedCompletionStatus
argument_list|(
name|iocp
argument_list|,
literal|0
argument_list|,
name|NGX_IOCP_CONNECT
argument_list|,
operator|&
name|conn
index|[
name|n
index|]
operator|.
name|write
operator|->
name|ovlp
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"PostQueuedCompletionStatus() failed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|n
operator|<
name|nevents
condition|)
block|{
name|conn
index|[
name|n
index|]
operator|=
name|conn
index|[
name|nevents
index|]
expr_stmt|;
name|events
index|[
name|n
index|]
operator|=
name|events
index|[
name|nevents
index|]
expr_stmt|;
block|}
name|nevents
operator|--
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ne
operator|.
name|lNetworkEvents
operator|&
name|FD_ACCEPT
condition|)
block|{
comment|/* CHECK ERROR ??? */
name|ngx_event_post_acceptex
argument_list|(
name|conn
index|[
name|n
index|]
operator|.
name|listening
argument_list|,
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
index|[
name|n
index|]
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"WSAWaitForMultipleEvents() "
literal|"returned unexpected network event %lu"
argument_list|,
name|ne
operator|.
name|lNetworkEvents
argument_list|)
expr_stmt|;
block|}
block|}
end_decl_stmt

end_unit

