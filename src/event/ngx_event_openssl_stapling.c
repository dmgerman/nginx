begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Maxim Dounin  * Copyright (C) Nginx, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event_connect.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SSL_CTRL_SET_TLSEXT_STATUS_REQ_CB
end_ifdef

begin_typedef
DECL|struct|__anon27caaf3f0108
typedef|typedef
struct|struct
block|{
DECL|member|staple
name|ngx_str_t
name|staple
decl_stmt|;
DECL|member|timeout
name|ngx_msec_t
name|timeout
decl_stmt|;
DECL|member|resolver
name|ngx_resolver_t
modifier|*
name|resolver
decl_stmt|;
DECL|member|resolver_timeout
name|ngx_msec_t
name|resolver_timeout
decl_stmt|;
DECL|member|addrs
name|ngx_addr_t
modifier|*
name|addrs
decl_stmt|;
DECL|member|host
name|ngx_str_t
name|host
decl_stmt|;
DECL|member|uri
name|ngx_str_t
name|uri
decl_stmt|;
DECL|member|port
name|in_port_t
name|port
decl_stmt|;
DECL|member|ssl_ctx
name|SSL_CTX
modifier|*
name|ssl_ctx
decl_stmt|;
DECL|member|cert
name|X509
modifier|*
name|cert
decl_stmt|;
DECL|member|issuer
name|X509
modifier|*
name|issuer
decl_stmt|;
DECL|member|valid
name|time_t
name|valid
decl_stmt|;
DECL|member|verify
name|unsigned
name|verify
range|:
literal|1
decl_stmt|;
DECL|member|loading
name|unsigned
name|loading
range|:
literal|1
decl_stmt|;
DECL|typedef|ngx_ssl_stapling_t
block|}
name|ngx_ssl_stapling_t
typedef|;
end_typedef

begin_typedef
DECL|typedef|ngx_ssl_ocsp_ctx_t
typedef|typedef
name|struct
name|ngx_ssl_ocsp_ctx_s
name|ngx_ssl_ocsp_ctx_t
typedef|;
end_typedef

begin_struct
DECL|struct|ngx_ssl_ocsp_ctx_s
struct|struct
name|ngx_ssl_ocsp_ctx_s
block|{
DECL|member|cert
name|X509
modifier|*
name|cert
decl_stmt|;
DECL|member|issuer
name|X509
modifier|*
name|issuer
decl_stmt|;
DECL|member|naddrs
name|ngx_uint_t
name|naddrs
decl_stmt|;
DECL|member|addrs
name|ngx_addr_t
modifier|*
name|addrs
decl_stmt|;
DECL|member|host
name|ngx_str_t
name|host
decl_stmt|;
DECL|member|uri
name|ngx_str_t
name|uri
decl_stmt|;
DECL|member|port
name|in_port_t
name|port
decl_stmt|;
DECL|member|resolver
name|ngx_resolver_t
modifier|*
name|resolver
decl_stmt|;
DECL|member|resolver_timeout
name|ngx_msec_t
name|resolver_timeout
decl_stmt|;
DECL|member|timeout
name|ngx_msec_t
name|timeout
decl_stmt|;
DECL|member|handler
name|void
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|r
parameter_list|)
function_decl|;
DECL|member|data
name|void
modifier|*
name|data
decl_stmt|;
DECL|member|request
name|ngx_buf_t
modifier|*
name|request
decl_stmt|;
DECL|member|response
name|ngx_buf_t
modifier|*
name|response
decl_stmt|;
DECL|member|peer
name|ngx_peer_connection_t
name|peer
decl_stmt|;
DECL|member|process
name|ngx_int_t
function_decl|(
modifier|*
name|process
function_decl|)
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|r
parameter_list|)
function_decl|;
DECL|member|state
name|ngx_uint_t
name|state
decl_stmt|;
DECL|member|code
name|ngx_uint_t
name|code
decl_stmt|;
DECL|member|count
name|ngx_uint_t
name|count
decl_stmt|;
DECL|member|done
name|ngx_uint_t
name|done
decl_stmt|;
DECL|member|header_name_start
name|u_char
modifier|*
name|header_name_start
decl_stmt|;
DECL|member|header_name_end
name|u_char
modifier|*
name|header_name_end
decl_stmt|;
DECL|member|header_start
name|u_char
modifier|*
name|header_start
decl_stmt|;
DECL|member|header_end
name|u_char
modifier|*
name|header_end
decl_stmt|;
DECL|member|pool
name|ngx_pool_t
modifier|*
name|pool
decl_stmt|;
DECL|member|log
name|ngx_log_t
modifier|*
name|log
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_stapling_file
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|,
name|ngx_str_t
modifier|*
name|file
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_stapling_issuer
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_stapling_responder
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|,
name|ngx_str_t
modifier|*
name|responder
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_ssl_certificate_status_callback
parameter_list|(
name|ngx_ssl_conn_t
modifier|*
name|ssl_conn
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_stapling_update
parameter_list|(
name|ngx_ssl_stapling_t
modifier|*
name|staple
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_stapling_ocsp_handler
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_stapling_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ngx_ssl_ocsp_start
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_ocsp_done
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_ocsp_request
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_ocsp_resolve_handler
parameter_list|(
name|ngx_resolver_ctx_t
modifier|*
name|resolve
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_ocsp_connect
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_ocsp_write_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_ocsp_read_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_ssl_ocsp_dummy_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_ocsp_create_request
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_ocsp_process_status_line
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_ocsp_parse_status_line
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_ocsp_process_headers
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_ocsp_parse_header_line
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_ssl_ocsp_process_body
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_ssl_ocsp_log_error
parameter_list|(
name|ngx_log_t
modifier|*
name|log
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|ngx_int_t
DECL|function|ngx_ssl_stapling (ngx_conf_t * cf,ngx_ssl_t * ssl,ngx_str_t * file,ngx_str_t * responder,ngx_uint_t verify)
name|ngx_ssl_stapling
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|,
name|ngx_str_t
modifier|*
name|file
parameter_list|,
name|ngx_str_t
modifier|*
name|responder
parameter_list|,
name|ngx_uint_t
name|verify
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ngx_ssl_stapling_t
modifier|*
name|staple
decl_stmt|;
name|staple
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_ssl_stapling_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|staple
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_ssl_stapling_cleanup
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|staple
expr_stmt|;
if|if
condition|(
name|SSL_CTX_set_ex_data
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
name|ngx_ssl_stapling_index
argument_list|,
name|staple
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL_CTX_set_ex_data() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|staple
operator|->
name|ssl_ctx
operator|=
name|ssl
operator|->
name|ctx
expr_stmt|;
name|staple
operator|->
name|timeout
operator|=
literal|60000
expr_stmt|;
name|staple
operator|->
name|verify
operator|=
name|verify
expr_stmt|;
if|if
condition|(
name|file
operator|->
name|len
condition|)
block|{
comment|/* use OCSP response from the file */
if|if
condition|(
name|ngx_ssl_stapling_file
argument_list|(
name|cf
argument_list|,
name|ssl
argument_list|,
name|file
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
goto|goto
name|done
goto|;
block|}
name|rc
operator|=
name|ngx_ssl_stapling_issuer
argument_list|(
name|cf
argument_list|,
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|rc
operator|=
name|ngx_ssl_stapling_responder
argument_list|(
name|cf
argument_list|,
name|ssl
argument_list|,
name|responder
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|done
label|:
name|SSL_CTX_set_tlsext_status_cb
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
name|ngx_ssl_certificate_status_callback
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_status_arg
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
name|staple
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_stapling_file (ngx_conf_t * cf,ngx_ssl_t * ssl,ngx_str_t * file)
name|ngx_ssl_stapling_file
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|,
name|ngx_str_t
modifier|*
name|file
parameter_list|)
block|{
name|BIO
modifier|*
name|bio
decl_stmt|;
name|int
name|len
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|OCSP_RESPONSE
modifier|*
name|response
decl_stmt|;
name|ngx_ssl_stapling_t
modifier|*
name|staple
decl_stmt|;
name|staple
operator|=
name|SSL_CTX_get_ex_data
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
name|ngx_ssl_stapling_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_conf_full_name
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
name|file
argument_list|,
literal|1
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|bio
operator|=
name|BIO_new_file
argument_list|(
operator|(
name|char
operator|*
operator|)
name|file
operator|->
name|data
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"BIO_new_file(\"%s\") failed"
argument_list|,
name|file
operator|->
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|response
operator|=
name|d2i_OCSP_RESPONSE_bio
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"d2i_OCSP_RESPONSE_bio(\"%s\") failed"
argument_list|,
name|file
operator|->
name|data
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|len
operator|=
name|i2d_OCSP_RESPONSE
argument_list|(
name|response
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"i2d_OCSP_RESPONSE(\"%s\") failed"
argument_list|,
name|file
operator|->
name|data
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|buf
operator|=
name|ngx_alloc
argument_list|(
name|len
argument_list|,
name|ssl
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|p
operator|=
name|buf
expr_stmt|;
name|len
operator|=
name|i2d_OCSP_RESPONSE
argument_list|(
name|response
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"i2d_OCSP_RESPONSE(\"%s\") failed"
argument_list|,
name|file
operator|->
name|data
argument_list|)
expr_stmt|;
name|ngx_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|OCSP_RESPONSE_free
argument_list|(
name|response
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
name|staple
operator|->
name|staple
operator|.
name|data
operator|=
name|buf
expr_stmt|;
name|staple
operator|->
name|staple
operator|.
name|len
operator|=
name|len
expr_stmt|;
return|return
name|NGX_OK
return|;
name|failed
label|:
name|OCSP_RESPONSE_free
argument_list|(
name|response
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_stapling_issuer (ngx_conf_t * cf,ngx_ssl_t * ssl)
name|ngx_ssl_stapling_issuer
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|rc
decl_stmt|;
name|X509
modifier|*
name|cert
decl_stmt|,
modifier|*
name|issuer
decl_stmt|;
name|X509_STORE
modifier|*
name|store
decl_stmt|;
name|X509_STORE_CTX
modifier|*
name|store_ctx
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|chain
expr_stmt|;
name|ngx_ssl_stapling_t
modifier|*
name|staple
decl_stmt|;
name|staple
operator|=
name|SSL_CTX_get_ex_data
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
name|ngx_ssl_stapling_index
argument_list|)
expr_stmt|;
name|cert
operator|=
name|SSL_CTX_get_ex_data
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
name|ngx_ssl_certificate_index
argument_list|)
expr_stmt|;
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10001000L
name|SSL_CTX_get_extra_chain_certs
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
operator|&
name|chain
argument_list|)
expr_stmt|;
else|#
directive|else
name|chain
operator|=
name|ssl
operator|->
name|ctx
operator|->
name|extra_certs
expr_stmt|;
endif|#
directive|endif
name|n
operator|=
name|sk_X509_num
argument_list|(
name|chain
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL get issuer: %d extra certs"
argument_list|,
name|n
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|issuer
operator|=
name|sk_X509_value
argument_list|(
name|chain
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|X509_check_issued
argument_list|(
name|issuer
argument_list|,
name|cert
argument_list|)
operator|==
name|X509_V_OK
condition|)
block|{
name|CRYPTO_add
argument_list|(
operator|&
name|issuer
operator|->
name|references
argument_list|,
literal|1
argument_list|,
name|CRYPTO_LOCK_X509
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL get issuer: found %p in extra certs"
argument_list|,
name|issuer
argument_list|)
expr_stmt|;
name|staple
operator|->
name|cert
operator|=
name|cert
expr_stmt|;
name|staple
operator|->
name|issuer
operator|=
name|issuer
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
block|}
name|store
operator|=
name|SSL_CTX_get_cert_store
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|store
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL_CTX_get_cert_store() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|store_ctx
operator|=
name|X509_STORE_CTX_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|store_ctx
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"X509_STORE_CTX_new() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|X509_STORE_CTX_init
argument_list|(
name|store_ctx
argument_list|,
name|store
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"X509_STORE_CTX_init() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|rc
operator|=
name|X509_STORE_CTX_get1_issuer
argument_list|(
operator|&
name|issuer
argument_list|,
name|store_ctx
argument_list|,
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"X509_STORE_CTX_get1_issuer() failed"
argument_list|)
expr_stmt|;
name|X509_STORE_CTX_free
argument_list|(
name|store_ctx
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"ssl_stapling\" ignored, issuer certificate not found"
argument_list|)
expr_stmt|;
name|X509_STORE_CTX_free
argument_list|(
name|store_ctx
argument_list|)
expr_stmt|;
return|return
name|NGX_DECLINED
return|;
block|}
name|X509_STORE_CTX_free
argument_list|(
name|store_ctx
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL get issuer: found %p in cert store"
argument_list|,
name|issuer
argument_list|)
expr_stmt|;
name|staple
operator|->
name|cert
operator|=
name|cert
expr_stmt|;
name|staple
operator|->
name|issuer
operator|=
name|issuer
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_stapling_responder (ngx_conf_t * cf,ngx_ssl_t * ssl,ngx_str_t * responder)
name|ngx_ssl_stapling_responder
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|,
name|ngx_str_t
modifier|*
name|responder
parameter_list|)
block|{
name|ngx_url_t
name|u
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|ngx_ssl_stapling_t
modifier|*
name|staple
decl_stmt|;
name|STACK_OF
argument_list|(
name|OPENSSL_STRING
argument_list|)
operator|*
name|aia
expr_stmt|;
name|staple
operator|=
name|SSL_CTX_get_ex_data
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
name|ngx_ssl_stapling_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|responder
operator|->
name|len
operator|==
literal|0
condition|)
block|{
comment|/* extract OCSP responder URL from certificate */
name|aia
operator|=
name|X509_get1_ocsp
argument_list|(
name|staple
operator|->
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|aia
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"ssl_stapling\" ignored, "
literal|"no OCSP responder URL in the certificate"
argument_list|)
expr_stmt|;
return|return
name|NGX_DECLINED
return|;
block|}
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10000000L
name|s
operator|=
name|sk_OPENSSL_STRING_value
argument_list|(
name|aia
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
name|s
operator|=
name|sk_value
argument_list|(
name|aia
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"ssl_stapling\" ignored, "
literal|"no OCSP responder URL in the certificate"
argument_list|)
expr_stmt|;
name|X509_email_free
argument_list|(
name|aia
argument_list|)
expr_stmt|;
return|return
name|NGX_DECLINED
return|;
block|}
name|responder
operator|->
name|len
operator|=
name|ngx_strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|responder
operator|->
name|data
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|responder
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|responder
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|X509_email_free
argument_list|(
name|aia
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|responder
operator|->
name|data
argument_list|,
name|s
argument_list|,
name|responder
operator|->
name|len
argument_list|)
expr_stmt|;
name|X509_email_free
argument_list|(
name|aia
argument_list|)
expr_stmt|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|u
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|.
name|url
operator|=
operator|*
name|responder
expr_stmt|;
name|u
operator|.
name|default_port
operator|=
literal|80
expr_stmt|;
name|u
operator|.
name|uri_part
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|u
operator|.
name|url
operator|.
name|len
operator|>
literal|7
operator|&&
name|ngx_strncasecmp
argument_list|(
name|u
operator|.
name|url
operator|.
name|data
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"http://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|u
operator|.
name|url
operator|.
name|len
operator|-=
literal|7
expr_stmt|;
name|u
operator|.
name|url
operator|.
name|data
operator|+=
literal|7
expr_stmt|;
block|}
else|else
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"ssl_stapling\" ignored, "
literal|"invalid URL prefix in OCSP responder \"%V\""
argument_list|,
operator|&
name|u
operator|.
name|url
argument_list|)
expr_stmt|;
return|return
name|NGX_DECLINED
return|;
block|}
if|if
condition|(
name|ngx_parse_url
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
operator|&
name|u
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|u
operator|.
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"ssl_stapling\" ignored, "
literal|"%s in OCSP responder \"%V\""
argument_list|,
name|u
operator|.
name|err
argument_list|,
operator|&
name|u
operator|.
name|url
argument_list|)
expr_stmt|;
return|return
name|NGX_DECLINED
return|;
block|}
return|return
name|NGX_ERROR
return|;
block|}
name|staple
operator|->
name|addrs
operator|=
name|u
operator|.
name|addrs
expr_stmt|;
name|staple
operator|->
name|host
operator|=
name|u
operator|.
name|host
expr_stmt|;
name|staple
operator|->
name|uri
operator|=
name|u
operator|.
name|uri
expr_stmt|;
name|staple
operator|->
name|port
operator|=
name|u
operator|.
name|port
expr_stmt|;
if|if
condition|(
name|staple
operator|->
name|uri
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_str_set
argument_list|(
operator|&
name|staple
operator|->
name|uri
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_ssl_stapling_resolver (ngx_conf_t * cf,ngx_ssl_t * ssl,ngx_resolver_t * resolver,ngx_msec_t resolver_timeout)
name|ngx_ssl_stapling_resolver
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|,
name|ngx_resolver_t
modifier|*
name|resolver
parameter_list|,
name|ngx_msec_t
name|resolver_timeout
parameter_list|)
block|{
name|ngx_ssl_stapling_t
modifier|*
name|staple
decl_stmt|;
name|staple
operator|=
name|SSL_CTX_get_ex_data
argument_list|(
name|ssl
operator|->
name|ctx
argument_list|,
name|ngx_ssl_stapling_index
argument_list|)
expr_stmt|;
name|staple
operator|->
name|resolver
operator|=
name|resolver
expr_stmt|;
name|staple
operator|->
name|resolver_timeout
operator|=
name|resolver_timeout
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|ngx_ssl_certificate_status_callback (ngx_ssl_conn_t * ssl_conn,void * data)
name|ngx_ssl_certificate_status_callback
parameter_list|(
name|ngx_ssl_conn_t
modifier|*
name|ssl_conn
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_ssl_stapling_t
modifier|*
name|staple
decl_stmt|;
name|c
operator|=
name|ngx_ssl_get_connection
argument_list|(
name|ssl_conn
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL certificate status callback"
argument_list|)
expr_stmt|;
name|staple
operator|=
name|data
expr_stmt|;
name|rc
operator|=
name|SSL_TLSEXT_ERR_NOACK
expr_stmt|;
if|if
condition|(
name|staple
operator|->
name|staple
operator|.
name|len
condition|)
block|{
comment|/* we have to copy ocsp response as OpenSSL will free it by itself */
name|p
operator|=
name|OPENSSL_malloc
argument_list|(
name|staple
operator|->
name|staple
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OPENSSL_malloc() failed"
argument_list|)
expr_stmt|;
return|return
name|SSL_TLSEXT_ERR_NOACK
return|;
block|}
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|staple
operator|->
name|staple
operator|.
name|data
argument_list|,
name|staple
operator|->
name|staple
operator|.
name|len
argument_list|)
expr_stmt|;
name|SSL_set_tlsext_status_ocsp_resp
argument_list|(
name|ssl_conn
argument_list|,
name|p
argument_list|,
name|staple
operator|->
name|staple
operator|.
name|len
argument_list|)
expr_stmt|;
name|rc
operator|=
name|SSL_TLSEXT_ERR_OK
expr_stmt|;
block|}
name|ngx_ssl_stapling_update
argument_list|(
name|staple
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_stapling_update (ngx_ssl_stapling_t * staple)
name|ngx_ssl_stapling_update
parameter_list|(
name|ngx_ssl_stapling_t
modifier|*
name|staple
parameter_list|)
block|{
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
decl_stmt|;
if|if
condition|(
name|staple
operator|->
name|host
operator|.
name|len
operator|==
literal|0
operator|||
name|staple
operator|->
name|loading
operator|||
name|staple
operator|->
name|valid
operator|>=
name|ngx_time
argument_list|()
condition|)
block|{
return|return;
block|}
name|staple
operator|->
name|loading
operator|=
literal|1
expr_stmt|;
name|ctx
operator|=
name|ngx_ssl_ocsp_start
argument_list|()
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|ctx
operator|->
name|cert
operator|=
name|staple
operator|->
name|cert
expr_stmt|;
name|ctx
operator|->
name|issuer
operator|=
name|staple
operator|->
name|issuer
expr_stmt|;
name|ctx
operator|->
name|addrs
operator|=
name|staple
operator|->
name|addrs
expr_stmt|;
name|ctx
operator|->
name|host
operator|=
name|staple
operator|->
name|host
expr_stmt|;
name|ctx
operator|->
name|uri
operator|=
name|staple
operator|->
name|uri
expr_stmt|;
name|ctx
operator|->
name|port
operator|=
name|staple
operator|->
name|port
expr_stmt|;
name|ctx
operator|->
name|timeout
operator|=
name|staple
operator|->
name|timeout
expr_stmt|;
name|ctx
operator|->
name|resolver
operator|=
name|staple
operator|->
name|resolver
expr_stmt|;
name|ctx
operator|->
name|resolver_timeout
operator|=
name|staple
operator|->
name|resolver_timeout
expr_stmt|;
name|ctx
operator|->
name|handler
operator|=
name|ngx_ssl_stapling_ocsp_handler
expr_stmt|;
name|ctx
operator|->
name|data
operator|=
name|staple
expr_stmt|;
name|ngx_ssl_ocsp_request
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_stapling_ocsp_handler (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_stapling_ocsp_handler
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x0090707fL
specifier|const
endif|#
directive|endif
name|u_char
modifier|*
name|p
decl_stmt|;
name|int
name|n
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_str_t
name|response
decl_stmt|;
name|X509_STORE
modifier|*
name|store
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|chain
expr_stmt|;
name|OCSP_CERTID
modifier|*
name|id
decl_stmt|;
name|OCSP_RESPONSE
modifier|*
name|ocsp
decl_stmt|;
name|OCSP_BASICRESP
modifier|*
name|basic
decl_stmt|;
name|ngx_ssl_stapling_t
modifier|*
name|staple
decl_stmt|;
name|ASN1_GENERALIZEDTIME
modifier|*
name|thisupdate
decl_stmt|,
modifier|*
name|nextupdate
decl_stmt|;
name|staple
operator|=
name|ctx
operator|->
name|data
expr_stmt|;
name|ocsp
operator|=
name|NULL
expr_stmt|;
name|basic
operator|=
name|NULL
expr_stmt|;
name|id
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|code
operator|!=
literal|200
condition|)
block|{
goto|goto
name|error
goto|;
block|}
comment|/* check the response */
name|len
operator|=
name|ctx
operator|->
name|response
operator|->
name|last
operator|-
name|ctx
operator|->
name|response
operator|->
name|pos
expr_stmt|;
name|p
operator|=
name|ctx
operator|->
name|response
operator|->
name|pos
expr_stmt|;
name|ocsp
operator|=
name|d2i_OCSP_RESPONSE
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ocsp
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"d2i_OCSP_RESPONSE() failed"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|n
operator|=
name|OCSP_response_status
argument_list|(
name|ocsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|OCSP_RESPONSE_STATUS_SUCCESSFUL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP response not successful (%d: %s)"
argument_list|,
name|n
argument_list|,
name|OCSP_response_status_str
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|basic
operator|=
name|OCSP_response_get1_basic
argument_list|(
name|ocsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|basic
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP_response_get1_basic() failed"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|store
operator|=
name|SSL_CTX_get_cert_store
argument_list|(
name|staple
operator|->
name|ssl_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|store
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL_CTX_get_cert_store() failed"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10001000L
name|SSL_CTX_get_extra_chain_certs
argument_list|(
name|staple
operator|->
name|ssl_ctx
argument_list|,
operator|&
name|chain
argument_list|)
expr_stmt|;
else|#
directive|else
name|chain
operator|=
name|staple
operator|->
name|ssl_ctx
operator|->
name|extra_certs
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|OCSP_basic_verify
argument_list|(
name|basic
argument_list|,
name|chain
argument_list|,
name|store
argument_list|,
name|staple
operator|->
name|verify
condition|?
name|OCSP_TRUSTOTHER
else|:
name|OCSP_NOVERIFY
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP_basic_verify() failed"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|id
operator|=
name|OCSP_cert_to_id
argument_list|(
name|NULL
argument_list|,
name|ctx
operator|->
name|cert
argument_list|,
name|ctx
operator|->
name|issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP_cert_to_id() failed"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|OCSP_resp_find_status
argument_list|(
name|basic
argument_list|,
name|id
argument_list|,
operator|&
name|n
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|thisupdate
argument_list|,
operator|&
name|nextupdate
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"certificate status not found in the OCSP response"
argument_list|,
name|n
argument_list|,
name|OCSP_response_status_str
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|n
operator|!=
name|V_OCSP_CERTSTATUS_GOOD
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"certificate status \"%s\" in the OCSP response"
argument_list|,
name|n
argument_list|,
name|OCSP_cert_status_str
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|OCSP_check_validity
argument_list|(
name|thisupdate
argument_list|,
name|nextupdate
argument_list|,
literal|300
argument_list|,
operator|-
literal|1
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP_check_validity() failed"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|OCSP_CERTID_free
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|ocsp
argument_list|)
expr_stmt|;
comment|/* copy the response to memory not in ctx->pool */
name|response
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|response
operator|.
name|data
operator|=
name|ngx_alloc
argument_list|(
name|response
operator|.
name|len
argument_list|,
name|ctx
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|response
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|ngx_memcpy
argument_list|(
name|response
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|response
operator|->
name|pos
argument_list|,
name|response
operator|.
name|len
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp response, %s, %uz"
argument_list|,
name|OCSP_cert_status_str
argument_list|(
name|n
argument_list|)
argument_list|,
name|response
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|staple
operator|->
name|staple
operator|.
name|data
condition|)
block|{
name|ngx_free
argument_list|(
name|staple
operator|->
name|staple
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
name|staple
operator|->
name|staple
operator|=
name|response
expr_stmt|;
name|done
label|:
name|staple
operator|->
name|loading
operator|=
literal|0
expr_stmt|;
name|staple
operator|->
name|valid
operator|=
name|ngx_time
argument_list|()
operator|+
literal|3600
expr_stmt|;
comment|/* ssl_stapling_valid */
name|ngx_ssl_ocsp_done
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
name|error
label|:
name|staple
operator|->
name|loading
operator|=
literal|0
expr_stmt|;
name|staple
operator|->
name|valid
operator|=
name|ngx_time
argument_list|()
operator|+
literal|300
expr_stmt|;
comment|/* ssl_stapling_err_valid */
if|if
condition|(
name|id
condition|)
block|{
name|OCSP_CERTID_free
argument_list|(
name|id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|basic
condition|)
block|{
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ocsp
condition|)
block|{
name|OCSP_RESPONSE_free
argument_list|(
name|ocsp
argument_list|)
expr_stmt|;
block|}
name|ngx_ssl_ocsp_done
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_stapling_cleanup (void * data)
name|ngx_ssl_stapling_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_ssl_stapling_t
modifier|*
name|staple
init|=
name|data
decl_stmt|;
if|if
condition|(
name|staple
operator|->
name|issuer
condition|)
block|{
name|X509_free
argument_list|(
name|staple
operator|->
name|issuer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|staple
operator|->
name|staple
operator|.
name|data
condition|)
block|{
name|ngx_free
argument_list|(
name|staple
operator|->
name|staple
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|ngx_ssl_ocsp_ctx_t
modifier|*
DECL|function|ngx_ssl_ocsp_start (void)
name|ngx_ssl_ocsp_start
parameter_list|(
name|void
parameter_list|)
block|{
name|ngx_log_t
modifier|*
name|log
decl_stmt|;
name|ngx_pool_t
modifier|*
name|pool
decl_stmt|;
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|pool
operator|=
name|ngx_create_pool
argument_list|(
literal|2048
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|pool
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_ssl_ocsp_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ngx_destroy_pool
argument_list|(
name|pool
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|log
operator|=
name|ngx_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_log_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
block|{
name|ngx_destroy_pool
argument_list|(
name|pool
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ctx
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
operator|*
name|log
operator|=
operator|*
name|ctx
operator|->
name|pool
operator|->
name|log
expr_stmt|;
name|ctx
operator|->
name|pool
operator|->
name|log
operator|=
name|log
expr_stmt|;
name|ctx
operator|->
name|log
operator|=
name|log
expr_stmt|;
name|log
operator|->
name|handler
operator|=
name|ngx_ssl_ocsp_log_error
expr_stmt|;
name|log
operator|->
name|data
operator|=
name|ctx
expr_stmt|;
name|log
operator|->
name|action
operator|=
literal|"requesting certificate status"
expr_stmt|;
return|return
name|ctx
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_ocsp_done (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_done
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|peer
operator|.
name|connection
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
block|}
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_ocsp_error (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_error
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp error"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|code
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|handler
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_ocsp_request (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_request
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_resolver_ctx_t
modifier|*
name|resolve
decl_stmt|,
name|temp
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp request"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_ssl_ocsp_create_request
argument_list|(
name|ctx
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ctx
operator|->
name|resolver
condition|)
block|{
comment|/* resolve OCSP responder hostname */
name|temp
operator|.
name|name
operator|=
name|ctx
operator|->
name|host
expr_stmt|;
name|resolve
operator|=
name|ngx_resolve_start
argument_list|(
name|ctx
operator|->
name|resolver
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolve
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|resolve
operator|==
name|NGX_NO_RESOLVER
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no resolver defined to resolve %V"
argument_list|,
operator|&
name|ctx
operator|->
name|host
argument_list|)
expr_stmt|;
goto|goto
name|connect
goto|;
block|}
name|resolve
operator|->
name|name
operator|=
name|ctx
operator|->
name|host
expr_stmt|;
name|resolve
operator|->
name|type
operator|=
name|NGX_RESOLVE_A
expr_stmt|;
name|resolve
operator|->
name|handler
operator|=
name|ngx_ssl_ocsp_resolve_handler
expr_stmt|;
name|resolve
operator|->
name|data
operator|=
name|ctx
expr_stmt|;
name|resolve
operator|->
name|timeout
operator|=
name|ctx
operator|->
name|resolver_timeout
expr_stmt|;
if|if
condition|(
name|ngx_resolve_name
argument_list|(
name|resolve
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
name|connect
label|:
name|ngx_ssl_ocsp_connect
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_ocsp_resolve_handler (ngx_resolver_ctx_t * resolve)
name|ngx_ssl_ocsp_resolve_handler
parameter_list|(
name|ngx_resolver_ctx_t
modifier|*
name|resolve
parameter_list|)
block|{
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
init|=
name|resolve
operator|->
name|data
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|in_port_t
name|port
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp resolve handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolve
operator|->
name|state
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"%V could not be resolved (%i: %s)"
argument_list|,
operator|&
name|resolve
operator|->
name|name
argument_list|,
name|resolve
operator|->
name|state
argument_list|,
name|ngx_resolver_strerror
argument_list|(
name|resolve
operator|->
name|state
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
block|{
name|in_addr_t
name|addr
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|resolve
operator|->
name|naddrs
condition|;
name|i
operator|++
control|)
block|{
name|addr
operator|=
name|ntohl
argument_list|(
name|resolve
operator|->
name|addrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"name was resolved to %ud.%ud.%ud.%ud"
argument_list|,
operator|(
name|addr
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|addr
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|addr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|addr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|ctx
operator|->
name|naddrs
operator|=
name|resolve
operator|->
name|naddrs
expr_stmt|;
name|ctx
operator|->
name|addrs
operator|=
name|ngx_pcalloc
argument_list|(
name|ctx
operator|->
name|pool
argument_list|,
name|ctx
operator|->
name|naddrs
operator|*
sizeof|sizeof
argument_list|(
name|ngx_addr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|addrs
operator|==
name|NULL
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|port
operator|=
name|htons
argument_list|(
name|ctx
operator|->
name|port
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|resolve
operator|->
name|naddrs
condition|;
name|i
operator|++
control|)
block|{
name|sin
operator|=
name|ngx_pcalloc
argument_list|(
name|ctx
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sin
operator|==
name|NULL
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|->
name|sin_port
operator|=
name|port
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|resolve
operator|->
name|addrs
index|[
name|i
index|]
expr_stmt|;
name|ctx
operator|->
name|addrs
index|[
name|i
index|]
operator|.
name|sockaddr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sin
expr_stmt|;
name|ctx
operator|->
name|addrs
index|[
name|i
index|]
operator|.
name|socklen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|len
operator|=
name|NGX_INET_ADDRSTRLEN
operator|+
sizeof|sizeof
argument_list|(
literal|":65535"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|ctx
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|len
operator|=
name|ngx_sock_ntop
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sin
argument_list|,
name|p
argument_list|,
name|len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|addrs
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|ctx
operator|->
name|addrs
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
operator|=
name|p
expr_stmt|;
block|}
name|ngx_resolve_name_done
argument_list|(
name|resolve
argument_list|)
expr_stmt|;
name|ngx_ssl_ocsp_connect
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
name|failed
label|:
name|ngx_resolve_name_done
argument_list|(
name|resolve
argument_list|)
expr_stmt|;
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_ocsp_connect (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_connect
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp connect"
argument_list|)
expr_stmt|;
comment|/* TODO: use all ip addresses */
name|ctx
operator|->
name|peer
operator|.
name|sockaddr
operator|=
name|ctx
operator|->
name|addrs
index|[
literal|0
index|]
operator|.
name|sockaddr
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|socklen
operator|=
name|ctx
operator|->
name|addrs
index|[
literal|0
index|]
operator|.
name|socklen
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|name
operator|=
operator|&
name|ctx
operator|->
name|addrs
index|[
literal|0
index|]
operator|.
name|name
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|get
operator|=
name|ngx_event_get_peer
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|log
operator|=
name|ctx
operator|->
name|log
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|log_error
operator|=
name|NGX_ERROR_ERR
expr_stmt|;
name|rc
operator|=
name|ngx_event_connect_peer
argument_list|(
operator|&
name|ctx
operator|->
name|peer
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp connect peer done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|==
name|NGX_BUSY
operator|||
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|data
operator|=
name|ctx
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|pool
operator|=
name|ctx
operator|->
name|pool
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_ssl_ocsp_read_handler
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_ssl_ocsp_write_handler
expr_stmt|;
name|ctx
operator|->
name|process
operator|=
name|ngx_ssl_ocsp_process_status_line
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
argument_list|,
name|ctx
operator|->
name|timeout
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
name|ctx
operator|->
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
name|ngx_ssl_ocsp_write_handler
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_ocsp_write_handler (ngx_event_t * wev)
name|ngx_ssl_ocsp_write_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
block|{
name|ssize_t
name|n
decl_stmt|,
name|size
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|c
operator|=
name|wev
operator|->
name|data
expr_stmt|;
name|ctx
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|wev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp write handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|wev
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"OCSP responder timed out"
argument_list|)
expr_stmt|;
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
name|size
operator|=
name|ctx
operator|->
name|request
operator|->
name|last
operator|-
name|ctx
operator|->
name|request
operator|->
name|pos
expr_stmt|;
name|n
operator|=
name|ngx_send
argument_list|(
name|c
argument_list|,
name|ctx
operator|->
name|request
operator|->
name|pos
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|ctx
operator|->
name|request
operator|->
name|pos
operator|+=
name|n
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|size
condition|)
block|{
name|wev
operator|->
name|handler
operator|=
name|ngx_ssl_ocsp_dummy_handler
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|wev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|wev
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
if|if
condition|(
operator|!
name|wev
operator|->
name|timer_set
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|wev
argument_list|,
name|ctx
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_ocsp_read_handler (ngx_event_t * rev)
name|ngx_ssl_ocsp_read_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ssize_t
name|n
decl_stmt|,
name|size
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|ctx
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp read handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|rev
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"OCSP responder timed out"
argument_list|)
expr_stmt|;
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ctx
operator|->
name|response
operator|==
name|NULL
condition|)
block|{
name|ctx
operator|->
name|response
operator|=
name|ngx_create_temp_buf
argument_list|(
name|ctx
operator|->
name|pool
argument_list|,
literal|16384
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|response
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|size
operator|=
name|ctx
operator|->
name|response
operator|->
name|end
operator|-
name|ctx
operator|->
name|response
operator|->
name|last
expr_stmt|;
name|n
operator|=
name|ngx_recv
argument_list|(
name|c
argument_list|,
name|ctx
operator|->
name|response
operator|->
name|last
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|ctx
operator|->
name|response
operator|->
name|last
operator|+=
name|n
expr_stmt|;
name|rc
operator|=
name|ctx
operator|->
name|process
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
continue|continue;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
break|break;
block|}
name|ctx
operator|->
name|done
operator|=
literal|1
expr_stmt|;
name|rc
operator|=
name|ctx
operator|->
name|process
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DONE
condition|)
block|{
comment|/* ctx->handler() was called */
return|return;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP responder prematurely closed connection"
argument_list|)
expr_stmt|;
name|ngx_ssl_ocsp_error
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_ssl_ocsp_dummy_handler (ngx_event_t * ev)
name|ngx_ssl_ocsp_dummy_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp dummy handler"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_ocsp_create_request (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_create_request
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|uintptr_t
name|escape
decl_stmt|;
name|ngx_str_t
name|binary
decl_stmt|,
name|base64
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|OCSP_CERTID
modifier|*
name|id
decl_stmt|;
name|OCSP_REQUEST
modifier|*
name|ocsp
decl_stmt|;
name|ocsp
operator|=
name|OCSP_REQUEST_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|ocsp
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP_REQUEST_new() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|id
operator|=
name|OCSP_cert_to_id
argument_list|(
name|NULL
argument_list|,
name|ctx
operator|->
name|cert
argument_list|,
name|ctx
operator|->
name|issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP_cert_to_id() failed"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
if|if
condition|(
name|OCSP_request_add0_id
argument_list|(
name|ocsp
argument_list|,
name|id
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP_request_add0_id() failed"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|len
operator|=
name|i2d_OCSP_REQUEST
argument_list|(
name|ocsp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"i2d_OCSP_REQUEST() failed"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|binary
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|binary
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|ctx
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|binary
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|p
operator|=
name|binary
operator|.
name|data
expr_stmt|;
name|len
operator|=
name|i2d_OCSP_REQUEST
argument_list|(
name|ocsp
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"i2d_OCSP_REQUEST() failed"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|base64
operator|.
name|len
operator|=
name|ngx_base64_encoded_length
argument_list|(
name|binary
operator|.
name|len
argument_list|)
expr_stmt|;
name|base64
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|ctx
operator|->
name|pool
argument_list|,
name|base64
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|base64
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|ngx_encode_base64
argument_list|(
operator|&
name|base64
argument_list|,
operator|&
name|binary
argument_list|)
expr_stmt|;
name|escape
operator|=
name|ngx_escape_uri
argument_list|(
name|NULL
argument_list|,
name|base64
operator|.
name|data
argument_list|,
name|base64
operator|.
name|len
argument_list|,
name|NGX_ESCAPE_URI_COMPONENT
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp request length %z, escape %d"
argument_list|,
name|base64
operator|.
name|len
argument_list|,
name|escape
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"GET "
argument_list|)
operator|-
literal|1
operator|+
name|ctx
operator|->
name|uri
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
literal|"/"
argument_list|)
operator|-
literal|1
operator|+
name|base64
operator|.
name|len
operator|+
literal|2
operator|*
name|escape
operator|+
sizeof|sizeof
argument_list|(
literal|" HTTP/1.0"
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Host: "
argument_list|)
operator|-
literal|1
operator|+
name|ctx
operator|->
name|host
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
expr_stmt|;
name|b
operator|=
name|ngx_create_temp_buf
argument_list|(
name|ctx
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
name|p
operator|=
name|b
operator|->
name|last
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
literal|"GET "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"GET "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|ctx
operator|->
name|uri
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|uri
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|uri
operator|.
name|data
index|[
name|ctx
operator|->
name|uri
operator|.
name|len
operator|-
literal|1
index|]
operator|!=
literal|'/'
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'/'
expr_stmt|;
block|}
if|if
condition|(
name|escape
operator|==
literal|0
condition|)
block|{
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|base64
operator|.
name|data
argument_list|,
name|base64
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ngx_escape_uri
argument_list|(
name|p
argument_list|,
name|base64
operator|.
name|data
argument_list|,
name|base64
operator|.
name|len
argument_list|,
name|NGX_ESCAPE_URI_COMPONENT
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
literal|" HTTP/1.0"
name|CRLF
argument_list|,
sizeof|sizeof
argument_list|(
literal|" HTTP/1.0"
name|CRLF
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
literal|"Host: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Host: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|ctx
operator|->
name|host
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|host
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|LF
expr_stmt|;
comment|/* add "\r\n" at the header end */
operator|*
name|p
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|request
operator|=
name|b
expr_stmt|;
return|return
name|NGX_OK
return|;
name|failed
label|:
name|OCSP_REQUEST_free
argument_list|(
name|ocsp
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_ocsp_process_status_line (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_process_status_line
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|rc
operator|=
name|ngx_ssl_ocsp_parse_status_line
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_EVENT, ctx->log, 0,                        "ssl ocsp status line \"%*s\"",                        ctx->response->pos - ctx->response->start,                        ctx->response->start);
endif|#
directive|endif
name|ctx
operator|->
name|process
operator|=
name|ngx_ssl_ocsp_process_headers
expr_stmt|;
return|return
name|ctx
operator|->
name|process
argument_list|(
name|ctx
argument_list|)
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
comment|/* rc == NGX_ERROR */
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP responder sent invalid response"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_ocsp_parse_status_line (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_parse_status_line
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
DECL|enum|__anon27caaf3f0203
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_H
name|sw_H
block|,
DECL|enumerator|sw_HT
name|sw_HT
block|,
DECL|enumerator|sw_HTT
name|sw_HTT
block|,
DECL|enumerator|sw_HTTP
name|sw_HTTP
block|,
DECL|enumerator|sw_first_major_digit
name|sw_first_major_digit
block|,
DECL|enumerator|sw_major_digit
name|sw_major_digit
block|,
DECL|enumerator|sw_first_minor_digit
name|sw_first_minor_digit
block|,
DECL|enumerator|sw_minor_digit
name|sw_minor_digit
block|,
DECL|enumerator|sw_status
name|sw_status
block|,
DECL|enumerator|sw_space_after_status
name|sw_space_after_status
block|,
DECL|enumerator|sw_status_text
name|sw_status_text
block|,
DECL|enumerator|sw_almost_done
name|sw_almost_done
block|}
name|state
enum|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp process status line"
argument_list|)
expr_stmt|;
name|state
operator|=
name|ctx
operator|->
name|state
expr_stmt|;
name|b
operator|=
name|ctx
operator|->
name|response
expr_stmt|;
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|b
operator|->
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
comment|/* "HTTP/" */
case|case
name|sw_start
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'H'
case|:
name|state
operator|=
name|sw_H
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
break|break;
case|case
name|sw_H
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'T'
case|:
name|state
operator|=
name|sw_HT
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
break|break;
case|case
name|sw_HT
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'T'
case|:
name|state
operator|=
name|sw_HTT
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
break|break;
case|case
name|sw_HTT
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'P'
case|:
name|state
operator|=
name|sw_HTTP
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
break|break;
case|case
name|sw_HTTP
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'/'
case|:
name|state
operator|=
name|sw_first_major_digit
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
break|break;
comment|/* the first digit of major HTTP version */
case|case
name|sw_first_major_digit
case|:
if|if
condition|(
name|ch
argument_list|<
literal|'1'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|state
operator|=
name|sw_major_digit
expr_stmt|;
break|break;
comment|/* the major HTTP version or dot */
case|case
name|sw_major_digit
case|:
if|if
condition|(
name|ch
operator|==
literal|'.'
condition|)
block|{
name|state
operator|=
name|sw_first_minor_digit
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
break|break;
comment|/* the first digit of minor HTTP version */
case|case
name|sw_first_minor_digit
case|:
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|state
operator|=
name|sw_minor_digit
expr_stmt|;
break|break;
comment|/* the minor HTTP version or the end of the request line */
case|case
name|sw_minor_digit
case|:
if|if
condition|(
name|ch
operator|==
literal|' '
condition|)
block|{
name|state
operator|=
name|sw_status
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
break|break;
comment|/* HTTP status code */
case|case
name|sw_status
case|:
if|if
condition|(
name|ch
operator|==
literal|' '
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|code
operator|=
name|ctx
operator|->
name|code
operator|*
literal|10
operator|+
name|ch
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
operator|++
name|ctx
operator|->
name|count
operator|==
literal|3
condition|)
block|{
name|state
operator|=
name|sw_space_after_status
expr_stmt|;
block|}
break|break;
comment|/* space or end of line */
case|case
name|sw_space_after_status
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
name|state
operator|=
name|sw_status_text
expr_stmt|;
break|break;
case|case
literal|'.'
case|:
comment|/* IIS may send 403.1, 403.2, etc */
name|state
operator|=
name|sw_status_text
expr_stmt|;
break|break;
case|case
name|CR
case|:
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
break|break;
comment|/* any text until end of line */
case|case
name|sw_status_text
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|CR
case|:
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
goto|goto
name|done
goto|;
block|}
break|break;
comment|/* end of status line */
case|case
name|sw_almost_done
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
block|}
block|}
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|state
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
name|done
label|:
name|b
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|sw_start
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_ocsp_process_headers (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_process_headers
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp process headers"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|rc
operator|=
name|ngx_ssl_ocsp_parse_header_line
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp header \"%*s: %*s\""
argument_list|,
name|ctx
operator|->
name|header_name_end
operator|-
name|ctx
operator|->
name|header_name_start
argument_list|,
name|ctx
operator|->
name|header_name_start
argument_list|,
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
argument_list|,
name|ctx
operator|->
name|header_start
argument_list|)
expr_stmt|;
name|len
operator|=
name|ctx
operator|->
name|header_name_end
operator|-
name|ctx
operator|->
name|header_name_start
expr_stmt|;
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
literal|"Content-Type"
argument_list|)
operator|-
literal|1
operator|&&
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_name_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Content-Type"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Content-Type"
argument_list|)
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|len
operator|=
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
expr_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
literal|"application/ocsp-response"
argument_list|)
operator|-
literal|1
operator|||
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"application/ocsp-response"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"application/ocsp-response"
argument_list|)
operator|-
literal|1
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP responder sent invalid "
literal|"\"Content-Type\" header: \"%*s\""
argument_list|,
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
argument_list|,
name|ctx
operator|->
name|header_start
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
continue|continue;
block|}
comment|/* TODO: honor Content-Length */
continue|continue;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_DONE
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
comment|/* rc == NGX_ERROR */
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"OCSP responder sent invalid response"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|process
operator|=
name|ngx_ssl_ocsp_process_body
expr_stmt|;
return|return
name|ctx
operator|->
name|process
argument_list|(
name|ctx
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_ocsp_parse_header_line (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_parse_header_line
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|u_char
name|c
decl_stmt|,
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|;
DECL|enum|__anon27caaf3f0303
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_name
name|sw_name
block|,
DECL|enumerator|sw_space_before_value
name|sw_space_before_value
block|,
DECL|enumerator|sw_value
name|sw_value
block|,
DECL|enumerator|sw_space_after_value
name|sw_space_after_value
block|,
DECL|enumerator|sw_almost_done
name|sw_almost_done
block|,
DECL|enumerator|sw_header_almost_done
name|sw_header_almost_done
block|}
name|state
enum|;
name|state
operator|=
name|ctx
operator|->
name|state
expr_stmt|;
for|for
control|(
name|p
operator|=
name|ctx
operator|->
name|response
operator|->
name|pos
init|;
name|p
operator|<
name|ctx
operator|->
name|response
operator|->
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug3(NGX_LOG_DEBUG_EVENT, ctx->log, 0,                        "s:%d in:'%02Xd:%c'", state, ch, ch);
endif|#
directive|endif
switch|switch
condition|(
name|state
condition|)
block|{
comment|/* first char */
case|case
name|sw_start
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|CR
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_header_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|header_done
goto|;
default|default:
name|state
operator|=
name|sw_name
expr_stmt|;
name|ctx
operator|->
name|header_name_start
operator|=
name|p
expr_stmt|;
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
break|break;
block|}
return|return
name|NGX_ERROR
return|;
block|}
break|break;
comment|/* header name */
case|case
name|sw_name
case|:
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|ch
operator|==
literal|':'
condition|)
block|{
name|ctx
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_space_before_value
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
literal|'-'
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|ch
operator|==
name|CR
condition|)
block|{
name|ctx
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
name|LF
condition|)
block|{
name|ctx
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
block|}
return|return
name|NGX_ERROR
return|;
comment|/* space* before header value */
case|case
name|sw_space_before_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
case|case
name|CR
case|:
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
default|default:
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
block|}
break|break;
comment|/* header value */
case|case
name|sw_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_space_after_value
expr_stmt|;
break|break;
case|case
name|CR
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
comment|/* space* before end of header line */
case|case
name|sw_space_after_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
case|case
name|CR
case|:
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end of header line */
case|case
name|sw_almost_done
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
comment|/* end of header */
case|case
name|sw_header_almost_done
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
goto|goto
name|header_done
goto|;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
block|}
block|}
name|ctx
operator|->
name|response
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|state
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
name|done
label|:
name|ctx
operator|->
name|response
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|sw_start
expr_stmt|;
return|return
name|NGX_OK
return|;
name|header_done
label|:
name|ctx
operator|->
name|response
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|sw_start
expr_stmt|;
return|return
name|NGX_DONE
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_ssl_ocsp_process_body (ngx_ssl_ocsp_ctx_t * ctx)
name|ngx_ssl_ocsp_process_body
parameter_list|(
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ssl ocsp process body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|done
condition|)
block|{
name|ctx
operator|->
name|handler
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NGX_DONE
return|;
block|}
return|return
name|NGX_AGAIN
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_ssl_ocsp_log_error (ngx_log_t * log,u_char * buf,size_t len)
name|ngx_ssl_ocsp_log_error
parameter_list|(
name|ngx_log_t
modifier|*
name|log
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_ssl_ocsp_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|log
operator|->
name|action
condition|)
block|{
name|p
operator|=
name|ngx_snprintf
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|" while %s"
argument_list|,
name|log
operator|->
name|action
argument_list|)
expr_stmt|;
name|len
operator|-=
name|p
operator|-
name|buf
expr_stmt|;
block|}
name|ctx
operator|=
name|log
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|ctx
condition|)
block|{
name|p
operator|=
name|ngx_snprintf
argument_list|(
name|p
argument_list|,
name|len
argument_list|,
literal|", responder: %V"
argument_list|,
operator|&
name|ctx
operator|->
name|host
argument_list|)
expr_stmt|;
block|}
return|return
name|p
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|ngx_int_t
DECL|function|ngx_ssl_stapling (ngx_conf_t * cf,ngx_ssl_t * ssl,ngx_str_t * file,ngx_str_t * responder,ngx_uint_t verify)
name|ngx_ssl_stapling
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|,
name|ngx_str_t
modifier|*
name|file
parameter_list|,
name|ngx_str_t
modifier|*
name|responder
parameter_list|,
name|ngx_uint_t
name|verify
parameter_list|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|ssl
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"ssl_stapling\" ignored, not supported"
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_ssl_stapling_resolver (ngx_conf_t * cf,ngx_ssl_t * ssl,ngx_resolver_t * resolver,ngx_msec_t resolver_timeout)
name|ngx_ssl_stapling_resolver
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_ssl_t
modifier|*
name|ssl
parameter_list|,
name|ngx_resolver_t
modifier|*
name|resolver
parameter_list|,
name|ngx_msec_t
name|resolver_timeout
parameter_list|)
block|{
return|return
name|NGX_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit

