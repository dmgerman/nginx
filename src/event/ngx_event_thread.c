begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_decl_stmt
DECL|variable|ngx_last_posted_event
name|volitile
name|int
name|ngx_last_posted_event
decl_stmt|;
end_decl_stmt

begin_typedef
DECL|struct|__anon2bf735c30208
typedef|typedef
struct|struct
block|{
DECL|member|tid
name|ngx_tid_t
name|tid
decl_stmt|;
DECL|member|cv
name|ngx_cv_t
name|cv
decl_stmt|;
DECL|typedef|ngx_thread_data_t
block|}
name|ngx_thread_data_t
typedef|;
end_typedef

begin_decl_stmt
DECL|variable|threead_data
specifier|static
name|ngx_thread_data_t
modifier|*
name|threead_data
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|err
operator|=
name|ngx_thread_cond_wait
argument_list|(
name|ngx_thread_data_cv
argument_list|,
name|ngx_thread_data_mutex
argument_list|)
expr_stmt|;
name|tid
operator|=
name|ngx_thread_self
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|thread_data_n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|thread_data
index|[
name|i
index|]
operator|.
name|tid
operator|==
name|tid
condition|)
block|{
name|cv
operator|=
name|thread_data
index|[
name|i
index|]
operator|.
name|cv
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|thread_data_n
condition|)
block|{
name|error
return|return
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|err
operator|=
name|ngx_thread_cond_wait
argument_list|(
name|cv
argument_list|,
name|ngx_posted_events_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_ALERT
argument_list|,
name|log
argument_list|,
name|err
argument_list|,
name|ngx_thread_cond_wait_n
literal|" failed, thread is exiting"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|ev
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ngx_last_posted_event
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|ev
operator|=
name|ngx_posted_events
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ev
operator|==
name|NULL
condition|)
block|{
continue|continue;
block|}
name|err
operator|=
name|ngx_thread_mutex_trylock
argument_list|(
name|ev
operator|->
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
name|ngx_posted_events
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|ngx_posted_events
index|[
name|ngx_last_posted_event
index|]
operator|==
name|NULL
condition|)
block|{
name|ngx_last_posted_event
operator|--
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|err
operator|==
name|NGX_EBUSY
condition|)
block|{
name|ev
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
name|ngx_log_error
argument_list|(
name|NGX_ALERT
argument_list|,
name|log
argument_list|,
name|err
argument_list|,
name|ngx_thread_mutex_unlock_n
literal|" failed,                               thread is exiting"
argument_list|)
expr_stmt|;
name|ngx_worker_thread_error
argument_list|()
expr_stmt|;
return|return;
block|}
name|err
operator|=
name|ngx_thread_mutex_unlock
argument_list|(
name|ngx_posted_events_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_ALERT
argument_list|,
name|log
argument_list|,
name|err
argument_list|,
name|ngx_thread_mutex_unlock_n
literal|" failed, thread exiting"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ev
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|ngx_event_handle_event
argument_list|(
name|ev
argument_list|)
expr_stmt|;
name|err
operator|=
name|ngx_thread_mutex_unlock
argument_list|(
name|ev
operator|->
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_ALERT
argument_list|,
name|log
argument_list|,
name|err
argument_list|,
name|ngx_thread_mutex_unlock_n
literal|" failed, thread exiting"
argument_list|)
expr_stmt|;
name|ngx_worker_thread_error
argument_list|()
expr_stmt|;
return|return;
block|}
name|err
operator|=
name|ngx_thread_mutex_lock
argument_list|(
name|ngx_posted_events_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_ALERT
argument_list|,
name|log
argument_list|,
name|err
argument_list|,
name|ngx_thread_mutex_lock_n
literal|" failed, thread exiting"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|restart
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_INFO
argument_list|,
name|log
argument_list|,
literal|0
argument_list|,
literal|"thread is exiting"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
end_block

begin_macro
name|ngx_worker_thread_error
argument_list|()
end_macro

begin_block
block|{
name|ngx_err_t
name|err
decl_stmt|;
name|err
operator|=
name|ngx_thread_mutex_unlock
argument_list|(
name|ngx_posted_events_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_ALERT
argument_list|,
name|log
argument_list|,
name|err
argument_list|,
name|ngx_thread_mutex_unlock_n
literal|" failed, thread exiting"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit

