begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  * Copyright (C) Nginx, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_stream.h>
end_include

begin_include
include|#
directive|include
file|<nginx.h>
end_include

begin_function_decl
specifier|static
name|ngx_stream_variable_t
modifier|*
name|ngx_stream_add_prefix_variable
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_binary_remote_addr
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_remote_addr
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_remote_port
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_proxy_protocol_addr
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_proxy_protocol_port
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_server_addr
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_server_port
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_bytes
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_session_time
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_status
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_connection
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_nginx_version
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_hostname
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_pid
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_msec
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_time_iso8601
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_time_local
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_variable_protocol
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_stream_core_variables
specifier|static
name|ngx_stream_variable_t
name|ngx_stream_core_variables
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"binary_remote_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_binary_remote_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"remote_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_remote_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"remote_port"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_remote_port
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_protocol_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_proxy_protocol_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_protocol_port"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_proxy_protocol_port
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_server_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_port"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_server_port
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"bytes_sent"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_bytes
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"bytes_received"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_bytes
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"session_time"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_session_time
block|,
literal|0
block|,
name|NGX_STREAM_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"status"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_status
block|,
literal|0
block|,
name|NGX_STREAM_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"connection"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_connection
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"nginx_version"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_nginx_version
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"hostname"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_hostname
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"pid"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_pid
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"msec"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_msec
block|,
literal|0
block|,
name|NGX_STREAM_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"time_iso8601"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_time_iso8601
block|,
literal|0
block|,
name|NGX_STREAM_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"time_local"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_time_local
block|,
literal|0
block|,
name|NGX_STREAM_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"protocol"
argument_list|)
block|,
name|NULL
block|,
name|ngx_stream_variable_protocol
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_null_string
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_stream_variable_null_value
name|ngx_stream_variable_value_t
name|ngx_stream_variable_null_value
init|=
name|ngx_stream_variable
argument_list|(
literal|""
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_stream_variable_true_value
name|ngx_stream_variable_value_t
name|ngx_stream_variable_true_value
init|=
name|ngx_stream_variable
argument_list|(
literal|"1"
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_stream_variable_depth
specifier|static
name|ngx_uint_t
name|ngx_stream_variable_depth
init|=
literal|100
decl_stmt|;
end_decl_stmt

begin_function
name|ngx_stream_variable_t
modifier|*
DECL|function|ngx_stream_add_variable (ngx_conf_t * cf,ngx_str_t * name,ngx_uint_t flags)
name|ngx_stream_add_variable
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|flags
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_hash_key_t
modifier|*
name|key
decl_stmt|;
name|ngx_stream_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
if|if
condition|(
name|name
operator|->
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid variable name \"$\""
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|NGX_STREAM_VAR_PREFIX
condition|)
block|{
return|return
name|ngx_stream_add_prefix_variable
argument_list|(
name|cf
argument_list|,
name|name
argument_list|,
name|flags
argument_list|)
return|;
block|}
name|cmcf
operator|=
name|ngx_stream_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|key
operator|=
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|key
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|key
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
name|v
operator|=
name|key
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|v
operator|->
name|flags
operator|&
name|NGX_STREAM_VAR_CHANGEABLE
operator|)
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the duplicate \"%V\" variable"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|flags
operator|&=
name|flags
operator||
operator|~
name|NGX_STREAM_VAR_WEAK
expr_stmt|;
return|return
name|v
return|;
block|}
name|v
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_variable_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ngx_strlow
argument_list|(
name|v
operator|->
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|set_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|get_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|v
operator|->
name|index
operator|=
literal|0
expr_stmt|;
name|rc
operator|=
name|ngx_hash_add_key
argument_list|(
name|cmcf
operator|->
name|variables_keys
argument_list|,
operator|&
name|v
operator|->
name|name
argument_list|,
name|v
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_BUSY
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"conflicting variable name \"%V\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|v
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_stream_variable_t
modifier|*
DECL|function|ngx_stream_add_prefix_variable (ngx_conf_t * cf,ngx_str_t * name,ngx_uint_t flags)
name|ngx_stream_add_prefix_variable
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|flags
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_stream_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_stream_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
name|v
operator|=
operator|&
name|v
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|v
operator|->
name|flags
operator|&
name|NGX_STREAM_VAR_CHANGEABLE
operator|)
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the duplicate \"%V\" variable"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|flags
operator|&=
name|flags
operator||
operator|~
name|NGX_STREAM_VAR_WEAK
expr_stmt|;
return|return
name|v
return|;
block|}
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|prefix_variables
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ngx_strlow
argument_list|(
name|v
operator|->
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|set_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|get_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|v
operator|->
name|index
operator|=
literal|0
expr_stmt|;
return|return
name|v
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_stream_get_variable_index (ngx_conf_t * cf,ngx_str_t * name)
name|ngx_stream_get_variable_index
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_stream_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
if|if
condition|(
name|name
operator|->
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid variable name \"$\""
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|cmcf
operator|=
name|ngx_stream_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|cmcf
operator|->
name|variables
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_variable_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
return|return
name|i
return|;
block|}
block|}
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|variables
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_strlow
argument_list|(
name|v
operator|->
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|set_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|get_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|index
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|-
literal|1
expr_stmt|;
return|return
name|v
operator|->
name|index
return|;
block|}
end_function

begin_function
name|ngx_stream_variable_value_t
modifier|*
DECL|function|ngx_stream_get_indexed_variable (ngx_stream_session_t * s,ngx_uint_t index)
name|ngx_stream_get_indexed_variable
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_uint_t
name|index
parameter_list|)
block|{
name|ngx_stream_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_stream_get_module_main_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|<=
name|index
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown variable index: %ui"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|s
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|not_found
operator|||
name|s
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|valid
condition|)
block|{
return|return
operator|&
name|s
operator|->
name|variables
index|[
name|index
index|]
return|;
block|}
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
if|if
condition|(
name|ngx_stream_variable_depth
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cycle while evaluating variable \"%V\""
argument_list|,
operator|&
name|v
index|[
name|index
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ngx_stream_variable_depth
operator|--
expr_stmt|;
if|if
condition|(
name|v
index|[
name|index
index|]
operator|.
name|get_handler
argument_list|(
name|s
argument_list|,
operator|&
name|s
operator|->
name|variables
index|[
name|index
index|]
argument_list|,
name|v
index|[
name|index
index|]
operator|.
name|data
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
name|ngx_stream_variable_depth
operator|++
expr_stmt|;
if|if
condition|(
name|v
index|[
name|index
index|]
operator|.
name|flags
operator|&
name|NGX_STREAM_VAR_NOCACHEABLE
condition|)
block|{
name|s
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|no_cacheable
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|&
name|s
operator|->
name|variables
index|[
name|index
index|]
return|;
block|}
name|ngx_stream_variable_depth
operator|++
expr_stmt|;
name|s
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|s
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|ngx_stream_variable_value_t
modifier|*
DECL|function|ngx_stream_get_flushed_variable (ngx_stream_session_t * s,ngx_uint_t index)
name|ngx_stream_get_flushed_variable
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_uint_t
name|index
parameter_list|)
block|{
name|ngx_stream_variable_value_t
modifier|*
name|v
decl_stmt|;
name|v
operator|=
operator|&
name|s
operator|->
name|variables
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|valid
operator|||
name|v
operator|->
name|not_found
condition|)
block|{
if|if
condition|(
operator|!
name|v
operator|->
name|no_cacheable
condition|)
block|{
return|return
name|v
return|;
block|}
name|v
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ngx_stream_get_indexed_variable
argument_list|(
name|s
argument_list|,
name|index
argument_list|)
return|;
block|}
end_function

begin_function
name|ngx_stream_variable_value_t
modifier|*
DECL|function|ngx_stream_get_variable (ngx_stream_session_t * s,ngx_str_t * name,ngx_uint_t key)
name|ngx_stream_get_variable
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|key
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_stream_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_stream_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_stream_get_module_main_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|ngx_hash_find
argument_list|(
operator|&
name|cmcf
operator|->
name|variables_hash
argument_list|,
name|key
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
condition|)
block|{
if|if
condition|(
name|v
operator|->
name|flags
operator|&
name|NGX_STREAM_VAR_INDEXED
condition|)
block|{
return|return
name|ngx_stream_get_flushed_variable
argument_list|(
name|s
argument_list|,
name|v
operator|->
name|index
argument_list|)
return|;
block|}
if|if
condition|(
name|ngx_stream_variable_depth
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cycle while evaluating variable \"%V\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ngx_stream_variable_depth
operator|--
expr_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|&&
name|v
operator|->
name|get_handler
argument_list|(
name|s
argument_list|,
name|vv
argument_list|,
name|v
operator|->
name|data
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
name|ngx_stream_variable_depth
operator|++
expr_stmt|;
return|return
name|vv
return|;
block|}
name|ngx_stream_variable_depth
operator|++
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|len
operator|=
literal|0
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|elts
expr_stmt|;
name|n
operator|=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|>=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|&&
name|name
operator|->
name|len
operator|>
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|len
operator|=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
expr_stmt|;
name|n
operator|=
name|i
expr_stmt|;
block|}
block|}
if|if
condition|(
name|n
operator|!=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
condition|)
block|{
if|if
condition|(
name|v
index|[
name|n
index|]
operator|.
name|get_handler
argument_list|(
name|s
argument_list|,
name|vv
argument_list|,
operator|(
name|uintptr_t
operator|)
name|name
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
return|return
name|vv
return|;
block|}
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_binary_remote_addr (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_binary_remote_addr
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_INET6
operator|)
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|s
operator|->
name|connection
operator|->
name|sockaddr
operator|->
name|sa_family
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HAVE_INET6
operator|)
case|case
name|AF_INET6
case|:
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|s
operator|->
name|connection
operator|->
name|sockaddr
expr_stmt|;
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
comment|/* AF_INET */
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|s
operator|->
name|connection
operator|->
name|sockaddr
expr_stmt|;
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
name|in_addr_t
argument_list|)
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|sin
operator|->
name|sin_addr
expr_stmt|;
break|break;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_remote_addr (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_remote_addr
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|len
operator|=
name|s
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|s
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_remote_port (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_remote_port
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_uint_t
name|port
decl_stmt|;
name|v
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"65535"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|port
operator|=
name|ngx_inet_get_port
argument_list|(
name|s
operator|->
name|connection
operator|->
name|sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|>
literal|0
operator|&&
name|port
operator|<
literal|65536
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%ui"
argument_list|,
name|port
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_proxy_protocol_addr (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_proxy_protocol_addr
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|len
operator|=
name|s
operator|->
name|connection
operator|->
name|proxy_protocol_addr
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|s
operator|->
name|connection
operator|->
name|proxy_protocol_addr
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_proxy_protocol_port (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_proxy_protocol_port
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_uint_t
name|port
decl_stmt|;
name|v
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"65535"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|port
operator|=
name|s
operator|->
name|connection
operator|->
name|proxy_protocol_port
expr_stmt|;
if|if
condition|(
name|port
operator|>
literal|0
operator|&&
name|port
operator|<
literal|65536
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%ui"
argument_list|,
name|port
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_server_addr (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_server_addr
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
name|str
decl_stmt|;
name|u_char
name|addr
index|[
name|NGX_SOCKADDR_STRLEN
index|]
decl_stmt|;
name|str
operator|.
name|len
operator|=
name|NGX_SOCKADDR_STRLEN
expr_stmt|;
name|str
operator|.
name|data
operator|=
name|addr
expr_stmt|;
if|if
condition|(
name|ngx_connection_local_sockaddr
argument_list|(
name|s
operator|->
name|connection
argument_list|,
operator|&
name|str
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|str
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|str
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|str
operator|.
name|data
argument_list|,
name|addr
argument_list|,
name|str
operator|.
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|str
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|str
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_server_port (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_server_port
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_uint_t
name|port
decl_stmt|;
name|v
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ngx_connection_local_sockaddr
argument_list|(
name|s
operator|->
name|connection
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"65535"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|port
operator|=
name|ngx_inet_get_port
argument_list|(
name|s
operator|->
name|connection
operator|->
name|local_sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|>
literal|0
operator|&&
name|port
operator|<
literal|65536
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%ui"
argument_list|,
name|port
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_bytes (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_bytes
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|NGX_OFF_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|data
operator|==
literal|1
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%O"
argument_list|,
name|s
operator|->
name|received
argument_list|)
operator|-
name|p
expr_stmt|;
block|}
else|else
block|{
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%O"
argument_list|,
name|s
operator|->
name|connection
operator|->
name|sent
argument_list|)
operator|-
name|p
expr_stmt|;
block|}
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_session_time (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_session_time
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_time_t
modifier|*
name|tp
decl_stmt|;
name|ngx_msec_int_t
name|ms
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|NGX_TIME_T_LEN
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
name|ms
operator|=
operator|(
name|ngx_msec_int_t
operator|)
operator|(
operator|(
name|tp
operator|->
name|sec
operator|-
name|s
operator|->
name|start_sec
operator|)
operator|*
literal|1000
operator|+
operator|(
name|tp
operator|->
name|msec
operator|-
name|s
operator|->
name|start_msec
operator|)
operator|)
expr_stmt|;
name|ms
operator|=
name|ngx_max
argument_list|(
name|ms
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%T.%03M"
argument_list|,
operator|(
name|time_t
operator|)
name|ms
operator|/
literal|1000
argument_list|,
name|ms
operator|%
literal|1000
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_status (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_status
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|NGX_INT_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%03ui"
argument_list|,
name|s
operator|->
name|status
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_connection (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_connection
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|NGX_ATOMIC_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%uA"
argument_list|,
name|s
operator|->
name|connection
operator|->
name|number
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_nginx_version (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_nginx_version
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
name|NGINX_VERSION
argument_list|)
operator|-
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
name|NGINX_VERSION
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_hostname (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_hostname
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_cycle
operator|->
name|hostname
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_cycle
operator|->
name|hostname
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_pid (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_pid
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|NGX_INT64_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%P"
argument_list|,
name|ngx_pid
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_msec (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_msec
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_time_t
modifier|*
name|tp
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|NGX_TIME_T_LEN
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%T.%03M"
argument_list|,
name|tp
operator|->
name|sec
argument_list|,
name|tp
operator|->
name|msec
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_time_iso8601 (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_time_iso8601
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|ngx_cached_http_log_iso8601
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|ngx_cached_http_log_iso8601
operator|.
name|data
argument_list|,
name|ngx_cached_http_log_iso8601
operator|.
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_cached_http_log_iso8601
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_time_local (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_time_local
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|ngx_cached_http_log_time
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|ngx_cached_http_log_time
operator|.
name|data
argument_list|,
name|ngx_cached_http_log_time
operator|.
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_cached_http_log_time
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_protocol (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_protocol
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|len
operator|=
literal|3
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|s
operator|->
name|connection
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|?
literal|"UDP"
else|:
literal|"TCP"
operator|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|void
modifier|*
DECL|function|ngx_stream_map_find (ngx_stream_session_t * s,ngx_stream_map_t * map,ngx_str_t * match)
name|ngx_stream_map_find
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_map_t
modifier|*
name|map
parameter_list|,
name|ngx_str_t
modifier|*
name|match
parameter_list|)
block|{
name|void
modifier|*
name|value
decl_stmt|;
name|u_char
modifier|*
name|low
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|key
decl_stmt|;
name|len
operator|=
name|match
operator|->
name|len
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
name|low
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|low
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
name|low
operator|=
name|NULL
expr_stmt|;
block|}
name|key
operator|=
name|ngx_hash_strlow
argument_list|(
name|low
argument_list|,
name|match
operator|->
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|value
operator|=
name|ngx_hash_find_combined
argument_list|(
operator|&
name|map
operator|->
name|hash
argument_list|,
name|key
argument_list|,
name|low
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
block|{
return|return
name|value
return|;
block|}
if|#
directive|if
operator|(
name|NGX_PCRE
operator|)
if|if
condition|(
name|len
operator|&&
name|map
operator|->
name|nregex
condition|)
block|{
name|ngx_int_t
name|n
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_stream_map_regex_t
modifier|*
name|reg
decl_stmt|;
name|reg
operator|=
name|map
operator|->
name|regex
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|map
operator|->
name|nregex
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|ngx_stream_regex_exec
argument_list|(
name|s
argument_list|,
name|reg
index|[
name|i
index|]
operator|.
name|regex
argument_list|,
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_OK
condition|)
block|{
return|return
name|reg
index|[
name|i
index|]
operator|.
name|value
return|;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_DECLINED
condition|)
block|{
continue|continue;
block|}
comment|/* NGX_ERROR */
return|return
name|NULL
return|;
block|}
block|}
endif|#
directive|endif
return|return
name|NULL
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_PCRE
operator|)
end_if

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_variable_not_found (ngx_stream_session_t * s,ngx_stream_variable_value_t * v,uintptr_t data)
name|ngx_stream_variable_not_found
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_stream_regex_t
modifier|*
DECL|function|ngx_stream_regex_compile (ngx_conf_t * cf,ngx_regex_compile_t * rc)
name|ngx_stream_regex_compile
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_regex_compile_t
modifier|*
name|rc
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ngx_str_t
name|name
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_stream_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_stream_regex_t
modifier|*
name|re
decl_stmt|;
name|ngx_stream_regex_variable_t
modifier|*
name|rv
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|rc
operator|->
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
if|if
condition|(
name|ngx_regex_compile
argument_list|(
name|rc
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"%V"
argument_list|,
operator|&
name|rc
operator|->
name|err
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|re
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_regex_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|re
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|re
operator|->
name|regex
operator|=
name|rc
operator|->
name|regex
expr_stmt|;
name|re
operator|->
name|ncaptures
operator|=
name|rc
operator|->
name|captures
expr_stmt|;
name|re
operator|->
name|name
operator|=
name|rc
operator|->
name|pattern
expr_stmt|;
name|cmcf
operator|=
name|ngx_stream_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|cmcf
operator|->
name|ncaptures
operator|=
name|ngx_max
argument_list|(
name|cmcf
operator|->
name|ncaptures
argument_list|,
name|re
operator|->
name|ncaptures
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|ngx_uint_t
operator|)
name|rc
operator|->
name|named_captures
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
return|return
name|re
return|;
block|}
name|rv
operator|=
name|ngx_palloc
argument_list|(
name|rc
operator|->
name|pool
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|ngx_stream_regex_variable_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|re
operator|->
name|variables
operator|=
name|rv
expr_stmt|;
name|re
operator|->
name|nvariables
operator|=
name|n
expr_stmt|;
name|size
operator|=
name|rc
operator|->
name|name_size
expr_stmt|;
name|p
operator|=
name|rc
operator|->
name|names
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|rv
index|[
name|i
index|]
operator|.
name|capture
operator|=
literal|2
operator|*
operator|(
operator|(
name|p
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator|+
name|p
index|[
literal|1
index|]
operator|)
expr_stmt|;
name|name
operator|.
name|data
operator|=
operator|&
name|p
index|[
literal|2
index|]
expr_stmt|;
name|name
operator|.
name|len
operator|=
name|ngx_strlen
argument_list|(
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
name|v
operator|=
name|ngx_stream_add_variable
argument_list|(
name|cf
argument_list|,
operator|&
name|name
argument_list|,
name|NGX_STREAM_VAR_CHANGEABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|rv
index|[
name|i
index|]
operator|.
name|index
operator|=
name|ngx_stream_get_variable_index
argument_list|(
name|cf
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
index|[
name|i
index|]
operator|.
name|index
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|get_handler
operator|=
name|ngx_stream_variable_not_found
expr_stmt|;
name|p
operator|+=
name|size
expr_stmt|;
block|}
return|return
name|re
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_stream_regex_exec (ngx_stream_session_t * s,ngx_stream_regex_t * re,ngx_str_t * str)
name|ngx_stream_regex_exec
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_regex_t
modifier|*
name|re
parameter_list|,
name|ngx_str_t
modifier|*
name|str
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|,
name|index
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|,
name|len
decl_stmt|;
name|ngx_stream_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_stream_get_module_main_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|re
operator|->
name|ncaptures
condition|)
block|{
name|len
operator|=
name|cmcf
operator|->
name|ncaptures
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|captures
operator|==
name|NULL
condition|)
block|{
name|s
operator|->
name|captures
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|captures
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
block|}
else|else
block|{
name|len
operator|=
literal|0
expr_stmt|;
block|}
name|rc
operator|=
name|ngx_regex_exec
argument_list|(
name|re
operator|->
name|regex
argument_list|,
name|str
argument_list|,
name|s
operator|->
name|captures
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_REGEX_NO_MATCHED
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
name|ngx_regex_exec_n
literal|" failed: %i on \"%V\" using \"%V\""
argument_list|,
name|rc
argument_list|,
name|str
argument_list|,
operator|&
name|re
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|re
operator|->
name|nvariables
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|re
operator|->
name|variables
index|[
name|i
index|]
operator|.
name|capture
expr_stmt|;
name|index
operator|=
name|re
operator|->
name|variables
index|[
name|i
index|]
operator|.
name|index
expr_stmt|;
name|vv
operator|=
operator|&
name|s
operator|->
name|variables
index|[
name|index
index|]
expr_stmt|;
name|vv
operator|->
name|len
operator|=
name|s
operator|->
name|captures
index|[
name|n
operator|+
literal|1
index|]
operator|-
name|s
operator|->
name|captures
index|[
name|n
index|]
expr_stmt|;
name|vv
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|vv
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|data
operator|=
operator|&
name|str
operator|->
name|data
index|[
name|s
operator|->
name|captures
index|[
name|n
index|]
index|]
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
block|{
name|ngx_stream_variable_t
modifier|*
name|v
decl_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"stream regex set $%V to \"%v\""
argument_list|,
operator|&
name|v
index|[
name|index
index|]
operator|.
name|name
argument_list|,
name|vv
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
name|s
operator|->
name|ncaptures
operator|=
name|rc
operator|*
literal|2
expr_stmt|;
name|s
operator|->
name|captures_data
operator|=
name|str
operator|->
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|ngx_int_t
DECL|function|ngx_stream_variables_add_core_vars (ngx_conf_t * cf)
name|ngx_stream_variables_add_core_vars
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_stream_variable_t
modifier|*
name|cv
decl_stmt|,
modifier|*
name|v
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_stream_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|cmcf
operator|->
name|variables_keys
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|temp_pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_hash_keys_arrays_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmcf
operator|->
name|variables_keys
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cmcf
operator|->
name|variables_keys
operator|->
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
name|cmcf
operator|->
name|variables_keys
operator|->
name|temp_pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
if|if
condition|(
name|ngx_hash_keys_array_init
argument_list|(
name|cmcf
operator|->
name|variables_keys
argument_list|,
name|NGX_HASH_SMALL
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|cmcf
operator|->
name|prefix_variables
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_variable_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
for|for
control|(
name|cv
operator|=
name|ngx_stream_core_variables
init|;
name|cv
operator|->
name|name
operator|.
name|len
condition|;
name|cv
operator|++
control|)
block|{
name|v
operator|=
name|ngx_stream_add_variable
argument_list|(
name|cf
argument_list|,
operator|&
name|cv
operator|->
name|name
argument_list|,
name|cv
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|v
operator|=
operator|*
name|cv
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_stream_variables_init_vars (ngx_conf_t * cf)
name|ngx_stream_variables_init_vars
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_hash_key_t
modifier|*
name|key
decl_stmt|;
name|ngx_hash_init_t
name|hash
decl_stmt|;
name|ngx_stream_variable_t
modifier|*
name|v
decl_stmt|,
modifier|*
name|av
decl_stmt|,
modifier|*
name|pv
decl_stmt|;
name|ngx_stream_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
comment|/* set the handlers for the indexed stream variables */
name|cmcf
operator|=
name|ngx_stream_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
name|pv
operator|=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|elts
expr_stmt|;
name|key
operator|=
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|nelts
condition|;
name|n
operator|++
control|)
block|{
name|av
operator|=
name|key
index|[
name|n
index|]
operator|.
name|value
expr_stmt|;
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|==
name|key
index|[
name|n
index|]
operator|.
name|key
operator|.
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|key
index|[
name|n
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
index|[
name|i
index|]
operator|.
name|get_handler
operator|=
name|av
operator|->
name|get_handler
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|data
operator|=
name|av
operator|->
name|data
expr_stmt|;
name|av
operator|->
name|flags
operator||=
name|NGX_STREAM_VAR_INDEXED
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|av
operator|->
name|flags
expr_stmt|;
name|av
operator|->
name|index
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|av
operator|->
name|get_handler
operator|==
name|NULL
operator|||
operator|(
name|av
operator|->
name|flags
operator|&
name|NGX_STREAM_VAR_WEAK
operator|)
condition|)
block|{
break|break;
block|}
goto|goto
name|next
goto|;
block|}
block|}
name|len
operator|=
literal|0
expr_stmt|;
name|av
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|>=
name|pv
index|[
name|n
index|]
operator|.
name|name
operator|.
name|len
operator|&&
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|>
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|pv
index|[
name|n
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|pv
index|[
name|n
index|]
operator|.
name|name
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|av
operator|=
operator|&
name|pv
index|[
name|n
index|]
expr_stmt|;
name|len
operator|=
name|pv
index|[
name|n
index|]
operator|.
name|name
operator|.
name|len
expr_stmt|;
block|}
block|}
if|if
condition|(
name|av
condition|)
block|{
name|v
index|[
name|i
index|]
operator|.
name|get_handler
operator|=
name|av
operator|->
name|get_handler
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|data
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|av
operator|->
name|flags
expr_stmt|;
goto|goto
name|next
goto|;
block|}
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|get_handler
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown \"%V\" variable"
argument_list|,
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|next
label|:
continue|continue;
block|}
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|nelts
condition|;
name|n
operator|++
control|)
block|{
name|av
operator|=
name|key
index|[
name|n
index|]
operator|.
name|value
expr_stmt|;
if|if
condition|(
name|av
operator|->
name|flags
operator|&
name|NGX_STREAM_VAR_NOHASH
condition|)
block|{
name|key
index|[
name|n
index|]
operator|.
name|key
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|hash
operator|.
name|hash
operator|=
operator|&
name|cmcf
operator|->
name|variables_hash
expr_stmt|;
name|hash
operator|.
name|key
operator|=
name|ngx_hash_key
expr_stmt|;
name|hash
operator|.
name|max_size
operator|=
name|cmcf
operator|->
name|variables_hash_max_size
expr_stmt|;
name|hash
operator|.
name|bucket_size
operator|=
name|cmcf
operator|->
name|variables_hash_bucket_size
expr_stmt|;
name|hash
operator|.
name|name
operator|=
literal|"variables_hash"
expr_stmt|;
name|hash
operator|.
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
name|hash
operator|.
name|temp_pool
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ngx_hash_init
argument_list|(
operator|&
name|hash
argument_list|,
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|elts
argument_list|,
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|nelts
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cmcf
operator|->
name|variables_keys
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

end_unit

