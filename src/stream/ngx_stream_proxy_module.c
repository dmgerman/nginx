begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Roman Arutyunyan  * Copyright (C) Nginx, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_stream.h>
end_include

begin_typedef
DECL|struct|__anon2be6ae3d0108
typedef|typedef
struct|struct
block|{
DECL|member|addr
name|ngx_addr_t
modifier|*
name|addr
decl_stmt|;
DECL|member|value
name|ngx_stream_complex_value_t
modifier|*
name|value
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_TRANSPARENT_PROXY
operator|)
DECL|member|transparent
name|ngx_uint_t
name|transparent
decl_stmt|;
comment|/* unsigned  transparent:1; */
endif|#
directive|endif
DECL|typedef|ngx_stream_upstream_local_t
block|}
name|ngx_stream_upstream_local_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2be6ae3d0208
typedef|typedef
struct|struct
block|{
DECL|member|connect_timeout
name|ngx_msec_t
name|connect_timeout
decl_stmt|;
DECL|member|timeout
name|ngx_msec_t
name|timeout
decl_stmt|;
DECL|member|next_upstream_timeout
name|ngx_msec_t
name|next_upstream_timeout
decl_stmt|;
DECL|member|buffer_size
name|size_t
name|buffer_size
decl_stmt|;
DECL|member|upload_rate
name|size_t
name|upload_rate
decl_stmt|;
DECL|member|download_rate
name|size_t
name|download_rate
decl_stmt|;
DECL|member|responses
name|ngx_uint_t
name|responses
decl_stmt|;
DECL|member|next_upstream_tries
name|ngx_uint_t
name|next_upstream_tries
decl_stmt|;
DECL|member|next_upstream
name|ngx_flag_t
name|next_upstream
decl_stmt|;
DECL|member|proxy_protocol
name|ngx_flag_t
name|proxy_protocol
decl_stmt|;
DECL|member|local
name|ngx_stream_upstream_local_t
modifier|*
name|local
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
DECL|member|ssl_enable
name|ngx_flag_t
name|ssl_enable
decl_stmt|;
DECL|member|ssl_session_reuse
name|ngx_flag_t
name|ssl_session_reuse
decl_stmt|;
DECL|member|ssl_protocols
name|ngx_uint_t
name|ssl_protocols
decl_stmt|;
DECL|member|ssl_ciphers
name|ngx_str_t
name|ssl_ciphers
decl_stmt|;
DECL|member|ssl_name
name|ngx_stream_complex_value_t
modifier|*
name|ssl_name
decl_stmt|;
DECL|member|ssl_server_name
name|ngx_flag_t
name|ssl_server_name
decl_stmt|;
DECL|member|ssl_verify
name|ngx_flag_t
name|ssl_verify
decl_stmt|;
DECL|member|ssl_verify_depth
name|ngx_uint_t
name|ssl_verify_depth
decl_stmt|;
DECL|member|ssl_trusted_certificate
name|ngx_str_t
name|ssl_trusted_certificate
decl_stmt|;
DECL|member|ssl_crl
name|ngx_str_t
name|ssl_crl
decl_stmt|;
DECL|member|ssl_certificate
name|ngx_str_t
name|ssl_certificate
decl_stmt|;
DECL|member|ssl_certificate_key
name|ngx_str_t
name|ssl_certificate_key
decl_stmt|;
DECL|member|ssl_passwords
name|ngx_array_t
modifier|*
name|ssl_passwords
decl_stmt|;
DECL|member|ssl
name|ngx_ssl_t
modifier|*
name|ssl
decl_stmt|;
endif|#
directive|endif
DECL|member|upstream
name|ngx_stream_upstream_srv_conf_t
modifier|*
name|upstream
decl_stmt|;
DECL|member|upstream_value
name|ngx_stream_complex_value_t
modifier|*
name|upstream_value
decl_stmt|;
DECL|typedef|ngx_stream_proxy_srv_conf_t
block|}
name|ngx_stream_proxy_srv_conf_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_handler
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_proxy_eval
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_proxy_set_local
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_upstream_t
modifier|*
name|u
parameter_list|,
name|ngx_stream_upstream_local_t
modifier|*
name|local
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_connect
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_init_upstream
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_resolve_handler
parameter_list|(
name|ngx_resolver_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_upstream_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_downstream_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_process_connection
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|,
name|ngx_uint_t
name|from_upstream
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_connect_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_proxy_test_connect
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_process
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_uint_t
name|from_upstream
parameter_list|,
name|ngx_uint_t
name|do_write
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_next_upstream
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_finalize
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_uint_t
name|rc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_stream_proxy_log_error
parameter_list|(
name|ngx_log_t
modifier|*
name|log
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_stream_proxy_create_srv_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_stream_proxy_merge_srv_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_stream_proxy_pass
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_stream_proxy_bind
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_proxy_send_proxy_protocol
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
end_if

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_stream_proxy_ssl_password_file
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_ssl_init_connection
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_stream_proxy_ssl_handshake
parameter_list|(
name|ngx_connection_t
modifier|*
name|pc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_proxy_ssl_name
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_stream_proxy_set_ssl
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_stream_proxy_ssl_protocols
specifier|static
name|ngx_conf_bitmask_t
name|ngx_stream_proxy_ssl_protocols
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"SSLv2"
argument_list|)
block|,
name|NGX_SSL_SSLv2
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"SSLv3"
argument_list|)
block|,
name|NGX_SSL_SSLv3
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"TLSv1"
argument_list|)
block|,
name|NGX_SSL_TLSv1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"TLSv1.1"
argument_list|)
block|,
name|NGX_SSL_TLSv1_1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"TLSv1.2"
argument_list|)
block|,
name|NGX_SSL_TLSv1_2
block|}
block|,
block|{
name|ngx_null_string
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
DECL|variable|ngx_conf_deprecated_proxy_downstream_buffer
specifier|static
name|ngx_conf_deprecated_t
name|ngx_conf_deprecated_proxy_downstream_buffer
init|=
block|{
name|ngx_conf_deprecated
block|,
literal|"proxy_downstream_buffer"
block|,
literal|"proxy_buffer_size"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_conf_deprecated_proxy_upstream_buffer
specifier|static
name|ngx_conf_deprecated_t
name|ngx_conf_deprecated_proxy_upstream_buffer
init|=
block|{
name|ngx_conf_deprecated
block|,
literal|"proxy_upstream_buffer"
block|,
literal|"proxy_buffer_size"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_stream_proxy_commands
specifier|static
name|ngx_command_t
name|ngx_stream_proxy_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"proxy_pass"
argument_list|)
block|,
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_stream_proxy_pass
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_bind"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE12
block|,
name|ngx_stream_proxy_bind
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_connect_timeout"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|connect_timeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_timeout"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|timeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_buffer_size"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_size_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|buffer_size
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_downstream_buffer"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_size_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|buffer_size
argument_list|)
block|,
operator|&
name|ngx_conf_deprecated_proxy_downstream_buffer
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_upstream_buffer"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_size_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|buffer_size
argument_list|)
block|,
operator|&
name|ngx_conf_deprecated_proxy_upstream_buffer
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_upload_rate"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_size_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|upload_rate
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_download_rate"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_size_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|download_rate
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_responses"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_num_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|responses
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_next_upstream"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|next_upstream
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_next_upstream_tries"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_num_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|next_upstream_tries
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_next_upstream_timeout"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|next_upstream_timeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_protocol"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|proxy_protocol
argument_list|)
block|,
name|NULL
block|}
block|,
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_enable
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_session_reuse"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_session_reuse
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_protocols"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_1MORE
block|,
name|ngx_conf_set_bitmask_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_protocols
argument_list|)
block|,
operator|&
name|ngx_stream_proxy_ssl_protocols
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_ciphers"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_ciphers
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_name"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_stream_set_complex_value_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_name
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_server_name"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_server_name
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_verify"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_verify
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_verify_depth"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_num_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_verify_depth
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_trusted_certificate"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_trusted_certificate
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_crl"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_crl
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_certificate"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_certificate
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_certificate_key"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_slot
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|,
name|ssl_certificate_key
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_ssl_password_file"
argument_list|)
block|,
name|NGX_STREAM_MAIN_CONF
operator||
name|NGX_STREAM_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_stream_proxy_ssl_password_file
block|,
name|NGX_STREAM_SRV_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
endif|#
directive|endif
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_stream_proxy_module_ctx
specifier|static
name|ngx_stream_module_t
name|ngx_stream_proxy_module_ctx
init|=
block|{
name|NULL
block|,
comment|/* preconfiguration */
name|NULL
block|,
comment|/* postconfiguration */
name|NULL
block|,
comment|/* create main configuration */
name|NULL
block|,
comment|/* init main configuration */
name|ngx_stream_proxy_create_srv_conf
block|,
comment|/* create server configuration */
name|ngx_stream_proxy_merge_srv_conf
comment|/* merge server configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_stream_proxy_module
name|ngx_module_t
name|ngx_stream_proxy_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_stream_proxy_module_ctx
block|,
comment|/* module context */
name|ngx_stream_proxy_commands
block|,
comment|/* module directives */
name|NGX_STREAM_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|NULL
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|NULL
block|,
comment|/* exit process */
name|NULL
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_handler (ngx_stream_session_t * s)
name|ngx_stream_proxy_handler
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_str_t
modifier|*
name|host
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_resolver_ctx_t
modifier|*
name|ctx
decl_stmt|,
name|temp
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|ngx_stream_upstream_srv_conf_t
modifier|*
name|uscf
decl_stmt|,
modifier|*
modifier|*
name|uscfp
decl_stmt|;
name|ngx_stream_upstream_main_conf_t
modifier|*
name|umcf
decl_stmt|;
name|c
operator|=
name|s
operator|->
name|connection
expr_stmt|;
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"proxy connection handler"
argument_list|)
expr_stmt|;
name|u
operator|=
name|ngx_pcalloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_upstream_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|s
operator|->
name|upstream
operator|=
name|u
expr_stmt|;
name|s
operator|->
name|log_handler
operator|=
name|ngx_stream_proxy_log_error
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|log
operator|=
name|c
operator|->
name|log
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|log_error
operator|=
name|NGX_ERROR_ERR
expr_stmt|;
if|if
condition|(
name|ngx_stream_proxy_set_local
argument_list|(
name|s
argument_list|,
name|u
argument_list|,
name|pscf
operator|->
name|local
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|peer
operator|.
name|type
operator|=
name|c
operator|->
name|type
expr_stmt|;
name|u
operator|->
name|proxy_protocol
operator|=
name|pscf
operator|->
name|proxy_protocol
expr_stmt|;
name|u
operator|->
name|start_sec
operator|=
name|ngx_time
argument_list|()
expr_stmt|;
name|c
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_stream_proxy_downstream_handler
expr_stmt|;
name|c
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_stream_proxy_downstream_handler
expr_stmt|;
name|s
operator|->
name|upstream_states
operator|=
name|ngx_array_create
argument_list|(
name|c
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_upstream_state_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|upstream_states
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|SOCK_STREAM
condition|)
block|{
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|pscf
operator|->
name|buffer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|downstream_buf
operator|.
name|start
operator|=
name|p
expr_stmt|;
name|u
operator|->
name|downstream_buf
operator|.
name|end
operator|=
name|p
operator|+
name|pscf
operator|->
name|buffer_size
expr_stmt|;
name|u
operator|->
name|downstream_buf
operator|.
name|pos
operator|=
name|p
expr_stmt|;
name|u
operator|->
name|downstream_buf
operator|.
name|last
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|proxy_protocol
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
operator|&&
name|pscf
operator|->
name|ssl
operator|==
name|NULL
endif|#
directive|endif
operator|&&
name|pscf
operator|->
name|buffer_size
operator|>=
name|NGX_PROXY_PROTOCOL_MAX_HEADER
condition|)
block|{
comment|/* optimization for a typical case */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"stream proxy send PROXY protocol header"
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_proxy_protocol_write
argument_list|(
name|c
argument_list|,
name|u
operator|->
name|downstream_buf
operator|.
name|last
argument_list|,
name|u
operator|->
name|downstream_buf
operator|.
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|downstream_buf
operator|.
name|last
operator|=
name|p
expr_stmt|;
name|u
operator|->
name|proxy_protocol
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|read
operator|->
name|ready
condition|)
block|{
name|ngx_post_event
argument_list|(
name|c
operator|->
name|read
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pscf
operator|->
name|upstream_value
condition|)
block|{
if|if
condition|(
name|ngx_stream_proxy_eval
argument_list|(
name|s
argument_list|,
name|pscf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|u
operator|->
name|resolved
operator|==
name|NULL
condition|)
block|{
name|uscf
operator|=
name|pscf
operator|->
name|upstream
expr_stmt|;
block|}
else|else
block|{
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
name|u
operator|->
name|ssl_name
operator|=
name|u
operator|->
name|resolved
operator|->
name|host
expr_stmt|;
endif|#
directive|endif
name|host
operator|=
operator|&
name|u
operator|->
name|resolved
operator|->
name|host
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|resolved
operator|->
name|sockaddr
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|resolved
operator|->
name|port
operator|==
literal|0
operator|&&
name|u
operator|->
name|resolved
operator|->
name|sockaddr
operator|->
name|sa_family
operator|!=
name|AF_UNIX
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no port in upstream \"%V\""
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ngx_stream_upstream_create_round_robin_peer
argument_list|(
name|s
argument_list|,
name|u
operator|->
name|resolved
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_stream_proxy_connect
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|umcf
operator|=
name|ngx_stream_get_module_main_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_upstream_module
argument_list|)
expr_stmt|;
name|uscfp
operator|=
name|umcf
operator|->
name|upstreams
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|umcf
operator|->
name|upstreams
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|uscf
operator|=
name|uscfp
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|uscf
operator|->
name|host
operator|.
name|len
operator|==
name|host
operator|->
name|len
operator|&&
operator|(
operator|(
name|uscf
operator|->
name|port
operator|==
literal|0
operator|&&
name|u
operator|->
name|resolved
operator|->
name|no_port
operator|)
operator|||
name|uscf
operator|->
name|port
operator|==
name|u
operator|->
name|resolved
operator|->
name|port
operator|)
operator|&&
name|ngx_strncasecmp
argument_list|(
name|uscf
operator|->
name|host
operator|.
name|data
argument_list|,
name|host
operator|->
name|data
argument_list|,
name|host
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
goto|goto
name|found
goto|;
block|}
block|}
if|if
condition|(
name|u
operator|->
name|resolved
operator|->
name|port
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no port in upstream \"%V\""
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|temp
operator|.
name|name
operator|=
operator|*
name|host
expr_stmt|;
name|cscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ngx_resolve_start
argument_list|(
name|cscf
operator|->
name|resolver
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ctx
operator|==
name|NGX_NO_RESOLVER
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no resolver defined to resolve %V"
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|->
name|name
operator|=
operator|*
name|host
expr_stmt|;
name|ctx
operator|->
name|handler
operator|=
name|ngx_stream_proxy_resolve_handler
expr_stmt|;
name|ctx
operator|->
name|data
operator|=
name|s
expr_stmt|;
name|ctx
operator|->
name|timeout
operator|=
name|cscf
operator|->
name|resolver_timeout
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
if|if
condition|(
name|ngx_resolve_name
argument_list|(
name|ctx
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|u
operator|->
name|resolved
operator|->
name|ctx
operator|=
name|NULL
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
name|found
label|:
if|if
condition|(
name|uscf
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no upstream configuration"
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
name|u
operator|->
name|ssl_name
operator|=
name|uscf
operator|->
name|host
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|uscf
operator|->
name|peer
operator|.
name|init
argument_list|(
name|s
argument_list|,
name|uscf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|peer
operator|.
name|start_time
operator|=
name|ngx_current_msec
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|next_upstream_tries
operator|&&
name|u
operator|->
name|peer
operator|.
name|tries
operator|>
name|pscf
operator|->
name|next_upstream_tries
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|tries
operator|=
name|pscf
operator|->
name|next_upstream_tries
expr_stmt|;
block|}
name|ngx_stream_proxy_connect
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_proxy_eval (ngx_stream_session_t * s,ngx_stream_proxy_srv_conf_t * pscf)
name|ngx_stream_proxy_eval
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
parameter_list|)
block|{
name|ngx_str_t
name|host
decl_stmt|;
name|ngx_url_t
name|url
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
if|if
condition|(
name|ngx_stream_complex_value
argument_list|(
name|s
argument_list|,
name|pscf
operator|->
name|upstream_value
argument_list|,
operator|&
name|host
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|url
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
name|url
operator|.
name|url
operator|=
name|host
expr_stmt|;
name|url
operator|.
name|no_resolve
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_parse_url
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
operator|&
name|url
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|url
operator|.
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"%s in upstream \"%V\""
argument_list|,
name|url
operator|.
name|err
argument_list|,
operator|&
name|url
operator|.
name|url
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_ERROR
return|;
block|}
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|u
operator|->
name|resolved
operator|=
name|ngx_pcalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_upstream_resolved_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|resolved
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|url
operator|.
name|addrs
operator|&&
name|url
operator|.
name|addrs
index|[
literal|0
index|]
operator|.
name|sockaddr
condition|)
block|{
name|u
operator|->
name|resolved
operator|->
name|sockaddr
operator|=
name|url
operator|.
name|addrs
index|[
literal|0
index|]
operator|.
name|sockaddr
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|socklen
operator|=
name|url
operator|.
name|addrs
index|[
literal|0
index|]
operator|.
name|socklen
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|naddrs
operator|=
literal|1
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|host
operator|=
name|url
operator|.
name|addrs
index|[
literal|0
index|]
operator|.
name|name
expr_stmt|;
block|}
else|else
block|{
name|u
operator|->
name|resolved
operator|->
name|host
operator|=
name|url
operator|.
name|host
expr_stmt|;
block|}
name|u
operator|->
name|resolved
operator|->
name|port
operator|=
name|url
operator|.
name|port
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|no_port
operator|=
name|url
operator|.
name|no_port
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_proxy_set_local (ngx_stream_session_t * s,ngx_stream_upstream_t * u,ngx_stream_upstream_local_t * local)
name|ngx_stream_proxy_set_local
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_stream_upstream_t
modifier|*
name|u
parameter_list|,
name|ngx_stream_upstream_local_t
modifier|*
name|local
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_str_t
name|val
decl_stmt|;
name|ngx_addr_t
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
name|local
operator|==
name|NULL
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|local
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|#
directive|if
operator|(
name|NGX_HAVE_TRANSPARENT_PROXY
operator|)
name|u
operator|->
name|peer
operator|.
name|transparent
operator|=
name|local
operator|->
name|transparent
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|local
operator|->
name|value
operator|==
name|NULL
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|local
operator|=
name|local
operator|->
name|addr
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|ngx_stream_complex_value
argument_list|(
name|s
argument_list|,
name|local
operator|->
name|value
argument_list|,
operator|&
name|val
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|val
operator|.
name|len
operator|==
literal|0
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|addr
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_addr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|rc
operator|=
name|ngx_parse_addr_port
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|addr
argument_list|,
name|val
operator|.
name|data
argument_list|,
name|val
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"invalid local address \"%V\""
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|addr
operator|->
name|name
operator|=
name|val
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|local
operator|=
name|addr
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_connect (ngx_stream_session_t * s)
name|ngx_stream_proxy_connect
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|,
modifier|*
name|pc
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|c
operator|=
name|s
operator|->
name|connection
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"connecting to upstream"
expr_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|u
operator|->
name|state
operator|=
name|ngx_array_push
argument_list|(
name|s
operator|->
name|upstream_states
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|state
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_memzero
argument_list|(
name|u
operator|->
name|state
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_upstream_state_t
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ngx_event_connect_peer
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"proxy connect: %i"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|state
operator|->
name|peer
operator|=
name|u
operator|->
name|peer
operator|.
name|name
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_BUSY
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no live upstreams"
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_BAD_GATEWAY
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
name|ngx_stream_proxy_next_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* rc == NGX_OK || rc == NGX_AGAIN || rc == NGX_DONE */
name|pc
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|pc
operator|->
name|data
operator|=
name|s
expr_stmt|;
name|pc
operator|->
name|log
operator|=
name|c
operator|->
name|log
expr_stmt|;
name|pc
operator|->
name|pool
operator|=
name|c
operator|->
name|pool
expr_stmt|;
name|pc
operator|->
name|read
operator|->
name|log
operator|=
name|c
operator|->
name|log
expr_stmt|;
name|pc
operator|->
name|write
operator|->
name|log
operator|=
name|c
operator|->
name|log
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|NGX_AGAIN
condition|)
block|{
name|ngx_stream_proxy_init_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|pc
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_stream_proxy_connect_handler
expr_stmt|;
name|pc
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_stream_proxy_connect_handler
expr_stmt|;
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|pc
operator|->
name|write
argument_list|,
name|pscf
operator|->
name|connect_timeout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_init_upstream (ngx_stream_session_t * s)
name|ngx_stream_proxy_init_upstream
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
block|{
name|int
name|tcp_nodelay
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|,
modifier|*
name|pc
decl_stmt|;
name|ngx_log_handler_pt
name|handler
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|pc
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|cscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|pc
operator|->
name|type
operator|==
name|SOCK_STREAM
operator|&&
name|cscf
operator|->
name|tcp_nodelay
operator|&&
name|pc
operator|->
name|tcp_nodelay
operator|==
name|NGX_TCP_NODELAY_UNSET
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|pc
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"tcp_nodelay"
argument_list|)
expr_stmt|;
name|tcp_nodelay
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|pc
operator|->
name|fd
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_NODELAY
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|tcp_nodelay
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_connection_error
argument_list|(
name|pc
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"setsockopt(TCP_NODELAY) failed"
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_next_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|pc
operator|->
name|tcp_nodelay
operator|=
name|NGX_TCP_NODELAY_SET
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|->
name|proxy_protocol
condition|)
block|{
if|if
condition|(
name|ngx_stream_proxy_send_proxy_protocol
argument_list|(
name|s
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return;
block|}
name|u
operator|->
name|proxy_protocol
operator|=
literal|0
expr_stmt|;
block|}
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
if|if
condition|(
name|pc
operator|->
name|type
operator|==
name|SOCK_STREAM
operator|&&
name|pscf
operator|->
name|ssl
operator|&&
name|pc
operator|->
name|ssl
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_ssl_init_connection
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
name|c
operator|=
name|s
operator|->
name|connection
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|log
operator|->
name|log_level
operator|>=
name|NGX_LOG_INFO
condition|)
block|{
name|ngx_str_t
name|str
decl_stmt|;
name|u_char
name|addr
index|[
name|NGX_SOCKADDR_STRLEN
index|]
decl_stmt|;
name|str
operator|.
name|len
operator|=
name|NGX_SOCKADDR_STRLEN
expr_stmt|;
name|str
operator|.
name|data
operator|=
name|addr
expr_stmt|;
if|if
condition|(
name|ngx_connection_local_sockaddr
argument_list|(
name|pc
argument_list|,
operator|&
name|str
argument_list|,
literal|1
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
name|handler
operator|=
name|c
operator|->
name|log
operator|->
name|handler
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"%sproxy %V connected to %V"
argument_list|,
name|pc
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|?
literal|"udp "
else|:
literal|""
argument_list|,
operator|&
name|str
argument_list|,
name|u
operator|->
name|peer
operator|.
name|name
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|handler
operator|=
name|handler
expr_stmt|;
block|}
block|}
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"proxying connection"
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|upstream_buf
operator|.
name|start
operator|==
name|NULL
condition|)
block|{
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|pscf
operator|->
name|buffer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|upstream_buf
operator|.
name|start
operator|=
name|p
expr_stmt|;
name|u
operator|->
name|upstream_buf
operator|.
name|end
operator|=
name|p
operator|+
name|pscf
operator|->
name|buffer_size
expr_stmt|;
name|u
operator|->
name|upstream_buf
operator|.
name|pos
operator|=
name|p
expr_stmt|;
name|u
operator|->
name|upstream_buf
operator|.
name|last
operator|=
name|p
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
name|s
operator|->
name|received
operator|=
name|c
operator|->
name|buffer
operator|->
name|last
operator|-
name|c
operator|->
name|buffer
operator|->
name|pos
expr_stmt|;
name|u
operator|->
name|downstream_buf
operator|=
operator|*
name|c
operator|->
name|buffer
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|responses
operator|==
literal|0
condition|)
block|{
name|pc
operator|->
name|read
operator|->
name|ready
operator|=
literal|0
expr_stmt|;
name|pc
operator|->
name|read
operator|->
name|eof
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|u
operator|->
name|connected
operator|=
literal|1
expr_stmt|;
name|pc
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_stream_proxy_upstream_handler
expr_stmt|;
name|pc
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_stream_proxy_upstream_handler
expr_stmt|;
if|if
condition|(
name|pc
operator|->
name|read
operator|->
name|ready
operator|||
name|pc
operator|->
name|read
operator|->
name|eof
condition|)
block|{
name|ngx_post_event
argument_list|(
name|pc
operator|->
name|read
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
name|ngx_stream_proxy_process
argument_list|(
name|s
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_proxy_send_proxy_protocol (ngx_stream_session_t * s)
name|ngx_stream_proxy_send_proxy_protocol
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ssize_t
name|n
decl_stmt|,
name|size
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|,
modifier|*
name|pc
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|u_char
name|buf
index|[
name|NGX_PROXY_PROTOCOL_MAX_HEADER
index|]
decl_stmt|;
name|c
operator|=
name|s
operator|->
name|connection
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"stream proxy send PROXY protocol header"
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_proxy_protocol_write
argument_list|(
name|c
argument_list|,
name|buf
argument_list|,
name|buf
operator|+
name|NGX_PROXY_PROTOCOL_MAX_HEADER
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|pc
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|size
operator|=
name|p
operator|-
name|buf
expr_stmt|;
name|n
operator|=
name|pc
operator|->
name|send
argument_list|(
name|pc
argument_list|,
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|pc
operator|->
name|write
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|pc
operator|->
name|write
argument_list|,
name|pscf
operator|->
name|timeout
argument_list|)
expr_stmt|;
name|pc
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_stream_proxy_connect_handler
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_OK
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|n
operator|!=
name|size
condition|)
block|{
comment|/*          * PROXY protocol specification:          * The sender must always ensure that the header          * is sent at once, so that the transport layer          * maintains atomicity along the path to the receiver.          */
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"could not send PROXY protocol header at once"
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
end_if

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_stream_proxy_ssl_password_file (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_stream_proxy_ssl_password_file
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|pscf
operator|->
name|ssl_passwords
operator|!=
name|NGX_CONF_UNSET_PTR
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|pscf
operator|->
name|ssl_passwords
operator|=
name|ngx_ssl_read_password_file
argument_list|(
name|cf
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|ssl_passwords
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_ssl_init_connection (ngx_stream_session_t * s)
name|ngx_stream_proxy_ssl_init_connection
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_connection_t
modifier|*
name|pc
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|pc
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_ssl_create_connection
argument_list|(
name|pscf
operator|->
name|ssl
argument_list|,
name|pc
argument_list|,
name|NGX_SSL_BUFFER
operator||
name|NGX_SSL_CLIENT
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pscf
operator|->
name|ssl_server_name
operator|||
name|pscf
operator|->
name|ssl_verify
condition|)
block|{
if|if
condition|(
name|ngx_stream_proxy_ssl_name
argument_list|(
name|s
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|pscf
operator|->
name|ssl_session_reuse
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|set_session
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|,
name|u
operator|->
name|peer
operator|.
name|data
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|s
operator|->
name|connection
operator|->
name|log
operator|->
name|action
operator|=
literal|"SSL handshaking to upstream"
expr_stmt|;
name|rc
operator|=
name|ngx_ssl_handshake
argument_list|(
name|pc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
if|if
condition|(
operator|!
name|pc
operator|->
name|write
operator|->
name|timer_set
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|pc
operator|->
name|write
argument_list|,
name|pscf
operator|->
name|connect_timeout
argument_list|)
expr_stmt|;
block|}
name|pc
operator|->
name|ssl
operator|->
name|handler
operator|=
name|ngx_stream_proxy_ssl_handshake
expr_stmt|;
return|return;
block|}
name|ngx_stream_proxy_ssl_handshake
argument_list|(
name|pc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_ssl_handshake (ngx_connection_t * pc)
name|ngx_stream_proxy_ssl_handshake
parameter_list|(
name|ngx_connection_t
modifier|*
name|pc
parameter_list|)
block|{
name|long
name|rc
decl_stmt|;
name|ngx_stream_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|s
operator|=
name|pc
operator|->
name|data
expr_stmt|;
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|pc
operator|->
name|ssl
operator|->
name|handshaked
condition|)
block|{
if|if
condition|(
name|pscf
operator|->
name|ssl_verify
condition|)
block|{
name|rc
operator|=
name|SSL_get_verify_result
argument_list|(
name|pc
operator|->
name|ssl
operator|->
name|connection
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|X509_V_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|pc
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream SSL certificate verify error: (%l:%s)"
argument_list|,
name|rc
argument_list|,
name|X509_verify_cert_error_string
argument_list|(
name|rc
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|ngx_ssl_check_host
argument_list|(
name|pc
argument_list|,
operator|&
name|u
operator|->
name|ssl_name
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|pc
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream SSL certificate does not match \"%V\""
argument_list|,
operator|&
name|u
operator|->
name|ssl_name
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
if|if
condition|(
name|pscf
operator|->
name|ssl_session_reuse
condition|)
block|{
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|save_session
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|,
name|u
operator|->
name|peer
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pc
operator|->
name|write
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|pc
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
name|ngx_stream_proxy_init_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|failed
label|:
name|ngx_stream_proxy_next_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_proxy_ssl_name (ngx_stream_session_t * s)
name|ngx_stream_proxy_ssl_name
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|ngx_str_t
name|name
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|ssl_name
condition|)
block|{
if|if
condition|(
name|ngx_stream_complex_value
argument_list|(
name|s
argument_list|,
name|pscf
operator|->
name|ssl_name
argument_list|,
operator|&
name|name
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
else|else
block|{
name|name
operator|=
name|u
operator|->
name|ssl_name
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|.
name|len
operator|==
literal|0
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/*      * ssl name here may contain port, strip it for compatibility      * with the http module      */
name|p
operator|=
name|name
operator|.
name|data
expr_stmt|;
name|last
operator|=
name|name
operator|.
name|data
operator|+
name|name
operator|.
name|len
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'['
condition|)
block|{
name|p
operator|=
name|ngx_strlchr
argument_list|(
name|p
argument_list|,
name|last
argument_list|,
literal|']'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|p
operator|=
name|name
operator|.
name|data
expr_stmt|;
block|}
block|}
name|p
operator|=
name|ngx_strlchr
argument_list|(
name|p
argument_list|,
name|last
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|name
operator|.
name|len
operator|=
name|p
operator|-
name|name
operator|.
name|data
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pscf
operator|->
name|ssl_server_name
condition|)
block|{
goto|goto
name|done
goto|;
block|}
ifdef|#
directive|ifdef
name|SSL_CTRL_SET_TLSEXT_HOSTNAME
comment|/* as per RFC 6066, literal IPv4 and IPv6 addresses are not permitted */
if|if
condition|(
name|name
operator|.
name|len
operator|==
literal|0
operator|||
operator|*
name|name
operator|.
name|data
operator|==
literal|'['
condition|)
block|{
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|ngx_inet_addr
argument_list|(
name|name
operator|.
name|data
argument_list|,
name|name
operator|.
name|len
argument_list|)
operator|!=
name|INADDR_NONE
condition|)
block|{
goto|goto
name|done
goto|;
block|}
comment|/*      * SSL_set_tlsext_host_name() needs a null-terminated string,      * hence we explicitly null-terminate name here      */
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|name
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|(
name|void
operator|)
name|ngx_cpystrn
argument_list|(
name|p
argument_list|,
name|name
operator|.
name|data
argument_list|,
name|name
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|name
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream SSL server name: \"%s\""
argument_list|,
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSL_set_tlsext_host_name
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|ssl
operator|->
name|connection
argument_list|,
name|name
operator|.
name|data
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL_set_tlsext_host_name(\"%s\") failed"
argument_list|,
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
endif|#
directive|endif
name|done
label|:
name|u
operator|->
name|ssl_name
operator|=
name|name
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_downstream_handler (ngx_event_t * ev)
name|ngx_stream_proxy_downstream_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_stream_proxy_process_connection
argument_list|(
name|ev
argument_list|,
name|ev
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_resolve_handler (ngx_resolver_ctx_t * ctx)
name|ngx_stream_proxy_resolve_handler
parameter_list|(
name|ngx_resolver_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_stream_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|ngx_stream_upstream_resolved_t
modifier|*
name|ur
decl_stmt|;
name|s
operator|=
name|ctx
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|ur
operator|=
name|u
operator|->
name|resolved
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"stream upstream resolve"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|state
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"%V could not be resolved (%i: %s)"
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|,
name|ctx
operator|->
name|state
argument_list|,
name|ngx_resolver_strerror
argument_list|(
name|ctx
operator|->
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ur
operator|->
name|naddrs
operator|=
name|ctx
operator|->
name|naddrs
expr_stmt|;
name|ur
operator|->
name|addrs
operator|=
name|ctx
operator|->
name|addrs
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
block|{
name|u_char
name|text
index|[
name|NGX_SOCKADDR_STRLEN
index|]
decl_stmt|;
name|ngx_str_t
name|addr
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|addr
operator|.
name|data
operator|=
name|text
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|naddrs
condition|;
name|i
operator|++
control|)
block|{
name|addr
operator|.
name|len
operator|=
name|ngx_sock_ntop
argument_list|(
name|ur
operator|->
name|addrs
index|[
name|i
index|]
operator|.
name|sockaddr
argument_list|,
name|ur
operator|->
name|addrs
index|[
name|i
index|]
operator|.
name|socklen
argument_list|,
name|text
argument_list|,
name|NGX_SOCKADDR_STRLEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"name was resolved to %V"
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|ngx_stream_upstream_create_round_robin_peer
argument_list|(
name|s
argument_list|,
name|ur
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_resolve_name_done
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|ur
operator|->
name|ctx
operator|=
name|NULL
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|start_time
operator|=
name|ngx_current_msec
expr_stmt|;
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|next_upstream_tries
operator|&&
name|u
operator|->
name|peer
operator|.
name|tries
operator|>
name|pscf
operator|->
name|next_upstream_tries
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|tries
operator|=
name|pscf
operator|->
name|next_upstream_tries
expr_stmt|;
block|}
name|ngx_stream_proxy_connect
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_upstream_handler (ngx_event_t * ev)
name|ngx_stream_proxy_upstream_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_stream_proxy_process_connection
argument_list|(
name|ev
argument_list|,
operator|!
name|ev
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_process_connection (ngx_event_t * ev,ngx_uint_t from_upstream)
name|ngx_stream_proxy_process_connection
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|,
name|ngx_uint_t
name|from_upstream
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|,
modifier|*
name|pc
decl_stmt|;
name|ngx_stream_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|c
operator|=
name|ev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|c
operator|=
name|s
operator|->
name|connection
expr_stmt|;
name|pc
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|timedout
condition|)
block|{
name|ev
operator|->
name|timedout
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|delayed
condition|)
block|{
name|ev
operator|->
name|delayed
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|ev
operator|->
name|ready
condition|)
block|{
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|ev
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|connected
operator|&&
operator|!
name|c
operator|->
name|read
operator|->
name|delayed
operator|&&
operator|!
name|pc
operator|->
name|read
operator|->
name|delayed
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|c
operator|->
name|write
argument_list|,
name|pscf
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
else|else
block|{
if|if
condition|(
name|s
operator|->
name|connection
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|)
block|{
if|if
condition|(
name|pscf
operator|->
name|responses
operator|==
name|NGX_MAX_INT32_VALUE
condition|)
block|{
comment|/*                      * successfully terminate timed out UDP session                      * with unspecified number of responses                      */
name|pc
operator|->
name|read
operator|->
name|ready
operator|=
literal|0
expr_stmt|;
name|pc
operator|->
name|read
operator|->
name|eof
operator|=
literal|1
expr_stmt|;
name|ngx_stream_proxy_process
argument_list|(
name|s
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|received
operator|==
literal|0
condition|)
block|{
name|ngx_stream_proxy_next_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"connection timed out"
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_OK
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|else if
condition|(
name|ev
operator|->
name|delayed
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"stream connection delayed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|ev
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|from_upstream
operator|&&
operator|!
name|u
operator|->
name|connected
condition|)
block|{
return|return;
block|}
name|ngx_stream_proxy_process
argument_list|(
name|s
argument_list|,
name|from_upstream
argument_list|,
name|ev
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_connect_handler (ngx_event_t * ev)
name|ngx_stream_proxy_connect_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_stream_session_t
modifier|*
name|s
decl_stmt|;
name|c
operator|=
name|ev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"upstream timed out"
argument_list|)
expr_stmt|;
name|ngx_stream_proxy_next_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_del_timer
argument_list|(
name|c
operator|->
name|write
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"stream proxy connect upstream"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_stream_proxy_test_connect
argument_list|(
name|c
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_next_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_stream_proxy_init_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_proxy_test_connect (ngx_connection_t * c)
name|ngx_stream_proxy_test_connect
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|socklen_t
name|len
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_KQUEUE
operator|)
if|if
condition|(
name|ngx_event_flags
operator|&
name|NGX_USE_KQUEUE_EVENT
condition|)
block|{
name|err
operator|=
name|c
operator|->
name|write
operator|->
name|kq_errno
condition|?
name|c
operator|->
name|write
operator|->
name|kq_errno
else|:
name|c
operator|->
name|read
operator|->
name|kq_errno
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|err
argument_list|,
literal|"kevent() reported that connect() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|err
operator|=
literal|0
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
comment|/*          * BSDs and Linux return 0 and set a pending error in err          * Solaris returns -1 and sets errno          */
if|if
condition|(
name|getsockopt
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_ERROR
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|err
argument_list|,
operator|&
name|len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|err
operator|=
name|ngx_socket_errno
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|err
argument_list|,
literal|"connect() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_process (ngx_stream_session_t * s,ngx_uint_t from_upstream,ngx_uint_t do_write)
name|ngx_stream_proxy_process
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_uint_t
name|from_upstream
parameter_list|,
name|ngx_uint_t
name|do_write
parameter_list|)
block|{
name|off_t
modifier|*
name|received
decl_stmt|,
name|limit
decl_stmt|;
name|size_t
name|size
decl_stmt|,
name|limit_rate
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_uint_t
name|flags
decl_stmt|;
name|ngx_msec_t
name|delay
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|,
modifier|*
name|pc
decl_stmt|,
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|ngx_log_handler_pt
name|handler
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|c
operator|=
name|s
operator|->
name|connection
expr_stmt|;
name|pc
operator|=
name|u
operator|->
name|connected
condition|?
name|u
operator|->
name|peer
operator|.
name|connection
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|SOCK_DGRAM
operator|&&
operator|(
name|ngx_terminate
operator|||
name|ngx_exiting
operator|)
condition|)
block|{
comment|/* socket is already closed on worker shutdown */
name|handler
operator|=
name|c
operator|->
name|log
operator|->
name|handler
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"disconnected on shutdown"
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|handler
operator|=
name|handler
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_OK
argument_list|)
expr_stmt|;
return|return;
block|}
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|from_upstream
condition|)
block|{
name|src
operator|=
name|pc
expr_stmt|;
name|dst
operator|=
name|c
expr_stmt|;
name|b
operator|=
operator|&
name|u
operator|->
name|upstream_buf
expr_stmt|;
name|limit_rate
operator|=
name|pscf
operator|->
name|download_rate
expr_stmt|;
name|received
operator|=
operator|&
name|u
operator|->
name|received
expr_stmt|;
block|}
else|else
block|{
name|src
operator|=
name|c
expr_stmt|;
name|dst
operator|=
name|pc
expr_stmt|;
name|b
operator|=
operator|&
name|u
operator|->
name|downstream_buf
expr_stmt|;
name|limit_rate
operator|=
name|pscf
operator|->
name|upload_rate
expr_stmt|;
name|received
operator|=
operator|&
name|s
operator|->
name|received
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|do_write
condition|)
block|{
name|size
operator|=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|size
operator|&&
name|dst
operator|&&
name|dst
operator|->
name|write
operator|->
name|ready
condition|)
block|{
name|n
operator|=
name|dst
operator|->
name|send
argument_list|(
name|dst
argument_list|,
name|b
operator|->
name|pos
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
operator|&&
name|dst
operator|->
name|shared
condition|)
block|{
comment|/* cannot wait on a shared socket */
name|n
operator|=
name|NGX_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|SOCK_DGRAM
operator|&&
operator|!
name|from_upstream
condition|)
block|{
name|ngx_stream_proxy_next_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_OK
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|b
operator|->
name|pos
operator|+=
name|n
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|pos
operator|==
name|b
operator|->
name|last
condition|)
block|{
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|start
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|b
operator|->
name|start
expr_stmt|;
block|}
block|}
block|}
block|}
name|size
operator|=
name|b
operator|->
name|end
operator|-
name|b
operator|->
name|last
expr_stmt|;
if|if
condition|(
name|size
operator|&&
name|src
operator|->
name|read
operator|->
name|ready
operator|&&
operator|!
name|src
operator|->
name|read
operator|->
name|delayed
condition|)
block|{
if|if
condition|(
name|limit_rate
condition|)
block|{
name|limit
operator|=
operator|(
name|off_t
operator|)
name|limit_rate
operator|*
operator|(
name|ngx_time
argument_list|()
operator|-
name|u
operator|->
name|start_sec
operator|+
literal|1
operator|)
operator|-
operator|*
name|received
expr_stmt|;
if|if
condition|(
name|limit
operator|<=
literal|0
condition|)
block|{
name|src
operator|->
name|read
operator|->
name|delayed
operator|=
literal|1
expr_stmt|;
name|delay
operator|=
operator|(
name|ngx_msec_t
operator|)
operator|(
operator|-
name|limit
operator|*
literal|1000
operator|/
name|limit_rate
operator|+
literal|1
operator|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|src
operator|->
name|read
argument_list|,
name|delay
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|off_t
operator|)
name|size
operator|>
name|limit
condition|)
block|{
name|size
operator|=
operator|(
name|size_t
operator|)
name|limit
expr_stmt|;
block|}
block|}
name|n
operator|=
name|src
operator|->
name|recv
argument_list|(
name|src
argument_list|,
name|b
operator|->
name|last
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
operator|||
name|n
operator|==
literal|0
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|limit_rate
condition|)
block|{
name|delay
operator|=
operator|(
name|ngx_msec_t
operator|)
operator|(
name|n
operator|*
literal|1000
operator|/
name|limit_rate
operator|)
expr_stmt|;
if|if
condition|(
name|delay
operator|>
literal|0
condition|)
block|{
name|src
operator|->
name|read
operator|->
name|delayed
operator|=
literal|1
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|src
operator|->
name|read
argument_list|,
name|delay
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|SOCK_DGRAM
operator|&&
operator|++
name|u
operator|->
name|responses
operator|==
name|pscf
operator|->
name|responses
condition|)
block|{
name|src
operator|->
name|read
operator|->
name|ready
operator|=
literal|0
expr_stmt|;
name|src
operator|->
name|read
operator|->
name|eof
operator|=
literal|1
expr_stmt|;
block|}
operator|*
name|received
operator|+=
name|n
expr_stmt|;
name|b
operator|->
name|last
operator|+=
name|n
expr_stmt|;
name|do_write
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|SOCK_DGRAM
operator|&&
name|u
operator|->
name|received
operator|==
literal|0
condition|)
block|{
name|ngx_stream_proxy_next_upstream
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|src
operator|->
name|read
operator|->
name|eof
operator|=
literal|1
expr_stmt|;
block|}
block|}
break|break;
block|}
if|if
condition|(
name|src
operator|->
name|read
operator|->
name|eof
operator|&&
operator|(
name|b
operator|->
name|pos
operator|==
name|b
operator|->
name|last
operator|||
operator|(
name|dst
operator|&&
name|dst
operator|->
name|read
operator|->
name|eof
operator|)
operator|)
condition|)
block|{
name|handler
operator|=
name|c
operator|->
name|log
operator|->
name|handler
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"%s%s disconnected"
literal|", bytes from/to client:%O/%O"
literal|", bytes from/to upstream:%O/%O"
argument_list|,
name|src
operator|->
name|type
operator|==
name|SOCK_DGRAM
condition|?
literal|"udp "
else|:
literal|""
argument_list|,
name|from_upstream
condition|?
literal|"upstream"
else|:
literal|"client"
argument_list|,
name|s
operator|->
name|received
argument_list|,
name|c
operator|->
name|sent
argument_list|,
name|u
operator|->
name|received
argument_list|,
name|pc
condition|?
name|pc
operator|->
name|sent
else|:
literal|0
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|handler
operator|=
name|handler
expr_stmt|;
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_OK
argument_list|)
expr_stmt|;
return|return;
block|}
name|flags
operator|=
name|src
operator|->
name|read
operator|->
name|eof
condition|?
name|NGX_CLOSE_EVENT
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|src
operator|->
name|shared
operator|&&
name|ngx_handle_read_event
argument_list|(
name|src
operator|->
name|read
argument_list|,
name|flags
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dst
condition|)
block|{
if|if
condition|(
operator|!
name|dst
operator|->
name|shared
operator|&&
name|ngx_handle_write_event
argument_list|(
name|dst
operator|->
name|write
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|c
operator|->
name|read
operator|->
name|delayed
operator|&&
operator|!
name|pc
operator|->
name|read
operator|->
name|delayed
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|c
operator|->
name|write
argument_list|,
name|pscf
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|c
operator|->
name|write
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|c
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_next_upstream (ngx_stream_session_t * s)
name|ngx_stream_proxy_next_upstream
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|)
block|{
name|ngx_msec_t
name|timeout
decl_stmt|;
name|ngx_connection_t
modifier|*
name|pc
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"stream proxy next upstream"
argument_list|)
expr_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|sockaddr
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|free
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|,
name|u
operator|->
name|peer
operator|.
name|data
argument_list|,
name|NGX_PEER_FAILED
argument_list|)
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|sockaddr
operator|=
name|NULL
expr_stmt|;
block|}
name|pscf
operator|=
name|ngx_stream_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_stream_proxy_module
argument_list|)
expr_stmt|;
name|timeout
operator|=
name|pscf
operator|->
name|next_upstream_timeout
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|tries
operator|==
literal|0
operator|||
operator|!
name|pscf
operator|->
name|next_upstream
operator|||
operator|(
name|timeout
operator|&&
name|ngx_current_msec
operator|-
name|u
operator|->
name|peer
operator|.
name|start_time
operator|>=
name|timeout
operator|)
condition|)
block|{
name|ngx_stream_proxy_finalize
argument_list|(
name|s
argument_list|,
name|NGX_STREAM_BAD_GATEWAY
argument_list|)
expr_stmt|;
return|return;
block|}
name|pc
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
if|if
condition|(
name|pc
condition|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"close proxy upstream connection: %d"
argument_list|,
name|pc
operator|->
name|fd
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
if|if
condition|(
name|pc
operator|->
name|ssl
condition|)
block|{
name|pc
operator|->
name|ssl
operator|->
name|no_wait_shutdown
operator|=
literal|1
expr_stmt|;
name|pc
operator|->
name|ssl
operator|->
name|no_send_shutdown
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_ssl_shutdown
argument_list|(
name|pc
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|u
operator|->
name|state
operator|->
name|bytes_received
operator|=
name|u
operator|->
name|received
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|bytes_sent
operator|=
name|pc
operator|->
name|sent
expr_stmt|;
name|ngx_close_connection
argument_list|(
name|pc
argument_list|)
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|connection
operator|=
name|NULL
expr_stmt|;
block|}
name|ngx_stream_proxy_connect
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_stream_proxy_finalize (ngx_stream_session_t * s,ngx_uint_t rc)
name|ngx_stream_proxy_finalize
parameter_list|(
name|ngx_stream_session_t
modifier|*
name|s
parameter_list|,
name|ngx_uint_t
name|rc
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|pc
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"finalize stream proxy: %i"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
block|{
goto|goto
name|noupstream
goto|;
block|}
if|if
condition|(
name|u
operator|->
name|resolved
operator|&&
name|u
operator|->
name|resolved
operator|->
name|ctx
condition|)
block|{
name|ngx_resolve_name_done
argument_list|(
name|u
operator|->
name|resolved
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|ctx
operator|=
name|NULL
expr_stmt|;
block|}
name|pc
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|state
condition|)
block|{
if|if
condition|(
name|pc
condition|)
block|{
name|u
operator|->
name|state
operator|->
name|bytes_received
operator|=
name|u
operator|->
name|received
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|bytes_sent
operator|=
name|pc
operator|->
name|sent
expr_stmt|;
block|}
block|}
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|free
operator|&&
name|u
operator|->
name|peer
operator|.
name|sockaddr
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|free
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|,
name|u
operator|->
name|peer
operator|.
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|sockaddr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|pc
condition|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_STREAM
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"close stream proxy upstream connection: %d"
argument_list|,
name|pc
operator|->
name|fd
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
if|if
condition|(
name|pc
operator|->
name|ssl
condition|)
block|{
name|pc
operator|->
name|ssl
operator|->
name|no_wait_shutdown
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_ssl_shutdown
argument_list|(
name|pc
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ngx_close_connection
argument_list|(
name|pc
argument_list|)
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|connection
operator|=
name|NULL
expr_stmt|;
block|}
name|noupstream
label|:
name|ngx_stream_finalize_session
argument_list|(
name|s
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_stream_proxy_log_error (ngx_log_t * log,u_char * buf,size_t len)
name|ngx_stream_proxy_log_error
parameter_list|(
name|ngx_log_t
modifier|*
name|log
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_connection_t
modifier|*
name|pc
decl_stmt|;
name|ngx_stream_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_stream_upstream_t
modifier|*
name|u
decl_stmt|;
name|s
operator|=
name|log
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|s
operator|->
name|upstream
expr_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|name
condition|)
block|{
name|p
operator|=
name|ngx_snprintf
argument_list|(
name|p
argument_list|,
name|len
argument_list|,
literal|", upstream: \"%V\""
argument_list|,
name|u
operator|->
name|peer
operator|.
name|name
argument_list|)
expr_stmt|;
name|len
operator|-=
name|p
operator|-
name|buf
expr_stmt|;
block|}
name|pc
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|p
operator|=
name|ngx_snprintf
argument_list|(
name|p
argument_list|,
name|len
argument_list|,
literal|", bytes from/to client:%O/%O"
literal|", bytes from/to upstream:%O/%O"
argument_list|,
name|s
operator|->
name|received
argument_list|,
name|s
operator|->
name|connection
operator|->
name|sent
argument_list|,
name|u
operator|->
name|received
argument_list|,
name|pc
condition|?
name|pc
operator|->
name|sent
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|p
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_stream_proxy_create_srv_conf (ngx_conf_t * cf)
name|ngx_stream_proxy_create_srv_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_proxy_srv_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/*      * set by ngx_pcalloc():      *      *     conf->ssl_protocols = 0;      *     conf->ssl_ciphers = { 0, NULL };      *     conf->ssl_name = NULL;      *     conf->ssl_trusted_certificate = { 0, NULL };      *     conf->ssl_crl = { 0, NULL };      *     conf->ssl_certificate = { 0, NULL };      *     conf->ssl_certificate_key = { 0, NULL };      *      *     conf->ssl = NULL;      *     conf->upstream = NULL;      *     conf->upstream_value = NULL;      */
name|conf
operator|->
name|connect_timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
name|conf
operator|->
name|timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
name|conf
operator|->
name|next_upstream_timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
name|conf
operator|->
name|buffer_size
operator|=
name|NGX_CONF_UNSET_SIZE
expr_stmt|;
name|conf
operator|->
name|upload_rate
operator|=
name|NGX_CONF_UNSET_SIZE
expr_stmt|;
name|conf
operator|->
name|download_rate
operator|=
name|NGX_CONF_UNSET_SIZE
expr_stmt|;
name|conf
operator|->
name|responses
operator|=
name|NGX_CONF_UNSET_UINT
expr_stmt|;
name|conf
operator|->
name|next_upstream_tries
operator|=
name|NGX_CONF_UNSET_UINT
expr_stmt|;
name|conf
operator|->
name|next_upstream
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|proxy_protocol
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|local
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
name|conf
operator|->
name|ssl_enable
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|ssl_session_reuse
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|ssl_server_name
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|ssl_verify
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|ssl_verify_depth
operator|=
name|NGX_CONF_UNSET_UINT
expr_stmt|;
name|conf
operator|->
name|ssl_passwords
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
endif|#
directive|endif
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_stream_proxy_merge_srv_conf (ngx_conf_t * cf,void * parent,void * child)
name|ngx_stream_proxy_merge_srv_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
block|{
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|prev
init|=
name|parent
decl_stmt|;
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|conf
init|=
name|child
decl_stmt|;
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|connect_timeout
argument_list|,
name|prev
operator|->
name|connect_timeout
argument_list|,
literal|60000
argument_list|)
expr_stmt|;
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|timeout
argument_list|,
name|prev
operator|->
name|timeout
argument_list|,
literal|10
operator|*
literal|60000
argument_list|)
expr_stmt|;
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|next_upstream_timeout
argument_list|,
name|prev
operator|->
name|next_upstream_timeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_size_value
argument_list|(
name|conf
operator|->
name|buffer_size
argument_list|,
name|prev
operator|->
name|buffer_size
argument_list|,
literal|16384
argument_list|)
expr_stmt|;
name|ngx_conf_merge_size_value
argument_list|(
name|conf
operator|->
name|upload_rate
argument_list|,
name|prev
operator|->
name|upload_rate
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_size_value
argument_list|(
name|conf
operator|->
name|download_rate
argument_list|,
name|prev
operator|->
name|download_rate
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_uint_value
argument_list|(
name|conf
operator|->
name|responses
argument_list|,
name|prev
operator|->
name|responses
argument_list|,
name|NGX_MAX_INT32_VALUE
argument_list|)
expr_stmt|;
name|ngx_conf_merge_uint_value
argument_list|(
name|conf
operator|->
name|next_upstream_tries
argument_list|,
name|prev
operator|->
name|next_upstream_tries
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|next_upstream
argument_list|,
name|prev
operator|->
name|next_upstream
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|proxy_protocol
argument_list|,
name|prev
operator|->
name|proxy_protocol
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|local
argument_list|,
name|prev
operator|->
name|local
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|ssl_enable
argument_list|,
name|prev
operator|->
name|ssl_enable
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|ssl_session_reuse
argument_list|,
name|prev
operator|->
name|ssl_session_reuse
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ngx_conf_merge_bitmask_value
argument_list|(
name|conf
operator|->
name|ssl_protocols
argument_list|,
name|prev
operator|->
name|ssl_protocols
argument_list|,
operator|(
name|NGX_CONF_BITMASK_SET
operator||
name|NGX_SSL_TLSv1
operator||
name|NGX_SSL_TLSv1_1
operator||
name|NGX_SSL_TLSv1_2
operator|)
argument_list|)
expr_stmt|;
name|ngx_conf_merge_str_value
argument_list|(
name|conf
operator|->
name|ssl_ciphers
argument_list|,
name|prev
operator|->
name|ssl_ciphers
argument_list|,
literal|"DEFAULT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|ssl_name
operator|==
name|NULL
condition|)
block|{
name|conf
operator|->
name|ssl_name
operator|=
name|prev
operator|->
name|ssl_name
expr_stmt|;
block|}
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|ssl_server_name
argument_list|,
name|prev
operator|->
name|ssl_server_name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|ssl_verify
argument_list|,
name|prev
operator|->
name|ssl_verify
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_uint_value
argument_list|(
name|conf
operator|->
name|ssl_verify_depth
argument_list|,
name|prev
operator|->
name|ssl_verify_depth
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ngx_conf_merge_str_value
argument_list|(
name|conf
operator|->
name|ssl_trusted_certificate
argument_list|,
name|prev
operator|->
name|ssl_trusted_certificate
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ngx_conf_merge_str_value
argument_list|(
name|conf
operator|->
name|ssl_crl
argument_list|,
name|prev
operator|->
name|ssl_crl
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ngx_conf_merge_str_value
argument_list|(
name|conf
operator|->
name|ssl_certificate
argument_list|,
name|prev
operator|->
name|ssl_certificate
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ngx_conf_merge_str_value
argument_list|(
name|conf
operator|->
name|ssl_certificate_key
argument_list|,
name|prev
operator|->
name|ssl_certificate_key
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|ssl_passwords
argument_list|,
name|prev
operator|->
name|ssl_passwords
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|ssl_enable
operator|&&
name|ngx_stream_proxy_set_ssl
argument_list|(
name|cf
argument_list|,
name|conf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
endif|#
directive|endif
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_STREAM_SSL
operator|)
end_if

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_stream_proxy_set_ssl (ngx_conf_t * cf,ngx_stream_proxy_srv_conf_t * pscf)
name|ngx_stream_proxy_set_ssl
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
parameter_list|)
block|{
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|pscf
operator|->
name|ssl
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_ssl_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|ssl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|pscf
operator|->
name|ssl
operator|->
name|log
operator|=
name|cf
operator|->
name|log
expr_stmt|;
if|if
condition|(
name|ngx_ssl_create
argument_list|(
name|pscf
operator|->
name|ssl
argument_list|,
name|pscf
operator|->
name|ssl_protocols
argument_list|,
name|NULL
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_ssl_cleanup_ctx
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|pscf
operator|->
name|ssl
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|ssl_certificate
operator|.
name|len
condition|)
block|{
if|if
condition|(
name|pscf
operator|->
name|ssl_certificate_key
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no \"proxy_ssl_certificate_key\" is defined "
literal|"for certificate \"%V\""
argument_list|,
operator|&
name|pscf
operator|->
name|ssl_certificate
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_ssl_certificate
argument_list|(
name|cf
argument_list|,
name|pscf
operator|->
name|ssl
argument_list|,
operator|&
name|pscf
operator|->
name|ssl_certificate
argument_list|,
operator|&
name|pscf
operator|->
name|ssl_certificate_key
argument_list|,
name|pscf
operator|->
name|ssl_passwords
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
if|if
condition|(
name|ngx_ssl_ciphers
argument_list|(
name|cf
argument_list|,
name|pscf
operator|->
name|ssl
argument_list|,
operator|&
name|pscf
operator|->
name|ssl_ciphers
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|pscf
operator|->
name|ssl_verify
condition|)
block|{
if|if
condition|(
name|pscf
operator|->
name|ssl_trusted_certificate
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no proxy_ssl_trusted_certificate for proxy_ssl_verify"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_ssl_trusted_certificate
argument_list|(
name|cf
argument_list|,
name|pscf
operator|->
name|ssl
argument_list|,
operator|&
name|pscf
operator|->
name|ssl_trusted_certificate
argument_list|,
name|pscf
operator|->
name|ssl_verify_depth
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_ssl_crl
argument_list|(
name|cf
argument_list|,
name|pscf
operator|->
name|ssl
argument_list|,
operator|&
name|pscf
operator|->
name|ssl_crl
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_stream_proxy_pass (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_stream_proxy_pass
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
init|=
name|conf
decl_stmt|;
name|ngx_url_t
name|u
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|,
modifier|*
name|url
decl_stmt|;
name|ngx_stream_complex_value_t
name|cv
decl_stmt|;
name|ngx_stream_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
name|ngx_stream_compile_complex_value_t
name|ccv
decl_stmt|;
if|if
condition|(
name|pscf
operator|->
name|upstream
operator|||
name|pscf
operator|->
name|upstream_value
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|cscf
operator|=
name|ngx_stream_conf_get_module_srv_conf
argument_list|(
name|cf
argument_list|,
name|ngx_stream_core_module
argument_list|)
expr_stmt|;
name|cscf
operator|->
name|handler
operator|=
name|ngx_stream_proxy_handler
expr_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|url
operator|=
operator|&
name|value
index|[
literal|1
index|]
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|ccv
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_compile_complex_value_t
argument_list|)
argument_list|)
expr_stmt|;
name|ccv
operator|.
name|cf
operator|=
name|cf
expr_stmt|;
name|ccv
operator|.
name|value
operator|=
name|url
expr_stmt|;
name|ccv
operator|.
name|complex_value
operator|=
operator|&
name|cv
expr_stmt|;
if|if
condition|(
name|ngx_stream_compile_complex_value
argument_list|(
operator|&
name|ccv
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|cv
operator|.
name|lengths
condition|)
block|{
name|pscf
operator|->
name|upstream_value
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_complex_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|upstream_value
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
operator|*
name|pscf
operator|->
name|upstream_value
operator|=
name|cv
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|u
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|.
name|url
operator|=
operator|*
name|url
expr_stmt|;
name|u
operator|.
name|no_resolve
operator|=
literal|1
expr_stmt|;
name|pscf
operator|->
name|upstream
operator|=
name|ngx_stream_upstream_add
argument_list|(
name|cf
argument_list|,
operator|&
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pscf
operator|->
name|upstream
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_stream_proxy_bind (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_stream_proxy_bind
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_stream_proxy_srv_conf_t
modifier|*
name|pscf
init|=
name|conf
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_stream_complex_value_t
name|cv
decl_stmt|;
name|ngx_stream_upstream_local_t
modifier|*
name|local
decl_stmt|;
name|ngx_stream_compile_complex_value_t
name|ccv
decl_stmt|;
if|if
condition|(
name|pscf
operator|->
name|local
operator|!=
name|NGX_CONF_UNSET_PTR
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
if|if
condition|(
name|cf
operator|->
name|args
operator|->
name|nelts
operator|==
literal|2
operator|&&
name|ngx_strcmp
argument_list|(
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pscf
operator|->
name|local
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|ccv
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_compile_complex_value_t
argument_list|)
argument_list|)
expr_stmt|;
name|ccv
operator|.
name|cf
operator|=
name|cf
expr_stmt|;
name|ccv
operator|.
name|value
operator|=
operator|&
name|value
index|[
literal|1
index|]
expr_stmt|;
name|ccv
operator|.
name|complex_value
operator|=
operator|&
name|cv
expr_stmt|;
if|if
condition|(
name|ngx_stream_compile_complex_value
argument_list|(
operator|&
name|ccv
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|local
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_upstream_local_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|local
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|pscf
operator|->
name|local
operator|=
name|local
expr_stmt|;
if|if
condition|(
name|cv
operator|.
name|lengths
condition|)
block|{
name|local
operator|->
name|value
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_stream_complex_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|local
operator|->
name|value
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
operator|*
name|local
operator|->
name|value
operator|=
name|cv
expr_stmt|;
block|}
else|else
block|{
name|local
operator|->
name|addr
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_addr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|local
operator|->
name|addr
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|rc
operator|=
name|ngx_parse_addr_port
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|local
operator|->
name|addr
argument_list|,
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
name|value
index|[
literal|1
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rc
condition|)
block|{
case|case
name|NGX_OK
case|:
name|local
operator|->
name|addr
operator|->
name|name
operator|=
name|value
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|NGX_DECLINED
case|:
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid address \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* fall through */
default|default:
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
if|if
condition|(
name|cf
operator|->
name|args
operator|->
name|nelts
operator|>
literal|2
condition|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|value
index|[
literal|2
index|]
operator|.
name|data
argument_list|,
literal|"transparent"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HAVE_TRANSPARENT_PROXY
operator|)
name|local
operator|->
name|transparent
operator|=
literal|1
expr_stmt|;
else|#
directive|else
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"transparent proxying is not supported "
literal|"on this platform, ignored"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

end_unit

