begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event_connect.h>
end_include

begin_include
include|#
directive|include
file|<ngx_mail.h>
end_include

begin_typedef
DECL|struct|__anon2c703de00108
typedef|typedef
struct|struct
block|{
DECL|member|peer
name|ngx_peer_addr_t
modifier|*
name|peer
decl_stmt|;
DECL|member|timeout
name|ngx_msec_t
name|timeout
decl_stmt|;
DECL|member|host_header
name|ngx_str_t
name|host_header
decl_stmt|;
DECL|member|uri
name|ngx_str_t
name|uri
decl_stmt|;
DECL|member|header
name|ngx_str_t
name|header
decl_stmt|;
DECL|member|headers
name|ngx_array_t
modifier|*
name|headers
decl_stmt|;
DECL|typedef|ngx_mail_auth_http_conf_t
block|}
name|ngx_mail_auth_http_conf_t
typedef|;
end_typedef

begin_typedef
DECL|typedef|ngx_mail_auth_http_ctx_t
typedef|typedef
name|struct
name|ngx_mail_auth_http_ctx_s
name|ngx_mail_auth_http_ctx_t
typedef|;
end_typedef

begin_typedef
DECL|typedef|ngx_mail_auth_http_handler_pt
typedef|typedef
name|void
function_decl|(
modifier|*
name|ngx_mail_auth_http_handler_pt
function_decl|)
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_typedef

begin_struct
DECL|struct|ngx_mail_auth_http_ctx_s
struct|struct
name|ngx_mail_auth_http_ctx_s
block|{
DECL|member|request
name|ngx_buf_t
modifier|*
name|request
decl_stmt|;
DECL|member|response
name|ngx_buf_t
modifier|*
name|response
decl_stmt|;
DECL|member|peer
name|ngx_peer_connection_t
name|peer
decl_stmt|;
DECL|member|handler
name|ngx_mail_auth_http_handler_pt
name|handler
decl_stmt|;
DECL|member|state
name|ngx_uint_t
name|state
decl_stmt|;
DECL|member|hash
name|ngx_uint_t
name|hash
decl_stmt|;
comment|/* no needed ? */
DECL|member|header_name_start
name|u_char
modifier|*
name|header_name_start
decl_stmt|;
DECL|member|header_name_end
name|u_char
modifier|*
name|header_name_end
decl_stmt|;
DECL|member|header_start
name|u_char
modifier|*
name|header_start
decl_stmt|;
DECL|member|header_end
name|u_char
modifier|*
name|header_end
decl_stmt|;
DECL|member|addr
name|ngx_str_t
name|addr
decl_stmt|;
DECL|member|port
name|ngx_str_t
name|port
decl_stmt|;
DECL|member|err
name|ngx_str_t
name|err
decl_stmt|;
DECL|member|errmsg
name|ngx_str_t
name|errmsg
decl_stmt|;
DECL|member|errcode
name|ngx_str_t
name|errcode
decl_stmt|;
DECL|member|sleep
name|time_t
name|sleep
decl_stmt|;
DECL|member|pool
name|ngx_pool_t
modifier|*
name|pool
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|ngx_mail_auth_http_write_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_mail_auth_http_read_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_mail_auth_http_ignore_status_line
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_mail_auth_http_process_headers
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_mail_auth_sleep_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_mail_auth_http_parse_header_line
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_mail_auth_http_block_read
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_mail_auth_http_dummy_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_buf_t
modifier|*
name|ngx_mail_auth_http_create_request
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_mail_auth_http_conf_t
modifier|*
name|ahcf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_mail_auth_http_escape
parameter_list|(
name|ngx_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_str_t
modifier|*
name|text
parameter_list|,
name|ngx_str_t
modifier|*
name|escaped
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_mail_auth_http_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_mail_auth_http_merge_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_mail_auth_http
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_mail_auth_http_header
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_mail_auth_http_commands
specifier|static
name|ngx_command_t
name|ngx_mail_auth_http_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"auth_http"
argument_list|)
block|,
name|NGX_MAIL_MAIN_CONF
operator||
name|NGX_MAIL_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_mail_auth_http
block|,
name|NGX_MAIL_SRV_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"auth_http_timeout"
argument_list|)
block|,
name|NGX_MAIL_MAIN_CONF
operator||
name|NGX_MAIL_SRV_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_MAIL_SRV_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_mail_auth_http_conf_t
argument_list|,
name|timeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"auth_http_header"
argument_list|)
block|,
name|NGX_MAIL_MAIN_CONF
operator||
name|NGX_MAIL_SRV_CONF
operator||
name|NGX_CONF_TAKE2
block|,
name|ngx_mail_auth_http_header
block|,
name|NGX_MAIL_SRV_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_mail_auth_http_module_ctx
specifier|static
name|ngx_mail_module_t
name|ngx_mail_auth_http_module_ctx
init|=
block|{
name|NULL
block|,
comment|/* create main configuration */
name|NULL
block|,
comment|/* init main configuration */
name|ngx_mail_auth_http_create_conf
block|,
comment|/* create server configuration */
name|ngx_mail_auth_http_merge_conf
comment|/* merge server configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_mail_auth_http_module
name|ngx_module_t
name|ngx_mail_auth_http_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_mail_auth_http_module_ctx
block|,
comment|/* module context */
name|ngx_mail_auth_http_commands
block|,
comment|/* module directives */
name|NGX_MAIL_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|NULL
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|NULL
block|,
comment|/* exit process */
name|NULL
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_mail_auth_http_protocol
specifier|static
name|char
modifier|*
name|ngx_mail_auth_http_protocol
index|[]
init|=
block|{
literal|"pop3"
block|,
literal|"imap"
block|,
literal|"smtp"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_mail_auth_http_method
specifier|static
name|ngx_str_t
name|ngx_mail_auth_http_method
index|[]
init|=
block|{
name|ngx_string
argument_list|(
literal|"plain"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"plain"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"apop"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"cram-md5"
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_mail_smtp_errcode
specifier|static
name|ngx_str_t
name|ngx_mail_smtp_errcode
init|=
name|ngx_string
argument_list|(
literal|"535 5.7.0"
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|ngx_mail_auth_http_init (ngx_mail_session_t * s)
name|ngx_mail_auth_http_init
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_pool_t
modifier|*
name|pool
decl_stmt|;
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_mail_auth_http_conf_t
modifier|*
name|ahcf
decl_stmt|;
name|s
operator|->
name|connection
operator|->
name|log
operator|->
name|action
operator|=
literal|"in http auth state"
expr_stmt|;
name|pool
operator|=
name|ngx_create_pool
argument_list|(
literal|2048
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|pool
operator|==
name|NULL
condition|)
block|{
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_mail_auth_http_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ngx_destroy_pool
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
name|ahcf
operator|=
name|ngx_mail_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_mail_auth_http_module
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|request
operator|=
name|ngx_mail_auth_http_create_request
argument_list|(
name|s
argument_list|,
name|pool
argument_list|,
name|ahcf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|request
operator|==
name|NULL
condition|)
block|{
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_mail_set_ctx
argument_list|(
name|s
argument_list|,
name|ctx
argument_list|,
name|ngx_mail_auth_http_module
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|sockaddr
operator|=
name|ahcf
operator|->
name|peer
operator|->
name|sockaddr
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|socklen
operator|=
name|ahcf
operator|->
name|peer
operator|->
name|socklen
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|name
operator|=
operator|&
name|ahcf
operator|->
name|peer
operator|->
name|name
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|get
operator|=
name|ngx_event_get_peer
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|log
operator|=
name|s
operator|->
name|connection
operator|->
name|log
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|log_error
operator|=
name|NGX_ERROR_ERR
expr_stmt|;
name|rc
operator|=
name|ngx_event_connect_peer
argument_list|(
operator|&
name|ctx
operator|->
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|==
name|NGX_BUSY
operator|||
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|peer
operator|.
name|connection
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
block|}
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|data
operator|=
name|s
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|pool
operator|=
name|s
operator|->
name|connection
operator|->
name|pool
expr_stmt|;
name|s
operator|->
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_mail_auth_http_block_read
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_mail_auth_http_read_handler
expr_stmt|;
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_mail_auth_http_write_handler
expr_stmt|;
name|ctx
operator|->
name|handler
operator|=
name|ngx_mail_auth_http_ignore_status_line
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
argument_list|,
name|ahcf
operator|->
name|timeout
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
name|ahcf
operator|->
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
name|ngx_mail_auth_http_write_handler
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_mail_auth_http_write_handler (ngx_event_t * wev)
name|ngx_mail_auth_http_write_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
block|{
name|ssize_t
name|n
decl_stmt|,
name|size
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_mail_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_mail_auth_http_conf_t
modifier|*
name|ahcf
decl_stmt|;
name|c
operator|=
name|wev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|ctx
operator|=
name|ngx_mail_get_module_ctx
argument_list|(
name|s
argument_list|,
name|ngx_mail_auth_http_module
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|wev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http write handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|wev
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"auth http server %V timed out"
argument_list|,
name|ctx
operator|->
name|peer
operator|.
name|name
argument_list|)
expr_stmt|;
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|size
operator|=
name|ctx
operator|->
name|request
operator|->
name|last
operator|-
name|ctx
operator|->
name|request
operator|->
name|pos
expr_stmt|;
name|n
operator|=
name|ngx_send
argument_list|(
name|c
argument_list|,
name|ctx
operator|->
name|request
operator|->
name|pos
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|ctx
operator|->
name|request
operator|->
name|pos
operator|+=
name|n
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|size
condition|)
block|{
name|wev
operator|->
name|handler
operator|=
name|ngx_mail_auth_http_dummy_handler
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|wev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|wev
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
if|if
condition|(
operator|!
name|wev
operator|->
name|timer_set
condition|)
block|{
name|ahcf
operator|=
name|ngx_mail_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_mail_auth_http_module
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|wev
argument_list|,
name|ahcf
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_mail_auth_http_read_handler (ngx_event_t * rev)
name|ngx_mail_auth_http_read_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ssize_t
name|n
decl_stmt|,
name|size
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_mail_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http read handler"
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ngx_mail_get_module_ctx
argument_list|(
name|s
argument_list|,
name|ngx_mail_auth_http_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|rev
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"auth http server %V timed out"
argument_list|,
name|ctx
operator|->
name|peer
operator|.
name|name
argument_list|)
expr_stmt|;
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ctx
operator|->
name|response
operator|==
name|NULL
condition|)
block|{
name|ctx
operator|->
name|response
operator|=
name|ngx_create_temp_buf
argument_list|(
name|ctx
operator|->
name|pool
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|response
operator|==
name|NULL
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|size
operator|=
name|ctx
operator|->
name|response
operator|->
name|end
operator|-
name|ctx
operator|->
name|response
operator|->
name|last
expr_stmt|;
name|n
operator|=
name|ngx_recv
argument_list|(
name|c
argument_list|,
name|ctx
operator|->
name|response
operator|->
name|pos
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|ctx
operator|->
name|response
operator|->
name|last
operator|+=
name|n
expr_stmt|;
name|ctx
operator|->
name|handler
argument_list|(
name|s
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return;
block|}
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_mail_auth_http_ignore_status_line (ngx_mail_session_t * s,ngx_mail_auth_http_ctx_t * ctx)
name|ngx_mail_auth_http_ignore_status_line
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
name|ch
decl_stmt|;
DECL|enum|__anon2c703de00203
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_H
name|sw_H
block|,
DECL|enumerator|sw_HT
name|sw_HT
block|,
DECL|enumerator|sw_HTT
name|sw_HTT
block|,
DECL|enumerator|sw_HTTP
name|sw_HTTP
block|,
DECL|enumerator|sw_skip
name|sw_skip
block|,
DECL|enumerator|sw_almost_done
name|sw_almost_done
block|}
name|state
enum|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http process status line"
argument_list|)
expr_stmt|;
name|state
operator|=
name|ctx
operator|->
name|state
expr_stmt|;
for|for
control|(
name|p
operator|=
name|ctx
operator|->
name|response
operator|->
name|pos
init|;
name|p
operator|<
name|ctx
operator|->
name|response
operator|->
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
comment|/* "HTTP/" */
case|case
name|sw_start
case|:
if|if
condition|(
name|ch
operator|==
literal|'H'
condition|)
block|{
name|state
operator|=
name|sw_H
expr_stmt|;
break|break;
block|}
goto|goto
name|next
goto|;
case|case
name|sw_H
case|:
if|if
condition|(
name|ch
operator|==
literal|'T'
condition|)
block|{
name|state
operator|=
name|sw_HT
expr_stmt|;
break|break;
block|}
goto|goto
name|next
goto|;
case|case
name|sw_HT
case|:
if|if
condition|(
name|ch
operator|==
literal|'T'
condition|)
block|{
name|state
operator|=
name|sw_HTT
expr_stmt|;
break|break;
block|}
goto|goto
name|next
goto|;
case|case
name|sw_HTT
case|:
if|if
condition|(
name|ch
operator|==
literal|'P'
condition|)
block|{
name|state
operator|=
name|sw_HTTP
expr_stmt|;
break|break;
block|}
goto|goto
name|next
goto|;
case|case
name|sw_HTTP
case|:
if|if
condition|(
name|ch
operator|==
literal|'/'
condition|)
block|{
name|state
operator|=
name|sw_skip
expr_stmt|;
break|break;
block|}
goto|goto
name|next
goto|;
comment|/* any text until end of line */
case|case
name|sw_skip
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|CR
case|:
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
goto|goto
name|done
goto|;
block|}
break|break;
comment|/* end of status line */
case|case
name|sw_almost_done
case|:
if|if
condition|(
name|ch
operator|==
name|LF
condition|)
block|{
goto|goto
name|done
goto|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"auth http server&V sent invalid response"
argument_list|,
name|ctx
operator|->
name|peer
operator|.
name|name
argument_list|)
expr_stmt|;
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|ctx
operator|->
name|response
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|state
expr_stmt|;
return|return;
name|next
label|:
name|p
operator|=
name|ctx
operator|->
name|response
operator|->
name|start
operator|-
literal|1
expr_stmt|;
name|done
label|:
name|ctx
operator|->
name|response
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|handler
operator|=
name|ngx_mail_auth_http_process_headers
expr_stmt|;
name|ctx
operator|->
name|handler
argument_list|(
name|s
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_mail_auth_http_process_headers (ngx_mail_session_t * s,ngx_mail_auth_http_ctx_t * ctx)
name|ngx_mail_auth_http_process_headers
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|time_t
name|timer
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|size
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|,
name|port
decl_stmt|,
name|n
decl_stmt|;
name|ngx_peer_addr_t
modifier|*
name|peer
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http process headers"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|rc
operator|=
name|ngx_mail_auth_http_parse_header_line
argument_list|(
name|s
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
block|{
name|ngx_str_t
name|key
decl_stmt|,
name|value
decl_stmt|;
name|key
operator|.
name|len
operator|=
name|ctx
operator|->
name|header_name_end
operator|-
name|ctx
operator|->
name|header_name_start
expr_stmt|;
name|key
operator|.
name|data
operator|=
name|ctx
operator|->
name|header_name_start
expr_stmt|;
name|value
operator|.
name|len
operator|=
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
expr_stmt|;
name|value
operator|.
name|data
operator|=
name|ctx
operator|->
name|header_start
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http header: \"%V: %V\""
argument_list|,
operator|&
name|key
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|len
operator|=
name|ctx
operator|->
name|header_name_end
operator|-
name|ctx
operator|->
name|header_name_start
expr_stmt|;
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
literal|"Auth-Status"
argument_list|)
operator|-
literal|1
operator|&&
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_name_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Auth-Status"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Status"
argument_list|)
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|len
operator|=
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|2
operator|&&
name|ctx
operator|->
name|header_start
index|[
literal|0
index|]
operator|==
literal|'O'
operator|&&
name|ctx
operator|->
name|header_start
index|[
literal|1
index|]
operator|==
literal|'K'
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|len
operator|==
literal|4
operator|&&
name|ctx
operator|->
name|header_start
index|[
literal|0
index|]
operator|==
literal|'W'
operator|&&
name|ctx
operator|->
name|header_start
index|[
literal|1
index|]
operator|==
literal|'A'
operator|&&
name|ctx
operator|->
name|header_start
index|[
literal|2
index|]
operator|==
literal|'I'
operator|&&
name|ctx
operator|->
name|header_start
index|[
literal|3
index|]
operator|==
literal|'T'
condition|)
block|{
name|s
operator|->
name|auth_wait
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|ctx
operator|->
name|errmsg
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|ctx
operator|->
name|errmsg
operator|.
name|data
operator|=
name|ctx
operator|->
name|header_start
expr_stmt|;
switch|switch
condition|(
name|s
operator|->
name|protocol
condition|)
block|{
case|case
name|NGX_MAIL_POP3_PROTOCOL
case|:
name|size
operator|=
sizeof|sizeof
argument_list|(
literal|"-ERR "
argument_list|)
operator|-
literal|1
operator|+
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
expr_stmt|;
break|break;
case|case
name|NGX_MAIL_IMAP_PROTOCOL
case|:
name|size
operator|=
name|s
operator|->
name|tag
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
literal|"NO "
argument_list|)
operator|-
literal|1
operator|+
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
comment|/* NGX_MAIL_SMTP_PROTOCOL */
name|ctx
operator|->
name|err
operator|=
name|ctx
operator|->
name|errmsg
expr_stmt|;
continue|continue;
block|}
name|p
operator|=
name|ngx_pcalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|->
name|err
operator|.
name|data
operator|=
name|p
expr_stmt|;
switch|switch
condition|(
name|s
operator|->
name|protocol
condition|)
block|{
case|case
name|NGX_MAIL_POP3_PROTOCOL
case|:
operator|*
name|p
operator|++
operator|=
literal|'-'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'E'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'R'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'R'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
break|break;
case|case
name|NGX_MAIL_IMAP_PROTOCOL
case|:
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|s
operator|->
name|tag
operator|.
name|data
argument_list|,
name|s
operator|->
name|tag
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'N'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'O'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
break|break;
default|default:
comment|/* NGX_MAIL_SMTP_PROTOCOL */
break|break;
block|}
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|ctx
operator|->
name|header_start
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|LF
expr_stmt|;
name|ctx
operator|->
name|err
operator|.
name|len
operator|=
name|p
operator|-
name|ctx
operator|->
name|err
operator|.
name|data
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
literal|"Auth-Server"
argument_list|)
operator|-
literal|1
operator|&&
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_name_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Auth-Server"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Server"
argument_list|)
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ctx
operator|->
name|addr
operator|.
name|len
operator|=
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
expr_stmt|;
name|ctx
operator|->
name|addr
operator|.
name|data
operator|=
name|ctx
operator|->
name|header_start
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
literal|"Auth-Port"
argument_list|)
operator|-
literal|1
operator|&&
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_name_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Auth-Port"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Port"
argument_list|)
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ctx
operator|->
name|port
operator|.
name|len
operator|=
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
expr_stmt|;
name|ctx
operator|->
name|port
operator|.
name|data
operator|=
name|ctx
operator|->
name|header_start
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
literal|"Auth-User"
argument_list|)
operator|-
literal|1
operator|&&
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_name_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Auth-User"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-User"
argument_list|)
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|->
name|login
operator|.
name|len
operator|=
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
expr_stmt|;
name|s
operator|->
name|login
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|s
operator|->
name|login
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|login
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_memcpy
argument_list|(
name|s
operator|->
name|login
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|header_start
argument_list|,
name|s
operator|->
name|login
operator|.
name|len
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
literal|"Auth-Pass"
argument_list|)
operator|-
literal|1
operator|&&
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_name_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Auth-Pass"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Pass"
argument_list|)
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|->
name|passwd
operator|.
name|len
operator|=
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
expr_stmt|;
name|s
operator|->
name|passwd
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|s
operator|->
name|passwd
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|passwd
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_memcpy
argument_list|(
name|s
operator|->
name|passwd
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|header_start
argument_list|,
name|s
operator|->
name|passwd
operator|.
name|len
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
literal|"Auth-Wait"
argument_list|)
operator|-
literal|1
operator|&&
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_name_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Auth-Wait"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Wait"
argument_list|)
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|n
operator|=
name|ngx_atoi
argument_list|(
name|ctx
operator|->
name|header_start
argument_list|,
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|NGX_ERROR
condition|)
block|{
name|ctx
operator|->
name|sleep
operator|=
name|n
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|len
operator|==
sizeof|sizeof
argument_list|(
literal|"Auth-Error-Code"
argument_list|)
operator|-
literal|1
operator|&&
name|ngx_strncasecmp
argument_list|(
name|ctx
operator|->
name|header_name_start
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Auth-Error-Code"
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Error-Code"
argument_list|)
operator|-
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ctx
operator|->
name|errcode
operator|.
name|len
operator|=
name|ctx
operator|->
name|header_end
operator|-
name|ctx
operator|->
name|header_start
expr_stmt|;
name|ctx
operator|->
name|errcode
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|ctx
operator|->
name|errcode
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|errcode
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_memcpy
argument_list|(
name|ctx
operator|->
name|errcode
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|header_start
argument_list|,
name|ctx
operator|->
name|errcode
operator|.
name|len
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* ignore other headers */
continue|continue;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_DONE
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http header done"
argument_list|)
expr_stmt|;
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|err
operator|.
name|len
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client login failed: \"%V\""
argument_list|,
operator|&
name|ctx
operator|->
name|errmsg
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|protocol
operator|==
name|NGX_MAIL_SMTP_PROTOCOL
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|errcode
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ctx
operator|->
name|errcode
operator|=
name|ngx_mail_smtp_errcode
expr_stmt|;
block|}
name|ctx
operator|->
name|err
operator|.
name|len
operator|=
name|ctx
operator|->
name|errcode
operator|.
name|len
operator|+
name|ctx
operator|->
name|errmsg
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
literal|" "
name|CRLF
argument_list|)
operator|-
literal|1
expr_stmt|;
name|p
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|ctx
operator|->
name|err
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|->
name|err
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|ctx
operator|->
name|errcode
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|errcode
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|ctx
operator|->
name|errmsg
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|errmsg
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|p
operator|=
name|LF
expr_stmt|;
block|}
name|s
operator|->
name|out
operator|=
name|ctx
operator|->
name|err
expr_stmt|;
name|timer
operator|=
name|ctx
operator|->
name|sleep
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|timer
operator|==
literal|0
condition|)
block|{
name|s
operator|->
name|quit
operator|=
literal|1
expr_stmt|;
name|ngx_mail_send
argument_list|(
name|s
operator|->
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_add_timer
argument_list|(
name|s
operator|->
name|connection
operator|->
name|read
argument_list|,
name|timer
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|s
operator|->
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_mail_auth_sleep_handler
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|->
name|auth_wait
condition|)
block|{
name|timer
operator|=
name|ctx
operator|->
name|sleep
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|timer
operator|==
literal|0
condition|)
block|{
name|ngx_mail_auth_http_init
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_add_timer
argument_list|(
name|s
operator|->
name|connection
operator|->
name|read
argument_list|,
name|timer
operator|*
literal|1000
argument_list|)
expr_stmt|;
name|s
operator|->
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_mail_auth_sleep_handler
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ctx
operator|->
name|addr
operator|.
name|len
operator|==
literal|0
operator|||
name|ctx
operator|->
name|port
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"auth http server %V did not send server or port"
argument_list|,
name|ctx
operator|->
name|peer
operator|.
name|name
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|s
operator|->
name|passwd
operator|.
name|data
operator|==
name|NULL
operator|&&
name|s
operator|->
name|protocol
operator|!=
name|NGX_MAIL_SMTP_PROTOCOL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"auth http server %V did not send password"
argument_list|,
name|ctx
operator|->
name|peer
operator|.
name|name
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|peer
operator|=
name|ngx_pcalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_peer_addr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|sin
operator|=
name|ngx_pcalloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sin
operator|==
name|NULL
condition|)
block|{
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|port
operator|=
name|ngx_atoi
argument_list|(
name|ctx
operator|->
name|port
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|port
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
name|NGX_ERROR
operator|||
name|port
argument_list|<
literal|1
operator|||
name|port
argument_list|>
literal|65536
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"auth http server %V sent invalid server "
literal|"port:\"%V\""
argument_list|,
name|ctx
operator|->
name|peer
operator|.
name|name
argument_list|,
operator|&
name|ctx
operator|->
name|port
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|sin
operator|->
name|sin_port
operator|=
name|htons
argument_list|(
operator|(
name|in_port_t
operator|)
name|port
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|addr
operator|.
name|data
index|[
name|ctx
operator|->
name|addr
operator|.
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|inet_addr
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ctx
operator|->
name|addr
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
name|INADDR_NONE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"auth http server %V sent invalid server "
literal|"address:\"%V\""
argument_list|,
name|ctx
operator|->
name|peer
operator|.
name|name
argument_list|,
operator|&
name|ctx
operator|->
name|addr
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|peer
operator|->
name|sockaddr
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sin
expr_stmt|;
name|peer
operator|->
name|socklen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|len
operator|=
name|ctx
operator|->
name|addr
operator|.
name|len
operator|+
literal|1
operator|+
name|ctx
operator|->
name|port
operator|.
name|len
expr_stmt|;
name|peer
operator|->
name|name
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|peer
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|s
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
name|len
operator|=
name|ctx
operator|->
name|addr
operator|.
name|len
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|peer
operator|->
name|name
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|addr
operator|.
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|peer
operator|->
name|name
operator|.
name|data
index|[
name|len
operator|++
index|]
operator|=
literal|':'
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|peer
operator|->
name|name
operator|.
name|data
operator|+
name|len
argument_list|,
name|ctx
operator|->
name|port
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|port
operator|.
name|len
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_proxy_init
argument_list|(
name|s
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return;
block|}
comment|/* rc == NGX_ERROR */
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"auth http server %V sent invalid header in response"
argument_list|,
name|ctx
operator|->
name|peer
operator|.
name|name
argument_list|)
expr_stmt|;
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_mail_auth_sleep_handler (ngx_event_t * rev)
name|ngx_mail_auth_sleep_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_mail_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_mail_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth sleep handler"
argument_list|)
expr_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|timedout
condition|)
block|{
name|rev
operator|->
name|timedout
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|auth_wait
condition|)
block|{
name|s
operator|->
name|auth_wait
operator|=
literal|0
expr_stmt|;
name|ngx_mail_auth_http_init
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|s
operator|->
name|protocol
condition|)
block|{
case|case
name|NGX_MAIL_POP3_PROTOCOL
case|:
name|s
operator|->
name|mail_state
operator|=
name|ngx_pop3_start
expr_stmt|;
name|s
operator|->
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_pop3_auth_state
expr_stmt|;
break|break;
case|case
name|NGX_MAIL_IMAP_PROTOCOL
case|:
name|s
operator|->
name|mail_state
operator|=
name|ngx_imap_start
expr_stmt|;
name|s
operator|->
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_imap_auth_state
expr_stmt|;
break|break;
default|default:
comment|/* NGX_MAIL_SMTP_PROTOCOL */
name|s
operator|->
name|mail_state
operator|=
name|ngx_smtp_start
expr_stmt|;
name|s
operator|->
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_smtp_auth_state
expr_stmt|;
break|break;
block|}
name|s
operator|->
name|auth_method
operator|=
name|NGX_MAIL_AUTH_PLAIN
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"in auth state"
expr_stmt|;
name|ngx_mail_send
argument_list|(
name|s
operator|->
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|destroyed
condition|)
block|{
return|return;
block|}
name|cscf
operator|=
name|ngx_mail_get_module_srv_conf
argument_list|(
name|s
argument_list|,
name|ngx_mail_core_module
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|rev
argument_list|,
name|cscf
operator|->
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|ready
condition|)
block|{
name|s
operator|->
name|connection
operator|->
name|read
operator|->
name|handler
argument_list|(
name|rev
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_mail_close_connection
argument_list|(
name|s
operator|->
name|connection
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|rev
operator|->
name|active
condition|)
block|{
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_mail_close_connection
argument_list|(
name|s
operator|->
name|connection
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_mail_auth_http_parse_header_line (ngx_mail_session_t * s,ngx_mail_auth_http_ctx_t * ctx)
name|ngx_mail_auth_http_parse_header_line
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|u_char
name|c
decl_stmt|,
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|ngx_uint_t
name|hash
decl_stmt|;
DECL|enum|__anon2c703de00303
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_name
name|sw_name
block|,
DECL|enumerator|sw_space_before_value
name|sw_space_before_value
block|,
DECL|enumerator|sw_value
name|sw_value
block|,
DECL|enumerator|sw_space_after_value
name|sw_space_after_value
block|,
DECL|enumerator|sw_almost_done
name|sw_almost_done
block|,
DECL|enumerator|sw_header_almost_done
name|sw_header_almost_done
block|}
name|state
enum|;
name|state
operator|=
name|ctx
operator|->
name|state
expr_stmt|;
name|hash
operator|=
name|ctx
operator|->
name|hash
expr_stmt|;
for|for
control|(
name|p
operator|=
name|ctx
operator|->
name|response
operator|->
name|pos
init|;
name|p
operator|<
name|ctx
operator|->
name|response
operator|->
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
comment|/* first char */
case|case
name|sw_start
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|CR
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_header_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|header_done
goto|;
default|default:
name|state
operator|=
name|sw_name
expr_stmt|;
name|ctx
operator|->
name|header_name_start
operator|=
name|p
expr_stmt|;
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
condition|)
block|{
name|hash
operator|=
name|c
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
name|hash
operator|=
name|ch
expr_stmt|;
break|break;
block|}
return|return
name|NGX_ERROR
return|;
block|}
break|break;
comment|/* header name */
case|case
name|sw_name
case|:
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
condition|)
block|{
name|hash
operator|+=
name|c
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
literal|':'
condition|)
block|{
name|ctx
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_space_before_value
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
literal|'-'
condition|)
block|{
name|hash
operator|+=
name|ch
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
name|hash
operator|+=
name|ch
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
name|CR
condition|)
block|{
name|ctx
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
name|LF
condition|)
block|{
name|ctx
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
block|}
return|return
name|NGX_ERROR
return|;
comment|/* space* before header value */
case|case
name|sw_space_before_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
case|case
name|CR
case|:
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
default|default:
name|ctx
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
block|}
break|break;
comment|/* header value */
case|case
name|sw_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_space_after_value
expr_stmt|;
break|break;
case|case
name|CR
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|ctx
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
comment|/* space* before end of header line */
case|case
name|sw_space_after_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
case|case
name|CR
case|:
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
block|}
break|break;
comment|/* end of header line */
case|case
name|sw_almost_done
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
comment|/* end of header */
case|case
name|sw_header_almost_done
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
goto|goto
name|header_done
goto|;
default|default:
return|return
name|NGX_ERROR
return|;
block|}
block|}
block|}
name|ctx
operator|->
name|response
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|state
expr_stmt|;
name|ctx
operator|->
name|hash
operator|=
name|hash
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
name|done
label|:
name|ctx
operator|->
name|response
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|sw_start
expr_stmt|;
name|ctx
operator|->
name|hash
operator|=
name|hash
expr_stmt|;
return|return
name|NGX_OK
return|;
name|header_done
label|:
name|ctx
operator|->
name|response
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|sw_start
expr_stmt|;
return|return
name|NGX_DONE
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_mail_auth_http_block_read (ngx_event_t * rev)
name|ngx_mail_auth_http_block_read
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_mail_session_t
modifier|*
name|s
decl_stmt|;
name|ngx_mail_auth_http_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http block read"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|ctx
operator|=
name|ngx_mail_get_module_ctx
argument_list|(
name|s
argument_list|,
name|ngx_mail_auth_http_module
argument_list|)
expr_stmt|;
name|ngx_close_connection
argument_list|(
name|ctx
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
name|ngx_destroy_pool
argument_list|(
name|ctx
operator|->
name|pool
argument_list|)
expr_stmt|;
name|ngx_mail_session_internal_server_error
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_mail_auth_http_dummy_handler (ngx_event_t * ev)
name|ngx_mail_auth_http_dummy_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|ev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http dummy handler"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_buf_t
modifier|*
DECL|function|ngx_mail_auth_http_create_request (ngx_mail_session_t * s,ngx_pool_t * pool,ngx_mail_auth_http_conf_t * ahcf)
name|ngx_mail_auth_http_create_request
parameter_list|(
name|ngx_mail_session_t
modifier|*
name|s
parameter_list|,
name|ngx_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_mail_auth_http_conf_t
modifier|*
name|ahcf
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_str_t
name|login
decl_stmt|,
name|passwd
decl_stmt|;
if|if
condition|(
name|ngx_mail_auth_http_escape
argument_list|(
name|pool
argument_list|,
operator|&
name|s
operator|->
name|login
argument_list|,
operator|&
name|login
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ngx_mail_auth_http_escape
argument_list|(
name|pool
argument_list|,
operator|&
name|s
operator|->
name|passwd
argument_list|,
operator|&
name|passwd
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"GET "
argument_list|)
operator|-
literal|1
operator|+
name|ahcf
operator|->
name|uri
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
literal|" HTTP/1.0"
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Host: "
argument_list|)
operator|-
literal|1
operator|+
name|ahcf
operator|->
name|host_header
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-Method: "
argument_list|)
operator|-
literal|1
operator|+
name|ngx_mail_auth_http_method
index|[
name|s
operator|->
name|auth_method
index|]
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-User: "
argument_list|)
operator|-
literal|1
operator|+
name|login
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-Pass: "
argument_list|)
operator|-
literal|1
operator|+
name|passwd
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-Salt: "
argument_list|)
operator|-
literal|1
operator|+
name|s
operator|->
name|salt
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-Protocol: imap"
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Auth-Login-Attempt: "
argument_list|)
operator|-
literal|1
operator|+
name|NGX_INT_T_LEN
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
literal|"Client-IP: "
argument_list|)
operator|-
literal|1
operator|+
name|s
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
operator|+
name|ahcf
operator|->
name|header
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|CRLF
argument_list|)
operator|-
literal|1
expr_stmt|;
name|b
operator|=
name|ngx_create_temp_buf
argument_list|(
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"GET "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"GET "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ahcf
operator|->
name|uri
operator|.
name|data
argument_list|,
name|ahcf
operator|->
name|uri
operator|.
name|len
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|" HTTP/1.0"
name|CRLF
argument_list|,
sizeof|sizeof
argument_list|(
literal|" HTTP/1.0"
name|CRLF
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Host: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Host: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ahcf
operator|->
name|host_header
operator|.
name|data
argument_list|,
name|ahcf
operator|->
name|host_header
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-Method: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Method: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ngx_mail_auth_http_method
index|[
name|s
operator|->
name|auth_method
index|]
operator|.
name|data
argument_list|,
name|ngx_mail_auth_http_method
index|[
name|s
operator|->
name|auth_method
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-User: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-User: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|login
operator|.
name|data
argument_list|,
name|login
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-Pass: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Pass: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|passwd
operator|.
name|data
argument_list|,
name|passwd
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|auth_method
operator|!=
name|NGX_MAIL_AUTH_PLAIN
operator|&&
name|s
operator|->
name|salt
operator|.
name|len
condition|)
block|{
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-Salt: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Salt: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|s
operator|->
name|salt
operator|.
name|data
argument_list|,
name|s
operator|->
name|salt
operator|.
name|len
argument_list|)
expr_stmt|;
name|s
operator|->
name|passwd
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
block|}
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-Protocol: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Auth-Protocol: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ngx_mail_auth_http_protocol
index|[
name|s
operator|->
name|protocol
index|]
argument_list|,
sizeof|sizeof
argument_list|(
literal|"imap"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_sprintf
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Auth-Login-Attempt: %ui"
name|CRLF
argument_list|,
name|s
operator|->
name|login_attempt
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|b
operator|->
name|last
argument_list|,
literal|"Client-IP: "
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Client-IP: "
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|s
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|data
argument_list|,
name|s
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
if|if
condition|(
name|ahcf
operator|->
name|header
operator|.
name|len
condition|)
block|{
name|b
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ahcf
operator|->
name|header
operator|.
name|data
argument_list|,
name|ahcf
operator|->
name|header
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
comment|/* add "\r\n" at the header end */
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|LF
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG_MAIL_PASSWD
operator|)
block|{
name|ngx_str_t
name|l
decl_stmt|;
name|l
operator|.
name|len
operator|=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|l
operator|.
name|data
operator|=
name|b
operator|->
name|pos
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_MAIL
argument_list|,
name|s
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mail auth http header:\n\"%V\""
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_mail_auth_http_escape (ngx_pool_t * pool,ngx_str_t * text,ngx_str_t * escaped)
name|ngx_mail_auth_http_escape
parameter_list|(
name|ngx_pool_t
modifier|*
name|pool
parameter_list|,
name|ngx_str_t
modifier|*
name|text
parameter_list|,
name|ngx_str_t
modifier|*
name|escaped
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|text
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
name|text
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|==
name|CR
operator|||
name|ch
operator|==
name|LF
condition|)
block|{
name|n
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
operator|*
name|escaped
operator|=
operator|*
name|text
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|escaped
operator|->
name|len
operator|=
name|text
operator|->
name|len
operator|+
name|n
operator|*
literal|2
expr_stmt|;
name|p
operator|=
name|ngx_palloc
argument_list|(
name|pool
argument_list|,
name|escaped
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|escaped
operator|->
name|data
operator|=
name|p
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|text
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
name|text
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|==
name|CR
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'%'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'0'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'D'
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ch
operator|==
name|LF
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'%'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'0'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'A'
expr_stmt|;
continue|continue;
block|}
operator|*
name|p
operator|++
operator|=
name|ch
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_mail_auth_http_create_conf (ngx_conf_t * cf)
name|ngx_mail_auth_http_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_mail_auth_http_conf_t
modifier|*
name|ahcf
decl_stmt|;
name|ahcf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_mail_auth_http_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahcf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ahcf
operator|->
name|timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
return|return
name|ahcf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_mail_auth_http_merge_conf (ngx_conf_t * cf,void * parent,void * child)
name|ngx_mail_auth_http_merge_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
block|{
name|ngx_mail_auth_http_conf_t
modifier|*
name|prev
init|=
name|parent
decl_stmt|;
name|ngx_mail_auth_http_conf_t
modifier|*
name|conf
init|=
name|child
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|header
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|peer
operator|==
name|NULL
condition|)
block|{
name|conf
operator|->
name|peer
operator|=
name|prev
operator|->
name|peer
expr_stmt|;
name|conf
operator|->
name|host_header
operator|=
name|prev
operator|->
name|host_header
expr_stmt|;
name|conf
operator|->
name|uri
operator|=
name|prev
operator|->
name|uri
expr_stmt|;
block|}
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|timeout
argument_list|,
name|prev
operator|->
name|timeout
argument_list|,
literal|60000
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|headers
operator|==
name|NULL
condition|)
block|{
name|conf
operator|->
name|headers
operator|=
name|prev
operator|->
name|headers
expr_stmt|;
name|conf
operator|->
name|header
operator|=
name|prev
operator|->
name|header
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|headers
operator|&&
name|conf
operator|->
name|header
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|header
operator|=
name|conf
operator|->
name|headers
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|headers
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|len
operator|+=
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
operator|+
literal|2
operator|+
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|len
operator|+
literal|2
expr_stmt|;
block|}
name|p
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|conf
operator|->
name|header
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|conf
operator|->
name|header
operator|.
name|data
operator|=
name|p
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|headers
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|':'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|data
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|CR
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|LF
expr_stmt|;
block|}
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_mail_auth_http (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_mail_auth_http
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_mail_auth_http_conf_t
modifier|*
name|ahcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_url_t
name|u
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|u
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|.
name|url
operator|=
name|value
index|[
literal|1
index|]
expr_stmt|;
name|u
operator|.
name|default_port
operator|=
literal|80
expr_stmt|;
name|u
operator|.
name|uri_part
operator|=
literal|1
expr_stmt|;
name|u
operator|.
name|one_addr
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_parse_url
argument_list|(
name|cf
argument_list|,
operator|&
name|u
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|u
operator|.
name|err
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"%s in auth_http \"%V\""
argument_list|,
name|u
operator|.
name|err
argument_list|,
operator|&
name|u
operator|.
name|url
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ahcf
operator|->
name|peer
operator|=
name|u
operator|.
name|addrs
expr_stmt|;
name|ahcf
operator|->
name|host_header
operator|=
name|u
operator|.
name|host
expr_stmt|;
name|ahcf
operator|->
name|uri
operator|=
name|u
operator|.
name|uri
expr_stmt|;
if|if
condition|(
name|ahcf
operator|->
name|uri
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ahcf
operator|->
name|uri
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"/"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|ahcf
operator|->
name|uri
operator|.
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"/"
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_mail_auth_http_header (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_mail_auth_http_header
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_mail_auth_http_conf_t
modifier|*
name|ahcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|header
decl_stmt|;
if|if
condition|(
name|ahcf
operator|->
name|headers
operator|==
name|NULL
condition|)
block|{
name|ahcf
operator|->
name|headers
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_table_elt_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahcf
operator|->
name|headers
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|header
operator|=
name|ngx_array_push
argument_list|(
name|ahcf
operator|->
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|header
operator|->
name|key
operator|=
name|value
index|[
literal|1
index|]
expr_stmt|;
name|header
operator|->
name|value
operator|=
name|value
index|[
literal|2
index|]
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

end_unit

