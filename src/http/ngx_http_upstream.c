begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_resolve_handler
parameter_list|(
name|ngx_resolver_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_rd_check_broken_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_wr_check_broken_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_check_broken_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_connect
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_reinit
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_send_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_send_request_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_process_header
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_test_connect
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_process_body_in_memory
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_send_response
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_process_non_buffered_downstream
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_process_non_buffered_body
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_non_buffered_filter_init
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_non_buffered_filter
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|ssize_t
name|bytes
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_process_downstream
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_process_body
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_store
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_dummy_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_next
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|,
name|ngx_uint_t
name|ft_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_finalize_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|,
name|ngx_int_t
name|rc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_process_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_process_multi_header_lines
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_ignore_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_process_limit_rate
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_process_buffering
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_process_charset
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_copy_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_copy_multi_header_lines
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_copy_content_type
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_copy_content_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_rewrite_location
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_rewrite_refresh
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_GZIP
operator|)
end_if

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_copy_content_encoding
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_add_variables
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_addr_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_status_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_upstream_response_time_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_upstream
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|dummy
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_upstream_server
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_upstream_create_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_upstream_init_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
end_if

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_ssl_init_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|,
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_upstream_ssl_handshake
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
DECL|variable|ngx_http_upstream_headers_in
name|ngx_http_upstream_header_t
name|ngx_http_upstream_headers_in
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"Status"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|status
argument_list|)
block|,
name|ngx_http_upstream_copy_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Content-Type"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|content_type
argument_list|)
block|,
name|ngx_http_upstream_copy_content_type
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Content-Length"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|content_length
argument_list|)
block|,
name|ngx_http_upstream_copy_content_length
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Date"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|date
argument_list|)
block|,
name|ngx_http_upstream_copy_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_headers_out_t
argument_list|,
name|date
argument_list|)
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Last-Modified"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|last_modified
argument_list|)
block|,
name|ngx_http_upstream_copy_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_headers_out_t
argument_list|,
name|last_modified
argument_list|)
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Server"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|server
argument_list|)
block|,
name|ngx_http_upstream_copy_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_headers_out_t
argument_list|,
name|server
argument_list|)
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"WWW-Authenticate"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|www_authenticate
argument_list|)
block|,
name|ngx_http_upstream_copy_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Location"
argument_list|)
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
name|ngx_http_upstream_rewrite_location
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Refresh"
argument_list|)
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
name|ngx_http_upstream_rewrite_refresh
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Set-Cookie"
argument_list|)
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
name|ngx_http_upstream_copy_header_line
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Content-Disposition"
argument_list|)
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
name|ngx_http_upstream_copy_header_line
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Cache-Control"
argument_list|)
block|,
name|ngx_http_upstream_process_multi_header_lines
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|cache_control
argument_list|)
block|,
name|ngx_http_upstream_copy_multi_header_lines
block|,
name|offsetof
argument_list|(
name|ngx_http_headers_out_t
argument_list|,
name|cache_control
argument_list|)
block|,
literal|1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Expires"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|expires
argument_list|)
block|,
name|ngx_http_upstream_copy_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_headers_out_t
argument_list|,
name|expires
argument_list|)
block|,
literal|1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Accept-Ranges"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|accept_ranges
argument_list|)
block|,
name|ngx_http_upstream_copy_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_headers_out_t
argument_list|,
name|accept_ranges
argument_list|)
block|,
literal|1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Connection"
argument_list|)
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Keep-Alive"
argument_list|)
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"X-Powered-By"
argument_list|)
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
name|ngx_http_upstream_copy_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"X-Accel-Expires"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|x_accel_expires
argument_list|)
block|,
name|ngx_http_upstream_copy_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"X-Accel-Redirect"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|x_accel_redirect
argument_list|)
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"X-Accel-Limit-Rate"
argument_list|)
block|,
name|ngx_http_upstream_process_limit_rate
block|,
literal|0
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"X-Accel-Buffering"
argument_list|)
block|,
name|ngx_http_upstream_process_buffering
block|,
literal|0
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"X-Accel-Charset"
argument_list|)
block|,
name|ngx_http_upstream_process_charset
block|,
literal|0
block|,
name|ngx_http_upstream_ignore_header_line
block|,
literal|0
block|,
literal|0
block|}
block|,
if|#
directive|if
operator|(
name|NGX_HTTP_GZIP
operator|)
block|{
name|ngx_string
argument_list|(
literal|"Content-Encoding"
argument_list|)
block|,
name|ngx_http_upstream_process_header_line
block|,
name|offsetof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|,
name|content_encoding
argument_list|)
block|,
name|ngx_http_upstream_copy_content_encoding
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|ngx_null_string
block|,
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_upstream_commands
specifier|static
name|ngx_command_t
name|ngx_http_upstream_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"upstream"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_BLOCK
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_upstream
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server"
argument_list|)
block|,
name|NGX_HTTP_UPS_CONF
operator||
name|NGX_CONF_1MORE
block|,
name|ngx_http_upstream_server
block|,
name|NGX_HTTP_SRV_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_upstream_module_ctx
specifier|static
name|ngx_http_module_t
name|ngx_http_upstream_module_ctx
init|=
block|{
name|ngx_http_upstream_add_variables
block|,
comment|/* preconfiguration */
name|NULL
block|,
comment|/* postconfiguration */
name|ngx_http_upstream_create_main_conf
block|,
comment|/* create main configuration */
name|ngx_http_upstream_init_main_conf
block|,
comment|/* init main configuration */
name|NULL
block|,
comment|/* create server configuration */
name|NULL
block|,
comment|/* merge server configuration */
name|NULL
block|,
comment|/* create location configuration */
name|NULL
comment|/* merge location configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_upstream_module
name|ngx_module_t
name|ngx_http_upstream_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_http_upstream_module_ctx
block|,
comment|/* module context */
name|ngx_http_upstream_commands
block|,
comment|/* module directives */
name|NGX_HTTP_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|NULL
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|NULL
block|,
comment|/* exit process */
name|NULL
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_upstream_vars
specifier|static
name|ngx_http_variable_t
name|ngx_http_upstream_vars
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"upstream_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_upstream_addr_variable
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOHASH
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"upstream_status"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_upstream_status_variable
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOHASH
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"upstream_response_time"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_upstream_response_time_variable
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOHASH
block|,
literal|0
block|}
block|,
block|{
name|ngx_null_string
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
DECL|function|ngx_http_upstream_init (ngx_http_request_t * r)
name|ngx_http_upstream_init
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|host
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_resolver_ctx_t
modifier|*
name|ctx
decl_stmt|,
name|temp
decl_stmt|;
name|ngx_http_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|ngx_http_upstream_srv_conf_t
modifier|*
name|uscf
decl_stmt|,
modifier|*
modifier|*
name|uscfp
decl_stmt|;
name|ngx_http_upstream_main_conf_t
modifier|*
name|umcf
decl_stmt|;
name|c
operator|=
name|r
operator|->
name|connection
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http init upstream, client timer: %d"
argument_list|,
name|c
operator|->
name|read
operator|->
name|timer_set
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|read
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|c
operator|->
name|read
argument_list|)
expr_stmt|;
block|}
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
operator|!
name|r
operator|->
name|post_action
operator|&&
operator|!
name|u
operator|->
name|conf
operator|->
name|ignore_client_abort
condition|)
block|{
name|r
operator|->
name|read_event_handler
operator|=
name|ngx_http_upstream_rd_check_broken_connection
expr_stmt|;
name|r
operator|->
name|write_event_handler
operator|=
name|ngx_http_upstream_wr_check_broken_connection
expr_stmt|;
block|}
if|if
condition|(
name|ngx_event_flags
operator|&
name|NGX_USE_CLEAR_EVENT
condition|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|write
operator|->
name|active
condition|)
block|{
if|if
condition|(
name|ngx_add_event
argument_list|(
name|c
operator|->
name|write
argument_list|,
name|NGX_WRITE_EVENT
argument_list|,
name|NGX_CLEAR_EVENT
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
if|if
condition|(
name|r
operator|->
name|request_body
condition|)
block|{
name|u
operator|->
name|request_bufs
operator|=
name|r
operator|->
name|request_body
operator|->
name|bufs
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|->
name|create_request
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|sendfile
operator|=
name|c
operator|->
name|sendfile
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|pool
operator|=
name|r
operator|->
name|pool
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|bufs
operator|.
name|num
operator|=
literal|1
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|bufs
operator|.
name|size
operator|=
name|clcf
operator|->
name|client_body_buffer_size
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|output_filter
operator|=
name|ngx_chain_writer
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|filter_ctx
operator|=
operator|&
name|u
operator|->
name|writer
expr_stmt|;
name|u
operator|->
name|writer
operator|.
name|pool
operator|=
name|r
operator|->
name|pool
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream_states
operator|==
name|NULL
condition|)
block|{
name|r
operator|->
name|upstream_states
operator|=
name|ngx_array_create
argument_list|(
name|r
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_state_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream_states
operator|==
name|NULL
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|u
operator|->
name|state
operator|=
name|ngx_array_push
argument_list|(
name|r
operator|->
name|upstream_states
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|state
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_memzero
argument_list|(
name|u
operator|->
name|state
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_state_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|cln
operator|=
name|ngx_http_cleanup_add
argument_list|(
name|r
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_upstream_cleanup
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|r
expr_stmt|;
name|u
operator|->
name|cleanup
operator|=
operator|&
name|cln
operator|->
name|handler
expr_stmt|;
name|u
operator|->
name|store
operator|=
operator|(
name|u
operator|->
name|conf
operator|->
name|store
operator|||
name|u
operator|->
name|conf
operator|->
name|store_lengths
operator|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|resolved
operator|==
name|NULL
condition|)
block|{
name|uscf
operator|=
name|u
operator|->
name|conf
operator|->
name|upstream
expr_stmt|;
block|}
else|else
block|{
name|host
operator|=
operator|&
name|r
operator|->
name|upstream
operator|->
name|resolved
operator|->
name|host
expr_stmt|;
name|umcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_upstream_module
argument_list|)
expr_stmt|;
name|uscfp
operator|=
name|umcf
operator|->
name|upstreams
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|umcf
operator|->
name|upstreams
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|uscf
operator|=
name|uscfp
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|uscf
operator|->
name|host
operator|.
name|len
operator|==
name|host
operator|->
name|len
operator|&&
name|ngx_memcmp
argument_list|(
name|uscf
operator|->
name|host
operator|.
name|data
argument_list|,
name|host
operator|->
name|data
argument_list|,
name|host
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
goto|goto
name|found
goto|;
block|}
block|}
name|temp
operator|.
name|name
operator|=
operator|*
name|host
expr_stmt|;
name|ctx
operator|=
name|ngx_resolve_start
argument_list|(
name|clcf
operator|->
name|resolver
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ctx
operator|==
name|NGX_NO_RESOLVER
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no resolver defined to resolve %V"
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_BAD_GATEWAY
argument_list|)
expr_stmt|;
return|return;
block|}
name|ctx
operator|->
name|name
operator|=
operator|*
name|host
expr_stmt|;
name|ctx
operator|->
name|type
operator|=
name|NGX_RESOLVE_A
expr_stmt|;
name|ctx
operator|->
name|handler
operator|=
name|ngx_http_upstream_resolve_handler
expr_stmt|;
name|ctx
operator|->
name|data
operator|=
name|r
expr_stmt|;
name|ctx
operator|->
name|timeout
operator|=
name|clcf
operator|->
name|resolver_timeout
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
if|if
condition|(
name|ngx_resolve_name
argument_list|(
name|ctx
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
name|found
label|:
if|if
condition|(
name|uscf
operator|->
name|peer
operator|.
name|init
argument_list|(
name|r
argument_list|,
name|uscf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_http_upstream_connect
argument_list|(
name|r
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_resolve_handler (ngx_resolver_ctx_t * ctx)
name|ngx_http_upstream_resolve_handler
parameter_list|(
name|ngx_resolver_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_resolved_t
modifier|*
name|ur
decl_stmt|;
name|r
operator|=
name|ctx
operator|->
name|data
expr_stmt|;
name|r
operator|->
name|upstream
operator|->
name|resolved
operator|->
name|ctx
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|state
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"%V could not be resolved (%i: %s)"
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|,
name|ctx
operator|->
name|state
argument_list|,
name|ngx_resolver_strerror
argument_list|(
name|ctx
operator|->
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_resolve_name_done
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_BAD_GATEWAY
argument_list|)
expr_stmt|;
return|return;
block|}
name|ur
operator|=
name|r
operator|->
name|upstream
operator|->
name|resolved
expr_stmt|;
name|ur
operator|->
name|naddrs
operator|=
name|ctx
operator|->
name|naddrs
expr_stmt|;
name|ur
operator|->
name|addrs
operator|=
name|ctx
operator|->
name|addrs
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
block|{
name|in_addr_t
name|addr
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|naddrs
condition|;
name|i
operator|++
control|)
block|{
name|addr
operator|=
name|ntohl
argument_list|(
name|ur
operator|->
name|addrs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"name was resolved to %ud.%ud.%ud.%ud"
argument_list|,
operator|(
name|addr
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|addr
operator|>>
literal|16
operator|)
operator|&
literal|0xff
argument_list|,
operator|(
name|addr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|,
name|addr
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|ngx_http_upstream_create_round_robin_peer
argument_list|(
name|r
argument_list|,
name|ur
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_resolve_name_done
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_resolve_name_done
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|ngx_http_upstream_connect
argument_list|(
name|r
argument_list|,
name|r
operator|->
name|upstream
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_rd_check_broken_connection (ngx_http_request_t * r)
name|ngx_http_upstream_rd_check_broken_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_upstream_check_broken_connection
argument_list|(
name|r
argument_list|,
name|r
operator|->
name|connection
operator|->
name|read
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_wr_check_broken_connection (ngx_http_request_t * r)
name|ngx_http_upstream_wr_check_broken_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_upstream_check_broken_connection
argument_list|(
name|r
argument_list|,
name|r
operator|->
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_check_broken_connection (ngx_http_request_t * r,ngx_event_t * ev)
name|ngx_http_upstream_check_broken_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|char
name|buf
index|[
literal|1
index|]
decl_stmt|;
name|ngx_err_t
name|err
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream check client, write event:%d, \"%V\""
argument_list|,
name|ev
operator|->
name|write
argument_list|,
operator|&
name|r
operator|->
name|uri
argument_list|)
expr_stmt|;
name|c
operator|=
name|r
operator|->
name|connection
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
if|#
directive|if
operator|(
name|NGX_HAVE_KQUEUE
operator|)
if|if
condition|(
name|ngx_event_flags
operator|&
name|NGX_USE_KQUEUE_EVENT
condition|)
block|{
if|if
condition|(
operator|!
name|ev
operator|->
name|pending_eof
condition|)
block|{
return|return;
block|}
name|ev
operator|->
name|eof
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|error
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|kq_errno
condition|)
block|{
name|ev
operator|->
name|error
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|u
operator|->
name|cacheable
operator|&&
operator|!
name|u
operator|->
name|store
operator|&&
name|u
operator|->
name|peer
operator|.
name|connection
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ev
operator|->
name|kq_errno
argument_list|,
literal|"kevent() reported that client closed prematurely "
literal|"connection, so upstream connection is closed too"
argument_list|)
expr_stmt|;
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|ev
operator|->
name|kq_errno
argument_list|,
literal|"kevent() reported that client closed "
literal|"prematurely connection"
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
endif|#
directive|endif
name|n
operator|=
name|recv
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|,
name|MSG_PEEK
argument_list|)
expr_stmt|;
name|err
operator|=
name|ngx_socket_errno
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"http upstream recv(): %d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
comment|/*      * we do not need to disable the write event because      * that event has NGX_USE_CLEAR_EVENT type      */
if|if
condition|(
name|ev
operator|->
name|write
operator|&&
operator|(
name|n
operator|>=
literal|0
operator|||
name|err
operator|==
name|NGX_EAGAIN
operator|)
condition|)
block|{
return|return;
block|}
if|if
condition|(
operator|(
name|ngx_event_flags
operator|&
name|NGX_USE_LEVEL_EVENT
operator|)
operator|&&
name|ev
operator|->
name|active
condition|)
block|{
if|if
condition|(
name|ngx_del_event
argument_list|(
name|ev
argument_list|,
name|NGX_READ_EVENT
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|err
operator|==
name|NGX_EAGAIN
condition|)
block|{
return|return;
block|}
name|ev
operator|->
name|error
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* n == 0 */
name|err
operator|=
literal|0
expr_stmt|;
block|}
name|ev
operator|->
name|eof
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|error
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|u
operator|->
name|cacheable
operator|&&
operator|!
name|u
operator|->
name|store
operator|&&
name|u
operator|->
name|peer
operator|.
name|connection
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"client closed prematurely connection, "
literal|"so upstream connection is closed too"
argument_list|)
expr_stmt|;
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|ev
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"client closed prematurely connection"
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_connect (ngx_http_request_t * r,ngx_http_upstream_t * u)
name|ngx_http_upstream_connect
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_time_t
modifier|*
name|tp
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|action
operator|=
literal|"connecting to upstream"
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|single_connection
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|state
operator|&&
name|u
operator|->
name|state
operator|->
name|response_sec
condition|)
block|{
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|response_sec
operator|=
name|tp
operator|->
name|sec
operator|-
name|u
operator|->
name|state
operator|->
name|response_sec
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|response_msec
operator|=
name|tp
operator|->
name|msec
operator|-
name|u
operator|->
name|state
operator|->
name|response_msec
expr_stmt|;
block|}
name|u
operator|->
name|state
operator|=
name|ngx_array_push
argument_list|(
name|r
operator|->
name|upstream_states
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|state
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_memzero
argument_list|(
name|u
operator|->
name|state
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_state_t
argument_list|)
argument_list|)
expr_stmt|;
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|response_sec
operator|=
name|tp
operator|->
name|sec
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|response_msec
operator|=
name|tp
operator|->
name|msec
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|peer
operator|=
name|u
operator|->
name|peer
operator|.
name|name
expr_stmt|;
name|rc
operator|=
name|ngx_event_connect_peer
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream connect: %i"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_BUSY
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no live upstreams"
argument_list|)
expr_stmt|;
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_NOLIVE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* rc == NGX_OK || rc == NGX_AGAIN */
name|c
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|c
operator|->
name|data
operator|=
name|r
expr_stmt|;
name|c
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_http_upstream_send_request_handler
expr_stmt|;
name|c
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_http_upstream_process_header
expr_stmt|;
name|c
operator|->
name|sendfile
operator|&=
name|r
operator|->
name|connection
operator|->
name|sendfile
expr_stmt|;
name|c
operator|->
name|pool
operator|=
name|r
operator|->
name|pool
expr_stmt|;
name|c
operator|->
name|read
operator|->
name|log
operator|=
name|c
operator|->
name|write
operator|->
name|log
operator|=
name|c
operator|->
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
comment|/* init or reinit the ngx_output_chain() and ngx_chain_writer() contexts */
name|u
operator|->
name|writer
operator|.
name|out
operator|=
name|NULL
expr_stmt|;
name|u
operator|->
name|writer
operator|.
name|last
operator|=
operator|&
name|u
operator|->
name|writer
operator|.
name|out
expr_stmt|;
name|u
operator|->
name|writer
operator|.
name|connection
operator|=
name|c
expr_stmt|;
name|u
operator|->
name|writer
operator|.
name|limit
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|request_sent
condition|)
block|{
if|if
condition|(
name|ngx_http_upstream_reinit
argument_list|(
name|r
argument_list|,
name|u
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|r
operator|->
name|request_body
operator|&&
name|r
operator|->
name|request_body
operator|->
name|buf
operator|&&
name|r
operator|->
name|request_body
operator|->
name|temp_file
operator|&&
name|r
operator|==
name|r
operator|->
expr|main
condition|)
block|{
comment|/*          * the r->request_body->buf can be reused for one request only,          * the subrequests should allocate their own temporay bufs          */
name|u
operator|->
name|output
operator|.
name|free
operator|=
name|ngx_alloc_chain_link
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|output
operator|.
name|free
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|output
operator|.
name|free
operator|->
name|buf
operator|=
name|r
operator|->
name|request_body
operator|->
name|buf
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|free
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|allocated
operator|=
literal|1
expr_stmt|;
name|r
operator|->
name|request_body
operator|->
name|buf
operator|->
name|pos
operator|=
name|r
operator|->
name|request_body
operator|->
name|buf
operator|->
name|start
expr_stmt|;
name|r
operator|->
name|request_body
operator|->
name|buf
operator|->
name|last
operator|=
name|r
operator|->
name|request_body
operator|->
name|buf
operator|->
name|start
expr_stmt|;
name|r
operator|->
name|request_body
operator|->
name|buf
operator|->
name|tag
operator|=
name|u
operator|->
name|output
operator|.
name|tag
expr_stmt|;
block|}
name|u
operator|->
name|request_sent
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|c
operator|->
name|write
argument_list|,
name|u
operator|->
name|conf
operator|->
name|connect_timeout
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
if|if
condition|(
name|u
operator|->
name|ssl
operator|&&
name|c
operator|->
name|ssl
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_ssl_init_connection
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
name|ngx_http_upstream_send_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
end_if

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_ssl_init_connection (ngx_http_request_t * r,ngx_http_upstream_t * u,ngx_connection_t * c)
name|ngx_http_upstream_ssl_init_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|,
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
if|if
condition|(
name|ngx_ssl_create_connection
argument_list|(
name|u
operator|->
name|conf
operator|->
name|ssl
argument_list|,
name|c
argument_list|,
name|NGX_SSL_BUFFER
operator||
name|NGX_SSL_CLIENT
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|sendfile
operator|=
literal|0
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|sendfile
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|set_session
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|,
name|u
operator|->
name|peer
operator|.
name|data
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|action
operator|=
literal|"SSL handshaking to upstream"
expr_stmt|;
name|rc
operator|=
name|ngx_ssl_handshake
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
name|c
operator|->
name|ssl
operator|->
name|handler
operator|=
name|ngx_http_upstream_ssl_handshake
expr_stmt|;
return|return;
block|}
name|ngx_http_upstream_ssl_handshake
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_ssl_handshake (ngx_connection_t * c)
name|ngx_http_upstream_ssl_handshake
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
block|{
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|r
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|ssl
operator|->
name|handshaked
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|save_session
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|,
name|u
operator|->
name|peer
operator|.
name|data
argument_list|)
expr_stmt|;
name|c
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_http_upstream_send_request_handler
expr_stmt|;
name|c
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_http_upstream_process_header
expr_stmt|;
name|ngx_http_upstream_send_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_ERROR
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_reinit (ngx_http_request_t * r,ngx_http_upstream_t * u)
name|ngx_http_upstream_reinit
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
block|{
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|;
if|if
condition|(
name|u
operator|->
name|reinit_request
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_headers_in_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_list_init
argument_list|(
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|headers
argument_list|,
name|r
operator|->
name|pool
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_table_elt_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
comment|/* reinit the request chain */
for|for
control|(
name|cl
operator|=
name|u
operator|->
name|request_bufs
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|cl
operator|->
name|buf
operator|->
name|pos
operator|=
name|cl
operator|->
name|buf
operator|->
name|start
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|file_pos
operator|=
literal|0
expr_stmt|;
block|}
comment|/* reinit the subrequest's ngx_output_chain() context */
if|if
condition|(
name|r
operator|->
name|request_body
operator|&&
name|r
operator|->
name|request_body
operator|->
name|temp_file
operator|&&
name|r
operator|!=
name|r
operator|->
expr|main
operator|&&
name|u
operator|->
name|output
operator|.
name|buf
condition|)
block|{
name|u
operator|->
name|output
operator|.
name|free
operator|=
name|ngx_alloc_chain_link
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|output
operator|.
name|free
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|u
operator|->
name|output
operator|.
name|free
operator|->
name|buf
operator|=
name|u
operator|->
name|output
operator|.
name|buf
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|free
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|buf
operator|->
name|pos
operator|=
name|u
operator|->
name|output
operator|.
name|buf
operator|->
name|start
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|buf
operator|->
name|last
operator|=
name|u
operator|->
name|output
operator|.
name|buf
operator|->
name|start
expr_stmt|;
block|}
name|u
operator|->
name|output
operator|.
name|buf
operator|=
name|NULL
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|in
operator|=
name|NULL
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|busy
operator|=
name|NULL
expr_stmt|;
comment|/* reinit u->buffer */
if|#
directive|if
literal|0
block_content|if (u->cache) {         u->buffer.pos = u->buffer.start + u->cache->ctx.header_size;         u->buffer.last = u->buffer.pos;      } else {         u->buffer.pos = u->buffer.start;         u->buffer.last = u->buffer.start;     }
else|#
directive|else
name|u
operator|->
name|buffer
operator|.
name|pos
operator|=
name|u
operator|->
name|buffer
operator|.
name|start
expr_stmt|;
name|u
operator|->
name|buffer
operator|.
name|last
operator|=
name|u
operator|->
name|buffer
operator|.
name|start
expr_stmt|;
endif|#
directive|endif
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_send_request (ngx_http_request_t * r,ngx_http_upstream_t * u)
name|ngx_http_upstream_send_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream send request"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|u
operator|->
name|request_sent
operator|&&
name|ngx_http_upstream_test_connect
argument_list|(
name|c
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"sending request to upstream"
expr_stmt|;
name|rc
operator|=
name|ngx_output_chain
argument_list|(
operator|&
name|u
operator|->
name|output
argument_list|,
name|u
operator|->
name|request_sent
condition|?
name|NULL
else|:
name|u
operator|->
name|request_bufs
argument_list|)
expr_stmt|;
name|u
operator|->
name|request_sent
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|c
operator|->
name|write
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|c
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|c
operator|->
name|write
argument_list|,
name|u
operator|->
name|conf
operator|->
name|send_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|c
operator|->
name|write
argument_list|,
name|u
operator|->
name|conf
operator|->
name|send_lowat
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
comment|/* rc == NGX_OK */
if|if
condition|(
name|c
operator|->
name|tcp_nopush
operator|==
name|NGX_TCP_NOPUSH_SET
condition|)
block|{
if|if
condition|(
name|ngx_tcp_push
argument_list|(
name|c
operator|->
name|fd
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
name|ngx_tcp_push_n
literal|" failed"
argument_list|)
expr_stmt|;
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|tcp_nopush
operator|=
name|NGX_TCP_NOPUSH_UNSET
expr_stmt|;
block|}
name|ngx_add_timer
argument_list|(
name|c
operator|->
name|read
argument_list|,
name|u
operator|->
name|conf
operator|->
name|read_timeout
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
if|if
condition|(
name|c
operator|->
name|read
operator|->
name|ready
condition|)
block|{
comment|/* post aio operation */
comment|/*          * TODO comment          * although we can post aio operation just in the end          * of ngx_http_upstream_connect() CHECK IT !!!          * it's better to do here because we postpone header buffer allocation          */
name|ngx_http_upstream_process_header
argument_list|(
name|c
operator|->
name|read
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
name|c
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_http_upstream_dummy_handler
expr_stmt|;
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|c
operator|->
name|write
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_send_request_handler (ngx_event_t * wev)
name|ngx_http_upstream_send_request_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|c
operator|=
name|wev
operator|->
name|data
expr_stmt|;
name|r
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|wev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream send request handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timedout
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_TIMEOUT
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
if|if
condition|(
name|u
operator|->
name|ssl
operator|&&
name|c
operator|->
name|ssl
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_ssl_init_connection
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
if|if
condition|(
name|u
operator|->
name|header_sent
condition|)
block|{
name|wev
operator|->
name|handler
operator|=
name|ngx_http_upstream_dummy_handler
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_handle_write_event
argument_list|(
name|wev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_http_upstream_send_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_process_header (ngx_event_t * rev)
name|ngx_http_upstream_process_header
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ssize_t
name|n
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_str_t
modifier|*
name|uri
decl_stmt|,
name|args
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|flags
decl_stmt|;
name|ngx_list_part_t
modifier|*
name|part
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_http_err_page_t
modifier|*
name|err_page
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|ngx_http_upstream_header_t
modifier|*
name|hh
decl_stmt|;
name|ngx_http_upstream_main_conf_t
modifier|*
name|umcf
decl_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|r
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream process header"
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"reading response header from upstream"
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|timedout
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_TIMEOUT
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|u
operator|->
name|request_sent
operator|&&
name|ngx_http_upstream_test_connect
argument_list|(
name|c
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|buffer
operator|.
name|start
operator|==
name|NULL
condition|)
block|{
name|u
operator|->
name|buffer
operator|.
name|start
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|u
operator|->
name|conf
operator|->
name|buffer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|buffer
operator|.
name|start
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|buffer
operator|.
name|pos
operator|=
name|u
operator|->
name|buffer
operator|.
name|start
expr_stmt|;
name|u
operator|->
name|buffer
operator|.
name|last
operator|=
name|u
operator|->
name|buffer
operator|.
name|start
expr_stmt|;
name|u
operator|->
name|buffer
operator|.
name|end
operator|=
name|u
operator|->
name|buffer
operator|.
name|start
operator|+
name|u
operator|->
name|conf
operator|->
name|buffer_size
expr_stmt|;
name|u
operator|->
name|buffer
operator|.
name|temporary
operator|=
literal|1
expr_stmt|;
name|u
operator|->
name|buffer
operator|.
name|tag
operator|=
name|u
operator|->
name|output
operator|.
name|tag
expr_stmt|;
if|if
condition|(
name|ngx_list_init
argument_list|(
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|headers
argument_list|,
name|r
operator|->
name|pool
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_table_elt_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
literal|0
block_content|if (u->cache) {             u->buffer.pos += u->cache->ctx.header_size;             u->buffer.last = u->buffer.pos;         }
endif|#
directive|endif
block|}
name|n
operator|=
name|c
operator|->
name|recv
argument_list|(
name|c
argument_list|,
name|u
operator|->
name|buffer
operator|.
name|last
argument_list|,
name|u
operator|->
name|buffer
operator|.
name|end
operator|-
name|u
operator|->
name|buffer
operator|.
name|last
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
if|#
directive|if
literal|0
block_content|ngx_add_timer(rev, u->read_timeout);
endif|#
directive|endif
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream prematurely closed connection"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
operator|||
name|n
operator|==
literal|0
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|buffer
operator|.
name|last
operator|+=
name|n
expr_stmt|;
if|#
directive|if
literal|0
block_content|u->valid_header_in = 0;      u->peer.cached = 0;
endif|#
directive|endif
name|rc
operator|=
name|u
operator|->
name|process_header
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
if|#
directive|if
literal|0
block_content|ngx_add_timer(rev, u->read_timeout);
endif|#
directive|endif
if|if
condition|(
name|u
operator|->
name|buffer
operator|.
name|pos
operator|==
name|u
operator|->
name|buffer
operator|.
name|end
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too big header"
argument_list|)
expr_stmt|;
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|==
name|NGX_HTTP_INTERNAL_SERVER_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* rc == NGX_OK */
if|if
condition|(
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|>=
name|NGX_HTTP_BAD_REQUEST
operator|&&
name|r
operator|->
name|subrequest_in_memory
condition|)
block|{
name|u
operator|->
name|buffer
operator|.
name|last
operator|=
name|u
operator|->
name|buffer
operator|.
name|pos
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|==
name|NGX_HTTP_INTERNAL_SERVER_ERROR
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|tries
operator|>
literal|1
operator|&&
operator|(
name|u
operator|->
name|conf
operator|->
name|next_upstream
operator|&
name|NGX_HTTP_UPSTREAM_FT_HTTP_500
operator|)
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_500
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
operator|(
name|NGX_HTTP_CACHE
operator|)
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|tries
operator|==
literal|0
operator|&&
name|u
operator|->
name|stale
operator|&&
operator|(
name|u
operator|->
name|conf
operator|->
name|use_stale
operator|&
name|NGX_HTTP_UPSTREAM_FT_HTTP_500
operator|)
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|ngx_http_send_cached_response
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|==
name|NGX_HTTP_NOT_FOUND
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|tries
operator|>
literal|1
operator|&&
name|u
operator|->
name|conf
operator|->
name|next_upstream
operator|&
name|NGX_HTTP_UPSTREAM_FT_HTTP_404
condition|)
block|{
name|ngx_http_upstream_next
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_404
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|conf
operator|->
name|intercept_404
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_NOT_FOUND
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|>=
name|NGX_HTTP_BAD_REQUEST
operator|&&
name|u
operator|->
name|conf
operator|->
name|intercept_errors
condition|)
block|{
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|clcf
operator|->
name|error_pages
condition|)
block|{
name|err_page
operator|=
name|clcf
operator|->
name|error_pages
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|clcf
operator|->
name|error_pages
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|err_page
index|[
name|i
index|]
operator|.
name|status
operator|==
operator|(
name|ngx_int_t
operator|)
name|u
operator|->
name|headers_in
operator|.
name|status_n
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|==
name|NGX_HTTP_UNAUTHORIZED
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|www_authenticate
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|www_authenticate
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
name|r
operator|->
name|headers_out
operator|.
name|www_authenticate
operator|=
operator|*
name|u
operator|->
name|headers_in
operator|.
name|www_authenticate
expr_stmt|;
block|}
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|u
operator|->
name|headers_in
operator|.
name|status_n
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
block|}
name|umcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_upstream_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|x_accel_redirect
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_DECLINED
argument_list|)
expr_stmt|;
name|part
operator|=
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
expr_stmt|;
name|h
operator|=
name|part
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
comment|/* void */
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|part
operator|->
name|nelts
condition|)
block|{
if|if
condition|(
name|part
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|part
operator|=
name|part
operator|->
name|next
expr_stmt|;
name|h
operator|=
name|part
operator|->
name|elts
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
name|hh
operator|=
name|ngx_hash_find
argument_list|(
operator|&
name|umcf
operator|->
name|headers_in_hash
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|hash
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|lowcase_key
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hh
operator|&&
name|hh
operator|->
name|redirect
condition|)
block|{
if|if
condition|(
name|hh
operator|->
name|copy_handler
argument_list|(
name|r
argument_list|,
operator|&
name|h
index|[
name|i
index|]
argument_list|,
name|hh
operator|->
name|conf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
name|uri
operator|=
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|x_accel_redirect
operator|->
name|value
expr_stmt|;
name|args
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|args
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ngx_http_parse_unsafe_uri
argument_list|(
name|r
argument_list|,
name|uri
argument_list|,
operator|&
name|args
argument_list|,
operator|&
name|flags
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_NOT_FOUND
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|flags
operator|&
name|NGX_HTTP_ZERO_IN_URI
condition|)
block|{
name|r
operator|->
name|zero_in_uri
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|method
operator|!=
name|NGX_HTTP_HEAD
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_GET
expr_stmt|;
block|}
name|ngx_http_internal_redirect
argument_list|(
name|r
argument_list|,
name|uri
argument_list|,
operator|&
name|args
argument_list|)
expr_stmt|;
return|return;
block|}
name|part
operator|=
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
expr_stmt|;
name|h
operator|=
name|part
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
comment|/* void */
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|part
operator|->
name|nelts
condition|)
block|{
if|if
condition|(
name|part
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|part
operator|=
name|part
operator|->
name|next
expr_stmt|;
name|h
operator|=
name|part
operator|->
name|elts
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ngx_hash_find
argument_list|(
operator|&
name|u
operator|->
name|conf
operator|->
name|hide_headers_hash
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|hash
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|lowcase_key
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|hh
operator|=
name|ngx_hash_find
argument_list|(
operator|&
name|umcf
operator|->
name|headers_in_hash
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|hash
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|lowcase_key
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hh
condition|)
block|{
if|if
condition|(
name|hh
operator|->
name|copy_handler
argument_list|(
name|r
argument_list|,
operator|&
name|h
index|[
name|i
index|]
argument_list|,
name|hh
operator|->
name|conf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_http_upstream_copy_header_line
argument_list|(
name|r
argument_list|,
operator|&
name|h
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|server
operator|&&
name|r
operator|->
name|headers_out
operator|.
name|server
operator|->
name|value
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|server
operator|->
name|hash
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|date
operator|&&
name|r
operator|->
name|headers_out
operator|.
name|date
operator|->
name|value
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|date
operator|->
name|hash
operator|=
literal|0
expr_stmt|;
block|}
name|r
operator|->
name|headers_out
operator|.
name|status
operator|=
name|u
operator|->
name|headers_in
operator|.
name|status_n
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|status_line
operator|=
name|u
operator|->
name|headers_in
operator|.
name|status_line
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|content_length_n
operator|!=
operator|-
literal|1
condition|)
block|{
name|u
operator|->
name|length
operator|=
operator|(
name|size_t
operator|)
name|r
operator|->
name|headers_out
operator|.
name|content_length_n
expr_stmt|;
block|}
else|else
block|{
name|u
operator|->
name|length
operator|=
name|NGX_MAX_SIZE_T_VALUE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|r
operator|->
name|subrequest_in_memory
condition|)
block|{
name|ngx_http_upstream_send_response
argument_list|(
name|r
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* subrequest content in memory */
if|if
condition|(
name|u
operator|->
name|input_filter
operator|==
name|NULL
condition|)
block|{
name|u
operator|->
name|input_filter_init
operator|=
name|ngx_http_upstream_non_buffered_filter_init
expr_stmt|;
name|u
operator|->
name|input_filter
operator|=
name|ngx_http_upstream_non_buffered_filter
expr_stmt|;
name|u
operator|->
name|input_filter_ctx
operator|=
name|r
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|->
name|input_filter_init
argument_list|(
name|u
operator|->
name|input_filter_ctx
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|buffer
operator|.
name|last
operator|-
name|u
operator|->
name|buffer
operator|.
name|pos
operator|>=
operator|(
name|ssize_t
operator|)
name|u
operator|->
name|length
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|input_filter
argument_list|(
name|u
operator|->
name|input_filter_ctx
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|rev
operator|->
name|handler
operator|=
name|ngx_http_upstream_process_body_in_memory
expr_stmt|;
name|ngx_http_upstream_process_body_in_memory
argument_list|(
name|rev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_test_connect (ngx_connection_t * c)
name|ngx_http_upstream_test_connect
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|socklen_t
name|len
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_KQUEUE
operator|)
if|if
condition|(
name|ngx_event_flags
operator|&
name|NGX_USE_KQUEUE_EVENT
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|write
operator|->
name|pending_eof
condition|)
block|{
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"connecting to upstream"
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|write
operator|->
name|kq_errno
argument_list|,
literal|"kevent() reported that connect() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
else|else
endif|#
directive|endif
block|{
name|err
operator|=
literal|0
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
comment|/*          * BSDs and Linux return 0 and set a pending error in err          * Solaris returns -1 and sets errno          */
if|if
condition|(
name|getsockopt
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_ERROR
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|err
argument_list|,
operator|&
name|len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|err
operator|=
name|ngx_errno
expr_stmt|;
block|}
if|if
condition|(
name|err
condition|)
block|{
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"connecting to upstream"
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|err
argument_list|,
literal|"connect() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_process_body_in_memory (ngx_event_t * rev)
name|ngx_http_upstream_process_body_in_memory
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|r
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream process body on memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|timedout
condition|)
block|{
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"upstream timed out"
argument_list|)
expr_stmt|;
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_ETIMEDOUT
argument_list|)
expr_stmt|;
return|return;
block|}
name|b
operator|=
operator|&
name|u
operator|->
name|buffer
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|size
operator|=
name|b
operator|->
name|end
operator|-
name|b
operator|->
name|last
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream buffer is too small to read repsonse"
argument_list|)
expr_stmt|;
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|n
operator|=
name|c
operator|->
name|recv
argument_list|(
name|c
argument_list|,
name|b
operator|->
name|last
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|n
operator|==
literal|0
operator|||
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|input_filter
argument_list|(
name|u
operator|->
name|input_filter_ctx
argument_list|,
name|n
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|rev
operator|->
name|ready
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rev
operator|->
name|active
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|rev
argument_list|,
name|u
operator|->
name|conf
operator|->
name|read_timeout
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|rev
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|rev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_send_response (ngx_http_request_t * r,ngx_http_upstream_t * u)
name|ngx_http_upstream_send_response
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
block|{
name|int
name|tcp_nodelay
decl_stmt|;
name|ssize_t
name|size
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_event_pipe_t
modifier|*
name|p
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cl
decl_stmt|;
name|ngx_pool_cleanup_file_t
modifier|*
name|clf
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|rc
operator|=
name|ngx_http_send_header
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|>
name|NGX_OK
operator|||
name|r
operator|->
name|post_action
operator|||
name|r
operator|->
name|header_only
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
name|u
operator|->
name|header_sent
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|request_body
operator|&&
name|r
operator|->
name|request_body
operator|->
name|temp_file
condition|)
block|{
for|for
control|(
name|cl
operator|=
name|r
operator|->
name|pool
operator|->
name|cleanup
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cl
operator|->
name|handler
operator|==
name|ngx_pool_cleanup_file
condition|)
block|{
name|clf
operator|=
name|cl
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|clf
operator|->
name|fd
operator|==
name|r
operator|->
name|request_body
operator|->
name|temp_file
operator|->
name|file
operator|.
name|fd
condition|)
block|{
name|cl
operator|->
name|handler
argument_list|(
name|clf
argument_list|)
expr_stmt|;
name|cl
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|r
operator|->
name|request_body
operator|->
name|temp_file
operator|->
name|file
operator|.
name|fd
operator|=
name|NGX_INVALID_FILE
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
name|c
operator|=
name|r
operator|->
name|connection
expr_stmt|;
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|u
operator|->
name|buffering
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|input_filter
operator|==
name|NULL
condition|)
block|{
name|u
operator|->
name|input_filter_init
operator|=
name|ngx_http_upstream_non_buffered_filter_init
expr_stmt|;
name|u
operator|->
name|input_filter
operator|=
name|ngx_http_upstream_non_buffered_filter
expr_stmt|;
name|u
operator|->
name|input_filter_ctx
operator|=
name|r
expr_stmt|;
block|}
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_http_upstream_process_non_buffered_body
expr_stmt|;
name|r
operator|->
name|write_event_handler
operator|=
name|ngx_http_upstream_process_non_buffered_downstream
expr_stmt|;
name|r
operator|->
name|limit_rate
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|input_filter_init
argument_list|(
name|u
operator|->
name|input_filter_ctx
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|clcf
operator|->
name|tcp_nodelay
operator|&&
name|c
operator|->
name|tcp_nodelay
operator|==
name|NGX_TCP_NODELAY_UNSET
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"tcp_nodelay"
argument_list|)
expr_stmt|;
name|tcp_nodelay
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_NODELAY
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|tcp_nodelay
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"setsockopt(TCP_NODELAY) failed"
argument_list|)
expr_stmt|;
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|tcp_nodelay
operator|=
name|NGX_TCP_NODELAY_SET
expr_stmt|;
block|}
name|size
operator|=
name|u
operator|->
name|buffer
operator|.
name|last
operator|-
name|u
operator|->
name|buffer
operator|.
name|pos
expr_stmt|;
if|if
condition|(
name|size
condition|)
block|{
name|u
operator|->
name|buffer
operator|.
name|last
operator|=
name|u
operator|->
name|buffer
operator|.
name|pos
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|input_filter
argument_list|(
name|u
operator|->
name|input_filter_ctx
argument_list|,
name|size
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_http_upstream_process_non_buffered_body
argument_list|(
name|c
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u
operator|->
name|buffer
operator|.
name|pos
operator|=
name|u
operator|->
name|buffer
operator|.
name|start
expr_stmt|;
name|u
operator|->
name|buffer
operator|.
name|last
operator|=
name|u
operator|->
name|buffer
operator|.
name|start
expr_stmt|;
if|if
condition|(
name|ngx_http_send_special
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_FLUSH
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
operator|->
name|ready
condition|)
block|{
name|ngx_http_upstream_process_non_buffered_body
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
comment|/* TODO: preallocate event_pipe bufs, look "Content-Length" */
if|#
directive|if
literal|0
block_content|if (u->cache&& u->cache->ctx.file.fd != NGX_INVALID_FILE) {         if (ngx_close_file(u->cache->ctx.file.fd) == NGX_FILE_ERROR) {             ngx_log_error(NGX_LOG_ALERT, c->log, ngx_errno,                           ngx_close_file_n " \"%s\" failed",                           u->cache->ctx.file.name.data);         }     }      if (u->cacheable) {         header = (ngx_http_cache_header_t *) u->buffer->start;          header->expires = u->cache->ctx.expires;         header->last_modified = u->cache->ctx.last_modified;         header->date = u->cache->ctx.date;         header->length = r->headers_out.content_length_n;         u->cache->ctx.length = r->headers_out.content_length_n;          header->key_len = u->cache->ctx.key0.len;         ngx_memcpy(&header->key, u->cache->ctx.key0.data, header->key_len);         header->key[header->key_len] = LF;     }
endif|#
directive|endif
name|p
operator|=
name|u
operator|->
name|pipe
expr_stmt|;
name|p
operator|->
name|output_filter
operator|=
operator|(
name|ngx_event_pipe_output_filter_pt
operator|)
name|ngx_http_output_filter
expr_stmt|;
name|p
operator|->
name|output_ctx
operator|=
name|r
expr_stmt|;
name|p
operator|->
name|tag
operator|=
name|u
operator|->
name|output
operator|.
name|tag
expr_stmt|;
name|p
operator|->
name|bufs
operator|=
name|u
operator|->
name|conf
operator|->
name|bufs
expr_stmt|;
name|p
operator|->
name|busy_size
operator|=
name|u
operator|->
name|conf
operator|->
name|busy_buffers_size
expr_stmt|;
name|p
operator|->
name|upstream
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|p
operator|->
name|downstream
operator|=
name|c
expr_stmt|;
name|p
operator|->
name|pool
operator|=
name|r
operator|->
name|pool
expr_stmt|;
name|p
operator|->
name|log
operator|=
name|c
operator|->
name|log
expr_stmt|;
name|p
operator|->
name|cacheable
operator|=
name|u
operator|->
name|cacheable
operator|||
name|u
operator|->
name|store
expr_stmt|;
name|p
operator|->
name|temp_file
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_temp_file_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|temp_file
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|->
name|temp_file
operator|->
name|file
operator|.
name|fd
operator|=
name|NGX_INVALID_FILE
expr_stmt|;
name|p
operator|->
name|temp_file
operator|->
name|file
operator|.
name|log
operator|=
name|c
operator|->
name|log
expr_stmt|;
name|p
operator|->
name|temp_file
operator|->
name|path
operator|=
name|u
operator|->
name|conf
operator|->
name|temp_path
expr_stmt|;
name|p
operator|->
name|temp_file
operator|->
name|pool
operator|=
name|r
operator|->
name|pool
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|cacheable
operator|||
name|u
operator|->
name|store
condition|)
block|{
name|p
operator|->
name|temp_file
operator|->
name|persistent
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|temp_file
operator|->
name|log_level
operator|=
name|NGX_LOG_WARN
expr_stmt|;
name|p
operator|->
name|temp_file
operator|->
name|warn
operator|=
literal|"an upstream response is buffered "
literal|"to a temporary file"
expr_stmt|;
block|}
name|p
operator|->
name|max_temp_file_size
operator|=
name|u
operator|->
name|conf
operator|->
name|max_temp_file_size
expr_stmt|;
name|p
operator|->
name|temp_file_write_size
operator|=
name|u
operator|->
name|conf
operator|->
name|temp_file_write_size
expr_stmt|;
name|p
operator|->
name|preread_bufs
operator|=
name|ngx_alloc_chain_link
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|preread_bufs
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|->
name|preread_bufs
operator|->
name|buf
operator|=
operator|&
name|u
operator|->
name|buffer
expr_stmt|;
name|p
operator|->
name|preread_bufs
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|u
operator|->
name|buffer
operator|.
name|recycled
operator|=
literal|1
expr_stmt|;
name|p
operator|->
name|preread_size
operator|=
name|u
operator|->
name|buffer
operator|.
name|last
operator|-
name|u
operator|->
name|buffer
operator|.
name|pos
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|cacheable
condition|)
block|{
name|p
operator|->
name|buf_to_file
operator|=
name|ngx_calloc_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|buf_to_file
operator|==
name|NULL
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|->
name|buf_to_file
operator|->
name|pos
operator|=
name|u
operator|->
name|buffer
operator|.
name|start
expr_stmt|;
name|p
operator|->
name|buf_to_file
operator|->
name|last
operator|=
name|u
operator|->
name|buffer
operator|.
name|pos
expr_stmt|;
name|p
operator|->
name|buf_to_file
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ngx_event_flags
operator|&
name|NGX_USE_AIO_EVENT
condition|)
block|{
comment|/* the posted aio operation may currupt a shadow buffer */
name|p
operator|->
name|single_buf
operator|=
literal|1
expr_stmt|;
block|}
comment|/* TODO: p->free_bufs = 0 if use ngx_create_chain_of_bufs() */
name|p
operator|->
name|free_bufs
operator|=
literal|1
expr_stmt|;
comment|/*      * event_pipe would do u->buffer.last += p->preread_size      * as though these bytes were read      */
name|u
operator|->
name|buffer
operator|.
name|last
operator|=
name|u
operator|->
name|buffer
operator|.
name|pos
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|conf
operator|->
name|cyclic_temp_file
condition|)
block|{
comment|/*          * we need to disable the use of sendfile() if we use cyclic temp file          * because the writing a new data may interfere with sendfile()          * that uses the same kernel file pages (at least on FreeBSD)          */
name|p
operator|->
name|cyclic_temp_file
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|sendfile
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|cyclic_temp_file
operator|=
literal|0
expr_stmt|;
block|}
name|p
operator|->
name|read_timeout
operator|=
name|u
operator|->
name|conf
operator|->
name|read_timeout
expr_stmt|;
name|p
operator|->
name|send_timeout
operator|=
name|clcf
operator|->
name|send_timeout
expr_stmt|;
name|p
operator|->
name|send_lowat
operator|=
name|clcf
operator|->
name|send_lowat
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_http_upstream_process_body
expr_stmt|;
name|r
operator|->
name|write_event_handler
operator|=
name|ngx_http_upstream_process_downstream
expr_stmt|;
name|ngx_http_upstream_process_body
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_process_non_buffered_downstream (ngx_http_request_t * r)
name|ngx_http_upstream_process_non_buffered_downstream
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_upstream_process_non_buffered_body
argument_list|(
name|r
operator|->
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_process_non_buffered_body (ngx_event_t * ev)
name|ngx_http_upstream_process_non_buffered_body
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|do_write
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|,
modifier|*
name|downstream
decl_stmt|,
modifier|*
name|upstream
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|c
operator|=
name|ev
operator|->
name|data
expr_stmt|;
name|r
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|write
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream process non buffered downstream"
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"sending to client"
expr_stmt|;
block|}
else|else
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream process non buffered upstream"
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"reading upstream"
expr_stmt|;
block|}
if|if
condition|(
name|ev
operator|->
name|timedout
condition|)
block|{
if|if
condition|(
name|ev
operator|->
name|write
condition|)
block|{
name|c
operator|->
name|timedout
operator|=
literal|1
expr_stmt|;
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"client timed out"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"upstream timed out"
argument_list|)
expr_stmt|;
block|}
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|downstream
operator|=
name|r
operator|->
name|connection
expr_stmt|;
name|upstream
operator|=
name|u
operator|->
name|peer
operator|.
name|connection
expr_stmt|;
name|b
operator|=
operator|&
name|u
operator|->
name|buffer
expr_stmt|;
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|do_write
operator|=
name|ev
operator|->
name|write
operator|||
name|u
operator|->
name|length
operator|==
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|do_write
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|out_bufs
operator|||
name|u
operator|->
name|busy_bufs
condition|)
block|{
name|rc
operator|=
name|ngx_http_output_filter
argument_list|(
name|r
argument_list|,
name|u
operator|->
name|out_bufs
argument_list|)
expr_stmt|;
if|if
condition|(
name|downstream
operator|->
name|destroyed
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_chain_update_chains
argument_list|(
operator|&
name|u
operator|->
name|free_bufs
argument_list|,
operator|&
name|u
operator|->
name|busy_bufs
argument_list|,
operator|&
name|u
operator|->
name|out_bufs
argument_list|,
name|u
operator|->
name|output
operator|.
name|tag
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|->
name|busy_bufs
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|length
operator|==
literal|0
operator|||
name|upstream
operator|->
name|read
operator|->
name|eof
operator|||
name|upstream
operator|->
name|read
operator|->
name|error
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|start
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|b
operator|->
name|start
expr_stmt|;
block|}
block|}
name|size
operator|=
name|b
operator|->
name|end
operator|-
name|b
operator|->
name|last
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|u
operator|->
name|length
condition|)
block|{
name|size
operator|=
name|u
operator|->
name|length
expr_stmt|;
block|}
if|if
condition|(
name|size
operator|&&
name|upstream
operator|->
name|read
operator|->
name|ready
condition|)
block|{
name|n
operator|=
name|upstream
operator|->
name|recv
argument_list|(
name|upstream
argument_list|,
name|b
operator|->
name|last
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|input_filter
argument_list|(
name|u
operator|->
name|input_filter_ctx
argument_list|,
name|n
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|do_write
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
if|if
condition|(
name|downstream
operator|->
name|data
operator|==
name|r
condition|)
block|{
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|downstream
operator|->
name|write
argument_list|,
name|clcf
operator|->
name|send_lowat
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|downstream
operator|->
name|write
operator|->
name|active
operator|&&
operator|!
name|downstream
operator|->
name|write
operator|->
name|ready
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|downstream
operator|->
name|write
argument_list|,
name|clcf
operator|->
name|send_timeout
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|downstream
operator|->
name|write
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|downstream
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|upstream
operator|->
name|read
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|upstream
operator|->
name|read
operator|->
name|active
operator|&&
operator|!
name|upstream
operator|->
name|read
operator|->
name|ready
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|upstream
operator|->
name|read
argument_list|,
name|u
operator|->
name|conf
operator|->
name|read_timeout
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|upstream
operator|->
name|read
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|upstream
operator|->
name|read
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_non_buffered_filter_init (void * data)
name|ngx_http_upstream_non_buffered_filter_init
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_non_buffered_filter (void * data,ssize_t bytes)
name|ngx_http_upstream_non_buffered_filter
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|ssize_t
name|bytes
parameter_list|)
block|{
name|ngx_http_request_t
modifier|*
name|r
init|=
name|data
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|,
modifier|*
modifier|*
name|ll
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
for|for
control|(
name|cl
operator|=
name|u
operator|->
name|out_bufs
operator|,
name|ll
operator|=
operator|&
name|u
operator|->
name|out_bufs
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
block|}
name|cl
operator|=
name|ngx_chain_get_free_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|&
name|u
operator|->
name|free_bufs
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ll
operator|=
name|cl
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|flush
operator|=
literal|1
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|memory
operator|=
literal|1
expr_stmt|;
name|b
operator|=
operator|&
name|u
operator|->
name|buffer
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
name|b
operator|->
name|last
operator|+=
name|bytes
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|last
operator|=
name|b
operator|->
name|last
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|length
operator|==
name|NGX_MAX_SIZE_T_VALUE
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|u
operator|->
name|length
operator|-=
name|bytes
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_process_downstream (ngx_http_request_t * r)
name|ngx_http_upstream_process_downstream
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_upstream_process_body
argument_list|(
name|r
operator|->
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_process_body (ngx_event_t * ev)
name|ngx_http_upstream_process_body
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_event_pipe_t
modifier|*
name|p
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|,
modifier|*
name|downstream
decl_stmt|;
name|ngx_http_log_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|c
operator|=
name|ev
operator|->
name|data
expr_stmt|;
name|r
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
name|downstream
operator|=
name|r
operator|->
name|connection
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|write
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream process downstream"
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"sending to client"
expr_stmt|;
block|}
else|else
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream process upstream"
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"reading upstream"
expr_stmt|;
name|ctx
operator|=
name|c
operator|->
name|log
operator|->
name|data
expr_stmt|;
name|ctx
operator|->
name|current_request
operator|=
name|r
expr_stmt|;
block|}
name|p
operator|=
name|u
operator|->
name|pipe
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|timedout
condition|)
block|{
if|if
condition|(
name|ev
operator|->
name|write
condition|)
block|{
if|if
condition|(
name|ev
operator|->
name|delayed
condition|)
block|{
name|ev
operator|->
name|timedout
operator|=
literal|0
expr_stmt|;
name|ev
operator|->
name|delayed
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|ev
operator|->
name|ready
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|ev
argument_list|,
name|p
operator|->
name|send_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|ev
argument_list|,
name|p
operator|->
name|send_lowat
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
block|}
if|if
condition|(
name|ngx_event_pipe
argument_list|(
name|p
argument_list|,
name|ev
operator|->
name|write
argument_list|)
operator|==
name|NGX_ABORT
condition|)
block|{
if|if
condition|(
name|downstream
operator|->
name|destroyed
condition|)
block|{
return|return;
block|}
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|p
operator|->
name|downstream_error
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|timedout
operator|=
literal|1
expr_stmt|;
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"client timed out"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|p
operator|->
name|upstream_error
operator|=
literal|1
expr_stmt|;
name|ngx_connection_error
argument_list|(
name|c
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"upstream timed out"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ev
operator|->
name|write
operator|&&
name|ev
operator|->
name|delayed
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http downstream delayed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|ev
argument_list|,
name|p
operator|->
name|send_lowat
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return;
block|}
return|return;
block|}
if|if
condition|(
name|ngx_event_pipe
argument_list|(
name|p
argument_list|,
name|ev
operator|->
name|write
argument_list|)
operator|==
name|NGX_ABORT
condition|)
block|{
if|if
condition|(
name|downstream
operator|->
name|destroyed
condition|)
block|{
return|return;
block|}
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|store
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|upstream_eof
operator|&&
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|==
name|NGX_HTTP_OK
condition|)
block|{
name|ngx_http_upstream_store
argument_list|(
name|r
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
operator|(
name|p
operator|->
name|upstream_error
operator|||
operator|(
name|p
operator|->
name|upstream_eof
operator|&&
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|!=
name|NGX_HTTP_OK
operator|)
operator|)
operator|&&
name|u
operator|->
name|pipe
operator|->
name|temp_file
operator|->
name|file
operator|.
name|fd
operator|!=
name|NGX_INVALID_FILE
condition|)
block|{
if|if
condition|(
name|ngx_delete_file
argument_list|(
name|u
operator|->
name|pipe
operator|->
name|temp_file
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_delete_file_n
literal|" \"%s\" failed"
argument_list|,
name|u
operator|->
name|pipe
operator|->
name|temp_file
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|#
directive|if
operator|(
name|NGX_HTTP_FILE_CACHE
operator|)
if|if
condition|(
name|p
operator|->
name|upstream_done
operator|&&
name|u
operator|->
name|cacheable
condition|)
block|{
if|if
condition|(
name|ngx_http_cache_update
argument_list|(
name|r
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_busy_unlock
argument_list|(
name|u
operator|->
name|conf
operator|->
name|busy_lock
argument_list|,
operator|&
name|u
operator|->
name|busy_lock
argument_list|)
expr_stmt|;
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|else if
condition|(
name|p
operator|->
name|upstream_eof
operator|&&
name|u
operator|->
name|cacheable
condition|)
block|{
comment|/* TODO: check length& update cache */
if|if
condition|(
name|ngx_http_cache_update
argument_list|(
name|r
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_busy_unlock
argument_list|(
name|u
operator|->
name|conf
operator|->
name|busy_lock
argument_list|,
operator|&
name|u
operator|->
name|busy_lock
argument_list|)
expr_stmt|;
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|p
operator|->
name|upstream_done
operator|||
name|p
operator|->
name|upstream_eof
operator|||
name|p
operator|->
name|upstream_error
condition|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream exit: %p"
argument_list|,
name|p
operator|->
name|out
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_http_busy_unlock(u->conf->busy_lock,&u->busy_lock);
endif|#
directive|endif
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|p
operator|->
name|downstream_error
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream downstream error"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|u
operator|->
name|cacheable
operator|&&
name|u
operator|->
name|peer
operator|.
name|connection
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_store (ngx_http_request_t * r,ngx_http_upstream_t * u)
name|ngx_http_upstream_store
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|)
block|{
name|char
modifier|*
name|failed
decl_stmt|;
name|u_char
modifier|*
name|name
decl_stmt|;
name|size_t
name|root
decl_stmt|;
name|time_t
name|lm
decl_stmt|;
name|ngx_err_t
name|err
decl_stmt|;
name|ngx_str_t
modifier|*
name|temp
decl_stmt|,
name|path
decl_stmt|,
modifier|*
name|last_modified
decl_stmt|;
name|ngx_temp_file_t
modifier|*
name|tf
decl_stmt|;
if|if
condition|(
name|u
operator|->
name|pipe
operator|->
name|temp_file
operator|->
name|file
operator|.
name|fd
operator|==
name|NGX_INVALID_FILE
condition|)
block|{
comment|/* create file for empty 200 response */
name|tf
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_temp_file_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tf
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
name|tf
operator|->
name|file
operator|.
name|fd
operator|=
name|NGX_INVALID_FILE
expr_stmt|;
name|tf
operator|->
name|file
operator|.
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
name|tf
operator|->
name|path
operator|=
name|u
operator|->
name|conf
operator|->
name|temp_path
expr_stmt|;
name|tf
operator|->
name|pool
operator|=
name|r
operator|->
name|pool
expr_stmt|;
name|tf
operator|->
name|persistent
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_create_temp_file
argument_list|(
operator|&
name|tf
operator|->
name|file
argument_list|,
name|tf
operator|->
name|path
argument_list|,
name|tf
operator|->
name|pool
argument_list|,
name|tf
operator|->
name|persistent
argument_list|,
name|tf
operator|->
name|clean
argument_list|,
name|tf
operator|->
name|access
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return;
block|}
name|u
operator|->
name|pipe
operator|->
name|temp_file
operator|=
name|tf
expr_stmt|;
block|}
name|temp
operator|=
operator|&
name|u
operator|->
name|pipe
operator|->
name|temp_file
operator|->
name|file
operator|.
name|name
expr_stmt|;
if|#
directive|if
operator|!
operator|(
name|NGX_WIN32
operator|)
if|if
condition|(
name|ngx_change_file_access
argument_list|(
name|temp
operator|->
name|data
argument_list|,
name|u
operator|->
name|conf
operator|->
name|store_access
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|err
operator|=
name|ngx_errno
expr_stmt|;
name|failed
operator|=
name|ngx_change_file_access_n
expr_stmt|;
name|name
operator|=
name|temp
operator|->
name|data
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
endif|#
directive|endif
if|if
condition|(
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|last_modified
condition|)
block|{
name|last_modified
operator|=
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|last_modified
operator|->
name|value
expr_stmt|;
name|lm
operator|=
name|ngx_http_parse_time
argument_list|(
name|last_modified
operator|->
name|data
argument_list|,
name|last_modified
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|lm
operator|!=
name|NGX_ERROR
condition|)
block|{
if|if
condition|(
name|ngx_set_file_time
argument_list|(
name|temp
operator|->
name|data
argument_list|,
name|u
operator|->
name|pipe
operator|->
name|temp_file
operator|->
name|file
operator|.
name|fd
argument_list|,
name|lm
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|err
operator|=
name|ngx_errno
expr_stmt|;
name|failed
operator|=
name|ngx_set_file_time_n
expr_stmt|;
name|name
operator|=
name|temp
operator|->
name|data
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
block|}
if|if
condition|(
name|u
operator|->
name|conf
operator|->
name|store_lengths
operator|==
name|NULL
condition|)
block|{
name|ngx_http_map_uri_to_path
argument_list|(
name|r
argument_list|,
operator|&
name|path
argument_list|,
operator|&
name|root
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ngx_http_script_run
argument_list|(
name|r
argument_list|,
operator|&
name|path
argument_list|,
name|u
operator|->
name|conf
operator|->
name|store_lengths
operator|->
name|elts
argument_list|,
literal|0
argument_list|,
name|u
operator|->
name|conf
operator|->
name|store_values
operator|->
name|elts
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
block|}
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream stores \"%s\" to \"%s\""
argument_list|,
name|temp
operator|->
name|data
argument_list|,
name|path
operator|.
name|data
argument_list|)
expr_stmt|;
name|failed
operator|=
name|ngx_rename_file_n
expr_stmt|;
name|name
operator|=
name|path
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|ngx_rename_file
argument_list|(
name|temp
operator|->
name|data
argument_list|,
name|path
operator|.
name|data
argument_list|)
operator|!=
name|NGX_FILE_ERROR
condition|)
block|{
return|return;
block|}
name|err
operator|=
name|ngx_errno
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|NGX_ENOENT
condition|)
block|{
name|err
operator|=
name|ngx_create_full_path
argument_list|(
name|path
operator|.
name|data
argument_list|,
name|ngx_dir_access
argument_list|(
name|u
operator|->
name|conf
operator|->
name|store_access
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ngx_rename_file
argument_list|(
name|temp
operator|->
name|data
argument_list|,
name|path
operator|.
name|data
argument_list|)
operator|!=
name|NGX_FILE_ERROR
condition|)
block|{
return|return;
block|}
name|err
operator|=
name|ngx_errno
expr_stmt|;
block|}
block|}
if|#
directive|if
operator|(
name|NGX_WIN32
operator|)
if|if
condition|(
name|err
operator|==
name|NGX_EEXIST
condition|)
block|{
if|if
condition|(
name|ngx_win32_rename_file
argument_list|(
name|temp
argument_list|,
operator|&
name|path
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|ngx_rename_file
argument_list|(
name|temp
operator|->
name|data
argument_list|,
name|path
operator|.
name|data
argument_list|)
operator|!=
name|NGX_FILE_ERROR
condition|)
block|{
return|return;
block|}
block|}
name|err
operator|=
name|ngx_errno
expr_stmt|;
block|}
endif|#
directive|endif
name|failed
label|:
if|if
condition|(
name|ngx_delete_file
argument_list|(
name|temp
operator|->
name|data
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_delete_file_n
literal|" \"%s\" failed"
argument_list|,
name|temp
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"%s \"%s\" failed"
argument_list|,
name|failed
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_dummy_handler (ngx_event_t * wev)
name|ngx_http_upstream_dummy_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|wev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream dummy handler"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_next (ngx_http_request_t * r,ngx_http_upstream_t * u,ngx_uint_t ft_type)
name|ngx_http_upstream_next
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|,
name|ngx_uint_t
name|ft_type
parameter_list|)
block|{
name|ngx_uint_t
name|status
decl_stmt|,
name|state
decl_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http next upstream, %xi"
argument_list|,
name|ft_type
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_http_busy_unlock(u->conf->busy_lock,&u->busy_lock);
endif|#
directive|endif
if|if
condition|(
name|ft_type
operator|==
name|NGX_HTTP_UPSTREAM_FT_HTTP_404
condition|)
block|{
name|state
operator|=
name|NGX_PEER_NEXT
expr_stmt|;
block|}
else|else
block|{
name|state
operator|=
name|NGX_PEER_FAILED
expr_stmt|;
block|}
if|if
condition|(
name|ft_type
operator|!=
name|NGX_HTTP_UPSTREAM_FT_NOLIVE
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|free
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|,
name|u
operator|->
name|peer
operator|.
name|data
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ft_type
operator|==
name|NGX_HTTP_UPSTREAM_FT_TIMEOUT
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"upstream timed out"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|cached
operator|&&
name|ft_type
operator|==
name|NGX_HTTP_UPSTREAM_FT_ERROR
condition|)
block|{
name|status
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|ft_type
condition|)
block|{
case|case
name|NGX_HTTP_UPSTREAM_FT_TIMEOUT
case|:
name|status
operator|=
name|NGX_HTTP_GATEWAY_TIME_OUT
expr_stmt|;
break|break;
case|case
name|NGX_HTTP_UPSTREAM_FT_HTTP_500
case|:
name|status
operator|=
name|NGX_HTTP_INTERNAL_SERVER_ERROR
expr_stmt|;
break|break;
case|case
name|NGX_HTTP_UPSTREAM_FT_HTTP_404
case|:
name|status
operator|=
name|NGX_HTTP_NOT_FOUND
expr_stmt|;
break|break;
comment|/*          * NGX_HTTP_UPSTREAM_FT_BUSY_LOCK and NGX_HTTP_UPSTREAM_FT_MAX_WAITING          * never reach here          */
default|default:
name|status
operator|=
name|NGX_HTTP_BAD_GATEWAY
expr_stmt|;
block|}
block|}
if|if
condition|(
name|r
operator|->
name|connection
operator|->
name|error
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
condition|)
block|{
name|u
operator|->
name|state
operator|->
name|status
operator|=
name|status
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|tries
operator|==
literal|0
operator|||
operator|!
operator|(
name|u
operator|->
name|conf
operator|->
name|next_upstream
operator|&
name|ft_type
operator|)
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HTTP_CACHE
operator|)
if|if
condition|(
name|u
operator|->
name|stale
operator|&&
operator|(
name|u
operator|->
name|conf
operator|->
name|use_stale
operator|&
name|ft_type
operator|)
condition|)
block|{
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|ngx_http_send_cached_response
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|u
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
condition|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"close http upstream connection: %d"
argument_list|,
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|fd
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|ssl
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|ssl
operator|->
name|no_wait_shutdown
operator|=
literal|1
expr_stmt|;
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|ssl
operator|->
name|no_send_shutdown
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_ssl_shutdown
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ngx_close_connection
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block_content|if (u->conf->busy_lock&& !u->busy_locked) {         ngx_http_upstream_busy_lock(p);         return;     }
endif|#
directive|endif
name|ngx_http_upstream_connect
argument_list|(
name|r
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_cleanup (void * data)
name|ngx_http_upstream_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_request_t
modifier|*
name|r
init|=
name|data
decl_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cleanup http upstream request: \"%V\""
argument_list|,
operator|&
name|r
operator|->
name|uri
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream
operator|->
name|resolved
operator|&&
name|r
operator|->
name|upstream
operator|->
name|resolved
operator|->
name|ctx
condition|)
block|{
name|ngx_resolve_name_done
argument_list|(
name|r
operator|->
name|upstream
operator|->
name|resolved
operator|->
name|ctx
argument_list|)
expr_stmt|;
block|}
name|ngx_http_upstream_finalize_request
argument_list|(
name|r
argument_list|,
name|r
operator|->
name|upstream
argument_list|,
name|NGX_DONE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_upstream_finalize_request (ngx_http_request_t * r,ngx_http_upstream_t * u,ngx_int_t rc)
name|ngx_http_upstream_finalize_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_upstream_t
modifier|*
name|u
parameter_list|,
name|ngx_int_t
name|rc
parameter_list|)
block|{
name|ngx_time_t
modifier|*
name|tp
decl_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"finalize http upstream request: %i"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
operator|*
name|u
operator|->
name|cleanup
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|state
operator|&&
name|u
operator|->
name|state
operator|->
name|response_sec
condition|)
block|{
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|response_sec
operator|=
name|tp
operator|->
name|sec
operator|-
name|u
operator|->
name|state
operator|->
name|response_sec
expr_stmt|;
name|u
operator|->
name|state
operator|->
name|response_msec
operator|=
name|tp
operator|->
name|msec
operator|-
name|u
operator|->
name|state
operator|->
name|response_msec
expr_stmt|;
block|}
name|u
operator|->
name|finalize_request
argument_list|(
name|r
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|free
condition|)
block|{
name|u
operator|->
name|peer
operator|.
name|free
argument_list|(
operator|&
name|u
operator|->
name|peer
argument_list|,
name|u
operator|->
name|peer
operator|.
name|data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
comment|/* TODO: do not shutdown persistent connection */
if|if
condition|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|ssl
condition|)
block|{
comment|/*              * We send the "close notify" shutdown alert to the upstream only              * and do not wait its "close notify" shutdown alert.              * It is acceptable according to the TLS standard.              */
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|ssl
operator|->
name|no_wait_shutdown
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_ssl_shutdown
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"close http upstream connection: %d"
argument_list|,
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|fd
argument_list|)
expr_stmt|;
name|ngx_close_connection
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
block|}
name|u
operator|->
name|peer
operator|.
name|connection
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|header_sent
operator|&&
operator|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|>=
name|NGX_HTTP_SPECIAL_RESPONSE
operator|)
condition|)
block|{
name|rc
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|u
operator|->
name|pipe
operator|&&
name|u
operator|->
name|pipe
operator|->
name|temp_file
condition|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http upstream temp fd: %d"
argument_list|,
name|u
operator|->
name|pipe
operator|->
name|temp_file
operator|->
name|file
operator|.
name|fd
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block_content|if (u->cache) {         ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                        "http upstream cache fd: %d",                        u->cache->ctx.file.fd);     }
endif|#
directive|endif
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
return|return;
block|}
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|action
operator|=
literal|"sending to client"
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|r
operator|==
name|r
operator|->
expr|main
condition|)
block|{
if|if
condition|(
operator|!
name|r
operator|->
name|post_action
condition|)
block|{
name|rc
operator|=
name|ngx_http_send_special
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_LAST
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|r
operator|->
name|out
condition|)
block|{
name|rc
operator|=
name|NGX_AGAIN
expr_stmt|;
block|}
block|}
block|}
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_process_header_line (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_process_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|ngx_table_elt_t
modifier|*
modifier|*
name|ph
decl_stmt|;
name|ph
operator|=
operator|(
name|ngx_table_elt_t
operator|*
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|+
name|offset
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|ph
operator|==
name|NULL
condition|)
block|{
operator|*
name|ph
operator|=
name|h
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_process_multi_header_lines (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_process_multi_header_lines
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|ngx_array_t
modifier|*
name|pa
decl_stmt|;
name|ngx_table_elt_t
modifier|*
modifier|*
name|ph
decl_stmt|;
name|pa
operator|=
operator|(
name|ngx_array_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|+
name|offset
operator|)
expr_stmt|;
if|if
condition|(
name|pa
operator|->
name|elts
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
name|pa
argument_list|,
name|r
operator|->
name|pool
argument_list|,
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_table_elt_t
operator|*
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
name|ph
operator|=
name|ngx_array_push
argument_list|(
name|pa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ph
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ph
operator|=
name|h
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_ignore_header_line (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_ignore_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_process_limit_rate (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_process_limit_rate
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|ngx_int_t
name|n
decl_stmt|;
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|x_accel_limit_rate
operator|=
name|h
expr_stmt|;
name|n
operator|=
name|ngx_atoi
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
argument_list|,
name|h
operator|->
name|value
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|NGX_ERROR
condition|)
block|{
name|r
operator|->
name|limit_rate
operator|=
operator|(
name|size_t
operator|)
name|n
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_process_buffering (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_process_buffering
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|u_char
name|c0
decl_stmt|,
name|c1
decl_stmt|,
name|c2
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream
operator|->
name|conf
operator|->
name|change_buffering
condition|)
block|{
if|if
condition|(
name|h
operator|->
name|value
operator|.
name|len
operator|==
literal|2
condition|)
block|{
name|c0
operator|=
name|ngx_tolower
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|c1
operator|=
name|ngx_tolower
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|c0
operator|==
literal|'n'
operator|&&
name|c1
operator|==
literal|'o'
condition|)
block|{
name|r
operator|->
name|upstream
operator|->
name|buffering
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|h
operator|->
name|value
operator|.
name|len
operator|==
literal|3
condition|)
block|{
name|c0
operator|=
name|ngx_tolower
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|c1
operator|=
name|ngx_tolower
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|c2
operator|=
name|ngx_tolower
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|c0
operator|==
literal|'y'
operator|&&
name|c1
operator|==
literal|'e'
operator|&&
name|c2
operator|==
literal|'s'
condition|)
block|{
name|r
operator|->
name|upstream
operator|->
name|buffering
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_process_charset (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_process_charset
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|override_charset
operator|=
operator|&
name|h
operator|->
name|value
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_copy_header_line (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_copy_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|ngx_table_elt_t
modifier|*
name|ho
decl_stmt|,
modifier|*
modifier|*
name|ph
decl_stmt|;
name|ho
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|ho
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ho
operator|=
operator|*
name|h
expr_stmt|;
if|if
condition|(
name|offset
condition|)
block|{
name|ph
operator|=
operator|(
name|ngx_table_elt_t
operator|*
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|r
operator|->
name|headers_out
operator|+
name|offset
operator|)
expr_stmt|;
operator|*
name|ph
operator|=
name|ho
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_copy_multi_header_lines (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_copy_multi_header_lines
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|ngx_array_t
modifier|*
name|pa
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|ho
decl_stmt|,
modifier|*
modifier|*
name|ph
decl_stmt|;
name|pa
operator|=
operator|(
name|ngx_array_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|r
operator|->
name|headers_out
operator|+
name|offset
operator|)
expr_stmt|;
if|if
condition|(
name|pa
operator|->
name|elts
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
name|pa
argument_list|,
name|r
operator|->
name|pool
argument_list|,
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_table_elt_t
operator|*
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
name|ph
operator|=
name|ngx_array_push
argument_list|(
name|pa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ph
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ho
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|ho
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ho
operator|=
operator|*
name|h
expr_stmt|;
operator|*
name|ph
operator|=
name|ho
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_copy_content_type (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_copy_content_type
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_type_len
operator|=
name|h
operator|->
name|value
operator|.
name|len
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_type
operator|=
name|h
operator|->
name|value
expr_stmt|;
for|for
control|(
name|p
operator|=
name|h
operator|->
name|value
operator|.
name|data
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|!=
literal|';'
condition|)
block|{
continue|continue;
block|}
name|last
operator|=
name|p
expr_stmt|;
while|while
condition|(
operator|*
operator|++
name|p
operator|==
literal|' '
condition|)
block|{
comment|/* void */
block|}
if|if
condition|(
name|ngx_strncasecmp
argument_list|(
name|p
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"charset="
argument_list|,
literal|8
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
name|p
operator|+=
literal|8
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_type_len
operator|=
name|last
operator|-
name|h
operator|->
name|value
operator|.
name|data
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|charset
operator|.
name|len
operator|=
name|h
operator|->
name|value
operator|.
name|data
operator|+
name|h
operator|->
name|value
operator|.
name|len
operator|-
name|p
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|charset
operator|.
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_copy_content_length (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_copy_content_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|ngx_table_elt_t
modifier|*
name|ho
decl_stmt|;
name|ho
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|ho
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ho
operator|=
operator|*
name|h
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_length
operator|=
name|ho
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_length_n
operator|=
name|ngx_atoof
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
argument_list|,
name|h
operator|->
name|value
operator|.
name|len
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_rewrite_location (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_rewrite_location
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|ho
decl_stmt|;
name|ho
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|ho
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ho
operator|=
operator|*
name|h
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream
operator|->
name|rewrite_redirect
condition|)
block|{
name|rc
operator|=
name|r
operator|->
name|upstream
operator|->
name|rewrite_redirect
argument_list|(
name|r
argument_list|,
name|ho
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|location
operator|=
name|ho
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"rewritten location: \"%V\""
argument_list|,
operator|&
name|ho
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
if|if
condition|(
name|ho
operator|->
name|value
operator|.
name|data
index|[
literal|0
index|]
operator|!=
literal|'/'
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|location
operator|=
name|ho
expr_stmt|;
block|}
comment|/*      * we do not set r->headers_out.location here to avoid the handling      * the local redirects without a host name by ngx_http_header_filter()      */
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_rewrite_refresh (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_rewrite_refresh
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|ho
decl_stmt|;
name|ho
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|ho
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ho
operator|=
operator|*
name|h
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream
operator|->
name|rewrite_redirect
condition|)
block|{
name|p
operator|=
name|ngx_strcasestrn
argument_list|(
name|ho
operator|->
name|value
operator|.
name|data
argument_list|,
literal|"url="
argument_list|,
literal|4
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|rc
operator|=
name|r
operator|->
name|upstream
operator|->
name|rewrite_redirect
argument_list|(
name|r
argument_list|,
name|ho
argument_list|,
name|p
operator|+
literal|4
operator|-
name|ho
operator|->
name|value
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|refresh
operator|=
name|ho
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"rewritten refresh: \"%V\""
argument_list|,
operator|&
name|ho
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
name|r
operator|->
name|headers_out
operator|.
name|refresh
operator|=
name|ho
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_GZIP
operator|)
end_if

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_copy_content_encoding (ngx_http_request_t * r,ngx_table_elt_t * h,ngx_uint_t offset)
name|ngx_http_upstream_copy_content_encoding
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_table_elt_t
modifier|*
name|h
parameter_list|,
name|ngx_uint_t
name|offset
parameter_list|)
block|{
name|ngx_table_elt_t
modifier|*
name|ho
decl_stmt|;
name|ho
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|ho
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ho
operator|=
operator|*
name|h
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_encoding
operator|=
name|ho
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_add_variables (ngx_conf_t * cf)
name|ngx_http_upstream_add_variables
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_variable_t
modifier|*
name|var
decl_stmt|,
modifier|*
name|v
decl_stmt|;
for|for
control|(
name|v
operator|=
name|ngx_http_upstream_vars
init|;
name|v
operator|->
name|name
operator|.
name|len
condition|;
name|v
operator|++
control|)
block|{
name|var
operator|=
name|ngx_http_add_variable
argument_list|(
name|cf
argument_list|,
operator|&
name|v
operator|->
name|name
argument_list|,
name|v
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|var
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|var
operator|->
name|get_handler
operator|=
name|v
operator|->
name|get_handler
expr_stmt|;
name|var
operator|->
name|data
operator|=
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_addr_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_upstream_addr_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_upstream_state_t
modifier|*
name|state
decl_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream_states
operator|==
name|NULL
operator|||
name|r
operator|->
name|upstream_states
operator|->
name|nelts
operator|==
literal|0
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|len
operator|=
literal|0
expr_stmt|;
name|state
operator|=
name|r
operator|->
name|upstream_states
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
operator|->
name|upstream_states
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|state
index|[
name|i
index|]
operator|.
name|peer
condition|)
block|{
name|len
operator|+=
name|state
index|[
name|i
index|]
operator|.
name|peer
operator|->
name|len
operator|+
literal|2
expr_stmt|;
block|}
else|else
block|{
name|len
operator|+=
literal|3
expr_stmt|;
block|}
block|}
name|p
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|state
index|[
name|i
index|]
operator|.
name|peer
condition|)
block|{
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|state
index|[
name|i
index|]
operator|.
name|peer
operator|->
name|data
argument_list|,
name|state
index|[
name|i
index|]
operator|.
name|peer
operator|->
name|len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|++
name|i
operator|==
name|r
operator|->
name|upstream_states
operator|->
name|nelts
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|state
index|[
name|i
index|]
operator|.
name|peer
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|','
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
else|else
block|{
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|':'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
operator|++
name|i
operator|==
name|r
operator|->
name|upstream_states
operator|->
name|nelts
condition|)
block|{
break|break;
block|}
continue|continue;
block|}
block|}
name|v
operator|->
name|len
operator|=
name|p
operator|-
name|v
operator|->
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_status_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_upstream_status_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_upstream_state_t
modifier|*
name|state
decl_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream_states
operator|==
name|NULL
operator|||
name|r
operator|->
name|upstream_states
operator|->
name|nelts
operator|==
literal|0
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|len
operator|=
name|r
operator|->
name|upstream_states
operator|->
name|nelts
operator|*
operator|(
literal|3
operator|+
literal|2
operator|)
expr_stmt|;
name|p
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|state
operator|=
name|r
operator|->
name|upstream_states
operator|->
name|elts
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|state
index|[
name|i
index|]
operator|.
name|status
condition|)
block|{
name|p
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%ui"
argument_list|,
name|state
index|[
name|i
index|]
operator|.
name|status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|p
operator|++
operator|=
literal|'-'
expr_stmt|;
block|}
if|if
condition|(
operator|++
name|i
operator|==
name|r
operator|->
name|upstream_states
operator|->
name|nelts
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|state
index|[
name|i
index|]
operator|.
name|peer
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|','
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
else|else
block|{
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|':'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
operator|++
name|i
operator|==
name|r
operator|->
name|upstream_states
operator|->
name|nelts
condition|)
block|{
break|break;
block|}
continue|continue;
block|}
block|}
name|v
operator|->
name|len
operator|=
name|p
operator|-
name|v
operator|->
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_upstream_response_time_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_upstream_response_time_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_msec_int_t
name|ms
decl_stmt|;
name|ngx_http_upstream_state_t
modifier|*
name|state
decl_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|upstream_states
operator|==
name|NULL
operator|||
name|r
operator|->
name|upstream_states
operator|->
name|nelts
operator|==
literal|0
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|len
operator|=
name|r
operator|->
name|upstream_states
operator|->
name|nelts
operator|*
operator|(
name|NGX_TIME_T_LEN
operator|+
literal|4
operator|+
literal|2
operator|)
expr_stmt|;
name|p
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|state
operator|=
name|r
operator|->
name|upstream_states
operator|->
name|elts
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|state
index|[
name|i
index|]
operator|.
name|status
condition|)
block|{
name|ms
operator|=
operator|(
name|ngx_msec_int_t
operator|)
operator|(
name|state
index|[
name|i
index|]
operator|.
name|response_sec
operator|*
literal|1000
operator|+
name|state
index|[
name|i
index|]
operator|.
name|response_msec
operator|)
expr_stmt|;
name|ms
operator|=
operator|(
name|ms
operator|>=
literal|0
operator|)
condition|?
name|ms
else|:
literal|0
expr_stmt|;
name|p
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%d.%03d"
argument_list|,
name|ms
operator|/
literal|1000
argument_list|,
name|ms
operator|%
literal|1000
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|p
operator|++
operator|=
literal|'-'
expr_stmt|;
block|}
if|if
condition|(
operator|++
name|i
operator|==
name|r
operator|->
name|upstream_states
operator|->
name|nelts
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|state
index|[
name|i
index|]
operator|.
name|peer
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|','
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
else|else
block|{
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|':'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
operator|++
name|i
operator|==
name|r
operator|->
name|upstream_states
operator|->
name|nelts
condition|)
block|{
break|break;
block|}
continue|continue;
block|}
block|}
name|v
operator|->
name|len
operator|=
name|p
operator|-
name|v
operator|->
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_upstream_header_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_upstream_header_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|upstream
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
return|return
name|ngx_http_variable_unknown_header
argument_list|(
name|v
argument_list|,
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
argument_list|,
operator|&
name|r
operator|->
name|upstream
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
argument_list|,
sizeof|sizeof
argument_list|(
literal|"upstream_http_"
argument_list|)
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_upstream (ngx_conf_t * cf,ngx_command_t * cmd,void * dummy)
name|ngx_http_upstream
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|dummy
parameter_list|)
block|{
name|char
modifier|*
name|rv
decl_stmt|;
name|void
modifier|*
name|mconf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_url_t
name|u
decl_stmt|;
name|ngx_uint_t
name|m
decl_stmt|;
name|ngx_conf_t
name|pcf
decl_stmt|;
name|ngx_http_module_t
modifier|*
name|module
decl_stmt|;
name|ngx_http_conf_ctx_t
modifier|*
name|ctx
decl_stmt|,
modifier|*
name|http_ctx
decl_stmt|;
name|ngx_http_upstream_srv_conf_t
modifier|*
name|uscf
decl_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|u
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|u
operator|.
name|host
operator|=
name|value
index|[
literal|1
index|]
expr_stmt|;
name|u
operator|.
name|no_resolve
operator|=
literal|1
expr_stmt|;
name|uscf
operator|=
name|ngx_http_upstream_add
argument_list|(
name|cf
argument_list|,
operator|&
name|u
argument_list|,
name|NGX_HTTP_UPSTREAM_CREATE
operator||
name|NGX_HTTP_UPSTREAM_WEIGHT
operator||
name|NGX_HTTP_UPSTREAM_MAX_FAILS
operator||
name|NGX_HTTP_UPSTREAM_FAIL_TIMEOUT
operator||
name|NGX_HTTP_UPSTREAM_DOWN
operator||
name|NGX_HTTP_UPSTREAM_BACKUP
argument_list|)
expr_stmt|;
if|if
condition|(
name|uscf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_conf_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|http_ctx
operator|=
name|cf
operator|->
name|ctx
expr_stmt|;
name|ctx
operator|->
name|main_conf
operator|=
name|http_ctx
operator|->
name|main_conf
expr_stmt|;
comment|/* the upstream{}'s srv_conf */
name|ctx
operator|->
name|srv_conf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|ngx_http_max_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|srv_conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ctx
operator|->
name|srv_conf
index|[
name|ngx_http_upstream_module
operator|.
name|ctx_index
index|]
operator|=
name|uscf
expr_stmt|;
name|uscf
operator|->
name|srv_conf
operator|=
name|ctx
operator|->
name|srv_conf
expr_stmt|;
comment|/* the upstream{}'s loc_conf */
name|ctx
operator|->
name|loc_conf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|ngx_http_max_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|loc_conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
for|for
control|(
name|m
operator|=
literal|0
init|;
name|ngx_modules
index|[
name|m
index|]
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
name|ngx_modules
index|[
name|m
index|]
operator|->
name|type
operator|!=
name|NGX_HTTP_MODULE
condition|)
block|{
continue|continue;
block|}
name|module
operator|=
name|ngx_modules
index|[
name|m
index|]
operator|->
name|ctx
expr_stmt|;
if|if
condition|(
name|module
operator|->
name|create_srv_conf
condition|)
block|{
name|mconf
operator|=
name|module
operator|->
name|create_srv_conf
argument_list|(
name|cf
argument_list|)
expr_stmt|;
if|if
condition|(
name|mconf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ctx
operator|->
name|srv_conf
index|[
name|ngx_modules
index|[
name|m
index|]
operator|->
name|ctx_index
index|]
operator|=
name|mconf
expr_stmt|;
block|}
if|if
condition|(
name|module
operator|->
name|create_loc_conf
condition|)
block|{
name|mconf
operator|=
name|module
operator|->
name|create_loc_conf
argument_list|(
name|cf
argument_list|)
expr_stmt|;
if|if
condition|(
name|mconf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ctx
operator|->
name|loc_conf
index|[
name|ngx_modules
index|[
name|m
index|]
operator|->
name|ctx_index
index|]
operator|=
name|mconf
expr_stmt|;
block|}
block|}
comment|/* parse inside upstream{} */
name|pcf
operator|=
operator|*
name|cf
expr_stmt|;
name|cf
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|cf
operator|->
name|cmd_type
operator|=
name|NGX_HTTP_UPS_CONF
expr_stmt|;
name|rv
operator|=
name|ngx_conf_parse
argument_list|(
name|cf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|*
name|cf
operator|=
name|pcf
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
name|NGX_CONF_OK
condition|)
block|{
return|return
name|rv
return|;
block|}
if|if
condition|(
name|uscf
operator|->
name|servers
operator|==
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"no servers are inside upstream"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_upstream_server (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_upstream_server
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_upstream_srv_conf_t
modifier|*
name|uscf
init|=
name|conf
decl_stmt|;
name|time_t
name|fail_timeout
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|,
name|s
decl_stmt|;
name|ngx_url_t
name|u
decl_stmt|;
name|ngx_int_t
name|weight
decl_stmt|,
name|max_fails
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_upstream_server_t
modifier|*
name|us
decl_stmt|;
if|if
condition|(
name|uscf
operator|->
name|servers
operator|==
name|NULL
condition|)
block|{
name|uscf
operator|->
name|servers
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_server_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uscf
operator|->
name|servers
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|us
operator|=
name|ngx_array_push
argument_list|(
name|uscf
operator|->
name|servers
argument_list|)
expr_stmt|;
if|if
condition|(
name|us
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
name|us
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_server_t
argument_list|)
argument_list|)
expr_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|u
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|.
name|url
operator|=
name|value
index|[
literal|1
index|]
expr_stmt|;
name|u
operator|.
name|default_port
operator|=
literal|80
expr_stmt|;
if|if
condition|(
name|ngx_parse_url
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
operator|&
name|u
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|u
operator|.
name|err
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"%s in upstream \"%V\""
argument_list|,
name|u
operator|.
name|err
argument_list|,
operator|&
name|u
operator|.
name|url
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|weight
operator|=
literal|1
expr_stmt|;
name|max_fails
operator|=
literal|1
expr_stmt|;
name|fail_timeout
operator|=
literal|10
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|cf
operator|->
name|args
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"weight="
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|uscf
operator|->
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_WEIGHT
operator|)
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
name|weight
operator|=
name|ngx_atoi
argument_list|(
operator|&
name|value
index|[
name|i
index|]
operator|.
name|data
index|[
literal|7
index|]
argument_list|,
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|weight
operator|==
name|NGX_ERROR
operator|||
name|weight
operator|==
literal|0
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"max_fails="
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|uscf
operator|->
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_MAX_FAILS
operator|)
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
name|max_fails
operator|=
name|ngx_atoi
argument_list|(
operator|&
name|value
index|[
name|i
index|]
operator|.
name|data
index|[
literal|10
index|]
argument_list|,
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_fails
operator|==
name|NGX_ERROR
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"fail_timeout="
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|uscf
operator|->
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_FAIL_TIMEOUT
operator|)
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
name|s
operator|.
name|len
operator|=
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|13
expr_stmt|;
name|s
operator|.
name|data
operator|=
operator|&
name|value
index|[
name|i
index|]
operator|.
name|data
index|[
literal|13
index|]
expr_stmt|;
name|fail_timeout
operator|=
name|ngx_parse_time
argument_list|(
operator|&
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fail_timeout
operator|<
literal|0
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"backup"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|uscf
operator|->
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_BACKUP
operator|)
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
name|us
operator|->
name|backup
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"down"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|uscf
operator|->
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_DOWN
operator|)
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
name|us
operator|->
name|down
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
goto|goto
name|invalid
goto|;
block|}
name|us
operator|->
name|addrs
operator|=
name|u
operator|.
name|addrs
expr_stmt|;
name|us
operator|->
name|naddrs
operator|=
name|u
operator|.
name|naddrs
expr_stmt|;
name|us
operator|->
name|weight
operator|=
name|weight
expr_stmt|;
name|us
operator|->
name|max_fails
operator|=
name|max_fails
expr_stmt|;
name|us
operator|->
name|fail_timeout
operator|=
name|fail_timeout
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
name|invalid
label|:
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
end_function

begin_function
name|ngx_http_upstream_srv_conf_t
modifier|*
DECL|function|ngx_http_upstream_add (ngx_conf_t * cf,ngx_url_t * u,ngx_uint_t flags)
name|ngx_http_upstream_add
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_url_t
modifier|*
name|u
parameter_list|,
name|ngx_uint_t
name|flags
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_upstream_server_t
modifier|*
name|us
decl_stmt|;
name|ngx_http_upstream_srv_conf_t
modifier|*
name|uscf
decl_stmt|,
modifier|*
modifier|*
name|uscfp
decl_stmt|;
name|ngx_http_upstream_main_conf_t
modifier|*
name|umcf
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_CREATE
operator|)
condition|)
block|{
if|if
condition|(
name|ngx_parse_url
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|u
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|err
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"%s in upstream \"%V\""
argument_list|,
name|u
operator|->
name|err
argument_list|,
operator|&
name|u
operator|->
name|url
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
block|}
name|umcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_upstream_module
argument_list|)
expr_stmt|;
name|uscfp
operator|=
name|umcf
operator|->
name|upstreams
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|umcf
operator|->
name|upstreams
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|uscfp
index|[
name|i
index|]
operator|->
name|host
operator|.
name|len
operator|!=
name|u
operator|->
name|host
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|uscfp
index|[
name|i
index|]
operator|->
name|host
operator|.
name|data
argument_list|,
name|u
operator|->
name|host
operator|.
name|data
argument_list|,
name|u
operator|->
name|host
operator|.
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
operator|(
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_CREATE
operator|)
operator|&&
operator|(
name|uscfp
index|[
name|i
index|]
operator|->
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_CREATE
operator|)
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate upstream \"%V\""
argument_list|,
operator|&
name|u
operator|->
name|host
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|(
name|uscfp
index|[
name|i
index|]
operator|->
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_CREATE
operator|)
operator|&&
name|u
operator|->
name|port
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"upstream \"%V\" may not have port %d"
argument_list|,
operator|&
name|u
operator|->
name|host
argument_list|,
name|u
operator|->
name|port
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|(
name|flags
operator|&
name|NGX_HTTP_UPSTREAM_CREATE
operator|)
operator|&&
name|uscfp
index|[
name|i
index|]
operator|->
name|port
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream \"%V\" may not have port %d in %s:%ui"
argument_list|,
operator|&
name|u
operator|->
name|host
argument_list|,
name|uscfp
index|[
name|i
index|]
operator|->
name|port
argument_list|,
name|uscfp
index|[
name|i
index|]
operator|->
name|file_name
argument_list|,
name|uscfp
index|[
name|i
index|]
operator|->
name|line
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|uscfp
index|[
name|i
index|]
operator|->
name|port
operator|!=
name|u
operator|->
name|port
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|uscfp
index|[
name|i
index|]
operator|->
name|default_port
operator|&&
name|u
operator|->
name|default_port
operator|&&
name|uscfp
index|[
name|i
index|]
operator|->
name|default_port
operator|!=
name|u
operator|->
name|default_port
condition|)
block|{
continue|continue;
block|}
return|return
name|uscfp
index|[
name|i
index|]
return|;
block|}
name|uscf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_srv_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uscf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|uscf
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|uscf
operator|->
name|host
operator|=
name|u
operator|->
name|host
expr_stmt|;
name|uscf
operator|->
name|file_name
operator|=
name|cf
operator|->
name|conf_file
operator|->
name|file
operator|.
name|name
operator|.
name|data
expr_stmt|;
name|uscf
operator|->
name|line
operator|=
name|cf
operator|->
name|conf_file
operator|->
name|line
expr_stmt|;
name|uscf
operator|->
name|port
operator|=
name|u
operator|->
name|port
expr_stmt|;
name|uscf
operator|->
name|default_port
operator|=
name|u
operator|->
name|default_port
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|naddrs
operator|==
literal|1
condition|)
block|{
name|uscf
operator|->
name|servers
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_server_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uscf
operator|->
name|servers
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|us
operator|=
name|ngx_array_push
argument_list|(
name|uscf
operator|->
name|servers
argument_list|)
expr_stmt|;
if|if
condition|(
name|us
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
name|us
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_server_t
argument_list|)
argument_list|)
expr_stmt|;
name|us
operator|->
name|addrs
operator|=
name|u
operator|->
name|addrs
expr_stmt|;
name|us
operator|->
name|naddrs
operator|=
name|u
operator|->
name|naddrs
expr_stmt|;
block|}
name|uscfp
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|umcf
operator|->
name|upstreams
argument_list|)
expr_stmt|;
if|if
condition|(
name|uscfp
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
operator|*
name|uscfp
operator|=
name|uscf
expr_stmt|;
return|return
name|uscf
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_upstream_create_main_conf (ngx_conf_t * cf)
name|ngx_http_upstream_create_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_upstream_main_conf_t
modifier|*
name|umcf
decl_stmt|;
name|umcf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_main_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|umcf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|umcf
operator|->
name|upstreams
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_srv_conf_t
operator|*
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|umcf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_upstream_init_main_conf (ngx_conf_t * cf,void * conf)
name|ngx_http_upstream_init_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_upstream_main_conf_t
modifier|*
name|umcf
init|=
name|conf
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_array_t
name|headers_in
decl_stmt|;
name|ngx_hash_key_t
modifier|*
name|hk
decl_stmt|;
name|ngx_hash_init_t
name|hash
decl_stmt|;
name|ngx_http_upstream_init_pt
name|init
decl_stmt|;
name|ngx_http_upstream_header_t
modifier|*
name|header
decl_stmt|;
name|ngx_http_upstream_srv_conf_t
modifier|*
modifier|*
name|uscfp
decl_stmt|;
name|uscfp
operator|=
name|umcf
operator|->
name|upstreams
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|umcf
operator|->
name|upstreams
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|init
operator|=
name|uscfp
index|[
name|i
index|]
operator|->
name|peer
operator|.
name|init_upstream
condition|?
name|uscfp
index|[
name|i
index|]
operator|->
name|peer
operator|.
name|init_upstream
else|:
name|ngx_http_upstream_init_round_robin
expr_stmt|;
if|if
condition|(
name|init
argument_list|(
name|cf
argument_list|,
name|uscfp
index|[
name|i
index|]
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
comment|/* upstream_headers_in_hash */
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|headers_in
argument_list|,
name|cf
operator|->
name|temp_pool
argument_list|,
literal|32
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_hash_key_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
for|for
control|(
name|header
operator|=
name|ngx_http_upstream_headers_in
init|;
name|header
operator|->
name|name
operator|.
name|len
condition|;
name|header
operator|++
control|)
block|{
name|hk
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|headers_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|hk
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|hk
operator|->
name|key
operator|=
name|header
operator|->
name|name
expr_stmt|;
name|hk
operator|->
name|key_hash
operator|=
name|ngx_hash_key_lc
argument_list|(
name|header
operator|->
name|name
operator|.
name|data
argument_list|,
name|header
operator|->
name|name
operator|.
name|len
argument_list|)
expr_stmt|;
name|hk
operator|->
name|value
operator|=
name|header
expr_stmt|;
block|}
name|hash
operator|.
name|hash
operator|=
operator|&
name|umcf
operator|->
name|headers_in_hash
expr_stmt|;
name|hash
operator|.
name|key
operator|=
name|ngx_hash_key_lc
expr_stmt|;
name|hash
operator|.
name|max_size
operator|=
literal|512
expr_stmt|;
name|hash
operator|.
name|bucket_size
operator|=
name|ngx_align
argument_list|(
literal|64
argument_list|,
name|ngx_cacheline_size
argument_list|)
expr_stmt|;
name|hash
operator|.
name|name
operator|=
literal|"upstream_headers_in_hash"
expr_stmt|;
name|hash
operator|.
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
name|hash
operator|.
name|temp_pool
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ngx_hash_init
argument_list|(
operator|&
name|hash
argument_list|,
name|headers_in
operator|.
name|elts
argument_list|,
name|headers_in
operator|.
name|nelts
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

end_unit

