begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_include
include|#
directive|include
file|<libxml/parser.h>
end_include

begin_include
include|#
directive|include
file|<libxml/tree.h>
end_include

begin_include
include|#
directive|include
file|<libxslt/xslt.h>
end_include

begin_include
include|#
directive|include
file|<libxslt/xsltInternals.h>
end_include

begin_include
include|#
directive|include
file|<libxslt/transform.h>
end_include

begin_include
include|#
directive|include
file|<libxslt/xsltutils.h>
end_include

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_EXSLT
operator|)
end_if

begin_include
include|#
directive|include
file|<libexslt/exslt.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|NGX_HTTP_XSLT_REUSE_DTD
end_ifndef

begin_define
DECL|macro|NGX_HTTP_XSLT_REUSE_DTD
define|#
directive|define
name|NGX_HTTP_XSLT_REUSE_DTD
value|1
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
DECL|struct|__anon2742de680108
typedef|typedef
struct|struct
block|{
DECL|member|name
name|u_char
modifier|*
name|name
decl_stmt|;
DECL|member|data
name|void
modifier|*
name|data
decl_stmt|;
DECL|typedef|ngx_http_xslt_file_t
block|}
name|ngx_http_xslt_file_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2742de680208
typedef|typedef
struct|struct
block|{
DECL|member|dtd_files
name|ngx_array_t
name|dtd_files
decl_stmt|;
comment|/* ngx_http_xslt_file_t */
DECL|member|sheet_files
name|ngx_array_t
name|sheet_files
decl_stmt|;
comment|/* ngx_http_xslt_file_t */
DECL|typedef|ngx_http_xslt_filter_main_conf_t
block|}
name|ngx_http_xslt_filter_main_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2742de680308
typedef|typedef
struct|struct
block|{
DECL|member|stylesheet
name|xsltStylesheetPtr
name|stylesheet
decl_stmt|;
DECL|member|params
name|ngx_array_t
name|params
decl_stmt|;
comment|/* ngx_http_complex_value_t */
DECL|typedef|ngx_http_xslt_sheet_t
block|}
name|ngx_http_xslt_sheet_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2742de680408
typedef|typedef
struct|struct
block|{
DECL|member|dtd
name|xmlDtdPtr
name|dtd
decl_stmt|;
DECL|member|sheets
name|ngx_array_t
name|sheets
decl_stmt|;
comment|/* ngx_http_xslt_sheet_t */
DECL|member|types
name|ngx_hash_t
name|types
decl_stmt|;
DECL|member|types_keys
name|ngx_array_t
modifier|*
name|types_keys
decl_stmt|;
DECL|typedef|ngx_http_xslt_filter_loc_conf_t
block|}
name|ngx_http_xslt_filter_loc_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2742de680508
typedef|typedef
struct|struct
block|{
DECL|member|doc
name|xmlDocPtr
name|doc
decl_stmt|;
DECL|member|ctxt
name|xmlParserCtxtPtr
name|ctxt
decl_stmt|;
DECL|member|sax
name|xmlSAXHandler
modifier|*
name|sax
decl_stmt|;
DECL|member|request
name|ngx_http_request_t
modifier|*
name|request
decl_stmt|;
DECL|member|params
name|ngx_array_t
name|params
decl_stmt|;
DECL|member|done
name|ngx_uint_t
name|done
decl_stmt|;
comment|/* unsigned  done:1; */
DECL|typedef|ngx_http_xslt_filter_ctx_t
block|}
name|ngx_http_xslt_filter_ctx_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_xslt_send
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_xslt_add_chunk
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_start_document
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_end_document
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_internal_subset
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|externalId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_external_subset
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|externalId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_entity_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
name|int
name|type
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|publicId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|,
name|xmlChar
modifier|*
name|content
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_attribute_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|elem
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|fullname
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|def
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|defaultValue
parameter_list|,
name|xmlEnumerationPtr
name|tree
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_element_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
name|int
name|type
parameter_list|,
name|xmlElementContentPtr
name|content
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_notation_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|publicId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_unparsed_entity_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|publicId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|notationName
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_start_element
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|localname
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|prefix
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|URI
parameter_list|,
name|int
name|nb_namespaces
parameter_list|,
specifier|const
name|xmlChar
modifier|*
modifier|*
name|namespaces
parameter_list|,
name|int
name|nb_attributes
parameter_list|,
name|int
name|nb_defaulted
parameter_list|,
specifier|const
name|xmlChar
modifier|*
modifier|*
name|attributes
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_end_element
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|localname
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|prefix
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|URI
name|ATTRIBUTE_UNUSED
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_characters
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_cdata_block
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|xmlEntityPtr
name|ngx_http_xslt_sax_get_entity
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|xmlEntityPtr
name|ngx_http_xslt_sax_get_parameter_entity
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|xmlParserInputPtr
name|ngx_http_xslt_sax_resolve_entity
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|publicId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_reference
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_comment
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_sax_processing_instruction
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|target
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|pidata
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_xslt_sax_is_standalone
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_xslt_sax_has_internal_subset
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_xslt_sax_has_external_subset
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_cdecl
name|ngx_http_xslt_sax_error
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
modifier|...
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_buf_t
modifier|*
name|ngx_http_xslt_apply_stylesheet
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_xslt_params
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_array_t
modifier|*
name|params
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_xslt_content_type
parameter_list|(
name|xsltStylesheetPtr
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_xslt_encoding
parameter_list|(
name|xsltStylesheetPtr
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_xslt_entities
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_xslt_stylesheet
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_cleanup_dtd
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_cleanup_stylesheet
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_xslt_filter_create_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_xslt_filter_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_xslt_filter_merge_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_xslt_filter_init
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_xslt_filter_exit
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_http_xslt_default_types
name|ngx_str_t
name|ngx_http_xslt_default_types
index|[]
init|=
block|{
name|ngx_string
argument_list|(
literal|"text/xml"
argument_list|)
block|,
name|ngx_null_string
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_xslt_filter_commands
specifier|static
name|ngx_command_t
name|ngx_http_xslt_filter_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"xml_entities"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_xslt_entities
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"xslt_stylesheet"
argument_list|)
block|,
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_1MORE
block|,
name|ngx_http_xslt_stylesheet
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"xslt_types"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_1MORE
block|,
name|ngx_http_types_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_xslt_filter_loc_conf_t
argument_list|,
name|types_keys
argument_list|)
block|,
operator|&
name|ngx_http_xslt_default_types
index|[
literal|0
index|]
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_xslt_filter_module_ctx
specifier|static
name|ngx_http_module_t
name|ngx_http_xslt_filter_module_ctx
init|=
block|{
name|NULL
block|,
comment|/* preconfiguration */
name|ngx_http_xslt_filter_init
block|,
comment|/* postconfiguration */
name|ngx_http_xslt_filter_create_main_conf
block|,
comment|/* create main configuration */
name|NULL
block|,
comment|/* init main configuration */
name|NULL
block|,
comment|/* create server configuration */
name|NULL
block|,
comment|/* merge server configuration */
name|ngx_http_xslt_filter_create_conf
block|,
comment|/* create location configuration */
name|ngx_http_xslt_filter_merge_conf
comment|/* merge location configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_xslt_filter_module
name|ngx_module_t
name|ngx_http_xslt_filter_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_http_xslt_filter_module_ctx
block|,
comment|/* module context */
name|ngx_http_xslt_filter_commands
block|,
comment|/* module directives */
name|NGX_HTTP_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|NULL
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|ngx_http_xslt_filter_exit
block|,
comment|/* exit process */
name|ngx_http_xslt_filter_exit
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_next_header_filter
specifier|static
name|ngx_http_output_header_filter_pt
name|ngx_http_next_header_filter
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_next_body_filter
specifier|static
name|ngx_http_output_body_filter_pt
name|ngx_http_next_body_filter
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_xslt_header_filter (ngx_http_request_t * r)
name|ngx_http_xslt_header_filter
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_xslt_filter_loc_conf_t
modifier|*
name|conf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xslt filter header"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|status
operator|==
name|NGX_HTTP_NOT_MODIFIED
condition|)
block|{
return|return
name|ngx_http_next_header_filter
argument_list|(
name|r
argument_list|)
return|;
block|}
name|conf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_xslt_filter_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|sheets
operator|.
name|nelts
operator|==
literal|0
operator|||
name|ngx_http_test_content_type
argument_list|(
name|r
argument_list|,
operator|&
name|conf
operator|->
name|types
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|ngx_http_next_header_filter
argument_list|(
name|r
argument_list|)
return|;
block|}
name|ctx
operator|=
name|ngx_http_get_module_ctx
argument_list|(
name|r
argument_list|,
name|ngx_http_xslt_filter_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
condition|)
block|{
return|return
name|ngx_http_next_header_filter
argument_list|(
name|r
argument_list|)
return|;
block|}
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_xslt_filter_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_http_set_ctx
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|ngx_http_xslt_filter_module
argument_list|)
expr_stmt|;
name|r
operator|->
name|main_filter_need_in_memory
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_xslt_body_filter (ngx_http_request_t * r,ngx_chain_t * in)
name|ngx_http_xslt_body_filter
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_chain_t
modifier|*
name|in
parameter_list|)
block|{
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|;
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xslt filter body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
block|{
return|return
name|ngx_http_next_body_filter
argument_list|(
name|r
argument_list|,
name|in
argument_list|)
return|;
block|}
name|ctx
operator|=
name|ngx_http_get_module_ctx
argument_list|(
name|r
argument_list|,
name|ngx_http_xslt_filter_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
operator|||
name|ctx
operator|->
name|done
condition|)
block|{
return|return
name|ngx_http_next_body_filter
argument_list|(
name|r
argument_list|,
name|in
argument_list|)
return|;
block|}
for|for
control|(
name|cl
operator|=
name|in
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ngx_http_xslt_add_chunk
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|cl
operator|->
name|buf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|ctxt
operator|->
name|myDoc
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HTTP_XSLT_REUSE_DTD
operator|)
name|ctx
operator|->
name|ctxt
operator|->
name|myDoc
operator|->
name|extSubset
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|xmlFreeDoc
argument_list|(
name|ctx
operator|->
name|ctxt
operator|->
name|myDoc
argument_list|)
expr_stmt|;
block|}
name|xmlFreeParserCtxt
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|)
expr_stmt|;
return|return
name|ngx_http_xslt_send
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|NULL
argument_list|)
return|;
block|}
if|if
condition|(
name|cl
operator|->
name|buf
operator|->
name|last_buf
condition|)
block|{
name|ctx
operator|->
name|doc
operator|=
name|ctx
operator|->
name|ctxt
operator|->
name|myDoc
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_XSLT_REUSE_DTD
operator|)
name|ctx
operator|->
name|doc
operator|->
name|extSubset
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|xmlFreeParserCtxt
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|ctxt
operator|->
name|wellFormed
condition|)
block|{
return|return
name|ngx_http_xslt_send
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|ngx_http_xslt_apply_stylesheet
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
argument_list|)
return|;
block|}
name|xmlFreeDoc
argument_list|(
name|ctx
operator|->
name|doc
argument_list|)
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"not well formed XML document"
argument_list|)
expr_stmt|;
return|return
name|ngx_http_xslt_send
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|NULL
argument_list|)
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_xslt_send (ngx_http_request_t * r,ngx_http_xslt_filter_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_xslt_send
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_chain_t
name|out
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ctx
operator|->
name|done
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
return|return
name|ngx_http_filter_finalize_request
argument_list|(
name|r
argument_list|,
name|NULL
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
return|;
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|r
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
name|ngx_free
argument_list|(
name|b
operator|->
name|pos
argument_list|)
expr_stmt|;
return|return
name|ngx_http_filter_finalize_request
argument_list|(
name|r
argument_list|,
name|NULL
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
return|;
block|}
if|if
condition|(
name|r
operator|==
name|r
operator|->
expr|main
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|content_length_n
operator|=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|content_length
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|content_length
operator|->
name|hash
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_length
operator|=
name|NULL
expr_stmt|;
block|}
name|ngx_http_clear_last_modified
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
name|rc
operator|=
name|ngx_http_next_header_filter
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|>
name|NGX_OK
operator|||
name|r
operator|->
name|header_only
condition|)
block|{
name|ngx_free
argument_list|(
name|b
operator|->
name|pos
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_xslt_cleanup
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|b
operator|->
name|pos
expr_stmt|;
name|out
operator|.
name|buf
operator|=
name|b
expr_stmt|;
name|out
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
return|return
name|ngx_http_next_body_filter
argument_list|(
name|r
argument_list|,
operator|&
name|out
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_xslt_add_chunk (ngx_http_request_t * r,ngx_http_xslt_filter_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_xslt_add_chunk
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|xmlSAXHandler
modifier|*
name|sax
decl_stmt|;
name|xmlParserCtxtPtr
name|ctxt
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|ctxt
operator|==
name|NULL
condition|)
block|{
name|ctxt
operator|=
name|xmlCreatePushParserCtxt
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctxt
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xmlCreatePushParserCtxt() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|sax
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|xmlSAXHandler
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|sax
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|sax
operator|=
name|ctxt
operator|->
name|sax
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|ctx
operator|->
name|sax
argument_list|,
name|sax
argument_list|,
sizeof|sizeof
argument_list|(
name|xmlSAXHandler
argument_list|)
argument_list|)
expr_stmt|;
name|sax
operator|->
name|startDocument
operator|=
name|ngx_http_xslt_sax_start_document
expr_stmt|;
name|sax
operator|->
name|endDocument
operator|=
name|ngx_http_xslt_sax_end_document
expr_stmt|;
name|sax
operator|->
name|internalSubset
operator|=
name|ngx_http_xslt_sax_internal_subset
expr_stmt|;
name|sax
operator|->
name|externalSubset
operator|=
name|ngx_http_xslt_sax_external_subset
expr_stmt|;
name|sax
operator|->
name|entityDecl
operator|=
name|ngx_http_xslt_sax_entity_decl
expr_stmt|;
name|sax
operator|->
name|attributeDecl
operator|=
name|ngx_http_xslt_sax_attribute_decl
expr_stmt|;
name|sax
operator|->
name|elementDecl
operator|=
name|ngx_http_xslt_sax_element_decl
expr_stmt|;
name|sax
operator|->
name|notationDecl
operator|=
name|ngx_http_xslt_sax_notation_decl
expr_stmt|;
name|sax
operator|->
name|unparsedEntityDecl
operator|=
name|ngx_http_xslt_sax_unparsed_entity_decl
expr_stmt|;
name|sax
operator|->
name|setDocumentLocator
operator|=
name|NULL
expr_stmt|;
name|sax
operator|->
name|startElementNs
operator|=
name|ngx_http_xslt_sax_start_element
expr_stmt|;
name|sax
operator|->
name|endElementNs
operator|=
name|ngx_http_xslt_sax_end_element
expr_stmt|;
name|sax
operator|->
name|characters
operator|=
name|ngx_http_xslt_sax_characters
expr_stmt|;
name|sax
operator|->
name|ignorableWhitespace
operator|=
name|ngx_http_xslt_sax_characters
expr_stmt|;
name|sax
operator|->
name|cdataBlock
operator|=
name|ngx_http_xslt_sax_cdata_block
expr_stmt|;
name|sax
operator|->
name|getEntity
operator|=
name|ngx_http_xslt_sax_get_entity
expr_stmt|;
name|sax
operator|->
name|resolveEntity
operator|=
name|ngx_http_xslt_sax_resolve_entity
expr_stmt|;
name|sax
operator|->
name|getParameterEntity
operator|=
name|ngx_http_xslt_sax_get_parameter_entity
expr_stmt|;
name|sax
operator|->
name|reference
operator|=
name|ngx_http_xslt_sax_reference
expr_stmt|;
name|sax
operator|->
name|comment
operator|=
name|ngx_http_xslt_sax_comment
expr_stmt|;
name|sax
operator|->
name|processingInstruction
operator|=
name|ngx_http_xslt_sax_processing_instruction
expr_stmt|;
name|sax
operator|->
name|isStandalone
operator|=
name|ngx_http_xslt_sax_is_standalone
expr_stmt|;
name|sax
operator|->
name|hasInternalSubset
operator|=
name|ngx_http_xslt_sax_has_internal_subset
expr_stmt|;
name|sax
operator|->
name|hasExternalSubset
operator|=
name|ngx_http_xslt_sax_has_external_subset
expr_stmt|;
name|sax
operator|->
name|warning
operator|=
name|NULL
expr_stmt|;
name|sax
operator|->
name|error
operator|=
name|ngx_http_xslt_sax_error
expr_stmt|;
name|sax
operator|->
name|fatalError
operator|=
name|ngx_http_xslt_sax_error
expr_stmt|;
name|ctxt
operator|->
name|userData
operator|=
name|ctx
expr_stmt|;
name|ctxt
operator|->
name|replaceEntities
operator|=
literal|1
expr_stmt|;
name|ctxt
operator|->
name|loadsubset
operator|=
literal|1
expr_stmt|;
name|ctx
operator|->
name|ctxt
operator|=
name|ctxt
expr_stmt|;
name|ctx
operator|->
name|request
operator|=
name|r
expr_stmt|;
block|}
name|err
operator|=
name|xmlParseChunk
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
operator|(
name|char
operator|*
operator|)
name|b
operator|->
name|pos
argument_list|,
operator|(
name|int
operator|)
operator|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|)
argument_list|,
name|b
operator|->
name|last_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xmlParseChunk() failed, error:%d"
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_start_document (void * data)
name|ngx_http_xslt_sax_start_document
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|startDocument
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_end_document (void * data)
name|ngx_http_xslt_sax_end_document
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|endDocument
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_internal_subset (void * data,const xmlChar * name,const xmlChar * externalId,const xmlChar * systemId)
name|ngx_http_xslt_sax_internal_subset
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|externalId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|internalSubset
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|name
argument_list|,
name|externalId
argument_list|,
name|systemId
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_external_subset (void * data,const xmlChar * name,const xmlChar * externalId,const xmlChar * systemId)
name|ngx_http_xslt_sax_external_subset
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|externalId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|xmlDocPtr
name|doc
decl_stmt|;
name|xmlDtdPtr
name|dtd
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_xslt_filter_loc_conf_t
modifier|*
name|conf
decl_stmt|;
name|r
operator|=
name|ctx
operator|->
name|request
expr_stmt|;
name|conf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_xslt_filter_module
argument_list|)
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xslt filter extSubset: \"%s\" \"%s\" \"%s\""
argument_list|,
name|name
condition|?
name|name
else|:
operator|(
name|xmlChar
operator|*
operator|)
literal|""
argument_list|,
name|externalId
condition|?
name|externalId
else|:
operator|(
name|xmlChar
operator|*
operator|)
literal|""
argument_list|,
name|systemId
condition|?
name|systemId
else|:
operator|(
name|xmlChar
operator|*
operator|)
literal|""
argument_list|)
expr_stmt|;
name|doc
operator|=
name|ctx
operator|->
name|ctxt
operator|->
name|myDoc
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_XSLT_REUSE_DTD
operator|)
name|dtd
operator|=
name|conf
operator|->
name|dtd
expr_stmt|;
else|#
directive|else
name|dtd
operator|=
name|xmlCopyDtd
argument_list|(
name|conf
operator|->
name|dtd
argument_list|)
expr_stmt|;
if|if
condition|(
name|dtd
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xmlCopyDtd() failed"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|doc
operator|->
name|children
operator|==
name|NULL
condition|)
block|{
name|xmlAddChild
argument_list|(
operator|(
name|xmlNodePtr
operator|)
name|doc
argument_list|,
operator|(
name|xmlNodePtr
operator|)
name|dtd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xmlAddPrevSibling
argument_list|(
name|doc
operator|->
name|children
argument_list|,
operator|(
name|xmlNodePtr
operator|)
name|dtd
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|doc
operator|->
name|extSubset
operator|=
name|dtd
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_entity_decl (void * data,const xmlChar * name,int type,const xmlChar * publicId,const xmlChar * systemId,xmlChar * content)
name|ngx_http_xslt_sax_entity_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
name|int
name|type
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|publicId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|,
name|xmlChar
modifier|*
name|content
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|entityDecl
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|publicId
argument_list|,
name|systemId
argument_list|,
name|content
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_attribute_decl (void * data,const xmlChar * elem,const xmlChar * fullname,int type,int def,const xmlChar * defaultValue,xmlEnumerationPtr tree)
name|ngx_http_xslt_sax_attribute_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|elem
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|fullname
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|def
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|defaultValue
parameter_list|,
name|xmlEnumerationPtr
name|tree
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|attributeDecl
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|elem
argument_list|,
name|fullname
argument_list|,
name|type
argument_list|,
name|def
argument_list|,
name|defaultValue
argument_list|,
name|tree
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_element_decl (void * data,const xmlChar * name,int type,xmlElementContentPtr content)
name|ngx_http_xslt_sax_element_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
name|int
name|type
parameter_list|,
name|xmlElementContentPtr
name|content
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|elementDecl
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|content
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_notation_decl (void * data,const xmlChar * name,const xmlChar * publicId,const xmlChar * systemId)
name|ngx_http_xslt_sax_notation_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|publicId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|notationDecl
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|name
argument_list|,
name|publicId
argument_list|,
name|systemId
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_unparsed_entity_decl (void * data,const xmlChar * name,const xmlChar * publicId,const xmlChar * systemId,const xmlChar * notationName)
name|ngx_http_xslt_sax_unparsed_entity_decl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|publicId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|notationName
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|unparsedEntityDecl
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|name
argument_list|,
name|publicId
argument_list|,
name|systemId
argument_list|,
name|notationName
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_start_element (void * data,const xmlChar * localname,const xmlChar * prefix,const xmlChar * URI,int nb_namespaces,const xmlChar ** namespaces,int nb_attributes,int nb_defaulted,const xmlChar ** attributes)
name|ngx_http_xslt_sax_start_element
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|localname
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|prefix
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|URI
parameter_list|,
name|int
name|nb_namespaces
parameter_list|,
specifier|const
name|xmlChar
modifier|*
modifier|*
name|namespaces
parameter_list|,
name|int
name|nb_attributes
parameter_list|,
name|int
name|nb_defaulted
parameter_list|,
specifier|const
name|xmlChar
modifier|*
modifier|*
name|attributes
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|startElementNs
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|localname
argument_list|,
name|prefix
argument_list|,
name|URI
argument_list|,
name|nb_namespaces
argument_list|,
name|namespaces
argument_list|,
name|nb_attributes
argument_list|,
name|nb_defaulted
argument_list|,
name|attributes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_end_element (void * data,const xmlChar * localname ATTRIBUTE_UNUSED,const xmlChar * prefix ATTRIBUTE_UNUSED,const xmlChar * URI ATTRIBUTE_UNUSED)
name|ngx_http_xslt_sax_end_element
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|localname
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|prefix
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|URI
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|endElementNs
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|localname
argument_list|,
name|prefix
argument_list|,
name|URI
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_characters (void * data,const xmlChar * p,int len)
name|ngx_http_xslt_sax_characters
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|characters
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_cdata_block (void * data,const xmlChar * p,int len)
name|ngx_http_xslt_sax_cdata_block
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|cdataBlock
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|xmlEntityPtr
DECL|function|ngx_http_xslt_sax_get_entity (void * data,const xmlChar * name)
name|ngx_http_xslt_sax_get_entity
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
return|return
name|ctx
operator|->
name|sax
operator|->
name|getEntity
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|xmlEntityPtr
DECL|function|ngx_http_xslt_sax_get_parameter_entity (void * data,const xmlChar * name)
name|ngx_http_xslt_sax_get_parameter_entity
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
return|return
name|ctx
operator|->
name|sax
operator|->
name|getParameterEntity
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|xmlParserInputPtr
DECL|function|ngx_http_xslt_sax_resolve_entity (void * data,const xmlChar * publicId,const xmlChar * systemId)
name|ngx_http_xslt_sax_resolve_entity
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|publicId
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|systemId
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
return|return
name|ctx
operator|->
name|sax
operator|->
name|resolveEntity
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|publicId
argument_list|,
name|systemId
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_reference (void * data,const xmlChar * name)
name|ngx_http_xslt_sax_reference
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|name
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|reference
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_comment (void * data,const xmlChar * value)
name|ngx_http_xslt_sax_comment
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|value
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|comment
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_sax_processing_instruction (void * data,const xmlChar * target,const xmlChar * pidata)
name|ngx_http_xslt_sax_processing_instruction
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|target
parameter_list|,
specifier|const
name|xmlChar
modifier|*
name|pidata
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ctx
operator|->
name|sax
operator|->
name|processingInstruction
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|,
name|target
argument_list|,
name|pidata
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|ngx_http_xslt_sax_is_standalone (void * data)
name|ngx_http_xslt_sax_is_standalone
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
return|return
name|ctx
operator|->
name|sax
operator|->
name|isStandalone
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|ngx_http_xslt_sax_has_internal_subset (void * data)
name|ngx_http_xslt_sax_has_internal_subset
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
return|return
name|ctx
operator|->
name|sax
operator|->
name|hasInternalSubset
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
DECL|function|ngx_http_xslt_sax_has_external_subset (void * data)
name|ngx_http_xslt_sax_has_external_subset
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
return|return
name|ctx
operator|->
name|sax
operator|->
name|hasExternalSubset
argument_list|(
name|ctx
operator|->
name|ctxt
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ngx_cdecl
DECL|function|ngx_http_xslt_sax_error (void * data,const char * msg,...)
name|ngx_http_xslt_sax_error
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|,
modifier|...
parameter_list|)
block|{
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|size_t
name|n
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|u_char
name|buf
index|[
name|NGX_MAX_ERROR_STR
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|size_t
operator|)
name|vsnprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|NGX_MAX_ERROR_STR
argument_list|,
name|msg
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|n
operator|&&
operator|(
name|buf
index|[
name|n
index|]
operator|==
name|CR
operator|||
name|buf
index|[
name|n
index|]
operator|==
name|LF
operator|)
condition|)
block|{
comment|/* void */
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|ctx
operator|->
name|request
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"libxml2 error: \"%*s\""
argument_list|,
name|n
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_buf_t
modifier|*
DECL|function|ngx_http_xslt_apply_stylesheet (ngx_http_request_t * r,ngx_http_xslt_filter_ctx_t * ctx)
name|ngx_http_xslt_apply_stylesheet
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|rc
decl_stmt|,
name|doc_type
decl_stmt|;
name|u_char
modifier|*
name|type
decl_stmt|,
modifier|*
name|encoding
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|xmlChar
modifier|*
name|buf
decl_stmt|;
name|xmlDocPtr
name|doc
decl_stmt|,
name|res
decl_stmt|;
name|ngx_http_xslt_sheet_t
modifier|*
name|sheet
decl_stmt|;
name|ngx_http_xslt_filter_loc_conf_t
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_xslt_filter_module
argument_list|)
expr_stmt|;
name|sheet
operator|=
name|conf
operator|->
name|sheets
operator|.
name|elts
expr_stmt|;
name|doc
operator|=
name|ctx
operator|->
name|doc
expr_stmt|;
comment|/* preallocate array for 4 params */
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|ctx
operator|->
name|params
argument_list|,
name|r
operator|->
name|pool
argument_list|,
literal|4
operator|*
literal|2
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|xmlFreeDoc
argument_list|(
name|doc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|sheets
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_http_xslt_params
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
operator|&
name|sheet
index|[
name|i
index|]
operator|.
name|params
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|xmlFreeDoc
argument_list|(
name|doc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|xsltApplyStylesheet
argument_list|(
name|sheet
index|[
name|i
index|]
operator|.
name|stylesheet
argument_list|,
name|doc
argument_list|,
name|ctx
operator|->
name|params
operator|.
name|elts
argument_list|)
expr_stmt|;
name|xmlFreeDoc
argument_list|(
name|doc
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xsltApplyStylesheet() failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|doc
operator|=
name|res
expr_stmt|;
comment|/* reset array elements */
name|ctx
operator|->
name|params
operator|.
name|nelts
operator|=
literal|0
expr_stmt|;
block|}
comment|/* there must be at least one stylesheet */
if|if
condition|(
name|r
operator|==
name|r
operator|->
expr|main
condition|)
block|{
name|type
operator|=
name|ngx_http_xslt_content_type
argument_list|(
name|sheet
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|stylesheet
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|type
operator|=
name|NULL
expr_stmt|;
block|}
name|encoding
operator|=
name|ngx_http_xslt_encoding
argument_list|(
name|sheet
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|stylesheet
argument_list|)
expr_stmt|;
name|doc_type
operator|=
name|doc
operator|->
name|type
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xslt filter type: %d t:%s e:%s"
argument_list|,
name|doc_type
argument_list|,
name|type
condition|?
name|type
else|:
operator|(
name|u_char
operator|*
operator|)
literal|"(null)"
argument_list|,
name|encoding
condition|?
name|encoding
else|:
operator|(
name|u_char
operator|*
operator|)
literal|"(null)"
argument_list|)
expr_stmt|;
name|rc
operator|=
name|xsltSaveResultToString
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|doc
argument_list|,
name|sheet
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|stylesheet
argument_list|)
expr_stmt|;
name|xmlFreeDoc
argument_list|(
name|doc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xsltSaveResultToString() failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xsltSaveResultToString() returned zero-length result"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|b
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_buf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
name|ngx_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|b
operator|->
name|pos
operator|=
name|buf
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|buf
operator|+
name|len
expr_stmt|;
name|b
operator|->
name|memory
operator|=
literal|1
expr_stmt|;
name|b
operator|->
name|last_buf
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|encoding
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|charset
operator|.
name|len
operator|=
name|ngx_strlen
argument_list|(
name|encoding
argument_list|)
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|charset
operator|.
name|data
operator|=
name|encoding
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|!=
name|r
operator|->
expr|main
condition|)
block|{
return|return
name|b
return|;
block|}
if|if
condition|(
name|type
condition|)
block|{
name|len
operator|=
name|ngx_strlen
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_type_len
operator|=
name|len
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_type
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_type
operator|.
name|data
operator|=
name|type
expr_stmt|;
block|}
if|else if
condition|(
name|doc_type
operator|==
name|XML_HTML_DOCUMENT_NODE
condition|)
block|{
name|r
operator|->
name|headers_out
operator|.
name|content_type_len
operator|=
sizeof|sizeof
argument_list|(
literal|"text/html"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_type
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"text/html"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_type
operator|.
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"text/html"
expr_stmt|;
block|}
name|r
operator|->
name|headers_out
operator|.
name|content_type_lowcase
operator|=
name|NULL
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_xslt_params (ngx_http_request_t * r,ngx_http_xslt_filter_ctx_t * ctx,ngx_array_t * params)
name|ngx_http_xslt_params
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_xslt_filter_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_array_t
modifier|*
name|params
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|,
modifier|*
name|value
decl_stmt|,
modifier|*
name|dst
decl_stmt|,
modifier|*
name|src
decl_stmt|,
modifier|*
modifier|*
name|s
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_str_t
name|string
decl_stmt|;
name|ngx_http_complex_value_t
modifier|*
name|param
decl_stmt|;
name|param
operator|=
name|params
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|params
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_http_complex_value
argument_list|(
name|r
argument_list|,
operator|&
name|param
index|[
name|i
index|]
argument_list|,
operator|&
name|string
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xslt filter param: \"%s\""
argument_list|,
name|string
operator|.
name|data
argument_list|)
expr_stmt|;
name|p
operator|=
name|string
operator|.
name|data
expr_stmt|;
name|last
operator|=
name|string
operator|.
name|data
operator|+
name|string
operator|.
name|len
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|p
operator|&&
operator|*
name|p
condition|)
block|{
name|value
operator|=
name|p
expr_stmt|;
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ngx_strchr
argument_list|(
name|p
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"invalid libxslt parameter \"%s\""
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xslt filter param name: \"%s\""
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|s
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|ctx
operator|->
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|s
operator|=
name|value
expr_stmt|;
name|value
operator|=
name|p
expr_stmt|;
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ngx_strchr
argument_list|(
name|p
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|len
operator|=
name|p
operator|-
name|value
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
name|last
operator|-
name|value
expr_stmt|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xslt filter param value: \"%s\""
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|dst
operator|=
name|value
expr_stmt|;
name|src
operator|=
name|value
expr_stmt|;
name|ngx_unescape_uri
argument_list|(
operator|&
name|dst
argument_list|,
operator|&
name|src
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|dst
operator|=
literal|'\0'
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"xslt filter param unescaped: \"%s\""
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|s
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|ctx
operator|->
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|s
operator|=
name|value
expr_stmt|;
block|}
block|}
name|s
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|ctx
operator|->
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|s
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_xslt_content_type (xsltStylesheetPtr s)
name|ngx_http_xslt_content_type
parameter_list|(
name|xsltStylesheetPtr
name|s
parameter_list|)
block|{
name|u_char
modifier|*
name|type
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|mediaType
condition|)
block|{
return|return
name|s
operator|->
name|mediaType
return|;
block|}
for|for
control|(
name|s
operator|=
name|s
operator|->
name|imports
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
name|type
operator|=
name|ngx_http_xslt_content_type
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
condition|)
block|{
return|return
name|type
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_xslt_encoding (xsltStylesheetPtr s)
name|ngx_http_xslt_encoding
parameter_list|(
name|xsltStylesheetPtr
name|s
parameter_list|)
block|{
name|u_char
modifier|*
name|encoding
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|encoding
condition|)
block|{
return|return
name|s
operator|->
name|encoding
return|;
block|}
for|for
control|(
name|s
operator|=
name|s
operator|->
name|imports
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
name|encoding
operator|=
name|ngx_http_xslt_encoding
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|encoding
condition|)
block|{
return|return
name|encoding
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_cleanup (void * data)
name|ngx_http_xslt_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_xslt_entities (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_xslt_entities
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_xslt_filter_loc_conf_t
modifier|*
name|xlcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ngx_http_xslt_file_t
modifier|*
name|file
decl_stmt|;
name|ngx_http_xslt_filter_main_conf_t
modifier|*
name|xmcf
decl_stmt|;
if|if
condition|(
name|xlcf
operator|->
name|dtd
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|xmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_xslt_filter_module
argument_list|)
expr_stmt|;
name|file
operator|=
name|xmcf
operator|->
name|dtd_files
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|xmcf
operator|->
name|dtd_files
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|file
index|[
name|i
index|]
operator|.
name|name
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|)
operator|==
literal|0
condition|)
block|{
name|xlcf
operator|->
name|dtd
operator|=
name|file
index|[
name|i
index|]
operator|.
name|data
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|xlcf
operator|->
name|dtd
operator|=
name|xmlParseDTD
argument_list|(
name|NULL
argument_list|,
operator|(
name|xmlChar
operator|*
operator|)
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|xlcf
operator|->
name|dtd
operator|==
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"xmlParseDTD() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_xslt_cleanup_dtd
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|xlcf
operator|->
name|dtd
expr_stmt|;
name|file
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|xmcf
operator|->
name|dtd_files
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|file
operator|->
name|name
operator|=
name|value
index|[
literal|1
index|]
operator|.
name|data
expr_stmt|;
name|file
operator|->
name|data
operator|=
name|xlcf
operator|->
name|dtd
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_xslt_stylesheet (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_xslt_stylesheet
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_xslt_filter_loc_conf_t
modifier|*
name|xlcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ngx_http_xslt_file_t
modifier|*
name|file
decl_stmt|;
name|ngx_http_xslt_sheet_t
modifier|*
name|sheet
decl_stmt|;
name|ngx_http_complex_value_t
modifier|*
name|param
decl_stmt|;
name|ngx_http_compile_complex_value_t
name|ccv
decl_stmt|;
name|ngx_http_xslt_filter_main_conf_t
modifier|*
name|xmcf
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
if|if
condition|(
name|xlcf
operator|->
name|sheets
operator|.
name|elts
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|xlcf
operator|->
name|sheets
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_xslt_sheet_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|sheet
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|xlcf
operator|->
name|sheets
argument_list|)
expr_stmt|;
if|if
condition|(
name|sheet
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
name|sheet
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_xslt_sheet_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_conf_full_name
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|xmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_xslt_filter_module
argument_list|)
expr_stmt|;
name|file
operator|=
name|xmcf
operator|->
name|sheet_files
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|xmcf
operator|->
name|sheet_files
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|file
index|[
name|i
index|]
operator|.
name|name
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sheet
operator|->
name|stylesheet
operator|=
name|file
index|[
name|i
index|]
operator|.
name|data
expr_stmt|;
goto|goto
name|found
goto|;
block|}
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|sheet
operator|->
name|stylesheet
operator|=
name|xsltParseStylesheetFile
argument_list|(
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|sheet
operator|->
name|stylesheet
operator|==
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"xsltParseStylesheetFile(\"%s\") failed"
argument_list|,
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_xslt_cleanup_stylesheet
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|sheet
operator|->
name|stylesheet
expr_stmt|;
name|file
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|xmcf
operator|->
name|sheet_files
argument_list|)
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|file
operator|->
name|name
operator|=
name|value
index|[
literal|1
index|]
operator|.
name|data
expr_stmt|;
name|file
operator|->
name|data
operator|=
name|sheet
operator|->
name|stylesheet
expr_stmt|;
name|found
label|:
name|n
operator|=
name|cf
operator|->
name|args
operator|->
name|nelts
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|2
condition|)
block|{
return|return
name|NGX_CONF_OK
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|sheet
operator|->
name|params
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
name|n
operator|-
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_complex_value_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|param
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|sheet
operator|->
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|ccv
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_compile_complex_value_t
argument_list|)
argument_list|)
expr_stmt|;
name|ccv
operator|.
name|cf
operator|=
name|cf
expr_stmt|;
name|ccv
operator|.
name|value
operator|=
operator|&
name|value
index|[
name|i
index|]
expr_stmt|;
name|ccv
operator|.
name|complex_value
operator|=
name|param
expr_stmt|;
name|ccv
operator|.
name|zero
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_http_compile_complex_value
argument_list|(
operator|&
name|ccv
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_cleanup_dtd (void * data)
name|ngx_http_xslt_cleanup_dtd
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|xmlFreeDtd
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_cleanup_stylesheet (void * data)
name|ngx_http_xslt_cleanup_stylesheet
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|xsltFreeStylesheet
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_xslt_filter_create_main_conf (ngx_conf_t * cf)
name|ngx_http_xslt_filter_create_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_xslt_filter_main_conf_t
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_xslt_filter_main_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|conf
operator|->
name|dtd_files
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_xslt_file_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|conf
operator|->
name|sheet_files
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_xslt_file_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_xslt_filter_create_conf (ngx_conf_t * cf)
name|ngx_http_xslt_filter_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_xslt_filter_loc_conf_t
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_xslt_filter_loc_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
comment|/*      * set by ngx_pcalloc():      *      *     conf->dtd = NULL;      *     conf->sheets = { NULL };      *     conf->types = { NULL };      *     conf->types_keys = NULL;      */
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_xslt_filter_merge_conf (ngx_conf_t * cf,void * parent,void * child)
name|ngx_http_xslt_filter_merge_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
block|{
name|ngx_http_xslt_filter_loc_conf_t
modifier|*
name|prev
init|=
name|parent
decl_stmt|;
name|ngx_http_xslt_filter_loc_conf_t
modifier|*
name|conf
init|=
name|child
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|dtd
operator|==
name|NULL
condition|)
block|{
name|conf
operator|->
name|dtd
operator|=
name|prev
operator|->
name|dtd
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|sheets
operator|.
name|nelts
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|sheets
operator|=
name|prev
operator|->
name|sheets
expr_stmt|;
block|}
if|if
condition|(
name|ngx_http_merge_types
argument_list|(
name|cf
argument_list|,
name|conf
operator|->
name|types_keys
argument_list|,
operator|&
name|conf
operator|->
name|types
argument_list|,
name|prev
operator|->
name|types_keys
argument_list|,
operator|&
name|prev
operator|->
name|types
argument_list|,
name|ngx_http_xslt_default_types
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_xslt_filter_init (ngx_conf_t * cf)
name|ngx_http_xslt_filter_init
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|xmlInitParser
argument_list|()
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_EXSLT
operator|)
name|exsltRegisterAll
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|ngx_http_next_header_filter
operator|=
name|ngx_http_top_header_filter
expr_stmt|;
name|ngx_http_top_header_filter
operator|=
name|ngx_http_xslt_header_filter
expr_stmt|;
name|ngx_http_next_body_filter
operator|=
name|ngx_http_top_body_filter
expr_stmt|;
name|ngx_http_top_body_filter
operator|=
name|ngx_http_xslt_body_filter
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_xslt_filter_exit (ngx_cycle_t * cycle)
name|ngx_http_xslt_filter_exit
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
block|{
name|xsltCleanupGlobals
argument_list|()
expr_stmt|;
name|xmlCleanupParser
argument_list|()
expr_stmt|;
block|}
end_function

end_unit

