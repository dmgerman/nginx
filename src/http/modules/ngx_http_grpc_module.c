begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Maxim Dounin  * Copyright (C) Nginx, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_typedef
DECL|struct|__anon2c2debe70108
typedef|typedef
struct|struct
block|{
DECL|member|flushes
name|ngx_array_t
modifier|*
name|flushes
decl_stmt|;
DECL|member|lengths
name|ngx_array_t
modifier|*
name|lengths
decl_stmt|;
DECL|member|values
name|ngx_array_t
modifier|*
name|values
decl_stmt|;
DECL|member|hash
name|ngx_hash_t
name|hash
decl_stmt|;
DECL|typedef|ngx_http_grpc_headers_t
block|}
name|ngx_http_grpc_headers_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c2debe70208
typedef|typedef
struct|struct
block|{
DECL|member|upstream
name|ngx_http_upstream_conf_t
name|upstream
decl_stmt|;
DECL|member|headers
name|ngx_http_grpc_headers_t
name|headers
decl_stmt|;
DECL|member|headers_source
name|ngx_array_t
modifier|*
name|headers_source
decl_stmt|;
DECL|member|host
name|ngx_str_t
name|host
decl_stmt|;
DECL|member|host_set
name|ngx_uint_t
name|host_set
decl_stmt|;
DECL|member|grpc_lengths
name|ngx_array_t
modifier|*
name|grpc_lengths
decl_stmt|;
DECL|member|grpc_values
name|ngx_array_t
modifier|*
name|grpc_values
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
DECL|member|ssl
name|ngx_uint_t
name|ssl
decl_stmt|;
DECL|member|ssl_protocols
name|ngx_uint_t
name|ssl_protocols
decl_stmt|;
DECL|member|ssl_ciphers
name|ngx_str_t
name|ssl_ciphers
decl_stmt|;
DECL|member|ssl_verify_depth
name|ngx_uint_t
name|ssl_verify_depth
decl_stmt|;
DECL|member|ssl_trusted_certificate
name|ngx_str_t
name|ssl_trusted_certificate
decl_stmt|;
DECL|member|ssl_crl
name|ngx_str_t
name|ssl_crl
decl_stmt|;
DECL|member|ssl_conf_commands
name|ngx_array_t
modifier|*
name|ssl_conf_commands
decl_stmt|;
endif|#
directive|endif
DECL|typedef|ngx_http_grpc_loc_conf_t
block|}
name|ngx_http_grpc_loc_conf_t
typedef|;
end_typedef

begin_typedef
DECL|enum|__anon2c2debe70303
typedef|typedef
enum|enum
block|{
DECL|enumerator|ngx_http_grpc_st_start
name|ngx_http_grpc_st_start
init|=
literal|0
block|,
DECL|enumerator|ngx_http_grpc_st_length_2
name|ngx_http_grpc_st_length_2
block|,
DECL|enumerator|ngx_http_grpc_st_length_3
name|ngx_http_grpc_st_length_3
block|,
DECL|enumerator|ngx_http_grpc_st_type
name|ngx_http_grpc_st_type
block|,
DECL|enumerator|ngx_http_grpc_st_flags
name|ngx_http_grpc_st_flags
block|,
DECL|enumerator|ngx_http_grpc_st_stream_id
name|ngx_http_grpc_st_stream_id
block|,
DECL|enumerator|ngx_http_grpc_st_stream_id_2
name|ngx_http_grpc_st_stream_id_2
block|,
DECL|enumerator|ngx_http_grpc_st_stream_id_3
name|ngx_http_grpc_st_stream_id_3
block|,
DECL|enumerator|ngx_http_grpc_st_stream_id_4
name|ngx_http_grpc_st_stream_id_4
block|,
DECL|enumerator|ngx_http_grpc_st_payload
name|ngx_http_grpc_st_payload
block|,
DECL|enumerator|ngx_http_grpc_st_padding
name|ngx_http_grpc_st_padding
DECL|typedef|ngx_http_grpc_state_e
block|}
name|ngx_http_grpc_state_e
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c2debe70408
typedef|typedef
struct|struct
block|{
DECL|member|init_window
name|size_t
name|init_window
decl_stmt|;
DECL|member|send_window
name|size_t
name|send_window
decl_stmt|;
DECL|member|recv_window
name|size_t
name|recv_window
decl_stmt|;
DECL|member|last_stream_id
name|ngx_uint_t
name|last_stream_id
decl_stmt|;
DECL|typedef|ngx_http_grpc_conn_t
block|}
name|ngx_http_grpc_conn_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c2debe70508
typedef|typedef
struct|struct
block|{
DECL|member|state
name|ngx_http_grpc_state_e
name|state
decl_stmt|;
DECL|member|frame_state
name|ngx_uint_t
name|frame_state
decl_stmt|;
DECL|member|fragment_state
name|ngx_uint_t
name|fragment_state
decl_stmt|;
DECL|member|in
name|ngx_chain_t
modifier|*
name|in
decl_stmt|;
DECL|member|out
name|ngx_chain_t
modifier|*
name|out
decl_stmt|;
DECL|member|free
name|ngx_chain_t
modifier|*
name|free
decl_stmt|;
DECL|member|busy
name|ngx_chain_t
modifier|*
name|busy
decl_stmt|;
DECL|member|connection
name|ngx_http_grpc_conn_t
modifier|*
name|connection
decl_stmt|;
DECL|member|id
name|ngx_uint_t
name|id
decl_stmt|;
DECL|member|pings
name|ngx_uint_t
name|pings
decl_stmt|;
DECL|member|settings
name|ngx_uint_t
name|settings
decl_stmt|;
DECL|member|length
name|off_t
name|length
decl_stmt|;
DECL|member|send_window
name|ssize_t
name|send_window
decl_stmt|;
DECL|member|recv_window
name|size_t
name|recv_window
decl_stmt|;
DECL|member|rest
name|size_t
name|rest
decl_stmt|;
DECL|member|stream_id
name|ngx_uint_t
name|stream_id
decl_stmt|;
DECL|member|type
name|u_char
name|type
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
decl_stmt|;
DECL|member|padding
name|u_char
name|padding
decl_stmt|;
DECL|member|error
name|ngx_uint_t
name|error
decl_stmt|;
DECL|member|window_update
name|ngx_uint_t
name|window_update
decl_stmt|;
DECL|member|setting_id
name|ngx_uint_t
name|setting_id
decl_stmt|;
DECL|member|setting_value
name|ngx_uint_t
name|setting_value
decl_stmt|;
DECL|member|ping_data
name|u_char
name|ping_data
index|[
literal|8
index|]
decl_stmt|;
DECL|member|index
name|ngx_uint_t
name|index
decl_stmt|;
DECL|member|name
name|ngx_str_t
name|name
decl_stmt|;
DECL|member|value
name|ngx_str_t
name|value
decl_stmt|;
DECL|member|field_end
name|u_char
modifier|*
name|field_end
decl_stmt|;
DECL|member|field_length
name|size_t
name|field_length
decl_stmt|;
DECL|member|field_rest
name|size_t
name|field_rest
decl_stmt|;
DECL|member|field_state
name|u_char
name|field_state
decl_stmt|;
DECL|member|literal
name|unsigned
name|literal
range|:
literal|1
decl_stmt|;
DECL|member|field_huffman
name|unsigned
name|field_huffman
range|:
literal|1
decl_stmt|;
DECL|member|header_sent
name|unsigned
name|header_sent
range|:
literal|1
decl_stmt|;
DECL|member|output_closed
name|unsigned
name|output_closed
range|:
literal|1
decl_stmt|;
DECL|member|output_blocked
name|unsigned
name|output_blocked
range|:
literal|1
decl_stmt|;
DECL|member|parsing_headers
name|unsigned
name|parsing_headers
range|:
literal|1
decl_stmt|;
DECL|member|end_stream
name|unsigned
name|end_stream
range|:
literal|1
decl_stmt|;
DECL|member|done
name|unsigned
name|done
range|:
literal|1
decl_stmt|;
DECL|member|status
name|unsigned
name|status
range|:
literal|1
decl_stmt|;
DECL|member|rst
name|unsigned
name|rst
range|:
literal|1
decl_stmt|;
DECL|member|goaway
name|unsigned
name|goaway
range|:
literal|1
decl_stmt|;
DECL|member|request
name|ngx_http_request_t
modifier|*
name|request
decl_stmt|;
DECL|member|host
name|ngx_str_t
name|host
decl_stmt|;
DECL|typedef|ngx_http_grpc_ctx_t
block|}
name|ngx_http_grpc_ctx_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c2debe70608
typedef|typedef
struct|struct
block|{
DECL|member|length_0
name|u_char
name|length_0
decl_stmt|;
DECL|member|length_1
name|u_char
name|length_1
decl_stmt|;
DECL|member|length_2
name|u_char
name|length_2
decl_stmt|;
DECL|member|type
name|u_char
name|type
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
decl_stmt|;
DECL|member|stream_id_0
name|u_char
name|stream_id_0
decl_stmt|;
DECL|member|stream_id_1
name|u_char
name|stream_id_1
decl_stmt|;
DECL|member|stream_id_2
name|u_char
name|stream_id_2
decl_stmt|;
DECL|member|stream_id_3
name|u_char
name|stream_id_3
decl_stmt|;
DECL|typedef|ngx_http_grpc_frame_t
block|}
name|ngx_http_grpc_frame_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_eval
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_http_grpc_loc_conf_t
modifier|*
name|glcf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_create_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_reinit_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_body_output_filter
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|ngx_chain_t
modifier|*
name|in
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_process_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_filter_init
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_filter
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|ssize_t
name|bytes
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_parse_frame
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_parse_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_parse_fragment
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_validate_header_name
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_validate_header_value
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_parse_rst_stream
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_parse_goaway
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_parse_window_update
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_parse_settings
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_parse_ping
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_send_settings_ack
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_send_ping_ack
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_send_window_update
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_chain_t
modifier|*
name|ngx_http_grpc_get_buf
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_grpc_ctx_t
modifier|*
name|ngx_http_grpc_get_ctx
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_get_connection_data
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_peer_connection_t
modifier|*
name|pc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_grpc_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_grpc_abort_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_grpc_finalize_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_int_t
name|rc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_internal_trailers_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_add_variables
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_grpc_create_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_grpc_merge_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_init_headers
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_grpc_loc_conf_t
modifier|*
name|conf
parameter_list|,
name|ngx_http_grpc_headers_t
modifier|*
name|headers
parameter_list|,
name|ngx_keyval_t
modifier|*
name|default_headers
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_grpc_pass
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
end_if

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_grpc_ssl_password_file
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_grpc_ssl_conf_command_check
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|post
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_grpc_set_ssl
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_grpc_loc_conf_t
modifier|*
name|glcf
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
DECL|variable|ngx_http_grpc_next_upstream_masks
specifier|static
name|ngx_conf_bitmask_t
name|ngx_http_grpc_next_upstream_masks
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"error"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_ERROR
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"timeout"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_TIMEOUT
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"invalid_header"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_INVALID_HEADER
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"non_idempotent"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_NON_IDEMPOTENT
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_500"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_500
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_502"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_502
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_503"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_503
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_504"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_504
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_403"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_403
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_404"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_404
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_429"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_HTTP_429
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"off"
argument_list|)
block|,
name|NGX_HTTP_UPSTREAM_FT_OFF
block|}
block|,
block|{
name|ngx_null_string
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
end_if

begin_decl_stmt
DECL|variable|ngx_http_grpc_ssl_protocols
specifier|static
name|ngx_conf_bitmask_t
name|ngx_http_grpc_ssl_protocols
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"SSLv2"
argument_list|)
block|,
name|NGX_SSL_SSLv2
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"SSLv3"
argument_list|)
block|,
name|NGX_SSL_SSLv3
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"TLSv1"
argument_list|)
block|,
name|NGX_SSL_TLSv1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"TLSv1.1"
argument_list|)
block|,
name|NGX_SSL_TLSv1_1
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"TLSv1.2"
argument_list|)
block|,
name|NGX_SSL_TLSv1_2
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"TLSv1.3"
argument_list|)
block|,
name|NGX_SSL_TLSv1_3
block|}
block|,
block|{
name|ngx_null_string
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_grpc_ssl_conf_command_post
specifier|static
name|ngx_conf_post_t
name|ngx_http_grpc_ssl_conf_command_post
init|=
block|{
name|ngx_http_grpc_ssl_conf_command_check
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
DECL|variable|ngx_http_grpc_commands
specifier|static
name|ngx_command_t
name|ngx_http_grpc_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"grpc_pass"
argument_list|)
block|,
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_HTTP_LIF_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_grpc_pass
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_bind"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE12
block|,
name|ngx_http_upstream_bind_set_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|local
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_socket_keepalive"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|socket_keepalive
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_connect_timeout"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|connect_timeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_send_timeout"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|send_timeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_intercept_errors"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|intercept_errors
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_buffer_size"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_size_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|buffer_size
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_read_timeout"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|read_timeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_next_upstream"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_1MORE
block|,
name|ngx_conf_set_bitmask_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|next_upstream
argument_list|)
block|,
operator|&
name|ngx_http_grpc_next_upstream_masks
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_next_upstream_tries"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_num_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|next_upstream_tries
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_next_upstream_timeout"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_msec_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|next_upstream_timeout
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_set_header"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE2
block|,
name|ngx_conf_set_keyval_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|headers_source
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_pass_header"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_array_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|pass_headers
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_hide_header"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_array_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|hide_headers
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ignore_headers"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_1MORE
block|,
name|ngx_conf_set_bitmask_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|ignore_headers
argument_list|)
block|,
operator|&
name|ngx_http_upstream_ignore_headers_masks
block|}
block|,
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_session_reuse"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|ssl_session_reuse
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_protocols"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_1MORE
block|,
name|ngx_conf_set_bitmask_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|ssl_protocols
argument_list|)
block|,
operator|&
name|ngx_http_grpc_ssl_protocols
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_ciphers"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|ssl_ciphers
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_name"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_set_complex_value_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|ssl_name
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_server_name"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|ssl_server_name
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_verify"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|ssl_verify
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_verify_depth"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_num_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|ssl_verify_depth
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_trusted_certificate"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|ssl_trusted_certificate
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_crl"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|ssl_crl
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_certificate"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_set_complex_value_zero_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|ssl_certificate
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_certificate_key"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_set_complex_value_zero_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|upstream
operator|.
name|ssl_certificate_key
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_password_file"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_grpc_ssl_password_file
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"grpc_ssl_conf_command"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE2
block|,
name|ngx_conf_set_keyval_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|,
name|ssl_conf_commands
argument_list|)
block|,
operator|&
name|ngx_http_grpc_ssl_conf_command_post
block|}
block|,
endif|#
directive|endif
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_grpc_module_ctx
specifier|static
name|ngx_http_module_t
name|ngx_http_grpc_module_ctx
init|=
block|{
name|ngx_http_grpc_add_variables
block|,
comment|/* preconfiguration */
name|NULL
block|,
comment|/* postconfiguration */
name|NULL
block|,
comment|/* create main configuration */
name|NULL
block|,
comment|/* init main configuration */
name|NULL
block|,
comment|/* create server configuration */
name|NULL
block|,
comment|/* merge server configuration */
name|ngx_http_grpc_create_loc_conf
block|,
comment|/* create location configuration */
name|ngx_http_grpc_merge_loc_conf
comment|/* merge location configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_grpc_module
name|ngx_module_t
name|ngx_http_grpc_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_http_grpc_module_ctx
block|,
comment|/* module context */
name|ngx_http_grpc_commands
block|,
comment|/* module directives */
name|NGX_HTTP_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|NULL
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|NULL
block|,
comment|/* exit process */
name|NULL
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_grpc_connection_start
specifier|static
name|u_char
name|ngx_http_grpc_connection_start
index|[]
init|=
literal|"PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"
comment|/* connection preface */
literal|"\x00\x00\x12\x04\x00\x00\x00\x00\x00"
comment|/* settings frame */
literal|"\x00\x01\x00\x00\x00\x00"
comment|/* header table size */
literal|"\x00\x02\x00\x00\x00\x00"
comment|/* disable push */
literal|"\x00\x04\x7f\xff\xff\xff"
comment|/* initial window */
literal|"\x00\x00\x04\x08\x00\x00\x00\x00\x00"
comment|/* window update frame */
literal|"\x7f\xff\x00\x00"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_grpc_headers
specifier|static
name|ngx_keyval_t
name|ngx_http_grpc_headers
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"Content-Length"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"$content_length"
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"TE"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"$grpc_internal_trailers"
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Host"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|""
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Connection"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|""
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Transfer-Encoding"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|""
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Keep-Alive"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|""
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Expect"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|""
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"Upgrade"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|""
argument_list|)
block|}
block|,
block|{
name|ngx_null_string
block|,
name|ngx_null_string
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_grpc_hide_headers
specifier|static
name|ngx_str_t
name|ngx_http_grpc_hide_headers
index|[]
init|=
block|{
name|ngx_string
argument_list|(
literal|"Date"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"Server"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"X-Accel-Expires"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"X-Accel-Redirect"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"X-Accel-Limit-Rate"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"X-Accel-Buffering"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"X-Accel-Charset"
argument_list|)
block|,
name|ngx_null_string
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_grpc_vars
specifier|static
name|ngx_http_variable_t
name|ngx_http_grpc_vars
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"grpc_internal_trailers"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_grpc_internal_trailers_variable
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
operator||
name|NGX_HTTP_VAR_NOHASH
block|,
literal|0
block|}
block|,
name|ngx_http_null_variable
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_handler (ngx_http_request_t * r)
name|ngx_http_grpc_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_grpc_loc_conf_t
modifier|*
name|glcf
decl_stmt|;
if|if
condition|(
name|ngx_http_upstream_create
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
name|ctx
operator|->
name|request
operator|=
name|r
expr_stmt|;
name|ngx_http_set_ctx
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|ngx_http_grpc_module
argument_list|)
expr_stmt|;
name|glcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_grpc_module
argument_list|)
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|glcf
operator|->
name|grpc_lengths
operator|==
name|NULL
condition|)
block|{
name|ctx
operator|->
name|host
operator|=
name|glcf
operator|->
name|host
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
name|u
operator|->
name|ssl
operator|=
operator|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl
operator|!=
name|NULL
operator|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|ssl
condition|)
block|{
name|ngx_str_set
argument_list|(
operator|&
name|u
operator|->
name|schema
argument_list|,
literal|"grpcs://"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_str_set
argument_list|(
operator|&
name|u
operator|->
name|schema
argument_list|,
literal|"grpc://"
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
name|ngx_str_set
argument_list|(
operator|&
name|u
operator|->
name|schema
argument_list|,
literal|"grpc://"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
if|if
condition|(
name|ngx_http_grpc_eval
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|glcf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
block|}
name|u
operator|->
name|output
operator|.
name|tag
operator|=
operator|(
name|ngx_buf_tag_t
operator|)
operator|&
name|ngx_http_grpc_module
expr_stmt|;
name|u
operator|->
name|conf
operator|=
operator|&
name|glcf
operator|->
name|upstream
expr_stmt|;
name|u
operator|->
name|create_request
operator|=
name|ngx_http_grpc_create_request
expr_stmt|;
name|u
operator|->
name|reinit_request
operator|=
name|ngx_http_grpc_reinit_request
expr_stmt|;
name|u
operator|->
name|process_header
operator|=
name|ngx_http_grpc_process_header
expr_stmt|;
name|u
operator|->
name|abort_request
operator|=
name|ngx_http_grpc_abort_request
expr_stmt|;
name|u
operator|->
name|finalize_request
operator|=
name|ngx_http_grpc_finalize_request
expr_stmt|;
name|u
operator|->
name|input_filter_init
operator|=
name|ngx_http_grpc_filter_init
expr_stmt|;
name|u
operator|->
name|input_filter
operator|=
name|ngx_http_grpc_filter
expr_stmt|;
name|u
operator|->
name|input_filter_ctx
operator|=
name|ctx
expr_stmt|;
name|r
operator|->
name|request_body_no_buffering
operator|=
literal|1
expr_stmt|;
name|rc
operator|=
name|ngx_http_read_client_request_body
argument_list|(
name|r
argument_list|,
name|ngx_http_upstream_init
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|>=
name|NGX_HTTP_SPECIAL_RESPONSE
condition|)
block|{
return|return
name|rc
return|;
block|}
return|return
name|NGX_DONE
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_eval (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_http_grpc_loc_conf_t * glcf)
name|ngx_http_grpc_eval
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_http_grpc_loc_conf_t
modifier|*
name|glcf
parameter_list|)
block|{
name|size_t
name|add
decl_stmt|;
name|ngx_url_t
name|url
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|url
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_script_run
argument_list|(
name|r
argument_list|,
operator|&
name|url
operator|.
name|url
argument_list|,
name|glcf
operator|->
name|grpc_lengths
operator|->
name|elts
argument_list|,
literal|0
argument_list|,
name|glcf
operator|->
name|grpc_values
operator|->
name|elts
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|url
operator|.
name|url
operator|.
name|len
operator|>
literal|7
operator|&&
name|ngx_strncasecmp
argument_list|(
name|url
operator|.
name|url
operator|.
name|data
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"grpc://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|add
operator|=
literal|7
expr_stmt|;
block|}
if|else if
condition|(
name|url
operator|.
name|url
operator|.
name|len
operator|>
literal|8
operator|&&
name|ngx_strncasecmp
argument_list|(
name|url
operator|.
name|url
operator|.
name|data
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"grpcs://"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
name|add
operator|=
literal|8
expr_stmt|;
name|r
operator|->
name|upstream
operator|->
name|ssl
operator|=
literal|1
expr_stmt|;
else|#
directive|else
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpcs protocol requires SSL support"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
endif|#
directive|endif
block|}
else|else
block|{
name|add
operator|=
literal|0
expr_stmt|;
block|}
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|add
condition|)
block|{
name|u
operator|->
name|schema
operator|.
name|len
operator|=
name|add
expr_stmt|;
name|u
operator|->
name|schema
operator|.
name|data
operator|=
name|url
operator|.
name|url
operator|.
name|data
expr_stmt|;
name|url
operator|.
name|url
operator|.
name|data
operator|+=
name|add
expr_stmt|;
name|url
operator|.
name|url
operator|.
name|len
operator|-=
name|add
expr_stmt|;
block|}
else|else
block|{
name|ngx_str_set
argument_list|(
operator|&
name|u
operator|->
name|schema
argument_list|,
literal|"grpc://"
argument_list|)
expr_stmt|;
block|}
name|url
operator|.
name|no_resolve
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_parse_url
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|&
name|url
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|url
operator|.
name|err
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"%s in upstream \"%V\""
argument_list|,
name|url
operator|.
name|err
argument_list|,
operator|&
name|url
operator|.
name|url
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_ERROR
return|;
block|}
name|u
operator|->
name|resolved
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_upstream_resolved_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|resolved
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|url
operator|.
name|addrs
condition|)
block|{
name|u
operator|->
name|resolved
operator|->
name|sockaddr
operator|=
name|url
operator|.
name|addrs
index|[
literal|0
index|]
operator|.
name|sockaddr
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|socklen
operator|=
name|url
operator|.
name|addrs
index|[
literal|0
index|]
operator|.
name|socklen
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|name
operator|=
name|url
operator|.
name|addrs
index|[
literal|0
index|]
operator|.
name|name
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|naddrs
operator|=
literal|1
expr_stmt|;
block|}
name|u
operator|->
name|resolved
operator|->
name|host
operator|=
name|url
operator|.
name|host
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|port
operator|=
name|url
operator|.
name|port
expr_stmt|;
name|u
operator|->
name|resolved
operator|->
name|no_port
operator|=
name|url
operator|.
name|no_port
expr_stmt|;
if|if
condition|(
name|url
operator|.
name|family
operator|!=
name|AF_UNIX
condition|)
block|{
if|if
condition|(
name|url
operator|.
name|no_port
condition|)
block|{
name|ctx
operator|->
name|host
operator|=
name|url
operator|.
name|host
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|->
name|host
operator|.
name|len
operator|=
name|url
operator|.
name|host
operator|.
name|len
operator|+
literal|1
operator|+
name|url
operator|.
name|port_text
operator|.
name|len
expr_stmt|;
name|ctx
operator|->
name|host
operator|.
name|data
operator|=
name|url
operator|.
name|host
operator|.
name|data
expr_stmt|;
block|}
block|}
else|else
block|{
name|ngx_str_set
argument_list|(
operator|&
name|ctx
operator|->
name|host
argument_list|,
literal|"localhost"
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_create_request (ngx_http_request_t * r)
name|ngx_http_grpc_create_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|key_tmp
decl_stmt|,
modifier|*
name|val_tmp
decl_stmt|,
modifier|*
name|headers_frame
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|tmp_len
decl_stmt|,
name|key_len
decl_stmt|,
name|val_len
decl_stmt|,
name|uri_len
decl_stmt|;
name|uintptr_t
name|escape
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|next
decl_stmt|;
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|,
modifier|*
name|body
decl_stmt|;
name|ngx_list_part_t
modifier|*
name|part
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|header
decl_stmt|;
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_http_grpc_frame_t
modifier|*
name|f
decl_stmt|;
name|ngx_http_script_code_pt
name|code
decl_stmt|;
name|ngx_http_grpc_loc_conf_t
modifier|*
name|glcf
decl_stmt|;
name|ngx_http_script_engine_t
name|e
decl_stmt|,
name|le
decl_stmt|;
name|ngx_http_script_len_code_pt
name|lcode
decl_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
name|glcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_grpc_module
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ngx_http_get_module_ctx
argument_list|(
name|r
argument_list|,
name|ngx_http_grpc_module
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_connection_start
argument_list|)
operator|-
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
comment|/* headers frame */
comment|/* :method header */
if|if
condition|(
name|r
operator|->
name|method
operator|==
name|NGX_HTTP_GET
operator|||
name|r
operator|->
name|method
operator|==
name|NGX_HTTP_POST
condition|)
block|{
name|len
operator|+=
literal|1
expr_stmt|;
name|tmp_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|len
operator|+=
literal|1
operator|+
name|NGX_HTTP_V2_INT_OCTETS
operator|+
name|r
operator|->
name|method_name
operator|.
name|len
expr_stmt|;
name|tmp_len
operator|=
name|r
operator|->
name|method_name
operator|.
name|len
expr_stmt|;
block|}
comment|/* :scheme header */
name|len
operator|+=
literal|1
expr_stmt|;
comment|/* :path header */
if|if
condition|(
name|r
operator|->
name|valid_unparsed_uri
condition|)
block|{
name|escape
operator|=
literal|0
expr_stmt|;
name|uri_len
operator|=
name|r
operator|->
name|unparsed_uri
operator|.
name|len
expr_stmt|;
block|}
else|else
block|{
name|escape
operator|=
literal|2
operator|*
name|ngx_escape_uri
argument_list|(
name|NULL
argument_list|,
name|r
operator|->
name|uri
operator|.
name|data
argument_list|,
name|r
operator|->
name|uri
operator|.
name|len
argument_list|,
name|NGX_ESCAPE_URI
argument_list|)
expr_stmt|;
name|uri_len
operator|=
name|r
operator|->
name|uri
operator|.
name|len
operator|+
name|escape
operator|+
sizeof|sizeof
argument_list|(
literal|"?"
argument_list|)
operator|-
literal|1
operator|+
name|r
operator|->
name|args
operator|.
name|len
expr_stmt|;
block|}
name|len
operator|+=
literal|1
operator|+
name|NGX_HTTP_V2_INT_OCTETS
operator|+
name|uri_len
expr_stmt|;
if|if
condition|(
name|tmp_len
operator|<
name|uri_len
condition|)
block|{
name|tmp_len
operator|=
name|uri_len
expr_stmt|;
block|}
comment|/* :authority header */
if|if
condition|(
operator|!
name|glcf
operator|->
name|host_set
condition|)
block|{
name|len
operator|+=
literal|1
operator|+
name|NGX_HTTP_V2_INT_OCTETS
operator|+
name|ctx
operator|->
name|host
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|tmp_len
operator|<
name|ctx
operator|->
name|host
operator|.
name|len
condition|)
block|{
name|tmp_len
operator|=
name|ctx
operator|->
name|host
operator|.
name|len
expr_stmt|;
block|}
block|}
comment|/* other headers */
name|ngx_http_script_flush_no_cacheable_variables
argument_list|(
name|r
argument_list|,
name|glcf
operator|->
name|headers
operator|.
name|flushes
argument_list|)
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|le
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_script_engine_t
argument_list|)
argument_list|)
expr_stmt|;
name|le
operator|.
name|ip
operator|=
name|glcf
operator|->
name|headers
operator|.
name|lengths
operator|->
name|elts
expr_stmt|;
name|le
operator|.
name|request
operator|=
name|r
expr_stmt|;
name|le
operator|.
name|flushed
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|*
operator|(
name|uintptr_t
operator|*
operator|)
name|le
operator|.
name|ip
condition|)
block|{
name|lcode
operator|=
operator|*
operator|(
name|ngx_http_script_len_code_pt
operator|*
operator|)
name|le
operator|.
name|ip
expr_stmt|;
name|key_len
operator|=
name|lcode
argument_list|(
operator|&
name|le
argument_list|)
expr_stmt|;
for|for
control|(
name|val_len
operator|=
literal|0
init|;
operator|*
operator|(
name|uintptr_t
operator|*
operator|)
name|le
operator|.
name|ip
condition|;
name|val_len
operator|+=
name|lcode
argument_list|(
operator|&
name|le
argument_list|)
control|)
block|{
name|lcode
operator|=
operator|*
operator|(
name|ngx_http_script_len_code_pt
operator|*
operator|)
name|le
operator|.
name|ip
expr_stmt|;
block|}
name|le
operator|.
name|ip
operator|+=
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|val_len
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
name|len
operator|+=
literal|1
operator|+
name|NGX_HTTP_V2_INT_OCTETS
operator|+
name|key_len
operator|+
name|NGX_HTTP_V2_INT_OCTETS
operator|+
name|val_len
expr_stmt|;
if|if
condition|(
name|tmp_len
operator|<
name|key_len
condition|)
block|{
name|tmp_len
operator|=
name|key_len
expr_stmt|;
block|}
if|if
condition|(
name|tmp_len
operator|<
name|val_len
condition|)
block|{
name|tmp_len
operator|=
name|val_len
expr_stmt|;
block|}
block|}
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|pass_request_headers
condition|)
block|{
name|part
operator|=
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
comment|/* void */
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|part
operator|->
name|nelts
condition|)
block|{
if|if
condition|(
name|part
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|part
operator|=
name|part
operator|->
name|next
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ngx_hash_find
argument_list|(
operator|&
name|glcf
operator|->
name|headers
operator|.
name|hash
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|hash
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|lowcase_key
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|len
operator|+=
literal|1
operator|+
name|NGX_HTTP_V2_INT_OCTETS
operator|+
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
operator|+
name|NGX_HTTP_V2_INT_OCTETS
operator|+
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|len
expr_stmt|;
if|if
condition|(
name|tmp_len
operator|<
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
condition|)
block|{
name|tmp_len
operator|=
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
expr_stmt|;
block|}
if|if
condition|(
name|tmp_len
operator|<
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|len
condition|)
block|{
name|tmp_len
operator|=
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|len
expr_stmt|;
block|}
block|}
block|}
comment|/* continuation frames */
name|len
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
operator|*
operator|(
name|len
operator|/
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
operator|)
expr_stmt|;
name|b
operator|=
name|ngx_create_temp_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cl
operator|=
name|ngx_alloc_chain_link
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cl
operator|->
name|buf
operator|=
name|b
expr_stmt|;
name|cl
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|tmp
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|tmp_len
operator|*
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|key_tmp
operator|=
name|tmp
operator|+
name|tmp_len
expr_stmt|;
name|val_tmp
operator|=
name|tmp
operator|+
literal|2
operator|*
name|tmp_len
expr_stmt|;
comment|/* connection preface */
name|b
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ngx_http_grpc_connection_start
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_connection_start
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* headers frame */
name|headers_frame
operator|=
name|b
operator|->
name|last
expr_stmt|;
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|b
operator|->
name|last
expr_stmt|;
name|b
operator|->
name|last
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|type
operator|=
name|NGX_HTTP_V2_HEADERS_FRAME
expr_stmt|;
name|f
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|method
operator|==
name|NGX_HTTP_GET
condition|)
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_indexed
argument_list|(
name|NGX_HTTP_V2_METHOD_GET_INDEX
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":method: GET\""
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|r
operator|->
name|method
operator|==
name|NGX_HTTP_POST
condition|)
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_indexed
argument_list|(
name|NGX_HTTP_V2_METHOD_POST_INDEX
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":method: POST\""
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_inc_indexed
argument_list|(
name|NGX_HTTP_V2_METHOD_INDEX
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_value
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|r
operator|->
name|method_name
operator|.
name|data
argument_list|,
name|r
operator|->
name|method_name
operator|.
name|len
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":method: %V\""
argument_list|,
operator|&
name|r
operator|->
name|method_name
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
if|if
condition|(
name|u
operator|->
name|ssl
condition|)
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_indexed
argument_list|(
name|NGX_HTTP_V2_SCHEME_HTTPS_INDEX
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":scheme: https\""
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_indexed
argument_list|(
name|NGX_HTTP_V2_SCHEME_HTTP_INDEX
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":scheme: http\""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|valid_unparsed_uri
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|unparsed_uri
operator|.
name|len
operator|==
literal|1
operator|&&
name|r
operator|->
name|unparsed_uri
operator|.
name|data
index|[
literal|0
index|]
operator|==
literal|'/'
condition|)
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_indexed
argument_list|(
name|NGX_HTTP_V2_PATH_ROOT_INDEX
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_inc_indexed
argument_list|(
name|NGX_HTTP_V2_PATH_INDEX
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_value
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|r
operator|->
name|unparsed_uri
operator|.
name|data
argument_list|,
name|r
operator|->
name|unparsed_uri
operator|.
name|len
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":path: %V\""
argument_list|,
operator|&
name|r
operator|->
name|unparsed_uri
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|escape
operator|||
name|r
operator|->
name|args
operator|.
name|len
operator|>
literal|0
condition|)
block|{
name|p
operator|=
name|val_tmp
expr_stmt|;
if|if
condition|(
name|escape
condition|)
block|{
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ngx_escape_uri
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|uri
operator|.
name|data
argument_list|,
name|r
operator|->
name|uri
operator|.
name|len
argument_list|,
name|NGX_ESCAPE_URI
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
name|ngx_copy
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|uri
operator|.
name|data
argument_list|,
name|r
operator|->
name|uri
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|args
operator|.
name|len
operator|>
literal|0
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'?'
expr_stmt|;
name|p
operator|=
name|ngx_copy
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|args
operator|.
name|data
argument_list|,
name|r
operator|->
name|args
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_inc_indexed
argument_list|(
name|NGX_HTTP_V2_PATH_INDEX
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_value
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|val_tmp
argument_list|,
name|p
operator|-
name|val_tmp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":path: %*s\""
argument_list|,
name|p
operator|-
name|val_tmp
argument_list|,
name|val_tmp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_inc_indexed
argument_list|(
name|NGX_HTTP_V2_PATH_INDEX
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_value
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|r
operator|->
name|uri
operator|.
name|data
argument_list|,
name|r
operator|->
name|uri
operator|.
name|len
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":path: %V\""
argument_list|,
operator|&
name|r
operator|->
name|uri
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|glcf
operator|->
name|host_set
condition|)
block|{
operator|*
name|b
operator|->
name|last
operator|++
operator|=
name|ngx_http_v2_inc_indexed
argument_list|(
name|NGX_HTTP_V2_AUTHORITY_INDEX
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_value
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|ctx
operator|->
name|host
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|host
operator|.
name|len
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \":authority: %V\""
argument_list|,
operator|&
name|ctx
operator|->
name|host
argument_list|)
expr_stmt|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|e
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_script_engine_t
argument_list|)
argument_list|)
expr_stmt|;
name|e
operator|.
name|ip
operator|=
name|glcf
operator|->
name|headers
operator|.
name|values
operator|->
name|elts
expr_stmt|;
name|e
operator|.
name|request
operator|=
name|r
expr_stmt|;
name|e
operator|.
name|flushed
operator|=
literal|1
expr_stmt|;
name|le
operator|.
name|ip
operator|=
name|glcf
operator|->
name|headers
operator|.
name|lengths
operator|->
name|elts
expr_stmt|;
while|while
condition|(
operator|*
operator|(
name|uintptr_t
operator|*
operator|)
name|le
operator|.
name|ip
condition|)
block|{
name|lcode
operator|=
operator|*
operator|(
name|ngx_http_script_len_code_pt
operator|*
operator|)
name|le
operator|.
name|ip
expr_stmt|;
name|key_len
operator|=
name|lcode
argument_list|(
operator|&
name|le
argument_list|)
expr_stmt|;
for|for
control|(
name|val_len
operator|=
literal|0
init|;
operator|*
operator|(
name|uintptr_t
operator|*
operator|)
name|le
operator|.
name|ip
condition|;
name|val_len
operator|+=
name|lcode
argument_list|(
operator|&
name|le
argument_list|)
control|)
block|{
name|lcode
operator|=
operator|*
operator|(
name|ngx_http_script_len_code_pt
operator|*
operator|)
name|le
operator|.
name|ip
expr_stmt|;
block|}
name|le
operator|.
name|ip
operator|+=
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|val_len
operator|==
literal|0
condition|)
block|{
name|e
operator|.
name|skip
operator|=
literal|1
expr_stmt|;
while|while
condition|(
operator|*
operator|(
name|uintptr_t
operator|*
operator|)
name|e
operator|.
name|ip
condition|)
block|{
name|code
operator|=
operator|*
operator|(
name|ngx_http_script_code_pt
operator|*
operator|)
name|e
operator|.
name|ip
expr_stmt|;
name|code
argument_list|(
operator|(
name|ngx_http_script_engine_t
operator|*
operator|)
operator|&
name|e
argument_list|)
expr_stmt|;
block|}
name|e
operator|.
name|ip
operator|+=
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
expr_stmt|;
name|e
operator|.
name|skip
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
operator|*
name|b
operator|->
name|last
operator|++
operator|=
literal|0
expr_stmt|;
name|e
operator|.
name|pos
operator|=
name|key_tmp
expr_stmt|;
name|code
operator|=
operator|*
operator|(
name|ngx_http_script_code_pt
operator|*
operator|)
name|e
operator|.
name|ip
expr_stmt|;
name|code
argument_list|(
operator|(
name|ngx_http_script_engine_t
operator|*
operator|)
operator|&
name|e
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_name
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|key_tmp
argument_list|,
name|key_len
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|e
operator|.
name|pos
operator|=
name|val_tmp
expr_stmt|;
while|while
condition|(
operator|*
operator|(
name|uintptr_t
operator|*
operator|)
name|e
operator|.
name|ip
condition|)
block|{
name|code
operator|=
operator|*
operator|(
name|ngx_http_script_code_pt
operator|*
operator|)
name|e
operator|.
name|ip
expr_stmt|;
name|code
argument_list|(
operator|(
name|ngx_http_script_engine_t
operator|*
operator|)
operator|&
name|e
argument_list|)
expr_stmt|;
block|}
name|e
operator|.
name|ip
operator|+=
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_value
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|val_tmp
argument_list|,
name|val_len
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
if|if
condition|(
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|log_level
operator|&
name|NGX_LOG_DEBUG_HTTP
condition|)
block|{
name|ngx_strlow
argument_list|(
name|key_tmp
argument_list|,
name|key_tmp
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \"%*s: %*s\""
argument_list|,
name|key_len
argument_list|,
name|key_tmp
argument_list|,
name|val_len
argument_list|,
name|val_tmp
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|pass_request_headers
condition|)
block|{
name|part
operator|=
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
comment|/* void */
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|part
operator|->
name|nelts
condition|)
block|{
if|if
condition|(
name|part
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|part
operator|=
name|part
operator|->
name|next
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ngx_hash_find
argument_list|(
operator|&
name|glcf
operator|->
name|headers
operator|.
name|hash
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|hash
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|lowcase_key
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
condition|)
block|{
continue|continue;
block|}
operator|*
name|b
operator|->
name|last
operator|++
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_name
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|ngx_http_v2_write_value
argument_list|(
name|b
operator|->
name|last
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|data
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|len
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
if|if
condition|(
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|log_level
operator|&
name|NGX_LOG_DEBUG_HTTP
condition|)
block|{
name|ngx_strlow
argument_list|(
name|tmp
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \"%*s: %V\""
argument_list|,
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|,
name|tmp
argument_list|,
operator|&
name|header
index|[
name|i
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
block|}
comment|/* update headers frame length */
name|len
operator|=
name|b
operator|->
name|last
operator|-
name|headers_frame
operator|-
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
condition|)
block|{
name|len
operator|=
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
expr_stmt|;
name|next
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|next
operator|=
literal|0
expr_stmt|;
block|}
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|headers_frame
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|len
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|len
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
operator|(
name|u_char
operator|)
operator|(
name|len
operator|&
literal|0xff
operator|)
expr_stmt|;
comment|/* create additional continuation frames */
name|p
operator|=
name|headers_frame
expr_stmt|;
while|while
condition|(
name|next
condition|)
block|{
name|p
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
operator|+
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
expr_stmt|;
name|len
operator|=
name|b
operator|->
name|last
operator|-
name|p
expr_stmt|;
name|ngx_memmove
argument_list|(
name|p
operator|+
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|b
operator|->
name|last
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
condition|)
block|{
name|len
operator|=
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
expr_stmt|;
name|next
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|next
operator|=
literal|0
expr_stmt|;
block|}
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|p
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|len
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|len
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
operator|(
name|u_char
operator|)
operator|(
name|len
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|type
operator|=
name|NGX_HTTP_V2_CONTINUATION_FRAME
expr_stmt|;
name|f
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
literal|1
expr_stmt|;
block|}
name|f
operator|->
name|flags
operator||=
name|NGX_HTTP_V2_END_HEADERS_FLAG
expr_stmt|;
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: %*xs%s, len: %uz"
argument_list|,
operator|(
name|size_t
operator|)
name|ngx_min
argument_list|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
argument_list|,
literal|256
argument_list|)
argument_list|,
name|b
operator|->
name|pos
argument_list|,
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|>
literal|256
condition|?
literal|"..."
else|:
literal|""
argument_list|,
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|request_body_no_buffering
condition|)
block|{
name|u
operator|->
name|request_bufs
operator|=
name|cl
expr_stmt|;
block|}
else|else
block|{
name|body
operator|=
name|u
operator|->
name|request_bufs
expr_stmt|;
name|u
operator|->
name|request_bufs
operator|=
name|cl
expr_stmt|;
if|if
condition|(
name|body
operator|==
name|NULL
condition|)
block|{
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|headers_frame
expr_stmt|;
name|f
operator|->
name|flags
operator||=
name|NGX_HTTP_V2_END_STREAM_FLAG
expr_stmt|;
block|}
while|while
condition|(
name|body
condition|)
block|{
name|b
operator|=
name|ngx_alloc_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|b
argument_list|,
name|body
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_buf_t
argument_list|)
argument_list|)
expr_stmt|;
name|cl
operator|->
name|next
operator|=
name|ngx_alloc_chain_link
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cl
operator|=
name|cl
operator|->
name|next
expr_stmt|;
name|cl
operator|->
name|buf
operator|=
name|b
expr_stmt|;
name|body
operator|=
name|body
operator|->
name|next
expr_stmt|;
block|}
name|b
operator|->
name|last_buf
operator|=
literal|1
expr_stmt|;
block|}
name|u
operator|->
name|output
operator|.
name|output_filter
operator|=
name|ngx_http_grpc_body_output_filter
expr_stmt|;
name|u
operator|->
name|output
operator|.
name|filter_ctx
operator|=
name|r
expr_stmt|;
name|b
operator|->
name|flush
operator|=
literal|1
expr_stmt|;
name|cl
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_reinit_request (ngx_http_request_t * r)
name|ngx_http_grpc_reinit_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ctx
operator|=
name|ngx_http_get_module_ctx
argument_list|(
name|r
argument_list|,
name|ngx_http_grpc_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|ctx
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|header_sent
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|output_closed
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|output_blocked
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|parsing_headers
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|end_stream
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|done
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|status
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|rst
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|goaway
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|connection
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_body_output_filter (void * data,ngx_chain_t * in)
name|ngx_http_grpc_body_output_filter
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|ngx_chain_t
modifier|*
name|in
parameter_list|)
block|{
name|ngx_http_request_t
modifier|*
name|r
init|=
name|data
decl_stmt|;
name|off_t
name|file_pos
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|start
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|limit
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|next
decl_stmt|,
name|last
decl_stmt|;
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|,
modifier|*
name|out
decl_stmt|,
modifier|*
modifier|*
name|ll
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_grpc_frame_t
modifier|*
name|f
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc output filter"
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ngx_http_grpc_get_ctx
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|in
condition|)
block|{
if|if
condition|(
name|ngx_chain_add_copy
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|&
name|ctx
operator|->
name|in
argument_list|,
name|in
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
name|out
operator|=
name|NULL
expr_stmt|;
name|ll
operator|=
operator|&
name|out
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|header_sent
condition|)
block|{
comment|/* first buffer contains headers */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc output header"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|header_sent
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|id
operator|!=
literal|1
condition|)
block|{
comment|/*              * keepalive connection: skip connection preface,              * update stream identifiers              */
name|b
operator|=
name|ctx
operator|->
name|in
operator|->
name|buf
expr_stmt|;
name|b
operator|->
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_connection_start
argument_list|)
operator|-
literal|1
expr_stmt|;
name|p
operator|=
name|b
operator|->
name|pos
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|b
operator|->
name|last
condition|)
block|{
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|p
expr_stmt|;
name|p
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ctx
operator|->
name|id
operator|&
literal|0xff
operator|)
expr_stmt|;
name|p
operator|+=
operator|(
name|f
operator|->
name|length_0
operator|<<
literal|16
operator|)
operator|+
operator|(
name|f
operator|->
name|length_1
operator|<<
literal|8
operator|)
operator|+
name|f
operator|->
name|length_2
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ctx
operator|->
name|in
operator|->
name|buf
operator|->
name|last_buf
condition|)
block|{
name|ctx
operator|->
name|output_closed
operator|=
literal|1
expr_stmt|;
block|}
operator|*
name|ll
operator|=
name|ctx
operator|->
name|in
expr_stmt|;
name|ll
operator|=
operator|&
name|ctx
operator|->
name|in
operator|->
name|next
expr_stmt|;
name|ctx
operator|->
name|in
operator|=
name|ctx
operator|->
name|in
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|out
condition|)
block|{
comment|/* queued control frames */
operator|*
name|ll
operator|=
name|ctx
operator|->
name|out
expr_stmt|;
for|for
control|(
name|cl
operator|=
name|ctx
operator|->
name|out
operator|,
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
block|}
name|ctx
operator|->
name|out
operator|=
name|NULL
expr_stmt|;
block|}
name|f
operator|=
name|NULL
expr_stmt|;
name|last
operator|=
literal|0
expr_stmt|;
name|limit
operator|=
name|ngx_max
argument_list|(
literal|0
argument_list|,
name|ctx
operator|->
name|send_window
argument_list|)
expr_stmt|;
if|if
condition|(
name|limit
operator|>
name|ctx
operator|->
name|connection
operator|->
name|send_window
condition|)
block|{
name|limit
operator|=
name|ctx
operator|->
name|connection
operator|->
name|send_window
expr_stmt|;
block|}
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc output limit: %uz w:%z:%uz"
argument_list|,
name|limit
argument_list|,
name|ctx
operator|->
name|send_window
argument_list|,
name|ctx
operator|->
name|connection
operator|->
name|send_window
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_SUPPRESS_WARN
operator|)
name|file_pos
operator|=
literal|0
expr_stmt|;
name|pos
operator|=
name|NULL
expr_stmt|;
name|cl
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|in
operator|=
name|ctx
operator|->
name|in
expr_stmt|;
while|while
condition|(
name|in
operator|&&
name|limit
operator|>
literal|0
condition|)
block|{
name|ngx_log_debug7
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc output in  l:%d f:%d %p, pos %p, size: %z "
literal|"file: %O, size: %O"
argument_list|,
name|in
operator|->
name|buf
operator|->
name|last_buf
argument_list|,
name|in
operator|->
name|buf
operator|->
name|in_file
argument_list|,
name|in
operator|->
name|buf
operator|->
name|start
argument_list|,
name|in
operator|->
name|buf
operator|->
name|pos
argument_list|,
name|in
operator|->
name|buf
operator|->
name|last
operator|-
name|in
operator|->
name|buf
operator|->
name|pos
argument_list|,
name|in
operator|->
name|buf
operator|->
name|file_pos
argument_list|,
name|in
operator|->
name|buf
operator|->
name|file_last
operator|-
name|in
operator|->
name|buf
operator|->
name|file_pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_buf_special
argument_list|(
name|in
operator|->
name|buf
argument_list|)
condition|)
block|{
goto|goto
name|next
goto|;
block|}
if|if
condition|(
name|in
operator|->
name|buf
operator|->
name|in_file
condition|)
block|{
name|file_pos
operator|=
name|in
operator|->
name|buf
operator|->
name|file_pos
expr_stmt|;
block|}
else|else
block|{
name|pos
operator|=
name|in
operator|->
name|buf
operator|->
name|pos
expr_stmt|;
block|}
name|next
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|cl
operator|=
name|ngx_http_grpc_get_buf
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|b
operator|=
name|cl
operator|->
name|buf
expr_stmt|;
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|b
operator|->
name|last
expr_stmt|;
name|b
operator|->
name|last
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
operator|*
name|ll
operator|=
name|cl
expr_stmt|;
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
name|cl
operator|=
name|ngx_chain_get_free_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|&
name|ctx
operator|->
name|free
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|b
operator|=
name|cl
operator|->
name|buf
expr_stmt|;
name|start
operator|=
name|b
operator|->
name|start
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|b
argument_list|,
name|in
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_buf_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/*              * restore b->start to preserve memory allocated in the buffer,              * to reuse it later for headers and control frames              */
name|b
operator|->
name|start
operator|=
name|start
expr_stmt|;
if|if
condition|(
name|in
operator|->
name|buf
operator|->
name|in_file
condition|)
block|{
name|b
operator|->
name|file_pos
operator|=
name|file_pos
expr_stmt|;
name|file_pos
operator|+=
name|ngx_min
argument_list|(
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
argument_list|,
name|limit
argument_list|)
expr_stmt|;
if|if
condition|(
name|file_pos
operator|>=
name|in
operator|->
name|buf
operator|->
name|file_last
condition|)
block|{
name|file_pos
operator|=
name|in
operator|->
name|buf
operator|->
name|file_last
expr_stmt|;
name|next
operator|=
literal|1
expr_stmt|;
block|}
name|b
operator|->
name|file_last
operator|=
name|file_pos
expr_stmt|;
name|len
operator|=
operator|(
name|ngx_uint_t
operator|)
operator|(
name|file_pos
operator|-
name|b
operator|->
name|file_pos
operator|)
expr_stmt|;
block|}
else|else
block|{
name|b
operator|->
name|pos
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|ngx_min
argument_list|(
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
argument_list|,
name|limit
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|>=
name|in
operator|->
name|buf
operator|->
name|last
condition|)
block|{
name|pos
operator|=
name|in
operator|->
name|buf
operator|->
name|last
expr_stmt|;
name|next
operator|=
literal|1
expr_stmt|;
block|}
name|b
operator|->
name|last
operator|=
name|pos
expr_stmt|;
name|len
operator|=
operator|(
name|ngx_uint_t
operator|)
operator|(
name|pos
operator|-
name|b
operator|->
name|pos
operator|)
expr_stmt|;
block|}
name|b
operator|->
name|tag
operator|=
operator|(
name|ngx_buf_tag_t
operator|)
operator|&
name|ngx_http_grpc_body_output_filter
expr_stmt|;
name|b
operator|->
name|shadow
operator|=
name|in
operator|->
name|buf
expr_stmt|;
name|b
operator|->
name|last_shadow
operator|=
name|next
expr_stmt|;
name|b
operator|->
name|last_buf
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|last_in_chain
operator|=
literal|0
expr_stmt|;
operator|*
name|ll
operator|=
name|cl
expr_stmt|;
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|len
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|len
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
operator|(
name|u_char
operator|)
operator|(
name|len
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|type
operator|=
name|NGX_HTTP_V2_DATA_FRAME
expr_stmt|;
name|f
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ctx
operator|->
name|id
operator|&
literal|0xff
operator|)
expr_stmt|;
name|limit
operator|-=
name|len
expr_stmt|;
name|ctx
operator|->
name|send_window
operator|-=
name|len
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|send_window
operator|-=
name|len
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|next
operator|&&
name|limit
operator|>
literal|0
condition|)
do|;
if|if
condition|(
operator|!
name|next
condition|)
block|{
comment|/*              * if the buffer wasn't fully sent due to flow control limits,              * preserve position for future use              */
if|if
condition|(
name|in
operator|->
name|buf
operator|->
name|in_file
condition|)
block|{
name|in
operator|->
name|buf
operator|->
name|file_pos
operator|=
name|file_pos
expr_stmt|;
block|}
else|else
block|{
name|in
operator|->
name|buf
operator|->
name|pos
operator|=
name|pos
expr_stmt|;
block|}
break|break;
block|}
name|next
label|:
if|if
condition|(
name|in
operator|->
name|buf
operator|->
name|last_buf
condition|)
block|{
name|last
operator|=
literal|1
expr_stmt|;
block|}
name|in
operator|=
name|in
operator|->
name|next
expr_stmt|;
block|}
name|ctx
operator|->
name|in
operator|=
name|in
expr_stmt|;
if|if
condition|(
name|last
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc output last"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|output_closed
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|f
condition|)
block|{
name|f
operator|->
name|flags
operator||=
name|NGX_HTTP_V2_END_STREAM_FLAG
expr_stmt|;
block|}
else|else
block|{
name|cl
operator|=
name|ngx_http_grpc_get_buf
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|b
operator|=
name|cl
operator|->
name|buf
expr_stmt|;
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|b
operator|->
name|last
expr_stmt|;
name|b
operator|->
name|last
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|type
operator|=
name|NGX_HTTP_V2_DATA_FRAME
expr_stmt|;
name|f
operator|->
name|flags
operator|=
name|NGX_HTTP_V2_END_STREAM_FLAG
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ctx
operator|->
name|id
operator|&
literal|0xff
operator|)
expr_stmt|;
operator|*
name|ll
operator|=
name|cl
expr_stmt|;
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
block|}
name|cl
operator|->
name|buf
operator|->
name|last_buf
operator|=
literal|1
expr_stmt|;
block|}
operator|*
name|ll
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
for|for
control|(
name|cl
operator|=
name|out
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|ngx_log_debug7
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc output out l:%d f:%d %p, pos %p, size: %z "
literal|"file: %O, size: %O"
argument_list|,
name|cl
operator|->
name|buf
operator|->
name|last_buf
argument_list|,
name|cl
operator|->
name|buf
operator|->
name|in_file
argument_list|,
name|cl
operator|->
name|buf
operator|->
name|start
argument_list|,
name|cl
operator|->
name|buf
operator|->
name|pos
argument_list|,
name|cl
operator|->
name|buf
operator|->
name|last
operator|-
name|cl
operator|->
name|buf
operator|->
name|pos
argument_list|,
name|cl
operator|->
name|buf
operator|->
name|file_pos
argument_list|,
name|cl
operator|->
name|buf
operator|->
name|file_last
operator|-
name|cl
operator|->
name|buf
operator|->
name|file_pos
argument_list|)
expr_stmt|;
block|}
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc output limit: %uz w:%z:%uz"
argument_list|,
name|limit
argument_list|,
name|ctx
operator|->
name|send_window
argument_list|,
name|ctx
operator|->
name|connection
operator|->
name|send_window
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rc
operator|=
name|ngx_chain_writer
argument_list|(
operator|&
name|r
operator|->
name|upstream
operator|->
name|writer
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|ngx_chain_update_chains
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|&
name|ctx
operator|->
name|free
argument_list|,
operator|&
name|ctx
operator|->
name|busy
argument_list|,
operator|&
name|out
argument_list|,
operator|(
name|ngx_buf_tag_t
operator|)
operator|&
name|ngx_http_grpc_body_output_filter
argument_list|)
expr_stmt|;
for|for
control|(
name|cl
operator|=
name|ctx
operator|->
name|free
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
comment|/* mark original buffers as sent */
if|if
condition|(
name|cl
operator|->
name|buf
operator|->
name|shadow
condition|)
block|{
if|if
condition|(
name|cl
operator|->
name|buf
operator|->
name|last_shadow
condition|)
block|{
name|b
operator|=
name|cl
operator|->
name|buf
operator|->
name|shadow
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
block|}
name|cl
operator|->
name|buf
operator|->
name|shadow
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_OK
operator|&&
name|ctx
operator|->
name|in
condition|)
block|{
name|rc
operator|=
name|NGX_AGAIN
expr_stmt|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
name|ctx
operator|->
name|output_blocked
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|->
name|output_blocked
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|done
condition|)
block|{
comment|/*          * We have already got the response and were sending some additional          * control frames.  Even if there is still something unsent, stop          * here anyway.          */
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
name|u
operator|->
name|length
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|in
operator|==
name|NULL
operator|&&
name|ctx
operator|->
name|out
operator|==
name|NULL
operator|&&
name|ctx
operator|->
name|output_closed
operator|&&
operator|!
name|ctx
operator|->
name|output_blocked
operator|&&
operator|!
name|ctx
operator|->
name|goaway
operator|&&
name|ctx
operator|->
name|state
operator|==
name|ngx_http_grpc_st_start
condition|)
block|{
name|u
operator|->
name|keepalive
operator|=
literal|1
expr_stmt|;
block|}
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_process_header (ngx_http_request_t * r)
name|ngx_http_grpc_process_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|status_line
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|,
name|status
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_upstream_header_t
modifier|*
name|hh
decl_stmt|;
name|ngx_http_upstream_main_conf_t
modifier|*
name|umcf
decl_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
name|b
operator|=
operator|&
name|u
operator|->
name|buffer
expr_stmt|;
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc response: %*xs%s, len: %uz"
argument_list|,
operator|(
name|size_t
operator|)
name|ngx_min
argument_list|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
argument_list|,
literal|256
argument_list|)
argument_list|,
name|b
operator|->
name|pos
argument_list|,
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|>
literal|256
condition|?
literal|"..."
else|:
literal|""
argument_list|,
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ngx_http_grpc_get_ctx
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|umcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_upstream_module
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|ctx
operator|->
name|state
operator|<
name|ngx_http_grpc_st_payload
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_frame
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
comment|/*                  * there can be a lot of window update frames,                  * so we reset buffer if it is empty and we haven't                  * started parsing headers yet                  */
if|if
condition|(
operator|!
name|ctx
operator|->
name|parsing_headers
condition|)
block|{
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|start
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|b
operator|->
name|pos
expr_stmt|;
block|}
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
comment|/*              * RFC 7540 says that implementations MUST discard frames              * that have unknown or unsupported types.  However, extension              * frames that appear in the middle of a header block are              * not permitted.  Also, for obvious reasons CONTINUATION frames              * cannot appear before headers, and DATA frames are not expected              * to appear before all headers are parsed.              */
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_DATA_FRAME
operator|||
operator|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_CONTINUATION_FRAME
operator|&&
operator|!
name|ctx
operator|->
name|parsing_headers
operator|)
operator|||
operator|(
name|ctx
operator|->
name|type
operator|!=
name|NGX_HTTP_V2_CONTINUATION_FRAME
operator|&&
name|ctx
operator|->
name|parsing_headers
operator|)
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent unexpected http2 frame: %d"
argument_list|,
name|ctx
operator|->
name|type
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|stream_id
operator|&&
name|ctx
operator|->
name|stream_id
operator|!=
name|ctx
operator|->
name|id
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent frame for unknown stream %ui"
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
block|}
comment|/* frame payload */
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_RST_STREAM_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_rst_stream
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream rejected request with error %ui"
argument_list|,
name|ctx
operator|->
name|error
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_GOAWAY_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_goaway
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
comment|/*              * If stream_id is lower than one we use, our              * request won't be processed and needs to be retried.              * If stream_id is greater or equal to the one we use,              * we can continue normally (except we can't use this              * connection for additional requests).  If there is              * a real error, the connection will be closed.              */
if|if
condition|(
name|ctx
operator|->
name|stream_id
operator|<
name|ctx
operator|->
name|id
condition|)
block|{
comment|/* TODO: we can retry non-idempotent requests */
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent goaway with error %ui"
argument_list|,
name|ctx
operator|->
name|error
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
name|ctx
operator|->
name|goaway
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_WINDOW_UPDATE_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_window_update
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|in
condition|)
block|{
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_SETTINGS_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_settings
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|in
condition|)
block|{
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_PING_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_ping
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_PUSH_PROMISE_FRAME
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent unexpected push promise frame"
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|!=
name|NGX_HTTP_V2_HEADERS_FRAME
operator|&&
name|ctx
operator|->
name|type
operator|!=
name|NGX_HTTP_V2_CONTINUATION_FRAME
condition|)
block|{
comment|/* priority, unknown frames */
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|ctx
operator|->
name|rest
operator|-=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
name|b
operator|->
name|pos
operator|+=
name|ctx
operator|->
name|rest
expr_stmt|;
name|ctx
operator|->
name|rest
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
continue|continue;
block|}
comment|/* headers */
for|for
control|(
init|;
condition|;
control|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_header
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
comment|/* a header line has been parsed successfully */
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header: \"%V: %V\""
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|,
operator|&
name|ctx
operator|->
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|name
operator|.
name|len
operator|&&
name|ctx
operator|->
name|name
operator|.
name|data
index|[
literal|0
index|]
operator|==
literal|':'
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|name
operator|.
name|len
operator|!=
sizeof|sizeof
argument_list|(
literal|":status"
argument_list|)
operator|-
literal|1
operator|||
name|ngx_strncmp
argument_list|(
name|ctx
operator|->
name|name
operator|.
name|data
argument_list|,
literal|":status"
argument_list|,
sizeof|sizeof
argument_list|(
literal|":status"
argument_list|)
operator|-
literal|1
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid header \"%V: %V\""
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|,
operator|&
name|ctx
operator|->
name|value
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|status
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent duplicate :status header"
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
name|status_line
operator|=
operator|&
name|ctx
operator|->
name|value
expr_stmt|;
if|if
condition|(
name|status_line
operator|->
name|len
operator|!=
literal|3
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid :status \"%V\""
argument_list|,
name|status_line
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
name|status
operator|=
name|ngx_atoi
argument_list|(
name|status_line
operator|->
name|data
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid :status \"%V\""
argument_list|,
name|status_line
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
if|if
condition|(
name|status
operator|<
name|NGX_HTTP_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent unexpected :status \"%V\""
argument_list|,
name|status_line
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|=
name|status
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|state
operator|&&
name|u
operator|->
name|state
operator|->
name|status
operator|==
literal|0
condition|)
block|{
name|u
operator|->
name|state
operator|->
name|status
operator|=
name|status
expr_stmt|;
block|}
name|ctx
operator|->
name|status
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|else if
condition|(
operator|!
name|ctx
operator|->
name|status
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent no :status header"
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
name|h
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|u
operator|->
name|headers_in
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|h
operator|->
name|key
operator|=
name|ctx
operator|->
name|name
expr_stmt|;
name|h
operator|->
name|value
operator|=
name|ctx
operator|->
name|value
expr_stmt|;
name|h
operator|->
name|lowcase_key
operator|=
name|h
operator|->
name|key
operator|.
name|data
expr_stmt|;
name|h
operator|->
name|hash
operator|=
name|ngx_hash_key
argument_list|(
name|h
operator|->
name|key
operator|.
name|data
argument_list|,
name|h
operator|->
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
name|hh
operator|=
name|ngx_hash_find
argument_list|(
operator|&
name|umcf
operator|->
name|headers_in_hash
argument_list|,
name|h
operator|->
name|hash
argument_list|,
name|h
operator|->
name|lowcase_key
argument_list|,
name|h
operator|->
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hh
condition|)
block|{
name|rc
operator|=
name|hh
operator|->
name|handler
argument_list|(
name|r
argument_list|,
name|h
argument_list|,
name|hh
operator|->
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|rc
return|;
block|}
block|}
continue|continue;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_HTTP_PARSE_HEADER_DONE
condition|)
block|{
comment|/* a whole header has been parsed successfully */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|end_stream
condition|)
block|{
name|u
operator|->
name|headers_in
operator|.
name|content_length_n
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|in
operator|==
name|NULL
operator|&&
name|ctx
operator|->
name|out
operator|==
name|NULL
operator|&&
name|ctx
operator|->
name|output_closed
operator|&&
operator|!
name|ctx
operator|->
name|output_blocked
operator|&&
operator|!
name|ctx
operator|->
name|goaway
operator|&&
name|b
operator|->
name|last
operator|==
name|b
operator|->
name|pos
condition|)
block|{
name|u
operator|->
name|keepalive
operator|=
literal|1
expr_stmt|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
comment|/* there was error while a header line parsing */
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid header"
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_UPSTREAM_INVALID_HEADER
return|;
block|}
comment|/* rc == NGX_AGAIN */
if|if
condition|(
name|ctx
operator|->
name|rest
operator|==
literal|0
condition|)
block|{
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
continue|continue;
block|}
return|return
name|NGX_AGAIN
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_filter_init (void * data)
name|ngx_http_grpc_filter_init
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|r
operator|=
name|ctx
operator|->
name|request
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|==
name|NGX_HTTP_NO_CONTENT
operator|||
name|u
operator|->
name|headers_in
operator|.
name|status_n
operator|==
name|NGX_HTTP_NOT_MODIFIED
operator|||
name|r
operator|->
name|method
operator|==
name|NGX_HTTP_HEAD
condition|)
block|{
name|ctx
operator|->
name|length
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|->
name|length
operator|=
name|u
operator|->
name|headers_in
operator|.
name|content_length_n
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|end_stream
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|length
operator|>
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream prematurely closed stream"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|u
operator|->
name|length
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|done
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|u
operator|->
name|length
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_filter (void * data,ssize_t bytes)
name|ngx_http_grpc_filter
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|ssize_t
name|bytes
parameter_list|)
block|{
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
init|=
name|data
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|,
modifier|*
modifier|*
name|ll
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|r
operator|=
name|ctx
operator|->
name|request
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
name|b
operator|=
operator|&
name|u
operator|->
name|buffer
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc filter bytes:%z"
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
name|b
operator|->
name|last
operator|+=
name|bytes
expr_stmt|;
for|for
control|(
name|cl
operator|=
name|u
operator|->
name|out_bufs
operator|,
name|ll
operator|=
operator|&
name|u
operator|->
name|out_bufs
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|ctx
operator|->
name|state
operator|<
name|ngx_http_grpc_st_payload
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_frame
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|done
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|length
operator|>
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream prematurely closed stream"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
comment|/*                      * We have finished parsing the response and the                      * remaining control frames.  If there are unsent                      * control frames, post a write event to send them.                      */
if|if
condition|(
name|ctx
operator|->
name|out
condition|)
block|{
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
name|u
operator|->
name|length
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|in
operator|==
name|NULL
operator|&&
name|ctx
operator|->
name|output_closed
operator|&&
operator|!
name|ctx
operator|->
name|output_blocked
operator|&&
operator|!
name|ctx
operator|->
name|goaway
operator|&&
name|ctx
operator|->
name|state
operator|==
name|ngx_http_grpc_st_start
condition|)
block|{
name|u
operator|->
name|keepalive
operator|=
literal|1
expr_stmt|;
block|}
break|break;
block|}
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
operator|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_CONTINUATION_FRAME
operator|&&
operator|!
name|ctx
operator|->
name|parsing_headers
operator|)
operator|||
operator|(
name|ctx
operator|->
name|type
operator|!=
name|NGX_HTTP_V2_CONTINUATION_FRAME
operator|&&
name|ctx
operator|->
name|parsing_headers
operator|)
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent unexpected http2 frame: %d"
argument_list|,
name|ctx
operator|->
name|type
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_DATA_FRAME
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|stream_id
operator|!=
name|ctx
operator|->
name|id
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent data frame "
literal|"for unknown stream %ui"
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
name|ctx
operator|->
name|recv_window
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream violated stream flow control, "
literal|"received %uz data frame with window %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|,
name|ctx
operator|->
name|recv_window
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
name|ctx
operator|->
name|connection
operator|->
name|recv_window
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream violated connection flow control, "
literal|"received %uz data frame with window %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|,
name|ctx
operator|->
name|connection
operator|->
name|recv_window
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|recv_window
operator|-=
name|ctx
operator|->
name|rest
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|recv_window
operator|-=
name|ctx
operator|->
name|rest
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|connection
operator|->
name|recv_window
operator|<
name|NGX_HTTP_V2_MAX_WINDOW
operator|/
literal|4
operator|||
name|ctx
operator|->
name|recv_window
operator|<
name|NGX_HTTP_V2_MAX_WINDOW
operator|/
literal|4
condition|)
block|{
if|if
condition|(
name|ngx_http_grpc_send_window_update
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ctx
operator|->
name|stream_id
operator|&&
name|ctx
operator|->
name|stream_id
operator|!=
name|ctx
operator|->
name|id
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent frame for unknown stream %ui"
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|stream_id
operator|&&
name|ctx
operator|->
name|done
operator|&&
name|ctx
operator|->
name|type
operator|!=
name|NGX_HTTP_V2_RST_STREAM_FRAME
operator|&&
name|ctx
operator|->
name|type
operator|!=
name|NGX_HTTP_V2_WINDOW_UPDATE_FRAME
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent frame for closed stream %ui"
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|padding
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|state
operator|==
name|ngx_http_grpc_st_padding
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|ctx
operator|->
name|rest
operator|-=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
name|b
operator|->
name|pos
operator|+=
name|ctx
operator|->
name|rest
expr_stmt|;
name|ctx
operator|->
name|rest
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_END_STREAM_FLAG
condition|)
block|{
name|ctx
operator|->
name|done
operator|=
literal|1
expr_stmt|;
block|}
continue|continue;
block|}
comment|/* frame payload */
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_RST_STREAM_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_rst_stream
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|error
operator|||
operator|!
name|ctx
operator|->
name|done
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream rejected request with error %ui"
argument_list|,
name|ctx
operator|->
name|error
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|rst
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent frame for closed stream %ui"
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|rst
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_GOAWAY_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_goaway
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
comment|/*              * If stream_id is lower than one we use, our              * request won't be processed and needs to be retried.              * If stream_id is greater or equal to the one we use,              * we can continue normally (except we can't use this              * connection for additional requests).  If there is              * a real error, the connection will be closed.              */
if|if
condition|(
name|ctx
operator|->
name|stream_id
operator|<
name|ctx
operator|->
name|id
condition|)
block|{
comment|/* TODO: we can retry non-idempotent requests */
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent goaway with error %ui"
argument_list|,
name|ctx
operator|->
name|error
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|goaway
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_WINDOW_UPDATE_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_window_update
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|in
condition|)
block|{
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_SETTINGS_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_settings
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|in
condition|)
block|{
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_PING_FRAME
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_ping
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_post_event
argument_list|(
name|u
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_PUSH_PROMISE_FRAME
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent unexpected push promise frame"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_HEADERS_FRAME
operator|||
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_CONTINUATION_FRAME
condition|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_header
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
comment|/* a header line has been parsed successfully */
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc trailer: \"%V: %V\""
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|,
operator|&
name|ctx
operator|->
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|name
operator|.
name|len
operator|&&
name|ctx
operator|->
name|name
operator|.
name|data
index|[
literal|0
index|]
operator|==
literal|':'
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid "
literal|"trailer \"%V: %V\""
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|,
operator|&
name|ctx
operator|->
name|value
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|h
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|u
operator|->
name|headers_in
operator|.
name|trailers
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|h
operator|->
name|key
operator|=
name|ctx
operator|->
name|name
expr_stmt|;
name|h
operator|->
name|value
operator|=
name|ctx
operator|->
name|value
expr_stmt|;
name|h
operator|->
name|lowcase_key
operator|=
name|h
operator|->
name|key
operator|.
name|data
expr_stmt|;
name|h
operator|->
name|hash
operator|=
name|ngx_hash_key
argument_list|(
name|h
operator|->
name|key
operator|.
name|data
argument_list|,
name|h
operator|->
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_HTTP_PARSE_HEADER_DONE
condition|)
block|{
comment|/* a whole header has been parsed successfully */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc trailer done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|end_stream
condition|)
block|{
name|ctx
operator|->
name|done
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent trailer without "
literal|"end stream flag"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
comment|/* there was error while a header line parsing */
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid trailer"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_HTTP_PARSE_HEADER_DONE
condition|)
block|{
continue|continue;
block|}
comment|/* rc == NGX_AGAIN */
if|if
condition|(
name|ctx
operator|->
name|rest
operator|==
literal|0
condition|)
block|{
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
continue|continue;
block|}
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|type
operator|!=
name|NGX_HTTP_V2_DATA_FRAME
condition|)
block|{
comment|/* priority, unknown frames */
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|ctx
operator|->
name|rest
operator|-=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
name|b
operator|->
name|pos
operator|+=
name|ctx
operator|->
name|rest
expr_stmt|;
name|ctx
operator|->
name|rest
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
continue|continue;
block|}
comment|/*          * data frame:          *          * +---------------+          * |Pad Length? (8)|          * +---------------+-----------------------------------------------+          * |                            Data (*)                         ...          * +---------------------------------------------------------------+          * |                           Padding (*)                       ...          * +---------------------------------------------------------------+          */
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_PADDED_FLAG
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|rest
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too short http2 frame"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|b
operator|->
name|pos
operator|==
name|b
operator|->
name|last
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|ctx
operator|->
name|flags
operator|&=
operator|~
name|NGX_HTTP_V2_PADDED_FLAG
expr_stmt|;
name|ctx
operator|->
name|padding
operator|=
operator|*
name|b
operator|->
name|pos
operator|++
expr_stmt|;
name|ctx
operator|->
name|rest
operator|-=
literal|1
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|padding
operator|>
name|ctx
operator|->
name|rest
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent http2 frame with too long "
literal|"padding: %d in frame %uz"
argument_list|,
name|ctx
operator|->
name|padding
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ctx
operator|->
name|rest
operator|==
name|ctx
operator|->
name|padding
condition|)
block|{
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|b
operator|->
name|pos
operator|==
name|b
operator|->
name|last
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|cl
operator|=
name|ngx_chain_get_free_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|&
name|u
operator|->
name|free_bufs
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|ll
operator|=
name|cl
expr_stmt|;
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
name|buf
operator|=
name|cl
operator|->
name|buf
expr_stmt|;
name|buf
operator|->
name|flush
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|memory
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|pos
operator|=
name|b
operator|->
name|pos
expr_stmt|;
name|buf
operator|->
name|tag
operator|=
name|u
operator|->
name|output
operator|.
name|tag
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc output buf %p"
argument_list|,
name|buf
operator|->
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
operator|-
name|ctx
operator|->
name|padding
condition|)
block|{
name|ctx
operator|->
name|rest
operator|-=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|b
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|length
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
operator|>
name|ctx
operator|->
name|length
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent response body larger "
literal|"than indicated content length"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|length
operator|-=
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
expr_stmt|;
block|}
return|return
name|NGX_AGAIN
return|;
block|}
name|b
operator|->
name|pos
operator|+=
name|ctx
operator|->
name|rest
operator|-
name|ctx
operator|->
name|padding
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|b
operator|->
name|pos
expr_stmt|;
name|ctx
operator|->
name|rest
operator|=
name|ctx
operator|->
name|padding
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|length
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
operator|>
name|ctx
operator|->
name|length
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent response body larger "
literal|"than indicated content length"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|length
operator|-=
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
expr_stmt|;
block|}
name|done
label|:
if|if
condition|(
name|ctx
operator|->
name|padding
condition|)
block|{
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_padding
expr_stmt|;
continue|continue;
block|}
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_END_STREAM_FLAG
condition|)
block|{
name|ctx
operator|->
name|done
operator|=
literal|1
expr_stmt|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_parse_frame (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_grpc_parse_frame
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|ngx_http_grpc_state_e
name|state
decl_stmt|;
name|state
operator|=
name|ctx
operator|->
name|state
expr_stmt|;
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|b
operator|->
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                        "grpc frame byte: %02Xd, s:%d", ch, state);
endif|#
directive|endif
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|ngx_http_grpc_st_start
case|:
name|ctx
operator|->
name|rest
operator|=
name|ch
operator|<<
literal|16
expr_stmt|;
name|state
operator|=
name|ngx_http_grpc_st_length_2
expr_stmt|;
break|break;
case|case
name|ngx_http_grpc_st_length_2
case|:
name|ctx
operator|->
name|rest
operator||=
name|ch
operator|<<
literal|8
expr_stmt|;
name|state
operator|=
name|ngx_http_grpc_st_length_3
expr_stmt|;
break|break;
case|case
name|ngx_http_grpc_st_length_3
case|:
name|ctx
operator|->
name|rest
operator||=
name|ch
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
name|NGX_HTTP_V2_DEFAULT_FRAME_SIZE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too large http2 frame: %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|state
operator|=
name|ngx_http_grpc_st_type
expr_stmt|;
break|break;
case|case
name|ngx_http_grpc_st_type
case|:
name|ctx
operator|->
name|type
operator|=
name|ch
expr_stmt|;
name|state
operator|=
name|ngx_http_grpc_st_flags
expr_stmt|;
break|break;
case|case
name|ngx_http_grpc_st_flags
case|:
name|ctx
operator|->
name|flags
operator|=
name|ch
expr_stmt|;
name|state
operator|=
name|ngx_http_grpc_st_stream_id
expr_stmt|;
break|break;
case|case
name|ngx_http_grpc_st_stream_id
case|:
name|ctx
operator|->
name|stream_id
operator|=
operator|(
name|ch
operator|&
literal|0x7f
operator|)
operator|<<
literal|24
expr_stmt|;
name|state
operator|=
name|ngx_http_grpc_st_stream_id_2
expr_stmt|;
break|break;
case|case
name|ngx_http_grpc_st_stream_id_2
case|:
name|ctx
operator|->
name|stream_id
operator||=
name|ch
operator|<<
literal|16
expr_stmt|;
name|state
operator|=
name|ngx_http_grpc_st_stream_id_3
expr_stmt|;
break|break;
case|case
name|ngx_http_grpc_st_stream_id_3
case|:
name|ctx
operator|->
name|stream_id
operator||=
name|ch
operator|<<
literal|8
expr_stmt|;
name|state
operator|=
name|ngx_http_grpc_st_stream_id_4
expr_stmt|;
break|break;
case|case
name|ngx_http_grpc_st_stream_id_4
case|:
name|ctx
operator|->
name|stream_id
operator||=
name|ch
expr_stmt|;
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc frame: %d, len: %uz, f:%d, i:%ui"
argument_list|,
name|ctx
operator|->
name|type
argument_list|,
name|ctx
operator|->
name|rest
argument_list|,
name|ctx
operator|->
name|flags
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_payload
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
comment|/* suppress warning */
case|case
name|ngx_http_grpc_st_payload
case|:
case|case
name|ngx_http_grpc_st_padding
case|:
break|break;
block|}
block|}
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|state
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_parse_header (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_grpc_parse_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|size_t
name|min
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
DECL|enum|__anon2c2debe70703
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_padding_length
name|sw_padding_length
block|,
DECL|enumerator|sw_dependency
name|sw_dependency
block|,
DECL|enumerator|sw_dependency_2
name|sw_dependency_2
block|,
DECL|enumerator|sw_dependency_3
name|sw_dependency_3
block|,
DECL|enumerator|sw_dependency_4
name|sw_dependency_4
block|,
DECL|enumerator|sw_weight
name|sw_weight
block|,
DECL|enumerator|sw_fragment
name|sw_fragment
block|,
DECL|enumerator|sw_padding
name|sw_padding
block|}
name|state
enum|;
name|state
operator|=
name|ctx
operator|->
name|frame_state
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|sw_start
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc parse header: start"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_HEADERS_FRAME
condition|)
block|{
name|ctx
operator|->
name|parsing_headers
operator|=
literal|1
expr_stmt|;
name|ctx
operator|->
name|fragment_state
operator|=
literal|0
expr_stmt|;
name|min
operator|=
operator|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_PADDED_FLAG
condition|?
literal|1
else|:
literal|0
operator|)
operator|+
operator|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_PRIORITY_FLAG
condition|?
literal|5
else|:
literal|0
operator|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|<
name|min
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent headers frame "
literal|"with invalid length: %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_END_STREAM_FLAG
condition|)
block|{
name|ctx
operator|->
name|end_stream
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_PADDED_FLAG
condition|)
block|{
name|state
operator|=
name|sw_padding_length
expr_stmt|;
block|}
if|else if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_PRIORITY_FLAG
condition|)
block|{
name|state
operator|=
name|sw_dependency
expr_stmt|;
block|}
else|else
block|{
name|state
operator|=
name|sw_fragment
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|ctx
operator|->
name|type
operator|==
name|NGX_HTTP_V2_CONTINUATION_FRAME
condition|)
block|{
name|state
operator|=
name|sw_fragment
expr_stmt|;
block|}
name|ctx
operator|->
name|padding
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|<
name|sw_fragment
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|last
operator|=
name|b
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|last
operator|=
name|b
operator|->
name|pos
operator|+
name|ctx
operator|->
name|rest
expr_stmt|;
block|}
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                            "grpc header byte: %02Xd s:%d", ch, state);
endif|#
directive|endif
comment|/*              * headers frame:              *              * +---------------+              * |Pad Length? (8)|              * +-+-------------+----------------------------------------------+              * |E|                 Stream Dependency? (31)                    |              * +-+-------------+----------------------------------------------+              * |  Weight? (8)  |              * +-+-------------+----------------------------------------------+              * |                   Header Block Fragment (*)                ...              * +--------------------------------------------------------------+              * |                           Padding (*)                      ...              * +--------------------------------------------------------------+              */
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|sw_padding_length
case|:
name|ctx
operator|->
name|padding
operator|=
name|ch
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_PRIORITY_FLAG
condition|)
block|{
name|state
operator|=
name|sw_dependency
expr_stmt|;
break|break;
block|}
goto|goto
name|fragment
goto|;
case|case
name|sw_dependency
case|:
name|state
operator|=
name|sw_dependency_2
expr_stmt|;
break|break;
case|case
name|sw_dependency_2
case|:
name|state
operator|=
name|sw_dependency_3
expr_stmt|;
break|break;
case|case
name|sw_dependency_3
case|:
name|state
operator|=
name|sw_dependency_4
expr_stmt|;
break|break;
case|case
name|sw_dependency_4
case|:
name|state
operator|=
name|sw_weight
expr_stmt|;
break|break;
case|case
name|sw_weight
case|:
goto|goto
name|fragment
goto|;
comment|/* suppress warning */
case|case
name|sw_start
case|:
case|case
name|sw_fragment
case|:
case|case
name|sw_padding
case|:
break|break;
block|}
block|}
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
name|fragment
label|:
name|p
operator|++
expr_stmt|;
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|padding
operator|>
name|ctx
operator|->
name|rest
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent http2 frame with too long "
literal|"padding: %d in frame %uz"
argument_list|,
name|ctx
operator|->
name|padding
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|state
operator|=
name|sw_fragment
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|==
name|sw_fragment
condition|)
block|{
name|rc
operator|=
name|ngx_http_grpc_parse_fragment
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
comment|/* rc == NGX_DONE */
name|state
operator|=
name|sw_padding
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|==
name|sw_padding
condition|)
block|{
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|ctx
operator|->
name|rest
operator|-=
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|b
operator|->
name|last
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
name|b
operator|->
name|pos
operator|+=
name|ctx
operator|->
name|rest
expr_stmt|;
name|ctx
operator|->
name|rest
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_END_HEADERS_FLAG
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|fragment_state
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent truncated http2 header"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|parsing_headers
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_HTTP_PARSE_HEADER_DONE
return|;
block|}
return|return
name|NGX_AGAIN
return|;
block|}
comment|/* unreachable */
return|return
name|NGX_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_parse_fragment (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_grpc_parse_fragment
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ngx_uint_t
name|index
decl_stmt|,
name|size_update
decl_stmt|;
DECL|enum|__anon2c2debe70803
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_index
name|sw_index
block|,
DECL|enumerator|sw_name_length
name|sw_name_length
block|,
DECL|enumerator|sw_name_length_2
name|sw_name_length_2
block|,
DECL|enumerator|sw_name_length_3
name|sw_name_length_3
block|,
DECL|enumerator|sw_name_length_4
name|sw_name_length_4
block|,
DECL|enumerator|sw_name
name|sw_name
block|,
DECL|enumerator|sw_name_bytes
name|sw_name_bytes
block|,
DECL|enumerator|sw_value_length
name|sw_value_length
block|,
DECL|enumerator|sw_value_length_2
name|sw_value_length_2
block|,
DECL|enumerator|sw_value_length_3
name|sw_value_length_3
block|,
DECL|enumerator|sw_value_length_4
name|sw_value_length_4
block|,
DECL|enumerator|sw_value
name|sw_value
block|,
DECL|enumerator|sw_value_bytes
name|sw_value_bytes
block|}
name|state
enum|;
comment|/* header block fragment */
if|#
directive|if
literal|0
block_content|ngx_log_debug3(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                    "grpc header fragment %p:%p rest:%uz",                    b->pos, b->last, ctx->rest);
endif|#
directive|endif
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
operator|-
name|ctx
operator|->
name|padding
condition|)
block|{
name|last
operator|=
name|b
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|last
operator|=
name|b
operator|->
name|pos
operator|+
name|ctx
operator|->
name|rest
operator|-
name|ctx
operator|->
name|padding
expr_stmt|;
block|}
name|state
operator|=
name|ctx
operator|->
name|fragment_state
expr_stmt|;
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                        "grpc header byte: %02Xd s:%d", ch, state);
endif|#
directive|endif
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|sw_start
case|:
name|ctx
operator|->
name|index
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|&
literal|0x80
operator|)
operator|==
literal|0x80
condition|)
block|{
comment|/*                  * indexed header:                  *                  *   0   1   2   3   4   5   6   7                  * +---+---+---+---+---+---+---+---+                  * | 1 |        Index (7+)         |                  * +---+---------------------------+                  */
name|index
operator|=
name|ch
operator|&
operator|~
literal|0x80
expr_stmt|;
if|if
condition|(
name|index
operator|==
literal|0
operator|||
name|index
operator|>
literal|61
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid http2 "
literal|"table index: %ui"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc indexed header: %ui"
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|index
operator|=
name|index
expr_stmt|;
name|ctx
operator|->
name|literal
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|else if
condition|(
operator|(
name|ch
operator|&
literal|0xc0
operator|)
operator|==
literal|0x40
condition|)
block|{
comment|/*                  * literal header with incremental indexing:                  *                  *   0   1   2   3   4   5   6   7                  * +---+---+---+---+---+---+---+---+                  * | 0 | 1 |      Index (6+)       |                  * +---+---+-----------------------+                  * | H |     Value Length (7+)     |                  * +---+---------------------------+                  * | Value String (Length octets)  |                  * +-------------------------------+                  *                  *   0   1   2   3   4   5   6   7                  * +---+---+---+---+---+---+---+---+                  * | 0 | 1 |           0           |                  * +---+---+-----------------------+                  * | H |     Name Length (7+)      |                  * +---+---------------------------+                  * |  Name String (Length octets)  |                  * +---+---------------------------+                  * | H |     Value Length (7+)     |                  * +---+---------------------------+                  * | Value String (Length octets)  |                  * +-------------------------------+                  */
name|index
operator|=
name|ch
operator|&
operator|~
literal|0xc0
expr_stmt|;
if|if
condition|(
name|index
operator|>
literal|61
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid http2 "
literal|"table index: %ui"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc literal header: %ui"
argument_list|,
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|==
literal|0
condition|)
block|{
name|state
operator|=
name|sw_name_length
expr_stmt|;
break|break;
block|}
name|ctx
operator|->
name|index
operator|=
name|index
expr_stmt|;
name|ctx
operator|->
name|literal
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_value_length
expr_stmt|;
break|break;
block|}
if|else if
condition|(
operator|(
name|ch
operator|&
literal|0xe0
operator|)
operator|==
literal|0x20
condition|)
block|{
comment|/*                  * dynamic table size update:                  *                  *   0   1   2   3   4   5   6   7                  * +---+---+---+---+---+---+---+---+                  * | 0 | 0 | 1 |   Max size (5+)   |                  * +---+---------------------------+                  */
name|size_update
operator|=
name|ch
operator|&
operator|~
literal|0xe0
expr_stmt|;
if|if
condition|(
name|size_update
operator|>
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid http2 "
literal|"dynamic table size update: %ui"
argument_list|,
name|size_update
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc table size update: %ui"
argument_list|,
name|size_update
argument_list|)
expr_stmt|;
break|break;
block|}
if|else if
condition|(
operator|(
name|ch
operator|&
literal|0xf0
operator|)
operator|==
literal|0x10
condition|)
block|{
comment|/*                  *  literal header field never indexed:                  *                  *   0   1   2   3   4   5   6   7                  * +---+---+---+---+---+---+---+---+                  * | 0 | 0 | 0 | 1 |  Index (4+)   |                  * +---+---+-----------------------+                  * | H |     Value Length (7+)     |                  * +---+---------------------------+                  * | Value String (Length octets)  |                  * +-------------------------------+                  *                  *   0   1   2   3   4   5   6   7                  * +---+---+---+---+---+---+---+---+                  * | 0 | 0 | 0 | 1 |       0       |                  * +---+---+-----------------------+                  * | H |     Name Length (7+)      |                  * +---+---------------------------+                  * |  Name String (Length octets)  |                  * +---+---------------------------+                  * | H |     Value Length (7+)     |                  * +---+---------------------------+                  * | Value String (Length octets)  |                  * +-------------------------------+                  */
name|index
operator|=
name|ch
operator|&
operator|~
literal|0xf0
expr_stmt|;
if|if
condition|(
name|index
operator|==
literal|0x0f
condition|)
block|{
name|ctx
operator|->
name|index
operator|=
name|index
expr_stmt|;
name|ctx
operator|->
name|literal
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_index
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|index
operator|==
literal|0
condition|)
block|{
name|state
operator|=
name|sw_name_length
expr_stmt|;
break|break;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc literal header never indexed: %ui"
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|index
operator|=
name|index
expr_stmt|;
name|ctx
operator|->
name|literal
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_value_length
expr_stmt|;
break|break;
block|}
if|else if
condition|(
operator|(
name|ch
operator|&
literal|0xf0
operator|)
operator|==
literal|0x00
condition|)
block|{
comment|/*                  * literal header field without indexing:                  *                  *   0   1   2   3   4   5   6   7                  * +---+---+---+---+---+---+---+---+                  * | 0 | 0 | 0 | 0 |  Index (4+)   |                  * +---+---+-----------------------+                  * | H |     Value Length (7+)     |                  * +---+---------------------------+                  * | Value String (Length octets)  |                  * +-------------------------------+                  *                  *   0   1   2   3   4   5   6   7                  * +---+---+---+---+---+---+---+---+                  * | 0 | 0 | 0 | 0 |       0       |                  * +---+---+-----------------------+                  * | H |     Name Length (7+)      |                  * +---+---------------------------+                  * |  Name String (Length octets)  |                  * +---+---------------------------+                  * | H |     Value Length (7+)     |                  * +---+---------------------------+                  * | Value String (Length octets)  |                  * +-------------------------------+                  */
name|index
operator|=
name|ch
operator|&
operator|~
literal|0xf0
expr_stmt|;
if|if
condition|(
name|index
operator|==
literal|0x0f
condition|)
block|{
name|ctx
operator|->
name|index
operator|=
name|index
expr_stmt|;
name|ctx
operator|->
name|literal
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_index
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|index
operator|==
literal|0
condition|)
block|{
name|state
operator|=
name|sw_name_length
expr_stmt|;
break|break;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc literal header without indexing: %ui"
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|index
operator|=
name|index
expr_stmt|;
name|ctx
operator|->
name|literal
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_value_length
expr_stmt|;
break|break;
block|}
comment|/* not reached */
return|return
name|NGX_ERROR
return|;
case|case
name|sw_index
case|:
name|ctx
operator|->
name|index
operator|=
name|ctx
operator|->
name|index
operator|+
operator|(
name|ch
operator|&
operator|~
literal|0x80
operator|)
expr_stmt|;
if|if
condition|(
name|ch
operator|&
literal|0x80
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent http2 table index "
literal|"with continuation flag"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|index
operator|>
literal|61
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid http2 "
literal|"table index: %ui"
argument_list|,
name|ctx
operator|->
name|index
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc header index: %ui"
argument_list|,
name|ctx
operator|->
name|index
argument_list|)
expr_stmt|;
name|state
operator|=
name|sw_value_length
expr_stmt|;
break|break;
case|case
name|sw_name_length
case|:
name|ctx
operator|->
name|field_huffman
operator|=
name|ch
operator|&
literal|0x80
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|ctx
operator|->
name|field_length
operator|=
name|ch
operator|&
operator|~
literal|0x80
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|field_length
operator|==
literal|0x7f
condition|)
block|{
name|state
operator|=
name|sw_name_length_2
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ctx
operator|->
name|field_length
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent zero http2 "
literal|"header name length"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|state
operator|=
name|sw_name
expr_stmt|;
break|break;
case|case
name|sw_name_length_2
case|:
name|ctx
operator|->
name|field_length
operator|+=
name|ch
operator|&
operator|~
literal|0x80
expr_stmt|;
if|if
condition|(
name|ch
operator|&
literal|0x80
condition|)
block|{
name|state
operator|=
name|sw_name_length_3
expr_stmt|;
break|break;
block|}
name|state
operator|=
name|sw_name
expr_stmt|;
break|break;
case|case
name|sw_name_length_3
case|:
name|ctx
operator|->
name|field_length
operator|+=
operator|(
name|ch
operator|&
operator|~
literal|0x80
operator|)
operator|<<
literal|7
expr_stmt|;
if|if
condition|(
name|ch
operator|&
literal|0x80
condition|)
block|{
name|state
operator|=
name|sw_name_length_4
expr_stmt|;
break|break;
block|}
name|state
operator|=
name|sw_name
expr_stmt|;
break|break;
case|case
name|sw_name_length_4
case|:
name|ctx
operator|->
name|field_length
operator|+=
operator|(
name|ch
operator|&
operator|~
literal|0x80
operator|)
operator|<<
literal|14
expr_stmt|;
if|if
condition|(
name|ch
operator|&
literal|0x80
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too large http2 "
literal|"header name length"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|state
operator|=
name|sw_name
expr_stmt|;
break|break;
case|case
name|sw_name
case|:
name|ctx
operator|->
name|name
operator|.
name|len
operator|=
name|ctx
operator|->
name|field_huffman
condition|?
name|ctx
operator|->
name|field_length
operator|*
literal|8
operator|/
literal|5
else|:
name|ctx
operator|->
name|field_length
expr_stmt|;
name|ctx
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|ctx
operator|->
name|name
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|field_end
operator|=
name|ctx
operator|->
name|name
operator|.
name|data
expr_stmt|;
name|ctx
operator|->
name|field_rest
operator|=
name|ctx
operator|->
name|field_length
expr_stmt|;
name|ctx
operator|->
name|field_state
operator|=
literal|0
expr_stmt|;
name|state
operator|=
name|sw_name_bytes
expr_stmt|;
comment|/* fall through */
case|case
name|sw_name_bytes
case|:
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc name: len:%uz h:%d last:%uz, rest:%uz"
argument_list|,
name|ctx
operator|->
name|field_length
argument_list|,
name|ctx
operator|->
name|field_huffman
argument_list|,
name|last
operator|-
name|p
argument_list|,
name|ctx
operator|->
name|rest
operator|-
operator|(
name|p
operator|-
name|b
operator|->
name|pos
operator|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|ngx_min
argument_list|(
name|last
operator|-
name|p
argument_list|,
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|field_rest
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|field_rest
operator|-=
name|size
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|field_huffman
condition|)
block|{
if|if
condition|(
name|ngx_http_huff_decode
argument_list|(
operator|&
name|ctx
operator|->
name|field_state
argument_list|,
name|p
argument_list|,
name|size
argument_list|,
operator|&
name|ctx
operator|->
name|field_end
argument_list|,
name|ctx
operator|->
name|field_rest
operator|==
literal|0
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid encoded header"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|name
operator|.
name|len
operator|=
name|ctx
operator|->
name|field_end
operator|-
name|ctx
operator|->
name|name
operator|.
name|data
expr_stmt|;
name|ctx
operator|->
name|name
operator|.
name|data
index|[
name|ctx
operator|->
name|name
operator|.
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|->
name|field_end
operator|=
name|ngx_cpymem
argument_list|(
name|ctx
operator|->
name|field_end
argument_list|,
name|p
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|name
operator|.
name|data
index|[
name|ctx
operator|->
name|name
operator|.
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|p
operator|+=
name|size
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|field_rest
operator|==
literal|0
condition|)
block|{
name|state
operator|=
name|sw_value_length
expr_stmt|;
block|}
break|break;
case|case
name|sw_value_length
case|:
name|ctx
operator|->
name|field_huffman
operator|=
name|ch
operator|&
literal|0x80
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|ctx
operator|->
name|field_length
operator|=
name|ch
operator|&
operator|~
literal|0x80
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|field_length
operator|==
literal|0x7f
condition|)
block|{
name|state
operator|=
name|sw_value_length_2
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ctx
operator|->
name|field_length
operator|==
literal|0
condition|)
block|{
name|ngx_str_set
argument_list|(
operator|&
name|ctx
operator|->
name|value
argument_list|,
literal|""
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
case|case
name|sw_value_length_2
case|:
name|ctx
operator|->
name|field_length
operator|+=
name|ch
operator|&
operator|~
literal|0x80
expr_stmt|;
if|if
condition|(
name|ch
operator|&
literal|0x80
condition|)
block|{
name|state
operator|=
name|sw_value_length_3
expr_stmt|;
break|break;
block|}
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
case|case
name|sw_value_length_3
case|:
name|ctx
operator|->
name|field_length
operator|+=
operator|(
name|ch
operator|&
operator|~
literal|0x80
operator|)
operator|<<
literal|7
expr_stmt|;
if|if
condition|(
name|ch
operator|&
literal|0x80
condition|)
block|{
name|state
operator|=
name|sw_value_length_4
expr_stmt|;
break|break;
block|}
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
case|case
name|sw_value_length_4
case|:
name|ctx
operator|->
name|field_length
operator|+=
operator|(
name|ch
operator|&
operator|~
literal|0x80
operator|)
operator|<<
literal|14
expr_stmt|;
if|if
condition|(
name|ch
operator|&
literal|0x80
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too large http2 "
literal|"header value length"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
case|case
name|sw_value
case|:
name|ctx
operator|->
name|value
operator|.
name|len
operator|=
name|ctx
operator|->
name|field_huffman
condition|?
name|ctx
operator|->
name|field_length
operator|*
literal|8
operator|/
literal|5
else|:
name|ctx
operator|->
name|field_length
expr_stmt|;
name|ctx
operator|->
name|value
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|ctx
operator|->
name|value
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|value
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|field_end
operator|=
name|ctx
operator|->
name|value
operator|.
name|data
expr_stmt|;
name|ctx
operator|->
name|field_rest
operator|=
name|ctx
operator|->
name|field_length
expr_stmt|;
name|ctx
operator|->
name|field_state
operator|=
literal|0
expr_stmt|;
name|state
operator|=
name|sw_value_bytes
expr_stmt|;
comment|/* fall through */
case|case
name|sw_value_bytes
case|:
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc value: len:%uz h:%d last:%uz, rest:%uz"
argument_list|,
name|ctx
operator|->
name|field_length
argument_list|,
name|ctx
operator|->
name|field_huffman
argument_list|,
name|last
operator|-
name|p
argument_list|,
name|ctx
operator|->
name|rest
operator|-
operator|(
name|p
operator|-
name|b
operator|->
name|pos
operator|)
argument_list|)
expr_stmt|;
name|size
operator|=
name|ngx_min
argument_list|(
name|last
operator|-
name|p
argument_list|,
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|field_rest
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|field_rest
operator|-=
name|size
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|field_huffman
condition|)
block|{
if|if
condition|(
name|ngx_http_huff_decode
argument_list|(
operator|&
name|ctx
operator|->
name|field_state
argument_list|,
name|p
argument_list|,
name|size
argument_list|,
operator|&
name|ctx
operator|->
name|field_end
argument_list|,
name|ctx
operator|->
name|field_rest
operator|==
literal|0
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid encoded header"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|value
operator|.
name|len
operator|=
name|ctx
operator|->
name|field_end
operator|-
name|ctx
operator|->
name|value
operator|.
name|data
expr_stmt|;
name|ctx
operator|->
name|value
operator|.
name|data
index|[
name|ctx
operator|->
name|value
operator|.
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|->
name|field_end
operator|=
name|ngx_cpymem
argument_list|(
name|ctx
operator|->
name|field_end
argument_list|,
name|p
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|value
operator|.
name|data
index|[
name|ctx
operator|->
name|value
operator|.
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|p
operator|+=
name|size
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|field_rest
operator|==
literal|0
condition|)
block|{
goto|goto
name|done
goto|;
block|}
break|break;
block|}
continue|continue;
name|done
label|:
name|p
operator|++
expr_stmt|;
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|ctx
operator|->
name|fragment_state
operator|=
name|sw_start
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|index
condition|)
block|{
name|ctx
operator|->
name|name
operator|=
operator|*
name|ngx_http_v2_get_static_name
argument_list|(
name|ctx
operator|->
name|index
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|index
operator|&&
operator|!
name|ctx
operator|->
name|literal
condition|)
block|{
name|ctx
operator|->
name|value
operator|=
operator|*
name|ngx_http_v2_get_static_value
argument_list|(
name|ctx
operator|->
name|index
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ctx
operator|->
name|index
condition|)
block|{
if|if
condition|(
name|ngx_http_grpc_validate_header_name
argument_list|(
name|r
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid header: \"%V: %V\""
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|,
operator|&
name|ctx
operator|->
name|value
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
if|if
condition|(
operator|!
name|ctx
operator|->
name|index
operator|||
name|ctx
operator|->
name|literal
condition|)
block|{
if|if
condition|(
name|ngx_http_grpc_validate_header_value
argument_list|(
name|r
argument_list|,
operator|&
name|ctx
operator|->
name|value
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent invalid header: \"%V: %V\""
argument_list|,
operator|&
name|ctx
operator|->
name|name
argument_list|,
operator|&
name|ctx
operator|->
name|value
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|ctx
operator|->
name|fragment_state
operator|=
name|state
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
name|ctx
operator|->
name|padding
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
return|return
name|NGX_DONE
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_validate_header_name (ngx_http_request_t * r,ngx_str_t * s)
name|ngx_http_grpc_validate_header_name
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|s
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
name|s
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|':'
operator|&&
name|i
operator|>
literal|0
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ch
operator|>=
literal|'A'
operator|&&
name|ch
operator|<=
literal|'Z'
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ch
operator|<=
literal|0x20
operator|||
name|ch
operator|==
literal|0x7f
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_validate_header_value (ngx_http_request_t * r,ngx_str_t * s)
name|ngx_http_grpc_validate_header_value
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|s
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|=
name|s
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'\0'
operator|||
name|ch
operator|==
name|CR
operator|||
name|ch
operator|==
name|LF
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_parse_rst_stream (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_grpc_parse_rst_stream
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
DECL|enum|__anon2c2debe70903
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_error_2
name|sw_error_2
block|,
DECL|enumerator|sw_error_3
name|sw_error_3
block|,
DECL|enumerator|sw_error_4
name|sw_error_4
block|}
name|state
enum|;
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|last
operator|=
name|b
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|last
operator|=
name|b
operator|->
name|pos
operator|+
name|ctx
operator|->
name|rest
expr_stmt|;
block|}
name|state
operator|=
name|ctx
operator|->
name|frame_state
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|sw_start
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|rest
operator|!=
literal|4
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent rst stream frame "
literal|"with invalid length: %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                        "grpc rst byte: %02Xd s:%d", ch, state);
endif|#
directive|endif
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|sw_start
case|:
name|ctx
operator|->
name|error
operator|=
operator|(
name|ngx_uint_t
operator|)
name|ch
operator|<<
literal|24
expr_stmt|;
name|state
operator|=
name|sw_error_2
expr_stmt|;
break|break;
case|case
name|sw_error_2
case|:
name|ctx
operator|->
name|error
operator||=
name|ch
operator|<<
literal|16
expr_stmt|;
name|state
operator|=
name|sw_error_3
expr_stmt|;
break|break;
case|case
name|sw_error_3
case|:
name|ctx
operator|->
name|error
operator||=
name|ch
operator|<<
literal|8
expr_stmt|;
name|state
operator|=
name|sw_error_4
expr_stmt|;
break|break;
case|case
name|sw_error_4
case|:
name|ctx
operator|->
name|error
operator||=
name|ch
expr_stmt|;
name|state
operator|=
name|sw_start
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc error: %ui"
argument_list|,
name|ctx
operator|->
name|error
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
literal|0
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_parse_goaway (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_grpc_parse_goaway
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
DECL|enum|__anon2c2debe70a03
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_last_stream_id_2
name|sw_last_stream_id_2
block|,
DECL|enumerator|sw_last_stream_id_3
name|sw_last_stream_id_3
block|,
DECL|enumerator|sw_last_stream_id_4
name|sw_last_stream_id_4
block|,
DECL|enumerator|sw_error
name|sw_error
block|,
DECL|enumerator|sw_error_2
name|sw_error_2
block|,
DECL|enumerator|sw_error_3
name|sw_error_3
block|,
DECL|enumerator|sw_error_4
name|sw_error_4
block|,
DECL|enumerator|sw_debug
name|sw_debug
block|}
name|state
enum|;
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|last
operator|=
name|b
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|last
operator|=
name|b
operator|->
name|pos
operator|+
name|ctx
operator|->
name|rest
expr_stmt|;
block|}
name|state
operator|=
name|ctx
operator|->
name|frame_state
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|sw_start
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|stream_id
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent goaway frame "
literal|"with non-zero stream id: %ui"
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|rest
operator|<
literal|8
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent goaway frame "
literal|"with invalid length: %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                        "grpc goaway byte: %02Xd s:%d", ch, state);
endif|#
directive|endif
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|sw_start
case|:
name|ctx
operator|->
name|stream_id
operator|=
operator|(
name|ch
operator|&
literal|0x7f
operator|)
operator|<<
literal|24
expr_stmt|;
name|state
operator|=
name|sw_last_stream_id_2
expr_stmt|;
break|break;
case|case
name|sw_last_stream_id_2
case|:
name|ctx
operator|->
name|stream_id
operator||=
name|ch
operator|<<
literal|16
expr_stmt|;
name|state
operator|=
name|sw_last_stream_id_3
expr_stmt|;
break|break;
case|case
name|sw_last_stream_id_3
case|:
name|ctx
operator|->
name|stream_id
operator||=
name|ch
operator|<<
literal|8
expr_stmt|;
name|state
operator|=
name|sw_last_stream_id_4
expr_stmt|;
break|break;
case|case
name|sw_last_stream_id_4
case|:
name|ctx
operator|->
name|stream_id
operator||=
name|ch
expr_stmt|;
name|state
operator|=
name|sw_error
expr_stmt|;
break|break;
case|case
name|sw_error
case|:
name|ctx
operator|->
name|error
operator|=
operator|(
name|ngx_uint_t
operator|)
name|ch
operator|<<
literal|24
expr_stmt|;
name|state
operator|=
name|sw_error_2
expr_stmt|;
break|break;
case|case
name|sw_error_2
case|:
name|ctx
operator|->
name|error
operator||=
name|ch
operator|<<
literal|16
expr_stmt|;
name|state
operator|=
name|sw_error_3
expr_stmt|;
break|break;
case|case
name|sw_error_3
case|:
name|ctx
operator|->
name|error
operator||=
name|ch
operator|<<
literal|8
expr_stmt|;
name|state
operator|=
name|sw_error_4
expr_stmt|;
break|break;
case|case
name|sw_error_4
case|:
name|ctx
operator|->
name|error
operator||=
name|ch
expr_stmt|;
name|state
operator|=
name|sw_debug
expr_stmt|;
break|break;
case|case
name|sw_debug
case|:
break|break;
block|}
block|}
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
literal|0
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc goaway: %ui, stream %ui"
argument_list|,
name|ctx
operator|->
name|error
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_parse_window_update (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_grpc_parse_window_update
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
DECL|enum|__anon2c2debe70b03
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_size_2
name|sw_size_2
block|,
DECL|enumerator|sw_size_3
name|sw_size_3
block|,
DECL|enumerator|sw_size_4
name|sw_size_4
block|}
name|state
enum|;
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|last
operator|=
name|b
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|last
operator|=
name|b
operator|->
name|pos
operator|+
name|ctx
operator|->
name|rest
expr_stmt|;
block|}
name|state
operator|=
name|ctx
operator|->
name|frame_state
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|sw_start
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|rest
operator|!=
literal|4
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent window update frame "
literal|"with invalid length: %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                        "grpc window update byte: %02Xd s:%d", ch, state);
endif|#
directive|endif
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|sw_start
case|:
name|ctx
operator|->
name|window_update
operator|=
operator|(
name|ch
operator|&
literal|0x7f
operator|)
operator|<<
literal|24
expr_stmt|;
name|state
operator|=
name|sw_size_2
expr_stmt|;
break|break;
case|case
name|sw_size_2
case|:
name|ctx
operator|->
name|window_update
operator||=
name|ch
operator|<<
literal|16
expr_stmt|;
name|state
operator|=
name|sw_size_3
expr_stmt|;
break|break;
case|case
name|sw_size_3
case|:
name|ctx
operator|->
name|window_update
operator||=
name|ch
operator|<<
literal|8
expr_stmt|;
name|state
operator|=
name|sw_size_4
expr_stmt|;
break|break;
case|case
name|sw_size_4
case|:
name|ctx
operator|->
name|window_update
operator||=
name|ch
expr_stmt|;
name|state
operator|=
name|sw_start
expr_stmt|;
break|break;
block|}
block|}
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
literal|0
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc window update: %ui"
argument_list|,
name|ctx
operator|->
name|window_update
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|stream_id
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|window_update
operator|>
operator|(
name|size_t
operator|)
name|NGX_HTTP_V2_MAX_WINDOW
operator|-
name|ctx
operator|->
name|send_window
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too large window update"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|send_window
operator|+=
name|ctx
operator|->
name|window_update
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ctx
operator|->
name|window_update
operator|>
name|NGX_HTTP_V2_MAX_WINDOW
operator|-
name|ctx
operator|->
name|connection
operator|->
name|send_window
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too large window update"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|connection
operator|->
name|send_window
operator|+=
name|ctx
operator|->
name|window_update
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_parse_settings (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_grpc_parse_settings
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|ssize_t
name|window_update
decl_stmt|;
DECL|enum|__anon2c2debe70c03
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_id
name|sw_id
block|,
DECL|enumerator|sw_id_2
name|sw_id_2
block|,
DECL|enumerator|sw_value
name|sw_value
block|,
DECL|enumerator|sw_value_2
name|sw_value_2
block|,
DECL|enumerator|sw_value_3
name|sw_value_3
block|,
DECL|enumerator|sw_value_4
name|sw_value_4
block|}
name|state
enum|;
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|last
operator|=
name|b
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|last
operator|=
name|b
operator|->
name|pos
operator|+
name|ctx
operator|->
name|rest
expr_stmt|;
block|}
name|state
operator|=
name|ctx
operator|->
name|frame_state
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|sw_start
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|stream_id
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent settings frame "
literal|"with non-zero stream id: %ui"
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_ACK_FLAG
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc settings ack"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|!=
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent settings frame "
literal|"with ack flag and non-zero length: %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|rest
operator|%
literal|6
operator|!=
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent settings frame "
literal|"with invalid length: %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|free
operator|==
name|NULL
operator|&&
name|ctx
operator|->
name|settings
operator|++
operator|>
literal|1000
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too many settings frames"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                        "grpc settings byte: %02Xd s:%d", ch, state);
endif|#
directive|endif
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|sw_start
case|:
case|case
name|sw_id
case|:
name|ctx
operator|->
name|setting_id
operator|=
name|ch
operator|<<
literal|8
expr_stmt|;
name|state
operator|=
name|sw_id_2
expr_stmt|;
break|break;
case|case
name|sw_id_2
case|:
name|ctx
operator|->
name|setting_id
operator||=
name|ch
expr_stmt|;
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
case|case
name|sw_value
case|:
name|ctx
operator|->
name|setting_value
operator|=
operator|(
name|ngx_uint_t
operator|)
name|ch
operator|<<
literal|24
expr_stmt|;
name|state
operator|=
name|sw_value_2
expr_stmt|;
break|break;
case|case
name|sw_value_2
case|:
name|ctx
operator|->
name|setting_value
operator||=
name|ch
operator|<<
literal|16
expr_stmt|;
name|state
operator|=
name|sw_value_3
expr_stmt|;
break|break;
case|case
name|sw_value_3
case|:
name|ctx
operator|->
name|setting_value
operator||=
name|ch
operator|<<
literal|8
expr_stmt|;
name|state
operator|=
name|sw_value_4
expr_stmt|;
break|break;
case|case
name|sw_value_4
case|:
name|ctx
operator|->
name|setting_value
operator||=
name|ch
expr_stmt|;
name|state
operator|=
name|sw_id
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc setting: %ui %ui"
argument_list|,
name|ctx
operator|->
name|setting_id
argument_list|,
name|ctx
operator|->
name|setting_value
argument_list|)
expr_stmt|;
comment|/*              * The following settings are defined by the protocol:              *              * SETTINGS_HEADER_TABLE_SIZE, SETTINGS_ENABLE_PUSH,              * SETTINGS_MAX_CONCURRENT_STREAMS, SETTINGS_INITIAL_WINDOW_SIZE,              * SETTINGS_MAX_FRAME_SIZE, SETTINGS_MAX_HEADER_LIST_SIZE              *              * Only SETTINGS_INITIAL_WINDOW_SIZE seems to be needed in              * a simple client.              */
if|if
condition|(
name|ctx
operator|->
name|setting_id
operator|==
literal|0x04
condition|)
block|{
comment|/* SETTINGS_INITIAL_WINDOW_SIZE */
if|if
condition|(
name|ctx
operator|->
name|setting_value
operator|>
name|NGX_HTTP_V2_MAX_WINDOW
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent settings frame "
literal|"with too large initial window size: %ui"
argument_list|,
name|ctx
operator|->
name|setting_value
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|window_update
operator|=
name|ctx
operator|->
name|setting_value
operator|-
name|ctx
operator|->
name|connection
operator|->
name|init_window
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|init_window
operator|=
name|ctx
operator|->
name|setting_value
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|send_window
operator|>
literal|0
operator|&&
name|window_update
operator|>
operator|(
name|ssize_t
operator|)
name|NGX_HTTP_V2_MAX_WINDOW
operator|-
name|ctx
operator|->
name|send_window
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent settings frame "
literal|"with too large initial window size: %ui"
argument_list|,
name|ctx
operator|->
name|setting_value
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|send_window
operator|+=
name|window_update
expr_stmt|;
block|}
break|break;
block|}
block|}
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
literal|0
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
return|return
name|ngx_http_grpc_send_settings_ack
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_parse_ping (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_buf_t * b)
name|ngx_http_grpc_parse_ping
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
DECL|enum|__anon2c2debe70d03
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_data_2
name|sw_data_2
block|,
DECL|enumerator|sw_data_3
name|sw_data_3
block|,
DECL|enumerator|sw_data_4
name|sw_data_4
block|,
DECL|enumerator|sw_data_5
name|sw_data_5
block|,
DECL|enumerator|sw_data_6
name|sw_data_6
block|,
DECL|enumerator|sw_data_7
name|sw_data_7
block|,
DECL|enumerator|sw_data_8
name|sw_data_8
block|}
name|state
enum|;
if|if
condition|(
name|b
operator|->
name|last
operator|-
name|b
operator|->
name|pos
operator|<
operator|(
name|ssize_t
operator|)
name|ctx
operator|->
name|rest
condition|)
block|{
name|last
operator|=
name|b
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|last
operator|=
name|b
operator|->
name|pos
operator|+
name|ctx
operator|->
name|rest
expr_stmt|;
block|}
name|state
operator|=
name|ctx
operator|->
name|frame_state
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|sw_start
condition|)
block|{
if|if
condition|(
name|ctx
operator|->
name|stream_id
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent ping frame "
literal|"with non-zero stream id: %ui"
argument_list|,
name|ctx
operator|->
name|stream_id
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|rest
operator|!=
literal|8
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent ping frame "
literal|"with invalid length: %uz"
argument_list|,
name|ctx
operator|->
name|rest
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|flags
operator|&
name|NGX_HTTP_V2_ACK_FLAG
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent ping frame with ack flag"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|free
operator|==
name|NULL
operator|&&
name|ctx
operator|->
name|pings
operator|++
operator|>
literal|1000
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"upstream sent too many ping frames"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|#
directive|if
literal|0
block_content|ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r->connection->log, 0,                        "grpc ping byte: %02Xd s:%d", ch, state);
endif|#
directive|endif
if|if
condition|(
name|state
operator|<
name|sw_data_8
condition|)
block|{
name|ctx
operator|->
name|ping_data
index|[
name|state
index|]
operator|=
name|ch
expr_stmt|;
name|state
operator|++
expr_stmt|;
block|}
else|else
block|{
name|ctx
operator|->
name|ping_data
index|[
literal|7
index|]
operator|=
name|ch
expr_stmt|;
name|state
operator|=
name|sw_start
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc ping"
argument_list|)
expr_stmt|;
block|}
block|}
name|ctx
operator|->
name|rest
operator|-=
name|p
operator|-
name|b
operator|->
name|pos
expr_stmt|;
name|ctx
operator|->
name|frame_state
operator|=
name|state
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|rest
operator|>
literal|0
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|ctx
operator|->
name|state
operator|=
name|ngx_http_grpc_st_start
expr_stmt|;
return|return
name|ngx_http_grpc_send_ping_ack
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_send_settings_ack (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx)
name|ngx_http_grpc_send_settings_ack
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|,
modifier|*
modifier|*
name|ll
decl_stmt|;
name|ngx_http_grpc_frame_t
modifier|*
name|f
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc send settings ack"
argument_list|)
expr_stmt|;
for|for
control|(
name|cl
operator|=
name|ctx
operator|->
name|out
operator|,
name|ll
operator|=
operator|&
name|ctx
operator|->
name|out
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
block|}
name|cl
operator|=
name|ngx_http_grpc_get_buf
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|cl
operator|->
name|buf
operator|->
name|last
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|last
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|type
operator|=
name|NGX_HTTP_V2_SETTINGS_FRAME
expr_stmt|;
name|f
operator|->
name|flags
operator|=
name|NGX_HTTP_V2_ACK_FLAG
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
literal|0
expr_stmt|;
operator|*
name|ll
operator|=
name|cl
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_send_ping_ack (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx)
name|ngx_http_grpc_send_ping_ack
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|,
modifier|*
modifier|*
name|ll
decl_stmt|;
name|ngx_http_grpc_frame_t
modifier|*
name|f
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc send ping ack"
argument_list|)
expr_stmt|;
for|for
control|(
name|cl
operator|=
name|ctx
operator|->
name|out
operator|,
name|ll
operator|=
operator|&
name|ctx
operator|->
name|out
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
block|}
name|cl
operator|=
name|ngx_http_grpc_get_buf
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|cl
operator|->
name|buf
operator|->
name|last
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|last
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
literal|8
expr_stmt|;
name|f
operator|->
name|type
operator|=
name|NGX_HTTP_V2_PING_FRAME
expr_stmt|;
name|f
operator|->
name|flags
operator|=
name|NGX_HTTP_V2_ACK_FLAG
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
literal|0
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|last
operator|=
name|ngx_copy
argument_list|(
name|cl
operator|->
name|buf
operator|->
name|last
argument_list|,
name|ctx
operator|->
name|ping_data
argument_list|,
literal|8
argument_list|)
expr_stmt|;
operator|*
name|ll
operator|=
name|cl
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_send_window_update (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx)
name|ngx_http_grpc_send_window_update
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|size_t
name|n
decl_stmt|;
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|,
modifier|*
modifier|*
name|ll
decl_stmt|;
name|ngx_http_grpc_frame_t
modifier|*
name|f
decl_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"grpc send window update: %uz %uz"
argument_list|,
name|ctx
operator|->
name|connection
operator|->
name|recv_window
argument_list|,
name|ctx
operator|->
name|recv_window
argument_list|)
expr_stmt|;
for|for
control|(
name|cl
operator|=
name|ctx
operator|->
name|out
operator|,
name|ll
operator|=
operator|&
name|ctx
operator|->
name|out
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|ll
operator|=
operator|&
name|cl
operator|->
name|next
expr_stmt|;
block|}
name|cl
operator|=
name|ngx_http_grpc_get_buf
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|cl
operator|->
name|buf
operator|->
name|last
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|last
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
literal|4
expr_stmt|;
name|f
operator|->
name|type
operator|=
name|NGX_HTTP_V2_WINDOW_UPDATE_FRAME
expr_stmt|;
name|f
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
literal|0
expr_stmt|;
name|n
operator|=
name|NGX_HTTP_V2_MAX_WINDOW
operator|-
name|ctx
operator|->
name|connection
operator|->
name|recv_window
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|recv_window
operator|=
name|NGX_HTTP_V2_MAX_WINDOW
expr_stmt|;
operator|*
name|cl
operator|->
name|buf
operator|->
name|last
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|n
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
operator|*
name|cl
operator|->
name|buf
operator|->
name|last
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|n
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
operator|*
name|cl
operator|->
name|buf
operator|->
name|last
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|n
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
operator|*
name|cl
operator|->
name|buf
operator|->
name|last
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
name|n
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|=
operator|(
name|ngx_http_grpc_frame_t
operator|*
operator|)
name|cl
operator|->
name|buf
operator|->
name|last
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|last
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
expr_stmt|;
name|f
operator|->
name|length_0
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_1
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|length_2
operator|=
literal|4
expr_stmt|;
name|f
operator|->
name|type
operator|=
name|NGX_HTTP_V2_WINDOW_UPDATE_FRAME
expr_stmt|;
name|f
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|f
operator|->
name|stream_id_0
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_1
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_2
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|ctx
operator|->
name|id
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
name|f
operator|->
name|stream_id_3
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ctx
operator|->
name|id
operator|&
literal|0xff
operator|)
expr_stmt|;
name|n
operator|=
name|NGX_HTTP_V2_MAX_WINDOW
operator|-
name|ctx
operator|->
name|recv_window
expr_stmt|;
name|ctx
operator|->
name|recv_window
operator|=
name|NGX_HTTP_V2_MAX_WINDOW
expr_stmt|;
operator|*
name|cl
operator|->
name|buf
operator|->
name|last
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|n
operator|>>
literal|24
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
operator|*
name|cl
operator|->
name|buf
operator|->
name|last
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|n
operator|>>
literal|16
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
operator|*
name|cl
operator|->
name|buf
operator|->
name|last
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|n
operator|>>
literal|8
operator|)
operator|&
literal|0xff
operator|)
expr_stmt|;
operator|*
name|cl
operator|->
name|buf
operator|->
name|last
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
name|n
operator|&
literal|0xff
operator|)
expr_stmt|;
operator|*
name|ll
operator|=
name|cl
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_chain_t
modifier|*
DECL|function|ngx_http_grpc_get_buf (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx)
name|ngx_http_grpc_get_buf
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|)
block|{
name|u_char
modifier|*
name|start
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|;
name|cl
operator|=
name|ngx_chain_get_free_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|&
name|ctx
operator|->
name|free
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|b
operator|=
name|cl
operator|->
name|buf
expr_stmt|;
name|start
operator|=
name|b
operator|->
name|start
expr_stmt|;
if|if
condition|(
name|start
operator|==
name|NULL
condition|)
block|{
comment|/*          * each buffer is large enough to hold two window update          * frames in a row          */
name|start
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
block|}
name|ngx_memzero
argument_list|(
name|b
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_buf_t
argument_list|)
argument_list|)
expr_stmt|;
name|b
operator|->
name|start
operator|=
name|start
expr_stmt|;
name|b
operator|->
name|pos
operator|=
name|start
expr_stmt|;
name|b
operator|->
name|last
operator|=
name|start
expr_stmt|;
name|b
operator|->
name|end
operator|=
name|start
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_frame_t
argument_list|)
operator|+
literal|8
expr_stmt|;
name|b
operator|->
name|tag
operator|=
operator|(
name|ngx_buf_tag_t
operator|)
operator|&
name|ngx_http_grpc_body_output_filter
expr_stmt|;
name|b
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|b
operator|->
name|flush
operator|=
literal|1
expr_stmt|;
return|return
name|cl
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_grpc_ctx_t
modifier|*
DECL|function|ngx_http_grpc_get_ctx (ngx_http_request_t * r)
name|ngx_http_grpc_get_ctx
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_upstream_t
modifier|*
name|u
decl_stmt|;
name|ctx
operator|=
name|ngx_http_get_module_ctx
argument_list|(
name|r
argument_list|,
name|ngx_http_grpc_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|connection
operator|==
name|NULL
condition|)
block|{
name|u
operator|=
name|r
operator|->
name|upstream
expr_stmt|;
if|if
condition|(
name|ngx_http_grpc_get_connection_data
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
operator|&
name|u
operator|->
name|peer
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
block|}
return|return
name|ctx
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_get_connection_data (ngx_http_request_t * r,ngx_http_grpc_ctx_t * ctx,ngx_peer_connection_t * pc)
name|ngx_http_grpc_get_connection_data
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_grpc_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_peer_connection_t
modifier|*
name|pc
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|c
operator|=
name|pc
operator|->
name|connection
expr_stmt|;
if|if
condition|(
name|pc
operator|->
name|cached
condition|)
block|{
comment|/*          * for cached connections, connection data can be found          * in the cleanup handler          */
for|for
control|(
name|cln
operator|=
name|c
operator|->
name|pool
operator|->
name|cleanup
init|;
name|cln
condition|;
name|cln
operator|=
name|cln
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cln
operator|->
name|handler
operator|==
name|ngx_http_grpc_cleanup
condition|)
block|{
name|ctx
operator|->
name|connection
operator|=
name|cln
operator|->
name|data
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ctx
operator|->
name|connection
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no connection data found for "
literal|"keepalive http2 connection"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ctx
operator|->
name|send_window
operator|=
name|ctx
operator|->
name|connection
operator|->
name|init_window
expr_stmt|;
name|ctx
operator|->
name|recv_window
operator|=
name|NGX_HTTP_V2_MAX_WINDOW
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|last_stream_id
operator|+=
literal|2
expr_stmt|;
name|ctx
operator|->
name|id
operator|=
name|ctx
operator|->
name|connection
operator|->
name|last_stream_id
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|c
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_conn_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_grpc_cleanup
expr_stmt|;
name|ctx
operator|->
name|connection
operator|=
name|cln
operator|->
name|data
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|init_window
operator|=
name|NGX_HTTP_V2_DEFAULT_WINDOW
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|send_window
operator|=
name|NGX_HTTP_V2_DEFAULT_WINDOW
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|recv_window
operator|=
name|NGX_HTTP_V2_MAX_WINDOW
expr_stmt|;
name|ctx
operator|->
name|send_window
operator|=
name|NGX_HTTP_V2_DEFAULT_WINDOW
expr_stmt|;
name|ctx
operator|->
name|recv_window
operator|=
name|NGX_HTTP_V2_MAX_WINDOW
expr_stmt|;
name|ctx
operator|->
name|id
operator|=
literal|1
expr_stmt|;
name|ctx
operator|->
name|connection
operator|->
name|last_stream_id
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_grpc_cleanup (void * data)
name|ngx_http_grpc_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
if|#
directive|if
literal|0
block_content|ngx_log_debug0(NGX_LOG_DEBUG_HTTP, c->log, 0,                    "grpc cleanup");
endif|#
directive|endif
return|return;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_grpc_abort_request (ngx_http_request_t * r)
name|ngx_http_grpc_abort_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"abort grpc request"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_grpc_finalize_request (ngx_http_request_t * r,ngx_int_t rc)
name|ngx_http_grpc_finalize_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_int_t
name|rc
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"finalize grpc request"
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_internal_trailers_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_grpc_internal_trailers_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_table_elt_t
modifier|*
name|te
decl_stmt|;
name|te
operator|=
name|r
operator|->
name|headers_in
operator|.
name|te
expr_stmt|;
if|if
condition|(
name|te
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|ngx_strlcasestrn
argument_list|(
name|te
operator|->
name|value
operator|.
name|data
argument_list|,
name|te
operator|->
name|value
operator|.
name|data
operator|+
name|te
operator|->
name|value
operator|.
name|len
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"trailers"
argument_list|,
literal|8
operator|-
literal|1
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"trailers"
expr_stmt|;
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"trailers"
argument_list|)
operator|-
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_add_variables (ngx_conf_t * cf)
name|ngx_http_grpc_add_variables
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_variable_t
modifier|*
name|var
decl_stmt|,
modifier|*
name|v
decl_stmt|;
for|for
control|(
name|v
operator|=
name|ngx_http_grpc_vars
init|;
name|v
operator|->
name|name
operator|.
name|len
condition|;
name|v
operator|++
control|)
block|{
name|var
operator|=
name|ngx_http_add_variable
argument_list|(
name|cf
argument_list|,
operator|&
name|v
operator|->
name|name
argument_list|,
name|v
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|var
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|var
operator|->
name|get_handler
operator|=
name|v
operator|->
name|get_handler
expr_stmt|;
name|var
operator|->
name|data
operator|=
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_grpc_create_loc_conf (ngx_conf_t * cf)
name|ngx_http_grpc_create_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_grpc_loc_conf_t
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_grpc_loc_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/*      * set by ngx_pcalloc():      *      *     conf->upstream.ignore_headers = 0;      *     conf->upstream.next_upstream = 0;      *     conf->upstream.hide_headers_hash = { NULL, 0 };      *      *     conf->headers.lengths = NULL;      *     conf->headers.values = NULL;      *     conf->headers.hash = { NULL, 0 };      *     conf->host = { 0, NULL };      *     conf->host_set = 0;      *     conf->ssl = 0;      *     conf->ssl_protocols = 0;      *     conf->ssl_ciphers = { 0, NULL };      *     conf->ssl_trusted_certificate = { 0, NULL };      *     conf->ssl_crl = { 0, NULL };      */
name|conf
operator|->
name|upstream
operator|.
name|local
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|socket_keepalive
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|next_upstream_tries
operator|=
name|NGX_CONF_UNSET_UINT
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|connect_timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|send_timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|read_timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|next_upstream_timeout
operator|=
name|NGX_CONF_UNSET_MSEC
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|buffer_size
operator|=
name|NGX_CONF_UNSET_SIZE
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|hide_headers
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|pass_headers
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|intercept_errors
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
name|conf
operator|->
name|upstream
operator|.
name|ssl_session_reuse
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|ssl_name
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|ssl_server_name
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|ssl_verify
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|conf
operator|->
name|ssl_verify_depth
operator|=
name|NGX_CONF_UNSET_UINT
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|ssl_certificate
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|ssl_certificate_key
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|ssl_passwords
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|conf
operator|->
name|ssl_conf_commands
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
endif|#
directive|endif
comment|/* the hardcoded values */
name|conf
operator|->
name|upstream
operator|.
name|cyclic_temp_file
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|buffering
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|ignore_client_abort
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|send_lowat
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|bufs
operator|.
name|num
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|busy_buffers_size
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|max_temp_file_size
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|temp_file_write_size
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|pass_request_headers
operator|=
literal|1
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|pass_request_body
operator|=
literal|1
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|force_ranges
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|pass_trailers
operator|=
literal|1
expr_stmt|;
name|conf
operator|->
name|upstream
operator|.
name|preserve_output
operator|=
literal|1
expr_stmt|;
name|conf
operator|->
name|headers_source
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|ngx_str_set
argument_list|(
operator|&
name|conf
operator|->
name|upstream
operator|.
name|module
argument_list|,
literal|"grpc"
argument_list|)
expr_stmt|;
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_grpc_merge_loc_conf (ngx_conf_t * cf,void * parent,void * child)
name|ngx_http_grpc_merge_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
block|{
name|ngx_http_grpc_loc_conf_t
modifier|*
name|prev
init|=
name|parent
decl_stmt|;
name|ngx_http_grpc_loc_conf_t
modifier|*
name|conf
init|=
name|child
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_hash_init_t
name|hash
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|local
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|local
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|socket_keepalive
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|socket_keepalive
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_uint_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|next_upstream_tries
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|next_upstream_tries
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|connect_timeout
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|connect_timeout
argument_list|,
literal|60000
argument_list|)
expr_stmt|;
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|send_timeout
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|send_timeout
argument_list|,
literal|60000
argument_list|)
expr_stmt|;
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|read_timeout
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|read_timeout
argument_list|,
literal|60000
argument_list|)
expr_stmt|;
name|ngx_conf_merge_msec_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|next_upstream_timeout
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|next_upstream_timeout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_size_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|buffer_size
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|buffer_size
argument_list|,
operator|(
name|size_t
operator|)
name|ngx_pagesize
argument_list|)
expr_stmt|;
name|ngx_conf_merge_bitmask_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|ignore_headers
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|ignore_headers
argument_list|,
name|NGX_CONF_BITMASK_SET
argument_list|)
expr_stmt|;
name|ngx_conf_merge_bitmask_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|next_upstream
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|next_upstream
argument_list|,
operator|(
name|NGX_CONF_BITMASK_SET
operator||
name|NGX_HTTP_UPSTREAM_FT_ERROR
operator||
name|NGX_HTTP_UPSTREAM_FT_TIMEOUT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|upstream
operator|.
name|next_upstream
operator|&
name|NGX_HTTP_UPSTREAM_FT_OFF
condition|)
block|{
name|conf
operator|->
name|upstream
operator|.
name|next_upstream
operator|=
name|NGX_CONF_BITMASK_SET
operator||
name|NGX_HTTP_UPSTREAM_FT_OFF
expr_stmt|;
block|}
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|intercept_errors
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|intercept_errors
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|ssl_session_reuse
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|ssl_session_reuse
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ngx_conf_merge_bitmask_value
argument_list|(
name|conf
operator|->
name|ssl_protocols
argument_list|,
name|prev
operator|->
name|ssl_protocols
argument_list|,
operator|(
name|NGX_CONF_BITMASK_SET
operator||
name|NGX_SSL_TLSv1
operator||
name|NGX_SSL_TLSv1_1
operator||
name|NGX_SSL_TLSv1_2
operator|)
argument_list|)
expr_stmt|;
name|ngx_conf_merge_str_value
argument_list|(
name|conf
operator|->
name|ssl_ciphers
argument_list|,
name|prev
operator|->
name|ssl_ciphers
argument_list|,
literal|"DEFAULT"
argument_list|)
expr_stmt|;
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|ssl_name
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|ssl_name
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|ssl_server_name
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|ssl_server_name
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|ssl_verify
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|ssl_verify
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ngx_conf_merge_uint_value
argument_list|(
name|conf
operator|->
name|ssl_verify_depth
argument_list|,
name|prev
operator|->
name|ssl_verify_depth
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ngx_conf_merge_str_value
argument_list|(
name|conf
operator|->
name|ssl_trusted_certificate
argument_list|,
name|prev
operator|->
name|ssl_trusted_certificate
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ngx_conf_merge_str_value
argument_list|(
name|conf
operator|->
name|ssl_crl
argument_list|,
name|prev
operator|->
name|ssl_crl
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|ssl_certificate
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|ssl_certificate
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|ssl_certificate_key
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|ssl_certificate_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|upstream
operator|.
name|ssl_passwords
argument_list|,
name|prev
operator|->
name|upstream
operator|.
name|ssl_passwords
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|ssl_conf_commands
argument_list|,
name|prev
operator|->
name|ssl_conf_commands
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|ssl
operator|&&
name|ngx_http_grpc_set_ssl
argument_list|(
name|cf
argument_list|,
name|conf
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
endif|#
directive|endif
name|hash
operator|.
name|max_size
operator|=
literal|512
expr_stmt|;
name|hash
operator|.
name|bucket_size
operator|=
name|ngx_align
argument_list|(
literal|64
argument_list|,
name|ngx_cacheline_size
argument_list|)
expr_stmt|;
name|hash
operator|.
name|name
operator|=
literal|"grpc_headers_hash"
expr_stmt|;
if|if
condition|(
name|ngx_http_upstream_hide_headers_hash
argument_list|(
name|cf
argument_list|,
operator|&
name|conf
operator|->
name|upstream
argument_list|,
operator|&
name|prev
operator|->
name|upstream
argument_list|,
name|ngx_http_grpc_hide_headers
argument_list|,
operator|&
name|hash
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|clcf
operator|=
name|ngx_http_conf_get_module_loc_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|clcf
operator|->
name|noname
operator|&&
name|conf
operator|->
name|upstream
operator|.
name|upstream
operator|==
name|NULL
operator|&&
name|conf
operator|->
name|grpc_lengths
operator|==
name|NULL
condition|)
block|{
name|conf
operator|->
name|upstream
operator|.
name|upstream
operator|=
name|prev
operator|->
name|upstream
operator|.
name|upstream
expr_stmt|;
name|conf
operator|->
name|host
operator|=
name|prev
operator|->
name|host
expr_stmt|;
name|conf
operator|->
name|grpc_lengths
operator|=
name|prev
operator|->
name|grpc_lengths
expr_stmt|;
name|conf
operator|->
name|grpc_values
operator|=
name|prev
operator|->
name|grpc_values
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
name|conf
operator|->
name|upstream
operator|.
name|ssl
operator|=
name|prev
operator|->
name|upstream
operator|.
name|ssl
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|clcf
operator|->
name|lmt_excpt
operator|&&
name|clcf
operator|->
name|handler
operator|==
name|NULL
operator|&&
operator|(
name|conf
operator|->
name|upstream
operator|.
name|upstream
operator|||
name|conf
operator|->
name|grpc_lengths
operator|)
condition|)
block|{
name|clcf
operator|->
name|handler
operator|=
name|ngx_http_grpc_handler
expr_stmt|;
block|}
name|ngx_conf_merge_ptr_value
argument_list|(
name|conf
operator|->
name|headers_source
argument_list|,
name|prev
operator|->
name|headers_source
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|headers_source
operator|==
name|prev
operator|->
name|headers_source
condition|)
block|{
name|conf
operator|->
name|headers
operator|=
name|prev
operator|->
name|headers
expr_stmt|;
name|conf
operator|->
name|host_set
operator|=
name|prev
operator|->
name|host_set
expr_stmt|;
block|}
name|rc
operator|=
name|ngx_http_grpc_init_headers
argument_list|(
name|cf
argument_list|,
name|conf
argument_list|,
operator|&
name|conf
operator|->
name|headers
argument_list|,
name|ngx_http_grpc_headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
comment|/*      * special handling to preserve conf->headers in the "http" section      * to inherit it to all servers      */
if|if
condition|(
name|prev
operator|->
name|headers
operator|.
name|hash
operator|.
name|buckets
operator|==
name|NULL
operator|&&
name|conf
operator|->
name|headers_source
operator|==
name|prev
operator|->
name|headers_source
condition|)
block|{
name|prev
operator|->
name|headers
operator|=
name|conf
operator|->
name|headers
expr_stmt|;
name|prev
operator|->
name|host_set
operator|=
name|conf
operator|->
name|host_set
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_init_headers (ngx_conf_t * cf,ngx_http_grpc_loc_conf_t * conf,ngx_http_grpc_headers_t * headers,ngx_keyval_t * default_headers)
name|ngx_http_grpc_init_headers
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_grpc_loc_conf_t
modifier|*
name|conf
parameter_list|,
name|ngx_http_grpc_headers_t
modifier|*
name|headers
parameter_list|,
name|ngx_keyval_t
modifier|*
name|default_headers
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|uintptr_t
modifier|*
name|code
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_array_t
name|headers_names
decl_stmt|,
name|headers_merged
decl_stmt|;
name|ngx_keyval_t
modifier|*
name|src
decl_stmt|,
modifier|*
name|s
decl_stmt|,
modifier|*
name|h
decl_stmt|;
name|ngx_hash_key_t
modifier|*
name|hk
decl_stmt|;
name|ngx_hash_init_t
name|hash
decl_stmt|;
name|ngx_http_script_compile_t
name|sc
decl_stmt|;
name|ngx_http_script_copy_code_t
modifier|*
name|copy
decl_stmt|;
if|if
condition|(
name|headers
operator|->
name|hash
operator|.
name|buckets
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|headers_names
argument_list|,
name|cf
operator|->
name|temp_pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_hash_key_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|headers_merged
argument_list|,
name|cf
operator|->
name|temp_pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_keyval_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|headers
operator|->
name|lengths
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|64
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|headers
operator|->
name|lengths
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|headers
operator|->
name|values
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|512
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|headers
operator|->
name|values
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|conf
operator|->
name|headers_source
condition|)
block|{
name|src
operator|=
name|conf
operator|->
name|headers_source
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conf
operator|->
name|headers_source
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
operator|==
literal|4
operator|&&
name|ngx_strncasecmp
argument_list|(
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"Host"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|host_set
operator|=
literal|1
expr_stmt|;
block|}
name|s
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|headers_merged
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|s
operator|=
name|src
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
name|h
operator|=
name|default_headers
expr_stmt|;
while|while
condition|(
name|h
operator|->
name|key
operator|.
name|len
condition|)
block|{
name|src
operator|=
name|headers_merged
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|headers_merged
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strcasecmp
argument_list|(
name|h
operator|->
name|key
operator|.
name|data
argument_list|,
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|)
operator|==
literal|0
condition|)
block|{
goto|goto
name|next
goto|;
block|}
block|}
name|s
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|headers_merged
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|s
operator|=
operator|*
name|h
expr_stmt|;
name|next
label|:
name|h
operator|++
expr_stmt|;
block|}
name|src
operator|=
name|headers_merged
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|headers_merged
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|hk
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|headers_names
argument_list|)
expr_stmt|;
if|if
condition|(
name|hk
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|hk
operator|->
name|key
operator|=
name|src
index|[
name|i
index|]
operator|.
name|key
expr_stmt|;
name|hk
operator|->
name|key_hash
operator|=
name|ngx_hash_key_lc
argument_list|(
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
name|hk
operator|->
name|value
operator|=
operator|(
name|void
operator|*
operator|)
literal|1
expr_stmt|;
if|if
condition|(
name|src
index|[
name|i
index|]
operator|.
name|value
operator|.
name|len
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
name|copy
operator|=
name|ngx_array_push_n
argument_list|(
name|headers
operator|->
name|lengths
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_script_copy_code_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|copy
operator|->
name|code
operator|=
operator|(
name|ngx_http_script_code_pt
operator|)
operator|(
name|void
operator|*
operator|)
name|ngx_http_script_copy_len_code
expr_stmt|;
name|copy
operator|->
name|len
operator|=
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
expr_stmt|;
name|size
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|ngx_http_script_copy_code_t
argument_list|)
operator|+
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|-
literal|1
operator|)
operator|&
operator|~
operator|(
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|copy
operator|=
name|ngx_array_push_n
argument_list|(
name|headers
operator|->
name|values
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|copy
operator|->
name|code
operator|=
name|ngx_http_script_copy_code
expr_stmt|;
name|copy
operator|->
name|len
operator|=
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
expr_stmt|;
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|copy
operator|+
sizeof|sizeof
argument_list|(
name|ngx_http_script_copy_code_t
argument_list|)
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|src
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_script_compile_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|.
name|cf
operator|=
name|cf
expr_stmt|;
name|sc
operator|.
name|source
operator|=
operator|&
name|src
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
name|sc
operator|.
name|flushes
operator|=
operator|&
name|headers
operator|->
name|flushes
expr_stmt|;
name|sc
operator|.
name|lengths
operator|=
operator|&
name|headers
operator|->
name|lengths
expr_stmt|;
name|sc
operator|.
name|values
operator|=
operator|&
name|headers
operator|->
name|values
expr_stmt|;
if|if
condition|(
name|ngx_http_script_compile
argument_list|(
operator|&
name|sc
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|code
operator|=
name|ngx_array_push_n
argument_list|(
name|headers
operator|->
name|lengths
argument_list|,
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|code
operator|=
operator|(
name|uintptr_t
operator|)
name|NULL
expr_stmt|;
name|code
operator|=
name|ngx_array_push_n
argument_list|(
name|headers
operator|->
name|values
argument_list|,
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|code
operator|=
operator|(
name|uintptr_t
operator|)
name|NULL
expr_stmt|;
block|}
name|code
operator|=
name|ngx_array_push_n
argument_list|(
name|headers
operator|->
name|lengths
argument_list|,
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|code
operator|=
operator|(
name|uintptr_t
operator|)
name|NULL
expr_stmt|;
name|hash
operator|.
name|hash
operator|=
operator|&
name|headers
operator|->
name|hash
expr_stmt|;
name|hash
operator|.
name|key
operator|=
name|ngx_hash_key_lc
expr_stmt|;
name|hash
operator|.
name|max_size
operator|=
literal|512
expr_stmt|;
name|hash
operator|.
name|bucket_size
operator|=
literal|64
expr_stmt|;
name|hash
operator|.
name|name
operator|=
literal|"grpc_headers_hash"
expr_stmt|;
name|hash
operator|.
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
name|hash
operator|.
name|temp_pool
operator|=
name|NULL
expr_stmt|;
return|return
name|ngx_hash_init
argument_list|(
operator|&
name|hash
argument_list|,
name|headers_names
operator|.
name|elts
argument_list|,
name|headers_names
operator|.
name|nelts
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_grpc_pass (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_grpc_pass
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_grpc_loc_conf_t
modifier|*
name|glcf
init|=
name|conf
decl_stmt|;
name|size_t
name|add
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|,
modifier|*
name|url
decl_stmt|;
name|ngx_url_t
name|u
decl_stmt|;
name|ngx_uint_t
name|n
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|ngx_http_script_compile_t
name|sc
decl_stmt|;
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|upstream
operator|||
name|glcf
operator|->
name|grpc_lengths
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|clcf
operator|=
name|ngx_http_conf_get_module_loc_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|clcf
operator|->
name|handler
operator|=
name|ngx_http_grpc_handler
expr_stmt|;
if|if
condition|(
name|clcf
operator|->
name|name
operator|.
name|len
operator|&&
name|clcf
operator|->
name|name
operator|.
name|data
index|[
name|clcf
operator|->
name|name
operator|.
name|len
operator|-
literal|1
index|]
operator|==
literal|'/'
condition|)
block|{
name|clcf
operator|->
name|auto_redirect
operator|=
literal|1
expr_stmt|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|url
operator|=
operator|&
name|value
index|[
literal|1
index|]
expr_stmt|;
name|n
operator|=
name|ngx_http_script_variables_count
argument_list|(
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
condition|)
block|{
name|ngx_memzero
argument_list|(
operator|&
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_script_compile_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|.
name|cf
operator|=
name|cf
expr_stmt|;
name|sc
operator|.
name|source
operator|=
name|url
expr_stmt|;
name|sc
operator|.
name|lengths
operator|=
operator|&
name|glcf
operator|->
name|grpc_lengths
expr_stmt|;
name|sc
operator|.
name|values
operator|=
operator|&
name|glcf
operator|->
name|grpc_values
expr_stmt|;
name|sc
operator|.
name|variables
operator|=
name|n
expr_stmt|;
name|sc
operator|.
name|complete_lengths
operator|=
literal|1
expr_stmt|;
name|sc
operator|.
name|complete_values
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_http_script_compile
argument_list|(
operator|&
name|sc
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
name|glcf
operator|->
name|ssl
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
return|return
name|NGX_CONF_OK
return|;
block|}
if|if
condition|(
name|ngx_strncasecmp
argument_list|(
name|url
operator|->
name|data
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"grpc://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|add
operator|=
literal|7
expr_stmt|;
block|}
if|else if
condition|(
name|ngx_strncasecmp
argument_list|(
name|url
operator|->
name|data
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"grpcs://"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
name|glcf
operator|->
name|ssl
operator|=
literal|1
expr_stmt|;
name|add
operator|=
literal|8
expr_stmt|;
else|#
directive|else
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"grpcs protocol requires SSL support"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
endif|#
directive|endif
block|}
else|else
block|{
name|add
operator|=
literal|0
expr_stmt|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|u
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_url_t
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|.
name|url
operator|.
name|len
operator|=
name|url
operator|->
name|len
operator|-
name|add
expr_stmt|;
name|u
operator|.
name|url
operator|.
name|data
operator|=
name|url
operator|->
name|data
operator|+
name|add
expr_stmt|;
name|u
operator|.
name|no_resolve
operator|=
literal|1
expr_stmt|;
name|glcf
operator|->
name|upstream
operator|.
name|upstream
operator|=
name|ngx_http_upstream_add
argument_list|(
name|cf
argument_list|,
operator|&
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|upstream
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|u
operator|.
name|family
operator|!=
name|AF_UNIX
condition|)
block|{
if|if
condition|(
name|u
operator|.
name|no_port
condition|)
block|{
name|glcf
operator|->
name|host
operator|=
name|u
operator|.
name|host
expr_stmt|;
block|}
else|else
block|{
name|glcf
operator|->
name|host
operator|.
name|len
operator|=
name|u
operator|.
name|host
operator|.
name|len
operator|+
literal|1
operator|+
name|u
operator|.
name|port_text
operator|.
name|len
expr_stmt|;
name|glcf
operator|->
name|host
operator|.
name|data
operator|=
name|u
operator|.
name|host
operator|.
name|data
expr_stmt|;
block|}
block|}
else|else
block|{
name|ngx_str_set
argument_list|(
operator|&
name|glcf
operator|->
name|host
argument_list|,
literal|"localhost"
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
end_if

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_grpc_ssl_password_file (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_grpc_ssl_password_file
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_grpc_loc_conf_t
modifier|*
name|glcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl_passwords
operator|!=
name|NGX_CONF_UNSET_PTR
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|glcf
operator|->
name|upstream
operator|.
name|ssl_passwords
operator|=
name|ngx_ssl_read_password_file
argument_list|(
name|cf
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl_passwords
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_grpc_ssl_conf_command_check (ngx_conf_t * cf,void * post,void * data)
name|ngx_http_grpc_ssl_conf_command_check
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|post
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|SSL_CONF_FLAG_FILE
return|return
literal|"is not supported on this platform"
return|;
else|#
directive|else
return|return
name|NGX_CONF_OK
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_grpc_set_ssl (ngx_conf_t * cf,ngx_http_grpc_loc_conf_t * glcf)
name|ngx_http_grpc_set_ssl
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_grpc_loc_conf_t
modifier|*
name|glcf
parameter_list|)
block|{
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|glcf
operator|->
name|upstream
operator|.
name|ssl
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_ssl_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|glcf
operator|->
name|upstream
operator|.
name|ssl
operator|->
name|log
operator|=
name|cf
operator|->
name|log
expr_stmt|;
if|if
condition|(
name|ngx_ssl_create
argument_list|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl
argument_list|,
name|glcf
operator|->
name|ssl_protocols
argument_list|,
name|NULL
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
name|ngx_ssl_cleanup_ctx
argument_list|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_ssl_cleanup_ctx
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|glcf
operator|->
name|upstream
operator|.
name|ssl
expr_stmt|;
if|if
condition|(
name|ngx_ssl_ciphers
argument_list|(
name|cf
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl
argument_list|,
operator|&
name|glcf
operator|->
name|ssl_ciphers
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl_certificate
operator|&&
name|glcf
operator|->
name|upstream
operator|.
name|ssl_certificate
operator|->
name|value
operator|.
name|len
condition|)
block|{
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl_certificate_key
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no \"grpc_ssl_certificate_key\" is defined "
literal|"for certificate \"%V\""
argument_list|,
operator|&
name|glcf
operator|->
name|upstream
operator|.
name|ssl_certificate
operator|->
name|value
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl_certificate
operator|->
name|lengths
operator|||
name|glcf
operator|->
name|upstream
operator|.
name|ssl_certificate_key
operator|->
name|lengths
condition|)
block|{
name|glcf
operator|->
name|upstream
operator|.
name|ssl_passwords
operator|=
name|ngx_ssl_preserve_passwords
argument_list|(
name|cf
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl_passwords
argument_list|)
expr_stmt|;
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl_passwords
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ngx_ssl_certificate
argument_list|(
name|cf
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl
argument_list|,
operator|&
name|glcf
operator|->
name|upstream
operator|.
name|ssl_certificate
operator|->
name|value
argument_list|,
operator|&
name|glcf
operator|->
name|upstream
operator|.
name|ssl_certificate_key
operator|->
name|value
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl_passwords
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
block|}
if|if
condition|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl_verify
condition|)
block|{
if|if
condition|(
name|glcf
operator|->
name|ssl_trusted_certificate
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"no grpc_ssl_trusted_certificate for grpc_ssl_verify"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_ssl_trusted_certificate
argument_list|(
name|cf
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl
argument_list|,
operator|&
name|glcf
operator|->
name|ssl_trusted_certificate
argument_list|,
name|glcf
operator|->
name|ssl_verify_depth
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_ssl_crl
argument_list|(
name|cf
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl
argument_list|,
operator|&
name|glcf
operator|->
name|ssl_crl
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
if|if
condition|(
name|ngx_ssl_client_session_cache
argument_list|(
name|cf
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl_session_reuse
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
ifdef|#
directive|ifdef
name|TLSEXT_TYPE_application_layer_protocol_negotiation
if|if
condition|(
name|SSL_CTX_set_alpn_protos
argument_list|(
name|glcf
operator|->
name|upstream
operator|.
name|ssl
operator|->
name|ctx
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"\x02h2"
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"SSL_CTX_set_alpn_protos() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|ngx_ssl_conf_commands
argument_list|(
name|cf
argument_list|,
name|glcf
operator|->
name|upstream
operator|.
name|ssl
argument_list|,
name|glcf
operator|->
name|ssl_conf_commands
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit

