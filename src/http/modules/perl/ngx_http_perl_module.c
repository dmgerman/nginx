begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http_perl_module.h>
end_include

begin_typedef
DECL|struct|__anon2bf5724c0108
typedef|typedef
struct|struct
block|{
DECL|member|perl
name|PerlInterpreter
modifier|*
name|perl
decl_stmt|;
DECL|member|nginx
name|HV
modifier|*
name|nginx
decl_stmt|;
DECL|member|modules
name|ngx_array_t
modifier|*
name|modules
decl_stmt|;
DECL|member|requires
name|ngx_array_t
modifier|*
name|requires
decl_stmt|;
DECL|typedef|ngx_http_perl_main_conf_t
block|}
name|ngx_http_perl_main_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2bf5724c0208
typedef|typedef
struct|struct
block|{
DECL|member|sub
name|SV
modifier|*
name|sub
decl_stmt|;
DECL|member|handler
name|ngx_str_t
name|handler
decl_stmt|;
DECL|typedef|ngx_http_perl_loc_conf_t
block|}
name|ngx_http_perl_loc_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2bf5724c0308
typedef|typedef
struct|struct
block|{
DECL|member|sub
name|SV
modifier|*
name|sub
decl_stmt|;
DECL|member|handler
name|ngx_str_t
name|handler
decl_stmt|;
DECL|typedef|ngx_http_perl_variable_t
block|}
name|ngx_http_perl_variable_t
typedef|;
end_typedef

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_SSI
operator|)
end_if

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_perl_ssi
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_ssi_ctx_t
modifier|*
name|ssi_ctx
parameter_list|,
name|ngx_str_t
modifier|*
modifier|*
name|params
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_perl_init_interpreter
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|PerlInterpreter
modifier|*
name|ngx_http_perl_create_interpreter
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_perl_run_requires
parameter_list|(
name|pTHX_
name|ngx_array_t
modifier|*
name|requires
parameter_list|,
name|ngx_log_t
modifier|*
name|log
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_perl_call_handler
parameter_list|(
name|pTHX_
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|HV
modifier|*
name|nginx
parameter_list|,
name|SV
modifier|*
name|sub
parameter_list|,
name|SV
modifier|*
modifier|*
name|args
parameter_list|,
name|ngx_str_t
modifier|*
name|handler
parameter_list|,
name|ngx_str_t
modifier|*
name|rv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_perl_eval_anon_sub
parameter_list|(
name|pTHX_
name|ngx_str_t
modifier|*
name|handler
parameter_list|,
name|SV
modifier|*
modifier|*
name|sv
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_perl_preconfiguration
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_perl_create_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_perl_init_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_perl_create_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_perl_merge_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_perl
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_perl_set
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_PERL_MULTIPLICITY
operator|)
end_if

begin_function_decl
specifier|static
name|void
name|ngx_http_perl_cleanup_perl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_perl_init_worker
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_perl_exit
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_http_perl_commands
specifier|static
name|ngx_command_t
name|ngx_http_perl_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"perl_modules"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_array_slot
block|,
name|NGX_HTTP_MAIN_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_perl_main_conf_t
argument_list|,
name|modules
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"perl_require"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_str_array_slot
block|,
name|NGX_HTTP_MAIN_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_perl_main_conf_t
argument_list|,
name|requires
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"perl"
argument_list|)
block|,
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_HTTP_LMT_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_perl
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"perl_set"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_TAKE2
block|,
name|ngx_http_perl_set
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_perl_module_ctx
specifier|static
name|ngx_http_module_t
name|ngx_http_perl_module_ctx
init|=
block|{
name|ngx_http_perl_preconfiguration
block|,
comment|/* preconfiguration */
name|NULL
block|,
comment|/* postconfiguration */
name|ngx_http_perl_create_main_conf
block|,
comment|/* create main configuration */
name|ngx_http_perl_init_main_conf
block|,
comment|/* init main configuration */
name|NULL
block|,
comment|/* create server configuration */
name|NULL
block|,
comment|/* merge server configuration */
name|ngx_http_perl_create_loc_conf
block|,
comment|/* create location configuration */
name|ngx_http_perl_merge_loc_conf
comment|/* merge location configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_perl_module
name|ngx_module_t
name|ngx_http_perl_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_http_perl_module_ctx
block|,
comment|/* module context */
name|ngx_http_perl_commands
block|,
comment|/* module directives */
name|NGX_HTTP_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|ngx_http_perl_init_worker
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|NULL
block|,
comment|/* exit process */
name|ngx_http_perl_exit
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_SSI
operator|)
end_if

begin_define
DECL|macro|NGX_HTTP_PERL_SSI_SUB
define|#
directive|define
name|NGX_HTTP_PERL_SSI_SUB
value|0
end_define

begin_define
DECL|macro|NGX_HTTP_PERL_SSI_ARG
define|#
directive|define
name|NGX_HTTP_PERL_SSI_ARG
value|1
end_define

begin_decl_stmt
DECL|variable|ngx_http_perl_ssi_params
specifier|static
name|ngx_http_ssi_param_t
name|ngx_http_perl_ssi_params
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"sub"
argument_list|)
block|,
name|NGX_HTTP_PERL_SSI_SUB
block|,
literal|1
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"arg"
argument_list|)
block|,
name|NGX_HTTP_PERL_SSI_ARG
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
name|ngx_null_string
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_perl_ssi_command
specifier|static
name|ngx_http_ssi_command_t
name|ngx_http_perl_ssi_command
init|=
block|{
name|ngx_string
argument_list|(
literal|"perl"
argument_list|)
block|,
name|ngx_http_perl_ssi
block|,
name|ngx_http_perl_ssi_params
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
DECL|variable|ngx_null_name
specifier|static
name|ngx_str_t
name|ngx_null_name
init|=
name|ngx_null_string
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|nginx_stash
specifier|static
name|HV
modifier|*
name|nginx_stash
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_PERL_MULTIPLICITY
operator|)
end_if

begin_decl_stmt
DECL|variable|ngx_perl_term
specifier|static
name|ngx_uint_t
name|ngx_perl_term
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
DECL|variable|perl
specifier|static
name|PerlInterpreter
modifier|*
name|perl
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
DECL|function|ngx_http_perl_xs_init (pTHX)
name|ngx_http_perl_xs_init
parameter_list|(
name|pTHX
parameter_list|)
block|{
name|newXS
argument_list|(
literal|"DynaLoader::boot_DynaLoader"
argument_list|,
name|boot_DynaLoader
argument_list|,
name|__FILE__
argument_list|)
expr_stmt|;
name|nginx_stash
operator|=
name|gv_stashpv
argument_list|(
literal|"nginx"
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_perl_handler (ngx_http_request_t * r)
name|ngx_http_perl_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|zero_in_uri
condition|)
block|{
return|return
name|NGX_HTTP_NOT_FOUND
return|;
block|}
name|r
operator|->
expr|main
operator|->
name|count
operator|++
expr_stmt|;
name|ngx_http_perl_handle_request
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|NGX_DONE
return|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_perl_handle_request (ngx_http_request_t * r)
name|ngx_http_perl_handle_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|SV
modifier|*
name|sub
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_str_t
name|uri
decl_stmt|,
name|args
decl_stmt|,
modifier|*
name|handler
decl_stmt|;
name|ngx_http_perl_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_perl_loc_conf_t
modifier|*
name|plcf
decl_stmt|;
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl handler"
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ngx_http_get_module_ctx
argument_list|(
name|r
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_perl_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_http_set_ctx
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
block|}
name|pmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
block|{
name|dTHXa
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|PERL_SET_CONTEXT
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
name|plcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
name|sub
operator|=
name|plcf
operator|->
name|sub
expr_stmt|;
name|handler
operator|=
operator|&
name|plcf
operator|->
name|handler
expr_stmt|;
block|}
else|else
block|{
name|sub
operator|=
name|ctx
operator|->
name|next
expr_stmt|;
name|handler
operator|=
operator|&
name|ngx_null_name
expr_stmt|;
name|ctx
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
block|}
name|rc
operator|=
name|ngx_http_perl_call_handler
argument_list|(
argument|aTHX_ r
argument_list|,
argument|pmcf->nginx
argument_list|,
argument|sub
argument_list|,
argument|NULL
argument_list|,
argument|handler
argument_list|,
argument|NULL
argument_list|)
expr_stmt|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl handler done: %i"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DONE
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rc
operator|>
literal|600
condition|)
block|{
name|rc
operator|=
name|NGX_OK
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|redirect_uri
operator|.
name|len
condition|)
block|{
name|uri
operator|=
name|ctx
operator|->
name|redirect_uri
expr_stmt|;
name|args
operator|=
name|ctx
operator|->
name|redirect_args
expr_stmt|;
block|}
else|else
block|{
name|uri
operator|.
name|len
operator|=
literal|0
expr_stmt|;
block|}
name|ctx
operator|->
name|filename
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|ctx
operator|->
name|redirect_uri
operator|.
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|done
operator|||
name|ctx
operator|->
name|next
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_DONE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|uri
operator|.
name|len
condition|)
block|{
name|ngx_http_internal_redirect
argument_list|(
name|r
argument_list|,
operator|&
name|uri
argument_list|,
operator|&
name|args
argument_list|)
expr_stmt|;
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_DONE
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_OK
operator|||
name|rc
operator|==
name|NGX_HTTP_OK
condition|)
block|{
name|ngx_http_send_special
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_LAST
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|done
operator|=
literal|1
expr_stmt|;
block|}
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_perl_sleep_handler (ngx_http_request_t * r)
name|ngx_http_perl_sleep_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_event_t
modifier|*
name|wev
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl sleep handler"
argument_list|)
expr_stmt|;
name|wev
operator|=
name|r
operator|->
name|connection
operator|->
name|write
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timedout
condition|)
block|{
name|wev
operator|->
name|timedout
operator|=
literal|0
expr_stmt|;
name|ngx_http_perl_handle_request
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|wev
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_perl_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_perl_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_perl_variable_t
modifier|*
name|pv
init|=
operator|(
name|ngx_http_perl_variable_t
operator|*
operator|)
name|data
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_str_t
name|value
decl_stmt|;
name|ngx_http_perl_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl variable handler"
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ngx_http_get_module_ctx
argument_list|(
name|r
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_perl_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_http_set_ctx
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
block|}
name|pmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
name|value
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
block|{
name|dTHXa
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|PERL_SET_CONTEXT
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ngx_http_perl_call_handler
argument_list|(
argument|aTHX_ r
argument_list|,
argument|pmcf->nginx
argument_list|,
argument|pv->sub
argument_list|,
argument|NULL
argument_list|,
argument|&pv->handler
argument_list|,
argument|&value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|value
operator|.
name|data
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|value
operator|.
name|data
expr_stmt|;
block|}
else|else
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
block|}
name|ctx
operator|->
name|filename
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|ctx
operator|->
name|redirect_uri
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl variable done"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_HTTP_SSI
operator|)
end_if

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_perl_ssi (ngx_http_request_t * r,ngx_http_ssi_ctx_t * ssi_ctx,ngx_str_t ** params)
name|ngx_http_perl_ssi
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_ssi_ctx_t
modifier|*
name|ssi_ctx
parameter_list|,
name|ngx_str_t
modifier|*
modifier|*
name|params
parameter_list|)
block|{
name|SV
modifier|*
name|sv
decl_stmt|,
modifier|*
modifier|*
name|asv
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_str_t
modifier|*
name|handler
decl_stmt|,
modifier|*
modifier|*
name|args
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_perl_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl ssi handler"
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|ngx_http_get_module_ctx
argument_list|(
name|r
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|ctx
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_perl_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_http_set_ctx
argument_list|(
name|r
argument_list|,
name|ctx
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
block|}
name|pmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ssi
operator|=
name|ssi_ctx
expr_stmt|;
name|handler
operator|=
name|params
index|[
name|NGX_HTTP_PERL_SSI_SUB
index|]
expr_stmt|;
name|handler
operator|->
name|data
index|[
name|handler
operator|->
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|{
name|dTHXa
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|PERL_SET_CONTEXT
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* the code is disabled to force the precompiled perl code using only */
block_content|ngx_http_perl_eval_anon_sub(aTHX_ handler,&sv);      if (sv ==&PL_sv_undef) {         ngx_log_error(NGX_LOG_ERR, r->connection->log, 0,                       "eval_pv(\"%V\") failed", handler);         return NGX_ERROR;     }      if (sv == NULL) {         sv = newSVpvn((char *) handler->data, handler->len);     }
endif|#
directive|endif
name|sv
operator|=
name|newSVpvn
argument_list|(
operator|(
name|char
operator|*
operator|)
name|handler
operator|->
name|data
argument_list|,
name|handler
operator|->
name|len
argument_list|)
expr_stmt|;
name|args
operator|=
operator|&
name|params
index|[
name|NGX_HTTP_PERL_SSI_ARG
index|]
expr_stmt|;
if|if
condition|(
name|args
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|args
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
comment|/* void */
block|}
name|asv
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|SV
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|asv
operator|==
name|NULL
condition|)
block|{
name|SvREFCNT_dec
argument_list|(
name|sv
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|asv
index|[
literal|0
index|]
operator|=
operator|(
name|SV
operator|*
operator|)
name|i
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|args
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|asv
index|[
name|i
operator|+
literal|1
index|]
operator|=
name|newSVpvn
argument_list|(
operator|(
name|char
operator|*
operator|)
name|args
index|[
name|i
index|]
operator|->
name|data
argument_list|,
name|args
index|[
name|i
index|]
operator|->
name|len
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|asv
operator|=
name|NULL
expr_stmt|;
block|}
name|rc
operator|=
name|ngx_http_perl_call_handler
argument_list|(
argument|aTHX_ r
argument_list|,
argument|pmcf->nginx
argument_list|,
argument|sv
argument_list|,
argument|asv
argument_list|,
argument|handler
argument_list|,
argument|NULL
argument_list|)
expr_stmt|;
name|SvREFCNT_dec
argument_list|(
name|sv
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|->
name|filename
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|ctx
operator|->
name|redirect_uri
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|ctx
operator|->
name|ssi
operator|=
name|NULL
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl ssi done"
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_perl_init_interpreter (ngx_conf_t * cf,ngx_http_perl_main_conf_t * pmcf)
name|ngx_http_perl_init_interpreter
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|m
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_PERL_MULTIPLICITY
operator|)
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|NGX_PERL_MODULES
if|if
condition|(
name|pmcf
operator|->
name|modules
operator|==
name|NGX_CONF_UNSET_PTR
condition|)
block|{
name|pmcf
operator|->
name|modules
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_str_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmcf
operator|->
name|modules
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|m
operator|=
name|ngx_array_push
argument_list|(
name|pmcf
operator|->
name|modules
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|m
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
name|NGX_PERL_MODULES
argument_list|)
operator|-
literal|1
expr_stmt|;
name|m
operator|->
name|data
operator|=
name|NGX_PERL_MODULES
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|pmcf
operator|->
name|modules
operator|!=
name|NGX_CONF_UNSET_PTR
condition|)
block|{
name|m
operator|=
name|pmcf
operator|->
name|modules
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pmcf
operator|->
name|modules
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_conf_full_name
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
operator|&
name|m
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
block|}
if|#
directive|if
operator|!
operator|(
name|NGX_HAVE_PERL_MULTIPLICITY
operator|)
if|if
condition|(
name|perl
condition|)
block|{
if|if
condition|(
name|ngx_set_environment
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
name|NULL
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|ngx_http_perl_run_requires
argument_list|(
argument|aTHX_ pmcf->requires
argument_list|,
argument|cf->log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|pmcf
operator|->
name|perl
operator|=
name|perl
expr_stmt|;
name|pmcf
operator|->
name|nginx
operator|=
name|nginx_stash
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|nginx_stash
operator|==
name|NULL
condition|)
block|{
name|PERL_SYS_INIT
argument_list|(
operator|&
name|ngx_argc
argument_list|,
operator|&
name|ngx_argv
argument_list|)
expr_stmt|;
block|}
name|pmcf
operator|->
name|perl
operator|=
name|ngx_http_perl_create_interpreter
argument_list|(
name|cf
argument_list|,
name|pmcf
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmcf
operator|->
name|perl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|pmcf
operator|->
name|nginx
operator|=
name|nginx_stash
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_PERL_MULTIPLICITY
operator|)
name|cln
operator|->
name|handler
operator|=
name|ngx_http_perl_cleanup_perl
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|pmcf
operator|->
name|perl
expr_stmt|;
else|#
directive|else
name|perl
operator|=
name|pmcf
operator|->
name|perl
expr_stmt|;
endif|#
directive|endif
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|PerlInterpreter
modifier|*
DECL|function|ngx_http_perl_create_interpreter (ngx_conf_t * cf,ngx_http_perl_main_conf_t * pmcf)
name|ngx_http_perl_create_interpreter
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|STRLEN
name|len
decl_stmt|;
name|SV
modifier|*
name|sv
decl_stmt|;
name|char
modifier|*
name|ver
decl_stmt|,
modifier|*
modifier|*
name|embedding
decl_stmt|;
name|ngx_str_t
modifier|*
name|m
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|PerlInterpreter
modifier|*
name|perl
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"create perl interpreter"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_set_environment
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
name|NULL
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|perl
operator|=
name|perl_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|perl
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl_alloc() failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|{
name|dTHXa
argument_list|(
name|perl
argument_list|)
expr_stmt|;
name|PERL_SET_CONTEXT
argument_list|(
name|perl
argument_list|)
expr_stmt|;
name|perl_construct
argument_list|(
name|perl
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PERL_EXIT_DESTRUCT_END
name|PL_exit_flags
operator||=
name|PERL_EXIT_DESTRUCT_END
expr_stmt|;
endif|#
directive|endif
name|n
operator|=
operator|(
name|pmcf
operator|->
name|modules
operator|!=
name|NGX_CONF_UNSET_PTR
operator|)
condition|?
name|pmcf
operator|->
name|modules
operator|->
name|nelts
operator|*
literal|2
else|:
literal|0
expr_stmt|;
name|embedding
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
operator|(
literal|4
operator|+
name|n
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|embedding
operator|==
name|NULL
condition|)
block|{
goto|goto
name|fail
goto|;
block|}
name|embedding
index|[
literal|0
index|]
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|n
operator|++
condition|)
block|{
name|m
operator|=
name|pmcf
operator|->
name|modules
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pmcf
operator|->
name|modules
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|embedding
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
operator|=
literal|"-I"
expr_stmt|;
name|embedding
index|[
literal|2
operator|*
name|i
operator|+
literal|2
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|m
index|[
name|i
index|]
operator|.
name|data
expr_stmt|;
block|}
block|}
name|embedding
index|[
name|n
operator|++
index|]
operator|=
literal|"-Mnginx"
expr_stmt|;
name|embedding
index|[
name|n
operator|++
index|]
operator|=
literal|"-e"
expr_stmt|;
name|embedding
index|[
name|n
operator|++
index|]
operator|=
literal|"0"
expr_stmt|;
name|n
operator|=
name|perl_parse
argument_list|(
name|perl
argument_list|,
name|ngx_http_perl_xs_init
argument_list|,
name|n
argument_list|,
name|embedding
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl_parse() failed: %d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sv
operator|=
name|get_sv
argument_list|(
literal|"nginx::VERSION"
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|ver
operator|=
name|SvPV
argument_list|(
name|sv
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|ver
argument_list|,
name|NGINX_VERSION
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"version "
name|NGINX_VERSION
literal|" of nginx.pm is required, "
literal|"but %s was found"
argument_list|,
name|ver
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|ngx_http_perl_run_requires
argument_list|(
argument|aTHX_ pmcf->requires
argument_list|,
argument|cf->log
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
goto|goto
name|fail
goto|;
block|}
block|}
return|return
name|perl
return|;
name|fail
label|:
operator|(
name|void
operator|)
name|perl_destruct
argument_list|(
name|perl
argument_list|)
expr_stmt|;
name|perl_free
argument_list|(
name|perl
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_perl_run_requires (pTHX_ ngx_array_t * requires,ngx_log_t * log)
name|ngx_http_perl_run_requires
parameter_list|(
name|pTHX_
name|ngx_array_t
modifier|*
name|requires
parameter_list|,
name|ngx_log_t
modifier|*
name|log
parameter_list|)
block|{
name|u_char
modifier|*
name|err
decl_stmt|;
name|STRLEN
name|len
decl_stmt|;
name|ngx_str_t
modifier|*
name|script
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
if|if
condition|(
name|requires
operator|==
name|NGX_CONF_UNSET_PTR
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|script
operator|=
name|requires
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|requires
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|require_pv
argument_list|(
operator|(
name|char
operator|*
operator|)
name|script
index|[
name|i
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|SvTRUE
argument_list|(
name|ERRSV
argument_list|)
condition|)
block|{
name|err
operator|=
operator|(
name|u_char
operator|*
operator|)
name|SvPV
argument_list|(
name|ERRSV
argument_list|,
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|len
operator|&&
operator|(
name|err
index|[
name|len
index|]
operator|==
name|CR
operator|||
name|err
index|[
name|len
index|]
operator|==
name|LF
operator|)
condition|)
block|{
comment|/* void */
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|log
argument_list|,
literal|0
argument_list|,
literal|"require_pv(\"%s\") failed: \"%*s\""
argument_list|,
name|script
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|len
operator|+
literal|1
argument_list|,
name|err
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_perl_call_handler (pTHX_ ngx_http_request_t * r,HV * nginx,SV * sub,SV ** args,ngx_str_t * handler,ngx_str_t * rv)
name|ngx_http_perl_call_handler
parameter_list|(
name|pTHX_
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|HV
modifier|*
name|nginx
parameter_list|,
name|SV
modifier|*
name|sub
parameter_list|,
name|SV
modifier|*
modifier|*
name|args
parameter_list|,
name|ngx_str_t
modifier|*
name|handler
parameter_list|,
name|ngx_str_t
modifier|*
name|rv
parameter_list|)
block|{
name|SV
modifier|*
name|sv
decl_stmt|;
name|int
name|n
decl_stmt|,
name|status
decl_stmt|;
name|char
modifier|*
name|line
decl_stmt|;
name|u_char
modifier|*
name|err
decl_stmt|;
name|STRLEN
name|len
decl_stmt|,
name|n_a
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|dSP
expr_stmt|;
name|status
operator|=
literal|0
expr_stmt|;
name|ENTER
expr_stmt|;
name|SAVETMPS
expr_stmt|;
name|PUSHMARK
argument_list|(
name|sp
argument_list|)
expr_stmt|;
name|sv
operator|=
name|sv_2mortal
argument_list|(
name|sv_bless
argument_list|(
name|newRV_noinc
argument_list|(
name|newSViv
argument_list|(
name|PTR2IV
argument_list|(
name|r
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|nginx
argument_list|)
argument_list|)
expr_stmt|;
name|XPUSHs
argument_list|(
name|sv
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
condition|)
block|{
name|EXTEND
argument_list|(
name|sp
argument_list|,
operator|(
name|intptr_t
operator|)
name|args
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
operator|(
name|ngx_uint_t
operator|)
name|args
index|[
literal|0
index|]
condition|;
name|i
operator|++
control|)
block|{
name|PUSHs
argument_list|(
name|sv_2mortal
argument_list|(
name|args
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|PUTBACK
expr_stmt|;
name|c
operator|=
name|r
operator|->
name|connection
expr_stmt|;
name|n
operator|=
name|call_sv
argument_list|(
name|sub
argument_list|,
name|G_EVAL
argument_list|)
expr_stmt|;
name|SPAGAIN
expr_stmt|;
if|if
condition|(
name|n
condition|)
block|{
if|if
condition|(
name|rv
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|POPi
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"call_sv: %d"
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|line
operator|=
name|SvPVx
argument_list|(
name|POPs
argument_list|,
name|n_a
argument_list|)
expr_stmt|;
name|rv
operator|->
name|len
operator|=
name|n_a
expr_stmt|;
name|rv
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|n_a
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|rv
operator|->
name|data
argument_list|,
name|line
argument_list|,
name|n_a
argument_list|)
expr_stmt|;
block|}
block|}
name|PUTBACK
expr_stmt|;
name|FREETMPS
expr_stmt|;
name|LEAVE
expr_stmt|;
comment|/* check $@ */
if|if
condition|(
name|SvTRUE
argument_list|(
name|ERRSV
argument_list|)
condition|)
block|{
name|err
operator|=
operator|(
name|u_char
operator|*
operator|)
name|SvPV
argument_list|(
name|ERRSV
argument_list|,
name|len
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|len
operator|&&
operator|(
name|err
index|[
name|len
index|]
operator|==
name|CR
operator|||
name|err
index|[
name|len
index|]
operator|==
name|LF
operator|)
condition|)
block|{
comment|/* void */
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"call_sv(\"%V\") failed: \"%*s\""
argument_list|,
name|handler
argument_list|,
name|len
operator|+
literal|1
argument_list|,
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
if|if
condition|(
name|n
operator|!=
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"call_sv(\"%V\") returned %d results"
argument_list|,
name|handler
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|status
operator|=
name|NGX_OK
expr_stmt|;
block|}
if|if
condition|(
name|rv
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
return|return
operator|(
name|ngx_int_t
operator|)
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_perl_eval_anon_sub (pTHX_ ngx_str_t * handler,SV ** sv)
name|ngx_http_perl_eval_anon_sub
parameter_list|(
name|pTHX_
name|ngx_str_t
modifier|*
name|handler
parameter_list|,
name|SV
modifier|*
modifier|*
name|sv
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
for|for
control|(
name|p
operator|=
name|handler
operator|->
name|data
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|!=
literal|' '
operator|&&
operator|*
name|p
operator|!=
literal|'\t'
operator|&&
operator|*
name|p
operator|!=
name|CR
operator|&&
operator|*
name|p
operator|!=
name|LF
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|p
argument_list|,
literal|"sub "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|ngx_strncmp
argument_list|(
name|p
argument_list|,
literal|"sub{"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|ngx_strncmp
argument_list|(
name|p
argument_list|,
literal|"use "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|sv
operator|=
name|eval_pv
argument_list|(
operator|(
name|char
operator|*
operator|)
name|p
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* eval_pv() does not set ERRSV on failure */
return|return;
block|}
operator|*
name|sv
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_perl_create_main_conf (ngx_conf_t * cf)
name|ngx_http_perl_create_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
decl_stmt|;
name|pmcf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_perl_main_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmcf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|pmcf
operator|->
name|modules
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
name|pmcf
operator|->
name|requires
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
return|return
name|pmcf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_perl_init_main_conf (ngx_conf_t * cf,void * conf)
name|ngx_http_perl_init_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
init|=
name|conf
decl_stmt|;
if|if
condition|(
name|pmcf
operator|->
name|perl
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_http_perl_init_interpreter
argument_list|(
name|cf
argument_list|,
name|pmcf
argument_list|)
operator|!=
name|NGX_CONF_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_PERL_MULTIPLICITY
operator|)
end_if

begin_function
specifier|static
name|void
DECL|function|ngx_http_perl_cleanup_perl (void * data)
name|ngx_http_perl_cleanup_perl
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|PerlInterpreter
modifier|*
name|perl
init|=
name|data
decl_stmt|;
name|PERL_SET_CONTEXT
argument_list|(
name|perl
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|perl_destruct
argument_list|(
name|perl
argument_list|)
expr_stmt|;
name|perl_free
argument_list|(
name|perl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_perl_term
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl term"
argument_list|)
expr_stmt|;
name|PERL_SYS_TERM
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_perl_preconfiguration (ngx_conf_t * cf)
name|ngx_http_perl_preconfiguration
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
if|#
directive|if
operator|(
name|NGX_HTTP_SSI
operator|)
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_http_ssi_main_conf_t
modifier|*
name|smcf
decl_stmt|;
name|smcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_ssi_filter_module
argument_list|)
expr_stmt|;
name|rc
operator|=
name|ngx_hash_add_key
argument_list|(
operator|&
name|smcf
operator|->
name|commands
argument_list|,
operator|&
name|ngx_http_perl_ssi_command
operator|.
name|name
argument_list|,
operator|&
name|ngx_http_perl_ssi_command
argument_list|,
name|NGX_HASH_READONLY_KEY
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|rc
operator|==
name|NGX_BUSY
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"conflicting SSI command \"%V\""
argument_list|,
operator|&
name|ngx_http_perl_ssi_command
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_ERROR
return|;
block|}
endif|#
directive|endif
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_perl_create_loc_conf (ngx_conf_t * cf)
name|ngx_http_perl_create_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_perl_loc_conf_t
modifier|*
name|plcf
decl_stmt|;
name|plcf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_perl_loc_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|plcf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/*      * set by ngx_pcalloc():      *      *     plcf->handler = { 0, NULL };      */
return|return
name|plcf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_perl_merge_loc_conf (ngx_conf_t * cf,void * parent,void * child)
name|ngx_http_perl_merge_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
block|{
name|ngx_http_perl_loc_conf_t
modifier|*
name|prev
init|=
name|parent
decl_stmt|;
name|ngx_http_perl_loc_conf_t
modifier|*
name|conf
init|=
name|child
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|sub
operator|==
name|NULL
condition|)
block|{
name|conf
operator|->
name|sub
operator|=
name|prev
operator|->
name|sub
expr_stmt|;
name|conf
operator|->
name|handler
operator|=
name|prev
operator|->
name|handler
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_perl (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_perl
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_perl_loc_conf_t
modifier|*
name|plcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
if|if
condition|(
name|plcf
operator|->
name|handler
operator|.
name|data
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate perl handler \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|pmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmcf
operator|->
name|perl
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_http_perl_init_interpreter
argument_list|(
name|cf
argument_list|,
name|pmcf
argument_list|)
operator|!=
name|NGX_CONF_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|plcf
operator|->
name|handler
operator|=
name|value
index|[
literal|1
index|]
expr_stmt|;
block|{
name|dTHXa
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|PERL_SET_CONTEXT
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|ngx_http_perl_eval_anon_sub
argument_list|(
name|aTHX_
operator|&
name|value
index|[
literal|1
index|]
argument_list|,
operator|&
name|plcf
operator|->
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|plcf
operator|->
name|sub
operator|==
operator|&
name|PL_sv_undef
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"eval_pv(\"%V\") failed"
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|plcf
operator|->
name|sub
operator|==
name|NULL
condition|)
block|{
name|plcf
operator|->
name|sub
operator|=
name|newSVpvn
argument_list|(
operator|(
name|char
operator|*
operator|)
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
name|value
index|[
literal|1
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
block|}
name|clcf
operator|=
name|ngx_http_conf_get_module_loc_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|clcf
operator|->
name|handler
operator|=
name|ngx_http_perl_handler
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_perl_set (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_perl_set
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_int_t
name|index
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_perl_variable_t
modifier|*
name|pv
decl_stmt|;
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
if|if
condition|(
name|value
index|[
literal|1
index|]
operator|.
name|data
index|[
literal|0
index|]
operator|!=
literal|'$'
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid variable name \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|value
index|[
literal|1
index|]
operator|.
name|len
operator|--
expr_stmt|;
name|value
index|[
literal|1
index|]
operator|.
name|data
operator|++
expr_stmt|;
name|v
operator|=
name|ngx_http_add_variable
argument_list|(
name|cf
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|,
name|NGX_HTTP_VAR_CHANGEABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|pv
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_perl_variable_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pv
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|index
operator|=
name|ngx_http_get_variable_index
argument_list|(
name|cf
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|pmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmcf
operator|->
name|perl
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_http_perl_init_interpreter
argument_list|(
name|cf
argument_list|,
name|pmcf
argument_list|)
operator|!=
name|NGX_CONF_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|pv
operator|->
name|handler
operator|=
name|value
index|[
literal|2
index|]
expr_stmt|;
block|{
name|dTHXa
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|PERL_SET_CONTEXT
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|ngx_http_perl_eval_anon_sub
argument_list|(
name|aTHX_
operator|&
name|value
index|[
literal|2
index|]
argument_list|,
operator|&
name|pv
operator|->
name|sub
argument_list|)
expr_stmt|;
if|if
condition|(
name|pv
operator|->
name|sub
operator|==
operator|&
name|PL_sv_undef
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"eval_pv(\"%V\") failed"
argument_list|,
operator|&
name|value
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|pv
operator|->
name|sub
operator|==
name|NULL
condition|)
block|{
name|pv
operator|->
name|sub
operator|=
name|newSVpvn
argument_list|(
operator|(
name|char
operator|*
operator|)
name|value
index|[
literal|2
index|]
operator|.
name|data
argument_list|,
name|value
index|[
literal|2
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
block|}
name|v
operator|->
name|get_handler
operator|=
name|ngx_http_perl_variable
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|uintptr_t
operator|)
name|pv
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_perl_init_worker (ngx_cycle_t * cycle)
name|ngx_http_perl_init_worker
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
block|{
name|ngx_http_perl_main_conf_t
modifier|*
name|pmcf
decl_stmt|;
name|pmcf
operator|=
name|ngx_http_cycle_get_module_main_conf
argument_list|(
name|cycle
argument_list|,
name|ngx_http_perl_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmcf
condition|)
block|{
name|dTHXa
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
name|PERL_SET_CONTEXT
argument_list|(
name|pmcf
operator|->
name|perl
argument_list|)
expr_stmt|;
comment|/* set worker's $$ */
name|sv_setiv
argument_list|(
name|GvSV
argument_list|(
name|gv_fetchpv
argument_list|(
literal|"$"
argument_list|,
name|TRUE
argument_list|,
name|SVt_PV
argument_list|)
argument_list|)
argument_list|,
operator|(
name|I32
operator|)
name|ngx_pid
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_perl_exit (ngx_cycle_t * cycle)
name|ngx_http_perl_exit
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
block|{
if|#
directive|if
operator|(
name|NGX_HAVE_PERL_MULTIPLICITY
operator|)
comment|/*      * the master exit hook is run before global pool cleanup,      * therefore just set flag here      */
name|ngx_perl_term
operator|=
literal|1
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|nginx_stash
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"perl term"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|perl_destruct
argument_list|(
name|perl
argument_list|)
expr_stmt|;
name|perl_free
argument_list|(
name|perl
argument_list|)
expr_stmt|;
name|PERL_SYS_TERM
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

end_unit

