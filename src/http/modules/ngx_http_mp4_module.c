begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_define
DECL|macro|NGX_HTTP_MP4_TRAK_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_TRAK_ATOM
value|0
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_TKHD_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_TKHD_ATOM
value|1
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_MDIA_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_MDIA_ATOM
value|2
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_MDHD_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_MDHD_ATOM
value|3
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_HDLR_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_HDLR_ATOM
value|4
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_MINF_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_MINF_ATOM
value|5
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_VMHD_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_VMHD_ATOM
value|6
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_SMHD_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_SMHD_ATOM
value|7
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_DINF_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_DINF_ATOM
value|8
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STBL_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_STBL_ATOM
value|9
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STSD_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_STSD_ATOM
value|10
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STTS_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_STTS_ATOM
value|11
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STTS_DATA
define|#
directive|define
name|NGX_HTTP_MP4_STTS_DATA
value|12
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STSS_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_STSS_ATOM
value|13
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STSS_DATA
define|#
directive|define
name|NGX_HTTP_MP4_STSS_DATA
value|14
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_CTTS_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_CTTS_ATOM
value|15
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_CTTS_DATA
define|#
directive|define
name|NGX_HTTP_MP4_CTTS_DATA
value|16
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STSC_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_STSC_ATOM
value|17
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STSC_CHUNK
define|#
directive|define
name|NGX_HTTP_MP4_STSC_CHUNK
value|18
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STSC_DATA
define|#
directive|define
name|NGX_HTTP_MP4_STSC_DATA
value|19
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STSZ_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_STSZ_ATOM
value|20
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STSZ_DATA
define|#
directive|define
name|NGX_HTTP_MP4_STSZ_DATA
value|21
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STCO_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_STCO_ATOM
value|22
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_STCO_DATA
define|#
directive|define
name|NGX_HTTP_MP4_STCO_DATA
value|23
end_define

begin_define
DECL|macro|NGX_HTTP_MP4_LAST_ATOM
define|#
directive|define
name|NGX_HTTP_MP4_LAST_ATOM
value|NGX_HTTP_MP4_STCO_DATA
end_define

begin_typedef
DECL|struct|__anon29a3247f0108
typedef|typedef
struct|struct
block|{
DECL|member|buffer_size
name|size_t
name|buffer_size
decl_stmt|;
DECL|member|max_buffer_size
name|size_t
name|max_buffer_size
decl_stmt|;
DECL|typedef|ngx_http_mp4_conf_t
block|}
name|ngx_http_mp4_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f0208
typedef|typedef
struct|struct
block|{
DECL|member|chunk
name|u_char
name|chunk
index|[
literal|4
index|]
decl_stmt|;
DECL|member|samples
name|u_char
name|samples
index|[
literal|4
index|]
decl_stmt|;
DECL|member|id
name|u_char
name|id
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_stsc_entry_t
block|}
name|ngx_mp4_stsc_entry_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f0308
typedef|typedef
struct|struct
block|{
DECL|member|timescale
name|uint32_t
name|timescale
decl_stmt|;
DECL|member|time_to_sample_entries
name|uint32_t
name|time_to_sample_entries
decl_stmt|;
DECL|member|sample_to_chunk_entries
name|uint32_t
name|sample_to_chunk_entries
decl_stmt|;
DECL|member|sync_samples_entries
name|uint32_t
name|sync_samples_entries
decl_stmt|;
DECL|member|composition_offset_entries
name|uint32_t
name|composition_offset_entries
decl_stmt|;
DECL|member|sample_sizes_entries
name|uint32_t
name|sample_sizes_entries
decl_stmt|;
DECL|member|chunks
name|uint32_t
name|chunks
decl_stmt|;
DECL|member|start_sample
name|ngx_uint_t
name|start_sample
decl_stmt|;
DECL|member|start_chunk
name|ngx_uint_t
name|start_chunk
decl_stmt|;
DECL|member|chunk_samples
name|ngx_uint_t
name|chunk_samples
decl_stmt|;
DECL|member|chunk_samples_size
name|ngx_uint_t
name|chunk_samples_size
decl_stmt|;
DECL|member|start_offset
name|off_t
name|start_offset
decl_stmt|;
DECL|member|tkhd_size
name|size_t
name|tkhd_size
decl_stmt|;
DECL|member|mdhd_size
name|size_t
name|mdhd_size
decl_stmt|;
DECL|member|hdlr_size
name|size_t
name|hdlr_size
decl_stmt|;
DECL|member|vmhd_size
name|size_t
name|vmhd_size
decl_stmt|;
DECL|member|smhd_size
name|size_t
name|smhd_size
decl_stmt|;
DECL|member|dinf_size
name|size_t
name|dinf_size
decl_stmt|;
DECL|member|size
name|size_t
name|size
decl_stmt|;
DECL|member|out
name|ngx_chain_t
name|out
index|[
name|NGX_HTTP_MP4_LAST_ATOM
operator|+
literal|1
index|]
decl_stmt|;
DECL|member|trak_atom_buf
name|ngx_buf_t
name|trak_atom_buf
decl_stmt|;
DECL|member|tkhd_atom_buf
name|ngx_buf_t
name|tkhd_atom_buf
decl_stmt|;
DECL|member|mdia_atom_buf
name|ngx_buf_t
name|mdia_atom_buf
decl_stmt|;
DECL|member|mdhd_atom_buf
name|ngx_buf_t
name|mdhd_atom_buf
decl_stmt|;
DECL|member|hdlr_atom_buf
name|ngx_buf_t
name|hdlr_atom_buf
decl_stmt|;
DECL|member|minf_atom_buf
name|ngx_buf_t
name|minf_atom_buf
decl_stmt|;
DECL|member|vmhd_atom_buf
name|ngx_buf_t
name|vmhd_atom_buf
decl_stmt|;
DECL|member|smhd_atom_buf
name|ngx_buf_t
name|smhd_atom_buf
decl_stmt|;
DECL|member|dinf_atom_buf
name|ngx_buf_t
name|dinf_atom_buf
decl_stmt|;
DECL|member|stbl_atom_buf
name|ngx_buf_t
name|stbl_atom_buf
decl_stmt|;
DECL|member|stsd_atom_buf
name|ngx_buf_t
name|stsd_atom_buf
decl_stmt|;
DECL|member|stts_atom_buf
name|ngx_buf_t
name|stts_atom_buf
decl_stmt|;
DECL|member|stts_data_buf
name|ngx_buf_t
name|stts_data_buf
decl_stmt|;
DECL|member|stss_atom_buf
name|ngx_buf_t
name|stss_atom_buf
decl_stmt|;
DECL|member|stss_data_buf
name|ngx_buf_t
name|stss_data_buf
decl_stmt|;
DECL|member|ctts_atom_buf
name|ngx_buf_t
name|ctts_atom_buf
decl_stmt|;
DECL|member|ctts_data_buf
name|ngx_buf_t
name|ctts_data_buf
decl_stmt|;
DECL|member|stsc_atom_buf
name|ngx_buf_t
name|stsc_atom_buf
decl_stmt|;
DECL|member|stsc_chunk_buf
name|ngx_buf_t
name|stsc_chunk_buf
decl_stmt|;
DECL|member|stsc_data_buf
name|ngx_buf_t
name|stsc_data_buf
decl_stmt|;
DECL|member|stsz_atom_buf
name|ngx_buf_t
name|stsz_atom_buf
decl_stmt|;
DECL|member|stsz_data_buf
name|ngx_buf_t
name|stsz_data_buf
decl_stmt|;
DECL|member|tsco_atom_buf
name|ngx_buf_t
name|tsco_atom_buf
decl_stmt|;
DECL|member|tsco_data_buf
name|ngx_buf_t
name|tsco_data_buf
decl_stmt|;
DECL|member|stsc_chunk_entry
name|ngx_mp4_stsc_entry_t
name|stsc_chunk_entry
decl_stmt|;
DECL|typedef|ngx_http_mp4_trak_t
block|}
name|ngx_http_mp4_trak_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f0408
typedef|typedef
struct|struct
block|{
DECL|member|file
name|ngx_file_t
name|file
decl_stmt|;
DECL|member|buffer
name|u_char
modifier|*
name|buffer
decl_stmt|;
DECL|member|buffer_start
name|u_char
modifier|*
name|buffer_start
decl_stmt|;
DECL|member|buffer_pos
name|u_char
modifier|*
name|buffer_pos
decl_stmt|;
DECL|member|buffer_end
name|u_char
modifier|*
name|buffer_end
decl_stmt|;
DECL|member|buffer_size
name|size_t
name|buffer_size
decl_stmt|;
DECL|member|offset
name|off_t
name|offset
decl_stmt|;
DECL|member|end
name|off_t
name|end
decl_stmt|;
DECL|member|content_length
name|off_t
name|content_length
decl_stmt|;
DECL|member|start
name|ngx_uint_t
name|start
decl_stmt|;
DECL|member|timescale
name|uint32_t
name|timescale
decl_stmt|;
DECL|member|request
name|ngx_http_request_t
modifier|*
name|request
decl_stmt|;
DECL|member|trak
name|ngx_array_t
name|trak
decl_stmt|;
DECL|member|traks
name|ngx_http_mp4_trak_t
name|traks
index|[
literal|2
index|]
decl_stmt|;
DECL|member|ftyp_size
name|size_t
name|ftyp_size
decl_stmt|;
DECL|member|moov_size
name|size_t
name|moov_size
decl_stmt|;
DECL|member|out
name|ngx_chain_t
modifier|*
name|out
decl_stmt|;
DECL|member|ftyp_atom
name|ngx_chain_t
name|ftyp_atom
decl_stmt|;
DECL|member|moov_atom
name|ngx_chain_t
name|moov_atom
decl_stmt|;
DECL|member|mvhd_atom
name|ngx_chain_t
name|mvhd_atom
decl_stmt|;
DECL|member|mdat_atom
name|ngx_chain_t
name|mdat_atom
decl_stmt|;
DECL|member|mdat_data
name|ngx_chain_t
name|mdat_data
decl_stmt|;
DECL|member|ftyp_atom_buf
name|ngx_buf_t
name|ftyp_atom_buf
decl_stmt|;
DECL|member|moov_atom_buf
name|ngx_buf_t
name|moov_atom_buf
decl_stmt|;
DECL|member|mvhd_atom_buf
name|ngx_buf_t
name|mvhd_atom_buf
decl_stmt|;
DECL|member|mdat_atom_buf
name|ngx_buf_t
name|mdat_atom_buf
decl_stmt|;
DECL|member|mdat_data_buf
name|ngx_buf_t
name|mdat_data_buf
decl_stmt|;
DECL|member|moov_atom_header
name|u_char
name|moov_atom_header
index|[
literal|8
index|]
decl_stmt|;
DECL|member|mdat_atom_header
name|u_char
name|mdat_atom_header
index|[
literal|16
index|]
decl_stmt|;
DECL|typedef|ngx_http_mp4_file_t
block|}
name|ngx_http_mp4_file_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f0508
typedef|typedef
struct|struct
block|{
DECL|member|name
name|char
modifier|*
name|name
decl_stmt|;
DECL|member|handler
name|ngx_int_t
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
DECL|typedef|ngx_http_mp4_atom_handler_t
block|}
name|ngx_http_mp4_atom_handler_t
typedef|;
end_typedef

begin_define
DECL|macro|ngx_mp4_atom_header (mp4)
define|#
directive|define
name|ngx_mp4_atom_header
parameter_list|(
name|mp4
parameter_list|)
value|(mp4->buffer_pos - 8)
end_define

begin_define
DECL|macro|ngx_mp4_atom_data (mp4)
define|#
directive|define
name|ngx_mp4_atom_data
parameter_list|(
name|mp4
parameter_list|)
value|mp4->buffer_pos
end_define

begin_define
DECL|macro|ngx_mp4_atom_next (mp4,n)
define|#
directive|define
name|ngx_mp4_atom_next
parameter_list|(
name|mp4
parameter_list|,
name|n
parameter_list|)
value|mp4->buffer_pos += n; mp4->offset += n
end_define

begin_define
DECL|macro|ngx_mp4_set_atom_name (p,n1,n2,n3,n4)
define|#
directive|define
name|ngx_mp4_set_atom_name
parameter_list|(
name|p
parameter_list|,
name|n1
parameter_list|,
name|n2
parameter_list|,
name|n3
parameter_list|,
name|n4
parameter_list|)
define|\
value|((u_char *) (p))[4] = n1;                                                 \     ((u_char *) (p))[5] = n2;                                                 \     ((u_char *) (p))[6] = n3;                                                 \     ((u_char *) (p))[7] = n4
end_define

begin_define
DECL|macro|ngx_mp4_get_32value (p)
define|#
directive|define
name|ngx_mp4_get_32value
parameter_list|(
name|p
parameter_list|)
define|\
value|( (((u_char *) (p))[0]<< 24)                                             \     + (((u_char *) (p))[1]<< 16)                                             \     + (((u_char *) (p))[2]<< 8)                                              \     + (((u_char *) (p))[3]) )
end_define

begin_define
DECL|macro|ngx_mp4_set_32value (p,n)
define|#
directive|define
name|ngx_mp4_set_32value
parameter_list|(
name|p
parameter_list|,
name|n
parameter_list|)
define|\
value|((u_char *) (p))[0] = (u_char) ((n)>> 24);                               \     ((u_char *) (p))[1] = (u_char) ((n)>> 16);                               \     ((u_char *) (p))[2] = (u_char) ((n)>> 8);                                \     ((u_char *) (p))[3] = (u_char)  (n)
end_define

begin_define
DECL|macro|ngx_mp4_get_64value (p)
define|#
directive|define
name|ngx_mp4_get_64value
parameter_list|(
name|p
parameter_list|)
define|\
value|( ((uint64_t) ((u_char *) (p))[0]<< 56)                                  \     + ((uint64_t) ((u_char *) (p))[1]<< 48)                                  \     + ((uint64_t) ((u_char *) (p))[2]<< 40)                                  \     + ((uint64_t) ((u_char *) (p))[3]<< 32)                                  \     + ((uint64_t) ((u_char *) (p))[4]<< 24)                                  \     + (           ((u_char *) (p))[5]<< 16)                                  \     + (           ((u_char *) (p))[6]<< 8)                                   \     + (           ((u_char *) (p))[7]) )
end_define

begin_define
DECL|macro|ngx_mp4_set_64value (p,n)
define|#
directive|define
name|ngx_mp4_set_64value
parameter_list|(
name|p
parameter_list|,
name|n
parameter_list|)
define|\
value|((u_char *) (p))[0] = (u_char) ((n)>> 56);                               \     ((u_char *) (p))[1] = (u_char) ((n)>> 48);                               \     ((u_char *) (p))[2] = (u_char) ((n)>> 40);                               \     ((u_char *) (p))[3] = (u_char) ((n)>> 32);                               \     ((u_char *) (p))[4] = (u_char) ((n)>> 24);                               \     ((u_char *) (p))[5] = (u_char) ((n)>> 16);                               \     ((u_char *) (p))[6] = (u_char) ((n)>> 8);                                \     ((u_char *) (p))[7] = (u_char) (n)
end_define

begin_define
DECL|macro|ngx_mp4_last_trak (mp4)
define|#
directive|define
name|ngx_mp4_last_trak
parameter_list|(
name|mp4
parameter_list|)
define|\
value|&((ngx_http_mp4_trak_t *) mp4->trak.elts)[mp4->trak.nelts - 1]
end_define

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_process
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_atom_handler_t
modifier|*
name|atom
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_ftyp_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_moov_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_mdat_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|size_t
name|ngx_http_mp4_update_mdat_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|off_t
name|start_offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_mvhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_trak_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_mp4_update_trak_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_cmov_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_tkhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_mdia_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_mp4_update_mdia_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_mdhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_hdlr_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_minf_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_mp4_update_minf_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_dinf_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_vmhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_smhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_stbl_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_mp4_update_stbl_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_stsd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_stts_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_update_stts_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_stss_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_update_stss_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_ctts_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_mp4_update_ctts_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_stsc_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_update_stsc_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_stsz_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_mp4_update_stsz_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_read_stco_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_mp4_update_stco_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_mp4_adjust_stco_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|,
name|int32_t
name|adjustment
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_mp4
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_mp4_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_mp4_merge_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_http_mp4_commands
specifier|static
name|ngx_command_t
name|ngx_http_mp4_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"mp4"
argument_list|)
block|,
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_NOARGS
block|,
name|ngx_http_mp4
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"mp4_buffer_size"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_size_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_mp4_conf_t
argument_list|,
name|buffer_size
argument_list|)
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"mp4_max_buffer_size"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_conf_set_size_slot
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_mp4_conf_t
argument_list|,
name|max_buffer_size
argument_list|)
block|,
name|NULL
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_mp4_module_ctx
specifier|static
name|ngx_http_module_t
name|ngx_http_mp4_module_ctx
init|=
block|{
name|NULL
block|,
comment|/* preconfiguration */
name|NULL
block|,
comment|/* postconfiguration */
name|NULL
block|,
comment|/* create main configuration */
name|NULL
block|,
comment|/* init main configuration */
name|NULL
block|,
comment|/* create server configuration */
name|NULL
block|,
comment|/* merge server configuration */
name|ngx_http_mp4_create_conf
block|,
comment|/* create location configuration */
name|ngx_http_mp4_merge_conf
comment|/* merge location configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_mp4_module
name|ngx_module_t
name|ngx_http_mp4_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_http_mp4_module_ctx
block|,
comment|/* module context */
name|ngx_http_mp4_commands
block|,
comment|/* module directives */
name|NGX_HTTP_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|NULL
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|NULL
block|,
comment|/* exit process */
name|NULL
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_mp4_atoms
specifier|static
name|ngx_http_mp4_atom_handler_t
name|ngx_http_mp4_atoms
index|[]
init|=
block|{
block|{
literal|"ftyp"
block|,
name|ngx_http_mp4_read_ftyp_atom
block|}
block|,
block|{
literal|"moov"
block|,
name|ngx_http_mp4_read_moov_atom
block|}
block|,
block|{
literal|"mdat"
block|,
name|ngx_http_mp4_read_mdat_atom
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_mp4_moov_atoms
specifier|static
name|ngx_http_mp4_atom_handler_t
name|ngx_http_mp4_moov_atoms
index|[]
init|=
block|{
block|{
literal|"mvhd"
block|,
name|ngx_http_mp4_read_mvhd_atom
block|}
block|,
block|{
literal|"trak"
block|,
name|ngx_http_mp4_read_trak_atom
block|}
block|,
block|{
literal|"cmov"
block|,
name|ngx_http_mp4_read_cmov_atom
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_mp4_trak_atoms
specifier|static
name|ngx_http_mp4_atom_handler_t
name|ngx_http_mp4_trak_atoms
index|[]
init|=
block|{
block|{
literal|"tkhd"
block|,
name|ngx_http_mp4_read_tkhd_atom
block|}
block|,
block|{
literal|"mdia"
block|,
name|ngx_http_mp4_read_mdia_atom
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_mp4_mdia_atoms
specifier|static
name|ngx_http_mp4_atom_handler_t
name|ngx_http_mp4_mdia_atoms
index|[]
init|=
block|{
block|{
literal|"mdhd"
block|,
name|ngx_http_mp4_read_mdhd_atom
block|}
block|,
block|{
literal|"hdlr"
block|,
name|ngx_http_mp4_read_hdlr_atom
block|}
block|,
block|{
literal|"minf"
block|,
name|ngx_http_mp4_read_minf_atom
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_mp4_minf_atoms
specifier|static
name|ngx_http_mp4_atom_handler_t
name|ngx_http_mp4_minf_atoms
index|[]
init|=
block|{
block|{
literal|"vmhd"
block|,
name|ngx_http_mp4_read_vmhd_atom
block|}
block|,
block|{
literal|"smhd"
block|,
name|ngx_http_mp4_read_smhd_atom
block|}
block|,
block|{
literal|"dinf"
block|,
name|ngx_http_mp4_read_dinf_atom
block|}
block|,
block|{
literal|"stbl"
block|,
name|ngx_http_mp4_read_stbl_atom
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_mp4_stbl_atoms
specifier|static
name|ngx_http_mp4_atom_handler_t
name|ngx_http_mp4_stbl_atoms
index|[]
init|=
block|{
block|{
literal|"stsd"
block|,
name|ngx_http_mp4_read_stsd_atom
block|}
block|,
block|{
literal|"stts"
block|,
name|ngx_http_mp4_read_stts_atom
block|}
block|,
block|{
literal|"stss"
block|,
name|ngx_http_mp4_read_stss_atom
block|}
block|,
block|{
literal|"ctts"
block|,
name|ngx_http_mp4_read_ctts_atom
block|}
block|,
block|{
literal|"stsc"
block|,
name|ngx_http_mp4_read_stsc_atom
block|}
block|,
block|{
literal|"stsz"
block|,
name|ngx_http_mp4_read_stsz_atom
block|}
block|,
block|{
literal|"stco"
block|,
name|ngx_http_mp4_read_stco_atom
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_handler (ngx_http_request_t * r)
name|ngx_http_mp4_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|u_char
modifier|*
name|last
decl_stmt|;
name|size_t
name|root
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|,
name|start
decl_stmt|;
name|ngx_uint_t
name|level
decl_stmt|;
name|ngx_str_t
name|path
decl_stmt|,
name|value
decl_stmt|;
name|ngx_log_t
modifier|*
name|log
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_chain_t
name|out
decl_stmt|;
name|ngx_http_mp4_file_t
modifier|*
name|mp4
decl_stmt|;
name|ngx_open_file_info_t
name|of
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|r
operator|->
name|method
operator|&
operator|(
name|NGX_HTTP_GET
operator||
name|NGX_HTTP_HEAD
operator|)
operator|)
condition|)
block|{
return|return
name|NGX_HTTP_NOT_ALLOWED
return|;
block|}
if|if
condition|(
name|r
operator|->
name|uri
operator|.
name|data
index|[
name|r
operator|->
name|uri
operator|.
name|len
operator|-
literal|1
index|]
operator|==
literal|'/'
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
name|rc
operator|=
name|ngx_http_discard_request_body
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|rc
return|;
block|}
name|last
operator|=
name|ngx_http_map_uri_to_path
argument_list|(
name|r
argument_list|,
operator|&
name|path
argument_list|,
operator|&
name|root
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|last
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
name|path
operator|.
name|len
operator|=
name|last
operator|-
name|path
operator|.
name|data
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|log
argument_list|,
literal|0
argument_list|,
literal|"http mp4 filename: \"%V\""
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|of
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_open_file_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|of
operator|.
name|read_ahead
operator|=
name|clcf
operator|->
name|read_ahead
expr_stmt|;
name|of
operator|.
name|directio
operator|=
name|NGX_MAX_OFF_T_VALUE
expr_stmt|;
name|of
operator|.
name|valid
operator|=
name|clcf
operator|->
name|open_file_cache_valid
expr_stmt|;
name|of
operator|.
name|min_uses
operator|=
name|clcf
operator|->
name|open_file_cache_min_uses
expr_stmt|;
name|of
operator|.
name|errors
operator|=
name|clcf
operator|->
name|open_file_cache_errors
expr_stmt|;
name|of
operator|.
name|events
operator|=
name|clcf
operator|->
name|open_file_cache_events
expr_stmt|;
if|if
condition|(
name|ngx_open_cached_file
argument_list|(
name|clcf
operator|->
name|open_file_cache
argument_list|,
operator|&
name|path
argument_list|,
operator|&
name|of
argument_list|,
name|r
operator|->
name|pool
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
switch|switch
condition|(
name|of
operator|.
name|err
condition|)
block|{
case|case
literal|0
case|:
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
case|case
name|NGX_ENOENT
case|:
case|case
name|NGX_ENOTDIR
case|:
case|case
name|NGX_ENAMETOOLONG
case|:
name|level
operator|=
name|NGX_LOG_ERR
expr_stmt|;
name|rc
operator|=
name|NGX_HTTP_NOT_FOUND
expr_stmt|;
break|break;
case|case
name|NGX_EACCES
case|:
name|level
operator|=
name|NGX_LOG_ERR
expr_stmt|;
name|rc
operator|=
name|NGX_HTTP_FORBIDDEN
expr_stmt|;
break|break;
default|default:
name|level
operator|=
name|NGX_LOG_CRIT
expr_stmt|;
name|rc
operator|=
name|NGX_HTTP_INTERNAL_SERVER_ERROR
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|rc
operator|!=
name|NGX_HTTP_NOT_FOUND
operator|||
name|clcf
operator|->
name|log_not_found
condition|)
block|{
name|ngx_log_error
argument_list|(
name|level
argument_list|,
name|log
argument_list|,
name|of
operator|.
name|err
argument_list|,
literal|"%s \"%s\" failed"
argument_list|,
name|of
operator|.
name|failed
argument_list|,
name|path
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
if|if
condition|(
operator|!
name|of
operator|.
name|is_file
condition|)
block|{
if|if
condition|(
name|ngx_close_file
argument_list|(
name|of
operator|.
name|fd
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_close_file_n
literal|" \"%s\" failed"
argument_list|,
name|path
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_DECLINED
return|;
block|}
name|r
operator|->
name|root_tested
operator|=
operator|!
name|r
operator|->
name|error_page
expr_stmt|;
name|r
operator|->
name|allow_ranges
operator|=
literal|1
expr_stmt|;
name|start
operator|=
operator|-
literal|1
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_length_n
operator|=
name|of
operator|.
name|size
expr_stmt|;
name|mp4
operator|=
name|NULL
expr_stmt|;
name|b
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|args
operator|.
name|len
condition|)
block|{
if|if
condition|(
name|ngx_http_arg
argument_list|(
name|r
argument_list|,
operator|(
name|u_char
operator|*
operator|)
literal|"start"
argument_list|,
literal|5
argument_list|,
operator|&
name|value
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
name|start
operator|=
name|ngx_atofp
argument_list|(
name|value
operator|.
name|data
argument_list|,
name|value
operator|.
name|len
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|!=
name|NGX_ERROR
condition|)
block|{
name|r
operator|->
name|allow_ranges
operator|=
literal|0
expr_stmt|;
name|mp4
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_mp4_file_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp4
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
name|mp4
operator|->
name|file
operator|.
name|fd
operator|=
name|of
operator|.
name|fd
expr_stmt|;
name|mp4
operator|->
name|file
operator|.
name|name
operator|=
name|path
expr_stmt|;
name|mp4
operator|->
name|file
operator|.
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
empty_stmt|;
name|mp4
operator|->
name|end
operator|=
name|of
operator|.
name|size
expr_stmt|;
name|mp4
operator|->
name|start
operator|=
operator|(
name|ngx_uint_t
operator|)
name|start
expr_stmt|;
name|mp4
operator|->
name|request
operator|=
name|r
expr_stmt|;
switch|switch
condition|(
name|ngx_http_mp4_process
argument_list|(
name|mp4
argument_list|)
condition|)
block|{
case|case
name|NGX_DECLINED
case|:
if|if
condition|(
name|mp4
operator|->
name|buffer
condition|)
block|{
name|ngx_pfree
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|mp4
operator|->
name|buffer
argument_list|)
expr_stmt|;
block|}
name|ngx_pfree
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|mp4
argument_list|)
expr_stmt|;
name|mp4
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
name|NGX_OK
case|:
name|r
operator|->
name|headers_out
operator|.
name|content_length_n
operator|=
name|mp4
operator|->
name|content_length
expr_stmt|;
break|break;
default|default:
comment|/* NGX_ERROR */
if|if
condition|(
name|mp4
operator|->
name|buffer
condition|)
block|{
name|ngx_pfree
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|mp4
operator|->
name|buffer
argument_list|)
expr_stmt|;
block|}
name|ngx_pfree
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|mp4
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
block|}
block|}
block|}
name|log
operator|->
name|action
operator|=
literal|"sending mp4 to client"
expr_stmt|;
if|if
condition|(
name|clcf
operator|->
name|directio
operator|<=
name|of
operator|.
name|size
condition|)
block|{
comment|/*          * DIRECTIO is set on transfer only          * to allow kernel to cache "moov" atom          */
if|if
condition|(
name|ngx_directio_on
argument_list|(
name|of
operator|.
name|fd
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_directio_on_n
literal|" \"%s\" failed"
argument_list|,
name|path
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
name|of
operator|.
name|is_directio
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|mp4
condition|)
block|{
name|mp4
operator|->
name|file
operator|.
name|directio
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|r
operator|->
name|headers_out
operator|.
name|status
operator|=
name|NGX_HTTP_OK
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|last_modified_time
operator|=
name|of
operator|.
name|mtime
expr_stmt|;
if|if
condition|(
name|ngx_http_set_content_type
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
if|if
condition|(
name|mp4
operator|==
name|NULL
condition|)
block|{
name|b
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_buf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
name|b
operator|->
name|file
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_file_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|file
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
block|}
name|rc
operator|=
name|ngx_http_send_header
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|>
name|NGX_OK
operator|||
name|r
operator|->
name|header_only
condition|)
block|{
return|return
name|rc
return|;
block|}
if|if
condition|(
name|mp4
condition|)
block|{
return|return
name|ngx_http_output_filter
argument_list|(
name|r
argument_list|,
name|mp4
operator|->
name|out
argument_list|)
return|;
block|}
name|b
operator|->
name|file_pos
operator|=
literal|0
expr_stmt|;
name|b
operator|->
name|file_last
operator|=
name|of
operator|.
name|size
expr_stmt|;
name|b
operator|->
name|in_file
operator|=
name|b
operator|->
name|file_last
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|b
operator|->
name|last_buf
operator|=
literal|1
expr_stmt|;
name|b
operator|->
name|last_in_chain
operator|=
literal|1
expr_stmt|;
name|b
operator|->
name|file
operator|->
name|fd
operator|=
name|of
operator|.
name|fd
expr_stmt|;
name|b
operator|->
name|file
operator|->
name|name
operator|=
name|path
expr_stmt|;
name|b
operator|->
name|file
operator|->
name|log
operator|=
name|log
expr_stmt|;
name|b
operator|->
name|file
operator|->
name|directio
operator|=
name|of
operator|.
name|is_directio
expr_stmt|;
name|out
operator|.
name|buf
operator|=
name|b
expr_stmt|;
name|out
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
return|return
name|ngx_http_output_filter
argument_list|(
name|r
argument_list|,
operator|&
name|out
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_process (ngx_http_mp4_file_t * mp4)
name|ngx_http_mp4_process
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|)
block|{
name|off_t
name|start_offset
decl_stmt|,
name|adjustment
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ngx_chain_t
modifier|*
modifier|*
name|prev
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_http_mp4_conf_t
modifier|*
name|conf
decl_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 start:%ui"
argument_list|,
name|mp4
operator|->
name|start
argument_list|)
expr_stmt|;
name|conf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|mp4
operator|->
name|request
argument_list|,
name|ngx_http_mp4_module
argument_list|)
expr_stmt|;
name|mp4
operator|->
name|buffer_size
operator|=
name|conf
operator|->
name|buffer_size
expr_stmt|;
name|rc
operator|=
name|ngx_http_mp4_read_atom
argument_list|(
name|mp4
argument_list|,
name|ngx_http_mp4_atoms
argument_list|,
name|mp4
operator|->
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|rc
return|;
block|}
if|if
condition|(
name|mp4
operator|->
name|trak
operator|.
name|nelts
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"no mp4 trak atoms were found in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|mp4
operator|->
name|mdat_atom
operator|.
name|buf
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"no mp4 mdat atom was found in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|prev
operator|=
operator|&
name|mp4
operator|->
name|out
expr_stmt|;
if|if
condition|(
name|mp4
operator|->
name|ftyp_atom
operator|.
name|buf
condition|)
block|{
operator|*
name|prev
operator|=
operator|&
name|mp4
operator|->
name|ftyp_atom
expr_stmt|;
name|prev
operator|=
operator|&
name|mp4
operator|->
name|ftyp_atom
operator|.
name|next
expr_stmt|;
block|}
operator|*
name|prev
operator|=
operator|&
name|mp4
operator|->
name|moov_atom
expr_stmt|;
name|prev
operator|=
operator|&
name|mp4
operator|->
name|moov_atom
operator|.
name|next
expr_stmt|;
if|if
condition|(
name|mp4
operator|->
name|mvhd_atom
operator|.
name|buf
condition|)
block|{
name|mp4
operator|->
name|moov_size
operator|+=
name|mp4
operator|->
name|mvhd_atom_buf
operator|.
name|last
operator|-
name|mp4
operator|->
name|mvhd_atom_buf
operator|.
name|pos
expr_stmt|;
operator|*
name|prev
operator|=
operator|&
name|mp4
operator|->
name|mvhd_atom
expr_stmt|;
name|prev
operator|=
operator|&
name|mp4
operator|->
name|mvhd_atom
operator|.
name|next
expr_stmt|;
block|}
name|start_offset
operator|=
name|mp4
operator|->
name|end
expr_stmt|;
name|trak
operator|=
name|mp4
operator|->
name|trak
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mp4
operator|->
name|trak
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_http_mp4_update_stts_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_http_mp4_update_stss_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_http_mp4_update_ctts_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_mp4_update_stsc_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_http_mp4_update_stsz_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_mp4_update_stco_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_http_mp4_update_stbl_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ngx_http_mp4_update_minf_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|trak
index|[
name|i
index|]
operator|.
name|size
operator|+=
name|trak
index|[
name|i
index|]
operator|.
name|mdhd_size
expr_stmt|;
name|trak
index|[
name|i
index|]
operator|.
name|size
operator|+=
name|trak
index|[
name|i
index|]
operator|.
name|hdlr_size
expr_stmt|;
name|ngx_http_mp4_update_mdia_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|trak
index|[
name|i
index|]
operator|.
name|size
operator|+=
name|trak
index|[
name|i
index|]
operator|.
name|tkhd_size
expr_stmt|;
name|ngx_http_mp4_update_trak_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mp4
operator|->
name|moov_size
operator|+=
name|trak
index|[
name|i
index|]
operator|.
name|size
expr_stmt|;
if|if
condition|(
name|start_offset
operator|>
name|trak
index|[
name|i
index|]
operator|.
name|start_offset
condition|)
block|{
name|start_offset
operator|=
name|trak
index|[
name|i
index|]
operator|.
name|start_offset
expr_stmt|;
block|}
operator|*
name|prev
operator|=
operator|&
name|trak
index|[
name|i
index|]
operator|.
name|out
index|[
name|NGX_HTTP_MP4_TRAK_ATOM
index|]
expr_stmt|;
name|prev
operator|=
operator|&
name|trak
index|[
name|i
index|]
operator|.
name|out
index|[
name|NGX_HTTP_MP4_TRAK_ATOM
index|]
operator|.
name|next
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|NGX_HTTP_MP4_LAST_ATOM
operator|+
literal|1
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|trak
index|[
name|i
index|]
operator|.
name|out
index|[
name|j
index|]
operator|.
name|buf
condition|)
block|{
operator|*
name|prev
operator|=
operator|&
name|trak
index|[
name|i
index|]
operator|.
name|out
index|[
name|j
index|]
expr_stmt|;
name|prev
operator|=
operator|&
name|trak
index|[
name|i
index|]
operator|.
name|out
index|[
name|j
index|]
operator|.
name|next
expr_stmt|;
block|}
block|}
block|}
name|mp4
operator|->
name|moov_size
operator|+=
literal|8
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|mp4
operator|->
name|moov_atom_header
argument_list|,
name|mp4
operator|->
name|moov_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|mp4
operator|->
name|moov_atom_header
argument_list|,
literal|'m'
argument_list|,
literal|'o'
argument_list|,
literal|'o'
argument_list|,
literal|'v'
argument_list|)
expr_stmt|;
name|mp4
operator|->
name|content_length
operator|+=
name|mp4
operator|->
name|moov_size
expr_stmt|;
operator|*
name|prev
operator|=
operator|&
name|mp4
operator|->
name|mdat_atom
expr_stmt|;
name|adjustment
operator|=
name|mp4
operator|->
name|ftyp_size
operator|+
name|mp4
operator|->
name|moov_size
operator|+
name|ngx_http_mp4_update_mdat_atom
argument_list|(
name|mp4
argument_list|,
name|start_offset
argument_list|)
operator|-
name|start_offset
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 adjustment:%D"
argument_list|,
name|adjustment
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mp4
operator|->
name|trak
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|ngx_http_mp4_adjust_stco_atom
argument_list|(
name|mp4
argument_list|,
operator|&
name|trak
index|[
name|i
index|]
argument_list|,
operator|(
name|int32_t
operator|)
name|adjustment
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f0608
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_atom_header_t
block|}
name|ngx_mp4_atom_header_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f0708
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|size64
name|u_char
name|size64
index|[
literal|8
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_atom_header64_t
block|}
name|ngx_mp4_atom_header64_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_atom_handler_t * atom,uint64_t atom_data_size)
name|ngx_http_mp4_read_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_atom_handler_t
modifier|*
name|atom
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|off_t
name|end
decl_stmt|;
name|size_t
name|atom_header_size
decl_stmt|;
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_name
decl_stmt|;
name|uint64_t
name|atom_size
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|n
decl_stmt|;
name|end
operator|=
name|mp4
operator|->
name|offset
operator|+
name|atom_data_size
expr_stmt|;
while|while
condition|(
name|mp4
operator|->
name|offset
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|mp4
operator|->
name|buffer_pos
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|>
name|mp4
operator|->
name|buffer_end
condition|)
block|{
if|if
condition|(
name|ngx_http_mp4_read
argument_list|(
name|mp4
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
name|atom_header
operator|=
name|mp4
operator|->
name|buffer_pos
expr_stmt|;
name|atom_size
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|atom_header
argument_list|)
expr_stmt|;
name|atom_header_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|atom_size
operator|==
literal|0
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 atom end"
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|atom_size
operator|<
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
condition|)
block|{
if|if
condition|(
name|atom_size
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|mp4
operator|->
name|buffer_pos
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header64_t
argument_list|)
operator|>
name|mp4
operator|->
name|buffer_end
condition|)
block|{
if|if
condition|(
name|ngx_http_mp4_read
argument_list|(
name|mp4
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|atom_header
operator|=
name|mp4
operator|->
name|buffer_pos
expr_stmt|;
block|}
comment|/* 64-bit atom size */
name|atom_size
operator|=
name|ngx_mp4_get_64value
argument_list|(
name|atom_header
operator|+
literal|8
argument_list|)
expr_stmt|;
name|atom_header_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header64_t
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 atom is too small:%uL"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
if|if
condition|(
name|mp4
operator|->
name|buffer_pos
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|>
name|mp4
operator|->
name|buffer_end
condition|)
block|{
if|if
condition|(
name|ngx_http_mp4_read
argument_list|(
name|mp4
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|atom_header
operator|=
name|mp4
operator|->
name|buffer_pos
expr_stmt|;
block|}
name|atom_name
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 atom: %*s @%O:%uL"
argument_list|,
literal|4
argument_list|,
name|atom_name
argument_list|,
name|mp4
operator|->
name|offset
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|atom
index|[
name|n
index|]
operator|.
name|name
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|atom_name
argument_list|,
name|atom
index|[
name|n
index|]
operator|.
name|name
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_header_size
argument_list|)
expr_stmt|;
name|rc
operator|=
name|atom
index|[
name|n
index|]
operator|.
name|handler
argument_list|(
name|mp4
argument_list|,
name|atom_size
operator|-
name|atom_header_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|rc
return|;
block|}
goto|goto
name|next
goto|;
block|}
block|}
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|next
label|:
continue|continue;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read (ngx_http_mp4_file_t * mp4)
name|ngx_http_mp4_read
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|)
block|{
name|ngx_int_t
name|n
decl_stmt|;
if|if
condition|(
name|mp4
operator|->
name|offset
operator|+
operator|(
name|off_t
operator|)
name|mp4
operator|->
name|buffer_size
operator|>
name|mp4
operator|->
name|end
condition|)
block|{
name|mp4
operator|->
name|buffer_size
operator|=
operator|(
name|size_t
operator|)
operator|(
name|mp4
operator|->
name|end
operator|-
name|mp4
operator|->
name|offset
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|mp4
operator|->
name|buffer
operator|==
name|NULL
condition|)
block|{
name|mp4
operator|->
name|buffer
operator|=
name|ngx_palloc
argument_list|(
name|mp4
operator|->
name|request
operator|->
name|pool
argument_list|,
name|mp4
operator|->
name|buffer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp4
operator|->
name|buffer
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|mp4
operator|->
name|buffer_start
operator|=
name|mp4
operator|->
name|buffer
expr_stmt|;
name|mp4
operator|->
name|buffer_end
operator|=
name|mp4
operator|->
name|buffer
operator|+
name|mp4
operator|->
name|buffer_size
expr_stmt|;
block|}
name|n
operator|=
name|ngx_read_file
argument_list|(
operator|&
name|mp4
operator|->
name|file
argument_list|,
name|mp4
operator|->
name|buffer_start
argument_list|,
name|mp4
operator|->
name|buffer_size
argument_list|,
name|mp4
operator|->
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|mp4
operator|->
name|buffer_pos
operator|=
name|mp4
operator|->
name|buffer_start
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_ftyp_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_ftyp_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|ftyp_atom
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 ftyp atom"
argument_list|)
expr_stmt|;
if|if
condition|(
name|atom_data_size
operator|>
literal|1024
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 ftyp atom is too large:%uL"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|ftyp_atom
operator|=
name|ngx_palloc
argument_list|(
name|mp4
operator|->
name|request
operator|->
name|pool
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ftyp_atom
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_mp4_set_32value
argument_list|(
name|ftyp_atom
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|ftyp_atom
argument_list|,
literal|'f'
argument_list|,
literal|'t'
argument_list|,
literal|'y'
argument_list|,
literal|'p'
argument_list|)
expr_stmt|;
comment|/*      * only moov atom content is guaranteed to be in mp4->buffer      * during sending response, so ftyp atom content should be copied      */
name|ngx_memcpy
argument_list|(
name|ftyp_atom
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
argument_list|,
name|ngx_mp4_atom_data
argument_list|(
name|mp4
argument_list|)
argument_list|,
operator|(
name|size_t
operator|)
name|atom_data_size
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|mp4
operator|->
name|ftyp_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|ftyp_atom
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|ftyp_atom
operator|+
name|atom_size
expr_stmt|;
name|mp4
operator|->
name|ftyp_atom
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|mp4
operator|->
name|ftyp_size
operator|=
name|atom_size
expr_stmt|;
name|mp4
operator|->
name|content_length
operator|=
name|atom_size
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_comment
comment|/*  * Small excess buffer to process atoms after moov atom, mp4->buffer_start  * will be set to this buffer part after moov atom processing.  */
end_comment

begin_define
DECL|macro|NGX_HTTP_MP4_MOOV_BUFFER_EXCESS
define|#
directive|define
name|NGX_HTTP_MP4_MOOV_BUFFER_EXCESS
value|(4 * 1024)
end_define

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_moov_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_moov_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|no_mdat
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_conf_t
modifier|*
name|conf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 moov atom"
argument_list|)
expr_stmt|;
name|no_mdat
operator|=
operator|(
name|mp4
operator|->
name|mdat_atom
operator|.
name|buf
operator|==
name|NULL
operator|)
expr_stmt|;
if|if
condition|(
name|no_mdat
operator|&&
name|mp4
operator|->
name|start
operator|==
literal|0
condition|)
block|{
comment|/*          * send original file if moov atom resides before          * mdat atom and client requests integral file          */
return|return
name|NGX_DECLINED
return|;
block|}
name|conf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|mp4
operator|->
name|request
argument_list|,
name|ngx_http_mp4_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|atom_data_size
operator|>
name|mp4
operator|->
name|buffer_size
condition|)
block|{
if|if
condition|(
name|atom_data_size
operator|>
name|conf
operator|->
name|max_buffer_size
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 moov atom is too large:%uL, "
literal|"you may want to increase mp4_max_buffer_size"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_pfree
argument_list|(
name|mp4
operator|->
name|request
operator|->
name|pool
argument_list|,
name|mp4
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|mp4
operator|->
name|buffer
operator|=
name|NULL
expr_stmt|;
name|mp4
operator|->
name|buffer_pos
operator|=
name|NULL
expr_stmt|;
name|mp4
operator|->
name|buffer_end
operator|=
name|NULL
expr_stmt|;
name|mp4
operator|->
name|buffer_size
operator|=
operator|(
name|size_t
operator|)
name|atom_data_size
operator|+
name|NGX_HTTP_MP4_MOOV_BUFFER_EXCESS
operator|*
name|no_mdat
expr_stmt|;
block|}
name|mp4
operator|->
name|trak
operator|.
name|elts
operator|=
operator|&
name|mp4
operator|->
name|traks
expr_stmt|;
name|mp4
operator|->
name|trak
operator|.
name|size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_http_mp4_trak_t
argument_list|)
expr_stmt|;
name|mp4
operator|->
name|trak
operator|.
name|nalloc
operator|=
literal|2
expr_stmt|;
name|mp4
operator|->
name|trak
operator|.
name|pool
operator|=
name|mp4
operator|->
name|request
operator|->
name|pool
expr_stmt|;
name|atom
operator|=
operator|&
name|mp4
operator|->
name|moov_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|mp4
operator|->
name|moov_atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|mp4
operator|->
name|moov_atom_header
operator|+
literal|8
expr_stmt|;
name|mp4
operator|->
name|moov_atom
operator|.
name|buf
operator|=
operator|&
name|mp4
operator|->
name|moov_atom_buf
expr_stmt|;
name|rc
operator|=
name|ngx_http_mp4_read_atom
argument_list|(
name|mp4
argument_list|,
name|ngx_http_mp4_moov_atoms
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 moov atom done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|no_mdat
condition|)
block|{
name|mp4
operator|->
name|buffer_start
operator|=
name|mp4
operator|->
name|buffer_pos
expr_stmt|;
name|mp4
operator|->
name|buffer_size
operator|=
name|NGX_HTTP_MP4_MOOV_BUFFER_EXCESS
expr_stmt|;
block|}
else|else
block|{
comment|/* skip atoms after moov atom */
name|mp4
operator|->
name|offset
operator|=
name|mp4
operator|->
name|end
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_mdat_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_mdat_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|ngx_buf_t
modifier|*
name|data
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 mdat atom"
argument_list|)
expr_stmt|;
name|data
operator|=
operator|&
name|mp4
operator|->
name|mdat_data_buf
expr_stmt|;
name|data
operator|->
name|file
operator|=
operator|&
name|mp4
operator|->
name|file
expr_stmt|;
name|data
operator|->
name|in_file
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|last_buf
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|last_in_chain
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|file_last
operator|=
name|mp4
operator|->
name|offset
operator|+
name|atom_data_size
expr_stmt|;
name|mp4
operator|->
name|mdat_atom
operator|.
name|buf
operator|=
operator|&
name|mp4
operator|->
name|mdat_atom_buf
expr_stmt|;
name|mp4
operator|->
name|mdat_atom
operator|.
name|next
operator|=
operator|&
name|mp4
operator|->
name|mdat_data
expr_stmt|;
name|mp4
operator|->
name|mdat_data
operator|.
name|buf
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|mp4
operator|->
name|trak
operator|.
name|nelts
condition|)
block|{
comment|/* skip atoms after mdat atom */
name|mp4
operator|->
name|offset
operator|=
name|mp4
operator|->
name|end
expr_stmt|;
block|}
else|else
block|{
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
DECL|function|ngx_http_mp4_update_mdat_atom (ngx_http_mp4_file_t * mp4,off_t start_offset)
name|ngx_http_mp4_update_mdat_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|off_t
name|start_offset
parameter_list|)
block|{
name|off_t
name|atom_data_size
decl_stmt|;
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|uint32_t
name|atom_header_size
decl_stmt|;
name|uint64_t
name|atom_size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|atom_data_size
operator|=
name|mp4
operator|->
name|mdat_data
operator|.
name|buf
operator|->
name|file_last
operator|-
name|start_offset
expr_stmt|;
name|mp4
operator|->
name|mdat_data
operator|.
name|buf
operator|->
name|file_pos
operator|=
name|start_offset
expr_stmt|;
name|mp4
operator|->
name|content_length
operator|+=
name|atom_data_size
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mdat new offset @%O:%O"
argument_list|,
name|start_offset
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|mp4
operator|->
name|mdat_atom_header
expr_stmt|;
if|if
condition|(
name|atom_data_size
operator|>
literal|0xffffffff
condition|)
block|{
name|atom_size
operator|=
literal|1
expr_stmt|;
name|atom_header_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header64_t
argument_list|)
expr_stmt|;
name|ngx_mp4_set_64value
argument_list|(
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header64_t
argument_list|)
operator|+
name|atom_data_size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
name|atom_data_size
expr_stmt|;
name|atom_header_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
block|}
name|ngx_mp4_set_32value
argument_list|(
name|atom_header
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'m'
argument_list|,
literal|'d'
argument_list|,
literal|'a'
argument_list|,
literal|'t'
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|mp4
operator|->
name|mdat_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
name|atom_header_size
expr_stmt|;
return|return
name|atom_header_size
return|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f0808
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|creation_time
name|u_char
name|creation_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|modification_time
name|u_char
name|modification_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|timescale
name|u_char
name|timescale
index|[
literal|4
index|]
decl_stmt|;
DECL|member|duration
name|u_char
name|duration
index|[
literal|4
index|]
decl_stmt|;
DECL|member|rate
name|u_char
name|rate
index|[
literal|4
index|]
decl_stmt|;
DECL|member|volume
name|u_char
name|volume
index|[
literal|2
index|]
decl_stmt|;
DECL|member|reserved
name|u_char
name|reserved
index|[
literal|10
index|]
decl_stmt|;
DECL|member|matrix
name|u_char
name|matrix
index|[
literal|36
index|]
decl_stmt|;
DECL|member|preview_time
name|u_char
name|preview_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|preview_duration
name|u_char
name|preview_duration
index|[
literal|4
index|]
decl_stmt|;
DECL|member|poster_time
name|u_char
name|poster_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|selection_time
name|u_char
name|selection_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|selection_duration
name|u_char
name|selection_duration
index|[
literal|4
index|]
decl_stmt|;
DECL|member|current_time
name|u_char
name|current_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|next_track_id
name|u_char
name|next_track_id
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_mvhd_atom_t
block|}
name|ngx_mp4_mvhd_atom_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f0908
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|creation_time
name|u_char
name|creation_time
index|[
literal|8
index|]
decl_stmt|;
DECL|member|modification_time
name|u_char
name|modification_time
index|[
literal|8
index|]
decl_stmt|;
DECL|member|timescale
name|u_char
name|timescale
index|[
literal|4
index|]
decl_stmt|;
DECL|member|duration
name|u_char
name|duration
index|[
literal|8
index|]
decl_stmt|;
DECL|member|rate
name|u_char
name|rate
index|[
literal|4
index|]
decl_stmt|;
DECL|member|volume
name|u_char
name|volume
index|[
literal|2
index|]
decl_stmt|;
DECL|member|reserved
name|u_char
name|reserved
index|[
literal|10
index|]
decl_stmt|;
DECL|member|matrix
name|u_char
name|matrix
index|[
literal|36
index|]
decl_stmt|;
DECL|member|preview_time
name|u_char
name|preview_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|preview_duration
name|u_char
name|preview_duration
index|[
literal|4
index|]
decl_stmt|;
DECL|member|poster_time
name|u_char
name|poster_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|selection_time
name|u_char
name|selection_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|selection_duration
name|u_char
name|selection_duration
index|[
literal|4
index|]
decl_stmt|;
DECL|member|current_time
name|u_char
name|current_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|next_track_id
name|u_char
name|next_track_id
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_mvhd64_atom_t
block|}
name|ngx_mp4_mvhd64_atom_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_mvhd_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_mvhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|uint32_t
name|timescale
decl_stmt|;
name|uint64_t
name|duration
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_mp4_mvhd_atom_t
modifier|*
name|mvhd_atom
decl_stmt|;
name|ngx_mp4_mvhd64_atom_t
modifier|*
name|mvhd64_atom
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 mvhd atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|mvhd_atom
operator|=
operator|(
name|ngx_mp4_mvhd_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|mvhd64_atom
operator|=
operator|(
name|ngx_mp4_mvhd64_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'m'
argument_list|,
literal|'v'
argument_list|,
literal|'h'
argument_list|,
literal|'d'
argument_list|)
expr_stmt|;
if|if
condition|(
name|mvhd_atom
operator|->
name|version
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
comment|/* version 0: 32-bit duration */
name|timescale
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|mvhd_atom
operator|->
name|timescale
argument_list|)
expr_stmt|;
name|duration
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|mvhd_atom
operator|->
name|duration
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* version 1: 64-bit duration */
name|timescale
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|mvhd64_atom
operator|->
name|timescale
argument_list|)
expr_stmt|;
name|duration
operator|=
name|ngx_mp4_get_64value
argument_list|(
name|mvhd64_atom
operator|->
name|duration
argument_list|)
expr_stmt|;
block|}
name|mp4
operator|->
name|timescale
operator|=
name|timescale
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mvhd timescale:%uD, duration:%uL, time:%.3fs"
argument_list|,
name|timescale
argument_list|,
name|duration
argument_list|,
operator|(
name|double
operator|)
name|duration
operator|/
name|timescale
argument_list|)
expr_stmt|;
name|duration
operator|-=
operator|(
name|uint64_t
operator|)
name|mp4
operator|->
name|start
operator|*
name|timescale
operator|/
literal|1000
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mvhd new duration:%uL, time:%.3fs"
argument_list|,
name|duration
argument_list|,
operator|(
name|double
operator|)
name|duration
operator|/
name|timescale
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|mvhd_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|mvhd_atom
operator|->
name|version
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|ngx_mp4_set_32value
argument_list|(
name|mvhd_atom
operator|->
name|duration
argument_list|,
name|duration
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_mp4_set_64value
argument_list|(
name|mvhd64_atom
operator|->
name|duration
argument_list|,
name|duration
argument_list|)
expr_stmt|;
block|}
name|atom
operator|=
operator|&
name|mp4
operator|->
name|mvhd_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
name|atom_size
expr_stmt|;
name|mp4
operator|->
name|mvhd_atom
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_trak_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_trak_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_end
decl_stmt|;
name|off_t
name|atom_file_end
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 trak atom"
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|mp4
operator|->
name|trak
argument_list|)
expr_stmt|;
if|if
condition|(
name|trak
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
name|trak
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_mp4_trak_t
argument_list|)
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'t'
argument_list|,
literal|'r'
argument_list|,
literal|'a'
argument_list|,
literal|'k'
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|trak_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_TRAK_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|atom_end
operator|=
name|mp4
operator|->
name|buffer_pos
operator|+
name|atom_data_size
expr_stmt|;
name|atom_file_end
operator|=
name|mp4
operator|->
name|offset
operator|+
name|atom_data_size
expr_stmt|;
name|rc
operator|=
name|ngx_http_mp4_read_atom
argument_list|(
name|mp4
argument_list|,
name|ngx_http_mp4_trak_atoms
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 trak atom: %i"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
comment|/* skip this trak */
name|ngx_memzero
argument_list|(
name|trak
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_mp4_trak_t
argument_list|)
argument_list|)
expr_stmt|;
name|mp4
operator|->
name|trak
operator|.
name|nelts
operator|--
expr_stmt|;
name|mp4
operator|->
name|buffer_pos
operator|=
name|atom_end
expr_stmt|;
name|mp4
operator|->
name|offset
operator|=
name|atom_file_end
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_mp4_update_trak_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_trak_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|trak
operator|->
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|trak_atom_buf
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom
operator|->
name|pos
argument_list|,
name|trak
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_cmov_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_cmov_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 compressed moov atom (cmov) is not supported"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f0a08
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|creation_time
name|u_char
name|creation_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|modification_time
name|u_char
name|modification_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|track_id
name|u_char
name|track_id
index|[
literal|4
index|]
decl_stmt|;
DECL|member|reserved1
name|u_char
name|reserved1
index|[
literal|4
index|]
decl_stmt|;
DECL|member|duration
name|u_char
name|duration
index|[
literal|4
index|]
decl_stmt|;
DECL|member|reserved2
name|u_char
name|reserved2
index|[
literal|8
index|]
decl_stmt|;
DECL|member|layer
name|u_char
name|layer
index|[
literal|2
index|]
decl_stmt|;
DECL|member|group
name|u_char
name|group
index|[
literal|2
index|]
decl_stmt|;
DECL|member|volume
name|u_char
name|volume
index|[
literal|2
index|]
decl_stmt|;
DECL|member|reverved3
name|u_char
name|reverved3
index|[
literal|2
index|]
decl_stmt|;
DECL|member|matrix
name|u_char
name|matrix
index|[
literal|36
index|]
decl_stmt|;
DECL|member|width
name|u_char
name|width
index|[
literal|4
index|]
decl_stmt|;
DECL|member|heigth
name|u_char
name|heigth
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_tkhd_atom_t
block|}
name|ngx_mp4_tkhd_atom_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f0b08
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|creation_time
name|u_char
name|creation_time
index|[
literal|8
index|]
decl_stmt|;
DECL|member|modification_time
name|u_char
name|modification_time
index|[
literal|8
index|]
decl_stmt|;
DECL|member|track_id
name|u_char
name|track_id
index|[
literal|4
index|]
decl_stmt|;
DECL|member|reserved1
name|u_char
name|reserved1
index|[
literal|4
index|]
decl_stmt|;
DECL|member|duration
name|u_char
name|duration
index|[
literal|8
index|]
decl_stmt|;
DECL|member|reserved2
name|u_char
name|reserved2
index|[
literal|8
index|]
decl_stmt|;
DECL|member|layer
name|u_char
name|layer
index|[
literal|2
index|]
decl_stmt|;
DECL|member|group
name|u_char
name|group
index|[
literal|2
index|]
decl_stmt|;
DECL|member|volume
name|u_char
name|volume
index|[
literal|2
index|]
decl_stmt|;
DECL|member|reverved3
name|u_char
name|reverved3
index|[
literal|2
index|]
decl_stmt|;
DECL|member|matrix
name|u_char
name|matrix
index|[
literal|36
index|]
decl_stmt|;
DECL|member|width
name|u_char
name|width
index|[
literal|4
index|]
decl_stmt|;
DECL|member|heigth
name|u_char
name|heigth
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_tkhd64_atom_t
block|}
name|ngx_mp4_tkhd64_atom_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_tkhd_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_tkhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|uint64_t
name|duration
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_mp4_tkhd_atom_t
modifier|*
name|tkhd_atom
decl_stmt|;
name|ngx_mp4_tkhd64_atom_t
modifier|*
name|tkhd64_atom
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 tkhd atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|tkhd_atom
operator|=
operator|(
name|ngx_mp4_tkhd_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|tkhd64_atom
operator|=
operator|(
name|ngx_mp4_tkhd64_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|tkhd_atom
argument_list|,
literal|'t'
argument_list|,
literal|'k'
argument_list|,
literal|'h'
argument_list|,
literal|'d'
argument_list|)
expr_stmt|;
if|if
condition|(
name|tkhd_atom
operator|->
name|version
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
comment|/* version 0: 32-bit duration */
name|duration
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|tkhd_atom
operator|->
name|duration
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* version 1: 64-bit duration */
name|duration
operator|=
name|ngx_mp4_get_64value
argument_list|(
name|tkhd64_atom
operator|->
name|duration
argument_list|)
expr_stmt|;
block|}
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"tkhd duration:%uL, time:%.3fs"
argument_list|,
name|duration
argument_list|,
operator|(
name|double
operator|)
name|duration
operator|/
name|mp4
operator|->
name|timescale
argument_list|)
expr_stmt|;
name|duration
operator|-=
operator|(
name|uint64_t
operator|)
name|mp4
operator|->
name|start
operator|*
name|mp4
operator|->
name|timescale
operator|/
literal|1000
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"tkhd new duration:%uL, time:%.3fs"
argument_list|,
name|duration
argument_list|,
operator|(
name|double
operator|)
name|duration
operator|/
name|mp4
operator|->
name|timescale
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|trak
operator|->
name|tkhd_size
operator|=
name|atom_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|tkhd_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|tkhd_atom
operator|->
name|version
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|ngx_mp4_set_32value
argument_list|(
name|tkhd_atom
operator|->
name|duration
argument_list|,
name|duration
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_mp4_set_64value
argument_list|(
name|tkhd64_atom
operator|->
name|duration
argument_list|,
name|duration
argument_list|)
expr_stmt|;
block|}
name|atom
operator|=
operator|&
name|trak
operator|->
name|tkhd_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
name|atom_size
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_TKHD_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_mdia_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_mdia_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"process mdia atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'m'
argument_list|,
literal|'d'
argument_list|,
literal|'i'
argument_list|,
literal|'a'
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|mdia_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_MDIA_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
return|return
name|ngx_http_mp4_read_atom
argument_list|(
name|mp4
argument_list|,
name|ngx_http_mp4_mdia_atoms
argument_list|,
name|atom_data_size
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_mp4_update_mdia_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_mdia_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|trak
operator|->
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|mdia_atom_buf
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom
operator|->
name|pos
argument_list|,
name|trak
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f0c08
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|creation_time
name|u_char
name|creation_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|modification_time
name|u_char
name|modification_time
index|[
literal|4
index|]
decl_stmt|;
DECL|member|timescale
name|u_char
name|timescale
index|[
literal|4
index|]
decl_stmt|;
DECL|member|duration
name|u_char
name|duration
index|[
literal|4
index|]
decl_stmt|;
DECL|member|language
name|u_char
name|language
index|[
literal|2
index|]
decl_stmt|;
DECL|member|quality
name|u_char
name|quality
index|[
literal|2
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_mdhd_atom_t
block|}
name|ngx_mp4_mdhd_atom_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f0d08
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|creation_time
name|u_char
name|creation_time
index|[
literal|8
index|]
decl_stmt|;
DECL|member|modification_time
name|u_char
name|modification_time
index|[
literal|8
index|]
decl_stmt|;
DECL|member|timescale
name|u_char
name|timescale
index|[
literal|4
index|]
decl_stmt|;
DECL|member|duration
name|u_char
name|duration
index|[
literal|8
index|]
decl_stmt|;
DECL|member|language
name|u_char
name|language
index|[
literal|2
index|]
decl_stmt|;
DECL|member|quality
name|u_char
name|quality
index|[
literal|2
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_mdhd64_atom_t
block|}
name|ngx_mp4_mdhd64_atom_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_mdhd_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_mdhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|uint32_t
name|timescale
decl_stmt|;
name|uint64_t
name|duration
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_mp4_mdhd_atom_t
modifier|*
name|mdhd_atom
decl_stmt|;
name|ngx_mp4_mdhd64_atom_t
modifier|*
name|mdhd64_atom
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 mdhd atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|mdhd_atom
operator|=
operator|(
name|ngx_mp4_mdhd_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|mdhd64_atom
operator|=
operator|(
name|ngx_mp4_mdhd64_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|mdhd_atom
argument_list|,
literal|'m'
argument_list|,
literal|'d'
argument_list|,
literal|'h'
argument_list|,
literal|'d'
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdhd_atom
operator|->
name|version
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
comment|/* version 0: everything is 32-bit */
name|timescale
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|mdhd_atom
operator|->
name|timescale
argument_list|)
expr_stmt|;
name|duration
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|mdhd_atom
operator|->
name|duration
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* version 1: 64-bit duration and 32-bit timescale */
name|timescale
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|mdhd64_atom
operator|->
name|timescale
argument_list|)
expr_stmt|;
name|duration
operator|=
name|ngx_mp4_get_64value
argument_list|(
name|mdhd64_atom
operator|->
name|duration
argument_list|)
expr_stmt|;
block|}
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mdhd timescale:%uD, duration:%uL, time:%.3fs"
argument_list|,
name|timescale
argument_list|,
name|duration
argument_list|,
operator|(
name|double
operator|)
name|duration
operator|/
name|timescale
argument_list|)
expr_stmt|;
name|duration
operator|-=
operator|(
name|uint64_t
operator|)
name|mp4
operator|->
name|start
operator|*
name|timescale
operator|/
literal|1000
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mdhd new duration:%uL, time:%.3fs"
argument_list|,
name|duration
argument_list|,
operator|(
name|double
operator|)
name|duration
operator|/
name|timescale
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|trak
operator|->
name|mdhd_size
operator|=
name|atom_size
expr_stmt|;
name|trak
operator|->
name|timescale
operator|=
name|timescale
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|mdhd_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdhd_atom
operator|->
name|version
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|ngx_mp4_set_32value
argument_list|(
name|mdhd_atom
operator|->
name|duration
argument_list|,
name|duration
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_mp4_set_64value
argument_list|(
name|mdhd64_atom
operator|->
name|duration
argument_list|,
name|duration
argument_list|)
expr_stmt|;
block|}
name|atom
operator|=
operator|&
name|trak
operator|->
name|mdhd_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
name|atom_size
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_MDHD_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_hdlr_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_hdlr_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 hdlr atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom_header
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'h'
argument_list|,
literal|'d'
argument_list|,
literal|'l'
argument_list|,
literal|'r'
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|hdlr_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
name|atom_size
expr_stmt|;
name|trak
operator|->
name|hdlr_size
operator|=
name|atom_size
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_HDLR_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_minf_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_minf_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"process minf atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'m'
argument_list|,
literal|'i'
argument_list|,
literal|'n'
argument_list|,
literal|'f'
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|minf_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_MINF_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
return|return
name|ngx_http_mp4_read_atom
argument_list|(
name|mp4
argument_list|,
name|ngx_http_mp4_minf_atoms
argument_list|,
name|atom_data_size
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_mp4_update_minf_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_minf_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|trak
operator|->
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
name|trak
operator|->
name|vmhd_size
operator|+
name|trak
operator|->
name|smhd_size
operator|+
name|trak
operator|->
name|dinf_size
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|minf_atom_buf
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom
operator|->
name|pos
argument_list|,
name|trak
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_vmhd_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_vmhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 vmhd atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom_header
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'v'
argument_list|,
literal|'m'
argument_list|,
literal|'h'
argument_list|,
literal|'d'
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|vmhd_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
name|atom_size
expr_stmt|;
name|trak
operator|->
name|vmhd_size
operator|+=
name|atom_size
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_VMHD_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_smhd_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_smhd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 smhd atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom_header
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'s'
argument_list|,
literal|'m'
argument_list|,
literal|'h'
argument_list|,
literal|'d'
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|smhd_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
name|atom_size
expr_stmt|;
name|trak
operator|->
name|vmhd_size
operator|+=
name|atom_size
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_SMHD_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_dinf_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_dinf_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 dinf atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom_header
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'d'
argument_list|,
literal|'i'
argument_list|,
literal|'n'
argument_list|,
literal|'f'
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|dinf_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
name|atom_size
expr_stmt|;
name|trak
operator|->
name|dinf_size
operator|+=
name|atom_size
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_DINF_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_stbl_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_stbl_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"process stbl atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|atom_header
argument_list|,
literal|'s'
argument_list|,
literal|'t'
argument_list|,
literal|'b'
argument_list|,
literal|'l'
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|stbl_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STBL_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
return|return
name|ngx_http_mp4_read_atom
argument_list|(
name|mp4
argument_list|,
name|ngx_http_mp4_stbl_atoms
argument_list|,
name|atom_data_size
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_mp4_update_stbl_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_stbl_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|trak
operator|->
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|stbl_atom_buf
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom
operator|->
name|pos
argument_list|,
name|trak
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f0e08
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|entries
name|u_char
name|entries
index|[
literal|4
index|]
decl_stmt|;
DECL|member|media_size
name|u_char
name|media_size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|media_name
name|u_char
name|media_name
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_stsd_atom_t
block|}
name|ngx_mp4_stsd_atom_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_stsd_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_stsd_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_table
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|;
name|ngx_mp4_stsd_atom_t
modifier|*
name|stsd_atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
comment|/* sample description atom */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stsd atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|stsd_atom
operator|=
operator|(
name|ngx_mp4_stsd_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|atom_table
operator|=
name|atom_header
operator|+
name|atom_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stsd_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|stsd_atom
argument_list|,
literal|'s'
argument_list|,
literal|'t'
argument_list|,
literal|'s'
argument_list|,
literal|'d'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint64_t
operator|)
operator|(
sizeof|sizeof
argument_list|(
name|ngx_mp4_stsd_atom_t
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|)
operator|>
name|atom_data_size
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 stsd atom too large"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"stsd entries:%uD, media:%*s"
argument_list|,
name|ngx_mp4_get_32value
argument_list|(
name|stsd_atom
operator|->
name|entries
argument_list|)
argument_list|,
literal|4
argument_list|,
name|stsd_atom
operator|->
name|media_name
argument_list|)
expr_stmt|;
comment|/* supported media format: "avc1" (H.264) and "mp4a" (MPEG-4/AAC) */
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|stsd_atom
operator|->
name|media_name
argument_list|,
literal|"avc1"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
operator|&&
name|ngx_strncmp
argument_list|(
name|stsd_atom
operator|->
name|media_name
argument_list|,
literal|"mp4a"
argument_list|,
literal|4
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|stsd_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_table
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSD_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|trak
operator|->
name|size
operator|+=
name|atom_size
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f0f08
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|entries
name|u_char
name|entries
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_stts_atom_t
block|}
name|ngx_mp4_stts_atom_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f1008
typedef|typedef
struct|struct
block|{
DECL|member|count
name|u_char
name|count
index|[
literal|4
index|]
decl_stmt|;
DECL|member|duration
name|u_char
name|duration
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_stts_entry_t
block|}
name|ngx_mp4_stts_entry_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_stts_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_stts_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_table
decl_stmt|,
modifier|*
name|atom_end
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_mp4_stts_atom_t
modifier|*
name|stts_atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
comment|/* time-to-sample atom */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stts atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|stts_atom
operator|=
operator|(
name|ngx_mp4_stts_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|stts_atom
argument_list|,
literal|'s'
argument_list|,
literal|'t'
argument_list|,
literal|'t'
argument_list|,
literal|'s'
argument_list|)
expr_stmt|;
name|entries
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|stts_atom
operator|->
name|entries
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 time-to-sample entries:%uD"
argument_list|,
name|entries
argument_list|)
expr_stmt|;
name|atom_table
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_stts_atom_t
argument_list|)
expr_stmt|;
name|atom_end
operator|=
name|atom_table
operator|+
name|entries
operator|*
sizeof|sizeof
argument_list|(
name|ngx_mp4_stts_entry_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint64_t
operator|)
operator|(
name|atom_end
operator|-
name|stts_atom
operator|->
name|version
operator|)
operator|>
name|atom_data_size
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 stts atom too large"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|trak
operator|->
name|time_to_sample_entries
operator|=
name|entries
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|stts_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_table
expr_stmt|;
name|data
operator|=
operator|&
name|trak
operator|->
name|stts_data_buf
expr_stmt|;
name|data
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|pos
operator|=
name|atom_table
expr_stmt|;
name|data
operator|->
name|last
operator|=
name|atom_end
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STTS_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STTS_DATA
index|]
operator|.
name|buf
operator|=
name|data
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_update_stts_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_stts_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|size_t
name|atom_size
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|,
name|count
decl_stmt|,
name|duration
decl_stmt|;
name|uint64_t
name|start_time
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_uint_t
name|start_sample
decl_stmt|;
name|ngx_mp4_stts_atom_t
modifier|*
name|stts_atom
decl_stmt|;
name|ngx_mp4_stts_entry_t
modifier|*
name|entry
decl_stmt|,
modifier|*
name|end
decl_stmt|;
comment|/*      * mdia.minf.stbl.stts updating requires trak->timescale      * from mdia.mdhd atom which may reside after mdia.minf      */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stts atom update"
argument_list|)
expr_stmt|;
name|data
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STTS_DATA
index|]
operator|.
name|buf
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"no mp4 stts atoms were found in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|entries
operator|=
name|trak
operator|->
name|time_to_sample_entries
expr_stmt|;
name|start_time
operator|=
name|mp4
operator|->
name|start
operator|*
name|trak
operator|->
name|timescale
operator|/
literal|1000
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"time-to-sample start_time:%uL"
argument_list|,
name|start_time
argument_list|)
expr_stmt|;
name|start_sample
operator|=
literal|0
expr_stmt|;
name|entry
operator|=
operator|(
name|ngx_mp4_stts_entry_t
operator|*
operator|)
name|data
operator|->
name|pos
expr_stmt|;
name|end
operator|=
operator|(
name|ngx_mp4_stts_entry_t
operator|*
operator|)
name|data
operator|->
name|last
expr_stmt|;
while|while
condition|(
name|entry
operator|<
name|end
condition|)
block|{
name|count
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|count
argument_list|)
expr_stmt|;
name|duration
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|duration
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"count:%uD, duration:%uD"
argument_list|,
name|count
argument_list|,
name|duration
argument_list|)
expr_stmt|;
if|if
condition|(
name|start_time
operator|<
name|count
operator|*
name|duration
condition|)
block|{
name|start_sample
operator|+=
operator|(
name|ngx_uint_t
operator|)
operator|(
name|start_time
operator|/
name|duration
operator|)
expr_stmt|;
name|count
operator|-=
name|start_sample
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|entry
operator|->
name|count
argument_list|,
name|count
argument_list|)
expr_stmt|;
goto|goto
name|found
goto|;
block|}
name|start_sample
operator|+=
name|count
expr_stmt|;
name|start_time
operator|-=
name|count
operator|*
name|duration
expr_stmt|;
name|entries
operator|--
expr_stmt|;
name|entry
operator|++
expr_stmt|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start time is out mp4 stts samples in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
name|found
label|:
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start_sample:%ui, new count:%uD"
argument_list|,
name|start_sample
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|trak
operator|->
name|start_sample
operator|=
name|start_sample
expr_stmt|;
name|data
operator|->
name|pos
operator|=
operator|(
name|u_char
operator|*
operator|)
name|entry
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_stts_atom_t
argument_list|)
operator|+
operator|(
name|data
operator|->
name|last
operator|-
name|data
operator|->
name|pos
operator|)
expr_stmt|;
name|trak
operator|->
name|size
operator|+=
name|atom_size
expr_stmt|;
name|atom
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STTS_ATOM
index|]
operator|.
name|buf
expr_stmt|;
name|stts_atom
operator|=
operator|(
name|ngx_mp4_stts_atom_t
operator|*
operator|)
name|atom
operator|->
name|pos
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stts_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stts_atom
operator|->
name|entries
argument_list|,
name|entries
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f1108
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|entries
name|u_char
name|entries
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_http_mp4_stss_atom_t
block|}
name|ngx_http_mp4_stss_atom_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_stss_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_stss_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_table
decl_stmt|,
modifier|*
name|atom_end
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
name|ngx_http_mp4_stss_atom_t
modifier|*
name|stss_atom
decl_stmt|;
comment|/* sync samples atom */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stss atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|stss_atom
operator|=
operator|(
name|ngx_http_mp4_stss_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|stss_atom
argument_list|,
literal|'s'
argument_list|,
literal|'t'
argument_list|,
literal|'s'
argument_list|,
literal|'s'
argument_list|)
expr_stmt|;
name|entries
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|stss_atom
operator|->
name|entries
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"sync sample entries:%uD"
argument_list|,
name|entries
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|trak
operator|->
name|sync_samples_entries
operator|=
name|entries
expr_stmt|;
name|atom_table
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_http_mp4_stss_atom_t
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|stss_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_table
expr_stmt|;
name|atom_end
operator|=
name|atom_table
operator|+
name|entries
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint64_t
operator|)
operator|(
name|atom_end
operator|-
name|stss_atom
operator|->
name|version
operator|)
operator|>
name|atom_data_size
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 stss atom too large"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|data
operator|=
operator|&
name|trak
operator|->
name|stss_data_buf
expr_stmt|;
name|data
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|pos
operator|=
name|atom_table
expr_stmt|;
name|data
operator|->
name|last
operator|=
name|atom_end
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSS_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSS_DATA
index|]
operator|.
name|buf
operator|=
name|data
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_update_stss_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_stss_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|size_t
name|atom_size
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|,
name|sample
decl_stmt|,
name|start_sample
decl_stmt|,
modifier|*
name|entry
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_http_mp4_stss_atom_t
modifier|*
name|stss_atom
decl_stmt|;
comment|/*      * mdia.minf.stbl.stss updating requires trak->start_sample      * from mdia.minf.stbl.stts which depends on value from mdia.mdhd      * atom which may reside after mdia.minf      */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stss atom update"
argument_list|)
expr_stmt|;
name|data
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSS_DATA
index|]
operator|.
name|buf
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
comment|/* sync samples starts from 1 */
name|start_sample
operator|=
name|trak
operator|->
name|start_sample
operator|+
literal|1
expr_stmt|;
name|entries
operator|=
name|trak
operator|->
name|sync_samples_entries
expr_stmt|;
name|entry
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|->
name|pos
expr_stmt|;
name|end
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|->
name|last
expr_stmt|;
while|while
condition|(
name|entry
operator|<
name|end
condition|)
block|{
name|sample
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start:%uD, sync:%uD"
argument_list|,
name|start_sample
argument_list|,
name|sample
argument_list|)
expr_stmt|;
if|if
condition|(
name|sample
operator|>=
name|start_sample
condition|)
block|{
goto|goto
name|found
goto|;
block|}
name|entries
operator|--
expr_stmt|;
name|entry
operator|++
expr_stmt|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start sample is out of mp4 stss atom in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
name|found
label|:
name|data
operator|->
name|pos
operator|=
operator|(
name|u_char
operator|*
operator|)
name|entry
expr_stmt|;
name|start_sample
operator|=
name|trak
operator|->
name|start_sample
expr_stmt|;
while|while
condition|(
name|entry
operator|<
name|end
condition|)
block|{
name|sample
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|sample
operator|-=
name|start_sample
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|entry
argument_list|,
name|sample
argument_list|)
expr_stmt|;
name|entry
operator|++
expr_stmt|;
block|}
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_http_mp4_stss_atom_t
argument_list|)
operator|+
operator|(
name|data
operator|->
name|last
operator|-
name|data
operator|->
name|pos
operator|)
expr_stmt|;
name|trak
operator|->
name|size
operator|+=
name|atom_size
expr_stmt|;
name|atom
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSS_ATOM
index|]
operator|.
name|buf
expr_stmt|;
name|stss_atom
operator|=
operator|(
name|ngx_http_mp4_stss_atom_t
operator|*
operator|)
name|atom
operator|->
name|pos
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stss_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stss_atom
operator|->
name|entries
argument_list|,
name|entries
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f1208
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|entries
name|u_char
name|entries
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_ctts_atom_t
block|}
name|ngx_mp4_ctts_atom_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon29a3247f1308
typedef|typedef
struct|struct
block|{
DECL|member|count
name|u_char
name|count
index|[
literal|4
index|]
decl_stmt|;
DECL|member|offset
name|u_char
name|offset
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_ctts_entry_t
block|}
name|ngx_mp4_ctts_entry_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_ctts_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_ctts_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_table
decl_stmt|,
modifier|*
name|atom_end
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_mp4_ctts_atom_t
modifier|*
name|ctts_atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
comment|/* composition offsets atom */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 ctts atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|ctts_atom
operator|=
operator|(
name|ngx_mp4_ctts_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|ctts_atom
argument_list|,
literal|'c'
argument_list|,
literal|'t'
argument_list|,
literal|'t'
argument_list|,
literal|'s'
argument_list|)
expr_stmt|;
name|entries
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|ctts_atom
operator|->
name|entries
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"composition offset entries:%uD"
argument_list|,
name|entries
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|trak
operator|->
name|composition_offset_entries
operator|=
name|entries
expr_stmt|;
name|atom_table
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_ctts_atom_t
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|ctts_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_table
expr_stmt|;
name|atom_end
operator|=
name|atom_table
operator|+
name|entries
operator|*
sizeof|sizeof
argument_list|(
name|ngx_mp4_ctts_entry_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint64_t
operator|)
operator|(
name|atom_end
operator|-
name|ctts_atom
operator|->
name|version
operator|)
operator|>
name|atom_data_size
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 ctts atom too large"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|data
operator|=
operator|&
name|trak
operator|->
name|ctts_data_buf
expr_stmt|;
name|data
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|pos
operator|=
name|atom_table
expr_stmt|;
name|data
operator|->
name|last
operator|=
name|atom_end
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_CTTS_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_CTTS_DATA
index|]
operator|.
name|buf
operator|=
name|data
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_mp4_update_ctts_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_ctts_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|size_t
name|atom_size
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|,
name|count
decl_stmt|,
name|start_sample
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_mp4_ctts_atom_t
modifier|*
name|ctts_atom
decl_stmt|;
name|ngx_mp4_ctts_entry_t
modifier|*
name|entry
decl_stmt|,
modifier|*
name|end
decl_stmt|;
comment|/*      * mdia.minf.stbl.ctts updating requires trak->start_sample      * from mdia.minf.stbl.stts which depends on value from mdia.mdhd      * atom which may reside after mdia.minf      */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 ctts atom update"
argument_list|)
expr_stmt|;
name|data
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_CTTS_DATA
index|]
operator|.
name|buf
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
comment|/* sync samples starts from 1 */
name|start_sample
operator|=
name|trak
operator|->
name|start_sample
operator|+
literal|1
expr_stmt|;
name|entries
operator|=
name|trak
operator|->
name|composition_offset_entries
expr_stmt|;
name|entry
operator|=
operator|(
name|ngx_mp4_ctts_entry_t
operator|*
operator|)
name|data
operator|->
name|pos
expr_stmt|;
name|end
operator|=
operator|(
name|ngx_mp4_ctts_entry_t
operator|*
operator|)
name|data
operator|->
name|last
expr_stmt|;
while|while
condition|(
name|entry
operator|<
name|end
condition|)
block|{
name|count
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|count
argument_list|)
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start:%uD, count:%uD, offset:%uD"
argument_list|,
name|start_sample
argument_list|,
name|count
argument_list|,
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|offset
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|start_sample
operator|<=
name|count
condition|)
block|{
name|count
operator|-=
operator|(
name|start_sample
operator|-
literal|1
operator|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|entry
operator|->
name|count
argument_list|,
name|count
argument_list|)
expr_stmt|;
goto|goto
name|found
goto|;
block|}
name|start_sample
operator|-=
name|count
expr_stmt|;
name|entries
operator|--
expr_stmt|;
name|entry
operator|++
expr_stmt|;
block|}
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_CTTS_ATOM
index|]
operator|.
name|buf
operator|=
name|NULL
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_CTTS_DATA
index|]
operator|.
name|buf
operator|=
name|NULL
expr_stmt|;
return|return;
name|found
label|:
name|data
operator|->
name|pos
operator|=
operator|(
name|u_char
operator|*
operator|)
name|entry
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_ctts_atom_t
argument_list|)
operator|+
operator|(
name|data
operator|->
name|last
operator|-
name|data
operator|->
name|pos
operator|)
expr_stmt|;
name|trak
operator|->
name|size
operator|+=
name|atom_size
expr_stmt|;
name|atom
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_CTTS_ATOM
index|]
operator|.
name|buf
expr_stmt|;
name|ctts_atom
operator|=
operator|(
name|ngx_mp4_ctts_atom_t
operator|*
operator|)
name|atom
operator|->
name|pos
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|ctts_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|ctts_atom
operator|->
name|entries
argument_list|,
name|entries
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f1408
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|entries
name|u_char
name|entries
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_stsc_atom_t
block|}
name|ngx_mp4_stsc_atom_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_stsc_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_stsc_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_table
decl_stmt|,
modifier|*
name|atom_end
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_mp4_stsc_atom_t
modifier|*
name|stsc_atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
comment|/* sample-to-chunk atom */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stsc atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|stsc_atom
operator|=
operator|(
name|ngx_mp4_stsc_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|stsc_atom
argument_list|,
literal|'s'
argument_list|,
literal|'t'
argument_list|,
literal|'s'
argument_list|,
literal|'c'
argument_list|)
expr_stmt|;
name|entries
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|stsc_atom
operator|->
name|entries
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"sample-to-chunk entries:%uD"
argument_list|,
name|entries
argument_list|)
expr_stmt|;
name|atom_table
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_stsc_atom_t
argument_list|)
expr_stmt|;
name|atom_end
operator|=
name|atom_table
operator|+
name|entries
operator|*
sizeof|sizeof
argument_list|(
name|ngx_mp4_stsc_entry_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint64_t
operator|)
operator|(
name|atom_end
operator|-
name|stsc_atom
operator|->
name|version
operator|)
operator|>
name|atom_data_size
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 stsc atom too large"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|trak
operator|->
name|sample_to_chunk_entries
operator|=
name|entries
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|stsc_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_table
expr_stmt|;
name|data
operator|=
operator|&
name|trak
operator|->
name|stsc_data_buf
expr_stmt|;
name|data
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|pos
operator|=
name|atom_table
expr_stmt|;
name|data
operator|->
name|last
operator|=
name|atom_end
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSC_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSC_DATA
index|]
operator|.
name|buf
operator|=
name|data
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_update_stsc_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_stsc_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|size_t
name|atom_size
decl_stmt|;
name|uint32_t
name|start_sample
decl_stmt|,
name|entries
decl_stmt|,
name|chunk
decl_stmt|,
name|samples
decl_stmt|,
name|id
decl_stmt|,
name|next_chunk
decl_stmt|,
name|n
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|ngx_mp4_stsc_atom_t
modifier|*
name|stsc_atom
decl_stmt|;
name|ngx_mp4_stsc_entry_t
modifier|*
name|entry
decl_stmt|,
modifier|*
name|first
decl_stmt|,
modifier|*
name|end
decl_stmt|;
comment|/*      * mdia.minf.stbl.stsc updating requires trak->start_sample      * from mdia.minf.stbl.stts which depends on value from mdia.mdhd      * atom which may reside after mdia.minf      */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stsc atom update"
argument_list|)
expr_stmt|;
name|data
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSC_DATA
index|]
operator|.
name|buf
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"no mp4 stsc atoms were found in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|start_sample
operator|=
operator|(
name|uint32_t
operator|)
name|trak
operator|->
name|start_sample
expr_stmt|;
name|entries
operator|=
name|trak
operator|->
name|sample_to_chunk_entries
operator|-
literal|1
expr_stmt|;
name|entry
operator|=
operator|(
name|ngx_mp4_stsc_entry_t
operator|*
operator|)
name|data
operator|->
name|pos
expr_stmt|;
name|end
operator|=
operator|(
name|ngx_mp4_stsc_entry_t
operator|*
operator|)
name|data
operator|->
name|last
expr_stmt|;
name|chunk
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|chunk
argument_list|)
expr_stmt|;
name|samples
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|samples
argument_list|)
expr_stmt|;
name|id
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|id
argument_list|)
expr_stmt|;
name|entry
operator|++
expr_stmt|;
while|while
condition|(
name|entry
operator|<
name|end
condition|)
block|{
name|next_chunk
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|chunk
argument_list|)
expr_stmt|;
name|ngx_log_debug5
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start_sample:%uD, chunk:%uD, chunks:%uD, "
literal|"samples:%uD, id:%uD"
argument_list|,
name|start_sample
argument_list|,
name|chunk
argument_list|,
name|next_chunk
operator|-
name|chunk
argument_list|,
name|samples
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|next_chunk
operator|-
name|chunk
operator|)
operator|*
name|samples
expr_stmt|;
if|if
condition|(
name|start_sample
operator|<=
name|n
condition|)
block|{
goto|goto
name|found
goto|;
block|}
name|start_sample
operator|-=
name|n
expr_stmt|;
name|chunk
operator|=
name|next_chunk
expr_stmt|;
name|samples
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|samples
argument_list|)
expr_stmt|;
name|id
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|id
argument_list|)
expr_stmt|;
name|entries
operator|--
expr_stmt|;
name|entry
operator|++
expr_stmt|;
block|}
name|next_chunk
operator|=
name|trak
operator|->
name|chunks
expr_stmt|;
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start_sample:%uD, chunk:%uD, chunks:%uD, samples:%uD"
argument_list|,
name|start_sample
argument_list|,
name|chunk
argument_list|,
name|next_chunk
operator|-
name|chunk
argument_list|,
name|samples
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|next_chunk
operator|-
name|chunk
operator|)
operator|*
name|samples
expr_stmt|;
if|if
condition|(
name|start_sample
operator|>
name|n
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start time is out mp4 stsc chunks in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|found
label|:
name|entries
operator|++
expr_stmt|;
name|entry
operator|--
expr_stmt|;
if|if
condition|(
name|samples
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"zero number of samples in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|trak
operator|->
name|start_chunk
operator|=
name|chunk
operator|-
literal|1
expr_stmt|;
name|trak
operator|->
name|start_chunk
operator|+=
name|start_sample
operator|/
name|samples
expr_stmt|;
name|trak
operator|->
name|chunk_samples
operator|=
name|start_sample
operator|%
name|samples
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start chunk:%ui, samples:%uD"
argument_list|,
name|trak
operator|->
name|start_chunk
argument_list|,
name|trak
operator|->
name|chunk_samples
argument_list|)
expr_stmt|;
name|data
operator|->
name|pos
operator|=
operator|(
name|u_char
operator|*
operator|)
name|entry
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_stsc_atom_t
argument_list|)
operator|+
operator|(
name|data
operator|->
name|last
operator|-
name|data
operator|->
name|pos
operator|)
expr_stmt|;
if|if
condition|(
name|trak
operator|->
name|chunk_samples
condition|)
block|{
name|first
operator|=
operator|&
name|trak
operator|->
name|stsc_chunk_entry
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|first
operator|->
name|chunk
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|first
operator|->
name|samples
argument_list|,
name|samples
operator|-
name|trak
operator|->
name|chunk_samples
argument_list|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|first
operator|->
name|id
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|buf
operator|=
operator|&
name|trak
operator|->
name|stsc_chunk_buf
expr_stmt|;
name|buf
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|pos
operator|=
operator|(
name|u_char
operator|*
operator|)
name|first
expr_stmt|;
name|buf
operator|->
name|last
operator|=
operator|(
name|u_char
operator|*
operator|)
name|first
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_stsc_entry_t
argument_list|)
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSC_CHUNK
index|]
operator|.
name|buf
operator|=
name|buf
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|entry
operator|->
name|chunk
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|atom_size
operator|+=
sizeof|sizeof
argument_list|(
name|ngx_mp4_stsc_entry_t
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|++
name|entry
operator|<
name|end
condition|)
block|{
name|chunk
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
operator|->
name|chunk
argument_list|)
expr_stmt|;
name|chunk
operator|-=
name|trak
operator|->
name|start_chunk
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|entry
operator|->
name|chunk
argument_list|,
name|chunk
argument_list|)
expr_stmt|;
block|}
name|trak
operator|->
name|size
operator|+=
name|atom_size
expr_stmt|;
name|atom
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSC_ATOM
index|]
operator|.
name|buf
expr_stmt|;
name|stsc_atom
operator|=
operator|(
name|ngx_mp4_stsc_atom_t
operator|*
operator|)
name|atom
operator|->
name|pos
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stsc_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stsc_atom
operator|->
name|entries
argument_list|,
name|entries
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f1508
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|uniform_size
name|u_char
name|uniform_size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|entries
name|u_char
name|entries
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_stsz_atom_t
block|}
name|ngx_mp4_stsz_atom_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_stsz_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_stsz_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_table
decl_stmt|,
modifier|*
name|atom_end
decl_stmt|;
name|size_t
name|atom_size
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|,
name|size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_mp4_stsz_atom_t
modifier|*
name|stsz_atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
comment|/* sample sizes atom */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stsz atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|stsz_atom
operator|=
operator|(
name|ngx_mp4_stsz_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|stsz_atom
argument_list|,
literal|'s'
argument_list|,
literal|'t'
argument_list|,
literal|'s'
argument_list|,
literal|'z'
argument_list|)
expr_stmt|;
name|size
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|stsz_atom
operator|->
name|uniform_size
argument_list|)
expr_stmt|;
name|entries
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|stsz_atom
operator|->
name|entries
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"sample uniform size:%uD, entries:%uD"
argument_list|,
name|size
argument_list|,
name|entries
argument_list|)
expr_stmt|;
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|trak
operator|->
name|sample_sizes_entries
operator|=
name|entries
expr_stmt|;
name|atom_table
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_stsz_atom_t
argument_list|)
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|stsz_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_table
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSZ_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
name|atom_end
operator|=
name|atom_table
operator|+
name|entries
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint64_t
operator|)
operator|(
name|atom_end
operator|-
name|stsz_atom
operator|->
name|version
operator|)
operator|>
name|atom_data_size
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 stsz atom too large"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|data
operator|=
operator|&
name|trak
operator|->
name|stsz_data_buf
expr_stmt|;
name|data
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|pos
operator|=
name|atom_table
expr_stmt|;
name|data
operator|->
name|last
operator|=
name|atom_end
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSZ_DATA
index|]
operator|.
name|buf
operator|=
name|data
expr_stmt|;
block|}
else|else
block|{
comment|/* if size != 0 then all samples are the same size */
comment|/* TODO : chunk samples */
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_atom_header_t
argument_list|)
operator|+
operator|(
name|size_t
operator|)
name|atom_data_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|atom_header
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|trak
operator|->
name|size
operator|+=
name|atom_size
expr_stmt|;
block|}
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_mp4_update_stsz_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_stsz_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|size_t
name|atom_size
decl_stmt|;
name|uint32_t
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_mp4_stsz_atom_t
modifier|*
name|stsz_atom
decl_stmt|;
comment|/*      * mdia.minf.stbl.stsz updating requires trak->start_sample      * from mdia.minf.stbl.stts which depends on value from mdia.mdhd      * atom which may reside after mdia.minf      */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stsz atom update"
argument_list|)
expr_stmt|;
name|data
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSZ_DATA
index|]
operator|.
name|buf
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|data
operator|->
name|pos
operator|+=
name|trak
operator|->
name|start_sample
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|end
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|->
name|pos
expr_stmt|;
for|for
control|(
name|pos
operator|=
name|end
operator|-
name|trak
operator|->
name|chunk_samples
init|;
name|pos
operator|<
name|end
condition|;
name|pos
operator|++
control|)
block|{
name|trak
operator|->
name|chunk_samples_size
operator|+=
name|ngx_mp4_get_32value
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"chunk samples sizes:%uD"
argument_list|,
name|trak
operator|->
name|chunk_samples_size
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_stsz_atom_t
argument_list|)
operator|+
operator|(
name|data
operator|->
name|last
operator|-
name|data
operator|->
name|pos
operator|)
expr_stmt|;
name|trak
operator|->
name|size
operator|+=
name|atom_size
expr_stmt|;
name|atom
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STSZ_ATOM
index|]
operator|.
name|buf
expr_stmt|;
name|stsz_atom
operator|=
operator|(
name|ngx_mp4_stsz_atom_t
operator|*
operator|)
name|atom
operator|->
name|pos
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stsz_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stsz_atom
operator|->
name|entries
argument_list|,
name|trak
operator|->
name|sample_sizes_entries
operator|-
name|trak
operator|->
name|start_sample
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_typedef
DECL|struct|__anon29a3247f1608
typedef|typedef
struct|struct
block|{
DECL|member|size
name|u_char
name|size
index|[
literal|4
index|]
decl_stmt|;
DECL|member|name
name|u_char
name|name
index|[
literal|4
index|]
decl_stmt|;
DECL|member|version
name|u_char
name|version
index|[
literal|1
index|]
decl_stmt|;
DECL|member|flags
name|u_char
name|flags
index|[
literal|3
index|]
decl_stmt|;
DECL|member|entries
name|u_char
name|entries
index|[
literal|4
index|]
decl_stmt|;
DECL|typedef|ngx_mp4_stco_atom_t
block|}
name|ngx_mp4_stco_atom_t
typedef|;
end_typedef

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_read_stco_atom (ngx_http_mp4_file_t * mp4,uint64_t atom_data_size)
name|ngx_http_mp4_read_stco_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|uint64_t
name|atom_data_size
parameter_list|)
block|{
name|u_char
modifier|*
name|atom_header
decl_stmt|,
modifier|*
name|atom_table
decl_stmt|,
modifier|*
name|atom_end
decl_stmt|;
name|uint32_t
name|entries
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_mp4_stco_atom_t
modifier|*
name|stco_atom
decl_stmt|;
name|ngx_http_mp4_trak_t
modifier|*
name|trak
decl_stmt|;
comment|/* chunk offsets atom */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stco atom"
argument_list|)
expr_stmt|;
name|atom_header
operator|=
name|ngx_mp4_atom_header
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|stco_atom
operator|=
operator|(
name|ngx_mp4_stco_atom_t
operator|*
operator|)
name|atom_header
expr_stmt|;
name|ngx_mp4_set_atom_name
argument_list|(
name|stco_atom
argument_list|,
literal|'s'
argument_list|,
literal|'t'
argument_list|,
literal|'c'
argument_list|,
literal|'o'
argument_list|)
expr_stmt|;
name|entries
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|stco_atom
operator|->
name|entries
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"chunks:%uD"
argument_list|,
name|entries
argument_list|)
expr_stmt|;
name|atom_table
operator|=
name|atom_header
operator|+
sizeof|sizeof
argument_list|(
name|ngx_mp4_stco_atom_t
argument_list|)
expr_stmt|;
name|atom_end
operator|=
name|atom_table
operator|+
name|entries
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint64_t
operator|)
operator|(
name|atom_end
operator|-
name|stco_atom
operator|->
name|version
operator|)
operator|>
name|atom_data_size
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"\"%s\" mp4 stco atom too large"
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|trak
operator|=
name|ngx_mp4_last_trak
argument_list|(
name|mp4
argument_list|)
expr_stmt|;
name|trak
operator|->
name|chunks
operator|=
name|entries
expr_stmt|;
name|atom
operator|=
operator|&
name|trak
operator|->
name|tsco_atom_buf
expr_stmt|;
name|atom
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|atom
operator|->
name|pos
operator|=
name|atom_header
expr_stmt|;
name|atom
operator|->
name|last
operator|=
name|atom_table
expr_stmt|;
name|data
operator|=
operator|&
name|trak
operator|->
name|tsco_data_buf
expr_stmt|;
name|data
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|pos
operator|=
name|atom_table
expr_stmt|;
name|data
operator|->
name|last
operator|=
name|atom_end
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STCO_ATOM
index|]
operator|.
name|buf
operator|=
name|atom
expr_stmt|;
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STCO_DATA
index|]
operator|.
name|buf
operator|=
name|data
expr_stmt|;
name|ngx_mp4_atom_next
argument_list|(
name|mp4
argument_list|,
name|atom_data_size
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_mp4_update_stco_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak)
name|ngx_http_mp4_update_stco_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|)
block|{
name|size_t
name|atom_size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|atom
decl_stmt|,
modifier|*
name|data
decl_stmt|;
name|ngx_mp4_stco_atom_t
modifier|*
name|stco_atom
decl_stmt|;
comment|/*      * mdia.minf.stbl.stco updating requires trak->start_chunk      * from mdia.minf.stbl.stsc which depends on value from mdia.mdhd      * atom which may reside after mdia.minf      */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stco atom update"
argument_list|)
expr_stmt|;
name|data
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STCO_DATA
index|]
operator|.
name|buf
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"no mp4 stco atoms were found in \"%s\""
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|data
operator|->
name|pos
operator|+=
name|trak
operator|->
name|start_chunk
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|atom_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_mp4_stco_atom_t
argument_list|)
operator|+
operator|(
name|data
operator|->
name|last
operator|-
name|data
operator|->
name|pos
operator|)
expr_stmt|;
name|trak
operator|->
name|size
operator|+=
name|atom_size
expr_stmt|;
name|trak
operator|->
name|start_offset
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|data
operator|->
name|pos
argument_list|)
expr_stmt|;
name|trak
operator|->
name|start_offset
operator|+=
name|trak
operator|->
name|chunk_samples_size
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|data
operator|->
name|pos
argument_list|,
name|trak
operator|->
name|start_offset
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"start chunk offset:%uD"
argument_list|,
name|trak
operator|->
name|start_offset
argument_list|)
expr_stmt|;
name|atom
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STCO_ATOM
index|]
operator|.
name|buf
expr_stmt|;
name|stco_atom
operator|=
operator|(
name|ngx_mp4_stco_atom_t
operator|*
operator|)
name|atom
operator|->
name|pos
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stco_atom
operator|->
name|size
argument_list|,
name|atom_size
argument_list|)
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|stco_atom
operator|->
name|entries
argument_list|,
name|trak
operator|->
name|chunks
operator|-
name|trak
operator|->
name|start_chunk
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_mp4_adjust_stco_atom (ngx_http_mp4_file_t * mp4,ngx_http_mp4_trak_t * trak,int32_t adjustment)
name|ngx_http_mp4_adjust_stco_atom
parameter_list|(
name|ngx_http_mp4_file_t
modifier|*
name|mp4
parameter_list|,
name|ngx_http_mp4_trak_t
modifier|*
name|trak
parameter_list|,
name|int32_t
name|adjustment
parameter_list|)
block|{
name|uint32_t
name|offset
decl_stmt|,
modifier|*
name|entry
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|ngx_buf_t
modifier|*
name|data
decl_stmt|;
comment|/*      * moov.trak.mdia.minf.stbl.stco adjustment requires      * minimal start offset of all traks and new moov atom size      */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|mp4
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"mp4 stco atom adjustment"
argument_list|)
expr_stmt|;
name|data
operator|=
name|trak
operator|->
name|out
index|[
name|NGX_HTTP_MP4_STCO_DATA
index|]
operator|.
name|buf
expr_stmt|;
name|entry
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|->
name|pos
expr_stmt|;
name|end
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|data
operator|->
name|last
expr_stmt|;
while|while
condition|(
name|entry
operator|<
name|end
condition|)
block|{
name|offset
operator|=
name|ngx_mp4_get_32value
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|offset
operator|+=
name|adjustment
expr_stmt|;
name|ngx_mp4_set_32value
argument_list|(
name|entry
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|entry
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_mp4 (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_mp4
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|clcf
operator|=
name|ngx_http_conf_get_module_loc_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|clcf
operator|->
name|handler
operator|=
name|ngx_http_mp4_handler
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_mp4_create_conf (ngx_conf_t * cf)
name|ngx_http_mp4_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_mp4_conf_t
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_mp4_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|conf
operator|->
name|buffer_size
operator|=
name|NGX_CONF_UNSET_SIZE
expr_stmt|;
name|conf
operator|->
name|max_buffer_size
operator|=
name|NGX_CONF_UNSET_SIZE
expr_stmt|;
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_mp4_merge_conf (ngx_conf_t * cf,void * parent,void * child)
name|ngx_http_mp4_merge_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
block|{
name|ngx_http_mp4_conf_t
modifier|*
name|prev
init|=
name|parent
decl_stmt|;
name|ngx_http_mp4_conf_t
modifier|*
name|conf
init|=
name|child
decl_stmt|;
name|ngx_conf_merge_size_value
argument_list|(
name|conf
operator|->
name|buffer_size
argument_list|,
name|prev
operator|->
name|buffer_size
argument_list|,
literal|512
operator|*
literal|1024
argument_list|)
expr_stmt|;
name|ngx_conf_merge_size_value
argument_list|(
name|conf
operator|->
name|max_buffer_size
argument_list|,
name|prev
operator|->
name|max_buffer_size
argument_list|,
literal|10
operator|*
literal|1024
operator|*
literal|1024
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

end_unit

