begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  * Copyright (C) Nginx, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_include
include|#
directive|include
file|<GeoIP.h>
end_include

begin_include
include|#
directive|include
file|<GeoIPCity.h>
end_include

begin_define
DECL|macro|NGX_GEOIP_COUNTRY_CODE
define|#
directive|define
name|NGX_GEOIP_COUNTRY_CODE
value|0
end_define

begin_define
DECL|macro|NGX_GEOIP_COUNTRY_CODE3
define|#
directive|define
name|NGX_GEOIP_COUNTRY_CODE3
value|1
end_define

begin_define
DECL|macro|NGX_GEOIP_COUNTRY_NAME
define|#
directive|define
name|NGX_GEOIP_COUNTRY_NAME
value|2
end_define

begin_typedef
DECL|struct|__anon2892f16d0108
typedef|typedef
struct|struct
block|{
DECL|member|country
name|GeoIP
modifier|*
name|country
decl_stmt|;
DECL|member|org
name|GeoIP
modifier|*
name|org
decl_stmt|;
DECL|member|city
name|GeoIP
modifier|*
name|city
decl_stmt|;
DECL|member|proxies
name|ngx_array_t
modifier|*
name|proxies
decl_stmt|;
comment|/* array of ngx_cidr_t */
DECL|member|proxy_recursive
name|ngx_flag_t
name|proxy_recursive
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
DECL|member|country_v6
name|unsigned
name|country_v6
range|:
literal|1
decl_stmt|;
DECL|member|org_v6
name|unsigned
name|org_v6
range|:
literal|1
decl_stmt|;
DECL|member|city_v6
name|unsigned
name|city_v6
range|:
literal|1
decl_stmt|;
endif|#
directive|endif
DECL|typedef|ngx_http_geoip_conf_t
block|}
name|ngx_http_geoip_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2892f16d0208
typedef|typedef
struct|struct
block|{
DECL|member|name
name|ngx_str_t
modifier|*
name|name
decl_stmt|;
DECL|member|data
name|uintptr_t
name|data
decl_stmt|;
DECL|typedef|ngx_http_geoip_var_t
block|}
name|ngx_http_geoip_var_t
typedef|;
end_typedef

begin_typedef
DECL|typedef|ngx_http_geoip_variable_handler_pt
typedef|typedef
specifier|const
name|char
modifier|*
function_decl|(
modifier|*
name|ngx_http_geoip_variable_handler_pt
function_decl|)
parameter_list|(
name|GeoIP
modifier|*
parameter_list|,
name|u_long
name|addr
parameter_list|)
function_decl|;
end_typedef

begin_decl_stmt
DECL|variable|ngx_http_geoip_country_functions
name|ngx_http_geoip_variable_handler_pt
name|ngx_http_geoip_country_functions
index|[]
init|=
block|{
name|GeoIP_country_code_by_ipnum
block|,
name|GeoIP_country_code3_by_ipnum
block|,
name|GeoIP_country_name_by_ipnum
block|, }
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
end_if

begin_typedef
DECL|typedef|ngx_http_geoip_variable_handler_v6_pt
typedef|typedef
specifier|const
name|char
modifier|*
function_decl|(
modifier|*
name|ngx_http_geoip_variable_handler_v6_pt
function_decl|)
parameter_list|(
name|GeoIP
modifier|*
parameter_list|,
name|geoipv6_t
name|addr
parameter_list|)
function_decl|;
end_typedef

begin_decl_stmt
DECL|variable|ngx_http_geoip_country_v6_functions
name|ngx_http_geoip_variable_handler_v6_pt
name|ngx_http_geoip_country_v6_functions
index|[]
init|=
block|{
name|GeoIP_country_code_by_ipnum_v6
block|,
name|GeoIP_country_code3_by_ipnum_v6
block|,
name|GeoIP_country_name_by_ipnum_v6
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_geoip_country_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_geoip_org_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_geoip_city_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_geoip_region_name_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_geoip_city_float_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_geoip_city_int_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|GeoIPRecord
modifier|*
name|ngx_http_geoip_get_city_record
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_geoip_add_variables
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_geoip_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_geoip_init_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_geoip_country
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_geoip_org
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_geoip_city
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_geoip_proxy
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_geoip_cidr_value
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|net
parameter_list|,
name|ngx_cidr_t
modifier|*
name|cidr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_geoip_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_http_geoip_commands
specifier|static
name|ngx_command_t
name|ngx_http_geoip_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"geoip_country"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_TAKE12
block|,
name|ngx_http_geoip_country
block|,
name|NGX_HTTP_MAIN_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_org"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_TAKE12
block|,
name|ngx_http_geoip_org
block|,
name|NGX_HTTP_MAIN_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_city"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_TAKE12
block|,
name|ngx_http_geoip_city
block|,
name|NGX_HTTP_MAIN_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_proxy"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_TAKE1
block|,
name|ngx_http_geoip_proxy
block|,
name|NGX_HTTP_MAIN_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_proxy_recursive"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_CONF_FLAG
block|,
name|ngx_conf_set_flag_slot
block|,
name|NGX_HTTP_MAIN_CONF_OFFSET
block|,
name|offsetof
argument_list|(
name|ngx_http_geoip_conf_t
argument_list|,
name|proxy_recursive
argument_list|)
block|,
name|NULL
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_geoip_module_ctx
specifier|static
name|ngx_http_module_t
name|ngx_http_geoip_module_ctx
init|=
block|{
name|ngx_http_geoip_add_variables
block|,
comment|/* preconfiguration */
name|NULL
block|,
comment|/* postconfiguration */
name|ngx_http_geoip_create_conf
block|,
comment|/* create main configuration */
name|ngx_http_geoip_init_conf
block|,
comment|/* init main configuration */
name|NULL
block|,
comment|/* create server configuration */
name|NULL
block|,
comment|/* merge server configuration */
name|NULL
block|,
comment|/* create location configuration */
name|NULL
comment|/* merge location configuration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_geoip_module
name|ngx_module_t
name|ngx_http_geoip_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_http_geoip_module_ctx
block|,
comment|/* module context */
name|ngx_http_geoip_commands
block|,
comment|/* module directives */
name|NGX_HTTP_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|NULL
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|NULL
block|,
comment|/* exit process */
name|NULL
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_geoip_vars
specifier|static
name|ngx_http_variable_t
name|ngx_http_geoip_vars
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"geoip_country_code"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_country_variable
block|,
name|NGX_GEOIP_COUNTRY_CODE
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_country_code3"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_country_variable
block|,
name|NGX_GEOIP_COUNTRY_CODE3
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_country_name"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_country_variable
block|,
name|NGX_GEOIP_COUNTRY_NAME
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_org"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_org_variable
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_city_continent_code"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|continent_code
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_city_country_code"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|country_code
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_city_country_code3"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|country_code3
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_city_country_name"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|country_name
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_region"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|region
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_region_name"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_region_name_variable
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_city"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|city
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_postal_code"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|postal_code
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_latitude"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_float_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|latitude
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_longitude"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_float_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|longitude
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_dma_code"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_int_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|dma_code
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"geoip_area_code"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_geoip_city_int_variable
block|,
name|offsetof
argument_list|(
name|GeoIPRecord
argument_list|,
name|area_code
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_null_string
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|u_long
DECL|function|ngx_http_geoip_addr (ngx_http_request_t * r,ngx_http_geoip_conf_t * gcf)
name|ngx_http_geoip_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
parameter_list|)
block|{
name|ngx_addr_t
name|addr
decl_stmt|;
name|ngx_array_t
modifier|*
name|xfwd
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|addr
operator|.
name|sockaddr
operator|=
name|r
operator|->
name|connection
operator|->
name|sockaddr
expr_stmt|;
name|addr
operator|.
name|socklen
operator|=
name|r
operator|->
name|connection
operator|->
name|socklen
expr_stmt|;
comment|/* addr.name = r->connection->addr_text; */
name|xfwd
operator|=
operator|&
name|r
operator|->
name|headers_in
operator|.
name|x_forwarded_for
expr_stmt|;
if|if
condition|(
name|xfwd
operator|->
name|nelts
operator|>
literal|0
operator|&&
name|gcf
operator|->
name|proxies
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_http_get_forwarded_addr
argument_list|(
name|r
argument_list|,
operator|&
name|addr
argument_list|,
name|xfwd
argument_list|,
name|NULL
argument_list|,
name|gcf
operator|->
name|proxies
argument_list|,
name|gcf
operator|->
name|proxy_recursive
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
operator|(
name|NGX_HAVE_INET6
operator|)
if|if
condition|(
name|addr
operator|.
name|sockaddr
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|in_addr_t
name|inaddr
decl_stmt|;
name|struct
name|in6_addr
modifier|*
name|inaddr6
decl_stmt|;
name|inaddr6
operator|=
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|addr
operator|.
name|sockaddr
operator|)
operator|->
name|sin6_addr
expr_stmt|;
if|if
condition|(
name|IN6_IS_ADDR_V4MAPPED
argument_list|(
name|inaddr6
argument_list|)
condition|)
block|{
name|p
operator|=
name|inaddr6
operator|->
name|s6_addr
expr_stmt|;
name|inaddr
operator|=
name|p
index|[
literal|12
index|]
operator|<<
literal|24
expr_stmt|;
name|inaddr
operator|+=
name|p
index|[
literal|13
index|]
operator|<<
literal|16
expr_stmt|;
name|inaddr
operator|+=
name|p
index|[
literal|14
index|]
operator|<<
literal|8
expr_stmt|;
name|inaddr
operator|+=
name|p
index|[
literal|15
index|]
expr_stmt|;
return|return
name|inaddr
return|;
block|}
block|}
endif|#
directive|endif
if|if
condition|(
name|addr
operator|.
name|sockaddr
operator|->
name|sa_family
operator|!=
name|AF_INET
condition|)
block|{
return|return
name|INADDR_NONE
return|;
block|}
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
operator|.
name|sockaddr
expr_stmt|;
return|return
name|ntohl
argument_list|(
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
end_if

begin_function
specifier|static
name|geoipv6_t
DECL|function|ngx_http_geoip_addr_v6 (ngx_http_request_t * r,ngx_http_geoip_conf_t * gcf)
name|ngx_http_geoip_addr_v6
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
parameter_list|)
block|{
name|ngx_addr_t
name|addr
decl_stmt|;
name|ngx_array_t
modifier|*
name|xfwd
decl_stmt|;
name|in_addr_t
name|addr4
decl_stmt|;
name|struct
name|in6_addr
name|addr6
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|addr
operator|.
name|sockaddr
operator|=
name|r
operator|->
name|connection
operator|->
name|sockaddr
expr_stmt|;
name|addr
operator|.
name|socklen
operator|=
name|r
operator|->
name|connection
operator|->
name|socklen
expr_stmt|;
comment|/* addr.name = r->connection->addr_text; */
name|xfwd
operator|=
operator|&
name|r
operator|->
name|headers_in
operator|.
name|x_forwarded_for
expr_stmt|;
if|if
condition|(
name|xfwd
operator|->
name|nelts
operator|>
literal|0
operator|&&
name|gcf
operator|->
name|proxies
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_http_get_forwarded_addr
argument_list|(
name|r
argument_list|,
operator|&
name|addr
argument_list|,
name|xfwd
argument_list|,
name|NULL
argument_list|,
name|gcf
operator|->
name|proxies
argument_list|,
name|gcf
operator|->
name|proxy_recursive
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|addr
operator|.
name|sockaddr
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
comment|/* Produce IPv4-mapped IPv6 address. */
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|addr
operator|.
name|sockaddr
expr_stmt|;
name|addr4
operator|=
name|ntohl
argument_list|(
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|addr6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr6
operator|.
name|s6_addr
index|[
literal|10
index|]
operator|=
literal|0xff
expr_stmt|;
name|addr6
operator|.
name|s6_addr
index|[
literal|11
index|]
operator|=
literal|0xff
expr_stmt|;
name|addr6
operator|.
name|s6_addr
index|[
literal|12
index|]
operator|=
name|addr4
operator|>>
literal|24
expr_stmt|;
name|addr6
operator|.
name|s6_addr
index|[
literal|13
index|]
operator|=
name|addr4
operator|>>
literal|16
expr_stmt|;
name|addr6
operator|.
name|s6_addr
index|[
literal|14
index|]
operator|=
name|addr4
operator|>>
literal|8
expr_stmt|;
name|addr6
operator|.
name|s6_addr
index|[
literal|15
index|]
operator|=
name|addr4
expr_stmt|;
return|return
name|addr6
return|;
case|case
name|AF_INET6
case|:
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|addr
operator|.
name|sockaddr
expr_stmt|;
return|return
name|sin6
operator|->
name|sin6_addr
return|;
default|default:
return|return
name|in6addr_any
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_geoip_country_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_geoip_country_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_geoip_variable_handler_pt
name|handler
init|=
name|ngx_http_geoip_country_functions
index|[
name|data
index|]
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
name|ngx_http_geoip_variable_handler_v6_pt
name|handler_v6
init|=
name|ngx_http_geoip_country_v6_functions
index|[
name|data
index|]
decl_stmt|;
endif|#
directive|endif
specifier|const
name|char
modifier|*
name|val
decl_stmt|;
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
decl_stmt|;
name|gcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_geoip_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcf
operator|->
name|country
operator|==
name|NULL
condition|)
block|{
goto|goto
name|not_found
goto|;
block|}
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
name|val
operator|=
name|gcf
operator|->
name|country_v6
condition|?
name|handler_v6
argument_list|(
name|gcf
operator|->
name|country
argument_list|,
name|ngx_http_geoip_addr_v6
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
else|:
name|handler
argument_list|(
name|gcf
operator|->
name|country
argument_list|,
name|ngx_http_geoip_addr
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|val
operator|=
name|handler
argument_list|(
name|gcf
operator|->
name|country
argument_list|,
name|ngx_http_geoip_addr
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
block|{
goto|goto
name|not_found
goto|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_strlen
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
name|val
expr_stmt|;
return|return
name|NGX_OK
return|;
name|not_found
label|:
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_geoip_org_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_geoip_org_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
decl_stmt|;
name|gcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_geoip_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcf
operator|->
name|org
operator|==
name|NULL
condition|)
block|{
goto|goto
name|not_found
goto|;
block|}
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
name|val
operator|=
name|gcf
operator|->
name|org_v6
condition|?
name|GeoIP_name_by_ipnum_v6
argument_list|(
name|gcf
operator|->
name|org
argument_list|,
name|ngx_http_geoip_addr_v6
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
else|:
name|GeoIP_name_by_ipnum
argument_list|(
name|gcf
operator|->
name|org
argument_list|,
name|ngx_http_geoip_addr
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|val
operator|=
name|GeoIP_name_by_ipnum
argument_list|(
name|gcf
operator|->
name|org
argument_list|,
name|ngx_http_geoip_addr
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
block|{
goto|goto
name|not_found
goto|;
block|}
name|len
operator|=
name|ngx_strlen
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|ngx_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|v
operator|->
name|data
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|ngx_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
name|not_found
label|:
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_geoip_city_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_geoip_city_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|char
modifier|*
name|val
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|GeoIPRecord
modifier|*
name|gr
decl_stmt|;
name|gr
operator|=
name|ngx_http_geoip_get_city_record
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|gr
operator|==
name|NULL
condition|)
block|{
goto|goto
name|not_found
goto|;
block|}
name|val
operator|=
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|gr
operator|+
name|data
operator|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
block|{
goto|goto
name|no_value
goto|;
block|}
name|len
operator|=
name|ngx_strlen
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|GeoIPRecord_delete
argument_list|(
name|gr
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|v
operator|->
name|data
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|GeoIPRecord_delete
argument_list|(
name|gr
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
name|no_value
label|:
name|GeoIPRecord_delete
argument_list|(
name|gr
argument_list|)
expr_stmt|;
name|not_found
label|:
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_geoip_region_name_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_geoip_region_name_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|val
decl_stmt|;
name|GeoIPRecord
modifier|*
name|gr
decl_stmt|;
name|gr
operator|=
name|ngx_http_geoip_get_city_record
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|gr
operator|==
name|NULL
condition|)
block|{
goto|goto
name|not_found
goto|;
block|}
name|val
operator|=
name|GeoIP_region_name_by_code
argument_list|(
name|gr
operator|->
name|country_code
argument_list|,
name|gr
operator|->
name|region
argument_list|)
expr_stmt|;
name|GeoIPRecord_delete
argument_list|(
name|gr
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
block|{
goto|goto
name|not_found
goto|;
block|}
name|len
operator|=
name|ngx_strlen
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|v
operator|->
name|data
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
name|not_found
label|:
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_geoip_city_float_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_geoip_city_float_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|float
name|val
decl_stmt|;
name|GeoIPRecord
modifier|*
name|gr
decl_stmt|;
name|gr
operator|=
name|ngx_http_geoip_get_city_record
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|gr
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_INT64_LEN
operator|+
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|GeoIPRecord_delete
argument_list|(
name|gr
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|val
operator|=
operator|*
operator|(
name|float
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|gr
operator|+
name|data
operator|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%.4f"
argument_list|,
name|val
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
name|GeoIPRecord_delete
argument_list|(
name|gr
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_geoip_city_int_variable (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_geoip_city_int_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|int
name|val
decl_stmt|;
name|GeoIPRecord
modifier|*
name|gr
decl_stmt|;
name|gr
operator|=
name|ngx_http_geoip_get_city_record
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|gr
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_INT64_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|GeoIPRecord_delete
argument_list|(
name|gr
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|val
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|gr
operator|+
name|data
operator|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%d"
argument_list|,
name|val
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
name|GeoIPRecord_delete
argument_list|(
name|gr
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|GeoIPRecord
modifier|*
DECL|function|ngx_http_geoip_get_city_record (ngx_http_request_t * r)
name|ngx_http_geoip_get_city_record
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
decl_stmt|;
name|gcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_geoip_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcf
operator|->
name|city
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
return|return
name|gcf
operator|->
name|city_v6
condition|?
name|GeoIP_record_by_ipnum_v6
argument_list|(
name|gcf
operator|->
name|city
argument_list|,
name|ngx_http_geoip_addr_v6
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
else|:
name|GeoIP_record_by_ipnum
argument_list|(
name|gcf
operator|->
name|city
argument_list|,
name|ngx_http_geoip_addr
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
return|;
else|#
directive|else
return|return
name|GeoIP_record_by_ipnum
argument_list|(
name|gcf
operator|->
name|city
argument_list|,
name|ngx_http_geoip_addr
argument_list|(
name|r
argument_list|,
name|gcf
argument_list|)
argument_list|)
return|;
endif|#
directive|endif
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_geoip_add_variables (ngx_conf_t * cf)
name|ngx_http_geoip_add_variables
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_variable_t
modifier|*
name|var
decl_stmt|,
modifier|*
name|v
decl_stmt|;
for|for
control|(
name|v
operator|=
name|ngx_http_geoip_vars
init|;
name|v
operator|->
name|name
operator|.
name|len
condition|;
name|v
operator|++
control|)
block|{
name|var
operator|=
name|ngx_http_add_variable
argument_list|(
name|cf
argument_list|,
operator|&
name|v
operator|->
name|name
argument_list|,
name|v
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|var
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|var
operator|->
name|get_handler
operator|=
name|v
operator|->
name|get_handler
expr_stmt|;
name|var
operator|->
name|data
operator|=
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_geoip_create_conf (ngx_conf_t * cf)
name|ngx_http_geoip_create_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ngx_http_geoip_conf_t
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_geoip_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|conf
operator|->
name|proxy_recursive
operator|=
name|NGX_CONF_UNSET
expr_stmt|;
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_geoip_cleanup
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|conf
expr_stmt|;
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_geoip_init_conf (ngx_conf_t * cf,void * conf)
name|ngx_http_geoip_init_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
init|=
name|conf
decl_stmt|;
name|ngx_conf_init_value
argument_list|(
name|gcf
operator|->
name|proxy_recursive
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_geoip_country (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_geoip_country
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|gcf
operator|->
name|country
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|gcf
operator|->
name|country
operator|=
name|GeoIP_open
argument_list|(
operator|(
name|char
operator|*
operator|)
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
name|GEOIP_MEMORY_CACHE
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcf
operator|->
name|country
operator|==
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"GeoIP_open(\"%V\") failed"
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|cf
operator|->
name|args
operator|->
name|nelts
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|value
index|[
literal|2
index|]
operator|.
name|data
argument_list|,
literal|"utf8"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|GeoIP_set_charset
argument_list|(
name|gcf
operator|->
name|country
argument_list|,
name|GEOIP_CHARSET_UTF8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
switch|switch
condition|(
name|gcf
operator|->
name|country
operator|->
name|databaseType
condition|)
block|{
case|case
name|GEOIP_COUNTRY_EDITION
case|:
return|return
name|NGX_CONF_OK
return|;
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
case|case
name|GEOIP_COUNTRY_EDITION_V6
case|:
name|gcf
operator|->
name|country_v6
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
endif|#
directive|endif
default|default:
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid GeoIP database \"%V\" type:%d"
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|,
name|gcf
operator|->
name|country
operator|->
name|databaseType
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_geoip_org (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_geoip_org
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|gcf
operator|->
name|org
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|gcf
operator|->
name|org
operator|=
name|GeoIP_open
argument_list|(
operator|(
name|char
operator|*
operator|)
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
name|GEOIP_MEMORY_CACHE
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcf
operator|->
name|org
operator|==
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"GeoIP_open(\"%V\") failed"
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|cf
operator|->
name|args
operator|->
name|nelts
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|value
index|[
literal|2
index|]
operator|.
name|data
argument_list|,
literal|"utf8"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|GeoIP_set_charset
argument_list|(
name|gcf
operator|->
name|org
argument_list|,
name|GEOIP_CHARSET_UTF8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
switch|switch
condition|(
name|gcf
operator|->
name|org
operator|->
name|databaseType
condition|)
block|{
case|case
name|GEOIP_ISP_EDITION
case|:
case|case
name|GEOIP_ORG_EDITION
case|:
case|case
name|GEOIP_DOMAIN_EDITION
case|:
case|case
name|GEOIP_ASNUM_EDITION
case|:
return|return
name|NGX_CONF_OK
return|;
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
case|case
name|GEOIP_ISP_EDITION_V6
case|:
case|case
name|GEOIP_ORG_EDITION_V6
case|:
case|case
name|GEOIP_DOMAIN_EDITION_V6
case|:
case|case
name|GEOIP_ASNUM_EDITION_V6
case|:
name|gcf
operator|->
name|org_v6
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
endif|#
directive|endif
default|default:
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid GeoIP database \"%V\" type:%d"
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|,
name|gcf
operator|->
name|org
operator|->
name|databaseType
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_geoip_city (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_geoip_city
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
if|if
condition|(
name|gcf
operator|->
name|city
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|gcf
operator|->
name|city
operator|=
name|GeoIP_open
argument_list|(
operator|(
name|char
operator|*
operator|)
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
name|GEOIP_MEMORY_CACHE
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcf
operator|->
name|city
operator|==
name|NULL
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"GeoIP_open(\"%V\") failed"
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|cf
operator|->
name|args
operator|->
name|nelts
operator|==
literal|3
condition|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|value
index|[
literal|2
index|]
operator|.
name|data
argument_list|,
literal|"utf8"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|GeoIP_set_charset
argument_list|(
name|gcf
operator|->
name|city
argument_list|,
name|GEOIP_CHARSET_UTF8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
switch|switch
condition|(
name|gcf
operator|->
name|city
operator|->
name|databaseType
condition|)
block|{
case|case
name|GEOIP_CITY_EDITION_REV0
case|:
case|case
name|GEOIP_CITY_EDITION_REV1
case|:
return|return
name|NGX_CONF_OK
return|;
if|#
directive|if
operator|(
name|NGX_HAVE_GEOIP_V6
operator|)
case|case
name|GEOIP_CITY_EDITION_REV0_V6
case|:
case|case
name|GEOIP_CITY_EDITION_REV1_V6
case|:
name|gcf
operator|->
name|city_v6
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
endif|#
directive|endif
default|default:
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid GeoIP City database \"%V\" type:%d"
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|,
name|gcf
operator|->
name|city
operator|->
name|databaseType
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_geoip_proxy (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_geoip_proxy
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_cidr_t
name|cidr
decl_stmt|,
modifier|*
name|c
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
if|if
condition|(
name|ngx_http_geoip_cidr_value
argument_list|(
name|cf
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|,
operator|&
name|cidr
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|gcf
operator|->
name|proxies
operator|==
name|NULL
condition|)
block|{
name|gcf
operator|->
name|proxies
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_cidr_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gcf
operator|->
name|proxies
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|c
operator|=
name|ngx_array_push
argument_list|(
name|gcf
operator|->
name|proxies
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
operator|*
name|c
operator|=
name|cidr
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_geoip_cidr_value (ngx_conf_t * cf,ngx_str_t * net,ngx_cidr_t * cidr)
name|ngx_http_geoip_cidr_value
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|net
parameter_list|,
name|ngx_cidr_t
modifier|*
name|cidr
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|net
operator|->
name|data
argument_list|,
literal|"255.255.255.255"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cidr
operator|->
name|family
operator|=
name|AF_INET
expr_stmt|;
name|cidr
operator|->
name|u
operator|.
name|in
operator|.
name|addr
operator|=
literal|0xffffffff
expr_stmt|;
name|cidr
operator|->
name|u
operator|.
name|in
operator|.
name|mask
operator|=
literal|0xffffffff
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|rc
operator|=
name|ngx_ptocidr
argument_list|(
name|net
argument_list|,
name|cidr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid network \"%V\""
argument_list|,
name|net
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_DONE
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"low address bits of %V are meaningless"
argument_list|,
name|net
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_geoip_cleanup (void * data)
name|ngx_http_geoip_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_geoip_conf_t
modifier|*
name|gcf
init|=
name|data
decl_stmt|;
if|if
condition|(
name|gcf
operator|->
name|country
condition|)
block|{
name|GeoIP_delete
argument_list|(
name|gcf
operator|->
name|country
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gcf
operator|->
name|org
condition|)
block|{
name|GeoIP_delete
argument_list|(
name|gcf
operator|->
name|org
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|gcf
operator|->
name|city
condition|)
block|{
name|GeoIP_delete
argument_list|(
name|gcf
operator|->
name|city
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit

