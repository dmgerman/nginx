begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_include
include|#
directive|include
file|<nginx.h>
end_include

begin_typedef
DECL|typedef|ngx_http_log_op_t
typedef|typedef
name|struct
name|ngx_http_log_op_s
name|ngx_http_log_op_t
typedef|;
end_typedef

begin_typedef
DECL|typedef|ngx_http_log_op_run_pt
typedef|typedef
name|u_char
modifier|*
function_decl|(
modifier|*
name|ngx_http_log_op_run_pt
function_decl|)
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_typedef

begin_typedef
DECL|typedef|ngx_http_log_op_getlen_pt
typedef|typedef
name|size_t
function_decl|(
modifier|*
name|ngx_http_log_op_getlen_pt
function_decl|)
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_typedef

begin_struct
DECL|struct|ngx_http_log_op_s
struct|struct
name|ngx_http_log_op_s
block|{
DECL|member|len
name|size_t
name|len
decl_stmt|;
DECL|member|getlen
name|ngx_http_log_op_getlen_pt
name|getlen
decl_stmt|;
DECL|member|run
name|ngx_http_log_op_run_pt
name|run
decl_stmt|;
DECL|member|data
name|uintptr_t
name|data
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
DECL|struct|__anon2c123cf20108
typedef|typedef
struct|struct
block|{
DECL|member|name
name|ngx_str_t
name|name
decl_stmt|;
DECL|member|ops
name|ngx_array_t
modifier|*
name|ops
decl_stmt|;
comment|/* array of ngx_http_log_op_t */
DECL|typedef|ngx_http_log_fmt_t
block|}
name|ngx_http_log_fmt_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c123cf20208
typedef|typedef
struct|struct
block|{
DECL|member|formats
name|ngx_array_t
name|formats
decl_stmt|;
comment|/* array of ngx_http_log_fmt_t */
DECL|member|combined_used
name|ngx_uint_t
name|combined_used
decl_stmt|;
comment|/* unsigned  combined_used:1 */
DECL|typedef|ngx_http_log_main_conf_t
block|}
name|ngx_http_log_main_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c123cf20308
typedef|typedef
struct|struct
block|{
DECL|member|lengths
name|ngx_array_t
modifier|*
name|lengths
decl_stmt|;
DECL|member|values
name|ngx_array_t
modifier|*
name|values
decl_stmt|;
DECL|typedef|ngx_http_log_script_t
block|}
name|ngx_http_log_script_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c123cf20408
typedef|typedef
struct|struct
block|{
DECL|member|file
name|ngx_open_file_t
modifier|*
name|file
decl_stmt|;
DECL|member|script
name|ngx_http_log_script_t
modifier|*
name|script
decl_stmt|;
DECL|member|disk_full_time
name|time_t
name|disk_full_time
decl_stmt|;
DECL|member|error_log_time
name|time_t
name|error_log_time
decl_stmt|;
DECL|member|ops
name|ngx_array_t
modifier|*
name|ops
decl_stmt|;
comment|/* array of ngx_http_log_op_t */
DECL|typedef|ngx_http_log_t
block|}
name|ngx_http_log_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c123cf20508
typedef|typedef
struct|struct
block|{
DECL|member|logs
name|ngx_array_t
modifier|*
name|logs
decl_stmt|;
comment|/* array of ngx_http_log_t */
DECL|member|open_file_cache
name|ngx_open_file_cache_t
modifier|*
name|open_file_cache
decl_stmt|;
DECL|member|open_file_cache_valid
name|time_t
name|open_file_cache_valid
decl_stmt|;
DECL|member|open_file_cache_min_uses
name|ngx_uint_t
name|open_file_cache_min_uses
decl_stmt|;
DECL|member|off
name|ngx_uint_t
name|off
decl_stmt|;
comment|/* unsigned  off:1 */
DECL|typedef|ngx_http_log_loc_conf_t
block|}
name|ngx_http_log_loc_conf_t
typedef|;
end_typedef

begin_typedef
DECL|struct|__anon2c123cf20608
typedef|typedef
struct|struct
block|{
DECL|member|name
name|ngx_str_t
name|name
decl_stmt|;
DECL|member|len
name|size_t
name|len
decl_stmt|;
DECL|member|run
name|ngx_http_log_op_run_pt
name|run
decl_stmt|;
DECL|typedef|ngx_http_log_var_t
block|}
name|ngx_http_log_var_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|ngx_http_log_write
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_log_t
modifier|*
name|log
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ssize_t
name|ngx_http_log_script_write
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_log_script_t
modifier|*
name|script
parameter_list|,
name|u_char
modifier|*
modifier|*
name|name
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_pipe
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_time
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_msec
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_request_time
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_status
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_bytes_sent
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_body_bytes_sent
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_request_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_log_variable_compile
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|,
name|ngx_str_t
modifier|*
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|size_t
name|ngx_http_log_variable_getlen
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_log_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uintptr_t
name|ngx_http_log_escape
parameter_list|(
name|u_char
modifier|*
name|dst
parameter_list|,
name|u_char
modifier|*
name|src
parameter_list|,
name|size_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_log_create_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_log_create_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_log_merge_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_log_set_log
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_log_set_format
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_log_compile_format
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_array_t
modifier|*
name|ops
parameter_list|,
name|ngx_array_t
modifier|*
name|args
parameter_list|,
name|ngx_uint_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|char
modifier|*
name|ngx_http_log_open_file_cache
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_log_init
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_http_log_commands
specifier|static
name|ngx_command_t
name|ngx_http_log_commands
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"log_format"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_2MORE
block|,
name|ngx_http_log_set_format
block|,
name|NGX_HTTP_MAIN_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"access_log"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_HTTP_LIF_CONF
operator||
name|NGX_HTTP_LMT_CONF
operator||
name|NGX_CONF_TAKE123
block|,
name|ngx_http_log_set_log
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"open_log_file_cache"
argument_list|)
block|,
name|NGX_HTTP_MAIN_CONF
operator||
name|NGX_HTTP_SRV_CONF
operator||
name|NGX_HTTP_LOC_CONF
operator||
name|NGX_CONF_TAKE1234
block|,
name|ngx_http_log_open_file_cache
block|,
name|NGX_HTTP_LOC_CONF_OFFSET
block|,
literal|0
block|,
name|NULL
block|}
block|,
name|ngx_null_command
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_log_module_ctx
specifier|static
name|ngx_http_module_t
name|ngx_http_log_module_ctx
init|=
block|{
name|NULL
block|,
comment|/* preconfiguration */
name|ngx_http_log_init
block|,
comment|/* postconfiguration */
name|ngx_http_log_create_main_conf
block|,
comment|/* create main configuration */
name|NULL
block|,
comment|/* init main configuration */
name|NULL
block|,
comment|/* create server configuration */
name|NULL
block|,
comment|/* merge server configuration */
name|ngx_http_log_create_loc_conf
block|,
comment|/* create location configration */
name|ngx_http_log_merge_loc_conf
comment|/* merge location configration */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_log_module
name|ngx_module_t
name|ngx_http_log_module
init|=
block|{
name|NGX_MODULE_V1
block|,
operator|&
name|ngx_http_log_module_ctx
block|,
comment|/* module context */
name|ngx_http_log_commands
block|,
comment|/* module directives */
name|NGX_HTTP_MODULE
block|,
comment|/* module type */
name|NULL
block|,
comment|/* init master */
name|NULL
block|,
comment|/* init module */
name|NULL
block|,
comment|/* init process */
name|NULL
block|,
comment|/* init thread */
name|NULL
block|,
comment|/* exit thread */
name|NULL
block|,
comment|/* exit process */
name|NULL
block|,
comment|/* exit master */
name|NGX_MODULE_V1_PADDING
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|ngx_str_t
name|ngx_http_access_log
init|=
name|ngx_string
argument_list|(
name|NGX_HTTP_LOG_PATH
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_combined_fmt
specifier|static
name|ngx_str_t
name|ngx_http_combined_fmt
init|=
name|ngx_string
argument_list|(
literal|"$remote_addr - $remote_user [$time_local] "
literal|"\"$request\" $status $body_bytes_sent "
literal|"\"$http_referer\" \"$http_user_agent\""
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_log_vars
specifier|static
name|ngx_http_log_var_t
name|ngx_http_log_vars
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"connection"
argument_list|)
block|,
name|NGX_ATOMIC_T_LEN
block|,
name|ngx_http_log_connection
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"pipe"
argument_list|)
block|,
literal|1
block|,
name|ngx_http_log_pipe
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"time_local"
argument_list|)
block|,
sizeof|sizeof
argument_list|(
literal|"28/Sep/1970:12:00:00 +0600"
argument_list|)
operator|-
literal|1
block|,
name|ngx_http_log_time
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"msec"
argument_list|)
block|,
name|NGX_TIME_T_LEN
operator|+
literal|4
block|,
name|ngx_http_log_msec
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_time"
argument_list|)
block|,
name|NGX_TIME_T_LEN
operator|+
literal|4
block|,
name|ngx_http_log_request_time
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"status"
argument_list|)
block|,
literal|3
block|,
name|ngx_http_log_status
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"bytes_sent"
argument_list|)
block|,
name|NGX_OFF_T_LEN
block|,
name|ngx_http_log_bytes_sent
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"body_bytes_sent"
argument_list|)
block|,
name|NGX_OFF_T_LEN
block|,
name|ngx_http_log_body_bytes_sent
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"apache_bytes_sent"
argument_list|)
block|,
name|NGX_OFF_T_LEN
block|,
name|ngx_http_log_body_bytes_sent
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_length"
argument_list|)
block|,
name|NGX_SIZE_T_LEN
block|,
name|ngx_http_log_request_length
block|}
block|,
block|{
name|ngx_null_string
block|,
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|ngx_int_t
DECL|function|ngx_http_log_handler (ngx_http_request_t * r)
name|ngx_http_log_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|u_char
modifier|*
name|line
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|l
decl_stmt|;
name|ngx_http_log_t
modifier|*
name|log
decl_stmt|;
name|ngx_open_file_t
modifier|*
name|file
decl_stmt|;
name|ngx_http_log_op_t
modifier|*
name|op
decl_stmt|;
name|ngx_http_log_loc_conf_t
modifier|*
name|lcf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http log handler"
argument_list|)
expr_stmt|;
name|lcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_log_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|lcf
operator|->
name|off
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|log
operator|=
name|lcf
operator|->
name|logs
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|l
operator|=
literal|0
init|;
name|l
operator|<
name|lcf
operator|->
name|logs
operator|->
name|nelts
condition|;
name|l
operator|++
control|)
block|{
if|if
condition|(
name|ngx_time
argument_list|()
operator|==
name|log
index|[
name|l
index|]
operator|.
name|disk_full_time
condition|)
block|{
comment|/*              * on FreeBSD writing to a full filesystem with enabled softupdates              * may block process for much longer time than writing to non-full              * filesystem, so we skip writing to a log for one second              */
continue|continue;
block|}
name|len
operator|=
literal|0
expr_stmt|;
name|op
operator|=
name|log
index|[
name|l
index|]
operator|.
name|ops
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|log
index|[
name|l
index|]
operator|.
name|ops
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|op
index|[
name|i
index|]
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|len
operator|+=
name|op
index|[
name|i
index|]
operator|.
name|getlen
argument_list|(
name|r
argument_list|,
name|op
index|[
name|i
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|len
operator|+=
name|op
index|[
name|i
index|]
operator|.
name|len
expr_stmt|;
block|}
block|}
name|len
operator|+=
name|NGX_LINEFEED_SIZE
expr_stmt|;
name|file
operator|=
name|log
index|[
name|l
index|]
operator|.
name|file
expr_stmt|;
if|if
condition|(
name|file
operator|&&
name|file
operator|->
name|buffer
condition|)
block|{
if|if
condition|(
name|len
operator|>
operator|(
name|size_t
operator|)
operator|(
name|file
operator|->
name|last
operator|-
name|file
operator|->
name|pos
operator|)
condition|)
block|{
name|ngx_http_log_write
argument_list|(
name|r
argument_list|,
operator|&
name|log
index|[
name|l
index|]
argument_list|,
name|file
operator|->
name|buffer
argument_list|,
name|file
operator|->
name|pos
operator|-
name|file
operator|->
name|buffer
argument_list|)
expr_stmt|;
name|file
operator|->
name|pos
operator|=
name|file
operator|->
name|buffer
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|<=
operator|(
name|size_t
operator|)
operator|(
name|file
operator|->
name|last
operator|-
name|file
operator|->
name|pos
operator|)
condition|)
block|{
name|p
operator|=
name|file
operator|->
name|pos
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|log
index|[
name|l
index|]
operator|.
name|ops
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
name|op
index|[
name|i
index|]
operator|.
name|run
argument_list|(
name|r
argument_list|,
name|p
argument_list|,
operator|&
name|op
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ngx_linefeed
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|file
operator|->
name|pos
operator|=
name|p
expr_stmt|;
continue|continue;
block|}
block|}
name|line
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|line
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|p
operator|=
name|line
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|log
index|[
name|l
index|]
operator|.
name|ops
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
name|op
index|[
name|i
index|]
operator|.
name|run
argument_list|(
name|r
argument_list|,
name|p
argument_list|,
operator|&
name|op
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ngx_linefeed
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ngx_http_log_write
argument_list|(
name|r
argument_list|,
operator|&
name|log
index|[
name|l
index|]
argument_list|,
name|line
argument_list|,
name|p
operator|-
name|line
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_log_write (ngx_http_request_t * r,ngx_http_log_t * log,u_char * buf,size_t len)
name|ngx_http_log_write
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_log_t
modifier|*
name|log
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|name
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_err_t
name|err
decl_stmt|;
if|if
condition|(
name|log
operator|->
name|script
operator|==
name|NULL
condition|)
block|{
name|name
operator|=
name|log
operator|->
name|file
operator|->
name|name
operator|.
name|data
expr_stmt|;
name|n
operator|=
name|ngx_write_fd
argument_list|(
name|log
operator|->
name|file
operator|->
name|fd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|name
operator|=
name|NULL
expr_stmt|;
name|n
operator|=
name|ngx_http_log_script_write
argument_list|(
name|r
argument_list|,
name|log
operator|->
name|script
argument_list|,
operator|&
name|name
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|==
operator|(
name|ssize_t
operator|)
name|len
condition|)
block|{
return|return;
block|}
name|now
operator|=
name|ngx_time
argument_list|()
expr_stmt|;
if|if
condition|(
name|n
operator|==
operator|-
literal|1
condition|)
block|{
name|err
operator|=
name|ngx_errno
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|NGX_ENOSPC
condition|)
block|{
name|log
operator|->
name|disk_full_time
operator|=
name|now
expr_stmt|;
block|}
if|if
condition|(
name|now
operator|-
name|log
operator|->
name|error_log_time
operator|>
literal|59
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|err
argument_list|,
name|ngx_write_fd_n
literal|" to \"%s\" failed"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|log
operator|->
name|error_log_time
operator|=
name|now
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|now
operator|-
name|log
operator|->
name|error_log_time
operator|>
literal|59
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
name|ngx_write_fd_n
literal|" to \"%s\" was incomplete: %z of %uz"
argument_list|,
name|name
argument_list|,
name|n
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|log
operator|->
name|error_log_time
operator|=
name|now
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|ssize_t
DECL|function|ngx_http_log_script_write (ngx_http_request_t * r,ngx_http_log_script_t * script,u_char ** name,u_char * buf,size_t len)
name|ngx_http_log_script_write
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_log_script_t
modifier|*
name|script
parameter_list|,
name|u_char
modifier|*
modifier|*
name|name
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|root
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_str_t
name|log
decl_stmt|,
name|path
decl_stmt|;
name|ngx_open_file_info_t
name|of
decl_stmt|;
name|ngx_http_log_loc_conf_t
modifier|*
name|llcf
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|err_status
operator|==
name|NGX_HTTP_NOT_FOUND
condition|)
block|{
comment|/* test root directory existance */
if|if
condition|(
name|ngx_http_map_uri_to_path
argument_list|(
name|r
argument_list|,
operator|&
name|path
argument_list|,
operator|&
name|root
argument_list|,
literal|0
argument_list|)
operator|==
name|NULL
condition|)
block|{
comment|/* simulate successfull logging */
return|return
name|len
return|;
block|}
name|path
operator|.
name|data
index|[
name|root
index|]
operator|=
literal|'\0'
expr_stmt|;
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|of
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_open_file_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|of
operator|.
name|valid
operator|=
name|clcf
operator|->
name|open_file_cache_valid
expr_stmt|;
name|of
operator|.
name|min_uses
operator|=
name|clcf
operator|->
name|open_file_cache_min_uses
expr_stmt|;
name|of
operator|.
name|errors
operator|=
name|clcf
operator|->
name|open_file_cache_errors
expr_stmt|;
name|of
operator|.
name|events
operator|=
name|clcf
operator|->
name|open_file_cache_events
expr_stmt|;
if|if
condition|(
name|ngx_open_cached_file
argument_list|(
name|clcf
operator|->
name|open_file_cache
argument_list|,
operator|&
name|path
argument_list|,
operator|&
name|of
argument_list|,
name|r
operator|->
name|pool
argument_list|)
operator|!=
name|NGX_OK
operator|||
operator|!
name|of
operator|.
name|is_dir
condition|)
block|{
comment|/* no root directory: simulate successfull logging */
return|return
name|len
return|;
block|}
block|}
if|if
condition|(
name|ngx_http_script_run
argument_list|(
name|r
argument_list|,
operator|&
name|log
argument_list|,
name|script
operator|->
name|lengths
operator|->
name|elts
argument_list|,
literal|1
argument_list|,
name|script
operator|->
name|values
operator|->
name|elts
argument_list|)
operator|==
name|NULL
condition|)
block|{
comment|/* simulate successfull logging */
return|return
name|len
return|;
block|}
name|log
operator|.
name|data
index|[
name|log
operator|.
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|name
operator|=
name|log
operator|.
name|data
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http log \"%s\""
argument_list|,
name|log
operator|.
name|data
argument_list|)
expr_stmt|;
name|llcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_log_module
argument_list|)
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|of
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_open_file_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|of
operator|.
name|log
operator|=
literal|1
expr_stmt|;
name|of
operator|.
name|valid
operator|=
name|llcf
operator|->
name|open_file_cache_valid
expr_stmt|;
name|of
operator|.
name|min_uses
operator|=
name|llcf
operator|->
name|open_file_cache_min_uses
expr_stmt|;
if|if
condition|(
name|ngx_open_cached_file
argument_list|(
name|llcf
operator|->
name|open_file_cache
argument_list|,
operator|&
name|log
argument_list|,
operator|&
name|of
argument_list|,
name|r
operator|->
name|pool
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_open_file_n
literal|" \"%s\" failed"
argument_list|,
name|log
operator|.
name|data
argument_list|)
expr_stmt|;
comment|/* simulate successfull logging */
return|return
name|len
return|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http log #%d"
argument_list|,
name|of
operator|.
name|fd
argument_list|)
expr_stmt|;
name|n
operator|=
name|ngx_write_fd
argument_list|(
name|of
operator|.
name|fd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_copy_short (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_copy_short
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|uintptr_t
name|data
decl_stmt|;
name|len
operator|=
name|op
operator|->
name|len
expr_stmt|;
name|data
operator|=
name|op
operator|->
name|data
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
block|{
operator|*
name|buf
operator|++
operator|=
operator|(
name|u_char
operator|)
operator|(
name|data
operator|&
literal|0xff
operator|)
expr_stmt|;
name|data
operator|>>=
literal|8
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_copy_long (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_copy_long
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
return|return
name|ngx_cpymem
argument_list|(
name|buf
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|op
operator|->
name|data
argument_list|,
name|op
operator|->
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_connection (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
return|return
name|ngx_sprintf
argument_list|(
name|buf
argument_list|,
literal|"%ui"
argument_list|,
name|r
operator|->
name|connection
operator|->
name|number
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_pipe (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_pipe
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|pipeline
condition|)
block|{
operator|*
name|buf
operator|=
literal|'p'
expr_stmt|;
block|}
else|else
block|{
operator|*
name|buf
operator|=
literal|'.'
expr_stmt|;
block|}
return|return
name|buf
operator|+
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_time (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_time
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
return|return
name|ngx_cpymem
argument_list|(
name|buf
argument_list|,
name|ngx_cached_http_log_time
operator|.
name|data
argument_list|,
name|ngx_cached_http_log_time
operator|.
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_msec (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_msec
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
name|ngx_time_t
modifier|*
name|tp
decl_stmt|;
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
return|return
name|ngx_sprintf
argument_list|(
name|buf
argument_list|,
literal|"%T.%03M"
argument_list|,
name|tp
operator|->
name|sec
argument_list|,
name|tp
operator|->
name|msec
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_request_time (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_request_time
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
name|ngx_time_t
modifier|*
name|tp
decl_stmt|;
name|ngx_msec_int_t
name|ms
decl_stmt|;
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
name|ms
operator|=
operator|(
name|ngx_msec_int_t
operator|)
operator|(
operator|(
name|tp
operator|->
name|sec
operator|-
name|r
operator|->
name|start_sec
operator|)
operator|*
literal|1000
operator|+
operator|(
name|tp
operator|->
name|msec
operator|-
name|r
operator|->
name|start_msec
operator|)
operator|)
expr_stmt|;
name|ms
operator|=
operator|(
name|ms
operator|>=
literal|0
operator|)
condition|?
name|ms
else|:
literal|0
expr_stmt|;
return|return
name|ngx_sprintf
argument_list|(
name|buf
argument_list|,
literal|"%T.%03M"
argument_list|,
name|ms
operator|/
literal|1000
argument_list|,
name|ms
operator|%
literal|1000
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_status (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_status
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
return|return
name|ngx_sprintf
argument_list|(
name|buf
argument_list|,
literal|"%ui"
argument_list|,
name|r
operator|->
name|err_status
condition|?
name|r
operator|->
name|err_status
else|:
name|r
operator|->
name|headers_out
operator|.
name|status
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_bytes_sent (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_bytes_sent
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
return|return
name|ngx_sprintf
argument_list|(
name|buf
argument_list|,
literal|"%O"
argument_list|,
name|r
operator|->
name|connection
operator|->
name|sent
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * although there is a real $body_bytes_sent variable,  * this log operation code function is more optimized for logging  */
end_comment

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_body_bytes_sent (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_body_bytes_sent
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
name|off_t
name|length
decl_stmt|;
name|length
operator|=
name|r
operator|->
name|connection
operator|->
name|sent
operator|-
name|r
operator|->
name|header_size
expr_stmt|;
if|if
condition|(
name|length
operator|>
literal|0
condition|)
block|{
return|return
name|ngx_sprintf
argument_list|(
name|buf
argument_list|,
literal|"%O"
argument_list|,
name|length
argument_list|)
return|;
block|}
operator|*
name|buf
operator|=
literal|'0'
expr_stmt|;
return|return
name|buf
operator|+
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_request_length (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_request_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
return|return
name|ngx_sprintf
argument_list|(
name|buf
argument_list|,
literal|"%O"
argument_list|,
name|r
operator|->
name|request_length
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_log_variable_compile (ngx_conf_t * cf,ngx_http_log_op_t * op,ngx_str_t * value)
name|ngx_http_log_variable_compile
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|,
name|ngx_str_t
modifier|*
name|value
parameter_list|)
block|{
name|ngx_int_t
name|index
decl_stmt|;
name|index
operator|=
name|ngx_http_get_variable_index
argument_list|(
name|cf
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|op
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|op
operator|->
name|getlen
operator|=
name|ngx_http_log_variable_getlen
expr_stmt|;
name|op
operator|->
name|run
operator|=
name|ngx_http_log_variable
expr_stmt|;
name|op
operator|->
name|data
operator|=
name|index
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
DECL|function|ngx_http_log_variable_getlen (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_log_variable_getlen
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|uintptr_t
name|len
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|value
decl_stmt|;
name|value
operator|=
name|ngx_http_get_indexed_variable
argument_list|(
name|r
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
operator|||
name|value
operator|->
name|not_found
condition|)
block|{
return|return
literal|1
return|;
block|}
name|len
operator|=
name|ngx_http_log_escape
argument_list|(
name|NULL
argument_list|,
name|value
operator|->
name|data
argument_list|,
name|value
operator|->
name|len
argument_list|)
expr_stmt|;
name|value
operator|->
name|escape
operator|=
name|len
condition|?
literal|1
else|:
literal|0
expr_stmt|;
return|return
name|value
operator|->
name|len
operator|+
name|len
operator|*
literal|3
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_log_variable (ngx_http_request_t * r,u_char * buf,ngx_http_log_op_t * op)
name|ngx_http_log_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|ngx_http_log_op_t
modifier|*
name|op
parameter_list|)
block|{
name|ngx_http_variable_value_t
modifier|*
name|value
decl_stmt|;
name|value
operator|=
name|ngx_http_get_indexed_variable
argument_list|(
name|r
argument_list|,
name|op
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
operator|||
name|value
operator|->
name|not_found
condition|)
block|{
operator|*
name|buf
operator|=
literal|'-'
expr_stmt|;
return|return
name|buf
operator|+
literal|1
return|;
block|}
if|if
condition|(
name|value
operator|->
name|escape
operator|==
literal|0
condition|)
block|{
return|return
name|ngx_cpymem
argument_list|(
name|buf
argument_list|,
name|value
operator|->
name|data
argument_list|,
name|value
operator|->
name|len
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|u_char
operator|*
operator|)
name|ngx_http_log_escape
argument_list|(
name|buf
argument_list|,
name|value
operator|->
name|data
argument_list|,
name|value
operator|->
name|len
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uintptr_t
DECL|function|ngx_http_log_escape (u_char * dst,u_char * src,size_t size)
name|ngx_http_log_escape
parameter_list|(
name|u_char
modifier|*
name|dst
parameter_list|,
name|u_char
modifier|*
name|src
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
specifier|static
name|u_char
name|hex
index|[]
init|=
literal|"0123456789ABCDEF"
decl_stmt|;
specifier|static
name|uint32_t
name|escape
index|[]
init|=
block|{
literal|0xffffffff
block|,
comment|/* 1111 1111 1111 1111  1111 1111 1111 1111 */
comment|/* ?>=< ;:98 7654 3210  /.-, +*)( '&%$ #"!  */
literal|0x00000004
block|,
comment|/* 0000 0000 0000 0000  0000 0000 0000 0100 */
comment|/* _^]\ [ZYX WVUT SRQP  ONML KJIH GFED CBA@ */
literal|0x10000000
block|,
comment|/* 0001 0000 0000 0000  0000 0000 0000 0000 */
comment|/*  ~}| {zyx wvut srqp  onml kjih gfed cba` */
literal|0x00000000
block|,
comment|/* 0000 0000 0000 0000  0000 0000 0000 0000 */
literal|0x00000000
block|,
comment|/* 0000 0000 0000 0000  0000 0000 0000 0000 */
literal|0x00000000
block|,
comment|/* 0000 0000 0000 0000  0000 0000 0000 0000 */
literal|0x00000000
block|,
comment|/* 0000 0000 0000 0000  0000 0000 0000 0000 */
literal|0x00000000
block|,
comment|/* 0000 0000 0000 0000  0000 0000 0000 0000 */
block|}
decl_stmt|;
if|if
condition|(
name|dst
operator|==
name|NULL
condition|)
block|{
comment|/* find the number of the characters to be escaped */
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|escape
index|[
operator|*
name|src
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
operator|*
name|src
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
name|n
operator|++
expr_stmt|;
block|}
name|src
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|uintptr_t
operator|)
name|n
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|escape
index|[
operator|*
name|src
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
operator|*
name|src
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
operator|*
name|dst
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|dst
operator|++
operator|=
literal|'x'
expr_stmt|;
operator|*
name|dst
operator|++
operator|=
name|hex
index|[
operator|*
name|src
operator|>>
literal|4
index|]
expr_stmt|;
operator|*
name|dst
operator|++
operator|=
name|hex
index|[
operator|*
name|src
operator|&
literal|0xf
index|]
expr_stmt|;
name|src
operator|++
expr_stmt|;
block|}
else|else
block|{
operator|*
name|dst
operator|++
operator|=
operator|*
name|src
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|uintptr_t
operator|)
name|dst
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_log_create_main_conf (ngx_conf_t * cf)
name|ngx_http_log_create_main_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_log_main_conf_t
modifier|*
name|conf
decl_stmt|;
name|ngx_http_log_fmt_t
modifier|*
name|fmt
decl_stmt|;
name|conf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_main_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|conf
operator|->
name|formats
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_fmt_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|fmt
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|conf
operator|->
name|formats
argument_list|)
expr_stmt|;
if|if
condition|(
name|fmt
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|fmt
operator|->
name|name
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"combined"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|fmt
operator|->
name|name
operator|.
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"combined"
expr_stmt|;
name|fmt
operator|->
name|ops
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|16
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_op_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fmt
operator|->
name|ops
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_log_create_loc_conf (ngx_conf_t * cf)
name|ngx_http_log_create_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_log_loc_conf_t
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_loc_conf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|conf
operator|->
name|open_file_cache
operator|=
name|NGX_CONF_UNSET_PTR
expr_stmt|;
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_log_merge_loc_conf (ngx_conf_t * cf,void * parent,void * child)
name|ngx_http_log_merge_loc_conf
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|void
modifier|*
name|parent
parameter_list|,
name|void
modifier|*
name|child
parameter_list|)
block|{
name|ngx_http_log_loc_conf_t
modifier|*
name|prev
init|=
name|parent
decl_stmt|;
name|ngx_http_log_loc_conf_t
modifier|*
name|conf
init|=
name|child
decl_stmt|;
name|ngx_http_log_t
modifier|*
name|log
decl_stmt|;
name|ngx_http_log_fmt_t
modifier|*
name|fmt
decl_stmt|;
name|ngx_http_log_main_conf_t
modifier|*
name|lmcf
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|open_file_cache
operator|==
name|NGX_CONF_UNSET_PTR
condition|)
block|{
name|conf
operator|->
name|open_file_cache
operator|=
name|prev
operator|->
name|open_file_cache
expr_stmt|;
name|conf
operator|->
name|open_file_cache_valid
operator|=
name|prev
operator|->
name|open_file_cache_valid
expr_stmt|;
name|conf
operator|->
name|open_file_cache_min_uses
operator|=
name|prev
operator|->
name|open_file_cache_min_uses
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|open_file_cache
operator|==
name|NGX_CONF_UNSET_PTR
condition|)
block|{
name|conf
operator|->
name|open_file_cache
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|conf
operator|->
name|logs
operator|||
name|conf
operator|->
name|off
condition|)
block|{
return|return
name|NGX_CONF_OK
return|;
block|}
operator|*
name|conf
operator|=
operator|*
name|prev
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|logs
operator|||
name|conf
operator|->
name|off
condition|)
block|{
return|return
name|NGX_CONF_OK
return|;
block|}
name|conf
operator|->
name|logs
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|logs
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|log
operator|=
name|ngx_array_push
argument_list|(
name|conf
operator|->
name|logs
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|log
operator|->
name|file
operator|=
name|ngx_conf_open_file
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
operator|&
name|ngx_http_access_log
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|->
name|file
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|log
operator|->
name|disk_full_time
operator|=
literal|0
expr_stmt|;
name|log
operator|->
name|error_log_time
operator|=
literal|0
expr_stmt|;
name|lmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_log_module
argument_list|)
expr_stmt|;
name|fmt
operator|=
name|lmcf
operator|->
name|formats
operator|.
name|elts
expr_stmt|;
comment|/* the default "combined" format */
name|log
operator|->
name|ops
operator|=
name|fmt
index|[
literal|0
index|]
operator|.
name|ops
expr_stmt|;
name|lmcf
operator|->
name|combined_used
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_log_set_log (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_log_set_log
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_log_loc_conf_t
modifier|*
name|llcf
init|=
name|conf
decl_stmt|;
name|ssize_t
name|buf
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|,
name|name
decl_stmt|;
name|ngx_http_log_t
modifier|*
name|log
decl_stmt|;
name|ngx_http_log_fmt_t
modifier|*
name|fmt
decl_stmt|;
name|ngx_http_log_main_conf_t
modifier|*
name|lmcf
decl_stmt|;
name|ngx_http_script_compile_t
name|sc
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llcf
operator|->
name|off
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
if|if
condition|(
name|llcf
operator|->
name|logs
operator|==
name|NULL
condition|)
block|{
name|llcf
operator|->
name|logs
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|llcf
operator|->
name|logs
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|lmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_log_module
argument_list|)
expr_stmt|;
name|log
operator|=
name|ngx_array_push
argument_list|(
name|llcf
operator|->
name|logs
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
name|log
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_t
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|=
name|ngx_http_script_variables_count
argument_list|(
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|log
operator|->
name|file
operator|=
name|ngx_conf_open_file
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|->
name|file
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ngx_conf_full_name
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|log
operator|->
name|script
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_script_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|->
name|script
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_script_compile_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|.
name|cf
operator|=
name|cf
expr_stmt|;
name|sc
operator|.
name|source
operator|=
operator|&
name|value
index|[
literal|1
index|]
expr_stmt|;
name|sc
operator|.
name|lengths
operator|=
operator|&
name|log
operator|->
name|script
operator|->
name|lengths
expr_stmt|;
name|sc
operator|.
name|values
operator|=
operator|&
name|log
operator|->
name|script
operator|->
name|values
expr_stmt|;
name|sc
operator|.
name|variables
operator|=
name|n
expr_stmt|;
name|sc
operator|.
name|complete_lengths
operator|=
literal|1
expr_stmt|;
name|sc
operator|.
name|complete_values
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_http_script_compile
argument_list|(
operator|&
name|sc
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
if|if
condition|(
name|cf
operator|->
name|args
operator|->
name|nelts
operator|>=
literal|3
condition|)
block|{
name|name
operator|=
name|value
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|name
operator|.
name|data
argument_list|,
literal|"combined"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|lmcf
operator|->
name|combined_used
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
name|name
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"combined"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|name
operator|.
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"combined"
expr_stmt|;
name|lmcf
operator|->
name|combined_used
operator|=
literal|1
expr_stmt|;
block|}
name|fmt
operator|=
name|lmcf
operator|->
name|formats
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lmcf
operator|->
name|formats
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fmt
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|==
name|name
operator|.
name|len
operator|&&
name|ngx_strcasecmp
argument_list|(
name|fmt
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|.
name|data
argument_list|)
operator|==
literal|0
condition|)
block|{
name|log
operator|->
name|ops
operator|=
name|fmt
index|[
name|i
index|]
operator|.
name|ops
expr_stmt|;
goto|goto
name|buffer
goto|;
block|}
block|}
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"unknown log format \"%V\""
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
name|buffer
label|:
if|if
condition|(
name|cf
operator|->
name|args
operator|->
name|nelts
operator|==
literal|4
condition|)
block|{
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
literal|3
index|]
operator|.
name|data
argument_list|,
literal|"buffer="
argument_list|,
literal|7
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|log
operator|->
name|script
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"buffered logs can not have variables in name"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|name
operator|.
name|len
operator|=
name|value
index|[
literal|3
index|]
operator|.
name|len
operator|-
literal|7
expr_stmt|;
name|name
operator|.
name|data
operator|=
name|value
index|[
literal|3
index|]
operator|.
name|data
operator|+
literal|7
expr_stmt|;
name|buf
operator|=
name|ngx_parse_size
argument_list|(
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|log
operator|->
name|file
operator|->
name|buffer
operator|&&
name|log
operator|->
name|file
operator|->
name|last
operator|-
name|log
operator|->
name|file
operator|->
name|pos
operator|!=
name|buf
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"access_log \"%V\" already defined "
literal|"with different buffer size"
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|log
operator|->
name|file
operator|->
name|buffer
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|->
name|file
operator|->
name|buffer
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|log
operator|->
name|file
operator|->
name|pos
operator|=
name|log
operator|->
name|file
operator|->
name|buffer
expr_stmt|;
name|log
operator|->
name|file
operator|->
name|last
operator|=
name|log
operator|->
name|file
operator|->
name|buffer
operator|+
name|buf
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_log_set_format (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_log_set_format
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_log_main_conf_t
modifier|*
name|lmcf
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_log_fmt_t
modifier|*
name|fmt
decl_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|fmt
operator|=
name|lmcf
operator|->
name|formats
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lmcf
operator|->
name|formats
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|fmt
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|==
name|value
index|[
literal|1
index|]
operator|.
name|len
operator|&&
name|ngx_strcmp
argument_list|(
name|fmt
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|value
index|[
literal|1
index|]
operator|.
name|data
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate \"log_format\" name \"%V\""
argument_list|,
operator|&
name|value
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|fmt
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|lmcf
operator|->
name|formats
argument_list|)
expr_stmt|;
if|if
condition|(
name|fmt
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|fmt
operator|->
name|name
operator|=
name|value
index|[
literal|1
index|]
expr_stmt|;
name|fmt
operator|->
name|ops
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|16
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_op_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fmt
operator|->
name|ops
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
return|return
name|ngx_http_log_compile_format
argument_list|(
name|cf
argument_list|,
name|fmt
operator|->
name|ops
argument_list|,
name|cf
operator|->
name|args
argument_list|,
literal|2
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_log_compile_format (ngx_conf_t * cf,ngx_array_t * ops,ngx_array_t * args,ngx_uint_t s)
name|ngx_http_log_compile_format
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_array_t
modifier|*
name|ops
parameter_list|,
name|ngx_array_t
modifier|*
name|args
parameter_list|,
name|ngx_uint_t
name|s
parameter_list|)
block|{
name|u_char
modifier|*
name|data
decl_stmt|,
modifier|*
name|p
decl_stmt|,
name|ch
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|len
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|,
name|var
decl_stmt|;
name|ngx_uint_t
name|bracket
decl_stmt|;
name|ngx_http_log_op_t
modifier|*
name|op
decl_stmt|;
name|ngx_http_log_var_t
modifier|*
name|v
decl_stmt|;
name|value
operator|=
name|args
operator|->
name|elts
expr_stmt|;
for|for
control|(
comment|/* void */
init|;
name|s
operator|<
name|args
operator|->
name|nelts
condition|;
name|s
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|value
index|[
name|s
index|]
operator|.
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
operator|!=
literal|'%'
condition|)
block|{
continue|continue;
block|}
name|ch
operator|=
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|>=
literal|'A'
operator|&&
name|ch
operator|<=
literal|'Z'
operator|)
operator|||
operator|(
name|ch
operator|>=
literal|'a'
operator|&&
name|ch
operator|<=
literal|'z'
operator|)
operator|||
name|ch
operator|==
literal|'{'
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the parameters in the \"%%name\" form are not supported, "
literal|"use the \"$variable\" instead"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|value
index|[
name|s
index|]
operator|.
name|len
condition|)
block|{
name|op
operator|=
name|ngx_array_push
argument_list|(
name|ops
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|data
operator|=
operator|&
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
operator|==
literal|'$'
condition|)
block|{
if|if
condition|(
operator|++
name|i
operator|==
name|value
index|[
name|s
index|]
operator|.
name|len
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
if|if
condition|(
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
operator|==
literal|'{'
condition|)
block|{
name|bracket
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|++
name|i
operator|==
name|value
index|[
name|s
index|]
operator|.
name|len
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
name|var
operator|.
name|data
operator|=
operator|&
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
name|bracket
operator|=
literal|0
expr_stmt|;
name|var
operator|.
name|data
operator|=
operator|&
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
expr_stmt|;
block|}
for|for
control|(
name|var
operator|.
name|len
operator|=
literal|0
init|;
name|i
operator|<
name|value
index|[
name|s
index|]
operator|.
name|len
condition|;
name|i
operator|++
operator|,
name|var
operator|.
name|len
operator|++
control|)
block|{
name|ch
operator|=
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'}'
operator|&&
name|bracket
condition|)
block|{
name|i
operator|++
expr_stmt|;
name|bracket
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|ch
operator|>=
literal|'A'
operator|&&
name|ch
operator|<=
literal|'Z'
operator|)
operator|||
operator|(
name|ch
operator|>=
literal|'a'
operator|&&
name|ch
operator|<=
literal|'z'
operator|)
operator|||
operator|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
operator|)
operator|||
name|ch
operator|==
literal|'_'
condition|)
block|{
continue|continue;
block|}
break|break;
block|}
if|if
condition|(
name|bracket
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the closing bracket in \"%V\" "
literal|"variable is missing"
argument_list|,
operator|&
name|var
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|var
operator|.
name|len
operator|==
literal|0
condition|)
block|{
goto|goto
name|invalid
goto|;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|var
operator|.
name|data
argument_list|,
literal|"apache_bytes_sent"
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_WARN
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"use \"$body_bytes_sent\" instead of "
literal|"\"$apache_bytes_sent\""
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|v
operator|=
name|ngx_http_log_vars
init|;
name|v
operator|->
name|name
operator|.
name|len
condition|;
name|v
operator|++
control|)
block|{
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|len
operator|==
name|var
operator|.
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|v
operator|->
name|name
operator|.
name|data
argument_list|,
name|var
operator|.
name|data
argument_list|,
name|var
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|op
operator|->
name|len
operator|=
name|v
operator|->
name|len
expr_stmt|;
name|op
operator|->
name|getlen
operator|=
name|NULL
expr_stmt|;
name|op
operator|->
name|run
operator|=
name|v
operator|->
name|run
expr_stmt|;
name|op
operator|->
name|data
operator|=
literal|0
expr_stmt|;
goto|goto
name|found
goto|;
block|}
block|}
if|if
condition|(
name|ngx_http_log_variable_compile
argument_list|(
name|cf
argument_list|,
name|op
argument_list|,
operator|&
name|var
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|found
label|:
continue|continue;
block|}
name|i
operator|++
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|value
index|[
name|s
index|]
operator|.
name|len
operator|&&
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
operator|!=
literal|'$'
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
name|len
operator|=
operator|&
name|value
index|[
name|s
index|]
operator|.
name|data
index|[
name|i
index|]
operator|-
name|data
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
name|op
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|op
operator|->
name|getlen
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
name|uintptr_t
argument_list|)
condition|)
block|{
name|op
operator|->
name|run
operator|=
name|ngx_http_log_copy_short
expr_stmt|;
name|op
operator|->
name|data
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
block|{
name|op
operator|->
name|data
operator|<<=
literal|8
expr_stmt|;
name|op
operator|->
name|data
operator||=
name|data
index|[
name|len
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|op
operator|->
name|run
operator|=
name|ngx_http_log_copy_long
expr_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|op
operator|->
name|data
operator|=
operator|(
name|uintptr_t
operator|)
name|p
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
name|NGX_CONF_OK
return|;
name|invalid
label|:
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%s\""
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
DECL|function|ngx_http_log_open_file_cache (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_log_open_file_cache
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|ngx_http_log_loc_conf_t
modifier|*
name|llcf
init|=
name|conf
decl_stmt|;
name|time_t
name|inactive
decl_stmt|,
name|valid
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|,
name|s
decl_stmt|;
name|ngx_int_t
name|max
decl_stmt|,
name|min_uses
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
if|if
condition|(
name|llcf
operator|->
name|open_file_cache
operator|!=
name|NGX_CONF_UNSET_PTR
condition|)
block|{
return|return
literal|"is duplicate"
return|;
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|max
operator|=
literal|0
expr_stmt|;
name|inactive
operator|=
literal|10
expr_stmt|;
name|valid
operator|=
literal|60
expr_stmt|;
name|min_uses
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|cf
operator|->
name|args
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"max="
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|max
operator|=
name|ngx_atoi
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|4
argument_list|,
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|max
operator|==
name|NGX_ERROR
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"inactive="
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|.
name|len
operator|=
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|9
expr_stmt|;
name|s
operator|.
name|data
operator|=
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|9
expr_stmt|;
name|inactive
operator|=
name|ngx_parse_time
argument_list|(
operator|&
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|inactive
operator|<
literal|0
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"min_uses="
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|min_uses
operator|=
name|ngx_atoi
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|9
argument_list|,
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|9
argument_list|)
expr_stmt|;
if|if
condition|(
name|min_uses
operator|==
name|NGX_ERROR
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"valid="
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|.
name|len
operator|=
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|6
expr_stmt|;
name|s
operator|.
name|data
operator|=
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|6
expr_stmt|;
name|valid
operator|=
name|ngx_parse_time
argument_list|(
operator|&
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid
operator|<
literal|0
condition|)
block|{
goto|goto
name|failed
goto|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|llcf
operator|->
name|open_file_cache
operator|=
name|NULL
expr_stmt|;
continue|continue;
block|}
name|failed
label|:
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid \"open_log_file_cache\" parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|llcf
operator|->
name|open_file_cache
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_OK
return|;
block|}
if|if
condition|(
name|max
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"\"open_log_file_cache\" must have \"max\" parameter"
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|llcf
operator|->
name|open_file_cache
operator|=
name|ngx_open_file_cache_init
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|max
argument_list|,
name|inactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|llcf
operator|->
name|open_file_cache
condition|)
block|{
name|llcf
operator|->
name|open_file_cache_valid
operator|=
name|valid
expr_stmt|;
name|llcf
operator|->
name|open_file_cache_min_uses
operator|=
name|min_uses
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
return|return
name|NGX_CONF_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_log_init (ngx_conf_t * cf)
name|ngx_http_log_init
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_array_t
name|a
decl_stmt|;
name|ngx_http_handler_pt
modifier|*
name|h
decl_stmt|;
name|ngx_http_log_fmt_t
modifier|*
name|fmt
decl_stmt|;
name|ngx_http_log_main_conf_t
modifier|*
name|lmcf
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|lmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_log_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|lmcf
operator|->
name|combined_used
condition|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|a
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_str_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|value
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|value
operator|=
name|ngx_http_combined_fmt
expr_stmt|;
name|fmt
operator|=
name|lmcf
operator|->
name|formats
operator|.
name|elts
expr_stmt|;
if|if
condition|(
name|ngx_http_log_compile_format
argument_list|(
name|cf
argument_list|,
name|fmt
operator|->
name|ops
argument_list|,
operator|&
name|a
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_CONF_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|h
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|phases
index|[
name|NGX_HTTP_LOG_PHASE
index|]
operator|.
name|handlers
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|h
operator|=
name|ngx_http_log_handler
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

end_unit

