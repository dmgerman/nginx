begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_string.h>
end_include

begin_include
include|#
directive|include
file|<ngx_files.h>
end_include

begin_include
include|#
directive|include
file|<ngx_log.h>
end_include

begin_include
include|#
directive|include
file|<ngx_alloc.h>
end_include

begin_include
include|#
directive|include
file|<ngx_array.h>
end_include

begin_include
include|#
directive|include
file|<ngx_table.h>
end_include

begin_include
include|#
directive|include
file|<ngx_hunk.h>
end_include

begin_include
include|#
directive|include
file|<ngx_connection.h>
end_include

begin_include
include|#
directive|include
file|<ngx_inet.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http_core.h>
end_include

begin_comment
comment|/* STUB */
end_comment

begin_include
include|#
directive|include
file|<ngx_http_output_filter.h>
end_include

begin_function_decl
name|int
name|ngx_http_static_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ngx_http_index_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ngx_http_proxy_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**/
end_comment

begin_function_decl
name|int
name|ngx_http_init_connection
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_init_request
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_process_request_header
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_process_request_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_process_request_headers
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_process_request_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_event_request_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_writer
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_block_read
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_read_discarded_body
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_keepalive_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_set_lingering_close
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ngx_http_lingering_close_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|int ngx_http_special_response(ngx_http_request_t *r, int error); int ngx_http_redirect(ngx_http_request_t *r, int redirect); int ngx_http_error(ngx_http_request_t *r, int error); int ngx_http_close_request(ngx_http_request_t *r);
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|ngx_http_close_connection
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|size_t
name|ngx_http_log_error
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|header_errors
specifier|static
name|char
modifier|*
name|header_errors
index|[]
init|=
block|{
literal|"client %s sent invalid method"
block|,
literal|"client %s sent invalid request"
block|,
literal|"client %s sent too long URI"
block|,
literal|"client %s sent HEAD method in HTTP/0.9 request"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|headers_in
specifier|static
name|ngx_http_header_t
name|headers_in
index|[]
init|=
block|{
block|{
literal|4
block|,
literal|"Host"
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|host
argument_list|)
block|}
block|,
block|{
literal|10
block|,
literal|"Connection"
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|connection
argument_list|)
block|}
block|,
block|{
literal|17
block|,
literal|"If-Modified-Since"
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|if_modified_since
argument_list|)
block|}
block|,
block|{
literal|10
block|,
literal|"User-Agent"
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|user_agent
argument_list|)
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
DECL|function|ngx_http_init_connection (ngx_connection_t * c)
name|int
name|ngx_http_init_connection
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|)
block|{
name|ngx_event_t
modifier|*
name|ev
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|addr
decl_stmt|;
name|ngx_http_server_t
modifier|*
name|srv
decl_stmt|;
name|ngx_http_log_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ev
operator|=
name|c
operator|->
name|read
expr_stmt|;
name|ev
operator|->
name|event_handler
operator|=
name|ngx_http_init_request
expr_stmt|;
name|srv
operator|=
operator|(
name|ngx_http_server_t
operator|*
operator|)
name|c
operator|->
name|server
expr_stmt|;
name|ngx_test_null
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|ngx_create_pool
argument_list|(
name|srv
operator|->
name|connection_pool_size
argument_list|,
name|ev
operator|->
name|log
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|ngx_test_null
argument_list|(
name|c
operator|->
name|requests
argument_list|,
name|ngx_create_array
argument_list|(
name|c
operator|->
name|pool
argument_list|,
literal|10
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|ev
operator|->
name|close_handler
operator|=
name|ngx_http_close_connection
expr_stmt|;
name|c
operator|->
name|write
operator|->
name|close_handler
operator|=
name|ngx_http_close_connection
expr_stmt|;
name|ngx_test_null
argument_list|(
name|addr
argument_list|,
name|ngx_palloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|c
operator|->
name|socklen
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|addr
argument_list|,
name|c
operator|->
name|sockaddr
argument_list|,
name|c
operator|->
name|socklen
argument_list|)
expr_stmt|;
name|c
operator|->
name|sockaddr
operator|=
name|addr
expr_stmt|;
name|ngx_test_null
argument_list|(
name|c
operator|->
name|addr_text
operator|.
name|data
argument_list|,
name|ngx_palloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|c
operator|->
name|addr_text
operator|.
name|len
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|c
operator|->
name|addr_text
operator|.
name|len
operator|=
name|ngx_inet_ntop
argument_list|(
name|c
operator|->
name|family
argument_list|,
operator|(
name|char
operator|*
operator|)
name|c
operator|->
name|sockaddr
operator|+
name|c
operator|->
name|addr
argument_list|,
name|c
operator|->
name|addr_text
operator|.
name|data
argument_list|,
name|c
operator|->
name|addr_text
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|addr_text
operator|.
name|len
operator|==
literal|0
condition|)
return|return
name|NGX_ERROR
return|;
name|ngx_test_null
argument_list|(
name|ctx
argument_list|,
name|ngx_pcalloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_ctx_t
argument_list|)
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|client
operator|=
name|c
operator|->
name|addr_text
operator|.
name|data
expr_stmt|;
name|ctx
operator|->
name|action
operator|=
literal|"reading client request line"
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|data
operator|=
name|ctx
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|handler
operator|=
name|ngx_http_log_error
expr_stmt|;
if|#
directive|if
operator|(
name|HAVE_DEFERRED_ACCEPT
operator|)
if|if
condition|(
name|ev
operator|->
name|ready
condition|)
block|{
return|return
name|ngx_http_init_request
argument_list|(
name|ev
argument_list|)
return|;
block|}
else|else
block|{
endif|#
directive|endif
comment|/* STUB: post_accept_timeout should be in http_conf */
name|ngx_add_timer
argument_list|(
name|ev
argument_list|,
name|c
operator|->
name|post_accept_timeout
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|USE_KQUEUE
operator|)
return|return
name|ngx_add_event
argument_list|(
name|ev
argument_list|,
name|NGX_READ_EVENT
argument_list|,
name|NGX_CLEAR_EVENT
argument_list|)
return|;
else|#
directive|else
if|#
directive|if
operator|(
name|HAVE_AIO_EVENT
operator|)
if|if
condition|(
name|ngx_event_type
operator|==
name|NGX_AIO_EVENT
condition|)
return|return
name|ngx_http_init_request
argument_list|(
name|ev
argument_list|)
return|;
if|else
endif|#
directive|endif
if|#
directive|if
operator|(
name|HAVE_CLEAR_EVENT
operator|)
if|if
condition|(
name|ngx_event_type
operator|==
name|NGX_KQUEUE_EVENT
condition|)
return|return
name|ngx_add_event
argument_list|(
name|ev
argument_list|,
name|NGX_READ_EVENT
argument_list|,
name|NGX_CLEAR_EVENT
argument_list|)
return|;
else|else
endif|#
directive|endif
return|return
name|ngx_add_event
argument_list|(
name|ev
argument_list|,
name|NGX_READ_EVENT
argument_list|,
name|NGX_LEVEL_EVENT
argument_list|)
return|;
endif|#
directive|endif
comment|/* USE_KQUEUE */
if|#
directive|if
operator|(
name|HAVE_DEFERRED_ACCEPT
operator|)
block|}
endif|#
directive|endif
block|}
end_function

begin_function
DECL|function|ngx_http_init_request (ngx_event_t * ev)
specifier|static
name|int
name|ngx_http_init_request
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_server_t
modifier|*
name|srv
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|c
operator|=
operator|(
name|ngx_connection_t
operator|*
operator|)
name|ev
operator|->
name|data
expr_stmt|;
name|srv
operator|=
operator|(
name|ngx_http_server_t
operator|*
operator|)
name|c
operator|->
name|server
expr_stmt|;
name|ngx_test_null
argument_list|(
name|r
argument_list|,
name|ngx_pcalloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_request_t
argument_list|)
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|c
operator|->
name|data
operator|=
name|r
expr_stmt|;
name|r
operator|->
name|connection
operator|=
name|c
expr_stmt|;
name|r
operator|->
name|server
operator|=
name|srv
expr_stmt|;
name|r
operator|->
name|file
operator|.
name|fd
operator|=
name|NGX_INVALID_FILE
expr_stmt|;
comment|/* STUB */
name|r
operator|->
name|srv_conf
operator|=
name|ngx_srv_conf
expr_stmt|;
name|r
operator|->
name|loc_conf
operator|=
name|ngx_loc_conf
expr_stmt|;
comment|/**/
if|if
condition|(
name|c
operator|->
name|buffer
operator|==
name|NULL
condition|)
block|{
name|ngx_test_null
argument_list|(
name|c
operator|->
name|buffer
argument_list|,
name|ngx_create_temp_hunk
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|srv
operator|->
name|header_buffer_size
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|->
name|header_read
operator|=
literal|1
expr_stmt|;
block|}
name|r
operator|->
name|header_in
operator|=
name|c
operator|->
name|buffer
expr_stmt|;
name|ngx_test_null
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|ngx_create_pool
argument_list|(
name|srv
operator|->
name|request_pool_size
argument_list|,
name|ev
operator|->
name|log
argument_list|)
argument_list|,
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_test_null
argument_list|(
name|r
operator|->
name|ctx
argument_list|,
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|*
name|ngx_max_module
argument_list|)
argument_list|,
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|headers
operator|=
name|ngx_create_table
argument_list|(
name|r
operator|->
name|pool
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|content_length
operator|=
operator|-
literal|1
expr_stmt|;
name|r
operator|->
name|headers_out
operator|.
name|last_modified_time
operator|=
operator|-
literal|1
expr_stmt|;
name|ev
operator|->
name|event_handler
operator|=
name|ngx_http_process_request_header
expr_stmt|;
name|r
operator|->
name|state_handler
operator|=
name|ngx_http_process_request_line
expr_stmt|;
name|r
operator|->
name|header_timeout
operator|=
literal|1
expr_stmt|;
return|return
name|ngx_http_process_request_header
argument_list|(
name|ev
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|ngx_http_process_request_header (ngx_event_t * ev)
specifier|static
name|int
name|ngx_http_process_request_header
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|rc
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_log_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|c
operator|=
operator|(
name|ngx_connection_t
operator|*
operator|)
name|ev
operator|->
name|data
expr_stmt|;
name|r
operator|=
operator|(
name|ngx_http_request_t
operator|*
operator|)
name|c
operator|->
name|data
expr_stmt|;
name|ngx_log_debug
argument_list|(
name|ev
operator|->
name|log
argument_list|,
literal|"http process request"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|header_read
condition|)
block|{
name|r
operator|->
name|header_read
operator|=
literal|0
expr_stmt|;
name|ngx_log_debug
argument_list|(
argument|ev->log
argument_list|,
literal|"http preread %d"
argument|_                       r->header_in->last.mem - r->header_in->pos.mem
argument_list|)
empty_stmt|;
block|}
else|else
block|{
name|n
operator|=
name|ngx_event_recv
argument_list|(
name|c
argument_list|,
name|r
operator|->
name|header_in
operator|->
name|last
operator|.
name|mem
argument_list|,
name|r
operator|->
name|header_in
operator|->
name|end
operator|-
name|r
operator|->
name|header_in
operator|->
name|last
operator|.
name|mem
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|header_timeout
condition|)
block|{
name|r
operator|->
name|header_timeout
operator|=
literal|0
expr_stmt|;
name|ngx_del_timer
argument_list|(
name|ev
argument_list|)
expr_stmt|;
comment|/* STUB: r->server->header_timeout                          OR r->srv_conf->header_timeout ? */
name|ngx_add_timer
argument_list|(
name|ev
argument_list|,
name|r
operator|->
name|server
operator|->
name|header_timeout
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
name|ngx_log_debug
argument_list|(
argument|ev->log
argument_list|,
literal|"http read %d"
argument|_ n
argument_list|)
empty_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client has prematurely closed connection"
argument_list|)
expr_stmt|;
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
block|}
name|r
operator|->
name|header_in
operator|->
name|last
operator|.
name|mem
operator|+=
name|n
expr_stmt|;
block|}
comment|/* state_handlers are called in following order:         ngx_http_process_request_line(r)         ngx_http_process_request_headers(r) */
do|do
block|{
name|rc
operator|=
operator|(
name|r
operator|->
name|state_handler
operator|)
operator|(
name|r
operator|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
return|return
name|rc
return|;
block|}
do|while
condition|(
name|rc
operator|==
name|NGX_AGAIN
operator|&&
name|r
operator|->
name|header_in
operator|->
name|pos
operator|.
name|mem
operator|<
name|r
operator|->
name|header_in
operator|->
name|last
operator|.
name|mem
condition|)
do|;
if|if
condition|(
name|r
operator|->
name|header_timeout
condition|)
block|{
name|r
operator|->
name|header_timeout
operator|=
literal|0
expr_stmt|;
name|ngx_del_timer
argument_list|(
name|ev
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|ev
argument_list|,
name|r
operator|->
name|server
operator|->
name|header_timeout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
return|return
name|ngx_http_event_request_handler
argument_list|(
name|r
argument_list|)
return|;
else|else
return|return
name|rc
return|;
block|}
end_function

begin_function
DECL|function|ngx_http_process_request_line (ngx_http_request_t * r)
specifier|static
name|int
name|ngx_http_process_request_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|int
name|rc
decl_stmt|,
name|len
decl_stmt|;
name|char
modifier|*
modifier|*
name|request
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_log_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|rc
operator|=
name|ngx_read_http_request_line
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|c
operator|=
name|r
operator|->
name|connection
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
name|r
operator|->
name|uri
operator|.
name|len
operator|=
operator|(
name|r
operator|->
name|args_start
condition|?
name|r
operator|->
name|args_start
operator|-
literal|1
else|:
name|r
operator|->
name|uri_end
operator|)
operator|-
name|r
operator|->
name|uri_start
expr_stmt|;
name|ngx_test_null
argument_list|(
name|r
operator|->
name|uri
operator|.
name|data
argument_list|,
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|r
operator|->
name|uri
operator|.
name|len
operator|+
literal|1
argument_list|)
argument_list|,
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_cpystrn
argument_list|(
name|r
operator|->
name|uri
operator|.
name|data
argument_list|,
name|r
operator|->
name|uri_start
argument_list|,
name|r
operator|->
name|uri
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|r
operator|->
name|request_line
operator|.
name|len
operator|=
name|r
operator|->
name|request_end
operator|-
name|r
operator|->
name|header_in
operator|->
name|start
expr_stmt|;
name|ngx_test_null
argument_list|(
name|r
operator|->
name|request_line
operator|.
name|data
argument_list|,
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|r
operator|->
name|request_line
operator|.
name|len
operator|+
literal|1
argument_list|)
argument_list|,
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_cpystrn
argument_list|(
name|r
operator|->
name|request_line
operator|.
name|data
argument_list|,
name|r
operator|->
name|header_in
operator|->
name|start
argument_list|,
name|r
operator|->
name|request_line
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* TEMP */
name|ngx_test_null
argument_list|(
name|request
argument_list|,
name|ngx_push_array
argument_list|(
name|c
operator|->
name|requests
argument_list|)
argument_list|,
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|request_end
condition|)
name|len
operator|=
name|r
operator|->
name|request_end
operator|-
name|r
operator|->
name|header_in
operator|->
name|start
operator|+
literal|1
expr_stmt|;
else|else
name|len
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|requests_len
operator|+=
name|len
expr_stmt|;
name|ngx_test_null
argument_list|(
operator|*
name|request
argument_list|,
name|ngx_palloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|len
argument_list|)
argument_list|,
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_cpystrn
argument_list|(
operator|*
name|request
argument_list|,
name|r
operator|->
name|header_in
operator|->
name|start
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ngx_log_debug
argument_list|(
name|c
operator|->
name|log
argument_list|,
literal|"REQ: '%s'"
name|_
operator|*
name|request
argument_list|)
expr_stmt|;
comment|/* */
if|if
condition|(
name|r
operator|->
name|uri_ext
condition|)
block|{
name|r
operator|->
name|exten
operator|.
name|len
operator|=
operator|(
name|r
operator|->
name|args_start
condition|?
name|r
operator|->
name|args_start
operator|-
literal|1
else|:
name|r
operator|->
name|uri_end
operator|)
operator|-
name|r
operator|->
name|uri_ext
expr_stmt|;
name|ngx_test_null
argument_list|(
name|r
operator|->
name|exten
operator|.
name|data
argument_list|,
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|r
operator|->
name|exten
operator|.
name|len
operator|+
literal|1
argument_list|)
argument_list|,
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_cpystrn
argument_list|(
name|r
operator|->
name|exten
operator|.
name|data
argument_list|,
name|r
operator|->
name|uri_ext
argument_list|,
name|r
operator|->
name|exten
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block_content|ngx_log_debug(r->connection->log, "HTTP: %d, %d, %s %s" _                       r->method _ r->http_version _                       r->uri.data _ r->exten.data);
endif|#
directive|endif
if|if
condition|(
name|r
operator|->
name|http_version
operator|==
literal|9
condition|)
return|return
name|NGX_OK
return|;
comment|/* TODO: check too long URI - no space for header, compact buffer */
name|r
operator|->
name|headers_in
operator|.
name|headers
operator|=
name|ngx_create_table
argument_list|(
name|r
operator|->
name|pool
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|r
operator|->
name|state_handler
operator|=
name|ngx_http_process_request_headers
expr_stmt|;
name|ctx
operator|=
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|data
expr_stmt|;
name|ctx
operator|->
name|action
operator|=
literal|"reading client request headers"
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
if|if
condition|(
name|r
operator|->
name|header_in
operator|->
name|last
operator|.
name|mem
operator|>=
name|r
operator|->
name|header_in
operator|->
name|end
condition|)
block|{
name|rc
operator|=
name|NGX_HTTP_PARSE_TOO_LONG_URI
expr_stmt|;
block|}
if|else if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|ctx
operator|=
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|data
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
name|header_errors
index|[
name|rc
operator|-
name|NGX_HTTP_PARSE_INVALID_METHOD
index|]
argument_list|,
name|ctx
operator|->
name|client
argument_list|)
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|handler
operator|=
name|ngx_http_log_error
expr_stmt|;
return|return
name|ngx_http_error
argument_list|(
name|r
argument_list|,
operator|(
name|rc
operator|==
name|NGX_HTTP_PARSE_TOO_LONG_URI
operator|)
condition|?
name|NGX_HTTP_REQUEST_URI_TOO_LARGE
else|:
name|NGX_HTTP_BAD_REQUEST
argument_list|)
return|;
block|}
end_function

begin_function
DECL|function|ngx_http_process_request_headers (ngx_http_request_t * r)
specifier|static
name|int
name|ngx_http_process_request_headers
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|ngx_http_log_ctx_t
modifier|*
name|ctx
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|rc
operator|=
name|ngx_read_http_header_line
argument_list|(
name|r
argument_list|,
name|r
operator|->
name|header_in
argument_list|)
expr_stmt|;
comment|/* TODO: check too long header, compact buffer */
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|ngx_http_process_request_header_line
argument_list|(
name|r
argument_list|)
operator|==
name|NGX_ERROR
condition|)
return|return
name|ngx_http_error
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
return|;
block|}
if|else if
condition|(
name|rc
operator|==
name|NGX_HTTP_PARSE_HEADER_DONE
condition|)
block|{
name|ngx_log_debug
argument_list|(
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|"HTTP header done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|http_version
operator|>
name|NGX_HTTP_VERSION_10
operator|&&
name|r
operator|->
name|headers_in
operator|.
name|host
operator|==
name|NULL
condition|)
block|{
return|return
name|ngx_http_error
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NGX_OK
return|;
block|}
block|}
if|else if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
if|else if
condition|(
name|rc
operator|==
name|NGX_HTTP_PARSE_INVALID_HEADER
condition|)
block|{
name|ctx
operator|=
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|data
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client %s sent invalid header"
argument_list|,
name|ctx
operator|->
name|client
argument_list|)
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|log
operator|->
name|handler
operator|=
name|ngx_http_log_error
expr_stmt|;
return|return
name|ngx_http_error
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
return|;
block|}
block|}
block|}
end_function

begin_function
DECL|function|ngx_http_process_request_header_line (ngx_http_request_t * r)
specifier|static
name|int
name|ngx_http_process_request_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
name|ngx_test_null
argument_list|(
name|h
argument_list|,
name|ngx_push_table
argument_list|(
name|r
operator|->
name|headers_in
operator|.
name|headers
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|h
operator|->
name|key
operator|.
name|len
operator|=
name|r
operator|->
name|header_name_end
operator|-
name|r
operator|->
name|header_name_start
expr_stmt|;
name|ngx_test_null
argument_list|(
name|h
operator|->
name|key
operator|.
name|data
argument_list|,
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|h
operator|->
name|key
operator|.
name|len
operator|+
literal|1
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|ngx_cpystrn
argument_list|(
name|h
operator|->
name|key
operator|.
name|data
argument_list|,
name|r
operator|->
name|header_name_start
argument_list|,
name|h
operator|->
name|key
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|h
operator|->
name|value
operator|.
name|len
operator|=
name|r
operator|->
name|header_end
operator|-
name|r
operator|->
name|header_start
expr_stmt|;
name|ngx_test_null
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
argument_list|,
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|h
operator|->
name|value
operator|.
name|len
operator|+
literal|1
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|ngx_cpystrn
argument_list|(
name|h
operator|->
name|value
operator|.
name|data
argument_list|,
name|r
operator|->
name|header_start
argument_list|,
name|h
operator|->
name|value
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|headers_in
index|[
name|i
index|]
operator|.
name|len
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|headers_in
index|[
name|i
index|]
operator|.
name|len
operator|==
name|h
operator|->
name|key
operator|.
name|len
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|headers_in
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|h
operator|->
name|key
operator|.
name|data
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
operator|(
operator|(
name|ngx_table_elt_t
operator|*
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|r
operator|->
name|headers_in
operator|+
name|headers_in
index|[
name|i
index|]
operator|.
name|offset
operator|)
operator|)
operator|=
name|h
expr_stmt|;
block|}
block|}
block|}
name|ngx_log_debug
argument_list|(
argument|r->connection->log
argument_list|,
literal|"HTTP header: '%s: %s'"
argument|_                   h->key.data _ h->value.data
argument_list|)
empty_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
DECL|function|ngx_http_event_request_handler (ngx_http_request_t * r)
specifier|static
name|int
name|ngx_http_event_request_handler
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|ngx_msec_t
name|timeout
decl_stmt|;
name|ngx_del_timer
argument_list|(
name|r
operator|->
name|connection
operator|->
name|read
argument_list|)
expr_stmt|;
name|r
operator|->
name|header_timeout
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|state_handler
operator|=
name|NULL
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|read
operator|->
name|event_handler
operator|=
name|ngx_http_block_read
expr_stmt|;
name|rc
operator|=
name|ngx_http_handler
argument_list|(
name|r
argument_list|)
expr_stmt|;
comment|/* handler is still busy */
if|if
condition|(
name|rc
operator|==
name|NGX_WAITING
condition|)
return|return
name|rc
return|;
comment|/* handler has done its work but transfer is not completed */
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
if|#
directive|if
operator|(
name|HAVE_CLEAR_EVENT
operator|)
if|if
condition|(
name|ngx_add_event
argument_list|(
name|r
operator|->
name|connection
operator|->
name|write
argument_list|,
name|NGX_WRITE_EVENT
argument_list|,
name|NGX_CLEAR_EVENT
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
else|#
directive|else
if|if
condition|(
name|ngx_add_event
argument_list|(
name|r
operator|->
name|connection
operator|->
name|write
argument_list|,
name|NGX_WRITE_EVENT
argument_list|,
name|NGX_ONESHOT_EVENT
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
endif|#
directive|endif
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
block|}
if|if
condition|(
name|r
operator|->
name|connection
operator|->
name|sent
operator|>
literal|0
condition|)
block|{
name|ngx_log_debug
argument_list|(
argument|r->connection->log
argument_list|,
literal|"sent: "
argument|QD_FMT _                           r->connection->sent
argument_list|)
empty_stmt|;
name|timeout
operator|=
operator|(
name|ngx_msec_t
operator|)
operator|(
name|r
operator|->
name|connection
operator|->
name|sent
operator|*
literal|10
operator|)
expr_stmt|;
name|ngx_log_debug
argument_list|(
argument|r->connection->log
argument_list|,
literal|"timeout: %d"
argument|_ timeout
argument_list|)
empty_stmt|;
name|ngx_add_timer
argument_list|(
name|r
operator|->
name|connection
operator|->
name|write
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_add_timer
argument_list|(
name|r
operator|->
name|connection
operator|->
name|write
argument_list|,
literal|10000
argument_list|)
expr_stmt|;
block|}
name|r
operator|->
name|connection
operator|->
name|write
operator|->
name|event_handler
operator|=
name|ngx_http_writer
expr_stmt|;
return|return
name|rc
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
comment|/* log http request */
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
block|}
if|if
condition|(
name|rc
operator|>=
name|NGX_HTTP_SPECIAL_RESPONSE
condition|)
return|return
name|ngx_http_special_response
argument_list|(
name|r
argument_list|,
name|rc
argument_list|)
return|;
comment|/* rc == NGX_OK */
if|if
condition|(
operator|!
name|r
operator|->
name|keepalive
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|lingering_close
condition|)
block|{
return|return
name|ngx_http_set_lingering_close
argument_list|(
name|r
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
block|}
block|}
comment|/* keepalive */
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|buffer
operator|->
name|pos
operator|.
name|mem
operator|=
name|r
operator|->
name|connection
operator|->
name|buffer
operator|->
name|last
operator|.
name|mem
operator|=
name|r
operator|->
name|connection
operator|->
name|buffer
operator|->
name|start
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|read
operator|->
name|event_handler
operator|=
name|ngx_http_keepalive_handler
expr_stmt|;
block|}
DECL|function|ngx_http_writer (ngx_event_t * ev)
specifier|static
name|int
name|ngx_http_writer
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|ngx_msec_t
name|timeout
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|conf
decl_stmt|;
name|c
operator|=
operator|(
name|ngx_connection_t
operator|*
operator|)
name|ev
operator|->
name|data
expr_stmt|;
name|r
operator|=
operator|(
name|ngx_http_request_t
operator|*
operator|)
name|c
operator|->
name|data
expr_stmt|;
name|c
operator|->
name|sent
operator|=
literal|0
expr_stmt|;
name|rc
operator|=
name|ngx_http_output_filter
argument_list|(
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ngx_log_debug
argument_list|(
argument|ev->log
argument_list|,
literal|"output filter in writer: %d"
argument|_ rc
argument_list|)
empty_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|sent
operator|>
literal|0
condition|)
block|{
name|conf
operator|=
operator|(
name|ngx_http_core_loc_conf_t
operator|*
operator|)
name|ngx_get_module_loc_conf
argument_list|(
name|r
operator|->
expr|main
operator|?
name|r
operator|->
expr|main
operator|:
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|timeout
operator|=
operator|(
name|ngx_msec_t
operator|)
operator|(
name|c
operator|->
name|sent
operator|*
name|conf
operator|->
name|send_timeout
operator|)
expr_stmt|;
name|ngx_log_debug
argument_list|(
argument|ev->log
argument_list|,
literal|"sent: "
argument|QD_FMT _ c->sent
argument_list|)
empty_stmt|;
name|ngx_log_debug
argument_list|(
argument|ev->log
argument_list|,
literal|"timeout: %d"
argument|_ timeout
argument_list|)
empty_stmt|;
name|ngx_del_timer
argument_list|(
name|ev
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|ev
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ev
operator|->
name|oneshot
condition|)
if|if
condition|(
name|ngx_add_event
argument_list|(
name|r
operator|->
name|connection
operator|->
name|write
argument_list|,
name|NGX_WRITE_EVENT
argument_list|,
name|NGX_ONESHOT_EVENT
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
block|}
return|return
name|rc
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
return|return
name|rc
return|;
comment|/* rc == NGX_OK */
name|ngx_log_debug
argument_list|(
name|ev
operator|->
name|log
argument_list|,
literal|"http writer done"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
operator|->
name|keepalive
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|lingering_close
condition|)
block|{
name|ngx_http_set_lingering_close
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
block|}
block|}
comment|/* keepalive */
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|c
operator|->
name|buffer
operator|->
name|pos
operator|.
name|mem
operator|=
name|c
operator|->
name|buffer
operator|->
name|last
operator|.
name|mem
operator|=
name|c
operator|->
name|buffer
operator|->
name|start
expr_stmt|;
name|c
operator|->
name|read
operator|->
name|event_handler
operator|=
name|ngx_http_keepalive_handler
expr_stmt|;
block|}
DECL|function|ngx_http_block_read (ngx_event_t * ev)
specifier|static
name|int
name|ngx_http_block_read
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_log_debug
argument_list|(
name|ev
operator|->
name|log
argument_list|,
literal|"http read blocked"
argument_list|)
expr_stmt|;
name|ev
operator|->
name|blocked
operator|=
literal|1
expr_stmt|;
return|return
name|ngx_del_event
argument_list|(
name|ev
argument_list|,
name|NGX_READ_EVENT
argument_list|,
literal|0
argument_list|)
return|;
block|}
DECL|function|ngx_http_discard_body (ngx_http_request_t * r)
name|int
name|ngx_http_discard_body
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_log_debug
argument_list|(
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|"set discard body"
argument_list|)
expr_stmt|;
name|ngx_del_timer
argument_list|(
name|r
operator|->
name|connection
operator|->
name|read
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|client_content_length
condition|)
name|r
operator|->
name|connection
operator|->
name|read
operator|->
name|event_handler
operator|=
name|ngx_http_read_discarded_body
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
DECL|function|ngx_http_read_discarded_body (ngx_event_t * ev)
specifier|static
name|int
name|ngx_http_read_discarded_body
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|c
operator|=
operator|(
name|ngx_connection_t
operator|*
operator|)
name|ev
operator|->
name|data
expr_stmt|;
name|r
operator|=
operator|(
name|ngx_http_request_t
operator|*
operator|)
name|c
operator|->
name|data
expr_stmt|;
name|ngx_log_debug
argument_list|(
name|ev
operator|->
name|log
argument_list|,
literal|"http read discarded body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|timedout
condition|)
return|return
name|NGX_ERROR
return|;
if|if
condition|(
name|r
operator|->
name|discarded_buffer
operator|==
name|NULL
condition|)
name|ngx_test_null
argument_list|(
name|r
operator|->
name|discarded_buffer
argument_list|,
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|r
operator|->
name|server
operator|->
name|discarded_buffer_size
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
name|size
operator|=
name|r
operator|->
name|client_content_length
expr_stmt|;
if|if
condition|(
name|size
operator|>
name|r
operator|->
name|server
operator|->
name|discarded_buffer_size
condition|)
name|size
operator|=
name|r
operator|->
name|server
operator|->
name|discarded_buffer_size
expr_stmt|;
name|n
operator|=
name|ngx_event_recv
argument_list|(
name|c
argument_list|,
name|r
operator|->
name|discarded_buffer
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
return|return
name|NGX_ERROR
return|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
return|return
name|NGX_OK
return|;
name|r
operator|->
name|client_content_length
operator|-=
name|n
expr_stmt|;
comment|/* XXX: what if r->client_content_length == 0 ? */
return|return
name|NGX_OK
return|;
block|}
if|#
directive|if
literal|0
block_content|static int ngx_http_discarded_read(ngx_event_t *ev) {     ssize_t n;     ngx_connection_t    *c;     ngx_http_request_t  *r;      c = (ngx_connection_t *) ev->data;     r = (ngx_http_request_t *) c->data;      ngx_log_debug(ev->log, "http discarded read");      if (ev->timedout)         return NGX_ERROR;      if (r->discarded_buffer == NULL)         ngx_test_null(r->discarded_buffer,                       ngx_palloc(r->pool, r->server->discarded_buffer_size),                       NGX_ERROR);      n = ngx_event_recv(c, r->discarded_buffer,                        r->server->discarded_buffer_size);      return n; }
endif|#
directive|endif
DECL|function|ngx_http_keepalive_handler (ngx_event_t * ev)
specifier|static
name|int
name|ngx_http_keepalive_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ssize_t
name|n
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_log_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|c
operator|=
operator|(
name|ngx_connection_t
operator|*
operator|)
name|ev
operator|->
name|data
expr_stmt|;
name|ngx_log_debug
argument_list|(
name|ev
operator|->
name|log
argument_list|,
literal|"http keepalive handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|timedout
condition|)
return|return
name|NGX_DONE
return|;
name|n
operator|=
name|ngx_event_recv
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|buffer
operator|->
name|last
operator|.
name|mem
argument_list|,
name|c
operator|->
name|buffer
operator|->
name|end
operator|-
name|c
operator|->
name|buffer
operator|->
name|last
operator|.
name|mem
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
operator|||
name|n
operator|==
name|NGX_ERROR
condition|)
return|return
name|n
return|;
name|ctx
operator|=
operator|(
name|ngx_http_log_ctx_t
operator|*
operator|)
name|ev
operator|->
name|log
operator|->
name|data
expr_stmt|;
name|ev
operator|->
name|log
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|ev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client %s closed keepalive connection"
argument_list|,
name|ctx
operator|->
name|client
argument_list|)
expr_stmt|;
return|return
name|NGX_DONE
return|;
block|}
name|c
operator|->
name|buffer
operator|->
name|last
operator|.
name|mem
operator|+=
name|n
expr_stmt|;
name|ev
operator|->
name|log
operator|->
name|handler
operator|=
name|ngx_http_log_error
expr_stmt|;
name|ctx
operator|->
name|action
operator|=
literal|"reading client request line"
expr_stmt|;
return|return
name|ngx_http_init_request
argument_list|(
name|ev
argument_list|)
return|;
block|}
DECL|function|ngx_http_set_lingering_close (ngx_http_request_t * r)
specifier|static
name|int
name|ngx_http_set_lingering_close
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|r
operator|->
name|lingering_time
operator|=
name|ngx_time
argument_list|()
operator|+
name|r
operator|->
name|server
operator|->
name|lingering_time
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|read
operator|->
name|event_handler
operator|=
name|ngx_http_lingering_close_handler
expr_stmt|;
name|ngx_del_timer
argument_list|(
name|r
operator|->
name|connection
operator|->
name|read
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|r
operator|->
name|connection
operator|->
name|read
argument_list|,
name|r
operator|->
name|server
operator|->
name|lingering_timeout
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|HAVE_CLEAR_EVENT
operator|)
if|if
condition|(
name|ngx_add_event
argument_list|(
name|r
operator|->
name|connection
operator|->
name|read
argument_list|,
name|NGX_READ_EVENT
argument_list|,
name|NGX_CLEAR_EVENT
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
else|#
directive|else
if|if
condition|(
name|ngx_add_event
argument_list|(
name|r
operator|->
name|connection
operator|->
name|read
argument_list|,
name|NGX_READ_EVENT
argument_list|,
name|NGX_ONESHOT_EVENT
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
endif|#
directive|endif
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
block|}
if|if
condition|(
name|ngx_shutdown_socket
argument_list|(
name|r
operator|->
name|connection
operator|->
name|fd
argument_list|,
name|NGX_WRITE_SHUTDOWN
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
name|ngx_shutdown_socket_n
literal|" failed"
argument_list|)
expr_stmt|;
return|return
name|ngx_http_close_request
argument_list|(
name|r
argument_list|)
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
DECL|function|ngx_http_lingering_close_handler (ngx_event_t * ev)
specifier|static
name|int
name|ngx_http_lingering_close_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ssize_t
name|n
decl_stmt|;
name|ngx_msec_t
name|timer
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|c
operator|=
operator|(
name|ngx_connection_t
operator|*
operator|)
name|ev
operator|->
name|data
expr_stmt|;
name|r
operator|=
operator|(
name|ngx_http_request_t
operator|*
operator|)
name|c
operator|->
name|data
expr_stmt|;
name|ngx_log_debug
argument_list|(
name|ev
operator|->
name|log
argument_list|,
literal|"http lingering close handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|timedout
condition|)
return|return
name|NGX_DONE
return|;
name|timer
operator|=
name|r
operator|->
name|lingering_time
operator|-
name|ngx_time
argument_list|()
expr_stmt|;
if|if
condition|(
name|timer
operator|<=
literal|0
condition|)
return|return
name|NGX_DONE
return|;
if|if
condition|(
name|r
operator|->
name|discarded_buffer
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|r
operator|->
name|header_in
operator|->
name|end
operator|-
name|r
operator|->
name|header_in
operator|->
name|last
operator|.
name|mem
operator|>=
name|r
operator|->
name|server
operator|->
name|discarded_buffer_size
condition|)
block|{
name|r
operator|->
name|discarded_buffer
operator|=
name|r
operator|->
name|header_in
operator|->
name|last
operator|.
name|mem
expr_stmt|;
block|}
else|else
block|{
name|ngx_test_null
argument_list|(
name|r
operator|->
name|discarded_buffer
argument_list|,
name|ngx_palloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|r
operator|->
name|server
operator|->
name|discarded_buffer_size
argument_list|)
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
block|}
block|}
name|n
operator|=
name|ngx_event_recv
argument_list|(
name|c
argument_list|,
name|r
operator|->
name|discarded_buffer
argument_list|,
name|r
operator|->
name|server
operator|->
name|discarded_buffer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
return|return
name|NGX_ERROR
return|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
return|return
name|NGX_DONE
return|;
name|timer
operator|*=
literal|1000
expr_stmt|;
if|if
condition|(
name|timer
operator|>
name|r
operator|->
name|server
operator|->
name|lingering_timeout
condition|)
name|timer
operator|=
name|r
operator|->
name|server
operator|->
name|lingering_timeout
expr_stmt|;
name|ngx_del_timer
argument_list|(
name|ev
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|ev
argument_list|,
name|timer
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
DECL|function|ngx_http_close_connection (ngx_event_t * ev)
specifier|static
name|int
name|ngx_http_close_connection
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|char
modifier|*
modifier|*
name|requests
decl_stmt|,
modifier|*
name|requests_line
decl_stmt|,
modifier|*
name|prev
decl_stmt|,
modifier|*
name|new
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
init|=
operator|(
name|ngx_connection_t
operator|*
operator|)
name|ev
operator|->
name|data
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|requests
operator|->
name|nelts
operator|>
literal|1
condition|)
block|{
name|len
operator|=
name|c
operator|->
name|requests_len
operator|+
name|c
operator|->
name|requests
operator|->
name|nelts
operator|*
literal|2
operator|-
literal|1
expr_stmt|;
name|ngx_test_null
argument_list|(
name|requests_line
argument_list|,
name|ngx_palloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
name|len
argument_list|)
argument_list|,
name|ngx_event_close_connection
argument_list|(
name|ev
argument_list|)
argument_list|)
expr_stmt|;
name|requests
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|c
operator|->
name|requests
operator|->
name|elts
expr_stmt|;
name|prev
operator|=
name|requests_line
expr_stmt|;
name|new
operator|=
name|ngx_cpystrn
argument_list|(
name|prev
argument_list|,
name|requests
index|[
literal|0
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|len
operator|-=
name|new
operator|-
name|prev
expr_stmt|;
name|prev
operator|=
name|new
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|c
operator|->
name|requests
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|new
operator|=
name|ngx_cpystrn
argument_list|(
name|prev
argument_list|,
literal|", "
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|new
operator|=
name|ngx_cpystrn
argument_list|(
name|new
argument_list|,
name|requests
index|[
name|i
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|len
operator|-=
name|new
operator|-
name|prev
expr_stmt|;
name|prev
operator|=
name|new
expr_stmt|;
block|}
block|}
else|else
block|{
name|requests_line
operator|=
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|c
operator|->
name|requests
operator|->
name|elts
expr_stmt|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"REQUESTS: %d, '%s'"
argument_list|,
name|c
operator|->
name|requests
operator|->
name|nelts
argument_list|,
name|requests_line
argument_list|)
expr_stmt|;
return|return
name|ngx_event_close_connection
argument_list|(
name|ev
argument_list|)
return|;
block|}
DECL|function|ngx_http_log_error (void * data,char * buf,size_t len)
specifier|static
name|size_t
name|ngx_http_log_error
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|ngx_http_log_ctx_t
modifier|*
name|ctx
init|=
operator|(
name|ngx_http_log_ctx_t
operator|*
operator|)
name|data
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|url
condition|)
return|return
name|ngx_snprintf
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|" while %s, client: %s, URL: %s"
argument_list|,
name|ctx
operator|->
name|action
argument_list|,
name|ctx
operator|->
name|client
argument_list|,
name|ctx
operator|->
name|url
argument_list|)
return|;
else|else
return|return
name|ngx_snprintf
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|" while %s, client: %s"
argument_list|,
name|ctx
operator|->
name|action
argument_list|,
name|ctx
operator|->
name|client
argument_list|)
return|;
block|}
end_function

end_unit

