begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_decl_stmt
DECL|variable|usual
specifier|static
name|uint32_t
name|usual
index|[]
init|=
block|{
literal|0xffffdbfe
block|,
comment|/* 1111 1111 1111 1111  1101 1011 1111 1110 */
comment|/* ?>=< ;:98 7654 3210  /.-, +*)( '&%$ #"!  */
literal|0x7fff37d6
block|,
comment|/* 0111 1111 1111 1111  0011 0111 1101 0110 */
comment|/* _^]\ [ZYX WVUT SRQP  ONML KJIH GFED CBA@ */
if|#
directive|if
operator|(
name|NGX_WIN32
operator|)
literal|0xefffffff
block|,
comment|/* 1110 1111 1111 1111  1111 1111 1111 1111 */
else|#
directive|else
literal|0xffffffff
block|,
comment|/* 1111 1111 1111 1111  1111 1111 1111 1111 */
endif|#
directive|endif
comment|/*  ~}| {zyx wvut srqp  onml kjih gfed cba` */
literal|0xffffffff
block|,
comment|/* 1111 1111 1111 1111  1111 1111 1111 1111 */
literal|0xffffffff
block|,
comment|/* 1111 1111 1111 1111  1111 1111 1111 1111 */
literal|0xffffffff
block|,
comment|/* 1111 1111 1111 1111  1111 1111 1111 1111 */
literal|0xffffffff
block|,
comment|/* 1111 1111 1111 1111  1111 1111 1111 1111 */
literal|0xffffffff
comment|/* 1111 1111 1111 1111  1111 1111 1111 1111 */
block|}
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_LITTLE_ENDIAN
operator|&&
name|NGX_HAVE_NONALIGNED
operator|)
end_if

begin_define
DECL|macro|ngx_str3_cmp (m,c0,c1,c2,c3)
define|#
directive|define
name|ngx_str3_cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|)
define|\
value|*(uint32_t *) m == ((c3<< 24) | (c2<< 16) | (c1<< 8) | c0)
end_define

begin_define
DECL|macro|ngx_str3Ocmp (m,c0,c1,c2,c3)
define|#
directive|define
name|ngx_str3Ocmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|)
define|\
value|*(uint32_t *) m == ((c3<< 24) | (c2<< 16) | (c1<< 8) | c0)
end_define

begin_define
DECL|macro|ngx_str4cmp (m,c0,c1,c2,c3)
define|#
directive|define
name|ngx_str4cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|)
define|\
value|*(uint32_t *) m == ((c3<< 24) | (c2<< 16) | (c1<< 8) | c0)
end_define

begin_define
DECL|macro|ngx_str5cmp (m,c0,c1,c2,c3,c4)
define|#
directive|define
name|ngx_str5cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|)
define|\
value|*(uint32_t *) m == ((c3<< 24) | (c2<< 16) | (c1<< 8) | c0)             \&& m[4] == c4
end_define

begin_define
DECL|macro|ngx_str6cmp (m,c0,c1,c2,c3,c4,c5)
define|#
directive|define
name|ngx_str6cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|,
name|c5
parameter_list|)
define|\
value|*(uint32_t *) m == ((c3<< 24) | (c2<< 16) | (c1<< 8) | c0)             \&& (((uint32_t *) m)[1]& 0xffff) == ((c5<< 8) | c4)
end_define

begin_define
DECL|macro|ngx_str7_cmp (m,c0,c1,c2,c3,c4,c5,c6,c7)
define|#
directive|define
name|ngx_str7_cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|,
name|c5
parameter_list|,
name|c6
parameter_list|,
name|c7
parameter_list|)
define|\
value|*(uint32_t *) m == ((c3<< 24) | (c2<< 16) | (c1<< 8) | c0)             \&& ((uint32_t *) m)[1] == ((c7<< 24) | (c6<< 16) | (c5<< 8) | c4)
end_define

begin_define
DECL|macro|ngx_str8cmp (m,c0,c1,c2,c3,c4,c5,c6,c7)
define|#
directive|define
name|ngx_str8cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|,
name|c5
parameter_list|,
name|c6
parameter_list|,
name|c7
parameter_list|)
define|\
value|*(uint32_t *) m == ((c3<< 24) | (c2<< 16) | (c1<< 8) | c0)             \&& ((uint32_t *) m)[1] == ((c7<< 24) | (c6<< 16) | (c5<< 8) | c4)
end_define

begin_define
DECL|macro|ngx_str9cmp (m,c0,c1,c2,c3,c4,c5,c6,c7,c8)
define|#
directive|define
name|ngx_str9cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|,
name|c5
parameter_list|,
name|c6
parameter_list|,
name|c7
parameter_list|,
name|c8
parameter_list|)
define|\
value|*(uint32_t *) m == ((c3<< 24) | (c2<< 16) | (c1<< 8) | c0)             \&& ((uint32_t *) m)[1] == ((c7<< 24) | (c6<< 16) | (c5<< 8) | c4)  \&& m[8] == c8
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !(NGX_HAVE_LITTLE_ENDIAN&& NGX_HAVE_NONALIGNED) */
end_comment

begin_define
DECL|macro|ngx_str3_cmp (m,c0,c1,c2,c3)
define|#
directive|define
name|ngx_str3_cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|)
define|\
value|m[0] == c0&& m[1] == c1&& m[2] == c2
end_define

begin_define
DECL|macro|ngx_str3Ocmp (m,c0,c1,c2,c3)
define|#
directive|define
name|ngx_str3Ocmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|)
define|\
value|m[0] == c0&& m[2] == c2&& m[3] == c3
end_define

begin_define
DECL|macro|ngx_str4cmp (m,c0,c1,c2,c3)
define|#
directive|define
name|ngx_str4cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|)
define|\
value|m[0] == c0&& m[1] == c1&& m[2] == c2&& m[3] == c3
end_define

begin_define
DECL|macro|ngx_str5cmp (m,c0,c1,c2,c3,c4)
define|#
directive|define
name|ngx_str5cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|)
define|\
value|m[0] == c0&& m[1] == c1&& m[2] == c2&& m[3] == c3&& m[4] == c4
end_define

begin_define
DECL|macro|ngx_str6cmp (m,c0,c1,c2,c3,c4,c5)
define|#
directive|define
name|ngx_str6cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|,
name|c5
parameter_list|)
define|\
value|m[0] == c0&& m[1] == c1&& m[2] == c2&& m[3] == c3                      \&& m[4] == c4&& m[5] == c5
end_define

begin_define
DECL|macro|ngx_str7_cmp (m,c0,c1,c2,c3,c4,c5,c6,c7)
define|#
directive|define
name|ngx_str7_cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|,
name|c5
parameter_list|,
name|c6
parameter_list|,
name|c7
parameter_list|)
define|\
value|m[0] == c0&& m[1] == c1&& m[2] == c2&& m[3] == c3                      \&& m[4] == c4&& m[5] == c5&& m[6] == c6
end_define

begin_define
DECL|macro|ngx_str8cmp (m,c0,c1,c2,c3,c4,c5,c6,c7)
define|#
directive|define
name|ngx_str8cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|,
name|c5
parameter_list|,
name|c6
parameter_list|,
name|c7
parameter_list|)
define|\
value|m[0] == c0&& m[1] == c1&& m[2] == c2&& m[3] == c3                      \&& m[4] == c4&& m[5] == c5&& m[6] == c6&& m[7] == c7
end_define

begin_define
DECL|macro|ngx_str9cmp (m,c0,c1,c2,c3,c4,c5,c6,c7,c8)
define|#
directive|define
name|ngx_str9cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|,
name|c5
parameter_list|,
name|c6
parameter_list|,
name|c7
parameter_list|,
name|c8
parameter_list|)
define|\
value|m[0] == c0&& m[1] == c1&& m[2] == c2&& m[3] == c3                      \&& m[4] == c4&& m[5] == c5&& m[6] == c6&& m[7] == c7&& m[8] == c8
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* gcc, icc, msvc and others compile these switches as an jump table */
end_comment

begin_function
name|ngx_int_t
DECL|function|ngx_http_parse_request_line (ngx_http_request_t * r,ngx_buf_t * b)
name|ngx_http_parse_request_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|)
block|{
name|u_char
name|c
decl_stmt|,
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|m
decl_stmt|;
DECL|enum|__anon2a3ef87b0103
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_method
name|sw_method
block|,
DECL|enumerator|sw_spaces_before_uri
name|sw_spaces_before_uri
block|,
DECL|enumerator|sw_schema
name|sw_schema
block|,
DECL|enumerator|sw_schema_slash
name|sw_schema_slash
block|,
DECL|enumerator|sw_schema_slash_slash
name|sw_schema_slash_slash
block|,
DECL|enumerator|sw_host
name|sw_host
block|,
DECL|enumerator|sw_port
name|sw_port
block|,
DECL|enumerator|sw_after_slash_in_uri
name|sw_after_slash_in_uri
block|,
DECL|enumerator|sw_check_uri
name|sw_check_uri
block|,
DECL|enumerator|sw_uri
name|sw_uri
block|,
DECL|enumerator|sw_http_09
name|sw_http_09
block|,
DECL|enumerator|sw_http_H
name|sw_http_H
block|,
DECL|enumerator|sw_http_HT
name|sw_http_HT
block|,
DECL|enumerator|sw_http_HTT
name|sw_http_HTT
block|,
DECL|enumerator|sw_http_HTTP
name|sw_http_HTTP
block|,
DECL|enumerator|sw_first_major_digit
name|sw_first_major_digit
block|,
DECL|enumerator|sw_major_digit
name|sw_major_digit
block|,
DECL|enumerator|sw_first_minor_digit
name|sw_first_minor_digit
block|,
DECL|enumerator|sw_minor_digit
name|sw_minor_digit
block|,
DECL|enumerator|sw_spaces_after_digit
name|sw_spaces_after_digit
block|,
DECL|enumerator|sw_almost_done
name|sw_almost_done
block|}
name|state
enum|;
name|state
operator|=
name|r
operator|->
name|state
expr_stmt|;
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|b
operator|->
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
comment|/* HTTP methods: GET, HEAD, POST */
case|case
name|sw_start
case|:
name|r
operator|->
name|request_start
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ch
operator|==
name|CR
operator|||
name|ch
operator|==
name|LF
condition|)
block|{
break|break;
block|}
if|if
condition|(
operator|(
name|ch
argument_list|<
literal|'A'
operator|||
name|ch
argument_list|>
literal|'Z'
operator|)
operator|&&
name|ch
operator|!=
literal|'_'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_METHOD
return|;
block|}
name|state
operator|=
name|sw_method
expr_stmt|;
break|break;
case|case
name|sw_method
case|:
if|if
condition|(
name|ch
operator|==
literal|' '
condition|)
block|{
name|r
operator|->
name|method_end
operator|=
name|p
operator|-
literal|1
expr_stmt|;
name|m
operator|=
name|r
operator|->
name|request_start
expr_stmt|;
switch|switch
condition|(
name|p
operator|-
name|m
condition|)
block|{
case|case
literal|3
case|:
if|if
condition|(
name|ngx_str3_cmp
argument_list|(
name|m
argument_list|,
literal|'G'
argument_list|,
literal|'E'
argument_list|,
literal|'T'
argument_list|,
literal|' '
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_GET
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ngx_str3_cmp
argument_list|(
name|m
argument_list|,
literal|'P'
argument_list|,
literal|'U'
argument_list|,
literal|'T'
argument_list|,
literal|' '
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_PUT
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|4
case|:
if|if
condition|(
name|m
index|[
literal|1
index|]
operator|==
literal|'O'
condition|)
block|{
if|if
condition|(
name|ngx_str3Ocmp
argument_list|(
name|m
argument_list|,
literal|'P'
argument_list|,
literal|'O'
argument_list|,
literal|'S'
argument_list|,
literal|'T'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_POST
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ngx_str3Ocmp
argument_list|(
name|m
argument_list|,
literal|'C'
argument_list|,
literal|'O'
argument_list|,
literal|'P'
argument_list|,
literal|'Y'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_COPY
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ngx_str3Ocmp
argument_list|(
name|m
argument_list|,
literal|'M'
argument_list|,
literal|'O'
argument_list|,
literal|'V'
argument_list|,
literal|'E'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_MOVE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ngx_str3Ocmp
argument_list|(
name|m
argument_list|,
literal|'L'
argument_list|,
literal|'O'
argument_list|,
literal|'C'
argument_list|,
literal|'K'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_LOCK
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ngx_str4cmp
argument_list|(
name|m
argument_list|,
literal|'H'
argument_list|,
literal|'E'
argument_list|,
literal|'A'
argument_list|,
literal|'D'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_HEAD
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|ngx_str5cmp
argument_list|(
name|m
argument_list|,
literal|'M'
argument_list|,
literal|'K'
argument_list|,
literal|'C'
argument_list|,
literal|'O'
argument_list|,
literal|'L'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_MKCOL
expr_stmt|;
block|}
if|if
condition|(
name|ngx_str5cmp
argument_list|(
name|m
argument_list|,
literal|'P'
argument_list|,
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'C'
argument_list|,
literal|'H'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_PATCH
expr_stmt|;
block|}
if|if
condition|(
name|ngx_str5cmp
argument_list|(
name|m
argument_list|,
literal|'T'
argument_list|,
literal|'R'
argument_list|,
literal|'A'
argument_list|,
literal|'C'
argument_list|,
literal|'E'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_TRACE
expr_stmt|;
block|}
break|break;
case|case
literal|6
case|:
if|if
condition|(
name|ngx_str6cmp
argument_list|(
name|m
argument_list|,
literal|'D'
argument_list|,
literal|'E'
argument_list|,
literal|'L'
argument_list|,
literal|'E'
argument_list|,
literal|'T'
argument_list|,
literal|'E'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_DELETE
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ngx_str6cmp
argument_list|(
name|m
argument_list|,
literal|'U'
argument_list|,
literal|'N'
argument_list|,
literal|'L'
argument_list|,
literal|'O'
argument_list|,
literal|'C'
argument_list|,
literal|'K'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_UNLOCK
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|7
case|:
if|if
condition|(
name|ngx_str7_cmp
argument_list|(
name|m
argument_list|,
literal|'O'
argument_list|,
literal|'P'
argument_list|,
literal|'T'
argument_list|,
literal|'I'
argument_list|,
literal|'O'
argument_list|,
literal|'N'
argument_list|,
literal|'S'
argument_list|,
literal|' '
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_OPTIONS
expr_stmt|;
block|}
break|break;
case|case
literal|8
case|:
if|if
condition|(
name|ngx_str8cmp
argument_list|(
name|m
argument_list|,
literal|'P'
argument_list|,
literal|'R'
argument_list|,
literal|'O'
argument_list|,
literal|'P'
argument_list|,
literal|'F'
argument_list|,
literal|'I'
argument_list|,
literal|'N'
argument_list|,
literal|'D'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_PROPFIND
expr_stmt|;
block|}
break|break;
case|case
literal|9
case|:
if|if
condition|(
name|ngx_str9cmp
argument_list|(
name|m
argument_list|,
literal|'P'
argument_list|,
literal|'R'
argument_list|,
literal|'O'
argument_list|,
literal|'P'
argument_list|,
literal|'P'
argument_list|,
literal|'A'
argument_list|,
literal|'T'
argument_list|,
literal|'C'
argument_list|,
literal|'H'
argument_list|)
condition|)
block|{
name|r
operator|->
name|method
operator|=
name|NGX_HTTP_PROPPATCH
expr_stmt|;
block|}
break|break;
block|}
name|state
operator|=
name|sw_spaces_before_uri
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|ch
argument_list|<
literal|'A'
operator|||
name|ch
argument_list|>
literal|'Z'
operator|)
operator|&&
name|ch
operator|!=
literal|'_'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_METHOD
return|;
block|}
break|break;
comment|/* space* before URI */
case|case
name|sw_spaces_before_uri
case|:
if|if
condition|(
name|ch
operator|==
literal|'/'
condition|)
block|{
name|r
operator|->
name|uri_start
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_after_slash_in_uri
expr_stmt|;
break|break;
block|}
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
condition|)
block|{
name|r
operator|->
name|schema_start
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_schema
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_schema
case|:
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
condition|)
block|{
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|':'
case|:
name|r
operator|->
name|schema_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_schema_slash
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_schema_slash
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'/'
case|:
name|state
operator|=
name|sw_schema_slash_slash
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_schema_slash_slash
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'/'
case|:
name|r
operator|->
name|host_start
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|state
operator|=
name|sw_host
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_host
case|:
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
condition|)
block|{
break|break;
block|}
if|if
condition|(
operator|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
operator|)
operator|||
name|ch
operator|==
literal|'.'
operator|||
name|ch
operator|==
literal|'-'
condition|)
block|{
break|break;
block|}
name|r
operator|->
name|host_end
operator|=
name|p
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|':'
case|:
name|state
operator|=
name|sw_port
expr_stmt|;
break|break;
case|case
literal|'/'
case|:
name|r
operator|->
name|uri_start
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_after_slash_in_uri
expr_stmt|;
break|break;
case|case
literal|' '
case|:
comment|/*                  * use single "/" from request line to preserve pointers,                  * if request line will be copied to large client buffer                  */
name|r
operator|->
name|uri_start
operator|=
name|r
operator|->
name|schema_end
operator|+
literal|1
expr_stmt|;
name|r
operator|->
name|uri_end
operator|=
name|r
operator|->
name|schema_end
operator|+
literal|2
expr_stmt|;
name|state
operator|=
name|sw_http_09
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_port
case|:
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'/'
case|:
name|r
operator|->
name|port_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|uri_start
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_after_slash_in_uri
expr_stmt|;
break|break;
case|case
literal|' '
case|:
name|r
operator|->
name|port_end
operator|=
name|p
expr_stmt|;
comment|/*                  * use single "/" from request line to preserve pointers,                  * if request line will be copied to large client buffer                  */
name|r
operator|->
name|uri_start
operator|=
name|r
operator|->
name|schema_end
operator|+
literal|1
expr_stmt|;
name|r
operator|->
name|uri_end
operator|=
name|r
operator|->
name|schema_end
operator|+
literal|2
expr_stmt|;
name|state
operator|=
name|sw_http_09
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
comment|/* check "/.", "//", "%", and "\" (Win32) in URI */
case|case
name|sw_after_slash_in_uri
case|:
if|if
condition|(
name|usual
index|[
name|ch
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
name|state
operator|=
name|sw_check_uri
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_http_09
expr_stmt|;
break|break;
case|case
name|CR
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|http_minor
operator|=
literal|9
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|http_minor
operator|=
literal|9
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|'.'
case|:
name|r
operator|->
name|complex_uri
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
case|case
literal|'%'
case|:
name|r
operator|->
name|quoted_uri
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
case|case
literal|'/'
case|:
name|r
operator|->
name|complex_uri
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
if|#
directive|if
operator|(
name|NGX_WIN32
operator|)
case|case
literal|'\\'
case|:
name|r
operator|->
name|complex_uri
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'?'
case|:
name|r
operator|->
name|args_start
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
case|case
literal|'#'
case|:
name|r
operator|->
name|complex_uri
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
case|case
literal|'+'
case|:
name|r
operator|->
name|plus_in_uri
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'\0'
case|:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
default|default:
name|state
operator|=
name|sw_check_uri
expr_stmt|;
break|break;
block|}
break|break;
comment|/* check "/", "%" and "\" (Win32) in URI */
case|case
name|sw_check_uri
case|:
if|if
condition|(
name|usual
index|[
name|ch
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'/'
case|:
name|r
operator|->
name|uri_ext
operator|=
name|NULL
expr_stmt|;
name|state
operator|=
name|sw_after_slash_in_uri
expr_stmt|;
break|break;
case|case
literal|'.'
case|:
name|r
operator|->
name|uri_ext
operator|=
name|p
operator|+
literal|1
expr_stmt|;
break|break;
case|case
literal|' '
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_http_09
expr_stmt|;
break|break;
case|case
name|CR
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|http_minor
operator|=
literal|9
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|http_minor
operator|=
literal|9
expr_stmt|;
goto|goto
name|done
goto|;
if|#
directive|if
operator|(
name|NGX_WIN32
operator|)
case|case
literal|'\\'
case|:
name|r
operator|->
name|complex_uri
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_after_slash_in_uri
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'%'
case|:
name|r
operator|->
name|quoted_uri
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|r
operator|->
name|args_start
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
case|case
literal|'#'
case|:
name|r
operator|->
name|complex_uri
operator|=
literal|1
expr_stmt|;
name|state
operator|=
name|sw_uri
expr_stmt|;
break|break;
case|case
literal|'+'
case|:
name|r
operator|->
name|plus_in_uri
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'\0'
case|:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
comment|/* URI */
case|case
name|sw_uri
case|:
if|if
condition|(
name|usual
index|[
name|ch
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_http_09
expr_stmt|;
break|break;
case|case
name|CR
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|http_minor
operator|=
literal|9
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|r
operator|->
name|uri_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|http_minor
operator|=
literal|9
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|'#'
case|:
name|r
operator|->
name|complex_uri
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'\0'
case|:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
comment|/* space+ after URI */
case|case
name|sw_http_09
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
case|case
name|CR
case|:
name|r
operator|->
name|http_minor
operator|=
literal|9
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|r
operator|->
name|http_minor
operator|=
literal|9
expr_stmt|;
goto|goto
name|done
goto|;
case|case
literal|'H'
case|:
name|r
operator|->
name|http_protocol
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_http_H
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_http_H
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'T'
case|:
name|state
operator|=
name|sw_http_HT
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_http_HT
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'T'
case|:
name|state
operator|=
name|sw_http_HTT
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_http_HTT
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'P'
case|:
name|state
operator|=
name|sw_http_HTTP
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
case|case
name|sw_http_HTTP
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'/'
case|:
name|state
operator|=
name|sw_first_major_digit
expr_stmt|;
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
comment|/* first digit of major HTTP version */
case|case
name|sw_first_major_digit
case|:
if|if
condition|(
name|ch
argument_list|<
literal|'1'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|r
operator|->
name|http_major
operator|=
name|ch
operator|-
literal|'0'
expr_stmt|;
name|state
operator|=
name|sw_major_digit
expr_stmt|;
break|break;
comment|/* major HTTP version or dot */
case|case
name|sw_major_digit
case|:
if|if
condition|(
name|ch
operator|==
literal|'.'
condition|)
block|{
name|state
operator|=
name|sw_first_minor_digit
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|r
operator|->
name|http_major
operator|=
name|r
operator|->
name|http_major
operator|*
literal|10
operator|+
name|ch
operator|-
literal|'0'
expr_stmt|;
break|break;
comment|/* first digit of minor HTTP version */
case|case
name|sw_first_minor_digit
case|:
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|r
operator|->
name|http_minor
operator|=
name|ch
operator|-
literal|'0'
expr_stmt|;
name|state
operator|=
name|sw_minor_digit
expr_stmt|;
break|break;
comment|/* minor HTTP version or end of request line */
case|case
name|sw_minor_digit
case|:
if|if
condition|(
name|ch
operator|==
name|CR
condition|)
block|{
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
name|LF
condition|)
block|{
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|ch
operator|==
literal|' '
condition|)
block|{
name|state
operator|=
name|sw_spaces_after_digit
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|r
operator|->
name|http_minor
operator|=
name|r
operator|->
name|http_minor
operator|*
literal|10
operator|+
name|ch
operator|-
literal|'0'
expr_stmt|;
break|break;
case|case
name|sw_spaces_after_digit
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
case|case
name|CR
case|:
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
break|break;
comment|/* end of request line */
case|case
name|sw_almost_done
case|:
name|r
operator|->
name|request_end
operator|=
name|p
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
block|}
block|}
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|state
operator|=
name|state
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
name|done
label|:
name|b
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|request_end
operator|==
name|NULL
condition|)
block|{
name|r
operator|->
name|request_end
operator|=
name|p
expr_stmt|;
block|}
name|r
operator|->
name|http_version
operator|=
name|r
operator|->
name|http_major
operator|*
literal|1000
operator|+
name|r
operator|->
name|http_minor
expr_stmt|;
name|r
operator|->
name|state
operator|=
name|sw_start
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|http_version
operator|==
literal|9
operator|&&
name|r
operator|->
name|method
operator|!=
name|NGX_HTTP_GET
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_09_METHOD
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_parse_header_line (ngx_http_request_t * r,ngx_buf_t * b,ngx_uint_t allow_underscores)
name|ngx_http_parse_header_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_buf_t
modifier|*
name|b
parameter_list|,
name|ngx_uint_t
name|allow_underscores
parameter_list|)
block|{
name|u_char
name|c
decl_stmt|,
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|ngx_uint_t
name|hash
decl_stmt|,
name|i
decl_stmt|;
DECL|enum|__anon2a3ef87b0203
enum|enum
block|{
DECL|enumerator|sw_start
name|sw_start
init|=
literal|0
block|,
DECL|enumerator|sw_name
name|sw_name
block|,
DECL|enumerator|sw_space_before_value
name|sw_space_before_value
block|,
DECL|enumerator|sw_value
name|sw_value
block|,
DECL|enumerator|sw_space_after_value
name|sw_space_after_value
block|,
DECL|enumerator|sw_ignore_line
name|sw_ignore_line
block|,
DECL|enumerator|sw_almost_done
name|sw_almost_done
block|,
DECL|enumerator|sw_header_almost_done
name|sw_header_almost_done
block|}
name|state
enum|;
comment|/* the last '\0' is not needed because string is zero terminated */
specifier|static
name|u_char
name|lowcase
index|[]
init|=
literal|"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
literal|"\0\0\0\0\0\0\0\0\0\0\0\0\0-\0\0"
literal|"0123456789\0\0\0\0\0\0"
literal|"\0abcdefghijklmnopqrstuvwxyz\0\0\0\0\0"
literal|"\0abcdefghijklmnopqrstuvwxyz\0\0\0\0\0"
literal|"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
literal|"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
literal|"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
literal|"\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"
decl_stmt|;
name|state
operator|=
name|r
operator|->
name|state
expr_stmt|;
name|hash
operator|=
name|r
operator|->
name|header_hash
expr_stmt|;
name|i
operator|=
name|r
operator|->
name|lowcase_index
expr_stmt|;
for|for
control|(
name|p
operator|=
name|b
operator|->
name|pos
init|;
name|p
operator|<
name|b
operator|->
name|last
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
comment|/* first char */
case|case
name|sw_start
case|:
name|r
operator|->
name|header_name_start
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|invalid_header
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|CR
case|:
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_header_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|header_done
goto|;
default|default:
name|state
operator|=
name|sw_name
expr_stmt|;
name|c
operator|=
name|lowcase
index|[
name|ch
index|]
expr_stmt|;
if|if
condition|(
name|c
condition|)
block|{
name|hash
operator|=
name|ngx_hash
argument_list|(
literal|0
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|r
operator|->
name|lowcase_header
index|[
literal|0
index|]
operator|=
name|c
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|r
operator|->
name|invalid_header
operator|=
literal|1
expr_stmt|;
break|break;
block|}
break|break;
comment|/* header name */
case|case
name|sw_name
case|:
name|c
operator|=
name|lowcase
index|[
name|ch
index|]
expr_stmt|;
if|if
condition|(
name|c
condition|)
block|{
name|hash
operator|=
name|ngx_hash
argument_list|(
name|hash
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|r
operator|->
name|lowcase_header
index|[
name|i
operator|++
index|]
operator|=
name|c
expr_stmt|;
name|i
operator|&=
operator|(
name|NGX_HTTP_LC_HEADER_LEN
operator|-
literal|1
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
literal|'_'
condition|)
block|{
if|if
condition|(
name|allow_underscores
condition|)
block|{
name|hash
operator|=
name|ngx_hash
argument_list|(
name|hash
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|r
operator|->
name|lowcase_header
index|[
name|i
operator|++
index|]
operator|=
name|ch
expr_stmt|;
name|i
operator|&=
operator|(
name|NGX_HTTP_LC_HEADER_LEN
operator|-
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|->
name|invalid_header
operator|=
literal|1
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|ch
operator|==
literal|':'
condition|)
block|{
name|r
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_space_before_value
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
name|CR
condition|)
block|{
name|r
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ch
operator|==
name|LF
condition|)
block|{
name|r
operator|->
name|header_name_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* IIS may send the duplicate "HTTP/1.1 ..." lines */
if|if
condition|(
name|ch
operator|==
literal|'/'
operator|&&
name|r
operator|->
name|upstream
operator|&&
name|p
operator|-
name|r
operator|->
name|header_name_start
operator|==
literal|4
operator|&&
name|ngx_strncmp
argument_list|(
name|r
operator|->
name|header_name_start
argument_list|,
literal|"HTTP"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|state
operator|=
name|sw_ignore_line
expr_stmt|;
break|break;
block|}
name|r
operator|->
name|invalid_header
operator|=
literal|1
expr_stmt|;
break|break;
comment|/* space* before header value */
case|case
name|sw_space_before_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
case|case
name|CR
case|:
name|r
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|r
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
default|default:
name|r
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
block|}
break|break;
comment|/* header value */
case|case
name|sw_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_space_after_value
expr_stmt|;
break|break;
case|case
name|CR
case|:
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
goto|goto
name|done
goto|;
block|}
break|break;
comment|/* space* before end of header line */
case|case
name|sw_space_after_value
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|' '
case|:
break|break;
case|case
name|CR
case|:
name|state
operator|=
name|sw_almost_done
expr_stmt|;
break|break;
case|case
name|LF
case|:
goto|goto
name|done
goto|;
default|default:
name|state
operator|=
name|sw_value
expr_stmt|;
break|break;
block|}
break|break;
comment|/* ignore header line */
case|case
name|sw_ignore_line
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
name|state
operator|=
name|sw_start
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
comment|/* end of header line */
case|case
name|sw_almost_done
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
goto|goto
name|done
goto|;
case|case
name|CR
case|:
break|break;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
break|break;
comment|/* end of header */
case|case
name|sw_header_almost_done
case|:
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|LF
case|:
goto|goto
name|header_done
goto|;
default|default:
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
block|}
block|}
name|b
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|state
operator|=
name|state
expr_stmt|;
name|r
operator|->
name|header_hash
operator|=
name|hash
expr_stmt|;
name|r
operator|->
name|lowcase_index
operator|=
name|i
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
name|done
label|:
name|b
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|r
operator|->
name|state
operator|=
name|sw_start
expr_stmt|;
name|r
operator|->
name|header_hash
operator|=
name|hash
expr_stmt|;
name|r
operator|->
name|lowcase_index
operator|=
name|i
expr_stmt|;
return|return
name|NGX_OK
return|;
name|header_done
label|:
name|b
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
name|r
operator|->
name|state
operator|=
name|sw_start
expr_stmt|;
return|return
name|NGX_HTTP_PARSE_HEADER_DONE
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_parse_complex_uri (ngx_http_request_t * r,ngx_uint_t merge_slashes)
name|ngx_http_parse_complex_uri
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_uint_t
name|merge_slashes
parameter_list|)
block|{
name|u_char
name|c
decl_stmt|,
name|ch
decl_stmt|,
name|decoded
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|u
decl_stmt|;
DECL|enum|__anon2a3ef87b0303
enum|enum
block|{
DECL|enumerator|sw_usual
name|sw_usual
init|=
literal|0
block|,
DECL|enumerator|sw_slash
name|sw_slash
block|,
DECL|enumerator|sw_dot
name|sw_dot
block|,
DECL|enumerator|sw_dot_dot
name|sw_dot_dot
block|,
DECL|enumerator|sw_quoted
name|sw_quoted
block|,
DECL|enumerator|sw_quoted_second
name|sw_quoted_second
block|}
name|state
enum|,
name|quoted_state
enum|;
if|#
directive|if
operator|(
name|NGX_SUPPRESS_WARN
operator|)
name|decoded
operator|=
literal|'\0'
expr_stmt|;
name|quoted_state
operator|=
name|sw_usual
expr_stmt|;
endif|#
directive|endif
name|state
operator|=
name|sw_usual
expr_stmt|;
name|p
operator|=
name|r
operator|->
name|uri_start
expr_stmt|;
name|u
operator|=
name|r
operator|->
name|uri
operator|.
name|data
expr_stmt|;
name|r
operator|->
name|uri_ext
operator|=
name|NULL
expr_stmt|;
name|r
operator|->
name|args_start
operator|=
name|NULL
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
while|while
condition|(
name|p
operator|<=
name|r
operator|->
name|uri_end
condition|)
block|{
comment|/*          * we use "ch = *p++" inside the cycle, but this operation is safe,          * because after the URI there is always at least one charcter:          * the line feed          */
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"s:%d in:'%Xd:%c', out:'%c'"
argument_list|,
name|state
argument_list|,
name|ch
argument_list|,
name|ch
argument_list|,
operator|*
name|u
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|sw_usual
case|:
if|if
condition|(
name|usual
index|[
name|ch
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_WIN32
operator|)
case|case
literal|'\\'
case|:
name|r
operator|->
name|uri_ext
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|r
operator|->
name|uri_start
operator|+
name|r
operator|->
name|uri
operator|.
name|len
condition|)
block|{
comment|/*                      * we omit the last "\" to cause redirect because                      * the browsers do not treat "\" as "/" in relative URL path                      */
break|break;
block|}
name|state
operator|=
name|sw_slash
expr_stmt|;
operator|*
name|u
operator|++
operator|=
literal|'/'
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
literal|'/'
case|:
name|r
operator|->
name|uri_ext
operator|=
name|NULL
expr_stmt|;
name|state
operator|=
name|sw_slash
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
break|break;
case|case
literal|'%'
case|:
name|quoted_state
operator|=
name|state
expr_stmt|;
name|state
operator|=
name|sw_quoted
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|r
operator|->
name|args_start
operator|=
name|p
expr_stmt|;
goto|goto
name|args
goto|;
case|case
literal|'#'
case|:
goto|goto
name|done
goto|;
case|case
literal|'.'
case|:
name|r
operator|->
name|uri_ext
operator|=
name|u
operator|+
literal|1
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
break|break;
case|case
literal|'+'
case|:
name|r
operator|->
name|plus_in_uri
operator|=
literal|1
expr_stmt|;
default|default:
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
break|break;
block|}
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
case|case
name|sw_slash
case|:
if|if
condition|(
name|usual
index|[
name|ch
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
name|state
operator|=
name|sw_usual
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_WIN32
operator|)
case|case
literal|'\\'
case|:
break|break;
endif|#
directive|endif
case|case
literal|'/'
case|:
if|if
condition|(
operator|!
name|merge_slashes
condition|)
block|{
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
block|}
break|break;
case|case
literal|'.'
case|:
name|state
operator|=
name|sw_dot
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
break|break;
case|case
literal|'%'
case|:
name|quoted_state
operator|=
name|state
expr_stmt|;
name|state
operator|=
name|sw_quoted
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|r
operator|->
name|args_start
operator|=
name|p
expr_stmt|;
goto|goto
name|args
goto|;
case|case
literal|'#'
case|:
goto|goto
name|done
goto|;
case|case
literal|'+'
case|:
name|r
operator|->
name|plus_in_uri
operator|=
literal|1
expr_stmt|;
default|default:
name|state
operator|=
name|sw_usual
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
break|break;
block|}
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
case|case
name|sw_dot
case|:
if|if
condition|(
name|usual
index|[
name|ch
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
name|state
operator|=
name|sw_usual
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_WIN32
operator|)
case|case
literal|'\\'
case|:
endif|#
directive|endif
case|case
literal|'/'
case|:
name|state
operator|=
name|sw_slash
expr_stmt|;
name|u
operator|--
expr_stmt|;
break|break;
case|case
literal|'.'
case|:
name|state
operator|=
name|sw_dot_dot
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
break|break;
case|case
literal|'%'
case|:
name|quoted_state
operator|=
name|state
expr_stmt|;
name|state
operator|=
name|sw_quoted
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|r
operator|->
name|args_start
operator|=
name|p
expr_stmt|;
goto|goto
name|args
goto|;
case|case
literal|'#'
case|:
goto|goto
name|done
goto|;
case|case
literal|'+'
case|:
name|r
operator|->
name|plus_in_uri
operator|=
literal|1
expr_stmt|;
default|default:
name|state
operator|=
name|sw_usual
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
break|break;
block|}
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
case|case
name|sw_dot_dot
case|:
if|if
condition|(
name|usual
index|[
name|ch
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
name|state
operator|=
name|sw_usual
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_WIN32
operator|)
case|case
literal|'\\'
case|:
endif|#
directive|endif
case|case
literal|'/'
case|:
name|state
operator|=
name|sw_slash
expr_stmt|;
name|u
operator|-=
literal|5
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|u
operator|<
name|r
operator|->
name|uri
operator|.
name|data
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
if|if
condition|(
operator|*
name|u
operator|==
literal|'/'
condition|)
block|{
name|u
operator|++
expr_stmt|;
break|break;
block|}
name|u
operator|--
expr_stmt|;
block|}
break|break;
case|case
literal|'%'
case|:
name|quoted_state
operator|=
name|state
expr_stmt|;
name|state
operator|=
name|sw_quoted
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
name|r
operator|->
name|args_start
operator|=
name|p
expr_stmt|;
goto|goto
name|args
goto|;
case|case
literal|'#'
case|:
goto|goto
name|done
goto|;
case|case
literal|'+'
case|:
name|r
operator|->
name|plus_in_uri
operator|=
literal|1
expr_stmt|;
default|default:
name|state
operator|=
name|sw_usual
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
break|break;
block|}
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
case|case
name|sw_quoted
case|:
name|r
operator|->
name|quoted_uri
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
name|decoded
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
name|state
operator|=
name|sw_quoted_second
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'f'
condition|)
block|{
name|decoded
operator|=
operator|(
name|u_char
operator|)
operator|(
name|c
operator|-
literal|'a'
operator|+
literal|10
operator|)
expr_stmt|;
name|state
operator|=
name|sw_quoted_second
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
case|case
name|sw_quoted_second
case|:
if|if
condition|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
condition|)
block|{
name|ch
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|decoded
operator|<<
literal|4
operator|)
operator|+
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'%'
operator|||
name|ch
operator|==
literal|'#'
condition|)
block|{
name|state
operator|=
name|sw_usual
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
if|else if
condition|(
name|ch
operator|==
literal|'\0'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|state
operator|=
name|quoted_state
expr_stmt|;
break|break;
block|}
name|c
operator|=
operator|(
name|u_char
operator|)
operator|(
name|ch
operator||
literal|0x20
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'f'
condition|)
block|{
name|ch
operator|=
operator|(
name|u_char
operator|)
operator|(
operator|(
name|decoded
operator|<<
literal|4
operator|)
operator|+
name|c
operator|-
literal|'a'
operator|+
literal|10
operator|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'?'
condition|)
block|{
name|state
operator|=
name|sw_usual
expr_stmt|;
operator|*
name|u
operator|++
operator|=
name|ch
expr_stmt|;
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
break|break;
block|}
if|else if
condition|(
name|ch
operator|==
literal|'+'
condition|)
block|{
name|r
operator|->
name|plus_in_uri
operator|=
literal|1
expr_stmt|;
block|}
name|state
operator|=
name|quoted_state
expr_stmt|;
break|break;
block|}
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
block|}
name|done
label|:
name|r
operator|->
name|uri
operator|.
name|len
operator|=
name|u
operator|-
name|r
operator|->
name|uri
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|uri_ext
condition|)
block|{
name|r
operator|->
name|exten
operator|.
name|len
operator|=
name|u
operator|-
name|r
operator|->
name|uri_ext
expr_stmt|;
name|r
operator|->
name|exten
operator|.
name|data
operator|=
name|r
operator|->
name|uri_ext
expr_stmt|;
block|}
name|r
operator|->
name|uri_ext
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_OK
return|;
name|args
label|:
while|while
condition|(
name|p
operator|<
name|r
operator|->
name|uri_end
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|++
operator|!=
literal|'#'
condition|)
block|{
continue|continue;
block|}
name|r
operator|->
name|args
operator|.
name|len
operator|=
name|p
operator|-
literal|1
operator|-
name|r
operator|->
name|args_start
expr_stmt|;
name|r
operator|->
name|args
operator|.
name|data
operator|=
name|r
operator|->
name|args_start
expr_stmt|;
name|r
operator|->
name|args_start
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
name|r
operator|->
name|uri
operator|.
name|len
operator|=
name|u
operator|-
name|r
operator|->
name|uri
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|uri_ext
condition|)
block|{
name|r
operator|->
name|exten
operator|.
name|len
operator|=
name|u
operator|-
name|r
operator|->
name|uri_ext
expr_stmt|;
name|r
operator|->
name|exten
operator|.
name|data
operator|=
name|r
operator|->
name|uri_ext
expr_stmt|;
block|}
name|r
operator|->
name|uri_ext
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_parse_unsafe_uri (ngx_http_request_t * r,ngx_str_t * uri,ngx_str_t * args,ngx_uint_t * flags)
name|ngx_http_parse_unsafe_uri
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|uri
parameter_list|,
name|ngx_str_t
modifier|*
name|args
parameter_list|,
name|ngx_uint_t
modifier|*
name|flags
parameter_list|)
block|{
name|u_char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|len
operator|=
name|uri
operator|->
name|len
expr_stmt|;
name|p
operator|=
name|uri
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
operator|||
name|p
index|[
literal|0
index|]
operator|==
literal|'?'
condition|)
block|{
goto|goto
name|unsafe
goto|;
block|}
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|len
operator|==
literal|3
operator|&&
name|p
index|[
literal|1
index|]
operator|==
literal|'.'
operator|&&
operator|(
name|ngx_path_separator
argument_list|(
name|p
index|[
literal|2
index|]
argument_list|)
operator|)
condition|)
block|{
goto|goto
name|unsafe
goto|;
block|}
for|for
control|(
comment|/* void */
init|;
name|len
condition|;
name|len
operator|--
control|)
block|{
name|ch
operator|=
operator|*
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|usual
index|[
name|ch
operator|>>
literal|5
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|ch
operator|&
literal|0x1f
operator|)
operator|)
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|ch
operator|==
literal|'?'
condition|)
block|{
name|args
operator|->
name|len
operator|=
name|len
operator|-
literal|1
expr_stmt|;
name|args
operator|->
name|data
operator|=
name|p
expr_stmt|;
name|uri
operator|->
name|len
operator|-=
name|len
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|ch
operator|==
literal|'\0'
condition|)
block|{
goto|goto
name|unsafe
goto|;
block|}
if|if
condition|(
name|ngx_path_separator
argument_list|(
name|ch
argument_list|)
operator|&&
name|len
operator|>
literal|2
condition|)
block|{
comment|/* detect "/../" */
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|'.'
operator|&&
name|p
index|[
literal|1
index|]
operator|==
literal|'.'
operator|&&
name|ngx_path_separator
argument_list|(
name|p
index|[
literal|2
index|]
argument_list|)
condition|)
block|{
goto|goto
name|unsafe
goto|;
block|}
block|}
block|}
return|return
name|NGX_OK
return|;
name|unsafe
label|:
if|if
condition|(
operator|*
name|flags
operator|&
name|NGX_HTTP_LOG_UNSAFE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unsafe URI \"%V\" was detected"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_ERROR
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_parse_multi_header_lines (ngx_array_t * headers,ngx_str_t * name,ngx_str_t * value)
name|ngx_http_parse_multi_header_lines
parameter_list|(
name|ngx_array_t
modifier|*
name|headers
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_str_t
modifier|*
name|value
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|u_char
modifier|*
name|start
decl_stmt|,
modifier|*
name|last
decl_stmt|,
modifier|*
name|end
decl_stmt|,
name|ch
decl_stmt|;
name|ngx_table_elt_t
modifier|*
modifier|*
name|h
decl_stmt|;
name|h
operator|=
name|headers
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|headers
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|headers
operator|->
name|pool
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"parse header: \"%V: %V\""
argument_list|,
operator|&
name|h
index|[
name|i
index|]
operator|->
name|key
argument_list|,
operator|&
name|h
index|[
name|i
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|->
name|len
operator|>
name|h
index|[
name|i
index|]
operator|->
name|value
operator|.
name|len
condition|)
block|{
continue|continue;
block|}
name|start
operator|=
name|h
index|[
name|i
index|]
operator|->
name|value
operator|.
name|data
expr_stmt|;
name|end
operator|=
name|h
index|[
name|i
index|]
operator|->
name|value
operator|.
name|data
operator|+
name|h
index|[
name|i
index|]
operator|->
name|value
operator|.
name|len
expr_stmt|;
while|while
condition|(
name|start
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|ngx_strncasecmp
argument_list|(
name|start
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|skip
goto|;
block|}
for|for
control|(
name|start
operator|+=
name|name
operator|->
name|len
init|;
name|start
operator|<
name|end
operator|&&
operator|*
name|start
operator|==
literal|' '
condition|;
name|start
operator|++
control|)
block|{
comment|/* void */
block|}
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|start
operator|==
name|end
operator|||
operator|*
name|start
operator|==
literal|','
condition|)
block|{
return|return
name|i
return|;
block|}
goto|goto
name|skip
goto|;
block|}
if|if
condition|(
name|start
operator|==
name|end
operator|||
operator|*
name|start
operator|++
operator|!=
literal|'='
condition|)
block|{
comment|/* the invalid header value */
goto|goto
name|skip
goto|;
block|}
while|while
condition|(
name|start
operator|<
name|end
operator|&&
operator|*
name|start
operator|==
literal|' '
condition|)
block|{
name|start
operator|++
expr_stmt|;
block|}
for|for
control|(
name|last
operator|=
name|start
init|;
name|last
operator|<
name|end
operator|&&
operator|*
name|last
operator|!=
literal|';'
condition|;
name|last
operator|++
control|)
block|{
comment|/* void */
block|}
name|value
operator|->
name|len
operator|=
name|last
operator|-
name|start
expr_stmt|;
name|value
operator|->
name|data
operator|=
name|start
expr_stmt|;
return|return
name|i
return|;
name|skip
label|:
while|while
condition|(
name|start
operator|<
name|end
condition|)
block|{
name|ch
operator|=
operator|*
name|start
operator|++
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|';'
operator|||
name|ch
operator|==
literal|','
condition|)
block|{
break|break;
block|}
block|}
while|while
condition|(
name|start
operator|<
name|end
operator|&&
operator|*
name|start
operator|==
literal|' '
condition|)
block|{
name|start
operator|++
expr_stmt|;
block|}
block|}
block|}
return|return
name|NGX_DECLINED
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_arg (ngx_http_request_t * r,u_char * name,size_t len,ngx_str_t * value)
name|ngx_http_arg
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|name
parameter_list|,
name|size_t
name|len
parameter_list|,
name|ngx_str_t
modifier|*
name|value
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|args
operator|.
name|len
operator|==
literal|0
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
name|p
operator|=
name|r
operator|->
name|args
operator|.
name|data
expr_stmt|;
name|last
operator|=
name|p
operator|+
name|r
operator|->
name|args
operator|.
name|len
expr_stmt|;
for|for
control|(
comment|/* void */
init|;
name|p
operator|<
name|last
condition|;
name|p
operator|++
control|)
block|{
comment|/* we need '=' after name, so drop one char from last */
name|p
operator|=
name|ngx_strlcasestrn
argument_list|(
name|p
argument_list|,
name|last
operator|-
literal|1
argument_list|,
name|name
argument_list|,
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
if|if
condition|(
operator|(
name|p
operator|==
name|r
operator|->
name|args
operator|.
name|data
operator|||
operator|*
operator|(
name|p
operator|-
literal|1
operator|)
operator|==
literal|'&'
operator|)
operator|&&
operator|*
operator|(
name|p
operator|+
name|len
operator|)
operator|==
literal|'='
condition|)
block|{
name|value
operator|->
name|data
operator|=
name|p
operator|+
name|len
operator|+
literal|1
expr_stmt|;
name|p
operator|=
name|ngx_strlchr
argument_list|(
name|p
argument_list|,
name|last
argument_list|,
literal|'&'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|p
operator|=
name|r
operator|->
name|args
operator|.
name|data
operator|+
name|r
operator|->
name|args
operator|.
name|len
expr_stmt|;
block|}
name|value
operator|->
name|len
operator|=
name|p
operator|-
name|value
operator|->
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
block|}
return|return
name|NGX_DECLINED
return|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_split_args (ngx_http_request_t * r,ngx_str_t * uri,ngx_str_t * args)
name|ngx_http_split_args
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|uri
parameter_list|,
name|ngx_str_t
modifier|*
name|args
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|last
operator|=
name|uri
operator|->
name|data
operator|+
name|uri
operator|->
name|len
expr_stmt|;
name|p
operator|=
name|ngx_strlchr
argument_list|(
name|uri
operator|->
name|data
argument_list|,
name|last
argument_list|,
literal|'?'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|uri
operator|->
name|len
operator|=
name|p
operator|-
name|uri
operator|->
name|data
expr_stmt|;
name|p
operator|++
expr_stmt|;
name|args
operator|->
name|len
operator|=
name|last
operator|-
name|p
expr_stmt|;
name|args
operator|->
name|data
operator|=
name|p
expr_stmt|;
block|}
else|else
block|{
name|args
operator|->
name|len
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

end_unit

