begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Nginx, Inc.  * Copyright (C) Valentin V. Bartenev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http_spdy_module.h>
end_include

begin_include
include|#
directive|include
file|<zlib.h>
end_include

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_LITTLE_ENDIAN
operator|&&
name|NGX_HAVE_NONALIGNED
operator|)
end_if

begin_define
DECL|macro|ngx_str5cmp (m,c0,c1,c2,c3,c4)
define|#
directive|define
name|ngx_str5cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|)
define|\
value|*(uint32_t *) m == (c3<< 24 | c2<< 16 | c1<< 8 | c0)                   \&& m[4] == c4
end_define

begin_else
else|#
directive|else
end_else

begin_define
DECL|macro|ngx_str5cmp (m,c0,c1,c2,c3,c4)
define|#
directive|define
name|ngx_str5cmp
parameter_list|(
name|m
parameter_list|,
name|c0
parameter_list|,
name|c1
parameter_list|,
name|c2
parameter_list|,
name|c3
parameter_list|,
name|c4
parameter_list|)
define|\
value|m[0] == c0&& m[1] == c1&& m[2] == c2&& m[3] == c3&& m[4] == c4
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_NONALIGNED
operator|)
end_if

begin_define
DECL|macro|ngx_spdy_frame_parse_uint16 (p)
define|#
directive|define
name|ngx_spdy_frame_parse_uint16
parameter_list|(
name|p
parameter_list|)
value|ntohs(*(uint16_t *) (p))
end_define

begin_define
DECL|macro|ngx_spdy_frame_parse_uint32 (p)
define|#
directive|define
name|ngx_spdy_frame_parse_uint32
parameter_list|(
name|p
parameter_list|)
value|ntohl(*(uint32_t *) (p))
end_define

begin_else
else|#
directive|else
end_else

begin_define
DECL|macro|ngx_spdy_frame_parse_uint16 (p)
define|#
directive|define
name|ngx_spdy_frame_parse_uint16
parameter_list|(
name|p
parameter_list|)
value|((p)[0]<< 8 | (p)[1])
end_define

begin_define
DECL|macro|ngx_spdy_frame_parse_uint32 (p)
define|#
directive|define
name|ngx_spdy_frame_parse_uint32
parameter_list|(
name|p
parameter_list|)
define|\
value|((p)[0]<< 24 | (p)[1]<< 16 | (p)[2]<< 8 | (p)[3])
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
DECL|macro|ngx_spdy_frame_parse_sid (p)
define|#
directive|define
name|ngx_spdy_frame_parse_sid
parameter_list|(
name|p
parameter_list|)
define|\
value|(ngx_spdy_frame_parse_uint32(p)& 0x7fffffff)
end_define

begin_define
DECL|macro|ngx_spdy_frame_parse_delta (p)
define|#
directive|define
name|ngx_spdy_frame_parse_delta
parameter_list|(
name|p
parameter_list|)
define|\
value|(ngx_spdy_frame_parse_uint32(p)& 0x7fffffff)
end_define

begin_define
DECL|macro|ngx_spdy_ctl_frame_check (h)
define|#
directive|define
name|ngx_spdy_ctl_frame_check
parameter_list|(
name|h
parameter_list|)
define|\
value|(((h)& 0xffffff00) == ngx_spdy_ctl_frame_head(0))
end_define

begin_define
DECL|macro|ngx_spdy_data_frame_check (h)
define|#
directive|define
name|ngx_spdy_data_frame_check
parameter_list|(
name|h
parameter_list|)
define|\
value|(!((h)& (uint32_t) NGX_SPDY_CTL_BIT<< 31))
end_define

begin_define
DECL|macro|ngx_spdy_ctl_frame_type (h)
define|#
directive|define
name|ngx_spdy_ctl_frame_type
parameter_list|(
name|h
parameter_list|)
value|((h)& 0x000000ff)
end_define

begin_define
DECL|macro|ngx_spdy_frame_flags (p)
define|#
directive|define
name|ngx_spdy_frame_flags
parameter_list|(
name|p
parameter_list|)
value|((p)>> 24)
end_define

begin_define
DECL|macro|ngx_spdy_frame_length (p)
define|#
directive|define
name|ngx_spdy_frame_length
parameter_list|(
name|p
parameter_list|)
value|((p)& 0x00ffffff)
end_define

begin_define
DECL|macro|ngx_spdy_frame_id (p)
define|#
directive|define
name|ngx_spdy_frame_id
parameter_list|(
name|p
parameter_list|)
value|((p)& 0x00ffffff)
end_define

begin_define
DECL|macro|NGX_SPDY_SKIP_HEADERS_BUFFER_SIZE
define|#
directive|define
name|NGX_SPDY_SKIP_HEADERS_BUFFER_SIZE
value|4096
end_define

begin_define
DECL|macro|NGX_SPDY_CTL_FRAME_BUFFER_SIZE
define|#
directive|define
name|NGX_SPDY_CTL_FRAME_BUFFER_SIZE
value|16
end_define

begin_define
DECL|macro|NGX_SPDY_PROTOCOL_ERROR
define|#
directive|define
name|NGX_SPDY_PROTOCOL_ERROR
value|1
end_define

begin_define
DECL|macro|NGX_SPDY_INVALID_STREAM
define|#
directive|define
name|NGX_SPDY_INVALID_STREAM
value|2
end_define

begin_define
DECL|macro|NGX_SPDY_REFUSED_STREAM
define|#
directive|define
name|NGX_SPDY_REFUSED_STREAM
value|3
end_define

begin_define
DECL|macro|NGX_SPDY_UNSUPPORTED_VERSION
define|#
directive|define
name|NGX_SPDY_UNSUPPORTED_VERSION
value|4
end_define

begin_define
DECL|macro|NGX_SPDY_CANCEL
define|#
directive|define
name|NGX_SPDY_CANCEL
value|5
end_define

begin_define
DECL|macro|NGX_SPDY_INTERNAL_ERROR
define|#
directive|define
name|NGX_SPDY_INTERNAL_ERROR
value|6
end_define

begin_define
DECL|macro|NGX_SPDY_FLOW_CONTROL_ERROR
define|#
directive|define
name|NGX_SPDY_FLOW_CONTROL_ERROR
value|7
end_define

begin_define
DECL|macro|NGX_SPDY_STREAM_IN_USE
define|#
directive|define
name|NGX_SPDY_STREAM_IN_USE
value|8
end_define

begin_define
DECL|macro|NGX_SPDY_STREAM_ALREADY_CLOSED
define|#
directive|define
name|NGX_SPDY_STREAM_ALREADY_CLOSED
value|9
end_define

begin_comment
comment|/* deprecated                              10 */
end_comment

begin_define
DECL|macro|NGX_SPDY_FRAME_TOO_LARGE
define|#
directive|define
name|NGX_SPDY_FRAME_TOO_LARGE
value|11
end_define

begin_define
DECL|macro|NGX_SPDY_SETTINGS_MAX_STREAMS
define|#
directive|define
name|NGX_SPDY_SETTINGS_MAX_STREAMS
value|4
end_define

begin_define
DECL|macro|NGX_SPDY_SETTINGS_INIT_WINDOW
define|#
directive|define
name|NGX_SPDY_SETTINGS_INIT_WINDOW
value|7
end_define

begin_define
DECL|macro|NGX_SPDY_SETTINGS_FLAG_PERSIST
define|#
directive|define
name|NGX_SPDY_SETTINGS_FLAG_PERSIST
value|0x01
end_define

begin_define
DECL|macro|NGX_SPDY_SETTINGS_FLAG_PERSISTED
define|#
directive|define
name|NGX_SPDY_SETTINGS_FLAG_PERSISTED
value|0x02
end_define

begin_define
DECL|macro|NGX_SPDY_MAX_WINDOW
define|#
directive|define
name|NGX_SPDY_MAX_WINDOW
value|NGX_MAX_INT32_VALUE
end_define

begin_define
DECL|macro|NGX_SPDY_CONNECTION_WINDOW
define|#
directive|define
name|NGX_SPDY_CONNECTION_WINDOW
value|65536
end_define

begin_define
DECL|macro|NGX_SPDY_INIT_STREAM_WINDOW
define|#
directive|define
name|NGX_SPDY_INIT_STREAM_WINDOW
value|65536
end_define

begin_define
DECL|macro|NGX_SPDY_STREAM_WINDOW
define|#
directive|define
name|NGX_SPDY_STREAM_WINDOW
value|NGX_SPDY_MAX_WINDOW
end_define

begin_typedef
DECL|struct|__anon2b38ba1c0108
typedef|typedef
struct|struct
block|{
DECL|member|hash
name|ngx_uint_t
name|hash
decl_stmt|;
DECL|member|len
name|u_char
name|len
decl_stmt|;
DECL|member|header
name|u_char
name|header
index|[
literal|7
index|]
decl_stmt|;
DECL|member|handler
name|ngx_int_t
function_decl|(
modifier|*
name|handler
function_decl|)
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
DECL|typedef|ngx_http_spdy_request_header_t
block|}
name|ngx_http_spdy_request_header_t
typedef|;
end_typedef

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_read_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_write_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_handle_connection
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_head
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_syn_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_headers
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_headers_error
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_headers_skip
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_window_update
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_data
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_read_data
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_rst_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_ping
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_skip
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_settings
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_complete
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_save
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|,
name|ngx_http_spdy_handler_pt
name|handler
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_protocol_error
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_spdy_state_internal_error
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_send_window_update
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_uint_t
name|sid
parameter_list|,
name|ngx_uint_t
name|delta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_send_rst_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_uint_t
name|sid
parameter_list|,
name|ngx_uint_t
name|status
parameter_list|,
name|ngx_uint_t
name|priority
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_send_settings
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_settings_frame_handler
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_spdy_out_frame_t
modifier|*
name|ngx_http_spdy_get_ctl_frame
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|size_t
name|size
parameter_list|,
name|ngx_uint_t
name|priority
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_ctl_frame_handler
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_spdy_stream_t
modifier|*
name|ngx_http_spdy_create_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_uint_t
name|id
parameter_list|,
name|ngx_uint_t
name|priority
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_spdy_stream_t
modifier|*
name|ngx_http_spdy_get_stream_by_id
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_uint_t
name|sid
parameter_list|)
function_decl|;
end_function_decl

begin_define
DECL|macro|ngx_http_spdy_streams_index_size (sscf)
define|#
directive|define
name|ngx_http_spdy_streams_index_size
parameter_list|(
name|sscf
parameter_list|)
value|(sscf->streams_index_mask + 1)
end_define

begin_define
DECL|macro|ngx_http_spdy_stream_index (sscf,sid)
define|#
directive|define
name|ngx_http_spdy_stream_index
parameter_list|(
name|sscf
parameter_list|,
name|sid
parameter_list|)
define|\
value|((sid>> 1)& sscf->streams_index_mask)
end_define

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_parse_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_alloc_large_header_buffer
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_handle_request_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_parse_method
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_parse_scheme
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_parse_host
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_parse_path
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_parse_version
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_construct_request_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_run_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_init_request_body
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_terminate_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_http_spdy_stream_t
modifier|*
name|stream
parameter_list|,
name|ngx_uint_t
name|status
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_close_stream_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_handle_connection_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_keepalive_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_finalize_connection
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_int_t
name|rc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_spdy_adjust_windows
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ssize_t
name|delta
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_pool_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
modifier|*
name|ngx_http_spdy_zalloc
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|u_int
name|items
parameter_list|,
name|u_int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_spdy_zfree
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|void
modifier|*
name|address
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_http_spdy_dict
specifier|static
specifier|const
name|u_char
name|ngx_http_spdy_dict
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x07
block|,
literal|0x6f
block|,
literal|0x70
block|,
literal|0x74
block|,
literal|0x69
block|,
comment|/* - - - - o p t i */
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x73
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x04
block|,
literal|0x68
block|,
comment|/* o n s - - - - h */
literal|0x65
block|,
literal|0x61
block|,
literal|0x64
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x04
block|,
literal|0x70
block|,
comment|/* e a d - - - - p */
literal|0x6f
block|,
literal|0x73
block|,
literal|0x74
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x03
block|,
literal|0x70
block|,
comment|/* o s t - - - - p */
literal|0x75
block|,
literal|0x74
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x06
block|,
literal|0x64
block|,
literal|0x65
block|,
comment|/* u t - - - - d e */
literal|0x6c
block|,
literal|0x65
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x05
block|,
comment|/* l e t e - - - - */
literal|0x74
block|,
literal|0x72
block|,
literal|0x61
block|,
literal|0x63
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* t r a c e - - - */
literal|0x06
block|,
literal|0x61
block|,
literal|0x63
block|,
literal|0x63
block|,
literal|0x65
block|,
literal|0x70
block|,
literal|0x74
block|,
literal|0x00
block|,
comment|/* - a c c e p t - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x0e
block|,
literal|0x61
block|,
literal|0x63
block|,
literal|0x63
block|,
literal|0x65
block|,
literal|0x70
block|,
comment|/* - - - a c c e p */
literal|0x74
block|,
literal|0x2d
block|,
literal|0x63
block|,
literal|0x68
block|,
literal|0x61
block|,
literal|0x72
block|,
literal|0x73
block|,
literal|0x65
block|,
comment|/* t - c h a r s e */
literal|0x74
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0f
block|,
literal|0x61
block|,
literal|0x63
block|,
literal|0x63
block|,
comment|/* t - - - - a c c */
literal|0x65
block|,
literal|0x70
block|,
literal|0x74
block|,
literal|0x2d
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x63
block|,
literal|0x6f
block|,
comment|/* e p t - e n c o */
literal|0x64
block|,
literal|0x69
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0f
block|,
comment|/* d i n g - - - - */
literal|0x61
block|,
literal|0x63
block|,
literal|0x63
block|,
literal|0x65
block|,
literal|0x70
block|,
literal|0x74
block|,
literal|0x2d
block|,
literal|0x6c
block|,
comment|/* a c c e p t - l */
literal|0x61
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x75
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x00
block|,
comment|/* a n g u a g e - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x0d
block|,
literal|0x61
block|,
literal|0x63
block|,
literal|0x63
block|,
literal|0x65
block|,
literal|0x70
block|,
comment|/* - - - a c c e p */
literal|0x74
block|,
literal|0x2d
block|,
literal|0x72
block|,
literal|0x61
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x73
block|,
comment|/* t - r a n g e s */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x03
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x00
block|,
comment|/* - - - - a g e - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x05
block|,
literal|0x61
block|,
literal|0x6c
block|,
literal|0x6c
block|,
literal|0x6f
block|,
literal|0x77
block|,
comment|/* - - - a l l o w */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0d
block|,
literal|0x61
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x68
block|,
comment|/* - - - - a u t h */
literal|0x6f
block|,
literal|0x72
block|,
literal|0x69
block|,
literal|0x7a
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x69
block|,
literal|0x6f
block|,
comment|/* o r i z a t i o */
literal|0x6e
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0d
block|,
literal|0x63
block|,
literal|0x61
block|,
literal|0x63
block|,
comment|/* n - - - - c a c */
literal|0x68
block|,
literal|0x65
block|,
literal|0x2d
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x72
block|,
comment|/* h e - c o n t r */
literal|0x6f
block|,
literal|0x6c
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0a
block|,
literal|0x63
block|,
literal|0x6f
block|,
comment|/* o l - - - - c o */
literal|0x6e
block|,
literal|0x6e
block|,
literal|0x65
block|,
literal|0x63
block|,
literal|0x74
block|,
literal|0x69
block|,
literal|0x6f
block|,
literal|0x6e
block|,
comment|/* n n e c t i o n */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0c
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
comment|/* - - - - c o n t */
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x2d
block|,
literal|0x62
block|,
literal|0x61
block|,
literal|0x73
block|,
literal|0x65
block|,
comment|/* e n t - b a s e */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x10
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
comment|/* - - - - c o n t */
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x2d
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x63
block|,
literal|0x6f
block|,
comment|/* e n t - e n c o */
literal|0x64
block|,
literal|0x69
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x10
block|,
comment|/* d i n g - - - - */
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x2d
block|,
comment|/* c o n t e n t - */
literal|0x6c
block|,
literal|0x61
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x75
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x65
block|,
comment|/* l a n g u a g e */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0e
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
comment|/* - - - - c o n t */
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x2d
block|,
literal|0x6c
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x67
block|,
comment|/* e n t - l e n g */
literal|0x74
block|,
literal|0x68
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x10
block|,
literal|0x63
block|,
literal|0x6f
block|,
comment|/* t h - - - - c o */
literal|0x6e
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x2d
block|,
literal|0x6c
block|,
literal|0x6f
block|,
comment|/* n t e n t - l o */
literal|0x63
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x69
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* c a t i o n - - */
literal|0x00
block|,
literal|0x0b
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x6e
block|,
comment|/* - - c o n t e n */
literal|0x74
block|,
literal|0x2d
block|,
literal|0x6d
block|,
literal|0x64
block|,
literal|0x35
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* t - m d 5 - - - */
literal|0x0d
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
comment|/* - c o n t e n t */
literal|0x2d
block|,
literal|0x72
block|,
literal|0x61
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* - r a n g e - - */
literal|0x00
block|,
literal|0x0c
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x6e
block|,
comment|/* - - c o n t e n */
literal|0x74
block|,
literal|0x2d
block|,
literal|0x74
block|,
literal|0x79
block|,
literal|0x70
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* t - t y p e - - */
literal|0x00
block|,
literal|0x04
block|,
literal|0x64
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* - - d a t e - - */
literal|0x00
block|,
literal|0x04
block|,
literal|0x65
block|,
literal|0x74
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* - - e t a g - - */
literal|0x00
block|,
literal|0x06
block|,
literal|0x65
block|,
literal|0x78
block|,
literal|0x70
block|,
literal|0x65
block|,
literal|0x63
block|,
literal|0x74
block|,
comment|/* - - e x p e c t */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x07
block|,
literal|0x65
block|,
literal|0x78
block|,
literal|0x70
block|,
literal|0x69
block|,
comment|/* - - - - e x p i */
literal|0x72
block|,
literal|0x65
block|,
literal|0x73
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x04
block|,
literal|0x66
block|,
comment|/* r e s - - - - f */
literal|0x72
block|,
literal|0x6f
block|,
literal|0x6d
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x04
block|,
literal|0x68
block|,
comment|/* r o m - - - - h */
literal|0x6f
block|,
literal|0x73
block|,
literal|0x74
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x08
block|,
literal|0x69
block|,
comment|/* o s t - - - - i */
literal|0x66
block|,
literal|0x2d
block|,
literal|0x6d
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x63
block|,
literal|0x68
block|,
literal|0x00
block|,
comment|/* f - m a t c h - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x11
block|,
literal|0x69
block|,
literal|0x66
block|,
literal|0x2d
block|,
literal|0x6d
block|,
literal|0x6f
block|,
comment|/* - - - i f - m o */
literal|0x64
block|,
literal|0x69
block|,
literal|0x66
block|,
literal|0x69
block|,
literal|0x65
block|,
literal|0x64
block|,
literal|0x2d
block|,
literal|0x73
block|,
comment|/* d i f i e d - s */
literal|0x69
block|,
literal|0x6e
block|,
literal|0x63
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0d
block|,
comment|/* i n c e - - - - */
literal|0x69
block|,
literal|0x66
block|,
literal|0x2d
block|,
literal|0x6e
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x65
block|,
literal|0x2d
block|,
comment|/* i f - n o n e - */
literal|0x6d
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x63
block|,
literal|0x68
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* m a t c h - - - */
literal|0x08
block|,
literal|0x69
block|,
literal|0x66
block|,
literal|0x2d
block|,
literal|0x72
block|,
literal|0x61
block|,
literal|0x6e
block|,
literal|0x67
block|,
comment|/* - i f - r a n g */
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x13
block|,
literal|0x69
block|,
literal|0x66
block|,
literal|0x2d
block|,
comment|/* e - - - - i f - */
literal|0x75
block|,
literal|0x6e
block|,
literal|0x6d
block|,
literal|0x6f
block|,
literal|0x64
block|,
literal|0x69
block|,
literal|0x66
block|,
literal|0x69
block|,
comment|/* u n m o d i f i */
literal|0x65
block|,
literal|0x64
block|,
literal|0x2d
block|,
literal|0x73
block|,
literal|0x69
block|,
literal|0x6e
block|,
literal|0x63
block|,
literal|0x65
block|,
comment|/* e d - s i n c e */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0d
block|,
literal|0x6c
block|,
literal|0x61
block|,
literal|0x73
block|,
literal|0x74
block|,
comment|/* - - - - l a s t */
literal|0x2d
block|,
literal|0x6d
block|,
literal|0x6f
block|,
literal|0x64
block|,
literal|0x69
block|,
literal|0x66
block|,
literal|0x69
block|,
literal|0x65
block|,
comment|/* - m o d i f i e */
literal|0x64
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x08
block|,
literal|0x6c
block|,
literal|0x6f
block|,
literal|0x63
block|,
comment|/* d - - - - l o c */
literal|0x61
block|,
literal|0x74
block|,
literal|0x69
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* a t i o n - - - */
literal|0x0c
block|,
literal|0x6d
block|,
literal|0x61
block|,
literal|0x78
block|,
literal|0x2d
block|,
literal|0x66
block|,
literal|0x6f
block|,
literal|0x72
block|,
comment|/* - m a x - f o r */
literal|0x77
block|,
literal|0x61
block|,
literal|0x72
block|,
literal|0x64
block|,
literal|0x73
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* w a r d s - - - */
literal|0x06
block|,
literal|0x70
block|,
literal|0x72
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x6d
block|,
literal|0x61
block|,
literal|0x00
block|,
comment|/* - p r a g m a - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x12
block|,
literal|0x70
block|,
literal|0x72
block|,
literal|0x6f
block|,
literal|0x78
block|,
literal|0x79
block|,
comment|/* - - - p r o x y */
literal|0x2d
block|,
literal|0x61
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x68
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
comment|/* - a u t h e n t */
literal|0x69
block|,
literal|0x63
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* i c a t e - - - */
literal|0x13
block|,
literal|0x70
block|,
literal|0x72
block|,
literal|0x6f
block|,
literal|0x78
block|,
literal|0x79
block|,
literal|0x2d
block|,
literal|0x61
block|,
comment|/* - p r o x y - a */
literal|0x75
block|,
literal|0x74
block|,
literal|0x68
block|,
literal|0x6f
block|,
literal|0x72
block|,
literal|0x69
block|,
literal|0x7a
block|,
literal|0x61
block|,
comment|/* u t h o r i z a */
literal|0x74
block|,
literal|0x69
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x05
block|,
comment|/* t i o n - - - - */
literal|0x72
block|,
literal|0x61
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* r a n g e - - - */
literal|0x07
block|,
literal|0x72
block|,
literal|0x65
block|,
literal|0x66
block|,
literal|0x65
block|,
literal|0x72
block|,
literal|0x65
block|,
literal|0x72
block|,
comment|/* - r e f e r e r */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0b
block|,
literal|0x72
block|,
literal|0x65
block|,
literal|0x74
block|,
literal|0x72
block|,
comment|/* - - - - r e t r */
literal|0x79
block|,
literal|0x2d
block|,
literal|0x61
block|,
literal|0x66
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x72
block|,
literal|0x00
block|,
comment|/* y - a f t e r - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x06
block|,
literal|0x73
block|,
literal|0x65
block|,
literal|0x72
block|,
literal|0x76
block|,
literal|0x65
block|,
comment|/* - - - s e r v e */
literal|0x72
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x02
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x00
block|,
comment|/* r - - - - t e - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x07
block|,
literal|0x74
block|,
literal|0x72
block|,
literal|0x61
block|,
literal|0x69
block|,
literal|0x6c
block|,
comment|/* - - - t r a i l */
literal|0x65
block|,
literal|0x72
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x11
block|,
literal|0x74
block|,
literal|0x72
block|,
comment|/* e r - - - - t r */
literal|0x61
block|,
literal|0x6e
block|,
literal|0x73
block|,
literal|0x66
block|,
literal|0x65
block|,
literal|0x72
block|,
literal|0x2d
block|,
literal|0x65
block|,
comment|/* a n s f e r - e */
literal|0x6e
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x64
block|,
literal|0x69
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x00
block|,
comment|/* n c o d i n g - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x07
block|,
literal|0x75
block|,
literal|0x70
block|,
literal|0x67
block|,
literal|0x72
block|,
literal|0x61
block|,
comment|/* - - - u p g r a */
literal|0x64
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0a
block|,
literal|0x75
block|,
literal|0x73
block|,
comment|/* d e - - - - u s */
literal|0x65
block|,
literal|0x72
block|,
literal|0x2d
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
comment|/* e r - a g e n t */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x04
block|,
literal|0x76
block|,
literal|0x61
block|,
literal|0x72
block|,
literal|0x79
block|,
comment|/* - - - - v a r y */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x03
block|,
literal|0x76
block|,
literal|0x69
block|,
literal|0x61
block|,
literal|0x00
block|,
comment|/* - - - - v i a - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x07
block|,
literal|0x77
block|,
literal|0x61
block|,
literal|0x72
block|,
literal|0x6e
block|,
literal|0x69
block|,
comment|/* - - - w a r n i */
literal|0x6e
block|,
literal|0x67
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x10
block|,
literal|0x77
block|,
literal|0x77
block|,
comment|/* n g - - - - w w */
literal|0x77
block|,
literal|0x2d
block|,
literal|0x61
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x68
block|,
literal|0x65
block|,
literal|0x6e
block|,
comment|/* w - a u t h e n */
literal|0x74
block|,
literal|0x69
block|,
literal|0x63
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* t i c a t e - - */
literal|0x00
block|,
literal|0x06
block|,
literal|0x6d
block|,
literal|0x65
block|,
literal|0x74
block|,
literal|0x68
block|,
literal|0x6f
block|,
literal|0x64
block|,
comment|/* - - m e t h o d */
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x03
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x74
block|,
literal|0x00
block|,
comment|/* - - - - g e t - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x06
block|,
literal|0x73
block|,
literal|0x74
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x75
block|,
comment|/* - - - s t a t u */
literal|0x73
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x06
block|,
literal|0x32
block|,
literal|0x30
block|,
literal|0x30
block|,
comment|/* s - - - - 2 0 0 */
literal|0x20
block|,
literal|0x4f
block|,
literal|0x4b
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x07
block|,
literal|0x76
block|,
comment|/* - O K - - - - v */
literal|0x65
block|,
literal|0x72
block|,
literal|0x73
block|,
literal|0x69
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* e r s i o n - - */
literal|0x00
block|,
literal|0x08
block|,
literal|0x48
block|,
literal|0x54
block|,
literal|0x54
block|,
literal|0x50
block|,
literal|0x2f
block|,
literal|0x31
block|,
comment|/* - - H T T P - 1 */
literal|0x2e
block|,
literal|0x31
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x03
block|,
literal|0x75
block|,
literal|0x72
block|,
comment|/* - 1 - - - - u r */
literal|0x6c
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x06
block|,
literal|0x70
block|,
literal|0x75
block|,
literal|0x62
block|,
comment|/* l - - - - p u b */
literal|0x6c
block|,
literal|0x69
block|,
literal|0x63
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0a
block|,
literal|0x73
block|,
comment|/* l i c - - - - s */
literal|0x65
block|,
literal|0x74
block|,
literal|0x2d
block|,
literal|0x63
block|,
literal|0x6f
block|,
literal|0x6f
block|,
literal|0x6b
block|,
literal|0x69
block|,
comment|/* e t - c o o k i */
literal|0x65
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x0a
block|,
literal|0x6b
block|,
literal|0x65
block|,
literal|0x65
block|,
comment|/* e - - - - k e e */
literal|0x70
block|,
literal|0x2d
block|,
literal|0x61
block|,
literal|0x6c
block|,
literal|0x69
block|,
literal|0x76
block|,
literal|0x65
block|,
literal|0x00
block|,
comment|/* p - a l i v e - */
literal|0x00
block|,
literal|0x00
block|,
literal|0x06
block|,
literal|0x6f
block|,
literal|0x72
block|,
literal|0x69
block|,
literal|0x67
block|,
literal|0x69
block|,
comment|/* - - - o r i g i */
literal|0x6e
block|,
literal|0x31
block|,
literal|0x30
block|,
literal|0x30
block|,
literal|0x31
block|,
literal|0x30
block|,
literal|0x31
block|,
literal|0x32
block|,
comment|/* n 1 0 0 1 0 1 2 */
literal|0x30
block|,
literal|0x31
block|,
literal|0x32
block|,
literal|0x30
block|,
literal|0x32
block|,
literal|0x32
block|,
literal|0x30
block|,
literal|0x35
block|,
comment|/* 0 1 2 0 2 2 0 5 */
literal|0x32
block|,
literal|0x30
block|,
literal|0x36
block|,
literal|0x33
block|,
literal|0x30
block|,
literal|0x30
block|,
literal|0x33
block|,
literal|0x30
block|,
comment|/* 2 0 6 3 0 0 3 0 */
literal|0x32
block|,
literal|0x33
block|,
literal|0x30
block|,
literal|0x33
block|,
literal|0x33
block|,
literal|0x30
block|,
literal|0x34
block|,
literal|0x33
block|,
comment|/* 2 3 0 3 3 0 4 3 */
literal|0x30
block|,
literal|0x35
block|,
literal|0x33
block|,
literal|0x30
block|,
literal|0x36
block|,
literal|0x33
block|,
literal|0x30
block|,
literal|0x37
block|,
comment|/* 0 5 3 0 6 3 0 7 */
literal|0x34
block|,
literal|0x30
block|,
literal|0x32
block|,
literal|0x34
block|,
literal|0x30
block|,
literal|0x35
block|,
literal|0x34
block|,
literal|0x30
block|,
comment|/* 4 0 2 4 0 5 4 0 */
literal|0x36
block|,
literal|0x34
block|,
literal|0x30
block|,
literal|0x37
block|,
literal|0x34
block|,
literal|0x30
block|,
literal|0x38
block|,
literal|0x34
block|,
comment|/* 6 4 0 7 4 0 8 4 */
literal|0x30
block|,
literal|0x39
block|,
literal|0x34
block|,
literal|0x31
block|,
literal|0x30
block|,
literal|0x34
block|,
literal|0x31
block|,
literal|0x31
block|,
comment|/* 0 9 4 1 0 4 1 1 */
literal|0x34
block|,
literal|0x31
block|,
literal|0x32
block|,
literal|0x34
block|,
literal|0x31
block|,
literal|0x33
block|,
literal|0x34
block|,
literal|0x31
block|,
comment|/* 4 1 2 4 1 3 4 1 */
literal|0x34
block|,
literal|0x34
block|,
literal|0x31
block|,
literal|0x35
block|,
literal|0x34
block|,
literal|0x31
block|,
literal|0x36
block|,
literal|0x34
block|,
comment|/* 4 4 1 5 4 1 6 4 */
literal|0x31
block|,
literal|0x37
block|,
literal|0x35
block|,
literal|0x30
block|,
literal|0x32
block|,
literal|0x35
block|,
literal|0x30
block|,
literal|0x34
block|,
comment|/* 1 7 5 0 2 5 0 4 */
literal|0x35
block|,
literal|0x30
block|,
literal|0x35
block|,
literal|0x32
block|,
literal|0x30
block|,
literal|0x33
block|,
literal|0x20
block|,
literal|0x4e
block|,
comment|/* 5 0 5 2 0 3 - N */
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x2d
block|,
literal|0x41
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x68
block|,
literal|0x6f
block|,
comment|/* o n - A u t h o */
literal|0x72
block|,
literal|0x69
block|,
literal|0x74
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x69
block|,
literal|0x76
block|,
literal|0x65
block|,
comment|/* r i t a t i v e */
literal|0x20
block|,
literal|0x49
block|,
literal|0x6e
block|,
literal|0x66
block|,
literal|0x6f
block|,
literal|0x72
block|,
literal|0x6d
block|,
literal|0x61
block|,
comment|/* - I n f o r m a */
literal|0x74
block|,
literal|0x69
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x32
block|,
literal|0x30
block|,
literal|0x34
block|,
literal|0x20
block|,
comment|/* t i o n 2 0 4 - */
literal|0x4e
block|,
literal|0x6f
block|,
literal|0x20
block|,
literal|0x43
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x65
block|,
comment|/* N o - C o n t e */
literal|0x6e
block|,
literal|0x74
block|,
literal|0x33
block|,
literal|0x30
block|,
literal|0x31
block|,
literal|0x20
block|,
literal|0x4d
block|,
literal|0x6f
block|,
comment|/* n t 3 0 1 - M o */
literal|0x76
block|,
literal|0x65
block|,
literal|0x64
block|,
literal|0x20
block|,
literal|0x50
block|,
literal|0x65
block|,
literal|0x72
block|,
literal|0x6d
block|,
comment|/* v e d - P e r m */
literal|0x61
block|,
literal|0x6e
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x6c
block|,
literal|0x79
block|,
literal|0x34
block|,
comment|/* a n e n t l y 4 */
literal|0x30
block|,
literal|0x30
block|,
literal|0x20
block|,
literal|0x42
block|,
literal|0x61
block|,
literal|0x64
block|,
literal|0x20
block|,
literal|0x52
block|,
comment|/* 0 0 - B a d - R */
literal|0x65
block|,
literal|0x71
block|,
literal|0x75
block|,
literal|0x65
block|,
literal|0x73
block|,
literal|0x74
block|,
literal|0x34
block|,
literal|0x30
block|,
comment|/* e q u e s t 4 0 */
literal|0x31
block|,
literal|0x20
block|,
literal|0x55
block|,
literal|0x6e
block|,
literal|0x61
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x68
block|,
comment|/* 1 - U n a u t h */
literal|0x6f
block|,
literal|0x72
block|,
literal|0x69
block|,
literal|0x7a
block|,
literal|0x65
block|,
literal|0x64
block|,
literal|0x34
block|,
literal|0x30
block|,
comment|/* o r i z e d 4 0 */
literal|0x33
block|,
literal|0x20
block|,
literal|0x46
block|,
literal|0x6f
block|,
literal|0x72
block|,
literal|0x62
block|,
literal|0x69
block|,
literal|0x64
block|,
comment|/* 3 - F o r b i d */
literal|0x64
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x34
block|,
literal|0x30
block|,
literal|0x34
block|,
literal|0x20
block|,
literal|0x4e
block|,
comment|/* d e n 4 0 4 - N */
literal|0x6f
block|,
literal|0x74
block|,
literal|0x20
block|,
literal|0x46
block|,
literal|0x6f
block|,
literal|0x75
block|,
literal|0x6e
block|,
literal|0x64
block|,
comment|/* o t - F o u n d */
literal|0x35
block|,
literal|0x30
block|,
literal|0x30
block|,
literal|0x20
block|,
literal|0x49
block|,
literal|0x6e
block|,
literal|0x74
block|,
literal|0x65
block|,
comment|/* 5 0 0 - I n t e */
literal|0x72
block|,
literal|0x6e
block|,
literal|0x61
block|,
literal|0x6c
block|,
literal|0x20
block|,
literal|0x53
block|,
literal|0x65
block|,
literal|0x72
block|,
comment|/* r n a l - S e r */
literal|0x76
block|,
literal|0x65
block|,
literal|0x72
block|,
literal|0x20
block|,
literal|0x45
block|,
literal|0x72
block|,
literal|0x72
block|,
literal|0x6f
block|,
comment|/* v e r - E r r o */
literal|0x72
block|,
literal|0x35
block|,
literal|0x30
block|,
literal|0x31
block|,
literal|0x20
block|,
literal|0x4e
block|,
literal|0x6f
block|,
literal|0x74
block|,
comment|/* r 5 0 1 - N o t */
literal|0x20
block|,
literal|0x49
block|,
literal|0x6d
block|,
literal|0x70
block|,
literal|0x6c
block|,
literal|0x65
block|,
literal|0x6d
block|,
literal|0x65
block|,
comment|/* - I m p l e m e */
literal|0x6e
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x64
block|,
literal|0x35
block|,
literal|0x30
block|,
literal|0x33
block|,
literal|0x20
block|,
comment|/* n t e d 5 0 3 - */
literal|0x53
block|,
literal|0x65
block|,
literal|0x72
block|,
literal|0x76
block|,
literal|0x69
block|,
literal|0x63
block|,
literal|0x65
block|,
literal|0x20
block|,
comment|/* S e r v i c e - */
literal|0x55
block|,
literal|0x6e
block|,
literal|0x61
block|,
literal|0x76
block|,
literal|0x61
block|,
literal|0x69
block|,
literal|0x6c
block|,
literal|0x61
block|,
comment|/* U n a v a i l a */
literal|0x62
block|,
literal|0x6c
block|,
literal|0x65
block|,
literal|0x4a
block|,
literal|0x61
block|,
literal|0x6e
block|,
literal|0x20
block|,
literal|0x46
block|,
comment|/* b l e J a n - F */
literal|0x65
block|,
literal|0x62
block|,
literal|0x20
block|,
literal|0x4d
block|,
literal|0x61
block|,
literal|0x72
block|,
literal|0x20
block|,
literal|0x41
block|,
comment|/* e b - M a r - A */
literal|0x70
block|,
literal|0x72
block|,
literal|0x20
block|,
literal|0x4d
block|,
literal|0x61
block|,
literal|0x79
block|,
literal|0x20
block|,
literal|0x4a
block|,
comment|/* p r - M a y - J */
literal|0x75
block|,
literal|0x6e
block|,
literal|0x20
block|,
literal|0x4a
block|,
literal|0x75
block|,
literal|0x6c
block|,
literal|0x20
block|,
literal|0x41
block|,
comment|/* u n - J u l - A */
literal|0x75
block|,
literal|0x67
block|,
literal|0x20
block|,
literal|0x53
block|,
literal|0x65
block|,
literal|0x70
block|,
literal|0x74
block|,
literal|0x20
block|,
comment|/* u g - S e p t - */
literal|0x4f
block|,
literal|0x63
block|,
literal|0x74
block|,
literal|0x20
block|,
literal|0x4e
block|,
literal|0x6f
block|,
literal|0x76
block|,
literal|0x20
block|,
comment|/* O c t - N o v - */
literal|0x44
block|,
literal|0x65
block|,
literal|0x63
block|,
literal|0x20
block|,
literal|0x30
block|,
literal|0x30
block|,
literal|0x3a
block|,
literal|0x30
block|,
comment|/* D e c - 0 0 - 0 */
literal|0x30
block|,
literal|0x3a
block|,
literal|0x30
block|,
literal|0x30
block|,
literal|0x20
block|,
literal|0x4d
block|,
literal|0x6f
block|,
literal|0x6e
block|,
comment|/* 0 - 0 0 - M o n */
literal|0x2c
block|,
literal|0x20
block|,
literal|0x54
block|,
literal|0x75
block|,
literal|0x65
block|,
literal|0x2c
block|,
literal|0x20
block|,
literal|0x57
block|,
comment|/* - - T u e - - W */
literal|0x65
block|,
literal|0x64
block|,
literal|0x2c
block|,
literal|0x20
block|,
literal|0x54
block|,
literal|0x68
block|,
literal|0x75
block|,
literal|0x2c
block|,
comment|/* e d - - T h u - */
literal|0x20
block|,
literal|0x46
block|,
literal|0x72
block|,
literal|0x69
block|,
literal|0x2c
block|,
literal|0x20
block|,
literal|0x53
block|,
literal|0x61
block|,
comment|/* - F r i - - S a */
literal|0x74
block|,
literal|0x2c
block|,
literal|0x20
block|,
literal|0x53
block|,
literal|0x75
block|,
literal|0x6e
block|,
literal|0x2c
block|,
literal|0x20
block|,
comment|/* t - - S u n - - */
literal|0x47
block|,
literal|0x4d
block|,
literal|0x54
block|,
literal|0x63
block|,
literal|0x68
block|,
literal|0x75
block|,
literal|0x6e
block|,
literal|0x6b
block|,
comment|/* G M T c h u n k */
literal|0x65
block|,
literal|0x64
block|,
literal|0x2c
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x78
block|,
literal|0x74
block|,
literal|0x2f
block|,
comment|/* e d - t e x t - */
literal|0x68
block|,
literal|0x74
block|,
literal|0x6d
block|,
literal|0x6c
block|,
literal|0x2c
block|,
literal|0x69
block|,
literal|0x6d
block|,
literal|0x61
block|,
comment|/* h t m l - i m a */
literal|0x67
block|,
literal|0x65
block|,
literal|0x2f
block|,
literal|0x70
block|,
literal|0x6e
block|,
literal|0x67
block|,
literal|0x2c
block|,
literal|0x69
block|,
comment|/* g e - p n g - i */
literal|0x6d
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x2f
block|,
literal|0x6a
block|,
literal|0x70
block|,
literal|0x67
block|,
comment|/* m a g e - j p g */
literal|0x2c
block|,
literal|0x69
block|,
literal|0x6d
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x65
block|,
literal|0x2f
block|,
literal|0x67
block|,
comment|/* - i m a g e - g */
literal|0x69
block|,
literal|0x66
block|,
literal|0x2c
block|,
literal|0x61
block|,
literal|0x70
block|,
literal|0x70
block|,
literal|0x6c
block|,
literal|0x69
block|,
comment|/* i f - a p p l i */
literal|0x63
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x69
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x2f
block|,
literal|0x78
block|,
comment|/* c a t i o n - x */
literal|0x6d
block|,
literal|0x6c
block|,
literal|0x2c
block|,
literal|0x61
block|,
literal|0x70
block|,
literal|0x70
block|,
literal|0x6c
block|,
literal|0x69
block|,
comment|/* m l - a p p l i */
literal|0x63
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x69
block|,
literal|0x6f
block|,
literal|0x6e
block|,
literal|0x2f
block|,
literal|0x78
block|,
comment|/* c a t i o n - x */
literal|0x68
block|,
literal|0x74
block|,
literal|0x6d
block|,
literal|0x6c
block|,
literal|0x2b
block|,
literal|0x78
block|,
literal|0x6d
block|,
literal|0x6c
block|,
comment|/* h t m l - x m l */
literal|0x2c
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x78
block|,
literal|0x74
block|,
literal|0x2f
block|,
literal|0x70
block|,
literal|0x6c
block|,
comment|/* - t e x t - p l */
literal|0x61
block|,
literal|0x69
block|,
literal|0x6e
block|,
literal|0x2c
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x78
block|,
literal|0x74
block|,
comment|/* a i n - t e x t */
literal|0x2f
block|,
literal|0x6a
block|,
literal|0x61
block|,
literal|0x76
block|,
literal|0x61
block|,
literal|0x73
block|,
literal|0x63
block|,
literal|0x72
block|,
comment|/* - j a v a s c r */
literal|0x69
block|,
literal|0x70
block|,
literal|0x74
block|,
literal|0x2c
block|,
literal|0x70
block|,
literal|0x75
block|,
literal|0x62
block|,
literal|0x6c
block|,
comment|/* i p t - p u b l */
literal|0x69
block|,
literal|0x63
block|,
literal|0x70
block|,
literal|0x72
block|,
literal|0x69
block|,
literal|0x76
block|,
literal|0x61
block|,
literal|0x74
block|,
comment|/* i c p r i v a t */
literal|0x65
block|,
literal|0x6d
block|,
literal|0x61
block|,
literal|0x78
block|,
literal|0x2d
block|,
literal|0x61
block|,
literal|0x67
block|,
literal|0x65
block|,
comment|/* e m a x - a g e */
literal|0x3d
block|,
literal|0x67
block|,
literal|0x7a
block|,
literal|0x69
block|,
literal|0x70
block|,
literal|0x2c
block|,
literal|0x64
block|,
literal|0x65
block|,
comment|/* - g z i p - d e */
literal|0x66
block|,
literal|0x6c
block|,
literal|0x61
block|,
literal|0x74
block|,
literal|0x65
block|,
literal|0x2c
block|,
literal|0x73
block|,
literal|0x64
block|,
comment|/* f l a t e - s d */
literal|0x63
block|,
literal|0x68
block|,
literal|0x63
block|,
literal|0x68
block|,
literal|0x61
block|,
literal|0x72
block|,
literal|0x73
block|,
literal|0x65
block|,
comment|/* c h c h a r s e */
literal|0x74
block|,
literal|0x3d
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x66
block|,
literal|0x2d
block|,
literal|0x38
block|,
literal|0x63
block|,
comment|/* t - u t f - 8 c */
literal|0x68
block|,
literal|0x61
block|,
literal|0x72
block|,
literal|0x73
block|,
literal|0x65
block|,
literal|0x74
block|,
literal|0x3d
block|,
literal|0x69
block|,
comment|/* h a r s e t - i */
literal|0x73
block|,
literal|0x6f
block|,
literal|0x2d
block|,
literal|0x38
block|,
literal|0x38
block|,
literal|0x35
block|,
literal|0x39
block|,
literal|0x2d
block|,
comment|/* s o - 8 8 5 9 - */
literal|0x31
block|,
literal|0x2c
block|,
literal|0x75
block|,
literal|0x74
block|,
literal|0x66
block|,
literal|0x2d
block|,
literal|0x2c
block|,
literal|0x2a
block|,
comment|/* 1 - u t f - - - */
literal|0x2c
block|,
literal|0x65
block|,
literal|0x6e
block|,
literal|0x71
block|,
literal|0x3d
block|,
literal|0x30
block|,
literal|0x2e
comment|/* - e n q - 0 -   */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_spdy_request_headers
specifier|static
name|ngx_http_spdy_request_header_t
name|ngx_http_spdy_request_headers
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|6
block|,
literal|"method"
block|,
name|ngx_http_spdy_parse_method
block|}
block|,
block|{
literal|0
block|,
literal|6
block|,
literal|"scheme"
block|,
name|ngx_http_spdy_parse_scheme
block|}
block|,
block|{
literal|0
block|,
literal|4
block|,
literal|"host"
block|,
name|ngx_http_spdy_parse_host
block|}
block|,
block|{
literal|0
block|,
literal|4
block|,
literal|"path"
block|,
name|ngx_http_spdy_parse_path
block|}
block|,
block|{
literal|0
block|,
literal|7
block|,
literal|"version"
block|,
name|ngx_http_spdy_parse_version
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
DECL|macro|NGX_SPDY_REQUEST_HEADERS
define|#
directive|define
name|NGX_SPDY_REQUEST_HEADERS
define|\
value|(sizeof(ngx_http_spdy_request_headers)                                    \      / sizeof(ngx_http_spdy_request_header_t))
end_define

begin_function
name|void
DECL|function|ngx_http_spdy_init (ngx_event_t * rev)
name|ngx_http_spdy_init
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ngx_http_connection_t
modifier|*
name|hc
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
name|ngx_http_spdy_main_conf_t
modifier|*
name|smcf
decl_stmt|;
name|ngx_http_spdy_connection_t
modifier|*
name|sc
decl_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|hc
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"init spdy request"
argument_list|)
expr_stmt|;
name|c
operator|->
name|log
operator|->
name|action
operator|=
literal|"processing SPDY"
expr_stmt|;
name|smcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|hc
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|smcf
operator|->
name|recv_buffer
operator|==
name|NULL
condition|)
block|{
name|smcf
operator|->
name|recv_buffer
operator|=
name|ngx_palloc
argument_list|(
name|ngx_cycle
operator|->
name|pool
argument_list|,
name|smcf
operator|->
name|recv_buffer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|smcf
operator|->
name|recv_buffer
operator|==
name|NULL
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|sc
operator|=
name|ngx_pcalloc
argument_list|(
name|c
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_spdy_connection_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|connection
operator|=
name|c
expr_stmt|;
name|sc
operator|->
name|http_connection
operator|=
name|hc
expr_stmt|;
name|sc
operator|->
name|send_window
operator|=
name|NGX_SPDY_CONNECTION_WINDOW
expr_stmt|;
name|sc
operator|->
name|recv_window
operator|=
name|NGX_SPDY_CONNECTION_WINDOW
expr_stmt|;
name|sc
operator|->
name|init_window
operator|=
name|NGX_SPDY_INIT_STREAM_WINDOW
expr_stmt|;
name|sc
operator|->
name|handler
operator|=
name|ngx_http_spdy_state_head
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|zalloc
operator|=
name|ngx_http_spdy_zalloc
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|zfree
operator|=
name|ngx_http_spdy_zfree
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|opaque
operator|=
name|sc
expr_stmt|;
name|rc
operator|=
name|inflateInit
argument_list|(
operator|&
name|sc
operator|->
name|zstream_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|Z_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"inflateInit() failed: %d"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|zstream_out
operator|.
name|zalloc
operator|=
name|ngx_http_spdy_zalloc
expr_stmt|;
name|sc
operator|->
name|zstream_out
operator|.
name|zfree
operator|=
name|ngx_http_spdy_zfree
expr_stmt|;
name|sc
operator|->
name|zstream_out
operator|.
name|opaque
operator|=
name|sc
expr_stmt|;
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|hc
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|rc
operator|=
name|deflateInit2
argument_list|(
operator|&
name|sc
operator|->
name|zstream_out
argument_list|,
operator|(
name|int
operator|)
name|sscf
operator|->
name|headers_comp
argument_list|,
name|Z_DEFLATED
argument_list|,
literal|11
argument_list|,
literal|4
argument_list|,
name|Z_DEFAULT_STRATEGY
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|Z_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"deflateInit2() failed: %d"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|rc
operator|=
name|deflateSetDictionary
argument_list|(
operator|&
name|sc
operator|->
name|zstream_out
argument_list|,
name|ngx_http_spdy_dict
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_spdy_dict
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|Z_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"deflateSetDictionary() failed: %d"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|pool
operator|=
name|ngx_create_pool
argument_list|(
name|sscf
operator|->
name|pool_size
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pool
operator|==
name|NULL
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|c
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_pool_cleanup_file_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_spdy_pool_cleanup
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|streams_index
operator|=
name|ngx_pcalloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
name|ngx_http_spdy_streams_index_size
argument_list|(
name|sscf
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
name|ngx_http_spdy_stream_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|streams_index
operator|==
name|NULL
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ngx_http_spdy_send_settings
argument_list|(
name|sc
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ngx_http_spdy_send_window_update
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|NGX_SPDY_MAX_WINDOW
operator|-
name|sc
operator|->
name|recv_window
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|recv_window
operator|=
name|NGX_SPDY_MAX_WINDOW
expr_stmt|;
name|ngx_queue_init
argument_list|(
operator|&
name|sc
operator|->
name|waiting
argument_list|)
expr_stmt|;
name|ngx_queue_init
argument_list|(
operator|&
name|sc
operator|->
name|posted
argument_list|)
expr_stmt|;
name|c
operator|->
name|data
operator|=
name|sc
expr_stmt|;
name|rev
operator|->
name|handler
operator|=
name|ngx_http_spdy_read_handler
expr_stmt|;
name|c
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_http_spdy_write_handler
expr_stmt|;
name|ngx_http_spdy_read_handler
argument_list|(
name|rev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_read_handler (ngx_event_t * rev)
name|ngx_http_spdy_read_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|available
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_spdy_main_conf_t
modifier|*
name|smcf
decl_stmt|;
name|ngx_http_spdy_connection_t
modifier|*
name|sc
decl_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|sc
operator|=
name|c
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"client timed out"
argument_list|)
expr_stmt|;
name|ngx_http_spdy_finalize_connection
argument_list|(
name|sc
argument_list|,
name|NGX_HTTP_REQUEST_TIME_OUT
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy read handler"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|blocked
operator|=
literal|1
expr_stmt|;
name|smcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|available
operator|=
name|smcf
operator|->
name|recv_buffer_size
operator|-
literal|2
operator|*
name|NGX_SPDY_STATE_BUFFER_SIZE
expr_stmt|;
do|do
block|{
name|p
operator|=
name|smcf
operator|->
name|recv_buffer
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|sc
operator|->
name|buffer
argument_list|,
name|NGX_SPDY_STATE_BUFFER_SIZE
argument_list|)
expr_stmt|;
name|end
operator|=
name|p
operator|+
name|sc
operator|->
name|buffer_used
expr_stmt|;
name|n
operator|=
name|c
operator|->
name|recv
argument_list|(
name|c
argument_list|,
name|end
argument_list|,
name|available
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|n
operator|==
literal|0
operator|&&
operator|(
name|sc
operator|->
name|incomplete
operator|||
name|sc
operator|->
name|processing
operator|)
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client closed prematurely connection"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|==
literal|0
operator|||
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_spdy_finalize_connection
argument_list|(
name|sc
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
name|end
operator|+=
name|n
expr_stmt|;
name|sc
operator|->
name|buffer_used
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|incomplete
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|p
operator|=
name|sc
operator|->
name|handler
argument_list|(
name|sc
argument_list|,
name|p
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
block|}
do|while
condition|(
name|p
operator|!=
name|end
condition|)
do|;
block|}
do|while
condition|(
name|rev
operator|->
name|ready
condition|)
do|;
if|if
condition|(
name|ngx_handle_read_event
argument_list|(
name|rev
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_spdy_finalize_connection
argument_list|(
name|sc
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|last_out
operator|&&
name|ngx_http_spdy_send_output_queue
argument_list|(
name|sc
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_spdy_finalize_connection
argument_list|(
name|sc
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|blocked
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|processing
condition|)
block|{
if|if
condition|(
name|rev
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|rev
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|ngx_http_spdy_handle_connection
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_write_handler (ngx_event_t * wev)
name|ngx_http_spdy_write_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|wev
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_queue_t
modifier|*
name|q
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|ngx_http_spdy_connection_t
modifier|*
name|sc
decl_stmt|;
name|c
operator|=
name|wev
operator|->
name|data
expr_stmt|;
name|sc
operator|=
name|c
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|wev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy write event timed out"
argument_list|)
expr_stmt|;
name|ngx_http_spdy_finalize_connection
argument_list|(
name|sc
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy write handler"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|blocked
operator|=
literal|1
expr_stmt|;
name|rc
operator|=
name|ngx_http_spdy_send_output_queue
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_http_spdy_finalize_connection
argument_list|(
name|sc
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
operator|!
name|ngx_queue_empty
argument_list|(
operator|&
name|sc
operator|->
name|posted
argument_list|)
condition|)
block|{
name|q
operator|=
name|ngx_queue_head
argument_list|(
operator|&
name|sc
operator|->
name|posted
argument_list|)
expr_stmt|;
name|ngx_queue_remove
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|stream
operator|=
name|ngx_queue_data
argument_list|(
name|q
argument_list|,
name|ngx_http_spdy_stream_t
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|stream
operator|->
name|handled
operator|=
literal|0
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy run stream %ui"
argument_list|,
name|stream
operator|->
name|id
argument_list|)
expr_stmt|;
name|wev
operator|=
name|stream
operator|->
name|request
operator|->
name|connection
operator|->
name|write
expr_stmt|;
name|wev
operator|->
name|handler
argument_list|(
name|wev
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|blocked
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return;
block|}
name|ngx_http_spdy_handle_connection
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_spdy_send_output_queue (ngx_http_spdy_connection_t * sc)
name|ngx_http_spdy_send_output_queue
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
block|{
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|;
name|ngx_event_t
modifier|*
name|wev
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|ngx_http_spdy_out_frame_t
modifier|*
name|out
decl_stmt|,
modifier|*
name|frame
decl_stmt|,
modifier|*
name|fn
decl_stmt|;
name|c
operator|=
name|sc
operator|->
name|connection
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|wev
operator|=
name|c
operator|->
name|write
expr_stmt|;
if|if
condition|(
operator|!
name|wev
operator|->
name|ready
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|cl
operator|=
name|NULL
expr_stmt|;
name|out
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|frame
operator|=
name|sc
operator|->
name|last_out
init|;
name|frame
condition|;
name|frame
operator|=
name|fn
control|)
block|{
name|frame
operator|->
name|last
operator|->
name|next
operator|=
name|cl
expr_stmt|;
name|cl
operator|=
name|frame
operator|->
name|first
expr_stmt|;
name|fn
operator|=
name|frame
operator|->
name|next
expr_stmt|;
name|frame
operator|->
name|next
operator|=
name|out
expr_stmt|;
name|out
operator|=
name|frame
expr_stmt|;
name|ngx_log_debug5
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy frame out: %p sid:%ui prio:%ui bl:%d len:%uz"
argument_list|,
name|out
argument_list|,
name|out
operator|->
name|stream
condition|?
name|out
operator|->
name|stream
operator|->
name|id
else|:
literal|0
argument_list|,
name|out
operator|->
name|priority
argument_list|,
name|out
operator|->
name|blocked
argument_list|,
name|out
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|cl
operator|=
name|c
operator|->
name|send_chain
argument_list|(
name|c
argument_list|,
name|cl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NGX_CHAIN_ERROR
condition|)
block|{
name|c
operator|->
name|error
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|blocked
condition|)
block|{
name|ngx_post_event
argument_list|(
name|wev
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_ERROR
return|;
block|}
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_handle_write_event
argument_list|(
name|wev
argument_list|,
name|clcf
operator|->
name|send_lowat
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
comment|/* FIXME */
block|}
if|if
condition|(
name|cl
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|wev
argument_list|,
name|clcf
operator|->
name|send_timeout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|wev
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|wev
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
comment|/* void */
init|;
name|out
condition|;
name|out
operator|=
name|fn
control|)
block|{
name|fn
operator|=
name|out
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|out
operator|->
name|handler
argument_list|(
name|sc
argument_list|,
name|out
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|out
operator|->
name|blocked
operator|=
literal|1
expr_stmt|;
name|out
operator|->
name|priority
operator|=
name|NGX_SPDY_HIGHEST_PRIORITY
expr_stmt|;
break|break;
block|}
name|ngx_log_debug4
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy frame sent: %p sid:%ui bl:%d len:%uz"
argument_list|,
name|out
argument_list|,
name|out
operator|->
name|stream
condition|?
name|out
operator|->
name|stream
operator|->
name|id
else|:
literal|0
argument_list|,
name|out
operator|->
name|blocked
argument_list|,
name|out
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|frame
operator|=
name|NULL
expr_stmt|;
for|for
control|(
comment|/* void */
init|;
name|out
condition|;
name|out
operator|=
name|fn
control|)
block|{
name|fn
operator|=
name|out
operator|->
name|next
expr_stmt|;
name|out
operator|->
name|next
operator|=
name|frame
expr_stmt|;
name|frame
operator|=
name|out
expr_stmt|;
block|}
name|sc
operator|->
name|last_out
operator|=
name|frame
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_handle_connection (ngx_http_spdy_connection_t * sc)
name|ngx_http_spdy_handle_connection
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|last_out
operator|||
name|sc
operator|->
name|processing
condition|)
block|{
return|return;
block|}
name|c
operator|=
name|sc
operator|->
name|connection
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|c
operator|->
name|buffered
condition|)
block|{
return|return;
block|}
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|incomplete
condition|)
block|{
name|ngx_add_timer
argument_list|(
name|c
operator|->
name|read
argument_list|,
name|sscf
operator|->
name|recv_timeout
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ngx_terminate
operator|||
name|ngx_exiting
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|ngx_destroy_pool
argument_list|(
name|sc
operator|->
name|pool
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pool
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|free_ctl_frames
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|free_fake_connections
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
if|if
condition|(
name|c
operator|->
name|ssl
condition|)
block|{
name|ngx_ssl_free_buffer
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|c
operator|->
name|destroyed
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|idle
operator|=
literal|1
expr_stmt|;
name|ngx_reusable_connection
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|c
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_http_empty_handler
expr_stmt|;
name|c
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_http_spdy_keepalive_handler
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|write
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|c
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
name|ngx_add_timer
argument_list|(
name|c
operator|->
name|read
argument_list|,
name|sscf
operator|->
name|keepalive_timeout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_head (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_head
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|uint32_t
name|head
decl_stmt|,
name|flen
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|NGX_SPDY_FRAME_HEADER_SIZE
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_head
argument_list|)
return|;
block|}
name|head
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|flen
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|sc
operator|->
name|flags
operator|=
name|ngx_spdy_frame_flags
argument_list|(
name|flen
argument_list|)
expr_stmt|;
name|sc
operator|->
name|length
operator|=
name|ngx_spdy_frame_length
argument_list|(
name|flen
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy process frame head:%08XD f:%Xd l:%uz"
argument_list|,
name|head
argument_list|,
name|sc
operator|->
name|flags
argument_list|,
name|sc
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_spdy_ctl_frame_check
argument_list|(
name|head
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|ngx_spdy_ctl_frame_type
argument_list|(
name|head
argument_list|)
condition|)
block|{
case|case
name|NGX_SPDY_SYN_STREAM
case|:
return|return
name|ngx_http_spdy_state_syn_stream
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
case|case
name|NGX_SPDY_SYN_REPLY
case|:
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
case|case
name|NGX_SPDY_RST_STREAM
case|:
return|return
name|ngx_http_spdy_state_rst_stream
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
case|case
name|NGX_SPDY_SETTINGS
case|:
return|return
name|ngx_http_spdy_state_settings
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
case|case
name|NGX_SPDY_PING
case|:
return|return
name|ngx_http_spdy_state_ping
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
case|case
name|NGX_SPDY_GOAWAY
case|:
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
comment|/* TODO */
case|case
name|NGX_SPDY_HEADERS
case|:
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
case|case
name|NGX_SPDY_WINDOW_UPDATE
case|:
return|return
name|ngx_http_spdy_state_window_update
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
default|default:
comment|/* TODO logging */
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|ngx_spdy_data_frame_check
argument_list|(
name|head
argument_list|)
condition|)
block|{
name|sc
operator|->
name|stream
operator|=
name|ngx_http_spdy_get_stream_by_id
argument_list|(
name|sc
argument_list|,
name|head
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_data
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
comment|/* TODO version& type check */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy unknown frame"
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_syn_stream (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_syn_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|ngx_uint_t
name|sid
decl_stmt|,
name|prio
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|NGX_SPDY_SYN_STREAM_SIZE
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_syn_stream
argument_list|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|length
operator|<=
name|NGX_SPDY_SYN_STREAM_SIZE
condition|)
block|{
comment|/* TODO logging */
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|sc
operator|->
name|length
operator|-=
name|NGX_SPDY_SYN_STREAM_SIZE
expr_stmt|;
name|sid
operator|=
name|ngx_spdy_frame_parse_sid
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|prio
operator|=
name|pos
index|[
literal|8
index|]
operator|>>
literal|5
expr_stmt|;
name|pos
operator|+=
name|NGX_SPDY_SYN_STREAM_SIZE
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy SYN_STREAM frame sid:%ui prio:%ui"
argument_list|,
name|sid
argument_list|,
name|prio
argument_list|)
expr_stmt|;
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|processing
operator|>=
name|sscf
operator|->
name|concurrent_streams
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy concurrent streams excessed %ui"
argument_list|,
name|sc
operator|->
name|processing
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_spdy_send_rst_stream
argument_list|(
name|sc
argument_list|,
name|sid
argument_list|,
name|NGX_SPDY_REFUSED_STREAM
argument_list|,
name|prio
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_headers_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
name|stream
operator|=
name|ngx_http_spdy_create_stream
argument_list|(
name|sc
argument_list|,
name|sid
argument_list|,
name|prio
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|==
name|NULL
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|stream
operator|->
name|in_closed
operator|=
operator|(
name|sc
operator|->
name|flags
operator|&
name|NGX_SPDY_FLAG_FIN
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|stream
operator|->
name|request
operator|->
name|request_length
operator|=
name|NGX_SPDY_FRAME_HEADER_SIZE
operator|+
name|NGX_SPDY_SYN_STREAM_SIZE
operator|+
name|sc
operator|->
name|length
expr_stmt|;
name|sc
operator|->
name|stream
operator|=
name|stream
expr_stmt|;
name|sc
operator|->
name|last_sid
operator|=
name|sid
expr_stmt|;
return|return
name|ngx_http_spdy_state_headers
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_headers (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_headers
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|int
name|z
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|complete
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|size
operator|=
name|end
operator|-
name|pos
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_headers
argument_list|)
return|;
block|}
if|if
condition|(
name|size
operator|>=
name|sc
operator|->
name|length
condition|)
block|{
name|size
operator|=
name|sc
operator|->
name|length
expr_stmt|;
name|complete
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|complete
operator|=
literal|0
expr_stmt|;
block|}
name|r
operator|=
name|sc
operator|->
name|stream
operator|->
name|request
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy process HEADERS %uz of %uz"
argument_list|,
name|size
argument_list|,
name|sc
operator|->
name|length
argument_list|)
expr_stmt|;
name|buf
operator|=
name|r
operator|->
name|header_in
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|next_in
operator|=
name|pos
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|avail_in
operator|=
name|size
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|next_out
operator|=
name|buf
operator|->
name|last
expr_stmt|;
comment|/* one byte is reserved for null-termination of the last header value */
name|sc
operator|->
name|zstream_in
operator|.
name|avail_out
operator|=
name|buf
operator|->
name|end
operator|-
name|buf
operator|->
name|last
operator|-
literal|1
expr_stmt|;
name|z
operator|=
name|inflate
argument_list|(
operator|&
name|sc
operator|->
name|zstream_in
argument_list|,
name|Z_NO_FLUSH
argument_list|)
expr_stmt|;
if|if
condition|(
name|z
operator|==
name|Z_NEED_DICT
condition|)
block|{
name|z
operator|=
name|inflateSetDictionary
argument_list|(
operator|&
name|sc
operator|->
name|zstream_in
argument_list|,
name|ngx_http_spdy_dict
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_spdy_dict
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|z
operator|!=
name|Z_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy inflateSetDictionary() failed: %d"
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy inflateSetDictionary(): %d"
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|z
operator|=
name|sc
operator|->
name|zstream_in
operator|.
name|avail_in
condition|?
name|inflate
argument_list|(
operator|&
name|sc
operator|->
name|zstream_in
argument_list|,
name|Z_NO_FLUSH
argument_list|)
else|:
name|Z_OK
expr_stmt|;
block|}
if|if
condition|(
name|z
operator|!=
name|Z_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy inflate() failed: %d"
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|ngx_log_debug5
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy inflate out: ni:%p no:%p ai:%ud ao:%ud rc:%d"
argument_list|,
name|sc
operator|->
name|zstream_in
operator|.
name|next_in
argument_list|,
name|sc
operator|->
name|zstream_in
operator|.
name|next_out
argument_list|,
name|sc
operator|->
name|zstream_in
operator|.
name|avail_in
argument_list|,
name|sc
operator|->
name|zstream_in
operator|.
name|avail_out
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|sc
operator|->
name|length
operator|-=
name|sc
operator|->
name|zstream_in
operator|.
name|next_in
operator|-
name|pos
expr_stmt|;
name|pos
operator|=
name|sc
operator|->
name|zstream_in
operator|.
name|next_in
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|sc
operator|->
name|zstream_in
operator|.
name|next_out
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
operator|.
name|elts
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
operator|<
name|NGX_SPDY_NV_NUM_SIZE
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_headers
argument_list|)
return|;
block|}
name|sc
operator|->
name|entries
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|buf
operator|->
name|pos
argument_list|)
expr_stmt|;
name|buf
operator|->
name|pos
operator|+=
name|NGX_SPDY_NV_NUM_SIZE
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy HEADERS block consists of %ui entries"
argument_list|,
name|sc
operator|->
name|entries
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_list_init
argument_list|(
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
argument_list|,
name|r
operator|->
name|pool
argument_list|,
literal|20
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_table_elt_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_headers_error
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|r
operator|->
name|headers_in
operator|.
name|cookies
argument_list|,
name|r
operator|->
name|pool
argument_list|,
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_table_elt_t
operator|*
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_headers_error
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
block|}
while|while
condition|(
name|sc
operator|->
name|entries
condition|)
block|{
name|rc
operator|=
name|ngx_http_spdy_parse_header
argument_list|(
name|r
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rc
condition|)
block|{
case|case
name|NGX_DONE
case|:
name|sc
operator|->
name|entries
operator|--
expr_stmt|;
case|case
name|NGX_OK
case|:
break|break;
case|case
name|NGX_AGAIN
case|:
if|if
condition|(
name|sc
operator|->
name|zstream_in
operator|.
name|avail_in
condition|)
block|{
name|rc
operator|=
name|ngx_http_spdy_alloc_large_header_buffer
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
comment|/* TODO logging */
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_REQUEST_HEADER_TOO_LARGE
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_headers_error
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_headers_error
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
comment|/* null-terminate the last processed header name or value */
operator|*
name|buf
operator|->
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|buf
operator|=
name|r
operator|->
name|header_in
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|next_out
operator|=
name|buf
operator|->
name|last
expr_stmt|;
comment|/* one byte is reserved for null-termination */
name|sc
operator|->
name|zstream_in
operator|.
name|avail_out
operator|=
name|buf
operator|->
name|end
operator|-
name|buf
operator|->
name|last
operator|-
literal|1
expr_stmt|;
name|z
operator|=
name|inflate
argument_list|(
operator|&
name|sc
operator|->
name|zstream_in
argument_list|,
name|Z_NO_FLUSH
argument_list|)
expr_stmt|;
if|if
condition|(
name|z
operator|!=
name|Z_OK
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy inflate() failed: %d"
argument_list|,
name|z
argument_list|)
expr_stmt|;
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|sc
operator|->
name|length
operator|-=
name|sc
operator|->
name|zstream_in
operator|.
name|next_in
operator|-
name|pos
expr_stmt|;
name|pos
operator|=
name|sc
operator|->
name|zstream_in
operator|.
name|next_in
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|sc
operator|->
name|zstream_in
operator|.
name|next_out
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|complete
condition|)
block|{
comment|/* TODO: improve error message */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy again while last chunk"
argument_list|)
expr_stmt|;
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_headers
argument_list|)
return|;
case|case
name|NGX_HTTP_PARSE_INVALID_REQUEST
case|:
comment|/* TODO: improve error message */
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent invalid header line"
argument_list|)
expr_stmt|;
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_headers_error
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
default|default:
comment|/* NGX_HTTP_PARSE_INVALID_HEADER */
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent invalid HEADERS spdy frame"
argument_list|)
expr_stmt|;
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
comment|/* a header line has been parsed successfully */
name|rc
operator|=
name|ngx_http_spdy_handle_request_header
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|rc
operator|==
name|NGX_HTTP_PARSE_INVALID_HEADER
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent invalid HEADERS spdy frame"
argument_list|)
expr_stmt|;
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_HTTP_PARSE_INVALID_REQUEST
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
expr_stmt|;
block|}
return|return
name|ngx_http_spdy_state_headers_error
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|buf
operator|->
name|pos
operator|!=
name|buf
operator|->
name|last
condition|)
block|{
comment|/* TODO: improve error message */
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"end %ui %p %p"
argument_list|,
name|complete
argument_list|,
name|buf
operator|->
name|pos
argument_list|,
name|buf
operator|->
name|last
argument_list|)
expr_stmt|;
name|ngx_http_spdy_close_stream
argument_list|(
name|sc
operator|->
name|stream
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
if|if
condition|(
operator|!
name|complete
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_headers
argument_list|)
return|;
block|}
comment|/* null-terminate the last header value */
operator|*
name|buf
operator|->
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|ngx_http_spdy_run_request
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_headers_error (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_headers_error
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|connection
operator|->
name|error
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_headers_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_headers_skip (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_headers_skip
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|u_char
name|buffer
index|[
name|NGX_SPDY_SKIP_HEADERS_BUFFER_SIZE
index|]
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|length
operator|==
literal|0
condition|)
block|{
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
name|size
operator|=
name|end
operator|-
name|pos
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_headers_skip
argument_list|)
return|;
block|}
name|sc
operator|->
name|zstream_in
operator|.
name|next_in
operator|=
name|pos
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|avail_in
operator|=
operator|(
name|size
operator|<
name|sc
operator|->
name|length
operator|)
condition|?
name|size
else|:
name|sc
operator|->
name|length
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|zstream_in
operator|.
name|avail_in
condition|)
block|{
name|sc
operator|->
name|zstream_in
operator|.
name|next_out
operator|=
name|buffer
expr_stmt|;
name|sc
operator|->
name|zstream_in
operator|.
name|avail_out
operator|=
name|NGX_SPDY_SKIP_HEADERS_BUFFER_SIZE
expr_stmt|;
name|n
operator|=
name|inflate
argument_list|(
operator|&
name|sc
operator|->
name|zstream_in
argument_list|,
name|Z_NO_FLUSH
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy inflate(): %d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|Z_OK
condition|)
block|{
comment|/* TODO: logging */
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
block|}
name|pos
operator|=
name|sc
operator|->
name|zstream_in
operator|.
name|next_in
expr_stmt|;
if|if
condition|(
name|size
operator|<
name|sc
operator|->
name|length
condition|)
block|{
name|sc
operator|->
name|length
operator|-=
name|size
expr_stmt|;
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_headers_skip
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_window_update (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_window_update
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|size_t
name|delta
decl_stmt|;
name|ngx_uint_t
name|sid
decl_stmt|;
name|ngx_event_t
modifier|*
name|wev
decl_stmt|;
name|ngx_queue_t
modifier|*
name|q
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|NGX_SPDY_WINDOW_UPDATE_SIZE
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_window_update
argument_list|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|length
operator|!=
name|NGX_SPDY_WINDOW_UPDATE_SIZE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent WINDOW_UPDATE frame "
literal|"with incorrect length %uz"
argument_list|,
name|sc
operator|->
name|length
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|sid
operator|=
name|ngx_spdy_frame_parse_sid
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|NGX_SPDY_SID_SIZE
expr_stmt|;
name|delta
operator|=
name|ngx_spdy_frame_parse_delta
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|NGX_SPDY_DELTA_SIZE
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy WINDOW_UPDATE sid:%ui delta:%ui"
argument_list|,
name|sid
argument_list|,
name|delta
argument_list|)
expr_stmt|;
if|if
condition|(
name|sid
condition|)
block|{
name|stream
operator|=
name|ngx_http_spdy_get_stream_by_id
argument_list|(
name|sc
argument_list|,
name|sid
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent WINDOW_UPDATE frame "
literal|"for unknown stream %ui"
argument_list|,
name|sid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_spdy_send_rst_stream
argument_list|(
name|sc
argument_list|,
name|sid
argument_list|,
name|NGX_SPDY_INVALID_STREAM
argument_list|,
name|NGX_SPDY_LOWEST_PRIORITY
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
if|if
condition|(
name|stream
operator|->
name|send_window
operator|>
operator|(
name|ssize_t
operator|)
operator|(
name|NGX_SPDY_MAX_WINDOW
operator|-
name|delta
operator|)
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client violated flow control for stream %ui: "
literal|"received WINDOW_UPDATE frame with delta %uz "
literal|"that is not allowed for window %z"
argument_list|,
name|sid
argument_list|,
name|delta
argument_list|,
name|stream
operator|->
name|send_window
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_spdy_terminate_stream
argument_list|(
name|sc
argument_list|,
name|stream
argument_list|,
name|NGX_SPDY_FLOW_CONTROL_ERROR
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
name|stream
operator|->
name|send_window
operator|+=
name|delta
expr_stmt|;
if|if
condition|(
name|stream
operator|->
name|exhausted
condition|)
block|{
name|stream
operator|->
name|exhausted
operator|=
literal|0
expr_stmt|;
name|wev
operator|=
name|stream
operator|->
name|request
operator|->
name|connection
operator|->
name|write
expr_stmt|;
if|if
condition|(
operator|!
name|wev
operator|->
name|timer_set
condition|)
block|{
name|wev
operator|->
name|delayed
operator|=
literal|0
expr_stmt|;
name|wev
operator|->
name|handler
argument_list|(
name|wev
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|sc
operator|->
name|send_window
operator|+=
name|delta
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|send_window
operator|>
name|NGX_SPDY_MAX_WINDOW
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client violated connection flow control: "
literal|"received WINDOW_UPDATE frame with delta %uz "
literal|"that is not allowed for window %uz"
argument_list|,
name|delta
argument_list|,
name|sc
operator|->
name|send_window
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
while|while
condition|(
operator|!
name|ngx_queue_empty
argument_list|(
operator|&
name|sc
operator|->
name|waiting
argument_list|)
condition|)
block|{
name|q
operator|=
name|ngx_queue_head
argument_list|(
operator|&
name|sc
operator|->
name|waiting
argument_list|)
expr_stmt|;
name|ngx_queue_remove
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|stream
operator|=
name|ngx_queue_data
argument_list|(
name|q
argument_list|,
name|ngx_http_spdy_stream_t
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|stream
operator|->
name|handled
operator|=
literal|0
expr_stmt|;
name|wev
operator|=
name|stream
operator|->
name|request
operator|->
name|connection
operator|->
name|write
expr_stmt|;
if|if
condition|(
operator|!
name|wev
operator|->
name|timer_set
condition|)
block|{
name|wev
operator|->
name|delayed
operator|=
literal|0
expr_stmt|;
name|wev
operator|->
name|handler
argument_list|(
name|wev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|send_window
operator|==
literal|0
condition|)
block|{
break|break;
block|}
block|}
block|}
block|}
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_data (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_data
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|stream
operator|=
name|sc
operator|->
name|stream
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy DATA frame"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|length
operator|>
name|sc
operator|->
name|recv_window
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client violated connection flow control: length of "
literal|"received DATA frame %uz, while available window %uz"
argument_list|,
name|stream
operator|->
name|id
argument_list|,
name|sc
operator|->
name|length
argument_list|,
name|sc
operator|->
name|recv_window
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|sc
operator|->
name|recv_window
operator|-=
name|sc
operator|->
name|length
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|recv_window
operator|<
name|NGX_SPDY_MAX_WINDOW
operator|/
literal|4
condition|)
block|{
if|if
condition|(
name|ngx_http_spdy_send_window_update
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
name|NGX_SPDY_MAX_WINDOW
operator|-
name|sc
operator|->
name|recv_window
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|sc
operator|->
name|recv_window
operator|=
name|NGX_SPDY_MAX_WINDOW
expr_stmt|;
block|}
if|if
condition|(
name|stream
operator|==
name|NULL
condition|)
block|{
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|length
operator|>
name|stream
operator|->
name|recv_window
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client violated flow control for stream %ui: length of "
literal|"received DATA frame %uz, while available window %uz"
argument_list|,
name|stream
operator|->
name|id
argument_list|,
name|sc
operator|->
name|length
argument_list|,
name|stream
operator|->
name|recv_window
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_spdy_terminate_stream
argument_list|(
name|sc
argument_list|,
name|stream
argument_list|,
name|NGX_SPDY_FLOW_CONTROL_ERROR
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
name|stream
operator|->
name|recv_window
operator|-=
name|sc
operator|->
name|length
expr_stmt|;
if|if
condition|(
name|stream
operator|->
name|recv_window
operator|<
name|NGX_SPDY_STREAM_WINDOW
operator|/
literal|4
condition|)
block|{
if|if
condition|(
name|ngx_http_spdy_send_window_update
argument_list|(
name|sc
argument_list|,
name|stream
operator|->
name|id
argument_list|,
name|NGX_SPDY_STREAM_WINDOW
operator|-
name|stream
operator|->
name|recv_window
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|stream
operator|->
name|recv_window
operator|=
name|NGX_SPDY_STREAM_WINDOW
expr_stmt|;
block|}
if|if
condition|(
name|stream
operator|->
name|in_closed
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent DATA frame for half closed stream %ui"
argument_list|,
name|stream
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_spdy_terminate_stream
argument_list|(
name|sc
argument_list|,
name|stream
argument_list|,
name|NGX_SPDY_STREAM_ALREADY_CLOSED
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_read_data
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_read_data (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_read_data
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|complete
decl_stmt|;
name|ngx_temp_file_t
modifier|*
name|tf
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|ngx_http_request_body_t
modifier|*
name|rb
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|stream
operator|=
name|sc
operator|->
name|stream
expr_stmt|;
if|if
condition|(
name|stream
operator|==
name|NULL
condition|)
block|{
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
if|if
condition|(
name|stream
operator|->
name|skip_data
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|NGX_SPDY_FLAG_FIN
condition|)
block|{
name|stream
operator|->
name|in_closed
operator|=
literal|1
expr_stmt|;
block|}
comment|/* TODO log and accounting */
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
name|size
operator|=
name|end
operator|-
name|pos
expr_stmt|;
if|if
condition|(
name|size
operator|>=
name|sc
operator|->
name|length
condition|)
block|{
name|size
operator|=
name|sc
operator|->
name|length
expr_stmt|;
name|complete
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|length
operator|-=
name|size
expr_stmt|;
name|complete
operator|=
literal|0
expr_stmt|;
block|}
name|r
operator|=
name|stream
operator|->
name|request
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|request_body
operator|==
name|NULL
operator|&&
name|ngx_http_spdy_init_request_body
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|stream
operator|->
name|skip_data
operator|=
name|NGX_SPDY_DATA_INTERNAL_ERROR
expr_stmt|;
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
name|rb
operator|=
name|r
operator|->
name|request_body
expr_stmt|;
name|tf
operator|=
name|rb
operator|->
name|temp_file
expr_stmt|;
name|buf
operator|=
name|rb
operator|->
name|buf
expr_stmt|;
if|if
condition|(
name|size
condition|)
block|{
name|rb
operator|->
name|rest
operator|+=
name|size
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
operator|!=
operator|-
literal|1
operator|&&
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
operator|<
name|rb
operator|->
name|rest
condition|)
block|{
comment|/* TODO logging */
name|stream
operator|->
name|skip_data
operator|=
name|NGX_SPDY_DATA_ERROR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
else|else
block|{
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|clcf
operator|->
name|client_max_body_size
operator|&&
name|clcf
operator|->
name|client_max_body_size
operator|<
name|rb
operator|->
name|rest
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client intended to send too large chunked "
literal|"body: %O bytes"
argument_list|,
name|rb
operator|->
name|rest
argument_list|)
expr_stmt|;
name|stream
operator|->
name|skip_data
operator|=
name|NGX_SPDY_DATA_ERROR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
if|if
condition|(
name|tf
condition|)
block|{
name|buf
operator|->
name|start
operator|=
name|pos
expr_stmt|;
name|buf
operator|->
name|pos
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|size
expr_stmt|;
name|buf
operator|->
name|end
operator|=
name|pos
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|pos
expr_stmt|;
name|n
operator|=
name|ngx_write_chain_to_temp_file
argument_list|(
name|tf
argument_list|,
name|rb
operator|->
name|bufs
argument_list|)
expr_stmt|;
comment|/* TODO: n == 0 or not complete and level event */
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
name|stream
operator|->
name|skip_data
operator|=
name|NGX_SPDY_DATA_INTERNAL_ERROR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|tf
operator|->
name|offset
operator|+=
name|n
expr_stmt|;
block|}
else|else
block|{
name|buf
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|buf
operator|->
name|last
argument_list|,
name|pos
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|size
expr_stmt|;
block|}
name|r
operator|->
name|request_length
operator|+=
name|size
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|complete
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_read_data
argument_list|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|flags
operator|&
name|NGX_SPDY_FLAG_FIN
condition|)
block|{
name|stream
operator|->
name|in_closed
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tf
condition|)
block|{
name|ngx_memzero
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_buf_t
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|->
name|in_file
operator|=
literal|1
expr_stmt|;
name|buf
operator|->
name|file_last
operator|=
name|tf
operator|->
name|file
operator|.
name|offset
expr_stmt|;
name|buf
operator|->
name|file
operator|=
operator|&
name|tf
operator|->
name|file
expr_stmt|;
name|rb
operator|->
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
operator|<
literal|0
condition|)
block|{
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
operator|=
name|rb
operator|->
name|rest
expr_stmt|;
block|}
if|if
condition|(
name|rb
operator|->
name|post_handler
condition|)
block|{
name|r
operator|->
name|read_event_handler
operator|=
name|ngx_http_block_reading
expr_stmt|;
name|rb
operator|->
name|post_handler
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
name|error
label|:
if|if
condition|(
name|rb
operator|->
name|post_handler
condition|)
block|{
if|if
condition|(
name|stream
operator|->
name|skip_data
operator|==
name|NGX_SPDY_DATA_ERROR
condition|)
block|{
name|rc
operator|=
operator|(
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
operator|==
operator|-
literal|1
operator|)
condition|?
name|NGX_HTTP_REQUEST_ENTITY_TOO_LARGE
else|:
name|NGX_HTTP_BAD_REQUEST
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|NGX_HTTP_INTERNAL_SERVER_ERROR
expr_stmt|;
block|}
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
return|return
name|ngx_http_spdy_state_skip
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_rst_stream (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_rst_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|ngx_uint_t
name|sid
decl_stmt|,
name|status
decl_stmt|;
name|ngx_event_t
modifier|*
name|ev
decl_stmt|;
name|ngx_connection_t
modifier|*
name|fc
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|NGX_SPDY_RST_STREAM_SIZE
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_rst_stream
argument_list|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|length
operator|!=
name|NGX_SPDY_RST_STREAM_SIZE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent RST_STREAM frame with incorrect length %uz"
argument_list|,
name|sc
operator|->
name|length
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|sid
operator|=
name|ngx_spdy_frame_parse_sid
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|NGX_SPDY_SID_SIZE
expr_stmt|;
name|status
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy RST_STREAM sid:%ui st:%ui"
argument_list|,
name|sid
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|stream
operator|=
name|ngx_http_spdy_get_stream_by_id
argument_list|(
name|sc
argument_list|,
name|sid
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|==
name|NULL
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown stream, probably it has been closed already"
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
name|stream
operator|->
name|in_closed
operator|=
literal|1
expr_stmt|;
name|stream
operator|->
name|out_closed
operator|=
literal|1
expr_stmt|;
name|fc
operator|=
name|stream
operator|->
name|request
operator|->
name|connection
expr_stmt|;
name|fc
operator|->
name|error
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|NGX_SPDY_CANCEL
case|:
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|fc
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client canceled stream %ui"
argument_list|,
name|sid
argument_list|)
expr_stmt|;
break|break;
case|case
name|NGX_SPDY_INTERNAL_ERROR
case|:
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|fc
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client terminated stream %ui because of internal error"
argument_list|,
name|sid
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|fc
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client terminated stream %ui with status %ui"
argument_list|,
name|sid
argument_list|,
name|status
argument_list|)
expr_stmt|;
break|break;
block|}
name|ev
operator|=
name|fc
operator|->
name|read
expr_stmt|;
name|ev
operator|->
name|handler
argument_list|(
name|ev
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_ping (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_ping
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|NGX_SPDY_PING_SIZE
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_ping
argument_list|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|length
operator|!=
name|NGX_SPDY_PING_SIZE
condition|)
block|{
comment|/* TODO logging */
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy PING frame"
argument_list|)
expr_stmt|;
name|frame
operator|=
name|ngx_http_spdy_get_ctl_frame
argument_list|(
name|sc
argument_list|,
name|NGX_SPDY_PING_SIZE
argument_list|,
name|NGX_SPDY_HIGHEST_PRIORITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame
operator|==
name|NULL
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|buf
operator|=
name|frame
operator|->
name|first
operator|->
name|buf
expr_stmt|;
name|p
operator|=
name|buf
operator|->
name|pos
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_head
argument_list|(
name|p
argument_list|,
name|NGX_SPDY_PING
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_flags_and_len
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|NGX_SPDY_PING_SIZE
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|pos
argument_list|,
name|NGX_SPDY_PING_SIZE
argument_list|)
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|p
expr_stmt|;
name|ngx_http_spdy_queue_frame
argument_list|(
name|sc
argument_list|,
name|frame
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|NGX_SPDY_PING_SIZE
expr_stmt|;
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_skip (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_skip
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|size
operator|=
name|end
operator|-
name|pos
expr_stmt|;
if|if
condition|(
name|size
operator|<
name|sc
operator|->
name|length
condition|)
block|{
name|sc
operator|->
name|length
operator|-=
name|size
expr_stmt|;
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|end
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_skip
argument_list|)
return|;
block|}
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
operator|+
name|sc
operator|->
name|length
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_settings (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_settings
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|ngx_uint_t
name|fid
decl_stmt|,
name|val
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|entries
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|NGX_SPDY_SETTINGS_NUM_SIZE
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_settings
argument_list|)
return|;
block|}
name|sc
operator|->
name|entries
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|NGX_SPDY_SETTINGS_NUM_SIZE
expr_stmt|;
name|sc
operator|->
name|length
operator|-=
name|NGX_SPDY_SETTINGS_NUM_SIZE
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|length
operator|<
name|sc
operator|->
name|entries
operator|*
name|NGX_SPDY_SETTINGS_PAIR_SIZE
condition|)
block|{
comment|/* TODO logging */
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy SETTINGS frame consists of %ui entries"
argument_list|,
name|sc
operator|->
name|entries
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|sc
operator|->
name|entries
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|NGX_SPDY_SETTINGS_PAIR_SIZE
condition|)
block|{
return|return
name|ngx_http_spdy_state_save
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
name|ngx_http_spdy_state_settings
argument_list|)
return|;
block|}
name|sc
operator|->
name|entries
operator|--
expr_stmt|;
name|sc
operator|->
name|length
operator|-=
name|NGX_SPDY_SETTINGS_PAIR_SIZE
expr_stmt|;
name|fid
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|NGX_SPDY_SETTINGS_FID_SIZE
expr_stmt|;
name|val
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|NGX_SPDY_SETTINGS_VAL_SIZE
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy SETTINGS entry fl:%ui id:%ui val:%ui"
argument_list|,
name|ngx_spdy_frame_flags
argument_list|(
name|fid
argument_list|)
argument_list|,
name|ngx_spdy_frame_id
argument_list|(
name|fid
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_spdy_frame_flags
argument_list|(
name|fid
argument_list|)
operator|==
name|NGX_SPDY_SETTINGS_FLAG_PERSISTED
condition|)
block|{
continue|continue;
block|}
switch|switch
condition|(
name|ngx_spdy_frame_id
argument_list|(
name|fid
argument_list|)
condition|)
block|{
case|case
name|NGX_SPDY_SETTINGS_INIT_WINDOW
case|:
if|if
condition|(
name|val
operator|>
name|NGX_SPDY_MAX_WINDOW
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent SETTINGS frame with "
literal|"incorrect INIT_WINDOW value: %ui"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_protocol_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
if|if
condition|(
name|ngx_http_spdy_adjust_windows
argument_list|(
name|sc
argument_list|,
name|val
operator|-
name|sc
operator|->
name|init_window
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
name|sc
operator|->
name|init_window
operator|=
name|val
expr_stmt|;
continue|continue;
block|}
block|}
return|return
name|ngx_http_spdy_state_complete
argument_list|(
name|sc
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_complete (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end)
name|ngx_http_spdy_state_complete
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|)
block|{
name|sc
operator|->
name|handler
operator|=
name|ngx_http_spdy_state_head
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_save (ngx_http_spdy_connection_t * sc,u_char * pos,u_char * end,ngx_http_spdy_handler_pt handler)
name|ngx_http_spdy_state_save
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|pos
parameter_list|,
name|u_char
modifier|*
name|end
parameter_list|,
name|ngx_http_spdy_handler_pt
name|handler
parameter_list|)
block|{
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
if|if
condition|(
name|end
operator|-
name|pos
operator|>
name|NGX_SPDY_STATE_BUFFER_SIZE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy state buffer overflow: "
literal|"%z bytes required"
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
return|return
name|ngx_http_spdy_state_internal_error
argument_list|(
name|sc
argument_list|)
return|;
block|}
endif|#
directive|endif
name|ngx_memcpy
argument_list|(
name|sc
operator|->
name|buffer
argument_list|,
name|pos
argument_list|,
name|NGX_SPDY_STATE_BUFFER_SIZE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|buffer_used
operator|=
name|end
operator|-
name|pos
expr_stmt|;
name|sc
operator|->
name|handler
operator|=
name|handler
expr_stmt|;
name|sc
operator|->
name|incomplete
operator|=
literal|1
expr_stmt|;
return|return
name|end
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_protocol_error (ngx_http_spdy_connection_t * sc)
name|ngx_http_spdy_state_protocol_error
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy state protocol error"
argument_list|)
expr_stmt|;
comment|/* TODO */
name|ngx_http_spdy_finalize_connection
argument_list|(
name|sc
argument_list|,
name|NGX_HTTP_CLIENT_CLOSED_REQUEST
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_spdy_state_internal_error (ngx_http_spdy_connection_t * sc)
name|ngx_http_spdy_state_internal_error
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy state internal error"
argument_list|)
expr_stmt|;
comment|/* TODO */
name|ngx_http_spdy_finalize_connection
argument_list|(
name|sc
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_send_window_update (ngx_http_spdy_connection_t * sc,ngx_uint_t sid,ngx_uint_t delta)
name|ngx_http_spdy_send_window_update
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_uint_t
name|sid
parameter_list|,
name|ngx_uint_t
name|delta
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
decl_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy write WINDOW_UPDATE sid:%ui delta:%ui"
argument_list|,
name|sid
argument_list|,
name|delta
argument_list|)
expr_stmt|;
name|frame
operator|=
name|ngx_http_spdy_get_ctl_frame
argument_list|(
name|sc
argument_list|,
name|NGX_SPDY_WINDOW_UPDATE_SIZE
argument_list|,
name|NGX_SPDY_HIGHEST_PRIORITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|buf
operator|=
name|frame
operator|->
name|first
operator|->
name|buf
expr_stmt|;
name|p
operator|=
name|buf
operator|->
name|pos
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_head
argument_list|(
name|p
argument_list|,
name|NGX_SPDY_WINDOW_UPDATE
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_flags_and_len
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|NGX_SPDY_WINDOW_UPDATE_SIZE
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_sid
argument_list|(
name|p
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_aligned_write_uint32
argument_list|(
name|p
argument_list|,
name|delta
argument_list|)
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|p
expr_stmt|;
name|ngx_http_spdy_queue_frame
argument_list|(
name|sc
argument_list|,
name|frame
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_send_rst_stream (ngx_http_spdy_connection_t * sc,ngx_uint_t sid,ngx_uint_t status,ngx_uint_t priority)
name|ngx_http_spdy_send_rst_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_uint_t
name|sid
parameter_list|,
name|ngx_uint_t
name|status
parameter_list|,
name|ngx_uint_t
name|priority
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|connection
operator|->
name|error
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy write RST_STREAM sid:%ui st:%ui"
argument_list|,
name|sid
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|frame
operator|=
name|ngx_http_spdy_get_ctl_frame
argument_list|(
name|sc
argument_list|,
name|NGX_SPDY_RST_STREAM_SIZE
argument_list|,
name|priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|buf
operator|=
name|frame
operator|->
name|first
operator|->
name|buf
expr_stmt|;
name|p
operator|=
name|buf
operator|->
name|pos
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_head
argument_list|(
name|p
argument_list|,
name|NGX_SPDY_RST_STREAM
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_flags_and_len
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|NGX_SPDY_RST_STREAM_SIZE
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_sid
argument_list|(
name|p
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_aligned_write_uint32
argument_list|(
name|p
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|p
expr_stmt|;
name|ngx_http_spdy_queue_frame
argument_list|(
name|sc
argument_list|,
name|frame
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static ngx_int_t ngx_http_spdy_send_goaway(ngx_http_spdy_connection_t *sc) {     u_char                     *p;     ngx_buf_t                  *buf;     ngx_http_spdy_out_frame_t  *frame;      ngx_log_debug1(NGX_LOG_DEBUG_HTTP, sc->connection->log, 0,                    "spdy create GOAWAY sid:%ui", sc->last_sid);      frame = ngx_http_spdy_get_ctl_frame(sc, NGX_SPDY_GOAWAY_SIZE,                                         NGX_SPDY_HIGHEST_PRIORITY);     if (frame == NULL) {         return NGX_ERROR;     }      buf = frame->first->buf;      p = buf->pos;      p = ngx_spdy_frame_write_head(p, NGX_SPDY_GOAWAY);     p = ngx_spdy_frame_write_flags_and_len(p, 0, NGX_SPDY_GOAWAY_SIZE);      p = ngx_spdy_frame_write_sid(p, sc->last_sid);      buf->last = p;      ngx_http_spdy_queue_frame(sc, frame);      return NGX_OK; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_send_settings (ngx_http_spdy_connection_t * sc)
name|ngx_http_spdy_send_settings
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy create SETTINGS frame"
argument_list|)
expr_stmt|;
name|frame
operator|=
name|ngx_palloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_spdy_out_frame_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cl
operator|=
name|ngx_alloc_chain_link
argument_list|(
name|sc
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|buf
operator|=
name|ngx_create_temp_buf
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
name|NGX_SPDY_FRAME_HEADER_SIZE
operator|+
name|NGX_SPDY_SETTINGS_NUM_SIZE
operator|+
literal|2
operator|*
name|NGX_SPDY_SETTINGS_PAIR_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|buf
operator|->
name|last_buf
operator|=
literal|1
expr_stmt|;
name|cl
operator|->
name|buf
operator|=
name|buf
expr_stmt|;
name|cl
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|frame
operator|->
name|first
operator|=
name|cl
expr_stmt|;
name|frame
operator|->
name|last
operator|=
name|cl
expr_stmt|;
name|frame
operator|->
name|handler
operator|=
name|ngx_http_spdy_settings_frame_handler
expr_stmt|;
name|frame
operator|->
name|stream
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
name|frame
operator|->
name|length
operator|=
name|NGX_SPDY_SETTINGS_NUM_SIZE
operator|+
literal|2
operator|*
name|NGX_SPDY_SETTINGS_PAIR_SIZE
expr_stmt|;
endif|#
directive|endif
name|frame
operator|->
name|priority
operator|=
name|NGX_SPDY_HIGHEST_PRIORITY
expr_stmt|;
name|frame
operator|->
name|blocked
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|buf
operator|->
name|pos
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_head
argument_list|(
name|p
argument_list|,
name|NGX_SPDY_SETTINGS
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_flags_and_len
argument_list|(
name|p
argument_list|,
name|NGX_SPDY_FLAG_CLEAR_SETTINGS
argument_list|,
name|NGX_SPDY_SETTINGS_NUM_SIZE
operator|+
literal|2
operator|*
name|NGX_SPDY_SETTINGS_PAIR_SIZE
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_aligned_write_uint32
argument_list|(
name|p
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_flags_and_id
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|NGX_SPDY_SETTINGS_MAX_STREAMS
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_aligned_write_uint32
argument_list|(
name|p
argument_list|,
name|sscf
operator|->
name|concurrent_streams
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_write_flags_and_id
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
name|NGX_SPDY_SETTINGS_INIT_WINDOW
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_spdy_frame_aligned_write_uint32
argument_list|(
name|p
argument_list|,
name|NGX_SPDY_STREAM_WINDOW
argument_list|)
expr_stmt|;
name|buf
operator|->
name|last
operator|=
name|p
expr_stmt|;
name|ngx_http_spdy_queue_frame
argument_list|(
name|sc
argument_list|,
name|frame
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_spdy_settings_frame_handler (ngx_http_spdy_connection_t * sc,ngx_http_spdy_out_frame_t * frame)
name|ngx_http_spdy_settings_frame_handler
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
parameter_list|)
block|{
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|frame
operator|->
name|first
operator|->
name|buf
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pos
operator|!=
name|buf
operator|->
name|last
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|ngx_free_chain
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
name|frame
operator|->
name|first
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_spdy_out_frame_t
modifier|*
DECL|function|ngx_http_spdy_get_ctl_frame (ngx_http_spdy_connection_t * sc,size_t length,ngx_uint_t priority)
name|ngx_http_spdy_get_ctl_frame
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|size_t
name|length
parameter_list|,
name|ngx_uint_t
name|priority
parameter_list|)
block|{
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|;
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
decl_stmt|;
name|frame
operator|=
name|sc
operator|->
name|free_ctl_frames
expr_stmt|;
if|if
condition|(
name|frame
condition|)
block|{
name|sc
operator|->
name|free_ctl_frames
operator|=
name|frame
operator|->
name|next
expr_stmt|;
name|cl
operator|=
name|frame
operator|->
name|first
expr_stmt|;
name|cl
operator|->
name|buf
operator|->
name|pos
operator|=
name|cl
operator|->
name|buf
operator|->
name|start
expr_stmt|;
block|}
else|else
block|{
name|frame
operator|=
name|ngx_palloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_spdy_out_frame_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|frame
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|cl
operator|=
name|ngx_alloc_chain_link
argument_list|(
name|sc
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|cl
operator|->
name|buf
operator|=
name|ngx_create_temp_buf
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
name|NGX_SPDY_CTL_FRAME_BUFFER_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cl
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|cl
operator|->
name|buf
operator|->
name|last_buf
operator|=
literal|1
expr_stmt|;
name|frame
operator|->
name|first
operator|=
name|cl
expr_stmt|;
name|frame
operator|->
name|last
operator|=
name|cl
expr_stmt|;
name|frame
operator|->
name|handler
operator|=
name|ngx_http_spdy_ctl_frame_handler
expr_stmt|;
name|frame
operator|->
name|stream
operator|=
name|NULL
expr_stmt|;
block|}
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
if|if
condition|(
name|length
operator|>
name|NGX_SPDY_CTL_FRAME_BUFFER_SIZE
operator|-
name|NGX_SPDY_FRAME_HEADER_SIZE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|sc
operator|->
name|pool
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"requested control frame is too big: %uz"
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|frame
operator|->
name|length
operator|=
name|length
expr_stmt|;
endif|#
directive|endif
name|frame
operator|->
name|priority
operator|=
name|priority
expr_stmt|;
name|frame
operator|->
name|blocked
operator|=
literal|0
expr_stmt|;
return|return
name|frame
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_ctl_frame_handler (ngx_http_spdy_connection_t * sc,ngx_http_spdy_out_frame_t * frame)
name|ngx_http_spdy_ctl_frame_handler
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_http_spdy_out_frame_t
modifier|*
name|frame
parameter_list|)
block|{
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|frame
operator|->
name|first
operator|->
name|buf
expr_stmt|;
if|if
condition|(
name|buf
operator|->
name|pos
operator|!=
name|buf
operator|->
name|last
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|frame
operator|->
name|next
operator|=
name|sc
operator|->
name|free_ctl_frames
expr_stmt|;
name|sc
operator|->
name|free_ctl_frames
operator|=
name|frame
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_spdy_stream_t
modifier|*
DECL|function|ngx_http_spdy_create_stream (ngx_http_spdy_connection_t * sc,ngx_uint_t id,ngx_uint_t priority)
name|ngx_http_spdy_create_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_uint_t
name|id
parameter_list|,
name|ngx_uint_t
name|priority
parameter_list|)
block|{
name|ngx_log_t
modifier|*
name|log
decl_stmt|;
name|ngx_uint_t
name|index
decl_stmt|;
name|ngx_event_t
modifier|*
name|rev
decl_stmt|,
modifier|*
name|wev
decl_stmt|;
name|ngx_connection_t
modifier|*
name|fc
decl_stmt|;
name|ngx_http_log_ctx_t
modifier|*
name|ctx
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|ngx_http_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
name|fc
operator|=
name|sc
operator|->
name|free_fake_connections
expr_stmt|;
if|if
condition|(
name|fc
condition|)
block|{
name|sc
operator|->
name|free_fake_connections
operator|=
name|fc
operator|->
name|data
expr_stmt|;
name|rev
operator|=
name|fc
operator|->
name|read
expr_stmt|;
name|wev
operator|=
name|fc
operator|->
name|write
expr_stmt|;
name|log
operator|=
name|fc
operator|->
name|log
expr_stmt|;
name|ctx
operator|=
name|log
operator|->
name|data
expr_stmt|;
block|}
else|else
block|{
name|fc
operator|=
name|ngx_palloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_connection_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fc
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|rev
operator|=
name|ngx_palloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_event_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|wev
operator|=
name|ngx_palloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_event_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wev
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|log
operator|=
name|ngx_palloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_log_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|log
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ctx
operator|=
name|ngx_palloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_log_ctx_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ctx
operator|->
name|connection
operator|=
name|fc
expr_stmt|;
name|ctx
operator|->
name|request
operator|=
name|NULL
expr_stmt|;
block|}
name|ngx_memcpy
argument_list|(
name|log
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_log_t
argument_list|)
argument_list|)
expr_stmt|;
name|log
operator|->
name|data
operator|=
name|ctx
expr_stmt|;
name|ngx_memzero
argument_list|(
name|rev
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_event_t
argument_list|)
argument_list|)
expr_stmt|;
name|rev
operator|->
name|data
operator|=
name|fc
expr_stmt|;
name|rev
operator|->
name|ready
operator|=
literal|1
expr_stmt|;
name|rev
operator|->
name|handler
operator|=
name|ngx_http_spdy_close_stream_handler
expr_stmt|;
name|rev
operator|->
name|log
operator|=
name|log
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|wev
argument_list|,
name|rev
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_event_t
argument_list|)
argument_list|)
expr_stmt|;
name|wev
operator|->
name|write
operator|=
literal|1
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|fc
argument_list|,
name|sc
operator|->
name|connection
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_connection_t
argument_list|)
argument_list|)
expr_stmt|;
name|fc
operator|->
name|data
operator|=
name|sc
operator|->
name|http_connection
expr_stmt|;
name|fc
operator|->
name|read
operator|=
name|rev
expr_stmt|;
name|fc
operator|->
name|write
operator|=
name|wev
expr_stmt|;
name|fc
operator|->
name|sent
operator|=
literal|0
expr_stmt|;
name|fc
operator|->
name|log
operator|=
name|log
expr_stmt|;
name|fc
operator|->
name|buffered
operator|=
literal|0
expr_stmt|;
name|fc
operator|->
name|sndlowat
operator|=
literal|1
expr_stmt|;
name|fc
operator|->
name|tcp_nodelay
operator|=
name|NGX_TCP_NODELAY_DISABLED
expr_stmt|;
name|r
operator|=
name|ngx_http_create_request
argument_list|(
name|fc
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|r
operator|->
name|valid_location
operator|=
literal|1
expr_stmt|;
name|fc
operator|->
name|data
operator|=
name|r
expr_stmt|;
name|sc
operator|->
name|connection
operator|->
name|requests
operator|++
expr_stmt|;
name|cscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|r
operator|->
name|header_in
operator|=
name|ngx_create_temp_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|cscf
operator|->
name|client_header_buffer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|header_in
operator|==
name|NULL
condition|)
block|{
name|ngx_http_free_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|r
operator|->
name|headers_in
operator|.
name|connection_type
operator|=
name|NGX_HTTP_CONNECTION_CLOSE
expr_stmt|;
name|stream
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_spdy_stream_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|==
name|NULL
condition|)
block|{
name|ngx_http_free_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|r
operator|->
name|spdy_stream
operator|=
name|stream
expr_stmt|;
name|stream
operator|->
name|id
operator|=
name|id
expr_stmt|;
name|stream
operator|->
name|request
operator|=
name|r
expr_stmt|;
name|stream
operator|->
name|connection
operator|=
name|sc
expr_stmt|;
name|stream
operator|->
name|send_window
operator|=
name|sc
operator|->
name|init_window
expr_stmt|;
name|stream
operator|->
name|recv_window
operator|=
name|NGX_SPDY_STREAM_WINDOW
expr_stmt|;
name|stream
operator|->
name|priority
operator|=
name|priority
expr_stmt|;
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|index
operator|=
name|ngx_http_spdy_stream_index
argument_list|(
name|sscf
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|stream
operator|->
name|index
operator|=
name|sc
operator|->
name|streams_index
index|[
name|index
index|]
expr_stmt|;
name|sc
operator|->
name|streams_index
index|[
name|index
index|]
operator|=
name|stream
expr_stmt|;
name|sc
operator|->
name|processing
operator|++
expr_stmt|;
return|return
name|stream
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_spdy_stream_t
modifier|*
DECL|function|ngx_http_spdy_get_stream_by_id (ngx_http_spdy_connection_t * sc,ngx_uint_t sid)
name|ngx_http_spdy_get_stream_by_id
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_uint_t
name|sid
parameter_list|)
block|{
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|stream
operator|=
name|sc
operator|->
name|streams_index
index|[
name|ngx_http_spdy_stream_index
argument_list|(
name|sscf
argument_list|,
name|sid
argument_list|)
index|]
expr_stmt|;
while|while
condition|(
name|stream
condition|)
block|{
if|if
condition|(
name|stream
operator|->
name|id
operator|==
name|sid
condition|)
block|{
return|return
name|stream
return|;
block|}
name|stream
operator|=
name|stream
operator|->
name|index
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_parse_header (ngx_http_request_t * r)
name|ngx_http_spdy_parse_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|end
decl_stmt|,
name|ch
decl_stmt|;
name|ngx_uint_t
name|hash
decl_stmt|;
name|ngx_http_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
DECL|enum|__anon2b38ba1c0203
enum|enum
block|{
DECL|enumerator|sw_name_len
name|sw_name_len
init|=
literal|0
block|,
DECL|enumerator|sw_name
name|sw_name
block|,
DECL|enumerator|sw_value_len
name|sw_value_len
block|,
DECL|enumerator|sw_value
name|sw_value
block|}
name|state
enum|;
name|state
operator|=
name|r
operator|->
name|state
expr_stmt|;
name|p
operator|=
name|r
operator|->
name|header_in
operator|->
name|pos
expr_stmt|;
name|end
operator|=
name|r
operator|->
name|header_in
operator|->
name|last
expr_stmt|;
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|sw_name_len
case|:
if|if
condition|(
name|end
operator|-
name|p
operator|<
name|NGX_SPDY_NV_NLEN_SIZE
condition|)
block|{
return|return
name|NGX_AGAIN
return|;
block|}
name|r
operator|->
name|lowcase_index
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|lowcase_index
operator|==
literal|0
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
comment|/* null-terminate the previous header value */
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|+=
name|NGX_SPDY_NV_NLEN_SIZE
expr_stmt|;
name|r
operator|->
name|invalid_header
operator|=
literal|0
expr_stmt|;
name|state
operator|=
name|sw_name
expr_stmt|;
comment|/* fall through */
case|case
name|sw_name
case|:
if|if
condition|(
operator|(
name|ngx_uint_t
operator|)
operator|(
name|end
operator|-
name|p
operator|)
operator|<
name|r
operator|->
name|lowcase_index
condition|)
block|{
break|break;
block|}
name|cscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|r
operator|->
name|header_name_start
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_name_end
operator|=
name|p
operator|+
name|r
operator|->
name|lowcase_index
expr_stmt|;
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
literal|':'
condition|)
block|{
name|p
operator|++
expr_stmt|;
block|}
name|hash
operator|=
literal|0
expr_stmt|;
for|for
control|(
comment|/* void */
init|;
name|p
operator|!=
name|r
operator|->
name|header_name_end
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
name|hash
operator|=
name|ngx_hash
argument_list|(
name|hash
argument_list|,
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|>=
literal|'a'
operator|&&
name|ch
operator|<=
literal|'z'
operator|)
operator|||
operator|(
name|ch
operator|==
literal|'-'
operator|)
operator|||
operator|(
name|ch
operator|>=
literal|'0'
operator|&&
name|ch
operator|<=
literal|'9'
operator|)
operator|||
operator|(
name|ch
operator|==
literal|'_'
operator|&&
name|cscf
operator|->
name|underscores_in_headers
operator|)
condition|)
block|{
continue|continue;
block|}
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'\0'
case|:
case|case
name|LF
case|:
case|case
name|CR
case|:
case|case
literal|':'
case|:
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
if|if
condition|(
name|ch
operator|>=
literal|'A'
operator|&&
name|ch
operator|<=
literal|'Z'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
name|r
operator|->
name|invalid_header
operator|=
literal|1
expr_stmt|;
block|}
name|r
operator|->
name|header_hash
operator|=
name|hash
expr_stmt|;
name|state
operator|=
name|sw_value_len
expr_stmt|;
comment|/* fall through */
case|case
name|sw_value_len
case|:
if|if
condition|(
name|end
operator|-
name|p
operator|<
name|NGX_SPDY_NV_VLEN_SIZE
condition|)
block|{
break|break;
block|}
name|r
operator|->
name|lowcase_index
operator|=
name|ngx_spdy_frame_parse_uint32
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* null-terminate header name */
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|p
operator|+=
name|NGX_SPDY_NV_VLEN_SIZE
expr_stmt|;
name|state
operator|=
name|sw_value
expr_stmt|;
comment|/* fall through */
case|case
name|sw_value
case|:
if|if
condition|(
operator|(
name|ngx_uint_t
operator|)
operator|(
name|end
operator|-
name|p
operator|)
operator|<
name|r
operator|->
name|lowcase_index
condition|)
block|{
break|break;
block|}
name|r
operator|->
name|header_start
operator|=
name|p
expr_stmt|;
while|while
condition|(
name|r
operator|->
name|lowcase_index
operator|--
condition|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'\0'
condition|)
block|{
if|if
condition|(
name|p
operator|==
name|r
operator|->
name|header_start
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_in
operator|->
name|pos
operator|=
name|p
operator|+
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|ch
operator|==
name|CR
operator|||
name|ch
operator|==
name|LF
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
name|p
operator|++
expr_stmt|;
block|}
name|r
operator|->
name|header_end
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|header_in
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|state
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_DONE
return|;
block|}
name|r
operator|->
name|header_in
operator|->
name|pos
operator|=
name|p
expr_stmt|;
name|r
operator|->
name|state
operator|=
name|state
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_alloc_large_header_buffer (ngx_http_request_t * r)
name|ngx_http_spdy_alloc_large_header_buffer
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|u_char
modifier|*
name|old
decl_stmt|,
modifier|*
name|new
decl_stmt|;
name|size_t
name|rest
decl_stmt|;
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|ngx_http_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy alloc large header buffer"
argument_list|)
expr_stmt|;
name|stream
operator|=
name|r
operator|->
name|spdy_stream
expr_stmt|;
name|cscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|->
name|header_buffers
operator|==
operator|(
name|ngx_uint_t
operator|)
name|cscf
operator|->
name|large_client_header_buffers
operator|.
name|num
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
name|rest
operator|=
name|r
operator|->
name|header_in
operator|->
name|last
operator|-
name|r
operator|->
name|header_in
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|rest
operator|>=
name|cscf
operator|->
name|large_client_header_buffers
operator|.
name|size
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
name|buf
operator|=
name|ngx_create_temp_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|cscf
operator|->
name|large_client_header_buffers
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy large header alloc: %p %z"
argument_list|,
name|buf
operator|->
name|pos
argument_list|,
name|buf
operator|->
name|end
operator|-
name|buf
operator|->
name|last
argument_list|)
expr_stmt|;
name|old
operator|=
name|r
operator|->
name|header_in
operator|->
name|pos
expr_stmt|;
name|new
operator|=
name|buf
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|rest
condition|)
block|{
name|buf
operator|->
name|last
operator|=
name|ngx_cpymem
argument_list|(
name|new
argument_list|,
name|old
argument_list|,
name|rest
argument_list|)
expr_stmt|;
block|}
name|r
operator|->
name|header_in
operator|=
name|buf
expr_stmt|;
name|stream
operator|->
name|header_buffers
operator|++
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_handle_request_header (ngx_http_request_t * r)
name|ngx_http_spdy_handle_request_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
name|ngx_http_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
name|ngx_http_spdy_request_header_t
modifier|*
name|sh
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|invalid_header
condition|)
block|{
name|cscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|cscf
operator|->
name|ignore_invalid_headers
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent invalid header: \"%*s\""
argument_list|,
name|r
operator|->
name|header_end
operator|-
name|r
operator|->
name|header_name_start
argument_list|,
name|r
operator|->
name|header_name_start
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
block|}
if|if
condition|(
name|r
operator|->
name|header_name_start
index|[
literal|0
index|]
operator|==
literal|':'
condition|)
block|{
name|r
operator|->
name|header_name_start
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NGX_SPDY_REQUEST_HEADERS
condition|;
name|i
operator|++
control|)
block|{
name|sh
operator|=
operator|&
name|ngx_http_spdy_request_headers
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|sh
operator|->
name|hash
operator|!=
name|r
operator|->
name|header_hash
operator|||
name|sh
operator|->
name|len
operator|!=
name|r
operator|->
name|header_name_end
operator|-
name|r
operator|->
name|header_name_start
operator|||
name|ngx_strncmp
argument_list|(
name|sh
operator|->
name|header
argument_list|,
name|r
operator|->
name|header_name_start
argument_list|,
name|sh
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
return|return
name|sh
operator|->
name|handler
argument_list|(
name|r
argument_list|)
return|;
block|}
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|h
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
name|ngx_http_spdy_close_stream
argument_list|(
name|r
operator|->
name|spdy_stream
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|h
operator|->
name|hash
operator|=
name|r
operator|->
name|header_hash
expr_stmt|;
name|h
operator|->
name|key
operator|.
name|len
operator|=
name|r
operator|->
name|header_name_end
operator|-
name|r
operator|->
name|header_name_start
expr_stmt|;
name|h
operator|->
name|key
operator|.
name|data
operator|=
name|r
operator|->
name|header_name_start
expr_stmt|;
name|h
operator|->
name|value
operator|.
name|len
operator|=
name|r
operator|->
name|header_end
operator|-
name|r
operator|->
name|header_start
expr_stmt|;
name|h
operator|->
name|value
operator|.
name|data
operator|=
name|r
operator|->
name|header_start
expr_stmt|;
name|h
operator|->
name|lowcase_key
operator|=
name|h
operator|->
name|key
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_spdy_request_headers_init (void)
name|ngx_http_spdy_request_headers_init
parameter_list|(
name|void
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_spdy_request_header_t
modifier|*
name|h
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NGX_SPDY_REQUEST_HEADERS
condition|;
name|i
operator|++
control|)
block|{
name|h
operator|=
operator|&
name|ngx_http_spdy_request_headers
index|[
name|i
index|]
expr_stmt|;
name|h
operator|->
name|hash
operator|=
name|ngx_hash_key
argument_list|(
name|h
operator|->
name|header
argument_list|,
name|h
operator|->
name|len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_parse_method (ngx_http_request_t * r)
name|ngx_http_spdy_parse_method
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|size_t
name|k
decl_stmt|,
name|len
decl_stmt|;
name|ngx_uint_t
name|n
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|m
decl_stmt|;
comment|/*      * This array takes less than 256 sequential bytes,      * and if typical CPU cache line size is 64 bytes,      * it is prefetched for 4 load operations.      */
DECL|struct|__anon2b38ba1c0308
specifier|static
specifier|const
struct|struct
block|{
DECL|member|len
name|u_char
name|len
decl_stmt|;
DECL|member|method
specifier|const
name|u_char
name|method
index|[
literal|11
index|]
decl_stmt|;
DECL|member|value
name|uint32_t
name|value
decl_stmt|;
block|}
name|tests
index|[]
init|=
block|{
block|{
literal|3
block|,
literal|"GET"
block|,
name|NGX_HTTP_GET
block|}
block|,
block|{
literal|4
block|,
literal|"POST"
block|,
name|NGX_HTTP_POST
block|}
block|,
block|{
literal|4
block|,
literal|"HEAD"
block|,
name|NGX_HTTP_HEAD
block|}
block|,
block|{
literal|7
block|,
literal|"OPTIONS"
block|,
name|NGX_HTTP_OPTIONS
block|}
block|,
block|{
literal|8
block|,
literal|"PROPFIND"
block|,
name|NGX_HTTP_PROPFIND
block|}
block|,
block|{
literal|3
block|,
literal|"PUT"
block|,
name|NGX_HTTP_PUT
block|}
block|,
block|{
literal|5
block|,
literal|"MKCOL"
block|,
name|NGX_HTTP_MKCOL
block|}
block|,
block|{
literal|6
block|,
literal|"DELETE"
block|,
name|NGX_HTTP_DELETE
block|}
block|,
block|{
literal|4
block|,
literal|"COPY"
block|,
name|NGX_HTTP_COPY
block|}
block|,
block|{
literal|4
block|,
literal|"MOVE"
block|,
name|NGX_HTTP_MOVE
block|}
block|,
block|{
literal|9
block|,
literal|"PROPPATCH"
block|,
name|NGX_HTTP_PROPPATCH
block|}
block|,
block|{
literal|4
block|,
literal|"LOCK"
block|,
name|NGX_HTTP_LOCK
block|}
block|,
block|{
literal|6
block|,
literal|"UNLOCK"
block|,
name|NGX_HTTP_UNLOCK
block|}
block|,
block|{
literal|5
block|,
literal|"PATCH"
block|,
name|NGX_HTTP_PATCH
block|}
block|,
block|{
literal|5
block|,
literal|"TRACE"
block|,
name|NGX_HTTP_TRACE
block|}
block|}
struct|,
modifier|*
name|test
struct|;
if|if
condition|(
name|r
operator|->
name|method_name
operator|.
name|len
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
name|len
operator|=
name|r
operator|->
name|header_end
operator|-
name|r
operator|->
name|header_start
expr_stmt|;
name|r
operator|->
name|method_name
operator|.
name|len
operator|=
name|len
expr_stmt|;
name|r
operator|->
name|method_name
operator|.
name|data
operator|=
name|r
operator|->
name|header_start
expr_stmt|;
name|test
operator|=
name|tests
expr_stmt|;
name|n
operator|=
sizeof|sizeof
argument_list|(
name|tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|tests
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
do|do
block|{
if|if
condition|(
name|len
operator|==
name|test
operator|->
name|len
condition|)
block|{
name|p
operator|=
name|r
operator|->
name|method_name
operator|.
name|data
expr_stmt|;
name|m
operator|=
name|test
operator|->
name|method
expr_stmt|;
name|k
operator|=
name|len
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|*
name|p
operator|++
operator|!=
operator|*
name|m
operator|++
condition|)
block|{
goto|goto
name|next
goto|;
block|}
block|}
do|while
condition|(
operator|--
name|k
condition|)
do|;
name|r
operator|->
name|method
operator|=
name|test
operator|->
name|value
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|next
label|:
name|test
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|n
condition|)
do|;
name|p
operator|=
name|r
operator|->
name|method_name
operator|.
name|data
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
operator|*
name|p
argument_list|<
literal|'A'
operator|||
operator|*
name|p
argument_list|>
literal|'Z'
operator|)
operator|&&
operator|*
name|p
operator|!=
literal|'_'
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"client sent invalid method"
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|p
operator|++
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|len
condition|)
do|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_parse_scheme (ngx_http_request_t * r)
name|ngx_http_spdy_parse_scheme
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|schema_start
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
name|r
operator|->
name|schema_start
operator|=
name|r
operator|->
name|header_start
expr_stmt|;
name|r
operator|->
name|schema_end
operator|=
name|r
operator|->
name|header_end
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_parse_host (ngx_http_request_t * r)
name|ngx_http_spdy_parse_host
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|host
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
name|h
operator|=
name|ngx_list_push
argument_list|(
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
name|ngx_http_spdy_close_stream
argument_list|(
name|r
operator|->
name|spdy_stream
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|r
operator|->
name|headers_in
operator|.
name|host
operator|=
name|h
expr_stmt|;
name|h
operator|->
name|hash
operator|=
name|r
operator|->
name|header_hash
expr_stmt|;
name|h
operator|->
name|key
operator|.
name|len
operator|=
name|r
operator|->
name|header_name_end
operator|-
name|r
operator|->
name|header_name_start
expr_stmt|;
name|h
operator|->
name|key
operator|.
name|data
operator|=
name|r
operator|->
name|header_name_start
expr_stmt|;
name|h
operator|->
name|value
operator|.
name|len
operator|=
name|r
operator|->
name|header_end
operator|-
name|r
operator|->
name|header_start
expr_stmt|;
name|h
operator|->
name|value
operator|.
name|data
operator|=
name|r
operator|->
name|header_start
expr_stmt|;
name|h
operator|->
name|lowcase_key
operator|=
name|h
operator|->
name|key
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_parse_path (ngx_http_request_t * r)
name|ngx_http_spdy_parse_path
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|unparsed_uri
operator|.
name|len
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
name|r
operator|->
name|uri_start
operator|=
name|r
operator|->
name|header_start
expr_stmt|;
name|r
operator|->
name|uri_end
operator|=
name|r
operator|->
name|header_end
expr_stmt|;
if|if
condition|(
name|ngx_http_parse_uri
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
if|if
condition|(
name|ngx_http_process_request_uri
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_parse_version (ngx_http_request_t * r)
name|ngx_http_spdy_parse_version
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
name|ch
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|http_protocol
operator|.
name|len
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_HEADER
return|;
block|}
name|p
operator|=
name|r
operator|->
name|header_start
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|header_end
operator|-
name|p
operator|<
literal|8
operator|||
operator|!
operator|(
name|ngx_str5cmp
argument_list|(
name|p
argument_list|,
literal|'H'
argument_list|,
literal|'T'
argument_list|,
literal|'T'
argument_list|,
literal|'P'
argument_list|,
literal|'/'
argument_list|)
operator|)
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|ch
operator|=
operator|*
operator|(
name|p
operator|+
literal|5
operator|)
expr_stmt|;
if|if
condition|(
name|ch
argument_list|<
literal|'1'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|r
operator|->
name|http_major
operator|=
name|ch
operator|-
literal|'0'
expr_stmt|;
for|for
control|(
name|p
operator|+=
literal|6
init|;
name|p
operator|!=
name|r
operator|->
name|header_end
operator|-
literal|2
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'.'
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|r
operator|->
name|http_major
operator|=
name|r
operator|->
name|http_major
operator|*
literal|10
operator|+
name|ch
operator|-
literal|'0'
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|!=
literal|'.'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|ch
operator|=
operator|*
operator|(
name|p
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|r
operator|->
name|http_minor
operator|=
name|ch
operator|-
literal|'0'
expr_stmt|;
for|for
control|(
name|p
operator|+=
literal|2
init|;
name|p
operator|!=
name|r
operator|->
name|header_end
condition|;
name|p
operator|++
control|)
block|{
name|ch
operator|=
operator|*
name|p
expr_stmt|;
if|if
condition|(
name|ch
argument_list|<
literal|'0'
operator|||
name|ch
argument_list|>
literal|'9'
condition|)
block|{
return|return
name|NGX_HTTP_PARSE_INVALID_REQUEST
return|;
block|}
name|r
operator|->
name|http_minor
operator|=
name|r
operator|->
name|http_minor
operator|*
literal|10
operator|+
name|ch
operator|-
literal|'0'
expr_stmt|;
block|}
name|r
operator|->
name|http_protocol
operator|.
name|len
operator|=
name|r
operator|->
name|header_end
operator|-
name|r
operator|->
name|header_start
expr_stmt|;
name|r
operator|->
name|http_protocol
operator|.
name|data
operator|=
name|r
operator|->
name|header_start
expr_stmt|;
name|r
operator|->
name|http_version
operator|=
name|r
operator|->
name|http_major
operator|*
literal|1000
operator|+
name|r
operator|->
name|http_minor
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_construct_request_line (ngx_http_request_t * r)
name|ngx_http_spdy_construct_request_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|method_name
operator|.
name|len
operator|==
literal|0
operator|||
name|r
operator|->
name|unparsed_uri
operator|.
name|len
operator|==
literal|0
operator|||
name|r
operator|->
name|http_protocol
operator|.
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_BAD_REQUEST
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|r
operator|->
name|request_line
operator|.
name|len
operator|=
name|r
operator|->
name|method_name
operator|.
name|len
operator|+
literal|1
operator|+
name|r
operator|->
name|unparsed_uri
operator|.
name|len
operator|+
literal|1
operator|+
name|r
operator|->
name|http_protocol
operator|.
name|len
expr_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|r
operator|->
name|request_line
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|ngx_http_finalize_request
argument_list|(
name|r
argument_list|,
name|NGX_HTTP_INTERNAL_SERVER_ERROR
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|r
operator|->
name|request_line
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|method_name
operator|.
name|data
argument_list|,
name|r
operator|->
name|method_name
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|unparsed_uri
operator|.
name|data
argument_list|,
name|r
operator|->
name|unparsed_uri
operator|.
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|http_protocol
operator|.
name|data
argument_list|,
name|r
operator|->
name|http_protocol
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* some modules expect the space character after method name */
name|r
operator|->
name|method_name
operator|.
name|data
operator|=
name|r
operator|->
name|request_line
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_run_request (ngx_http_request_t * r)
name|ngx_http_spdy_run_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_list_part_t
modifier|*
name|part
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
name|ngx_http_header_t
modifier|*
name|hh
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
if|if
condition|(
name|ngx_http_spdy_construct_request_line
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy http request line: \"%V\""
argument_list|,
operator|&
name|r
operator|->
name|request_line
argument_list|)
expr_stmt|;
name|cmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|part
operator|=
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
expr_stmt|;
name|h
operator|=
name|part
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|part
operator|->
name|nelts
condition|)
block|{
if|if
condition|(
name|part
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|part
operator|=
name|part
operator|->
name|next
expr_stmt|;
name|h
operator|=
name|part
operator|->
name|elts
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
name|hh
operator|=
name|ngx_hash_find
argument_list|(
operator|&
name|cmcf
operator|->
name|headers_in_hash
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|hash
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|lowcase_key
argument_list|,
name|h
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hh
operator|&&
name|hh
operator|->
name|handler
argument_list|(
name|r
argument_list|,
operator|&
name|h
index|[
name|i
index|]
argument_list|,
name|hh
operator|->
name|offset
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return;
block|}
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http header: \"%V: %V\""
argument_list|,
operator|&
name|h
index|[
name|i
index|]
operator|.
name|key
argument_list|,
operator|&
name|h
index|[
name|i
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
name|r
operator|->
name|http_state
operator|=
name|NGX_HTTP_PROCESS_REQUEST_STATE
expr_stmt|;
if|if
condition|(
name|ngx_http_process_request_header
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return;
block|}
name|ngx_http_process_request
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_init_request_body (ngx_http_request_t * r)
name|ngx_http_spdy_init_request_body
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_temp_file_t
modifier|*
name|tf
decl_stmt|;
name|ngx_http_request_body_t
modifier|*
name|rb
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|rb
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_request_body_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rb
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|r
operator|->
name|request_body
operator|=
name|rb
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|spdy_stream
operator|->
name|in_closed
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|rb
operator|->
name|rest
operator|=
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
expr_stmt|;
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|request_body_in_file_only
operator|||
name|rb
operator|->
name|rest
operator|>
operator|(
name|off_t
operator|)
name|clcf
operator|->
name|client_body_buffer_size
operator|||
name|rb
operator|->
name|rest
operator|<
literal|0
condition|)
block|{
name|tf
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_temp_file_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|tf
operator|->
name|file
operator|.
name|fd
operator|=
name|NGX_INVALID_FILE
expr_stmt|;
name|tf
operator|->
name|file
operator|.
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
name|tf
operator|->
name|path
operator|=
name|clcf
operator|->
name|client_body_temp_path
expr_stmt|;
name|tf
operator|->
name|pool
operator|=
name|r
operator|->
name|pool
expr_stmt|;
name|tf
operator|->
name|warn
operator|=
literal|"a client request body is buffered to a temporary file"
expr_stmt|;
name|tf
operator|->
name|log_level
operator|=
name|r
operator|->
name|request_body_file_log_level
expr_stmt|;
name|tf
operator|->
name|persistent
operator|=
name|r
operator|->
name|request_body_in_persistent_file
expr_stmt|;
name|tf
operator|->
name|clean
operator|=
name|r
operator|->
name|request_body_in_clean_file
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|request_body_file_group_access
condition|)
block|{
name|tf
operator|->
name|access
operator|=
literal|0660
expr_stmt|;
block|}
name|rb
operator|->
name|temp_file
operator|=
name|tf
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|spdy_stream
operator|->
name|in_closed
operator|&&
name|ngx_create_temp_file
argument_list|(
operator|&
name|tf
operator|->
name|file
argument_list|,
name|tf
operator|->
name|path
argument_list|,
name|tf
operator|->
name|pool
argument_list|,
name|tf
operator|->
name|persistent
argument_list|,
name|tf
operator|->
name|clean
argument_list|,
name|tf
operator|->
name|access
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|buf
operator|=
name|ngx_calloc_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|rb
operator|->
name|rest
operator|==
literal|0
condition|)
block|{
return|return
name|NGX_OK
return|;
block|}
name|buf
operator|=
name|ngx_create_temp_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|(
name|size_t
operator|)
name|rb
operator|->
name|rest
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
name|rb
operator|->
name|buf
operator|=
name|buf
expr_stmt|;
name|rb
operator|->
name|bufs
operator|=
name|ngx_alloc_chain_link
argument_list|(
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|rb
operator|->
name|bufs
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|rb
operator|->
name|bufs
operator|->
name|buf
operator|=
name|buf
expr_stmt|;
name|rb
operator|->
name|bufs
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|rb
operator|->
name|rest
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_spdy_read_request_body (ngx_http_request_t * r,ngx_http_client_body_handler_pt post_handler)
name|ngx_http_spdy_read_request_body
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_client_body_handler_pt
name|post_handler
parameter_list|)
block|{
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy read request body"
argument_list|)
expr_stmt|;
name|stream
operator|=
name|r
operator|->
name|spdy_stream
expr_stmt|;
switch|switch
condition|(
name|stream
operator|->
name|skip_data
condition|)
block|{
case|case
name|NGX_SPDY_DATA_DISCARD
case|:
name|post_handler
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
case|case
name|NGX_SPDY_DATA_ERROR
case|:
if|if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
operator|==
operator|-
literal|1
condition|)
block|{
return|return
name|NGX_HTTP_REQUEST_ENTITY_TOO_LARGE
return|;
block|}
else|else
block|{
return|return
name|NGX_HTTP_BAD_REQUEST
return|;
block|}
case|case
name|NGX_SPDY_DATA_INTERNAL_ERROR
case|:
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
if|if
condition|(
operator|!
name|r
operator|->
name|request_body
operator|&&
name|ngx_http_spdy_init_request_body
argument_list|(
name|r
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|stream
operator|->
name|skip_data
operator|=
name|NGX_SPDY_DATA_INTERNAL_ERROR
expr_stmt|;
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
if|if
condition|(
name|stream
operator|->
name|in_closed
condition|)
block|{
name|post_handler
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|r
operator|->
name|request_body
operator|->
name|post_handler
operator|=
name|post_handler
expr_stmt|;
name|r
operator|->
name|read_event_handler
operator|=
name|ngx_http_test_reading
expr_stmt|;
name|r
operator|->
name|write_event_handler
operator|=
name|ngx_http_request_empty_handler
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_terminate_stream (ngx_http_spdy_connection_t * sc,ngx_http_spdy_stream_t * stream,ngx_uint_t status)
name|ngx_http_spdy_terminate_stream
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_http_spdy_stream_t
modifier|*
name|stream
parameter_list|,
name|ngx_uint_t
name|status
parameter_list|)
block|{
name|ngx_event_t
modifier|*
name|rev
decl_stmt|;
name|ngx_connection_t
modifier|*
name|fc
decl_stmt|;
if|if
condition|(
name|ngx_http_spdy_send_rst_stream
argument_list|(
name|sc
argument_list|,
name|stream
operator|->
name|id
argument_list|,
name|status
argument_list|,
name|NGX_SPDY_HIGHEST_PRIORITY
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|stream
operator|->
name|out_closed
operator|=
literal|1
expr_stmt|;
name|fc
operator|=
name|stream
operator|->
name|request
operator|->
name|connection
expr_stmt|;
name|fc
operator|->
name|error
operator|=
literal|1
expr_stmt|;
name|rev
operator|=
name|fc
operator|->
name|read
expr_stmt|;
name|rev
operator|->
name|handler
argument_list|(
name|rev
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_close_stream_handler (ngx_event_t * ev)
name|ngx_http_spdy_close_stream_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|fc
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|fc
operator|=
name|ev
operator|->
name|data
expr_stmt|;
name|r
operator|=
name|fc
operator|->
name|data
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy close stream handler"
argument_list|)
expr_stmt|;
name|ngx_http_spdy_close_stream
argument_list|(
name|r
operator|->
name|spdy_stream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_spdy_close_stream (ngx_http_spdy_stream_t * stream,ngx_int_t rc)
name|ngx_http_spdy_close_stream
parameter_list|(
name|ngx_http_spdy_stream_t
modifier|*
name|stream
parameter_list|,
name|ngx_int_t
name|rc
parameter_list|)
block|{
name|ngx_event_t
modifier|*
name|ev
decl_stmt|;
name|ngx_connection_t
modifier|*
name|fc
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
modifier|*
name|index
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
name|ngx_http_spdy_connection_t
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|stream
operator|->
name|connection
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy close stream %ui, queued %ui, processing %ui"
argument_list|,
name|stream
operator|->
name|id
argument_list|,
name|stream
operator|->
name|queued
argument_list|,
name|sc
operator|->
name|processing
argument_list|)
expr_stmt|;
name|fc
operator|=
name|stream
operator|->
name|request
operator|->
name|connection
expr_stmt|;
if|if
condition|(
name|stream
operator|->
name|queued
condition|)
block|{
name|fc
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_http_spdy_close_stream_handler
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|stream
operator|->
name|out_closed
condition|)
block|{
if|if
condition|(
name|ngx_http_spdy_send_rst_stream
argument_list|(
name|sc
argument_list|,
name|stream
operator|->
name|id
argument_list|,
name|NGX_SPDY_INTERNAL_ERROR
argument_list|,
name|stream
operator|->
name|priority
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|sc
operator|->
name|connection
operator|->
name|error
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|stream
operator|==
name|stream
condition|)
block|{
name|sc
operator|->
name|stream
operator|=
name|NULL
expr_stmt|;
block|}
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|index
operator|=
name|sc
operator|->
name|streams_index
operator|+
name|ngx_http_spdy_stream_index
argument_list|(
name|sscf
argument_list|,
name|stream
operator|->
name|id
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|s
operator|=
operator|*
name|index
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
if|if
condition|(
name|s
operator|==
name|stream
condition|)
block|{
operator|*
name|index
operator|=
name|s
operator|->
name|index
expr_stmt|;
break|break;
block|}
name|index
operator|=
operator|&
name|s
operator|->
name|index
expr_stmt|;
block|}
name|ngx_http_free_request
argument_list|(
name|stream
operator|->
name|request
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|ev
operator|=
name|fc
operator|->
name|read
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|active
operator|||
name|ev
operator|->
name|disabled
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy fake read event was activated"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ev
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|ev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ev
operator|->
name|prev
condition|)
block|{
name|ngx_delete_posted_event
argument_list|(
name|ev
argument_list|)
expr_stmt|;
block|}
name|ev
operator|=
name|fc
operator|->
name|write
expr_stmt|;
if|if
condition|(
name|ev
operator|->
name|active
operator|||
name|ev
operator|->
name|disabled
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy fake write event was activated"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ev
operator|->
name|timer_set
condition|)
block|{
name|ngx_del_timer
argument_list|(
name|ev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ev
operator|->
name|prev
condition|)
block|{
name|ngx_delete_posted_event
argument_list|(
name|ev
argument_list|)
expr_stmt|;
block|}
name|fc
operator|->
name|data
operator|=
name|sc
operator|->
name|free_fake_connections
expr_stmt|;
name|sc
operator|->
name|free_fake_connections
operator|=
name|fc
expr_stmt|;
name|sc
operator|->
name|processing
operator|--
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|processing
operator|||
name|sc
operator|->
name|blocked
condition|)
block|{
return|return;
block|}
name|ev
operator|=
name|sc
operator|->
name|connection
operator|->
name|read
expr_stmt|;
name|ev
operator|->
name|handler
operator|=
name|ngx_http_spdy_handle_connection_handler
expr_stmt|;
name|ngx_post_event
argument_list|(
name|ev
argument_list|,
operator|&
name|ngx_posted_events
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_handle_connection_handler (ngx_event_t * rev)
name|ngx_http_spdy_handle_connection_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|rev
operator|->
name|handler
operator|=
name|ngx_http_spdy_read_handler
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|ready
condition|)
block|{
name|ngx_http_spdy_read_handler
argument_list|(
name|rev
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|ngx_http_spdy_handle_connection
argument_list|(
name|c
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_keepalive_handler (ngx_event_t * rev)
name|ngx_http_spdy_keepalive_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
name|ngx_http_spdy_connection_t
modifier|*
name|sc
decl_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy keepalive handler"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|timedout
operator|||
name|c
operator|->
name|close
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
operator|(
name|NGX_HAVE_KQUEUE
operator|)
if|if
condition|(
name|ngx_event_flags
operator|&
name|NGX_USE_KQUEUE_EVENT
condition|)
block|{
if|if
condition|(
name|rev
operator|->
name|pending_eof
condition|)
block|{
name|c
operator|->
name|log
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|rev
operator|->
name|kq_errno
argument_list|,
literal|"kevent() reported that client %V closed "
literal|"keepalive connection"
argument_list|,
operator|&
name|c
operator|->
name|addr_text
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
if|if
condition|(
name|c
operator|->
name|ssl
condition|)
block|{
name|c
operator|->
name|ssl
operator|->
name|no_send_shutdown
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
endif|#
directive|endif
name|c
operator|->
name|destroyed
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|idle
operator|=
literal|0
expr_stmt|;
name|ngx_reusable_connection
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|=
name|c
operator|->
name|data
expr_stmt|;
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|sc
operator|->
name|pool
operator|=
name|ngx_create_pool
argument_list|(
name|sscf
operator|->
name|pool_size
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|pool
operator|==
name|NULL
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|streams_index
operator|=
name|ngx_pcalloc
argument_list|(
name|sc
operator|->
name|pool
argument_list|,
name|ngx_http_spdy_streams_index_size
argument_list|(
name|sscf
argument_list|)
operator|*
sizeof|sizeof
argument_list|(
name|ngx_http_spdy_stream_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|streams_index
operator|==
name|NULL
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_http_spdy_write_handler
expr_stmt|;
name|rev
operator|->
name|handler
operator|=
name|ngx_http_spdy_read_handler
expr_stmt|;
name|ngx_http_spdy_read_handler
argument_list|(
name|rev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_finalize_connection (ngx_http_spdy_connection_t * sc,ngx_int_t rc)
name|ngx_http_spdy_finalize_connection
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ngx_int_t
name|rc
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|,
name|size
decl_stmt|;
name|ngx_event_t
modifier|*
name|ev
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|,
modifier|*
name|fc
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
name|c
operator|=
name|sc
operator|->
name|connection
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|processing
condition|)
block|{
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|error
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_http_empty_handler
expr_stmt|;
name|c
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_http_empty_handler
expr_stmt|;
name|sc
operator|->
name|last_out
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|blocked
operator|=
literal|1
expr_stmt|;
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|size
operator|=
name|ngx_http_spdy_streams_index_size
argument_list|(
name|sscf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
name|stream
operator|=
name|sc
operator|->
name|streams_index
index|[
name|i
index|]
expr_stmt|;
while|while
condition|(
name|stream
condition|)
block|{
name|stream
operator|->
name|handled
operator|=
literal|0
expr_stmt|;
name|r
operator|=
name|stream
operator|->
name|request
expr_stmt|;
name|fc
operator|=
name|r
operator|->
name|connection
expr_stmt|;
name|fc
operator|->
name|error
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|stream
operator|->
name|queued
condition|)
block|{
name|stream
operator|->
name|queued
operator|=
literal|0
expr_stmt|;
name|ev
operator|=
name|fc
operator|->
name|write
expr_stmt|;
name|ev
operator|->
name|delayed
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ev
operator|=
name|fc
operator|->
name|read
expr_stmt|;
block|}
name|stream
operator|=
name|stream
operator|->
name|index
expr_stmt|;
name|ev
operator|->
name|eof
operator|=
literal|1
expr_stmt|;
name|ev
operator|->
name|handler
argument_list|(
name|ev
argument_list|)
expr_stmt|;
block|}
block|}
name|sc
operator|->
name|blocked
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|processing
condition|)
block|{
return|return;
block|}
name|ngx_http_close_connection
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_spdy_adjust_windows (ngx_http_spdy_connection_t * sc,ssize_t delta)
name|ngx_http_spdy_adjust_windows
parameter_list|(
name|ngx_http_spdy_connection_t
modifier|*
name|sc
parameter_list|,
name|ssize_t
name|delta
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|,
name|size
decl_stmt|;
name|ngx_event_t
modifier|*
name|wev
decl_stmt|;
name|ngx_http_spdy_stream_t
modifier|*
name|stream
decl_stmt|,
modifier|*
name|sn
decl_stmt|;
name|ngx_http_spdy_srv_conf_t
modifier|*
name|sscf
decl_stmt|;
name|sscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|sc
operator|->
name|http_connection
operator|->
name|conf_ctx
argument_list|,
name|ngx_http_spdy_module
argument_list|)
expr_stmt|;
name|size
operator|=
name|ngx_http_spdy_streams_index_size
argument_list|(
name|sscf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|stream
operator|=
name|sc
operator|->
name|streams_index
index|[
name|i
index|]
init|;
name|stream
condition|;
name|stream
operator|=
name|sn
control|)
block|{
name|sn
operator|=
name|stream
operator|->
name|index
expr_stmt|;
if|if
condition|(
name|delta
operator|>
literal|0
operator|&&
name|stream
operator|->
name|send_window
operator|>
operator|(
name|ssize_t
operator|)
operator|(
name|NGX_SPDY_MAX_WINDOW
operator|-
name|delta
operator|)
condition|)
block|{
if|if
condition|(
name|ngx_http_spdy_terminate_stream
argument_list|(
name|sc
argument_list|,
name|stream
argument_list|,
name|NGX_SPDY_FLOW_CONTROL_ERROR
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
continue|continue;
block|}
name|stream
operator|->
name|send_window
operator|+=
name|delta
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|sc
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"spdy:%ui adjust window:%z"
argument_list|,
name|stream
operator|->
name|id
argument_list|,
name|stream
operator|->
name|send_window
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|->
name|send_window
operator|>
literal|0
operator|&&
name|stream
operator|->
name|exhausted
condition|)
block|{
name|stream
operator|->
name|exhausted
operator|=
literal|0
expr_stmt|;
name|wev
operator|=
name|stream
operator|->
name|request
operator|->
name|connection
operator|->
name|write
expr_stmt|;
if|if
condition|(
operator|!
name|wev
operator|->
name|timer_set
condition|)
block|{
name|wev
operator|->
name|delayed
operator|=
literal|0
expr_stmt|;
name|wev
operator|->
name|handler
argument_list|(
name|wev
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_pool_cleanup (void * data)
name|ngx_http_spdy_pool_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_spdy_connection_t
modifier|*
name|sc
init|=
name|data
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|pool
condition|)
block|{
name|ngx_destroy_pool
argument_list|(
name|sc
operator|->
name|pool
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
DECL|function|ngx_http_spdy_zalloc (void * opaque,u_int items,u_int size)
name|ngx_http_spdy_zalloc
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|u_int
name|items
parameter_list|,
name|u_int
name|size
parameter_list|)
block|{
name|ngx_http_spdy_connection_t
modifier|*
name|sc
init|=
name|opaque
decl_stmt|;
return|return
name|ngx_palloc
argument_list|(
name|sc
operator|->
name|connection
operator|->
name|pool
argument_list|,
name|items
operator|*
name|size
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_spdy_zfree (void * opaque,void * address)
name|ngx_http_spdy_zfree
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|void
modifier|*
name|address
parameter_list|)
block|{
if|#
directive|if
literal|0
block_content|ngx_http_spdy_connection_t *sc = opaque;      ngx_log_debug1(NGX_LOG_DEBUG_HTTP, sc->connection->log, 0,                    "spdy zfree: %p", address);
endif|#
directive|endif
block|}
end_function

end_unit

