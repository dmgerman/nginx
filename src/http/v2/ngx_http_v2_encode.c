begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Nginx, Inc.  * Copyright (C) Valentin V. Bartenev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_function_decl
specifier|static
name|u_char
modifier|*
name|ngx_http_v2_write_int
parameter_list|(
name|u_char
modifier|*
name|pos
parameter_list|,
name|ngx_uint_t
name|prefix
parameter_list|,
name|ngx_uint_t
name|value
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|u_char
modifier|*
DECL|function|ngx_http_v2_string_encode (u_char * dst,u_char * src,size_t len,u_char * tmp,ngx_uint_t lower)
name|ngx_http_v2_string_encode
parameter_list|(
name|u_char
modifier|*
name|dst
parameter_list|,
name|u_char
modifier|*
name|src
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u_char
modifier|*
name|tmp
parameter_list|,
name|ngx_uint_t
name|lower
parameter_list|)
block|{
name|size_t
name|hlen
decl_stmt|;
name|hlen
operator|=
name|ngx_http_huff_encode
argument_list|(
name|src
argument_list|,
name|len
argument_list|,
name|tmp
argument_list|,
name|lower
argument_list|)
expr_stmt|;
if|if
condition|(
name|hlen
operator|>
literal|0
condition|)
block|{
operator|*
name|dst
operator|=
name|NGX_HTTP_V2_ENCODE_HUFF
expr_stmt|;
name|dst
operator|=
name|ngx_http_v2_write_int
argument_list|(
name|dst
argument_list|,
name|ngx_http_v2_prefix
argument_list|(
literal|7
argument_list|)
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
return|return
name|ngx_cpymem
argument_list|(
name|dst
argument_list|,
name|tmp
argument_list|,
name|hlen
argument_list|)
return|;
block|}
operator|*
name|dst
operator|=
name|NGX_HTTP_V2_ENCODE_RAW
expr_stmt|;
name|dst
operator|=
name|ngx_http_v2_write_int
argument_list|(
name|dst
argument_list|,
name|ngx_http_v2_prefix
argument_list|(
literal|7
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|lower
condition|)
block|{
name|ngx_strlow
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|dst
operator|+
name|len
return|;
block|}
return|return
name|ngx_cpymem
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_char
modifier|*
DECL|function|ngx_http_v2_write_int (u_char * pos,ngx_uint_t prefix,ngx_uint_t value)
name|ngx_http_v2_write_int
parameter_list|(
name|u_char
modifier|*
name|pos
parameter_list|,
name|ngx_uint_t
name|prefix
parameter_list|,
name|ngx_uint_t
name|value
parameter_list|)
block|{
if|if
condition|(
name|value
operator|<
name|prefix
condition|)
block|{
operator|*
name|pos
operator|++
operator||=
name|value
expr_stmt|;
return|return
name|pos
return|;
block|}
operator|*
name|pos
operator|++
operator||=
name|prefix
expr_stmt|;
name|value
operator|-=
name|prefix
expr_stmt|;
while|while
condition|(
name|value
operator|>=
literal|128
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
name|value
operator|%
literal|128
operator|+
literal|128
expr_stmt|;
name|value
operator|/=
literal|128
expr_stmt|;
block|}
operator|*
name|pos
operator|++
operator|=
operator|(
name|u_char
operator|)
name|value
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

end_unit

