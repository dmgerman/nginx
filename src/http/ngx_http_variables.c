begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  * Copyright (C) Nginx, Inc.  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_include
include|#
directive|include
file|<nginx.h>
end_include

begin_function_decl
specifier|static
name|ngx_http_variable_t
modifier|*
name|ngx_http_add_prefix_variable
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void ngx_http_variable_request_set(ngx_http_request_t *r,     ngx_http_variable_value_t *v, uintptr_t data);
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_get_size
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_cookies
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_headers_internal
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|,
name|u_char
name|sep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_unknown_header_in
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_unknown_header_out
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_unknown_trailer_out
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_cookie
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_argument
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_TCP_INFO
operator|)
end_if

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_tcpinfo
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_content_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_host
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_binary_remote_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_remote_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_remote_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_proxy_protocol_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_proxy_protocol_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_proxy_protocol_tlv
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_server_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_server_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_scheme
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_https
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_variable_set_args
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_is_args
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_document_root
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_realpath_root
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_filename
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_server_name
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_method
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_remote_user
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_bytes_sent
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_body_bytes_sent
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_pipe
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_completion
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_body
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_body_file
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_time
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_request_id
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_status
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_sent_content_type
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_sent_content_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_sent_location
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_sent_last_modified
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_sent_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_sent_keep_alive
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_sent_transfer_encoding
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_variable_set_limit_rate
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_connection_requests
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_connection_time
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_nginx_version
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_hostname
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_pid
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_msec
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_time_iso8601
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_variable_time_local
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * TODO:  *     Apache CGI: AUTH_TYPE, PATH_INFO (null), PATH_TRANSLATED  *                 REMOTE_HOST (null), REMOTE_IDENT (null),  *                 SERVER_SOFTWARE  *  *     Apache SSI: DOCUMENT_NAME, LAST_MODIFIED, USER_NAME (file owner)  */
end_comment

begin_comment
comment|/*  * the $http_host, $http_user_agent, $http_referer, and $http_via  * variables may be handled by generic  * ngx_http_variable_unknown_header_in(), but for performance reasons  * they are handled using dedicated entries  */
end_comment

begin_decl_stmt
DECL|variable|ngx_http_core_variables
specifier|static
name|ngx_http_variable_t
name|ngx_http_core_variables
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"http_host"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|host
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_user_agent"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|user_agent
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_referer"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|referer
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
if|#
directive|if
operator|(
name|NGX_HTTP_GZIP
operator|)
block|{
name|ngx_string
argument_list|(
literal|"http_via"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|via
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
if|#
directive|if
operator|(
name|NGX_HTTP_X_FORWARDED_FOR
operator|)
block|{
name|ngx_string
argument_list|(
literal|"http_x_forwarded_for"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|x_forwarded_for
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|ngx_string
argument_list|(
literal|"http_cookie"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_cookies
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|cookie
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"content_length"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_content_length
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"content_type"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|content_type
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"host"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_host
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"binary_remote_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_binary_remote_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"remote_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_remote_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"remote_port"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_remote_port
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_protocol_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_proxy_protocol_addr
block|,
name|offsetof
argument_list|(
name|ngx_proxy_protocol_t
argument_list|,
name|src_addr
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_protocol_port"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_proxy_protocol_port
block|,
name|offsetof
argument_list|(
name|ngx_proxy_protocol_t
argument_list|,
name|src_port
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_protocol_server_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_proxy_protocol_addr
block|,
name|offsetof
argument_list|(
name|ngx_proxy_protocol_t
argument_list|,
name|dst_addr
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_protocol_server_port"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_proxy_protocol_port
block|,
name|offsetof
argument_list|(
name|ngx_proxy_protocol_t
argument_list|,
name|dst_port
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"proxy_protocol_tlv_"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_proxy_protocol_tlv
block|,
literal|0
block|,
name|NGX_HTTP_VAR_PREFIX
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_addr"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_server_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_port"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_server_port
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_protocol"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|http_protocol
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"scheme"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_scheme
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"https"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_https
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_uri"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|unparsed_uri
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"uri"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|uri
argument_list|)
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"document_uri"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|uri
argument_list|)
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_line
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"document_root"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_document_root
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"realpath_root"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_realpath_root
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"query_string"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|args
argument_list|)
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"args"
argument_list|)
block|,
name|ngx_http_variable_set_args
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|args
argument_list|)
block|,
name|NGX_HTTP_VAR_CHANGEABLE
operator||
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"is_args"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_is_args
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_filename"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_filename
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_name"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_server_name
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_method"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_method
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"remote_user"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_remote_user
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"bytes_sent"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_bytes_sent
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"body_bytes_sent"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_body_bytes_sent
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"pipe"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_pipe
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_completion"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_completion
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_body"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_body
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_body_file"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_body_file
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_length"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_length
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_time"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_time
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_id"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_request_id
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"status"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_status
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_content_type"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_sent_content_type
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_content_length"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_sent_content_length
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_location"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_sent_location
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_last_modified"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_sent_last_modified
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_connection"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_sent_connection
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_keep_alive"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_sent_keep_alive
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_transfer_encoding"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_sent_transfer_encoding
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_cache_control"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_out
operator|.
name|cache_control
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_link"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_out
operator|.
name|link
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"limit_rate"
argument_list|)
block|,
name|ngx_http_variable_set_limit_rate
block|,
name|ngx_http_variable_request_get_size
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|limit_rate
argument_list|)
block|,
name|NGX_HTTP_VAR_CHANGEABLE
operator||
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"connection"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_connection
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"connection_requests"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_connection_requests
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"connection_time"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_connection_time
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"nginx_version"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_nginx_version
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"hostname"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_hostname
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"pid"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_pid
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"msec"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_msec
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"time_iso8601"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_time_iso8601
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"time_local"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_time_local
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
if|#
directive|if
operator|(
name|NGX_HAVE_TCP_INFO
operator|)
block|{
name|ngx_string
argument_list|(
literal|"tcpinfo_rtt"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_tcpinfo
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"tcpinfo_rttvar"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_tcpinfo
block|,
literal|1
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"tcpinfo_snd_cwnd"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_tcpinfo
block|,
literal|2
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"tcpinfo_rcv_space"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_tcpinfo
block|,
literal|3
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|ngx_string
argument_list|(
literal|"http_"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_unknown_header_in
block|,
literal|0
block|,
name|NGX_HTTP_VAR_PREFIX
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_http_"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_unknown_header_out
block|,
literal|0
block|,
name|NGX_HTTP_VAR_PREFIX
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"sent_trailer_"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_unknown_trailer_out
block|,
literal|0
block|,
name|NGX_HTTP_VAR_PREFIX
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"cookie_"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_cookie
block|,
literal|0
block|,
name|NGX_HTTP_VAR_PREFIX
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"arg_"
argument_list|)
block|,
name|NULL
block|,
name|ngx_http_variable_argument
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHEABLE
operator||
name|NGX_HTTP_VAR_PREFIX
block|,
literal|0
block|}
block|,
name|ngx_http_null_variable
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_variable_null_value
name|ngx_http_variable_value_t
name|ngx_http_variable_null_value
init|=
name|ngx_http_variable
argument_list|(
literal|""
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_variable_true_value
name|ngx_http_variable_value_t
name|ngx_http_variable_true_value
init|=
name|ngx_http_variable
argument_list|(
literal|"1"
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_variable_depth
specifier|static
name|ngx_uint_t
name|ngx_http_variable_depth
init|=
literal|100
decl_stmt|;
end_decl_stmt

begin_function
name|ngx_http_variable_t
modifier|*
DECL|function|ngx_http_add_variable (ngx_conf_t * cf,ngx_str_t * name,ngx_uint_t flags)
name|ngx_http_add_variable
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|flags
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_hash_key_t
modifier|*
name|key
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
if|if
condition|(
name|name
operator|->
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid variable name \"$\""
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|NGX_HTTP_VAR_PREFIX
condition|)
block|{
return|return
name|ngx_http_add_prefix_variable
argument_list|(
name|cf
argument_list|,
name|name
argument_list|,
name|flags
argument_list|)
return|;
block|}
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|key
operator|=
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|key
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|key
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
name|v
operator|=
name|key
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|v
operator|->
name|flags
operator|&
name|NGX_HTTP_VAR_CHANGEABLE
operator|)
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the duplicate \"%V\" variable"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|NGX_HTTP_VAR_WEAK
operator|)
condition|)
block|{
name|v
operator|->
name|flags
operator|&=
operator|~
name|NGX_HTTP_VAR_WEAK
expr_stmt|;
block|}
return|return
name|v
return|;
block|}
name|v
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ngx_strlow
argument_list|(
name|v
operator|->
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|set_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|get_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|v
operator|->
name|index
operator|=
literal|0
expr_stmt|;
name|rc
operator|=
name|ngx_hash_add_key
argument_list|(
name|cmcf
operator|->
name|variables_keys
argument_list|,
operator|&
name|v
operator|->
name|name
argument_list|,
name|v
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_BUSY
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"conflicting variable name \"%V\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|v
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_t
modifier|*
DECL|function|ngx_http_add_prefix_variable (ngx_conf_t * cf,ngx_str_t * name,ngx_uint_t flags)
name|ngx_http_add_prefix_variable
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|flags
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
name|v
operator|=
operator|&
name|v
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|v
operator|->
name|flags
operator|&
name|NGX_HTTP_VAR_CHANGEABLE
operator|)
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the duplicate \"%V\" variable"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|NGX_HTTP_VAR_WEAK
operator|)
condition|)
block|{
name|v
operator|->
name|flags
operator|&=
operator|~
name|NGX_HTTP_VAR_WEAK
expr_stmt|;
block|}
return|return
name|v
return|;
block|}
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|prefix_variables
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|ngx_strlow
argument_list|(
name|v
operator|->
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|set_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|get_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|v
operator|->
name|index
operator|=
literal|0
expr_stmt|;
return|return
name|v
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_get_variable_index (ngx_conf_t * cf,ngx_str_t * name)
name|ngx_http_get_variable_index
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
if|if
condition|(
name|name
operator|->
name|len
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid variable name \"$\""
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|cmcf
operator|->
name|variables
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
return|return
name|i
return|;
block|}
block|}
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|variables
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_strlow
argument_list|(
name|v
operator|->
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|set_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|get_handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|index
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|-
literal|1
expr_stmt|;
return|return
name|v
operator|->
name|index
return|;
block|}
end_function

begin_function
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_get_indexed_variable (ngx_http_request_t * r,ngx_uint_t index)
name|ngx_http_get_indexed_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_uint_t
name|index
parameter_list|)
block|{
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|<=
name|index
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown variable index: %ui"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|r
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|not_found
operator|||
name|r
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|valid
condition|)
block|{
return|return
operator|&
name|r
operator|->
name|variables
index|[
name|index
index|]
return|;
block|}
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
if|if
condition|(
name|ngx_http_variable_depth
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cycle while evaluating variable \"%V\""
argument_list|,
operator|&
name|v
index|[
name|index
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ngx_http_variable_depth
operator|--
expr_stmt|;
if|if
condition|(
name|v
index|[
name|index
index|]
operator|.
name|get_handler
argument_list|(
name|r
argument_list|,
operator|&
name|r
operator|->
name|variables
index|[
name|index
index|]
argument_list|,
name|v
index|[
name|index
index|]
operator|.
name|data
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
name|ngx_http_variable_depth
operator|++
expr_stmt|;
if|if
condition|(
name|v
index|[
name|index
index|]
operator|.
name|flags
operator|&
name|NGX_HTTP_VAR_NOCACHEABLE
condition|)
block|{
name|r
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|no_cacheable
operator|=
literal|1
expr_stmt|;
block|}
return|return
operator|&
name|r
operator|->
name|variables
index|[
name|index
index|]
return|;
block|}
name|ngx_http_variable_depth
operator|++
expr_stmt|;
name|r
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|valid
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|variables
index|[
name|index
index|]
operator|.
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_get_flushed_variable (ngx_http_request_t * r,ngx_uint_t index)
name|ngx_http_get_flushed_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_uint_t
name|index
parameter_list|)
block|{
name|ngx_http_variable_value_t
modifier|*
name|v
decl_stmt|;
name|v
operator|=
operator|&
name|r
operator|->
name|variables
index|[
name|index
index|]
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|valid
operator|||
name|v
operator|->
name|not_found
condition|)
block|{
if|if
condition|(
operator|!
name|v
operator|->
name|no_cacheable
condition|)
block|{
return|return
name|v
return|;
block|}
name|v
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ngx_http_get_indexed_variable
argument_list|(
name|r
argument_list|,
name|index
argument_list|)
return|;
block|}
end_function

begin_function
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_get_variable (ngx_http_request_t * r,ngx_str_t * name,ngx_uint_t key)
name|ngx_http_get_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|key
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|ngx_hash_find
argument_list|(
operator|&
name|cmcf
operator|->
name|variables_hash
argument_list|,
name|key
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
condition|)
block|{
if|if
condition|(
name|v
operator|->
name|flags
operator|&
name|NGX_HTTP_VAR_INDEXED
condition|)
block|{
return|return
name|ngx_http_get_flushed_variable
argument_list|(
name|r
argument_list|,
name|v
operator|->
name|index
argument_list|)
return|;
block|}
if|if
condition|(
name|ngx_http_variable_depth
operator|==
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cycle while evaluating variable \"%V\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ngx_http_variable_depth
operator|--
expr_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|&&
name|v
operator|->
name|get_handler
argument_list|(
name|r
argument_list|,
name|vv
argument_list|,
name|v
operator|->
name|data
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
name|ngx_http_variable_depth
operator|++
expr_stmt|;
return|return
name|vv
return|;
block|}
name|ngx_http_variable_depth
operator|++
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|len
operator|=
literal|0
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|elts
expr_stmt|;
name|n
operator|=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|>=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|&&
name|name
operator|->
name|len
operator|>
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|len
operator|=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
expr_stmt|;
name|n
operator|=
name|i
expr_stmt|;
block|}
block|}
if|if
condition|(
name|n
operator|!=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
condition|)
block|{
if|if
condition|(
name|v
index|[
name|n
index|]
operator|.
name|get_handler
argument_list|(
name|r
argument_list|,
name|vv
argument_list|,
operator|(
name|uintptr_t
operator|)
name|name
argument_list|)
operator|==
name|NGX_OK
condition|)
block|{
return|return
name|vv
return|;
block|}
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|s
decl_stmt|;
name|s
operator|=
operator|(
name|ngx_str_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|r
operator|+
name|data
operator|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|data
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|s
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|s
operator|->
name|data
expr_stmt|;
block|}
else|else
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void ngx_http_variable_request_set(ngx_http_request_t *r,     ngx_http_variable_value_t *v, uintptr_t data) {     ngx_str_t  *s;      s = (ngx_str_t *) ((char *) r + data);      s->len = v->len;     s->data = v->data; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_get_size (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_get_size
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|size_t
modifier|*
name|sp
decl_stmt|;
name|sp
operator|=
operator|(
name|size_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|r
operator|+
name|data
operator|)
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_SIZE_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%uz"
argument_list|,
operator|*
name|sp
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_header (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
return|return
name|ngx_http_variable_headers_internal
argument_list|(
name|r
argument_list|,
name|v
argument_list|,
name|data
argument_list|,
literal|','
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_cookies (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_cookies
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
return|return
name|ngx_http_variable_headers_internal
argument_list|(
name|r
argument_list|,
name|v
argument_list|,
name|data
argument_list|,
literal|';'
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_headers_internal (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data,u_char sep)
name|ngx_http_variable_headers_internal
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|,
name|u_char
name|sep
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|,
modifier|*
name|th
decl_stmt|;
name|h
operator|=
operator|*
operator|(
name|ngx_table_elt_t
operator|*
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|r
operator|+
name|data
operator|)
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|th
operator|=
name|h
init|;
name|th
condition|;
name|th
operator|=
name|th
operator|->
name|next
control|)
block|{
if|if
condition|(
name|th
operator|->
name|hash
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
name|len
operator|+=
name|th
operator|->
name|value
operator|.
name|len
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|len
operator|-=
literal|2
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|h
operator|->
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|h
operator|->
name|value
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
for|for
control|(
name|th
operator|=
name|h
init|;
name|th
condition|;
name|th
operator|=
name|th
operator|->
name|next
control|)
block|{
if|if
condition|(
name|th
operator|->
name|hash
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
name|p
operator|=
name|ngx_copy
argument_list|(
name|p
argument_list|,
name|th
operator|->
name|value
operator|.
name|data
argument_list|,
name|th
operator|->
name|value
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
operator|*
name|p
operator|++
operator|=
name|sep
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_unknown_header_in (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_unknown_header_in
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
return|return
name|ngx_http_variable_unknown_header
argument_list|(
name|r
argument_list|,
name|v
argument_list|,
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
argument_list|,
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
argument_list|,
sizeof|sizeof
argument_list|(
literal|"http_"
argument_list|)
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_unknown_header_out (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_unknown_header_out
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
return|return
name|ngx_http_variable_unknown_header
argument_list|(
name|r
argument_list|,
name|v
argument_list|,
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
argument_list|,
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
operator|.
name|part
argument_list|,
sizeof|sizeof
argument_list|(
literal|"sent_http_"
argument_list|)
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_unknown_trailer_out (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_unknown_trailer_out
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
return|return
name|ngx_http_variable_unknown_header
argument_list|(
name|r
argument_list|,
name|v
argument_list|,
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
argument_list|,
operator|&
name|r
operator|->
name|headers_out
operator|.
name|trailers
operator|.
name|part
argument_list|,
sizeof|sizeof
argument_list|(
literal|"sent_trailer_"
argument_list|)
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_variable_unknown_header (ngx_http_request_t * r,ngx_http_variable_value_t * v,ngx_str_t * var,ngx_list_part_t * part,size_t prefix)
name|ngx_http_variable_unknown_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|ngx_str_t
modifier|*
name|var
parameter_list|,
name|ngx_list_part_t
modifier|*
name|part
parameter_list|,
name|size_t
name|prefix
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
name|ch
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|header
decl_stmt|,
modifier|*
name|h
decl_stmt|,
modifier|*
modifier|*
name|ph
decl_stmt|;
name|ph
operator|=
operator|&
name|h
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_SUPPRESS_WARN
operator|)
name|len
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
comment|/* void */
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|part
operator|->
name|nelts
condition|)
block|{
if|if
condition|(
name|part
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|part
operator|=
name|part
operator|->
name|next
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|header
index|[
name|i
index|]
operator|.
name|hash
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
operator|!=
name|var
operator|->
name|len
operator|-
name|prefix
condition|)
block|{
continue|continue;
block|}
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|var
operator|->
name|len
operator|-
name|prefix
condition|;
name|n
operator|++
control|)
block|{
name|ch
operator|=
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|>=
literal|'A'
operator|&&
name|ch
operator|<=
literal|'Z'
condition|)
block|{
name|ch
operator||=
literal|0x20
expr_stmt|;
block|}
if|else if
condition|(
name|ch
operator|==
literal|'-'
condition|)
block|{
name|ch
operator|=
literal|'_'
expr_stmt|;
block|}
if|if
condition|(
name|var
operator|->
name|data
index|[
name|n
operator|+
name|prefix
index|]
operator|!=
name|ch
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|n
operator|!=
name|var
operator|->
name|len
operator|-
name|prefix
condition|)
block|{
continue|continue;
block|}
name|len
operator|+=
name|header
index|[
name|i
index|]
operator|.
name|value
operator|.
name|len
operator|+
literal|2
expr_stmt|;
operator|*
name|ph
operator|=
operator|&
name|header
index|[
name|i
index|]
expr_stmt|;
name|ph
operator|=
operator|&
name|header
index|[
name|i
index|]
operator|.
name|next
expr_stmt|;
block|}
operator|*
name|ph
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|len
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|h
operator|->
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|h
operator|->
name|value
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|p
operator|=
name|ngx_copy
argument_list|(
name|p
argument_list|,
name|h
operator|->
name|value
operator|.
name|data
argument_list|,
name|h
operator|->
name|value
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
operator|*
name|p
operator|++
operator|=
literal|','
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
name|h
operator|=
name|h
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_line (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_line
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|r
operator|->
name|request_line
operator|.
name|data
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|s
operator|=
name|r
operator|->
name|request_start
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
for|for
control|(
name|p
operator|=
name|s
init|;
name|p
operator|<
name|r
operator|->
name|header_in
operator|->
name|last
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
name|CR
operator|||
operator|*
name|p
operator|==
name|LF
condition|)
block|{
break|break;
block|}
block|}
name|r
operator|->
name|request_line
operator|.
name|len
operator|=
name|p
operator|-
name|s
expr_stmt|;
name|r
operator|->
name|request_line
operator|.
name|data
operator|=
name|s
expr_stmt|;
block|}
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|request_line
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|s
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_cookie (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_cookie
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|name
init|=
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
decl_stmt|;
name|ngx_str_t
name|cookie
decl_stmt|,
name|s
decl_stmt|;
name|s
operator|.
name|len
operator|=
name|name
operator|->
name|len
operator|-
operator|(
sizeof|sizeof
argument_list|(
literal|"cookie_"
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|s
operator|.
name|data
operator|=
name|name
operator|->
name|data
operator|+
sizeof|sizeof
argument_list|(
literal|"cookie_"
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ngx_http_parse_multi_header_lines
argument_list|(
name|r
argument_list|,
name|r
operator|->
name|headers_in
operator|.
name|cookie
argument_list|,
operator|&
name|s
argument_list|,
operator|&
name|cookie
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|len
operator|=
name|cookie
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|cookie
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_argument (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_argument
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|name
init|=
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
decl_stmt|;
name|u_char
modifier|*
name|arg
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_str_t
name|value
decl_stmt|;
name|len
operator|=
name|name
operator|->
name|len
operator|-
operator|(
sizeof|sizeof
argument_list|(
literal|"arg_"
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|arg
operator|=
name|name
operator|->
name|data
operator|+
sizeof|sizeof
argument_list|(
literal|"arg_"
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
operator|||
name|ngx_http_arg
argument_list|(
name|r
argument_list|,
name|arg
argument_list|,
name|len
argument_list|,
operator|&
name|value
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|data
operator|=
name|value
operator|.
name|data
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_TCP_INFO
operator|)
end_if

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_tcpinfo (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_tcpinfo
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|struct
name|tcp_info
name|ti
decl_stmt|;
name|socklen_t
name|len
decl_stmt|;
name|uint32_t
name|value
decl_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tcp_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockopt
argument_list|(
name|r
operator|->
name|connection
operator|->
name|fd
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_INFO
argument_list|,
operator|&
name|ti
argument_list|,
operator|&
name|len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_INT32_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
switch|switch
condition|(
name|data
condition|)
block|{
case|case
literal|0
case|:
name|value
operator|=
name|ti
operator|.
name|tcpi_rtt
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|value
operator|=
name|ti
operator|.
name|tcpi_rttvar
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|value
operator|=
name|ti
operator|.
name|tcpi_snd_cwnd
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|value
operator|=
name|ti
operator|.
name|tcpi_rcv_space
expr_stmt|;
break|break;
comment|/* suppress warning */
default|default:
name|value
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%uD"
argument_list|,
name|value
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_content_length (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_content_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|content_length
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|headers_in
operator|.
name|content_length
operator|->
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|headers_in
operator|.
name|content_length
operator|->
name|value
operator|.
name|data
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
block|}
if|else if
condition|(
name|r
operator|->
name|reading_body
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|1
expr_stmt|;
block|}
if|else if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
operator|>=
literal|0
condition|)
block|{
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_OFF_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%O"
argument_list|,
name|r
operator|->
name|headers_in
operator|.
name|content_length_n
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
block|}
if|else if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|chunked
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_host (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_host
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|server
operator|.
name|len
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|headers_in
operator|.
name|server
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|headers_in
operator|.
name|server
operator|.
name|data
expr_stmt|;
block|}
else|else
block|{
name|cscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|cscf
operator|->
name|server_name
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|cscf
operator|->
name|server_name
operator|.
name|data
expr_stmt|;
block|}
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_binary_remote_addr (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_binary_remote_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_INET6
operator|)
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|r
operator|->
name|connection
operator|->
name|sockaddr
operator|->
name|sa_family
condition|)
block|{
if|#
directive|if
operator|(
name|NGX_HAVE_INET6
operator|)
case|case
name|AF_INET6
case|:
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|r
operator|->
name|connection
operator|->
name|sockaddr
expr_stmt|;
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
expr_stmt|;
break|break;
endif|#
directive|endif
if|#
directive|if
operator|(
name|NGX_HAVE_UNIX_DOMAIN
operator|)
case|case
name|AF_UNIX
case|:
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|data
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
comment|/* AF_INET */
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|r
operator|->
name|connection
operator|->
name|sockaddr
expr_stmt|;
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
name|in_addr_t
argument_list|)
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|&
name|sin
operator|->
name|sin_addr
expr_stmt|;
break|break;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_remote_addr (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_remote_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|connection
operator|->
name|addr_text
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_remote_port (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_remote_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_uint_t
name|port
decl_stmt|;
name|v
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"65535"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|port
operator|=
name|ngx_inet_get_port
argument_list|(
name|r
operator|->
name|connection
operator|->
name|sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|>
literal|0
operator|&&
name|port
operator|<
literal|65536
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%ui"
argument_list|,
name|port
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_proxy_protocol_addr (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_proxy_protocol_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|addr
decl_stmt|;
name|ngx_proxy_protocol_t
modifier|*
name|pp
decl_stmt|;
name|pp
operator|=
name|r
operator|->
name|connection
operator|->
name|proxy_protocol
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|addr
operator|=
operator|(
name|ngx_str_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pp
operator|+
name|data
operator|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|addr
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|addr
operator|->
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_proxy_protocol_port (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_proxy_protocol_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_uint_t
name|port
decl_stmt|;
name|ngx_proxy_protocol_t
modifier|*
name|pp
decl_stmt|;
name|pp
operator|=
name|r
operator|->
name|connection
operator|->
name|proxy_protocol
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"65535"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|port
operator|=
operator|*
operator|(
name|in_port_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pp
operator|+
name|data
operator|)
expr_stmt|;
if|if
condition|(
name|port
operator|>
literal|0
operator|&&
name|port
operator|<
literal|65536
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%ui"
argument_list|,
name|port
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_proxy_protocol_tlv (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_proxy_protocol_tlv
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|name
init|=
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_str_t
name|tlv
decl_stmt|,
name|value
decl_stmt|;
name|tlv
operator|.
name|len
operator|=
name|name
operator|->
name|len
operator|-
operator|(
sizeof|sizeof
argument_list|(
literal|"proxy_protocol_tlv_"
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|tlv
operator|.
name|data
operator|=
name|name
operator|->
name|data
operator|+
sizeof|sizeof
argument_list|(
literal|"proxy_protocol_tlv_"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|rc
operator|=
name|ngx_proxy_protocol_get_tlv
argument_list|(
name|r
operator|->
name|connection
argument_list|,
operator|&
name|tlv
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|len
operator|=
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|value
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_server_addr (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_server_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
name|s
decl_stmt|;
name|u_char
name|addr
index|[
name|NGX_SOCKADDR_STRLEN
index|]
decl_stmt|;
name|s
operator|.
name|len
operator|=
name|NGX_SOCKADDR_STRLEN
expr_stmt|;
name|s
operator|.
name|data
operator|=
name|addr
expr_stmt|;
if|if
condition|(
name|ngx_connection_local_sockaddr
argument_list|(
name|r
operator|->
name|connection
argument_list|,
operator|&
name|s
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|s
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|s
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|s
operator|.
name|data
argument_list|,
name|addr
argument_list|,
name|s
operator|.
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|s
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|s
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_server_port (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_server_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_uint_t
name|port
decl_stmt|;
name|v
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ngx_connection_local_sockaddr
argument_list|(
name|r
operator|->
name|connection
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"65535"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|port
operator|=
name|ngx_inet_get_port
argument_list|(
name|r
operator|->
name|connection
operator|->
name|local_sockaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|>
literal|0
operator|&&
name|port
operator|<
literal|65536
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%ui"
argument_list|,
name|port
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_scheme (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_scheme
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
if|if
condition|(
name|r
operator|->
name|connection
operator|->
name|ssl
condition|)
block|{
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"https"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"https"
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
endif|#
directive|endif
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"http"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"http"
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_https (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_https
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|#
directive|if
operator|(
name|NGX_HTTP_SSL
operator|)
if|if
condition|(
name|r
operator|->
name|connection
operator|->
name|ssl
condition|)
block|{
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"on"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"on"
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
endif|#
directive|endif
operator|*
name|v
operator|=
name|ngx_http_variable_null_value
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_variable_set_args (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_set_args
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|r
operator|->
name|args
operator|.
name|len
operator|=
name|v
operator|->
name|len
expr_stmt|;
name|r
operator|->
name|args
operator|.
name|data
operator|=
name|v
operator|->
name|data
expr_stmt|;
name|r
operator|->
name|valid_unparsed_uri
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_is_args (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_is_args
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|args
operator|.
name|len
operator|==
literal|0
condition|)
block|{
operator|*
name|v
operator|=
name|ngx_http_variable_null_value
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|len
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"?"
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_document_root (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_document_root
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
name|path
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|clcf
operator|->
name|root_lengths
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|clcf
operator|->
name|root
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|clcf
operator|->
name|root
operator|.
name|data
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ngx_http_script_run
argument_list|(
name|r
argument_list|,
operator|&
name|path
argument_list|,
name|clcf
operator|->
name|root_lengths
operator|->
name|elts
argument_list|,
literal|0
argument_list|,
name|clcf
operator|->
name|root_values
operator|->
name|elts
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_get_full_name
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|(
name|ngx_str_t
operator|*
operator|)
operator|&
name|ngx_cycle
operator|->
name|prefix
argument_list|,
operator|&
name|path
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|path
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|path
operator|.
name|data
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_realpath_root (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_realpath_root
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|real
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_str_t
name|path
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_HAVE_MAX_PATH
operator|)
name|u_char
name|buffer
index|[
name|NGX_MAX_PATH
index|]
decl_stmt|;
endif|#
directive|endif
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|clcf
operator|->
name|root_lengths
operator|==
name|NULL
condition|)
block|{
name|path
operator|=
name|clcf
operator|->
name|root
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ngx_http_script_run
argument_list|(
name|r
argument_list|,
operator|&
name|path
argument_list|,
name|clcf
operator|->
name|root_lengths
operator|->
name|elts
argument_list|,
literal|1
argument_list|,
name|clcf
operator|->
name|root_values
operator|->
name|elts
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|path
operator|.
name|data
index|[
name|path
operator|.
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|ngx_get_full_name
argument_list|(
name|r
operator|->
name|pool
argument_list|,
operator|(
name|ngx_str_t
operator|*
operator|)
operator|&
name|ngx_cycle
operator|->
name|prefix
argument_list|,
operator|&
name|path
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
if|#
directive|if
operator|(
name|NGX_HAVE_MAX_PATH
operator|)
name|real
operator|=
name|buffer
expr_stmt|;
else|#
directive|else
name|real
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|real
operator|=
name|ngx_realpath
argument_list|(
name|path
operator|.
name|data
argument_list|,
name|real
argument_list|)
expr_stmt|;
if|if
condition|(
name|real
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_realpath_n
literal|" \"%s\" failed"
argument_list|,
name|path
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|len
operator|=
name|ngx_strlen
argument_list|(
name|real
argument_list|)
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
if|#
directive|if
operator|!
operator|(
name|NGX_HAVE_MAX_PATH
operator|)
name|ngx_free
argument_list|(
name|real
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|v
operator|->
name|data
argument_list|,
name|real
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
operator|(
name|NGX_HAVE_MAX_PATH
operator|)
name|ngx_free
argument_list|(
name|real
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_filename (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_filename
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|size_t
name|root
decl_stmt|;
name|ngx_str_t
name|path
decl_stmt|;
if|if
condition|(
name|ngx_http_map_uri_to_path
argument_list|(
name|r
argument_list|,
operator|&
name|path
argument_list|,
operator|&
name|root
argument_list|,
literal|0
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
comment|/* ngx_http_map_uri_to_path() allocates memory for terminating '\0' */
name|v
operator|->
name|len
operator|=
name|path
operator|.
name|len
operator|-
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|path
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_server_name (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_server_name
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_core_srv_conf_t
modifier|*
name|cscf
decl_stmt|;
name|cscf
operator|=
name|ngx_http_get_module_srv_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|cscf
operator|->
name|server_name
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|cscf
operator|->
name|server_name
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_method (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_method
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
expr|main
operator|->
name|method_name
operator|.
name|data
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|r
operator|->
expr|main
operator|->
name|method_name
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
expr|main
operator|->
name|method_name
operator|.
name|data
expr_stmt|;
block|}
else|else
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_remote_user (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_remote_user
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|rc
operator|=
name|ngx_http_auth_basic_user
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|headers_in
operator|.
name|user
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|headers_in
operator|.
name|user
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_bytes_sent (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_bytes_sent
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_OFF_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%O"
argument_list|,
name|r
operator|->
name|connection
operator|->
name|sent
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_body_bytes_sent (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_body_bytes_sent
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|off_t
name|sent
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|sent
operator|=
name|r
operator|->
name|connection
operator|->
name|sent
operator|-
name|r
operator|->
name|header_size
expr_stmt|;
if|if
condition|(
name|sent
operator|<
literal|0
condition|)
block|{
name|sent
operator|=
literal|0
expr_stmt|;
block|}
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_OFF_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%O"
argument_list|,
name|sent
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_pipe (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_pipe
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
operator|(
name|r
operator|->
name|pipeline
condition|?
literal|"p"
else|:
literal|"."
operator|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_status (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_status
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_uint_t
name|status
decl_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_INT_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|r
operator|->
name|err_status
condition|)
block|{
name|status
operator|=
name|r
operator|->
name|err_status
expr_stmt|;
block|}
if|else if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|status
condition|)
block|{
name|status
operator|=
name|r
operator|->
name|headers_out
operator|.
name|status
expr_stmt|;
block|}
if|else if
condition|(
name|r
operator|->
name|http_version
operator|==
name|NGX_HTTP_VERSION_9
condition|)
block|{
name|status
operator|=
literal|9
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
literal|0
expr_stmt|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|v
operator|->
name|data
argument_list|,
literal|"%03ui"
argument_list|,
name|status
argument_list|)
operator|-
name|v
operator|->
name|data
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_sent_content_type (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_sent_content_type
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|content_type
operator|.
name|len
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|headers_out
operator|.
name|content_type
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|headers_out
operator|.
name|content_type
operator|.
name|data
expr_stmt|;
block|}
else|else
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_sent_content_length (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_sent_content_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|content_length
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|headers_out
operator|.
name|content_length
operator|->
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|headers_out
operator|.
name|content_length
operator|->
name|value
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|content_length_n
operator|>=
literal|0
condition|)
block|{
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_OFF_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%O"
argument_list|,
name|r
operator|->
name|headers_out
operator|.
name|content_length_n
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_sent_location (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_sent_location
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
name|name
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|location
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|headers_out
operator|.
name|location
operator|->
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|headers_out
operator|.
name|location
operator|->
name|value
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|ngx_str_set
argument_list|(
operator|&
name|name
argument_list|,
literal|"sent_http_location"
argument_list|)
expr_stmt|;
return|return
name|ngx_http_variable_unknown_header
argument_list|(
name|r
argument_list|,
name|v
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|r
operator|->
name|headers_out
operator|.
name|headers
operator|.
name|part
argument_list|,
sizeof|sizeof
argument_list|(
literal|"sent_http_"
argument_list|)
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_sent_last_modified (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_sent_last_modified
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|last_modified
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|headers_out
operator|.
name|last_modified
operator|->
name|value
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|headers_out
operator|.
name|last_modified
operator|->
name|value
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|last_modified_time
operator|>=
literal|0
condition|)
block|{
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"Mon, 28 Sep 1970 06:00:00 GMT"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_http_time
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|headers_out
operator|.
name|last_modified_time
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_sent_connection (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_sent_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_out
operator|.
name|status
operator|==
name|NGX_HTTP_SWITCHING_PROTOCOLS
condition|)
block|{
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"upgrade"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|p
operator|=
literal|"upgrade"
expr_stmt|;
block|}
if|else if
condition|(
name|r
operator|->
name|keepalive
condition|)
block|{
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"keep-alive"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|p
operator|=
literal|"keep-alive"
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"close"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|p
operator|=
literal|"close"
expr_stmt|;
block|}
name|v
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_sent_keep_alive (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_sent_keep_alive
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|keepalive
condition|)
block|{
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|clcf
operator|->
name|keepalive_header
condition|)
block|{
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"timeout="
argument_list|)
operator|-
literal|1
operator|+
name|NGX_TIME_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"timeout=%T"
argument_list|,
name|clcf
operator|->
name|keepalive_header
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
block|}
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_sent_transfer_encoding (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_sent_transfer_encoding
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|chunked
condition|)
block|{
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|"chunked"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"chunked"
expr_stmt|;
block|}
else|else
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_variable_set_limit_rate (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_set_limit_rate
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ssize_t
name|s
decl_stmt|;
name|ngx_str_t
name|val
decl_stmt|;
name|val
operator|.
name|len
operator|=
name|v
operator|->
name|len
expr_stmt|;
name|val
operator|.
name|data
operator|=
name|v
operator|->
name|data
expr_stmt|;
name|s
operator|=
name|ngx_parse_size
argument_list|(
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"invalid $limit_rate \"%V\""
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
return|return;
block|}
name|r
operator|->
name|limit_rate
operator|=
name|s
expr_stmt|;
name|r
operator|->
name|limit_rate_set
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_completion (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_completion
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|request_complete
condition|)
block|{
name|v
operator|->
name|len
operator|=
literal|2
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
literal|"OK"
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
operator|*
name|v
operator|=
name|ngx_http_variable_null_value
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_body (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_body
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_buf_t
modifier|*
name|buf
decl_stmt|;
name|ngx_chain_t
modifier|*
name|cl
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|request_body
operator|==
name|NULL
operator|||
name|r
operator|->
name|request_body
operator|->
name|bufs
operator|==
name|NULL
operator|||
name|r
operator|->
name|request_body
operator|->
name|temp_file
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|cl
operator|=
name|r
operator|->
name|request_body
operator|->
name|bufs
expr_stmt|;
name|buf
operator|=
name|cl
operator|->
name|buf
expr_stmt|;
if|if
condition|(
name|cl
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|len
operator|=
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|buf
operator|->
name|pos
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|len
operator|=
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
expr_stmt|;
name|cl
operator|=
name|cl
operator|->
name|next
expr_stmt|;
for|for
control|(
comment|/* void */
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|buf
operator|=
name|cl
operator|->
name|buf
expr_stmt|;
name|len
operator|+=
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
expr_stmt|;
block|}
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
name|cl
operator|=
name|r
operator|->
name|request_body
operator|->
name|bufs
expr_stmt|;
for|for
control|(
comment|/* void */
init|;
name|cl
condition|;
name|cl
operator|=
name|cl
operator|->
name|next
control|)
block|{
name|buf
operator|=
name|cl
operator|->
name|buf
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|buf
operator|->
name|pos
argument_list|,
name|buf
operator|->
name|last
operator|-
name|buf
operator|->
name|pos
argument_list|)
expr_stmt|;
block|}
name|v
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_body_file (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_body_file
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
if|if
condition|(
name|r
operator|->
name|request_body
operator|==
name|NULL
operator|||
name|r
operator|->
name|request_body
operator|->
name|temp_file
operator|==
name|NULL
condition|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|v
operator|->
name|len
operator|=
name|r
operator|->
name|request_body
operator|->
name|temp_file
operator|->
name|file
operator|.
name|name
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|r
operator|->
name|request_body
operator|->
name|temp_file
operator|->
name|file
operator|.
name|name
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_length (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_length
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_OFF_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%O"
argument_list|,
name|r
operator|->
name|request_length
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_time (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_time
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_time_t
modifier|*
name|tp
decl_stmt|;
name|ngx_msec_int_t
name|ms
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_TIME_T_LEN
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
name|ms
operator|=
operator|(
name|ngx_msec_int_t
operator|)
operator|(
operator|(
name|tp
operator|->
name|sec
operator|-
name|r
operator|->
name|start_sec
operator|)
operator|*
literal|1000
operator|+
operator|(
name|tp
operator|->
name|msec
operator|-
name|r
operator|->
name|start_msec
operator|)
operator|)
expr_stmt|;
name|ms
operator|=
name|ngx_max
argument_list|(
name|ms
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%T.%03M"
argument_list|,
operator|(
name|time_t
operator|)
name|ms
operator|/
literal|1000
argument_list|,
name|ms
operator|%
literal|1000
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_request_id (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_request_id
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|id
decl_stmt|;
if|#
directive|if
operator|(
name|NGX_OPENSSL
operator|)
name|u_char
name|random_bytes
index|[
literal|16
index|]
decl_stmt|;
endif|#
directive|endif
name|id
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|len
operator|=
literal|32
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|id
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_OPENSSL
operator|)
if|if
condition|(
name|RAND_bytes
argument_list|(
name|random_bytes
argument_list|,
literal|16
argument_list|)
operator|==
literal|1
condition|)
block|{
name|ngx_hex_dump
argument_list|(
name|id
argument_list|,
name|random_bytes
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|ngx_ssl_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"RAND_bytes() failed"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ngx_sprintf
argument_list|(
name|id
argument_list|,
literal|"%08xD%08xD%08xD%08xD"
argument_list|,
operator|(
name|uint32_t
operator|)
name|ngx_random
argument_list|()
argument_list|,
operator|(
name|uint32_t
operator|)
name|ngx_random
argument_list|()
argument_list|,
operator|(
name|uint32_t
operator|)
name|ngx_random
argument_list|()
argument_list|,
operator|(
name|uint32_t
operator|)
name|ngx_random
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_connection (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_connection
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_ATOMIC_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%uA"
argument_list|,
name|r
operator|->
name|connection
operator|->
name|number
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_connection_requests (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_connection_requests
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_INT_T_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%ui"
argument_list|,
name|r
operator|->
name|connection
operator|->
name|requests
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_connection_time (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_connection_time
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_msec_int_t
name|ms
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_TIME_T_LEN
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ms
operator|=
name|ngx_current_msec
operator|-
name|r
operator|->
name|connection
operator|->
name|start_time
expr_stmt|;
name|ms
operator|=
name|ngx_max
argument_list|(
name|ms
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%T.%03M"
argument_list|,
operator|(
name|time_t
operator|)
name|ms
operator|/
literal|1000
argument_list|,
name|ms
operator|%
literal|1000
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_nginx_version (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_nginx_version
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
name|NGINX_VERSION
argument_list|)
operator|-
literal|1
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
operator|(
name|u_char
operator|*
operator|)
name|NGINX_VERSION
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_hostname (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_hostname
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|len
operator|=
name|ngx_cycle
operator|->
name|hostname
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|ngx_cycle
operator|->
name|hostname
operator|.
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_pid (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_pid
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_INT64_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%P"
argument_list|,
name|ngx_pid
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_msec (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_msec
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_time_t
modifier|*
name|tp
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|NGX_TIME_T_LEN
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|tp
operator|=
name|ngx_timeofday
argument_list|()
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|p
argument_list|,
literal|"%T.%03M"
argument_list|,
name|tp
operator|->
name|sec
argument_list|,
name|tp
operator|->
name|msec
argument_list|)
operator|-
name|p
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_time_iso8601 (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_time_iso8601
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|ngx_cached_http_log_iso8601
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|ngx_cached_http_log_iso8601
operator|.
name|data
argument_list|,
name|ngx_cached_http_log_iso8601
operator|.
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_cached_http_log_iso8601
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_time_local (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_time_local
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|ngx_cached_http_log_time
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|ngx_cached_http_log_time
operator|.
name|data
argument_list|,
name|ngx_cached_http_log_time
operator|.
name|len
argument_list|)
expr_stmt|;
name|v
operator|->
name|len
operator|=
name|ngx_cached_http_log_time
operator|.
name|len
expr_stmt|;
name|v
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|v
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|data
operator|=
name|p
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|void
modifier|*
DECL|function|ngx_http_map_find (ngx_http_request_t * r,ngx_http_map_t * map,ngx_str_t * match)
name|ngx_http_map_find
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_map_t
modifier|*
name|map
parameter_list|,
name|ngx_str_t
modifier|*
name|match
parameter_list|)
block|{
name|void
modifier|*
name|value
decl_stmt|;
name|u_char
modifier|*
name|low
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|key
decl_stmt|;
name|len
operator|=
name|match
operator|->
name|len
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
name|low
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|low
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
name|low
operator|=
name|NULL
expr_stmt|;
block|}
name|key
operator|=
name|ngx_hash_strlow
argument_list|(
name|low
argument_list|,
name|match
operator|->
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|value
operator|=
name|ngx_hash_find_combined
argument_list|(
operator|&
name|map
operator|->
name|hash
argument_list|,
name|key
argument_list|,
name|low
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
condition|)
block|{
return|return
name|value
return|;
block|}
if|#
directive|if
operator|(
name|NGX_PCRE
operator|)
if|if
condition|(
name|len
operator|&&
name|map
operator|->
name|nregex
condition|)
block|{
name|ngx_int_t
name|n
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_map_regex_t
modifier|*
name|reg
decl_stmt|;
name|reg
operator|=
name|map
operator|->
name|regex
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|map
operator|->
name|nregex
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|ngx_http_regex_exec
argument_list|(
name|r
argument_list|,
name|reg
index|[
name|i
index|]
operator|.
name|regex
argument_list|,
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_OK
condition|)
block|{
return|return
name|reg
index|[
name|i
index|]
operator|.
name|value
return|;
block|}
if|if
condition|(
name|n
operator|==
name|NGX_DECLINED
condition|)
block|{
continue|continue;
block|}
comment|/* NGX_ERROR */
return|return
name|NULL
return|;
block|}
block|}
endif|#
directive|endif
return|return
name|NULL
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_PCRE
operator|)
end_if

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_variable_not_found (ngx_http_request_t * r,ngx_http_variable_value_t * v,uintptr_t data)
name|ngx_http_variable_not_found
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_variable_value_t
modifier|*
name|v
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|v
operator|->
name|not_found
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_http_regex_t
modifier|*
DECL|function|ngx_http_regex_compile (ngx_conf_t * cf,ngx_regex_compile_t * rc)
name|ngx_http_regex_compile
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_regex_compile_t
modifier|*
name|rc
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|ngx_str_t
name|name
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_regex_t
modifier|*
name|re
decl_stmt|;
name|ngx_http_regex_variable_t
modifier|*
name|rv
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|rc
operator|->
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
if|if
condition|(
name|ngx_regex_compile
argument_list|(
name|rc
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"%V"
argument_list|,
operator|&
name|rc
operator|->
name|err
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|re
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_regex_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|re
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|re
operator|->
name|regex
operator|=
name|rc
operator|->
name|regex
expr_stmt|;
name|re
operator|->
name|ncaptures
operator|=
name|rc
operator|->
name|captures
expr_stmt|;
name|re
operator|->
name|name
operator|=
name|rc
operator|->
name|pattern
expr_stmt|;
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|cmcf
operator|->
name|ncaptures
operator|=
name|ngx_max
argument_list|(
name|cmcf
operator|->
name|ncaptures
argument_list|,
name|re
operator|->
name|ncaptures
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|ngx_uint_t
operator|)
name|rc
operator|->
name|named_captures
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
block|{
return|return
name|re
return|;
block|}
name|rv
operator|=
name|ngx_palloc
argument_list|(
name|rc
operator|->
name|pool
argument_list|,
name|n
operator|*
sizeof|sizeof
argument_list|(
name|ngx_http_regex_variable_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|re
operator|->
name|variables
operator|=
name|rv
expr_stmt|;
name|re
operator|->
name|nvariables
operator|=
name|n
expr_stmt|;
name|size
operator|=
name|rc
operator|->
name|name_size
expr_stmt|;
name|p
operator|=
name|rc
operator|->
name|names
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|rv
index|[
name|i
index|]
operator|.
name|capture
operator|=
literal|2
operator|*
operator|(
operator|(
name|p
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator|+
name|p
index|[
literal|1
index|]
operator|)
expr_stmt|;
name|name
operator|.
name|data
operator|=
operator|&
name|p
index|[
literal|2
index|]
expr_stmt|;
name|name
operator|.
name|len
operator|=
name|ngx_strlen
argument_list|(
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
name|v
operator|=
name|ngx_http_add_variable
argument_list|(
name|cf
argument_list|,
operator|&
name|name
argument_list|,
name|NGX_HTTP_VAR_CHANGEABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|rv
index|[
name|i
index|]
operator|.
name|index
operator|=
name|ngx_http_get_variable_index
argument_list|(
name|cf
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
index|[
name|i
index|]
operator|.
name|index
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|get_handler
operator|=
name|ngx_http_variable_not_found
expr_stmt|;
name|p
operator|+=
name|size
expr_stmt|;
block|}
return|return
name|re
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_regex_exec (ngx_http_request_t * r,ngx_http_regex_t * re,ngx_str_t * s)
name|ngx_http_regex_exec
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_regex_t
modifier|*
name|re
parameter_list|,
name|ngx_str_t
modifier|*
name|s
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|,
name|index
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|,
name|len
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|re
operator|->
name|ncaptures
condition|)
block|{
name|len
operator|=
name|cmcf
operator|->
name|ncaptures
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|captures
operator|==
name|NULL
operator|||
name|r
operator|->
name|realloc_captures
condition|)
block|{
name|r
operator|->
name|realloc_captures
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|captures
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|captures
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
block|}
else|else
block|{
name|len
operator|=
literal|0
expr_stmt|;
block|}
name|rc
operator|=
name|ngx_regex_exec
argument_list|(
name|re
operator|->
name|regex
argument_list|,
name|s
argument_list|,
name|r
operator|->
name|captures
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_REGEX_NO_MATCHED
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
if|if
condition|(
name|rc
operator|<
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
name|ngx_regex_exec_n
literal|" failed: %i on \"%V\" using \"%V\""
argument_list|,
name|rc
argument_list|,
name|s
argument_list|,
operator|&
name|re
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|re
operator|->
name|nvariables
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|re
operator|->
name|variables
index|[
name|i
index|]
operator|.
name|capture
expr_stmt|;
name|index
operator|=
name|re
operator|->
name|variables
index|[
name|i
index|]
operator|.
name|index
expr_stmt|;
name|vv
operator|=
operator|&
name|r
operator|->
name|variables
index|[
name|index
index|]
expr_stmt|;
name|vv
operator|->
name|len
operator|=
name|r
operator|->
name|captures
index|[
name|n
operator|+
literal|1
index|]
operator|-
name|r
operator|->
name|captures
index|[
name|n
index|]
expr_stmt|;
name|vv
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
name|vv
operator|->
name|no_cacheable
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|not_found
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|data
operator|=
operator|&
name|s
operator|->
name|data
index|[
name|r
operator|->
name|captures
index|[
name|n
index|]
index|]
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG
operator|)
block|{
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http regex set $%V to \"%v\""
argument_list|,
operator|&
name|v
index|[
name|index
index|]
operator|.
name|name
argument_list|,
name|vv
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
name|r
operator|->
name|ncaptures
operator|=
name|rc
operator|*
literal|2
expr_stmt|;
name|r
operator|->
name|captures_data
operator|=
name|s
operator|->
name|data
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|ngx_int_t
DECL|function|ngx_http_variables_add_core_vars (ngx_conf_t * cf)
name|ngx_http_variables_add_core_vars
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_variable_t
modifier|*
name|cv
decl_stmt|,
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|cmcf
operator|->
name|variables_keys
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|temp_pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_hash_keys_arrays_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmcf
operator|->
name|variables_keys
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cmcf
operator|->
name|variables_keys
operator|->
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
name|cmcf
operator|->
name|variables_keys
operator|->
name|temp_pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
if|if
condition|(
name|ngx_hash_keys_array_init
argument_list|(
name|cmcf
operator|->
name|variables_keys
argument_list|,
name|NGX_HASH_SMALL
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|cmcf
operator|->
name|prefix_variables
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
for|for
control|(
name|cv
operator|=
name|ngx_http_core_variables
init|;
name|cv
operator|->
name|name
operator|.
name|len
condition|;
name|cv
operator|++
control|)
block|{
name|v
operator|=
name|ngx_http_add_variable
argument_list|(
name|cf
argument_list|,
operator|&
name|cv
operator|->
name|name
argument_list|,
name|cv
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|v
operator|=
operator|*
name|cv
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_variables_init_vars (ngx_conf_t * cf)
name|ngx_http_variables_init_vars
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_hash_key_t
modifier|*
name|key
decl_stmt|;
name|ngx_hash_init_t
name|hash
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|,
modifier|*
name|av
decl_stmt|,
modifier|*
name|pv
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
comment|/* set the handlers for the indexed http variables */
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
name|pv
operator|=
name|cmcf
operator|->
name|prefix_variables
operator|.
name|elts
expr_stmt|;
name|key
operator|=
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|nelts
condition|;
name|n
operator|++
control|)
block|{
name|av
operator|=
name|key
index|[
name|n
index|]
operator|.
name|value
expr_stmt|;
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|==
name|key
index|[
name|n
index|]
operator|.
name|key
operator|.
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|key
index|[
name|n
index|]
operator|.
name|key
operator|.
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
index|[
name|i
index|]
operator|.
name|get_handler
operator|=
name|av
operator|->
name|get_handler
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|data
operator|=
name|av
operator|->
name|data
expr_stmt|;
name|av
operator|->
name|flags
operator||=
name|NGX_HTTP_VAR_INDEXED
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|av
operator|->
name|flags
expr_stmt|;
name|av
operator|->
name|index
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|av
operator|->
name|get_handler
operator|==
name|NULL
operator|||
operator|(
name|av
operator|->
name|flags
operator|&
name|NGX_HTTP_VAR_WEAK
operator|)
condition|)
block|{
break|break;
block|}
goto|goto
name|next
goto|;
block|}
block|}
name|len
operator|=
literal|0
expr_stmt|;
name|av
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|cmcf
operator|->
name|prefix_variables
operator|.
name|nelts
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|>=
name|pv
index|[
name|n
index|]
operator|.
name|name
operator|.
name|len
operator|&&
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|>
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|pv
index|[
name|n
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|pv
index|[
name|n
index|]
operator|.
name|name
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|av
operator|=
operator|&
name|pv
index|[
name|n
index|]
expr_stmt|;
name|len
operator|=
name|pv
index|[
name|n
index|]
operator|.
name|name
operator|.
name|len
expr_stmt|;
block|}
block|}
if|if
condition|(
name|av
condition|)
block|{
name|v
index|[
name|i
index|]
operator|.
name|get_handler
operator|=
name|av
operator|->
name|get_handler
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|data
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|av
operator|->
name|flags
expr_stmt|;
goto|goto
name|next
goto|;
block|}
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|get_handler
operator|==
name|NULL
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown \"%V\" variable"
argument_list|,
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|next
label|:
continue|continue;
block|}
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|nelts
condition|;
name|n
operator|++
control|)
block|{
name|av
operator|=
name|key
index|[
name|n
index|]
operator|.
name|value
expr_stmt|;
if|if
condition|(
name|av
operator|->
name|flags
operator|&
name|NGX_HTTP_VAR_NOHASH
condition|)
block|{
name|key
index|[
name|n
index|]
operator|.
name|key
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|hash
operator|.
name|hash
operator|=
operator|&
name|cmcf
operator|->
name|variables_hash
expr_stmt|;
name|hash
operator|.
name|key
operator|=
name|ngx_hash_key
expr_stmt|;
name|hash
operator|.
name|max_size
operator|=
name|cmcf
operator|->
name|variables_hash_max_size
expr_stmt|;
name|hash
operator|.
name|bucket_size
operator|=
name|cmcf
operator|->
name|variables_hash_bucket_size
expr_stmt|;
name|hash
operator|.
name|name
operator|=
literal|"variables_hash"
expr_stmt|;
name|hash
operator|.
name|pool
operator|=
name|cf
operator|->
name|pool
expr_stmt|;
name|hash
operator|.
name|temp_pool
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ngx_hash_init
argument_list|(
operator|&
name|hash
argument_list|,
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|elts
argument_list|,
name|cmcf
operator|->
name|variables_keys
operator|->
name|keys
operator|.
name|nelts
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cmcf
operator|->
name|variables_keys
operator|=
name|NULL
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

end_unit

