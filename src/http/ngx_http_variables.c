begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_define
DECL|macro|NGX_HTTP_VARS_HASH_PRIME
define|#
directive|define
name|NGX_HTTP_VARS_HASH_PRIME
value|29
end_define

begin_define
DECL|macro|ngx_http_vars_hash_key (key,vn)
define|#
directive|define
name|ngx_http_vars_hash_key
parameter_list|(
name|key
parameter_list|,
name|vn
parameter_list|)
define|\
value|{                                                                        \         ngx_uint_t  n;                                                       \         for (key = 0, n = 0; n< (vn)->len; n++) {                           \             key += (vn)->data[n];                                            \         }                                                                    \         key %= NGX_HTTP_VARS_HASH_PRIME;                                     \     }
end_define

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_unknown_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_remote_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_uri
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_query_string
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_http_core_variables_hash
specifier|static
name|ngx_array_t
modifier|*
name|ngx_http_core_variables_hash
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_core_variables
specifier|static
name|ngx_http_core_variable_t
name|ngx_http_core_variables
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"HTTP_HOST"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|host
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"HTTP_USER_AGENT"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|user_agent
argument_list|)
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"HTTP_REFERER"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|referer
argument_list|)
block|}
block|,
if|#
directive|if
operator|(
name|NGX_HTTP_GZIP
operator|)
block|{
name|ngx_string
argument_list|(
literal|"HTTP_VIA"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|via
argument_list|)
block|}
block|,
endif|#
directive|endif
if|#
directive|if
operator|(
name|NGX_HTTP_PROXY
operator|)
block|{
name|ngx_string
argument_list|(
literal|"HTTP_X_FORWARDED_FOR"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
argument|ngx_http_headers_in_t
argument_list|,
argument|x_forwarded_for
argument_list|)
block|}
block|,
endif|#
directive|endif
block|{
name|ngx_string
argument_list|(
literal|"REMOTE_ADDR"
argument_list|)
block|,
name|ngx_http_variable_remote_addr
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"DOCUMENT_URI"
argument_list|)
block|,
name|ngx_http_variable_uri
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"QUERY_STRING"
argument_list|)
block|,
name|ngx_http_variable_query_string
block|,
literal|0
block|}
block|,
block|{
name|ngx_null_string
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|ngx_http_variable_t
modifier|*
DECL|function|ngx_http_add_variable (ngx_conf_t * cf,ngx_str_t * name,ngx_uint_t set)
name|ngx_http_add_variable
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|set
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|cmcf
operator|->
name|variables
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_t
argument_list|)
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|set
operator|&&
name|v
index|[
name|i
index|]
operator|.
name|handler
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the duplicate \"%V\" variable"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
operator|&
name|v
index|[
name|i
index|]
return|;
block|}
block|}
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|variables
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|name
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|->
name|name
operator|.
name|data
index|[
name|i
index|]
operator|=
name|ngx_toupper
argument_list|(
name|name
operator|->
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|v
operator|->
name|index
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|-
literal|1
expr_stmt|;
name|v
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
return|return
name|v
return|;
block|}
end_function

begin_function
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_get_indexed_variable (ngx_http_request_t * r,ngx_uint_t index)
name|ngx_http_get_indexed_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_uint_t
name|index
parameter_list|)
block|{
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmcf
operator|->
name|variables
operator|.
name|elts
operator|==
name|NULL
operator|||
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|<=
name|index
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown variable index: %d"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|r
operator|->
name|variables
operator|&&
name|r
operator|->
name|variables
index|[
name|index
index|]
condition|)
block|{
return|return
name|r
operator|->
name|variables
index|[
name|index
index|]
return|;
block|}
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
name|vv
operator|=
name|v
index|[
name|index
index|]
operator|.
name|handler
argument_list|(
name|r
argument_list|,
name|v
index|[
name|index
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|variables
operator|==
name|NULL
condition|)
block|{
name|r
operator|->
name|variables
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|*
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|variables
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
block|}
name|r
operator|->
name|variables
index|[
name|index
index|]
operator|=
name|vv
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_get_variable (ngx_http_request_t * r,ngx_str_t * name)
name|ngx_http_get_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|,
name|key
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_variable_t
modifier|*
name|cv
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|!=
name|name
operator|->
name|len
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|ngx_http_get_indexed_variable
argument_list|(
name|r
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|index
argument_list|)
return|;
block|}
block|}
name|ngx_http_vars_hash_key
argument_list|(
name|key
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|cv
operator|=
name|ngx_http_core_variables_hash
index|[
name|key
index|]
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ngx_http_core_variables_hash
index|[
name|key
index|]
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cv
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|!=
name|name
operator|->
name|len
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|cv
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|cv
index|[
name|i
index|]
operator|.
name|handler
argument_list|(
name|r
argument_list|,
name|cv
index|[
name|i
index|]
operator|.
name|data
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
literal|"HTTP_"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|ngx_http_variable_unknown_header
argument_list|(
name|r
argument_list|,
operator|(
name|uintptr_t
operator|)
name|name
argument_list|)
return|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown \"%V\" variable"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_VARIABLE_NOT_FOUND
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_header (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|h
operator|=
operator|*
operator|(
name|ngx_table_elt_t
operator|*
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
operator|&
name|r
operator|->
name|headers_in
operator|+
name|data
operator|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_VARIABLE_NOT_FOUND
return|;
block|}
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|h
operator|->
name|value
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_unknown_header (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_unknown_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|var
init|=
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
decl_stmt|;
name|u_char
name|ch
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_list_part_t
modifier|*
name|part
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|header
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|part
operator|=
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
comment|/* void */
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|part
operator|->
name|nelts
condition|)
block|{
if|if
condition|(
name|part
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|part
operator|=
name|part
operator|->
name|next
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|+
literal|5
operator|<
name|var
operator|->
name|len
operator|&&
name|n
operator|<
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
condition|;
name|n
operator|++
control|)
block|{
name|ch
operator|=
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|>=
literal|'a'
operator|&&
name|ch
operator|<=
literal|'z'
condition|)
block|{
name|ch
operator|&=
operator|~
literal|0x20
expr_stmt|;
block|}
if|else if
condition|(
name|ch
operator|==
literal|'-'
condition|)
block|{
name|ch
operator|=
literal|'_'
expr_stmt|;
block|}
if|if
condition|(
name|var
operator|->
name|data
index|[
name|n
operator|+
literal|5
index|]
operator|!=
name|ch
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|n
operator|+
literal|5
operator|==
name|var
operator|->
name|len
condition|)
block|{
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|header
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
return|return
name|vv
return|;
block|}
block|}
return|return
name|NGX_HTTP_VARIABLE_NOT_FOUND
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_remote_addr (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_remote_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|r
operator|->
name|connection
operator|->
name|addr_text
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_uri (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_uri
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|r
operator|->
name|uri
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_query_string (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_query_string
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|r
operator|->
name|args
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_variables_init (ngx_cycle_t * cycle)
name|ngx_http_variables_init
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|key
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_variable_t
modifier|*
name|cv
decl_stmt|,
modifier|*
name|vp
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|ngx_http_core_variables_hash
operator|=
name|ngx_palloc
argument_list|(
name|cycle
operator|->
name|pool
argument_list|,
name|NGX_HTTP_VARS_HASH_PRIME
operator|*
sizeof|sizeof
argument_list|(
name|ngx_array_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_core_variables_hash
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NGX_HTTP_VARS_HASH_PRIME
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|ngx_http_core_variables_hash
index|[
name|i
index|]
argument_list|,
name|cycle
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_core_variable_t
argument_list|)
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
for|for
control|(
name|cv
operator|=
name|ngx_http_core_variables
init|;
name|cv
operator|->
name|name
operator|.
name|len
condition|;
name|cv
operator|++
control|)
block|{
name|ngx_http_vars_hash_key
argument_list|(
name|key
argument_list|,
operator|&
name|cv
operator|->
name|name
argument_list|)
expr_stmt|;
name|vp
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|ngx_http_core_variables_hash
index|[
name|key
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|vp
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|vp
operator|=
operator|*
name|cv
expr_stmt|;
block|}
name|cmcf
operator|=
name|ngx_http_cycle_get_module_main_conf
argument_list|(
name|cycle
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|handler
condition|)
block|{
continue|continue;
block|}
name|ngx_http_vars_hash_key
argument_list|(
name|key
argument_list|,
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|cv
operator|=
name|ngx_http_core_variables_hash
index|[
name|key
index|]
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ngx_http_core_variables_hash
index|[
name|key
index|]
operator|.
name|nelts
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|cv
index|[
name|j
index|]
operator|.
name|name
operator|.
name|len
operator|!=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|cv
index|[
name|j
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
index|[
name|i
index|]
operator|.
name|handler
operator|=
name|cv
index|[
name|j
index|]
operator|.
name|handler
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|data
operator|=
name|cv
index|[
name|j
index|]
operator|.
name|data
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
literal|"HTTP_"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
index|[
name|i
index|]
operator|.
name|handler
operator|=
name|ngx_http_variable_unknown_header
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|data
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
continue|continue;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown \"%V\" variable"
argument_list|,
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

end_unit

