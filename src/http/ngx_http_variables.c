begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_headers
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_unknown_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_host
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_remote_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_remote_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_server_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_server_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_document_root
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_request_filename
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_variable_value_t
modifier|*
name|ngx_http_variable_remote_user
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * TODO:  *     Apache CGI: AUTH_TYPE, PATH_INFO (null), PATH_TRANSLATED  *                 REMOTE_HOST (null), REMOTE_IDENT (null),  *                 SERVER_SOFTWARE  *  *     Apache SSI: DATE_GMT, DOCUMENT_NAME, LAST_MODIFIED,  *                 USER_NAME (file owner)  */
end_comment

begin_decl_stmt
DECL|variable|ngx_http_core_variables
specifier|static
name|ngx_http_variable_t
name|ngx_http_core_variables
index|[]
init|=
block|{
block|{
name|ngx_string
argument_list|(
literal|"http_host"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|host
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_user_agent"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|user_agent
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"http_referer"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|referer
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
if|#
directive|if
operator|(
name|NGX_HTTP_GZIP
operator|)
block|{
name|ngx_string
argument_list|(
literal|"http_via"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|via
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
if|#
directive|if
operator|(
name|NGX_HTTP_PROXY
operator|)
block|{
name|ngx_string
argument_list|(
literal|"http_x_forwarded_for"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|x_forwarded_for
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
endif|#
directive|endif
block|{
name|ngx_string
argument_list|(
literal|"http_cookie"
argument_list|)
block|,
name|ngx_http_variable_headers
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|cookies
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"content_length"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|content_length
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"content_type"
argument_list|)
block|,
name|ngx_http_variable_header
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|headers_in
operator|.
name|content_type
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"host"
argument_list|)
block|,
name|ngx_http_variable_host
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"remote_addr"
argument_list|)
block|,
name|ngx_http_variable_remote_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"remote_port"
argument_list|)
block|,
name|ngx_http_variable_remote_port
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_addr"
argument_list|)
block|,
name|ngx_http_variable_server_addr
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_port"
argument_list|)
block|,
name|ngx_http_variable_server_port
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_protocol"
argument_list|)
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|http_protocol
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_uri"
argument_list|)
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|unparsed_uri
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"document_uri"
argument_list|)
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|uri
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"document_root"
argument_list|)
block|,
name|ngx_http_variable_document_root
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"query_string"
argument_list|)
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|args
argument_list|)
block|,
name|NGX_HTTP_VAR_NOCACHABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_filename"
argument_list|)
block|,
name|ngx_http_variable_request_filename
block|,
literal|0
block|,
name|NGX_HTTP_VAR_NOCACHABLE
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"server_name"
argument_list|)
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|server_name
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"request_method"
argument_list|)
block|,
name|ngx_http_variable_request
block|,
name|offsetof
argument_list|(
name|ngx_http_request_t
argument_list|,
name|method_name
argument_list|)
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_string
argument_list|(
literal|"remote_user"
argument_list|)
block|,
name|ngx_http_variable_remote_user
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
name|ngx_null_string
block|,
name|NULL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|ngx_http_variable_t
modifier|*
DECL|function|ngx_http_add_variable (ngx_conf_t * cf,ngx_str_t * name,ngx_uint_t flags)
name|ngx_http_add_variable
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|,
name|ngx_uint_t
name|flags
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|all_variables
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|all_variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
operator|!
operator|(
name|v
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|NGX_HTTP_VAR_CHANGABLE
operator|)
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"the duplicate \"%V\" variable"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
operator|&
name|v
index|[
name|i
index|]
return|;
block|}
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|all_variables
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|name
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|->
name|name
operator|.
name|data
index|[
name|i
index|]
operator|=
name|ngx_tolower
argument_list|(
name|name
operator|->
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|v
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|v
operator|->
name|index
operator|=
literal|0
expr_stmt|;
return|return
name|v
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_get_variable_index (ngx_conf_t * cf,ngx_str_t * name)
name|ngx_http_get_variable_index
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|cmcf
operator|->
name|variables
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_t
argument_list|)
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|name
operator|->
name|len
operator|!=
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|||
name|ngx_strncasecmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|!=
literal|0
condition|)
block|{
continue|continue;
block|}
return|return
name|i
return|;
block|}
block|}
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|variables
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|v
operator|->
name|name
operator|.
name|len
operator|=
name|name
operator|->
name|len
expr_stmt|;
name|v
operator|->
name|name
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
name|name
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|->
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|name
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|->
name|name
operator|.
name|data
index|[
name|i
index|]
operator|=
name|ngx_tolower
argument_list|(
name|name
operator|->
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|v
operator|->
name|handler
operator|=
name|NULL
expr_stmt|;
name|v
operator|->
name|data
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|v
operator|->
name|index
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|-
literal|1
expr_stmt|;
return|return
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_get_indexed_variable (ngx_http_request_t * r,ngx_uint_t index)
name|ngx_http_get_indexed_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_uint_t
name|index
parameter_list|)
block|{
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmcf
operator|->
name|variables
operator|.
name|elts
operator|==
name|NULL
operator|||
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|<=
name|index
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown variable index: %d"
argument_list|,
name|index
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|r
operator|->
name|variables
operator|&&
name|r
operator|->
name|variables
index|[
name|index
index|]
condition|)
block|{
return|return
name|r
operator|->
name|variables
index|[
name|index
index|]
return|;
block|}
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
name|vv
operator|=
name|v
index|[
name|index
index|]
operator|.
name|handler
argument_list|(
name|r
argument_list|,
name|v
index|[
name|index
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|variables
operator|==
name|NULL
condition|)
block|{
name|r
operator|->
name|variables
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|cmcf
operator|->
name|variables
operator|.
name|nelts
operator|*
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|variables
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
operator|!
operator|(
name|v
index|[
name|index
index|]
operator|.
name|flags
operator|&
name|NGX_HTTP_VAR_NOCACHABLE
operator|)
condition|)
block|{
name|r
operator|->
name|variables
index|[
name|index
index|]
operator|=
name|vv
expr_stmt|;
block|}
return|return
name|vv
return|;
block|}
end_function

begin_function
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_get_variable (ngx_http_request_t * r,ngx_str_t * name)
name|ngx_http_get_variable
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|,
name|key
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_get_module_main_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|key
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|name
operator|->
name|len
condition|;
name|i
operator|++
control|)
block|{
name|key
operator|+=
name|name
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
block|}
name|key
operator|%=
name|cmcf
operator|->
name|variables_hash
operator|.
name|hash_size
expr_stmt|;
name|v
operator|=
operator|(
name|ngx_http_variable_t
operator|*
operator|)
name|cmcf
operator|->
name|variables_hash
operator|.
name|buckets
expr_stmt|;
if|if
condition|(
name|v
index|[
name|key
index|]
operator|.
name|name
operator|.
name|len
operator|==
name|name
operator|->
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|v
index|[
name|key
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|name
operator|->
name|data
argument_list|,
name|name
operator|->
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|v
index|[
name|key
index|]
operator|.
name|flags
operator|&
name|NGX_HTTP_VAR_INDEXED
condition|)
block|{
return|return
name|ngx_http_get_indexed_variable
argument_list|(
name|r
argument_list|,
name|v
index|[
name|key
index|]
operator|.
name|index
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|v
index|[
name|key
index|]
operator|.
name|handler
argument_list|(
name|r
argument_list|,
name|v
index|[
name|key
index|]
operator|.
name|data
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|name
operator|->
name|data
argument_list|,
literal|"http_"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|ngx_http_variable_unknown_header
argument_list|(
name|r
argument_list|,
operator|(
name|uintptr_t
operator|)
name|name
argument_list|)
return|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown \"%V\" variable"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_HTTP_VAR_NOT_FOUND
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_request (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_request
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|s
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|s
operator|=
operator|(
name|ngx_str_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|r
operator|+
name|data
operator|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_VAR_NOT_FOUND
return|;
block|}
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
operator|*
name|s
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_header (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_table_elt_t
modifier|*
name|h
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|h
operator|=
operator|*
operator|(
name|ngx_table_elt_t
operator|*
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|r
operator|+
name|data
operator|)
expr_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_VAR_NOT_FOUND
return|;
block|}
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|h
operator|->
name|value
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_headers (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_headers
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_array_t
modifier|*
name|a
decl_stmt|;
name|ngx_table_elt_t
modifier|*
modifier|*
name|h
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|a
operator|=
operator|(
name|ngx_array_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|r
operator|+
name|data
operator|)
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|nelts
operator|==
literal|0
condition|)
block|{
return|return
name|NGX_HTTP_VAR_NOT_FOUND
return|;
block|}
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|h
operator|=
name|a
operator|->
name|elts
expr_stmt|;
if|if
condition|(
name|a
operator|->
name|nelts
operator|==
literal|1
condition|)
block|{
name|vv
operator|->
name|text
operator|=
operator|(
operator|*
name|h
operator|)
operator|->
name|value
expr_stmt|;
return|return
name|vv
return|;
block|}
name|vv
operator|->
name|text
operator|.
name|len
operator|=
operator|(
name|size_t
operator|)
operator|-
operator|(
name|ssize_t
operator|)
operator|(
sizeof|sizeof
argument_list|(
literal|"; "
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|a
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|vv
operator|->
name|text
operator|.
name|len
operator|+=
name|h
index|[
name|i
index|]
operator|->
name|value
operator|.
name|len
operator|+
sizeof|sizeof
argument_list|(
literal|"; "
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|vv
operator|->
name|text
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|vv
operator|->
name|text
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|->
name|text
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|p
operator|=
name|vv
operator|->
name|text
operator|.
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
comment|/* void */
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|h
index|[
name|i
index|]
operator|->
name|value
operator|.
name|data
argument_list|,
name|h
index|[
name|i
index|]
operator|->
name|value
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|a
operator|->
name|nelts
operator|-
literal|1
condition|)
block|{
break|break;
block|}
operator|*
name|p
operator|++
operator|=
literal|';'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_unknown_header (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_unknown_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_str_t
modifier|*
name|var
init|=
operator|(
name|ngx_str_t
operator|*
operator|)
name|data
decl_stmt|;
name|u_char
name|ch
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_list_part_t
modifier|*
name|part
decl_stmt|;
name|ngx_table_elt_t
modifier|*
name|header
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|part
operator|=
operator|&
name|r
operator|->
name|headers_in
operator|.
name|headers
operator|.
name|part
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
comment|/* void */
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|part
operator|->
name|nelts
condition|)
block|{
if|if
condition|(
name|part
operator|->
name|next
operator|==
name|NULL
condition|)
block|{
break|break;
block|}
name|part
operator|=
name|part
operator|->
name|next
expr_stmt|;
name|header
operator|=
name|part
operator|->
name|elts
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|+
literal|5
operator|<
name|var
operator|->
name|len
operator|&&
name|n
operator|<
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|len
condition|;
name|n
operator|++
control|)
block|{
name|ch
operator|=
name|header
index|[
name|i
index|]
operator|.
name|key
operator|.
name|data
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
name|ch
operator|>=
literal|'A'
operator|&&
name|ch
operator|<=
literal|'Z'
condition|)
block|{
name|ch
operator||=
literal|0x20
expr_stmt|;
block|}
if|else if
condition|(
name|ch
operator|==
literal|'-'
condition|)
block|{
name|ch
operator|=
literal|'_'
expr_stmt|;
block|}
if|if
condition|(
name|var
operator|->
name|data
index|[
name|n
operator|+
literal|5
index|]
operator|!=
name|ch
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|n
operator|+
literal|5
operator|==
name|var
operator|->
name|len
condition|)
block|{
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|header
index|[
name|i
index|]
operator|.
name|value
expr_stmt|;
return|return
name|vv
return|;
block|}
block|}
return|return
name|NGX_HTTP_VAR_NOT_FOUND
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_host (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_host
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|headers_in
operator|.
name|host
condition|)
block|{
name|vv
operator|->
name|text
operator|.
name|len
operator|=
name|r
operator|->
name|headers_in
operator|.
name|host_name_len
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|data
operator|=
name|r
operator|->
name|headers_in
operator|.
name|host
operator|->
name|value
operator|.
name|data
expr_stmt|;
block|}
else|else
block|{
name|vv
operator|->
name|text
operator|=
name|r
operator|->
name|server_name
expr_stmt|;
block|}
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_remote_addr (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_remote_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|r
operator|->
name|connection
operator|->
name|addr_text
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_remote_port (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_remote_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_uint_t
name|port
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
literal|"65535"
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|->
name|text
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* AF_INET only */
if|if
condition|(
name|r
operator|->
name|connection
operator|->
name|sockaddr
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|r
operator|->
name|connection
operator|->
name|sockaddr
expr_stmt|;
name|port
operator|=
name|ntohs
argument_list|(
name|sin
operator|->
name|sin_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|>
literal|0
operator|&&
name|port
operator|<
literal|65536
condition|)
block|{
name|vv
operator|->
name|value
operator|=
name|port
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|len
operator|=
name|ngx_sprintf
argument_list|(
name|vv
operator|->
name|text
operator|.
name|data
argument_list|,
literal|"%ui"
argument_list|,
name|port
argument_list|)
operator|-
name|vv
operator|->
name|text
operator|.
name|data
expr_stmt|;
block|}
block|}
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_server_addr (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_server_addr
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|socklen_t
name|len
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|INET_ADDRSTRLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|->
name|text
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|c
operator|=
name|r
operator|->
name|connection
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|in_addr
operator|==
literal|0
condition|)
block|{
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|c
operator|->
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
operator|&
name|len
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_socket_errno
argument_list|,
literal|"getsockname() failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|r
operator|->
name|in_addr
operator|=
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
block|}
name|vv
operator|->
name|text
operator|.
name|len
operator|=
name|ngx_inet_ntop
argument_list|(
name|c
operator|->
name|listening
operator|->
name|family
argument_list|,
operator|&
name|r
operator|->
name|in_addr
argument_list|,
name|vv
operator|->
name|text
operator|.
name|data
argument_list|,
name|INET_ADDRSTRLEN
argument_list|)
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_server_port (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_server_port
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
name|r
operator|->
name|port
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|len
operator|=
name|r
operator|->
name|port_text
operator|->
name|len
operator|-
literal|1
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|data
operator|=
name|r
operator|->
name|port_text
operator|->
name|data
operator|+
literal|1
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_document_root (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_document_root
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|clcf
operator|->
name|root
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_request_filename (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_request_filename
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|clcf
operator|->
name|alias
condition|)
block|{
name|vv
operator|->
name|text
operator|.
name|len
operator|=
name|clcf
operator|->
name|root
operator|.
name|len
operator|+
name|r
operator|->
name|uri
operator|.
name|len
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|vv
operator|->
name|text
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|->
name|text
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|vv
operator|->
name|text
operator|.
name|data
argument_list|,
name|clcf
operator|->
name|root
operator|.
name|data
argument_list|,
name|clcf
operator|->
name|root
operator|.
name|len
argument_list|)
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|uri
operator|.
name|data
argument_list|,
name|r
operator|->
name|uri
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vv
operator|->
name|text
operator|.
name|len
operator|=
name|clcf
operator|->
name|root
operator|.
name|len
operator|+
name|r
operator|->
name|uri
operator|.
name|len
operator|+
literal|2
operator|-
name|clcf
operator|->
name|name
operator|.
name|len
expr_stmt|;
name|vv
operator|->
name|text
operator|.
name|data
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|vv
operator|->
name|text
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|->
name|text
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|vv
operator|->
name|text
operator|.
name|data
argument_list|,
name|clcf
operator|->
name|root
operator|.
name|data
argument_list|,
name|clcf
operator|->
name|root
operator|.
name|len
argument_list|)
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|p
argument_list|,
name|r
operator|->
name|uri
operator|.
name|data
operator|+
name|clcf
operator|->
name|name
operator|.
name|len
argument_list|,
name|r
operator|->
name|uri
operator|.
name|len
operator|+
literal|1
operator|-
name|clcf
operator|->
name|name
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
return|return
name|vv
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_variable_value_t
modifier|*
DECL|function|ngx_http_variable_remote_user (ngx_http_request_t * r,uintptr_t data)
name|ngx_http_variable_remote_user
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|uintptr_t
name|data
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_http_variable_value_t
modifier|*
name|vv
decl_stmt|;
name|rc
operator|=
name|ngx_http_auth_basic_user
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
return|return
name|NGX_HTTP_VAR_NOT_FOUND
return|;
block|}
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|=
name|ngx_palloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vv
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|vv
operator|->
name|value
operator|=
literal|0
expr_stmt|;
name|vv
operator|->
name|text
operator|=
name|r
operator|->
name|headers_in
operator|.
name|user
expr_stmt|;
return|return
name|vv
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_variables_add_core_vars (ngx_conf_t * cf)
name|ngx_http_variables_add_core_vars
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|,
modifier|*
name|cv
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|cmcf
operator|->
name|all_variables
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
literal|32
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_variable_t
argument_list|)
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
for|for
control|(
name|cv
operator|=
name|ngx_http_core_variables
init|;
name|cv
operator|->
name|name
operator|.
name|len
condition|;
name|cv
operator|++
control|)
block|{
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|&
name|cmcf
operator|->
name|all_variables
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
operator|*
name|v
operator|=
operator|*
name|cv
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_variables_init_vars (ngx_conf_t * cf)
name|ngx_http_variables_init_vars
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_http_variable_t
modifier|*
name|v
decl_stmt|,
modifier|*
name|av
decl_stmt|;
name|ngx_http_core_main_conf_t
modifier|*
name|cmcf
decl_stmt|;
comment|/* set the handlers for the indexed http variables */
name|cmcf
operator|=
name|ngx_http_conf_get_module_main_conf
argument_list|(
name|cf
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|v
operator|=
name|cmcf
operator|->
name|variables
operator|.
name|elts
expr_stmt|;
name|av
operator|=
name|cmcf
operator|->
name|all_variables
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cmcf
operator|->
name|variables
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|cmcf
operator|->
name|all_variables
operator|.
name|nelts
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
operator|==
name|av
index|[
name|n
index|]
operator|.
name|name
operator|.
name|len
operator|&&
name|ngx_strncmp
argument_list|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|av
index|[
name|n
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
index|[
name|i
index|]
operator|.
name|handler
operator|=
name|av
index|[
name|n
index|]
operator|.
name|handler
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|data
operator|=
name|av
index|[
name|n
index|]
operator|.
name|data
expr_stmt|;
name|av
index|[
name|n
index|]
operator|.
name|flags
operator||=
name|NGX_HTTP_VAR_INDEXED
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|flags
operator|=
name|av
index|[
name|n
index|]
operator|.
name|flags
expr_stmt|;
name|av
index|[
name|n
index|]
operator|.
name|index
operator|=
name|i
expr_stmt|;
goto|goto
name|next
goto|;
block|}
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|v
index|[
name|i
index|]
operator|.
name|name
operator|.
name|data
argument_list|,
literal|"http_"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|v
index|[
name|i
index|]
operator|.
name|handler
operator|=
name|ngx_http_variable_unknown_header
expr_stmt|;
name|v
index|[
name|i
index|]
operator|.
name|data
operator|=
operator|(
name|uintptr_t
operator|)
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
continue|continue;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"unknown \"%V\" variable"
argument_list|,
operator|&
name|v
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
name|next
label|:
continue|continue;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http variables: %ui"
argument_list|,
name|cmcf
operator|->
name|variables
operator|.
name|nelts
argument_list|)
expr_stmt|;
comment|/* init the all http variables hash */
name|cmcf
operator|->
name|variables_hash
operator|.
name|max_size
operator|=
literal|500
expr_stmt|;
name|cmcf
operator|->
name|variables_hash
operator|.
name|bucket_limit
operator|=
literal|1
expr_stmt|;
name|cmcf
operator|->
name|variables_hash
operator|.
name|bucket_size
operator|=
sizeof|sizeof
argument_list|(
name|ngx_http_variable_t
argument_list|)
expr_stmt|;
name|cmcf
operator|->
name|variables_hash
operator|.
name|name
operator|=
literal|"http variables"
expr_stmt|;
if|if
condition|(
name|ngx_hash_init
argument_list|(
operator|&
name|cmcf
operator|->
name|variables_hash
argument_list|,
name|cf
operator|->
name|pool
argument_list|,
name|cmcf
operator|->
name|all_variables
operator|.
name|elts
argument_list|,
name|cmcf
operator|->
name|all_variables
operator|.
name|nelts
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|cf
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http variables hash size: %ui for %ui values, "
literal|"max buckets per entry: %ui"
argument_list|,
name|cmcf
operator|->
name|variables_hash
operator|.
name|hash_size
argument_list|,
name|cmcf
operator|->
name|all_variables
operator|.
name|nelts
argument_list|,
name|cmcf
operator|->
name|variables_hash
operator|.
name|min_buckets
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

end_unit

