begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_http.h>
end_include

begin_include
include|#
directive|include
file|<ngx_md5.h>
end_include

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_read
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_cache_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ssize_t
name|ngx_http_file_cache_aio_read
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_cache_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_FILE_AIO
operator|)
end_if

begin_function_decl
specifier|static
name|void
name|ngx_http_cache_aio_event_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_exists
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|,
name|ngx_http_cache_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_name
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_path_t
modifier|*
name|path
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_http_file_cache_node_t
modifier|*
name|ngx_http_file_cache_lookup
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|,
name|u_char
modifier|*
name|key
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_file_cache_rbtree_insert_value
parameter_list|(
name|ngx_rbtree_node_t
modifier|*
name|temp
parameter_list|,
name|ngx_rbtree_node_t
modifier|*
name|node
parameter_list|,
name|ngx_rbtree_node_t
modifier|*
name|sentinel
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_file_cache_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|time_t
name|ngx_http_file_cache_forced_expire
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|time_t
name|ngx_http_file_cache_expire
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ngx_http_file_cache_delete
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|,
name|ngx_queue_t
modifier|*
name|q
parameter_list|,
name|u_char
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_manager_sleep
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_noop
parameter_list|(
name|ngx_tree_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_str_t
modifier|*
name|path
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_manage_file
parameter_list|(
name|ngx_tree_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_str_t
modifier|*
name|path
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_add_file
parameter_list|(
name|ngx_tree_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_str_t
modifier|*
name|path
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_add
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|,
name|ngx_http_cache_t
modifier|*
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|ngx_int_t
name|ngx_http_file_cache_delete_file
parameter_list|(
name|ngx_tree_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_str_t
modifier|*
name|path
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
DECL|variable|ngx_http_cache_status
name|ngx_str_t
name|ngx_http_cache_status
index|[]
init|=
block|{
name|ngx_string
argument_list|(
literal|"MISS"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"BYPASS"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"EXPIRED"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"STALE"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"UPDATING"
argument_list|)
block|,
name|ngx_string
argument_list|(
literal|"HIT"
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
DECL|variable|ngx_http_file_cache_key
specifier|static
name|u_char
name|ngx_http_file_cache_key
index|[]
init|=
block|{
name|LF
block|,
literal|'K'
block|,
literal|'E'
block|,
literal|'Y'
block|,
literal|':'
block|,
literal|' '
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_init (ngx_shm_zone_t * shm_zone,void * data)
name|ngx_http_file_cache_init
parameter_list|(
name|ngx_shm_zone_t
modifier|*
name|shm_zone
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_file_cache_t
modifier|*
name|ocache
init|=
name|data
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_uint_t
name|n
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|cache
operator|=
name|shm_zone
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|ocache
condition|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|cache
operator|->
name|path
operator|->
name|name
operator|.
name|data
argument_list|,
name|ocache
operator|->
name|path
operator|->
name|name
operator|.
name|data
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|shm_zone
operator|->
name|shm
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"cache \"%V\" uses the \"%V\" cache path "
literal|"while previously it used the \"%V\" cache path"
argument_list|,
operator|&
name|shm_zone
operator|->
name|shm
operator|.
name|name
argument_list|,
operator|&
name|cache
operator|->
name|path
operator|->
name|name
argument_list|,
operator|&
name|ocache
operator|->
name|path
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|3
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
name|cache
operator|->
name|path
operator|->
name|level
index|[
name|n
index|]
operator|!=
name|ocache
operator|->
name|path
operator|->
name|level
index|[
name|n
index|]
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|shm_zone
operator|->
name|shm
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"cache \"%V\" had previously different levels"
argument_list|,
operator|&
name|shm_zone
operator|->
name|shm
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
name|cache
operator|->
name|sh
operator|=
name|ocache
operator|->
name|sh
expr_stmt|;
name|cache
operator|->
name|shpool
operator|=
name|ocache
operator|->
name|shpool
expr_stmt|;
name|cache
operator|->
name|bsize
operator|=
name|ocache
operator|->
name|bsize
expr_stmt|;
name|cache
operator|->
name|max_size
operator|/=
name|cache
operator|->
name|bsize
expr_stmt|;
if|if
condition|(
operator|!
name|cache
operator|->
name|sh
operator|->
name|cold
operator|||
name|cache
operator|->
name|sh
operator|->
name|loading
condition|)
block|{
name|cache
operator|->
name|path
operator|->
name|loader
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
name|cache
operator|->
name|shpool
operator|=
operator|(
name|ngx_slab_pool_t
operator|*
operator|)
name|shm_zone
operator|->
name|shm
operator|.
name|addr
expr_stmt|;
if|if
condition|(
name|shm_zone
operator|->
name|shm
operator|.
name|exists
condition|)
block|{
name|cache
operator|->
name|sh
operator|=
name|cache
operator|->
name|shpool
operator|->
name|data
expr_stmt|;
name|cache
operator|->
name|bsize
operator|=
name|ngx_fs_bsize
argument_list|(
name|cache
operator|->
name|path
operator|->
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
name|cache
operator|->
name|sh
operator|=
name|ngx_slab_alloc
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_sh_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|sh
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cache
operator|->
name|shpool
operator|->
name|data
operator|=
name|cache
operator|->
name|sh
expr_stmt|;
name|ngx_rbtree_init
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|rbtree
argument_list|,
operator|&
name|cache
operator|->
name|sh
operator|->
name|sentinel
argument_list|,
name|ngx_http_file_cache_rbtree_insert_value
argument_list|)
expr_stmt|;
name|ngx_queue_init
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|queue
argument_list|)
expr_stmt|;
name|cache
operator|->
name|sh
operator|->
name|cold
operator|=
literal|1
expr_stmt|;
name|cache
operator|->
name|sh
operator|->
name|loading
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|sh
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|bsize
operator|=
name|ngx_fs_bsize
argument_list|(
name|cache
operator|->
name|path
operator|->
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
name|cache
operator|->
name|max_size
operator|/=
name|cache
operator|->
name|bsize
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
literal|" in cache keys zone \"\""
argument_list|)
operator|+
name|shm_zone
operator|->
name|shm
operator|.
name|name
operator|.
name|len
expr_stmt|;
name|cache
operator|->
name|shpool
operator|->
name|log_ctx
operator|=
name|ngx_slab_alloc
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|shpool
operator|->
name|log_ctx
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_sprintf
argument_list|(
name|cache
operator|->
name|shpool
operator|->
name|log_ctx
argument_list|,
literal|" in cache keys zone \"%V\"%Z"
argument_list|,
operator|&
name|shm_zone
operator|->
name|shm
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_file_cache_new (ngx_http_request_t * r)
name|ngx_http_file_cache_new
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_cache_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_array_init
argument_list|(
operator|&
name|c
operator|->
name|keys
argument_list|,
name|r
operator|->
name|pool
argument_list|,
literal|4
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_str_t
argument_list|)
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|r
operator|->
name|cache
operator|=
name|c
expr_stmt|;
name|c
operator|->
name|file
operator|.
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_file_cache_create (ngx_http_request_t * r)
name|ngx_http_file_cache_create
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|ngx_http_file_cache_create_key
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
name|cache
operator|=
name|c
operator|->
name|file_cache
expr_stmt|;
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|r
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_http_file_cache_exists
argument_list|(
name|cache
argument_list|,
name|c
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_file_cache_cleanup
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|ngx_http_file_cache_name
argument_list|(
name|r
argument_list|,
name|cache
operator|->
name|path
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_file_cache_create_key (ngx_http_request_t * r)
name|ngx_http_file_cache_create_key
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|ngx_str_t
modifier|*
name|key
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_md5_t
name|md5
decl_stmt|;
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
name|ngx_crc32_init
argument_list|(
name|c
operator|->
name|crc32
argument_list|)
expr_stmt|;
name|ngx_md5_init
argument_list|(
operator|&
name|md5
argument_list|)
expr_stmt|;
name|key
operator|=
name|c
operator|->
name|keys
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
operator|->
name|keys
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http cache key: \"%V\""
argument_list|,
operator|&
name|key
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|len
operator|+=
name|key
index|[
name|i
index|]
operator|.
name|len
expr_stmt|;
name|ngx_crc32_update
argument_list|(
operator|&
name|c
operator|->
name|crc32
argument_list|,
name|key
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|key
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
name|ngx_md5_update
argument_list|(
operator|&
name|md5
argument_list|,
name|key
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|key
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
name|c
operator|->
name|header_start
operator|=
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_header_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_key
argument_list|)
operator|+
name|len
operator|+
literal|1
expr_stmt|;
name|ngx_crc32_final
argument_list|(
name|c
operator|->
name|crc32
argument_list|)
expr_stmt|;
name|ngx_md5_final
argument_list|(
name|c
operator|->
name|key
argument_list|,
operator|&
name|md5
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_file_cache_open (ngx_http_request_t * r)
name|ngx_http_file_cache_open
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|,
name|rv
decl_stmt|;
name|ngx_uint_t
name|cold
decl_stmt|,
name|test
decl_stmt|;
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|ngx_pool_cleanup_t
modifier|*
name|cln
decl_stmt|;
name|ngx_open_file_info_t
name|of
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|buf
condition|)
block|{
return|return
name|ngx_http_file_cache_read
argument_list|(
name|r
argument_list|,
name|c
argument_list|)
return|;
block|}
name|cache
operator|=
name|c
operator|->
name|file_cache
expr_stmt|;
name|cln
operator|=
name|ngx_pool_cleanup_add
argument_list|(
name|r
operator|->
name|pool
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cln
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|rc
operator|=
name|ngx_http_file_cache_exists
argument_list|(
name|cache
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache exists: %i e:%d"
argument_list|,
name|rc
argument_list|,
name|c
operator|->
name|exists
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|rc
return|;
block|}
name|cln
operator|->
name|handler
operator|=
name|ngx_http_file_cache_cleanup
expr_stmt|;
name|cln
operator|->
name|data
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return
name|NGX_HTTP_CACHE_SCARCE
return|;
block|}
name|cold
operator|=
name|cache
operator|->
name|sh
operator|->
name|cold
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|error
condition|)
block|{
return|return
name|c
operator|->
name|error
return|;
block|}
name|c
operator|->
name|temp_file
operator|=
literal|1
expr_stmt|;
name|test
operator|=
name|c
operator|->
name|exists
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rv
operator|=
name|NGX_DECLINED
expr_stmt|;
block|}
else|else
block|{
comment|/* rc == NGX_DECLINED */
if|if
condition|(
name|c
operator|->
name|min_uses
operator|>
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|cold
condition|)
block|{
return|return
name|NGX_HTTP_CACHE_SCARCE
return|;
block|}
name|test
operator|=
literal|1
expr_stmt|;
name|rv
operator|=
name|NGX_HTTP_CACHE_SCARCE
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|temp_file
operator|=
literal|1
expr_stmt|;
name|test
operator|=
name|cold
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rv
operator|=
name|NGX_DECLINED
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ngx_http_file_cache_name
argument_list|(
name|r
argument_list|,
name|cache
operator|->
name|path
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
operator|!
name|test
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
name|ngx_memzero
argument_list|(
operator|&
name|of
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_open_file_info_t
argument_list|)
argument_list|)
expr_stmt|;
name|of
operator|.
name|uniq
operator|=
name|c
operator|->
name|uniq
expr_stmt|;
name|of
operator|.
name|valid
operator|=
name|clcf
operator|->
name|open_file_cache_valid
expr_stmt|;
name|of
operator|.
name|min_uses
operator|=
name|clcf
operator|->
name|open_file_cache_min_uses
expr_stmt|;
name|of
operator|.
name|events
operator|=
name|clcf
operator|->
name|open_file_cache_events
expr_stmt|;
name|of
operator|.
name|directio
operator|=
name|NGX_OPEN_FILE_DIRECTIO_OFF
expr_stmt|;
name|of
operator|.
name|read_ahead
operator|=
name|clcf
operator|->
name|read_ahead
expr_stmt|;
if|if
condition|(
name|ngx_open_cached_file
argument_list|(
name|clcf
operator|->
name|open_file_cache
argument_list|,
operator|&
name|c
operator|->
name|file
operator|.
name|name
argument_list|,
operator|&
name|of
argument_list|,
name|r
operator|->
name|pool
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
switch|switch
condition|(
name|of
operator|.
name|err
condition|)
block|{
case|case
literal|0
case|:
return|return
name|NGX_ERROR
return|;
case|case
name|NGX_ENOENT
case|:
case|case
name|NGX_ENOTDIR
case|:
return|return
name|rv
return|;
default|default:
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|of
operator|.
name|err
argument_list|,
name|ngx_open_file_n
literal|" \"%s\" failed"
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache fd: %d"
argument_list|,
name|of
operator|.
name|fd
argument_list|)
expr_stmt|;
name|c
operator|->
name|file
operator|.
name|fd
operator|=
name|of
operator|.
name|fd
expr_stmt|;
name|c
operator|->
name|file
operator|.
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
name|c
operator|->
name|uniq
operator|=
name|of
operator|.
name|uniq
expr_stmt|;
name|c
operator|->
name|length
operator|=
name|of
operator|.
name|size
expr_stmt|;
name|c
operator|->
name|buf
operator|=
name|ngx_create_temp_buf
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|c
operator|->
name|body_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
return|return
name|ngx_http_file_cache_read
argument_list|(
name|r
argument_list|,
name|c
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_read (ngx_http_request_t * r,ngx_http_cache_t * c)
name|ngx_http_file_cache_read
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_cache_t
modifier|*
name|c
parameter_list|)
block|{
name|time_t
name|now
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|ngx_http_file_cache_header_t
modifier|*
name|h
decl_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
name|n
operator|=
name|ngx_http_file_cache_aio_read
argument_list|(
name|r
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
block|{
return|return
name|n
return|;
block|}
if|if
condition|(
operator|(
name|size_t
operator|)
name|n
operator|<
name|c
operator|->
name|header_start
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cache file \"%s\" is too small"
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|h
operator|=
operator|(
name|ngx_http_file_cache_header_t
operator|*
operator|)
name|c
operator|->
name|buf
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|h
operator|->
name|crc32
operator|!=
name|c
operator|->
name|crc32
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cache file \"%s\" has md5 collision"
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_DECLINED
return|;
block|}
name|c
operator|->
name|buf
operator|->
name|last
operator|+=
name|n
expr_stmt|;
name|c
operator|->
name|valid_sec
operator|=
name|h
operator|->
name|valid_sec
expr_stmt|;
name|c
operator|->
name|last_modified
operator|=
name|h
operator|->
name|last_modified
expr_stmt|;
name|c
operator|->
name|date
operator|=
name|h
operator|->
name|date
expr_stmt|;
name|c
operator|->
name|valid_msec
operator|=
name|h
operator|->
name|valid_msec
expr_stmt|;
name|c
operator|->
name|header_start
operator|=
name|h
operator|->
name|header_start
expr_stmt|;
name|c
operator|->
name|body_start
operator|=
name|h
operator|->
name|body_start
expr_stmt|;
name|r
operator|->
name|cached
operator|=
literal|1
expr_stmt|;
name|cache
operator|=
name|c
operator|->
name|file_cache
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|sh
operator|->
name|cold
condition|)
block|{
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|->
name|node
operator|->
name|exists
condition|)
block|{
name|c
operator|->
name|node
operator|->
name|uses
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|node
operator|->
name|body_start
operator|=
name|c
operator|->
name|body_start
expr_stmt|;
name|c
operator|->
name|node
operator|->
name|exists
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|node
operator|->
name|uniq
operator|=
name|c
operator|->
name|uniq
expr_stmt|;
name|cache
operator|->
name|sh
operator|->
name|size
operator|+=
operator|(
name|c
operator|->
name|length
operator|+
name|cache
operator|->
name|bsize
operator|-
literal|1
operator|)
operator|/
name|cache
operator|->
name|bsize
expr_stmt|;
block|}
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
name|now
operator|=
name|ngx_time
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|valid_sec
operator|<
name|now
condition|)
block|{
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|node
operator|->
name|updating
condition|)
block|{
name|rc
operator|=
name|NGX_HTTP_CACHE_UPDATING
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|node
operator|->
name|updating
operator|=
literal|1
expr_stmt|;
name|rc
operator|=
name|NGX_HTTP_CACHE_STALE
expr_stmt|;
block|}
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|ngx_log_debug3
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache expired: %i %T %T"
argument_list|,
name|rc
argument_list|,
name|c
operator|->
name|valid_sec
argument_list|,
name|now
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ssize_t
DECL|function|ngx_http_file_cache_aio_read (ngx_http_request_t * r,ngx_http_cache_t * c)
name|ngx_http_file_cache_aio_read
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_http_cache_t
modifier|*
name|c
parameter_list|)
block|{
if|#
directive|if
operator|(
name|NGX_HAVE_FILE_AIO
operator|)
name|ssize_t
name|n
decl_stmt|;
name|ngx_http_core_loc_conf_t
modifier|*
name|clcf
decl_stmt|;
if|if
condition|(
operator|!
name|ngx_file_aio
condition|)
block|{
goto|goto
name|noaio
goto|;
block|}
name|clcf
operator|=
name|ngx_http_get_module_loc_conf
argument_list|(
name|r
argument_list|,
name|ngx_http_core_module
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|clcf
operator|->
name|aio
condition|)
block|{
goto|goto
name|noaio
goto|;
block|}
name|n
operator|=
name|ngx_file_aio_read
argument_list|(
operator|&
name|c
operator|->
name|file
argument_list|,
name|c
operator|->
name|buf
operator|->
name|pos
argument_list|,
name|c
operator|->
name|body_start
argument_list|,
literal|0
argument_list|,
name|r
operator|->
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|NGX_AGAIN
condition|)
block|{
return|return
name|n
return|;
block|}
name|c
operator|->
name|file
operator|.
name|aio
operator|->
name|data
operator|=
name|r
expr_stmt|;
name|c
operator|->
name|file
operator|.
name|aio
operator|->
name|handler
operator|=
name|ngx_http_cache_aio_event_handler
expr_stmt|;
name|r
operator|->
expr|main
operator|->
name|blocked
operator|++
expr_stmt|;
name|r
operator|->
name|aio
operator|=
literal|1
expr_stmt|;
return|return
name|NGX_AGAIN
return|;
name|noaio
label|:
endif|#
directive|endif
return|return
name|ngx_read_file
argument_list|(
operator|&
name|c
operator|->
name|file
argument_list|,
name|c
operator|->
name|buf
operator|->
name|pos
argument_list|,
name|c
operator|->
name|body_start
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|NGX_HAVE_FILE_AIO
operator|)
end_if

begin_function
specifier|static
name|void
DECL|function|ngx_http_cache_aio_event_handler (ngx_event_t * ev)
name|ngx_http_cache_aio_event_handler
parameter_list|(
name|ngx_event_t
modifier|*
name|ev
parameter_list|)
block|{
name|ngx_event_aio_t
modifier|*
name|aio
decl_stmt|;
name|ngx_http_request_t
modifier|*
name|r
decl_stmt|;
name|aio
operator|=
name|ev
operator|->
name|data
expr_stmt|;
name|r
operator|=
name|aio
operator|->
name|data
expr_stmt|;
name|r
operator|->
expr|main
operator|->
name|blocked
operator|--
expr_stmt|;
name|r
operator|->
name|aio
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|connection
operator|->
name|write
operator|->
name|handler
argument_list|(
name|r
operator|->
name|connection
operator|->
name|write
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_exists (ngx_http_file_cache_t * cache,ngx_http_cache_t * c)
name|ngx_http_file_cache_exists
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|,
name|ngx_http_cache_t
modifier|*
name|c
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_http_file_cache_node_t
modifier|*
name|fcn
decl_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|fcn
operator|=
name|ngx_http_file_cache_lookup
argument_list|(
name|cache
argument_list|,
name|c
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcn
condition|)
block|{
name|ngx_queue_remove
argument_list|(
operator|&
name|fcn
operator|->
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcn
operator|->
name|error
condition|)
block|{
if|if
condition|(
name|fcn
operator|->
name|valid_sec
operator|<
name|ngx_time
argument_list|()
condition|)
block|{
goto|goto
name|renew
goto|;
block|}
name|rc
operator|=
name|NGX_OK
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|fcn
operator|->
name|uses
operator|++
expr_stmt|;
name|fcn
operator|->
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|fcn
operator|->
name|exists
condition|)
block|{
name|c
operator|->
name|exists
operator|=
name|fcn
operator|->
name|exists
expr_stmt|;
name|c
operator|->
name|body_start
operator|=
name|fcn
operator|->
name|body_start
expr_stmt|;
name|rc
operator|=
name|NGX_OK
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|fcn
operator|->
name|uses
operator|>=
name|c
operator|->
name|min_uses
condition|)
block|{
name|c
operator|->
name|exists
operator|=
name|fcn
operator|->
name|exists
expr_stmt|;
name|c
operator|->
name|body_start
operator|=
name|fcn
operator|->
name|body_start
expr_stmt|;
name|rc
operator|=
name|NGX_OK
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|=
name|NGX_AGAIN
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
name|fcn
operator|=
name|ngx_slab_alloc_locked
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_node_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcn
operator|==
name|NULL
condition|)
block|{
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_http_file_cache_forced_expire
argument_list|(
name|cache
argument_list|)
expr_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|fcn
operator|=
name|ngx_slab_alloc_locked
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_node_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcn
operator|==
name|NULL
condition|)
block|{
name|rc
operator|=
name|NGX_ERROR
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
name|ngx_memcpy
argument_list|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|fcn
operator|->
name|node
operator|.
name|key
argument_list|,
name|c
operator|->
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|fcn
operator|->
name|key
argument_list|,
operator|&
name|c
operator|->
name|key
index|[
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
index|]
argument_list|,
name|NGX_HTTP_CACHE_KEY_LEN
operator|-
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_rbtree_insert
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|rbtree
argument_list|,
operator|&
name|fcn
operator|->
name|node
argument_list|)
expr_stmt|;
name|renew
label|:
name|rc
operator|=
name|NGX_DECLINED
expr_stmt|;
name|fcn
operator|->
name|uses
operator|=
literal|1
expr_stmt|;
name|fcn
operator|->
name|count
operator|=
literal|1
expr_stmt|;
name|fcn
operator|->
name|valid_msec
operator|=
literal|0
expr_stmt|;
name|fcn
operator|->
name|error
operator|=
literal|0
expr_stmt|;
name|fcn
operator|->
name|exists
operator|=
literal|0
expr_stmt|;
name|fcn
operator|->
name|valid_sec
operator|=
literal|0
expr_stmt|;
name|fcn
operator|->
name|uniq
operator|=
literal|0
expr_stmt|;
name|fcn
operator|->
name|body_start
operator|=
literal|0
expr_stmt|;
name|fcn
operator|->
name|length
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|fcn
operator|->
name|expire
operator|=
name|ngx_time
argument_list|()
operator|+
name|cache
operator|->
name|inactive
expr_stmt|;
name|ngx_queue_insert_head
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|queue
argument_list|,
operator|&
name|fcn
operator|->
name|queue
argument_list|)
expr_stmt|;
name|c
operator|->
name|uniq
operator|=
name|fcn
operator|->
name|uniq
expr_stmt|;
name|c
operator|->
name|error
operator|=
name|fcn
operator|->
name|error
expr_stmt|;
name|c
operator|->
name|node
operator|=
name|fcn
expr_stmt|;
name|failed
label|:
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_name (ngx_http_request_t * r,ngx_path_t * path)
name|ngx_http_file_cache_name
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_path_t
modifier|*
name|path
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|len
operator|=
name|path
operator|->
name|name
operator|.
name|len
operator|+
literal|1
operator|+
name|path
operator|->
name|len
operator|+
literal|2
operator|*
name|NGX_HTTP_CACHE_KEY_LEN
expr_stmt|;
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
operator|=
name|ngx_pnalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|,
name|path
operator|->
name|name
operator|.
name|data
argument_list|,
name|path
operator|->
name|name
operator|.
name|len
argument_list|)
expr_stmt|;
name|p
operator|=
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
operator|+
name|path
operator|->
name|name
operator|.
name|len
operator|+
literal|1
operator|+
name|path
operator|->
name|len
expr_stmt|;
name|p
operator|=
name|ngx_hex_dump
argument_list|(
name|p
argument_list|,
name|c
operator|->
name|key
argument_list|,
name|NGX_HTTP_CACHE_KEY_LEN
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|ngx_create_hashed_filename
argument_list|(
name|path
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|len
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cache file: \"%s\""
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_http_file_cache_node_t
modifier|*
DECL|function|ngx_http_file_cache_lookup (ngx_http_file_cache_t * cache,u_char * key)
name|ngx_http_file_cache_lookup
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|,
name|u_char
modifier|*
name|key
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_rbtree_key_t
name|node_key
decl_stmt|;
name|ngx_rbtree_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|sentinel
decl_stmt|;
name|ngx_http_file_cache_node_t
modifier|*
name|fcn
decl_stmt|;
name|ngx_memcpy
argument_list|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|node_key
argument_list|,
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
expr_stmt|;
name|node
operator|=
name|cache
operator|->
name|sh
operator|->
name|rbtree
operator|.
name|root
expr_stmt|;
name|sentinel
operator|=
name|cache
operator|->
name|sh
operator|->
name|rbtree
operator|.
name|sentinel
expr_stmt|;
while|while
condition|(
name|node
operator|!=
name|sentinel
condition|)
block|{
if|if
condition|(
name|node_key
operator|<
name|node
operator|->
name|key
condition|)
block|{
name|node
operator|=
name|node
operator|->
name|left
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|node_key
operator|>
name|node
operator|->
name|key
condition|)
block|{
name|node
operator|=
name|node
operator|->
name|right
expr_stmt|;
continue|continue;
block|}
comment|/* node_key == node->key */
do|do
block|{
name|fcn
operator|=
operator|(
name|ngx_http_file_cache_node_t
operator|*
operator|)
name|node
expr_stmt|;
name|rc
operator|=
name|ngx_memcmp
argument_list|(
operator|&
name|key
index|[
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
index|]
argument_list|,
name|fcn
operator|->
name|key
argument_list|,
name|NGX_HTTP_CACHE_KEY_LEN
operator|-
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
block|{
return|return
name|fcn
return|;
block|}
name|node
operator|=
operator|(
name|rc
operator|<
literal|0
operator|)
condition|?
name|node
operator|->
name|left
else|:
name|node
operator|->
name|right
expr_stmt|;
block|}
do|while
condition|(
name|node
operator|!=
name|sentinel
operator|&&
name|node_key
operator|==
name|node
operator|->
name|key
condition|)
do|;
break|break;
block|}
comment|/* not found */
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_file_cache_rbtree_insert_value (ngx_rbtree_node_t * temp,ngx_rbtree_node_t * node,ngx_rbtree_node_t * sentinel)
name|ngx_http_file_cache_rbtree_insert_value
parameter_list|(
name|ngx_rbtree_node_t
modifier|*
name|temp
parameter_list|,
name|ngx_rbtree_node_t
modifier|*
name|node
parameter_list|,
name|ngx_rbtree_node_t
modifier|*
name|sentinel
parameter_list|)
block|{
name|ngx_rbtree_node_t
modifier|*
modifier|*
name|p
decl_stmt|;
name|ngx_http_file_cache_node_t
modifier|*
name|cn
decl_stmt|,
modifier|*
name|cnt
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|node
operator|->
name|key
operator|<
name|temp
operator|->
name|key
condition|)
block|{
name|p
operator|=
operator|&
name|temp
operator|->
name|left
expr_stmt|;
block|}
if|else if
condition|(
name|node
operator|->
name|key
operator|>
name|temp
operator|->
name|key
condition|)
block|{
name|p
operator|=
operator|&
name|temp
operator|->
name|right
expr_stmt|;
block|}
else|else
block|{
comment|/* node->key == temp->key */
name|cn
operator|=
operator|(
name|ngx_http_file_cache_node_t
operator|*
operator|)
name|node
expr_stmt|;
name|cnt
operator|=
operator|(
name|ngx_http_file_cache_node_t
operator|*
operator|)
name|temp
expr_stmt|;
name|p
operator|=
operator|(
name|ngx_memcmp
argument_list|(
name|cn
operator|->
name|key
argument_list|,
name|cnt
operator|->
name|key
argument_list|,
name|NGX_HTTP_CACHE_KEY_LEN
operator|-
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
operator|<
literal|0
operator|)
condition|?
operator|&
name|temp
operator|->
name|left
else|:
operator|&
name|temp
operator|->
name|right
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|==
name|sentinel
condition|)
block|{
break|break;
block|}
name|temp
operator|=
operator|*
name|p
expr_stmt|;
block|}
operator|*
name|p
operator|=
name|node
expr_stmt|;
name|node
operator|->
name|parent
operator|=
name|temp
expr_stmt|;
name|node
operator|->
name|left
operator|=
name|sentinel
expr_stmt|;
name|node
operator|->
name|right
operator|=
name|sentinel
expr_stmt|;
name|ngx_rbt_red
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_file_cache_set_header (ngx_http_request_t * r,u_char * buf)
name|ngx_http_file_cache_set_header
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|)
block|{
name|ngx_http_file_cache_header_t
modifier|*
name|h
init|=
operator|(
name|ngx_http_file_cache_header_t
operator|*
operator|)
name|buf
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_str_t
modifier|*
name|key
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache set header"
argument_list|)
expr_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
name|h
operator|->
name|valid_sec
operator|=
name|c
operator|->
name|valid_sec
expr_stmt|;
name|h
operator|->
name|last_modified
operator|=
name|c
operator|->
name|last_modified
expr_stmt|;
name|h
operator|->
name|date
operator|=
name|c
operator|->
name|date
expr_stmt|;
name|h
operator|->
name|crc32
operator|=
name|c
operator|->
name|crc32
expr_stmt|;
name|h
operator|->
name|valid_msec
operator|=
operator|(
name|u_short
operator|)
name|c
operator|->
name|valid_msec
expr_stmt|;
name|h
operator|->
name|header_start
operator|=
operator|(
name|u_short
operator|)
name|c
operator|->
name|header_start
expr_stmt|;
name|h
operator|->
name|body_start
operator|=
operator|(
name|u_short
operator|)
name|c
operator|->
name|body_start
expr_stmt|;
name|p
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_header_t
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_cpymem
argument_list|(
name|p
argument_list|,
name|ngx_http_file_cache_key
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_key
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|=
name|c
operator|->
name|keys
operator|.
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
operator|->
name|keys
operator|.
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|p
operator|=
name|ngx_copy
argument_list|(
name|p
argument_list|,
name|key
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|key
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
operator|*
name|p
operator|=
name|LF
expr_stmt|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_file_cache_update (ngx_http_request_t * r,ngx_temp_file_t * tf)
name|ngx_http_file_cache_update
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_temp_file_t
modifier|*
name|tf
parameter_list|)
block|{
name|off_t
name|size
decl_stmt|,
name|length
decl_stmt|;
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_file_uniq_t
name|uniq
decl_stmt|;
name|ngx_file_info_t
name|fi
decl_stmt|;
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|ngx_ext_rename_file_t
name|ext
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|updated
condition|)
block|{
return|return;
block|}
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache update"
argument_list|)
expr_stmt|;
name|c
operator|->
name|updated
operator|=
literal|1
expr_stmt|;
name|cache
operator|=
name|c
operator|->
name|file_cache
expr_stmt|;
name|uniq
operator|=
literal|0
expr_stmt|;
name|length
operator|=
literal|0
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache rename: \"%s\" to \"%s\""
argument_list|,
name|tf
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
name|ext
operator|.
name|access
operator|=
name|NGX_FILE_OWNER_ACCESS
expr_stmt|;
name|ext
operator|.
name|path_access
operator|=
name|NGX_FILE_OWNER_ACCESS
expr_stmt|;
name|ext
operator|.
name|time
operator|=
operator|-
literal|1
expr_stmt|;
name|ext
operator|.
name|create_path
operator|=
literal|1
expr_stmt|;
name|ext
operator|.
name|delete_file
operator|=
literal|1
expr_stmt|;
name|ext
operator|.
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
name|rc
operator|=
name|ngx_ext_rename_file
argument_list|(
operator|&
name|tf
operator|->
name|file
operator|.
name|name
argument_list|,
operator|&
name|c
operator|->
name|file
operator|.
name|name
argument_list|,
operator|&
name|ext
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
if|if
condition|(
name|ngx_fd_info
argument_list|(
name|tf
operator|->
name|file
operator|.
name|fd
argument_list|,
operator|&
name|fi
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_fd_info_n
literal|" \"%s\" failed"
argument_list|,
name|tf
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
name|rc
operator|=
name|NGX_ERROR
expr_stmt|;
block|}
else|else
block|{
name|uniq
operator|=
name|ngx_file_uniq
argument_list|(
operator|&
name|fi
argument_list|)
expr_stmt|;
name|length
operator|=
name|ngx_file_size
argument_list|(
operator|&
name|fi
argument_list|)
expr_stmt|;
block|}
block|}
name|size
operator|=
operator|(
name|length
operator|+
name|cache
operator|->
name|bsize
operator|-
literal|1
operator|)
operator|/
name|cache
operator|->
name|bsize
expr_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|c
operator|->
name|node
operator|->
name|count
operator|--
expr_stmt|;
name|c
operator|->
name|node
operator|->
name|uniq
operator|=
name|uniq
expr_stmt|;
name|c
operator|->
name|node
operator|->
name|body_start
operator|=
name|c
operator|->
name|body_start
expr_stmt|;
name|size
operator|=
name|size
operator|-
operator|(
name|c
operator|->
name|node
operator|->
name|length
operator|+
name|cache
operator|->
name|bsize
operator|-
literal|1
operator|)
operator|/
name|cache
operator|->
name|bsize
expr_stmt|;
name|c
operator|->
name|node
operator|->
name|length
operator|=
name|length
expr_stmt|;
name|cache
operator|->
name|sh
operator|->
name|size
operator|+=
name|size
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_OK
condition|)
block|{
name|c
operator|->
name|node
operator|->
name|exists
operator|=
literal|1
expr_stmt|;
block|}
name|c
operator|->
name|node
operator|->
name|updating
operator|=
literal|0
expr_stmt|;
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_cache_send (ngx_http_request_t * r)
name|ngx_http_cache_send
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
name|ngx_buf_t
modifier|*
name|b
decl_stmt|;
name|ngx_chain_t
name|out
decl_stmt|;
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache send: %s"
argument_list|,
name|c
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
comment|/* we need to allocate all before the header would be sent */
name|b
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_buf_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
name|b
operator|->
name|file
operator|=
name|ngx_pcalloc
argument_list|(
name|r
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_file_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|->
name|file
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
name|r
operator|->
name|header_only
operator|=
operator|(
name|c
operator|->
name|length
operator|-
name|c
operator|->
name|body_start
operator|)
operator|==
literal|0
expr_stmt|;
name|rc
operator|=
name|ngx_http_send_header
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|>
name|NGX_OK
operator|||
name|r
operator|->
name|header_only
condition|)
block|{
return|return
name|rc
return|;
block|}
name|b
operator|->
name|file_pos
operator|=
name|c
operator|->
name|body_start
expr_stmt|;
name|b
operator|->
name|file_last
operator|=
name|c
operator|->
name|length
expr_stmt|;
name|b
operator|->
name|in_file
operator|=
literal|1
expr_stmt|;
name|b
operator|->
name|last_buf
operator|=
operator|(
name|r
operator|==
name|r
operator|->
expr|main
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|b
operator|->
name|last_in_chain
operator|=
literal|1
expr_stmt|;
name|b
operator|->
name|file
operator|->
name|fd
operator|=
name|c
operator|->
name|file
operator|.
name|fd
expr_stmt|;
name|b
operator|->
name|file
operator|->
name|name
operator|=
name|c
operator|->
name|file
operator|.
name|name
expr_stmt|;
name|b
operator|->
name|file
operator|->
name|log
operator|=
name|r
operator|->
name|connection
operator|->
name|log
expr_stmt|;
name|out
operator|.
name|buf
operator|=
name|b
expr_stmt|;
name|out
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
return|return
name|ngx_http_output_filter
argument_list|(
name|r
argument_list|,
operator|&
name|out
argument_list|)
return|;
block|}
end_function

begin_function
name|void
DECL|function|ngx_http_file_cache_free (ngx_http_request_t * r,ngx_temp_file_t * tf)
name|ngx_http_file_cache_free
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_temp_file_t
modifier|*
name|tf
parameter_list|)
block|{
name|ngx_http_cache_t
modifier|*
name|c
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|ngx_http_file_cache_node_t
modifier|*
name|fcn
decl_stmt|;
name|c
operator|=
name|r
operator|->
name|cache
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|updated
condition|)
block|{
return|return;
block|}
name|c
operator|->
name|updated
operator|=
literal|1
expr_stmt|;
name|cache
operator|=
name|c
operator|->
name|file_cache
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache free"
argument_list|)
expr_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|fcn
operator|=
name|c
operator|->
name|node
expr_stmt|;
name|fcn
operator|->
name|count
operator|--
expr_stmt|;
name|fcn
operator|->
name|updating
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
block|{
name|fcn
operator|->
name|valid_sec
operator|=
name|c
operator|->
name|valid_sec
expr_stmt|;
name|fcn
operator|->
name|valid_msec
operator|=
name|c
operator|->
name|valid_msec
expr_stmt|;
name|fcn
operator|->
name|error
operator|=
name|c
operator|->
name|error
expr_stmt|;
block|}
if|else if
condition|(
name|fcn
operator|->
name|valid_msec
operator|==
literal|0
operator|&&
name|fcn
operator|->
name|count
operator|==
literal|0
condition|)
block|{
name|ngx_queue_remove
argument_list|(
operator|&
name|fcn
operator|->
name|queue
argument_list|)
expr_stmt|;
name|ngx_rbtree_delete
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|rbtree
argument_list|,
operator|&
name|fcn
operator|->
name|node
argument_list|)
expr_stmt|;
name|ngx_slab_free_locked
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
name|fcn
argument_list|)
expr_stmt|;
name|c
operator|->
name|node
operator|=
name|NULL
expr_stmt|;
block|}
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|temp_file
condition|)
block|{
if|if
condition|(
name|tf
operator|&&
name|tf
operator|->
name|file
operator|.
name|fd
operator|!=
name|NGX_INVALID_FILE
condition|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache incomplete: \"%s\""
argument_list|,
name|tf
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_delete_file
argument_list|(
name|tf
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|r
operator|->
name|connection
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_delete_file_n
literal|" \"%s\" failed"
argument_list|,
name|tf
operator|->
name|file
operator|.
name|name
operator|.
name|data
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_file_cache_cleanup (void * data)
name|ngx_http_file_cache_cleanup
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_cache_t
modifier|*
name|c
init|=
name|data
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|updated
condition|)
block|{
return|return;
block|}
name|c
operator|->
name|updated
operator|=
literal|1
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|c
operator|->
name|file
operator|.
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache cleanup"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|error
condition|)
block|{
return|return;
block|}
name|cache
operator|=
name|c
operator|->
name|file_cache
expr_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|c
operator|->
name|node
operator|->
name|count
operator|--
expr_stmt|;
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|time_t
DECL|function|ngx_http_file_cache_forced_expire (ngx_http_file_cache_t * cache)
name|ngx_http_file_cache_forced_expire
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|)
block|{
name|u_char
modifier|*
name|name
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|time_t
name|wait
decl_stmt|;
name|ngx_uint_t
name|tries
decl_stmt|;
name|ngx_path_t
modifier|*
name|path
decl_stmt|;
name|ngx_queue_t
modifier|*
name|q
decl_stmt|;
name|ngx_http_file_cache_node_t
modifier|*
name|fcn
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache forced expire"
argument_list|)
expr_stmt|;
name|path
operator|=
name|cache
operator|->
name|path
expr_stmt|;
name|len
operator|=
name|path
operator|->
name|name
operator|.
name|len
operator|+
literal|1
operator|+
name|path
operator|->
name|len
operator|+
literal|2
operator|*
name|NGX_HTTP_CACHE_KEY_LEN
expr_stmt|;
name|name
operator|=
name|ngx_alloc
argument_list|(
name|len
operator|+
literal|1
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
return|return
literal|10
return|;
block|}
name|ngx_memcpy
argument_list|(
name|name
argument_list|,
name|path
operator|->
name|name
operator|.
name|data
argument_list|,
name|path
operator|->
name|name
operator|.
name|len
argument_list|)
expr_stmt|;
name|wait
operator|=
literal|10
expr_stmt|;
name|tries
operator|=
literal|0
expr_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
for|for
control|(
name|q
operator|=
name|ngx_queue_last
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|queue
argument_list|)
init|;
name|q
operator|!=
name|ngx_queue_sentinel
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|queue
argument_list|)
condition|;
name|q
operator|=
name|ngx_queue_prev
argument_list|(
name|q
argument_list|)
control|)
block|{
name|fcn
operator|=
name|ngx_queue_data
argument_list|(
name|q
argument_list|,
name|ngx_http_file_cache_node_t
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|ngx_log_debug6
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache forced expire: #%d %d %02xd%02xd%02xd%02xd"
argument_list|,
name|fcn
operator|->
name|count
argument_list|,
name|fcn
operator|->
name|exists
argument_list|,
name|fcn
operator|->
name|key
index|[
literal|0
index|]
argument_list|,
name|fcn
operator|->
name|key
index|[
literal|1
index|]
argument_list|,
name|fcn
operator|->
name|key
index|[
literal|2
index|]
argument_list|,
name|fcn
operator|->
name|key
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcn
operator|->
name|count
condition|)
block|{
if|if
condition|(
name|tries
operator|++
operator|<
literal|20
condition|)
block|{
continue|continue;
block|}
name|wait
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|fcn
operator|->
name|exists
condition|)
block|{
name|ngx_queue_remove
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|ngx_rbtree_delete
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|rbtree
argument_list|,
operator|&
name|fcn
operator|->
name|node
argument_list|)
expr_stmt|;
name|ngx_slab_free_locked
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
name|fcn
argument_list|)
expr_stmt|;
break|break;
block|}
name|ngx_http_file_cache_delete
argument_list|(
name|cache
argument_list|,
name|q
argument_list|,
name|name
argument_list|)
expr_stmt|;
break|break;
block|}
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|ngx_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
name|wait
return|;
block|}
end_function

begin_function
specifier|static
name|time_t
DECL|function|ngx_http_file_cache_expire (ngx_http_file_cache_t * cache)
name|ngx_http_file_cache_expire
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|)
block|{
name|u_char
modifier|*
name|name
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|time_t
name|now
decl_stmt|,
name|wait
decl_stmt|;
name|ngx_path_t
modifier|*
name|path
decl_stmt|;
name|ngx_queue_t
modifier|*
name|q
decl_stmt|;
name|ngx_http_file_cache_node_t
modifier|*
name|fcn
decl_stmt|;
name|u_char
name|key
index|[
literal|2
operator|*
name|NGX_HTTP_CACHE_KEY_LEN
index|]
decl_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache expire"
argument_list|)
expr_stmt|;
name|path
operator|=
name|cache
operator|->
name|path
expr_stmt|;
name|len
operator|=
name|path
operator|->
name|name
operator|.
name|len
operator|+
literal|1
operator|+
name|path
operator|->
name|len
operator|+
literal|2
operator|*
name|NGX_HTTP_CACHE_KEY_LEN
expr_stmt|;
name|name
operator|=
name|ngx_alloc
argument_list|(
name|len
operator|+
literal|1
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
return|return
literal|10
return|;
block|}
name|ngx_memcpy
argument_list|(
name|name
argument_list|,
name|path
operator|->
name|name
operator|.
name|data
argument_list|,
name|path
operator|->
name|name
operator|.
name|len
argument_list|)
expr_stmt|;
name|now
operator|=
name|ngx_time
argument_list|()
expr_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|ngx_queue_empty
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|queue
argument_list|)
condition|)
block|{
name|wait
operator|=
literal|10
expr_stmt|;
break|break;
block|}
name|q
operator|=
name|ngx_queue_last
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|queue
argument_list|)
expr_stmt|;
name|fcn
operator|=
name|ngx_queue_data
argument_list|(
name|q
argument_list|,
name|ngx_http_file_cache_node_t
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|wait
operator|=
name|fcn
operator|->
name|expire
operator|-
name|now
expr_stmt|;
if|if
condition|(
name|wait
operator|>
literal|0
condition|)
block|{
name|wait
operator|=
name|wait
operator|>
literal|10
condition|?
literal|10
else|:
name|wait
expr_stmt|;
break|break;
block|}
name|ngx_log_debug6
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache expire: #%d %d %02xd%02xd%02xd%02xd"
argument_list|,
name|fcn
operator|->
name|count
argument_list|,
name|fcn
operator|->
name|exists
argument_list|,
name|fcn
operator|->
name|key
index|[
literal|0
index|]
argument_list|,
name|fcn
operator|->
name|key
index|[
literal|1
index|]
argument_list|,
name|fcn
operator|->
name|key
index|[
literal|2
index|]
argument_list|,
name|fcn
operator|->
name|key
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcn
operator|->
name|count
condition|)
block|{
name|p
operator|=
name|ngx_hex_dump
argument_list|(
name|key
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|fcn
operator|->
name|node
operator|.
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|NGX_HTTP_CACHE_KEY_LEN
operator|-
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ngx_hex_dump
argument_list|(
name|p
argument_list|,
name|fcn
operator|->
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/*              * abnormally exited workers may leave locked cache entries,              * and although it may be safe to remove them completely,              * we prefer to remove them from inactive queue and rbtree              * only, and to allow other leaks              */
name|ngx_queue_remove
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|ngx_rbtree_delete
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|rbtree
argument_list|,
operator|&
name|fcn
operator|->
name|node
argument_list|)
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"ignore long locked inactive cache entry %*s, count:%d"
argument_list|,
literal|2
operator|*
name|NGX_HTTP_CACHE_KEY_LEN
argument_list|,
name|key
argument_list|,
name|fcn
operator|->
name|count
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|fcn
operator|->
name|exists
condition|)
block|{
name|ngx_queue_remove
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|ngx_rbtree_delete
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|rbtree
argument_list|,
operator|&
name|fcn
operator|->
name|node
argument_list|)
expr_stmt|;
name|ngx_slab_free_locked
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
name|fcn
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ngx_http_file_cache_delete
argument_list|(
name|cache
argument_list|,
name|q
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|ngx_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
return|return
name|wait
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_file_cache_delete (ngx_http_file_cache_t * cache,ngx_queue_t * q,u_char * name)
name|ngx_http_file_cache_delete
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|,
name|ngx_queue_t
modifier|*
name|q
parameter_list|,
name|u_char
modifier|*
name|name
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|ngx_path_t
modifier|*
name|path
decl_stmt|;
name|ngx_http_file_cache_node_t
modifier|*
name|fcn
decl_stmt|;
name|fcn
operator|=
name|ngx_queue_data
argument_list|(
name|q
argument_list|,
name|ngx_http_file_cache_node_t
argument_list|,
name|queue
argument_list|)
expr_stmt|;
name|cache
operator|->
name|sh
operator|->
name|size
operator|-=
operator|(
name|fcn
operator|->
name|length
operator|+
name|cache
operator|->
name|bsize
operator|-
literal|1
operator|)
operator|/
name|cache
operator|->
name|bsize
expr_stmt|;
name|path
operator|=
name|cache
operator|->
name|path
expr_stmt|;
name|p
operator|=
name|name
operator|+
name|path
operator|->
name|name
operator|.
name|len
operator|+
literal|1
operator|+
name|path
operator|->
name|len
expr_stmt|;
name|p
operator|=
name|ngx_hex_dump
argument_list|(
name|p
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|fcn
operator|->
name|node
operator|.
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|NGX_HTTP_CACHE_KEY_LEN
operator|-
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
expr_stmt|;
name|p
operator|=
name|ngx_hex_dump
argument_list|(
name|p
argument_list|,
name|fcn
operator|->
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|ngx_queue_remove
argument_list|(
name|q
argument_list|)
expr_stmt|;
name|ngx_rbtree_delete
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|rbtree
argument_list|,
operator|&
name|fcn
operator|->
name|node
argument_list|)
expr_stmt|;
name|ngx_slab_free_locked
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
name|fcn
argument_list|)
expr_stmt|;
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|len
operator|=
name|path
operator|->
name|name
operator|.
name|len
operator|+
literal|1
operator|+
name|path
operator|->
name|len
operator|+
literal|2
operator|*
name|NGX_HTTP_CACHE_KEY_LEN
expr_stmt|;
name|ngx_create_hashed_filename
argument_list|(
name|path
argument_list|,
name|name
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache expire: \"%s\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_delete_file
argument_list|(
name|name
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_delete_file_n
literal|" \"%s\" failed"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|time_t
DECL|function|ngx_http_file_cache_manager (void * data)
name|ngx_http_file_cache_manager
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_file_cache_t
modifier|*
name|cache
init|=
name|data
decl_stmt|;
name|off_t
name|size
decl_stmt|;
name|time_t
name|next
decl_stmt|;
name|next
operator|=
name|ngx_http_file_cache_expire
argument_list|(
name|cache
argument_list|)
expr_stmt|;
name|cache
operator|->
name|last
operator|=
name|ngx_current_msec
expr_stmt|;
name|cache
operator|->
name|files
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|size
operator|=
name|cache
operator|->
name|sh
operator|->
name|size
expr_stmt|;
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache size: %O"
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|<
name|cache
operator|->
name|max_size
condition|)
block|{
return|return
name|next
return|;
block|}
name|next
operator|=
name|ngx_http_file_cache_forced_expire
argument_list|(
name|cache
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_http_file_cache_manager_sleep
argument_list|(
name|cache
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|next
return|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_http_file_cache_loader (void * data)
name|ngx_http_file_cache_loader
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|ngx_http_file_cache_t
modifier|*
name|cache
init|=
name|data
decl_stmt|;
name|ngx_tree_ctx_t
name|tree
decl_stmt|;
if|if
condition|(
operator|!
name|cache
operator|->
name|sh
operator|->
name|cold
operator|||
name|cache
operator|->
name|sh
operator|->
name|loading
condition|)
block|{
return|return;
block|}
if|if
condition|(
operator|!
name|ngx_atomic_cmp_set
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|loading
argument_list|,
literal|0
argument_list|,
name|ngx_pid
argument_list|)
condition|)
block|{
return|return;
block|}
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache loader"
argument_list|)
expr_stmt|;
name|tree
operator|.
name|init_handler
operator|=
name|NULL
expr_stmt|;
name|tree
operator|.
name|file_handler
operator|=
name|ngx_http_file_cache_manage_file
expr_stmt|;
name|tree
operator|.
name|pre_tree_handler
operator|=
name|ngx_http_file_cache_noop
expr_stmt|;
name|tree
operator|.
name|post_tree_handler
operator|=
name|ngx_http_file_cache_noop
expr_stmt|;
name|tree
operator|.
name|spec_handler
operator|=
name|ngx_http_file_cache_delete_file
expr_stmt|;
name|tree
operator|.
name|data
operator|=
name|cache
expr_stmt|;
name|tree
operator|.
name|alloc
operator|=
literal|0
expr_stmt|;
name|tree
operator|.
name|log
operator|=
name|ngx_cycle
operator|->
name|log
expr_stmt|;
name|cache
operator|->
name|last
operator|=
name|ngx_current_msec
expr_stmt|;
name|cache
operator|->
name|files
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ngx_walk_tree
argument_list|(
operator|&
name|tree
argument_list|,
operator|&
name|cache
operator|->
name|path
operator|->
name|name
argument_list|)
operator|==
name|NGX_ABORT
condition|)
block|{
name|cache
operator|->
name|sh
operator|->
name|loading
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|cache
operator|->
name|sh
operator|->
name|cold
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|sh
operator|->
name|loading
operator|=
literal|0
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_NOTICE
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache: %V %.3fM, bsize: %uz"
argument_list|,
operator|&
name|cache
operator|->
name|path
operator|->
name|name
argument_list|,
operator|(
operator|(
name|double
operator|)
name|cache
operator|->
name|sh
operator|->
name|size
operator|*
name|cache
operator|->
name|bsize
operator|)
operator|/
operator|(
literal|1024
operator|*
literal|1024
operator|)
argument_list|,
name|cache
operator|->
name|bsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_manager_sleep (ngx_http_file_cache_t * cache)
name|ngx_http_file_cache_manager_sleep
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|)
block|{
name|ngx_msec_t
name|elapsed
decl_stmt|;
if|if
condition|(
name|cache
operator|->
name|files
operator|++
operator|>
literal|100
condition|)
block|{
name|ngx_time_update
argument_list|()
expr_stmt|;
name|elapsed
operator|=
name|ngx_abs
argument_list|(
operator|(
name|ngx_msec_int_t
operator|)
operator|(
name|ngx_current_msec
operator|-
name|cache
operator|->
name|last
operator|)
argument_list|)
expr_stmt|;
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache manager time: %M"
argument_list|,
name|elapsed
argument_list|)
expr_stmt|;
if|if
condition|(
name|elapsed
operator|>
literal|200
condition|)
block|{
comment|/*              * if processing 100 files takes more than 200ms,              * it seems that many operations require disk i/o,              * therefore sleep 200ms              */
name|ngx_msleep
argument_list|(
literal|200
argument_list|)
expr_stmt|;
name|ngx_time_update
argument_list|()
expr_stmt|;
block|}
name|cache
operator|->
name|last
operator|=
name|ngx_current_msec
expr_stmt|;
name|cache
operator|->
name|files
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
name|ngx_quit
operator|||
name|ngx_terminate
operator|)
condition|?
name|NGX_ABORT
else|:
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_noop (ngx_tree_ctx_t * ctx,ngx_str_t * path)
name|ngx_http_file_cache_noop
parameter_list|(
name|ngx_tree_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_str_t
modifier|*
name|path
parameter_list|)
block|{
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_manage_file (ngx_tree_ctx_t * ctx,ngx_str_t * path)
name|ngx_http_file_cache_manage_file
parameter_list|(
name|ngx_tree_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_str_t
modifier|*
name|path
parameter_list|)
block|{
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|cache
operator|=
name|ctx
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|ngx_http_file_cache_add_file
argument_list|(
name|ctx
argument_list|,
name|path
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
operator|(
name|void
operator|)
name|ngx_http_file_cache_delete_file
argument_list|(
name|ctx
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
return|return
name|ngx_http_file_cache_manager_sleep
argument_list|(
name|cache
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_add_file (ngx_tree_ctx_t * ctx,ngx_str_t * name)
name|ngx_http_file_cache_add_file
parameter_list|(
name|ngx_tree_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_str_t
modifier|*
name|name
parameter_list|)
block|{
name|u_char
modifier|*
name|p
decl_stmt|;
name|ngx_fd_t
name|fd
decl_stmt|;
name|ngx_int_t
name|n
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_file_info_t
name|fi
decl_stmt|;
name|ngx_http_cache_t
name|c
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|ngx_http_file_cache_header_t
name|h
decl_stmt|;
if|if
condition|(
name|name
operator|->
name|len
operator|<
literal|2
operator|*
name|NGX_HTTP_CACHE_KEY_LEN
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|c
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_cache_t
argument_list|)
argument_list|)
expr_stmt|;
name|fd
operator|=
name|ngx_open_file
argument_list|(
name|name
operator|->
name|data
argument_list|,
name|NGX_FILE_RDONLY
argument_list|,
name|NGX_FILE_OPEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|NGX_INVALID_FILE
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_open_file_n
literal|" \"%s\" failed"
argument_list|,
name|name
operator|->
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|c
operator|.
name|file
operator|.
name|fd
operator|=
name|fd
expr_stmt|;
name|c
operator|.
name|file
operator|.
name|name
operator|=
operator|*
name|name
expr_stmt|;
name|c
operator|.
name|file
operator|.
name|log
operator|=
name|ctx
operator|->
name|log
expr_stmt|;
name|n
operator|=
name|ngx_read_file
argument_list|(
operator|&
name|c
operator|.
name|file
argument_list|,
operator|(
name|u_char
operator|*
operator|)
operator|&
name|h
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_header_t
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
operator|(
name|size_t
operator|)
name|n
operator|<
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_header_t
argument_list|)
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"cache file \"%s\" is too small"
argument_list|,
name|name
operator|->
name|data
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|ngx_fd_info
argument_list|(
name|fd
argument_list|,
operator|&
name|fi
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_fd_info_n
literal|" \"%s\" failed"
argument_list|,
name|name
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c
operator|.
name|uniq
operator|=
name|ngx_file_uniq
argument_list|(
operator|&
name|fi
argument_list|)
expr_stmt|;
name|c
operator|.
name|valid_sec
operator|=
name|h
operator|.
name|valid_sec
expr_stmt|;
name|c
operator|.
name|valid_msec
operator|=
name|h
operator|.
name|valid_msec
expr_stmt|;
name|c
operator|.
name|body_start
operator|=
name|h
operator|.
name|body_start
expr_stmt|;
name|c
operator|.
name|length
operator|=
name|ngx_file_size
argument_list|(
operator|&
name|fi
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ngx_close_file
argument_list|(
name|fd
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_close_file_n
literal|" \"%s\" failed"
argument_list|,
name|name
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|.
name|body_start
operator|==
literal|0
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|p
operator|=
operator|&
name|name
operator|->
name|data
index|[
name|name
operator|->
name|len
operator|-
literal|2
operator|*
name|NGX_HTTP_CACHE_KEY_LEN
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NGX_HTTP_CACHE_KEY_LEN
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|ngx_hextoi
argument_list|(
name|p
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_ERROR
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
name|p
operator|+=
literal|2
expr_stmt|;
name|c
operator|.
name|key
index|[
name|i
index|]
operator|=
operator|(
name|u_char
operator|)
name|n
expr_stmt|;
block|}
name|cache
operator|=
name|ctx
operator|->
name|data
expr_stmt|;
return|return
name|ngx_http_file_cache_add
argument_list|(
name|cache
argument_list|,
operator|&
name|c
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_add (ngx_http_file_cache_t * cache,ngx_http_cache_t * c)
name|ngx_http_file_cache_add
parameter_list|(
name|ngx_http_file_cache_t
modifier|*
name|cache
parameter_list|,
name|ngx_http_cache_t
modifier|*
name|c
parameter_list|)
block|{
name|ngx_http_file_cache_node_t
modifier|*
name|fcn
decl_stmt|;
name|ngx_shmtx_lock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|fcn
operator|=
name|ngx_http_file_cache_lookup
argument_list|(
name|cache
argument_list|,
name|c
operator|->
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcn
operator|==
name|NULL
condition|)
block|{
name|fcn
operator|=
name|ngx_slab_alloc_locked
argument_list|(
name|cache
operator|->
name|shpool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_node_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fcn
operator|==
name|NULL
condition|)
block|{
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
block|}
name|ngx_memcpy
argument_list|(
operator|(
name|u_char
operator|*
operator|)
operator|&
name|fcn
operator|->
name|node
operator|.
name|key
argument_list|,
name|c
operator|->
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_memcpy
argument_list|(
name|fcn
operator|->
name|key
argument_list|,
operator|&
name|c
operator|->
name|key
index|[
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
index|]
argument_list|,
name|NGX_HTTP_CACHE_KEY_LEN
operator|-
sizeof|sizeof
argument_list|(
name|ngx_rbtree_key_t
argument_list|)
argument_list|)
expr_stmt|;
name|ngx_rbtree_insert
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|rbtree
argument_list|,
operator|&
name|fcn
operator|->
name|node
argument_list|)
expr_stmt|;
name|fcn
operator|->
name|uses
operator|=
literal|1
expr_stmt|;
name|fcn
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|fcn
operator|->
name|valid_msec
operator|=
name|c
operator|->
name|valid_msec
expr_stmt|;
name|fcn
operator|->
name|error
operator|=
literal|0
expr_stmt|;
name|fcn
operator|->
name|exists
operator|=
literal|1
expr_stmt|;
name|fcn
operator|->
name|uniq
operator|=
name|c
operator|->
name|uniq
expr_stmt|;
name|fcn
operator|->
name|valid_sec
operator|=
name|c
operator|->
name|valid_sec
expr_stmt|;
name|fcn
operator|->
name|body_start
operator|=
name|c
operator|->
name|body_start
expr_stmt|;
name|fcn
operator|->
name|length
operator|=
name|c
operator|->
name|length
expr_stmt|;
name|cache
operator|->
name|sh
operator|->
name|size
operator|+=
operator|(
name|c
operator|->
name|length
operator|+
name|cache
operator|->
name|bsize
operator|-
literal|1
operator|)
operator|/
name|cache
operator|->
name|bsize
expr_stmt|;
block|}
else|else
block|{
name|ngx_queue_remove
argument_list|(
operator|&
name|fcn
operator|->
name|queue
argument_list|)
expr_stmt|;
block|}
name|fcn
operator|->
name|expire
operator|=
name|ngx_time
argument_list|()
operator|+
name|cache
operator|->
name|inactive
expr_stmt|;
name|ngx_queue_insert_head
argument_list|(
operator|&
name|cache
operator|->
name|sh
operator|->
name|queue
argument_list|,
operator|&
name|fcn
operator|->
name|queue
argument_list|)
expr_stmt|;
name|ngx_shmtx_unlock
argument_list|(
operator|&
name|cache
operator|->
name|shpool
operator|->
name|mutex
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|ngx_int_t
DECL|function|ngx_http_file_cache_delete_file (ngx_tree_ctx_t * ctx,ngx_str_t * path)
name|ngx_http_file_cache_delete_file
parameter_list|(
name|ngx_tree_ctx_t
modifier|*
name|ctx
parameter_list|,
name|ngx_str_t
modifier|*
name|path
parameter_list|)
block|{
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_HTTP
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"http file cache delete: \"%s\""
argument_list|,
name|path
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_delete_file
argument_list|(
name|path
operator|->
name|data
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|ctx
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_delete_file_n
literal|" \"%s\" failed"
argument_list|,
name|path
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|time_t
DECL|function|ngx_http_file_cache_valid (ngx_array_t * cache_valid,ngx_uint_t status)
name|ngx_http_file_cache_valid
parameter_list|(
name|ngx_array_t
modifier|*
name|cache_valid
parameter_list|,
name|ngx_uint_t
name|status
parameter_list|)
block|{
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_cache_valid_t
modifier|*
name|valid
decl_stmt|;
if|if
condition|(
name|cache_valid
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|valid
operator|=
name|cache_valid
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cache_valid
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|valid
index|[
name|i
index|]
operator|.
name|status
operator|==
literal|0
condition|)
block|{
return|return
name|valid
index|[
name|i
index|]
operator|.
name|valid
return|;
block|}
if|if
condition|(
name|valid
index|[
name|i
index|]
operator|.
name|status
operator|==
name|status
condition|)
block|{
return|return
name|valid
index|[
name|i
index|]
operator|.
name|valid
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|char
modifier|*
DECL|function|ngx_http_file_cache_set_slot (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_file_cache_set_slot
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|off_t
name|max_size
decl_stmt|;
name|u_char
modifier|*
name|last
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|time_t
name|inactive
decl_stmt|;
name|ssize_t
name|size
decl_stmt|;
name|ngx_str_t
name|s
decl_stmt|,
name|name
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|;
name|ngx_http_file_cache_t
modifier|*
name|cache
decl_stmt|;
name|cache
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_file_cache_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|cache
operator|->
name|path
operator|=
name|ngx_pcalloc
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_path_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|path
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|inactive
operator|=
literal|600
expr_stmt|;
name|name
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|size
operator|=
literal|0
expr_stmt|;
name|max_size
operator|=
name|NGX_MAX_OFF_T_VALUE
expr_stmt|;
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|cache
operator|->
name|path
operator|->
name|name
operator|=
name|value
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|path
operator|->
name|name
operator|.
name|data
index|[
name|cache
operator|->
name|path
operator|->
name|name
operator|.
name|len
operator|-
literal|1
index|]
operator|==
literal|'/'
condition|)
block|{
name|cache
operator|->
name|path
operator|->
name|name
operator|.
name|len
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|ngx_conf_full_name
argument_list|(
name|cf
operator|->
name|cycle
argument_list|,
operator|&
name|cache
operator|->
name|path
operator|->
name|name
argument_list|,
literal|0
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|cf
operator|->
name|args
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"levels="
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|=
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|7
expr_stmt|;
name|last
operator|=
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
name|value
index|[
name|i
index|]
operator|.
name|len
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|3
operator|&&
name|p
operator|<
name|last
condition|;
name|n
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|>
literal|'0'
operator|&&
operator|*
name|p
operator|<
literal|'3'
condition|)
block|{
name|cache
operator|->
name|path
operator|->
name|level
index|[
name|n
index|]
operator|=
operator|*
name|p
operator|++
operator|-
literal|'0'
expr_stmt|;
name|cache
operator|->
name|path
operator|->
name|len
operator|+=
name|cache
operator|->
name|path
operator|->
name|level
index|[
name|n
index|]
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|last
condition|)
block|{
break|break;
block|}
if|if
condition|(
operator|*
name|p
operator|++
operator|==
literal|':'
operator|&&
name|n
operator|<
literal|2
operator|&&
name|p
operator|!=
name|last
condition|)
block|{
continue|continue;
block|}
goto|goto
name|invalid_levels
goto|;
block|}
goto|goto
name|invalid_levels
goto|;
block|}
if|if
condition|(
name|cache
operator|->
name|path
operator|->
name|len
operator|<
literal|10
operator|+
literal|3
condition|)
block|{
continue|continue;
block|}
name|invalid_levels
label|:
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid \"levels\" \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"keys_zone="
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
name|name
operator|.
name|data
operator|=
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|10
expr_stmt|;
name|p
operator|=
operator|(
name|u_char
operator|*
operator|)
name|ngx_strchr
argument_list|(
name|name
operator|.
name|data
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|name
operator|.
name|len
operator|=
name|p
operator|-
name|name
operator|.
name|data
expr_stmt|;
name|p
operator|++
expr_stmt|;
name|s
operator|.
name|len
operator|=
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
name|p
expr_stmt|;
name|s
operator|.
name|data
operator|=
name|p
expr_stmt|;
name|size
operator|=
name|ngx_parse_size
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|>
literal|8191
condition|)
block|{
continue|continue;
block|}
block|}
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid keys zone size \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"inactive="
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|.
name|len
operator|=
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|9
expr_stmt|;
name|s
operator|.
name|data
operator|=
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|9
expr_stmt|;
name|inactive
operator|=
name|ngx_parse_time
argument_list|(
operator|&
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|inactive
operator|<
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid inactive value \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_strncmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"max_size="
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|s
operator|.
name|len
operator|=
name|value
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|9
expr_stmt|;
name|s
operator|.
name|data
operator|=
name|value
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|9
expr_stmt|;
name|max_size
operator|=
name|ngx_parse_offset
argument_list|(
operator|&
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_size
operator|<
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid max_size value \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
continue|continue;
block|}
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid parameter \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|name
operator|.
name|len
operator|==
literal|0
operator|||
name|size
operator|==
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"\"%V\" must have \"keys_zone\" parameter"
argument_list|,
operator|&
name|cmd
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|cache
operator|->
name|path
operator|->
name|manager
operator|=
name|ngx_http_file_cache_manager
expr_stmt|;
name|cache
operator|->
name|path
operator|->
name|loader
operator|=
name|ngx_http_file_cache_loader
expr_stmt|;
name|cache
operator|->
name|path
operator|->
name|data
operator|=
name|cache
expr_stmt|;
if|if
condition|(
name|ngx_add_path
argument_list|(
name|cf
argument_list|,
operator|&
name|cache
operator|->
name|path
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|cache
operator|->
name|shm_zone
operator|=
name|ngx_shared_memory_add
argument_list|(
name|cf
argument_list|,
operator|&
name|name
argument_list|,
name|size
argument_list|,
name|cmd
operator|->
name|post
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|shm_zone
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|cache
operator|->
name|shm_zone
operator|->
name|data
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"duplicate zone \"%V\""
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|cache
operator|->
name|shm_zone
operator|->
name|init
operator|=
name|ngx_http_file_cache_init
expr_stmt|;
name|cache
operator|->
name|shm_zone
operator|->
name|data
operator|=
name|cache
expr_stmt|;
name|cache
operator|->
name|inactive
operator|=
name|inactive
expr_stmt|;
name|cache
operator|->
name|max_size
operator|=
name|max_size
expr_stmt|;
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
name|char
modifier|*
DECL|function|ngx_http_file_cache_valid_set_slot (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_file_cache_valid_set_slot
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|conf
decl_stmt|;
name|time_t
name|valid
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|,
name|n
decl_stmt|,
name|status
decl_stmt|;
name|ngx_array_t
modifier|*
modifier|*
name|a
decl_stmt|;
name|ngx_http_cache_valid_t
modifier|*
name|v
decl_stmt|;
specifier|static
name|ngx_uint_t
name|statuses
index|[]
init|=
block|{
literal|200
block|,
literal|301
block|,
literal|302
block|}
decl_stmt|;
name|a
operator|=
operator|(
name|ngx_array_t
operator|*
operator|*
operator|)
operator|(
name|p
operator|+
name|cmd
operator|->
name|offset
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|a
operator|==
name|NGX_CONF_UNSET_PTR
condition|)
block|{
operator|*
name|a
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_cache_valid_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|a
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
name|n
operator|=
name|cf
operator|->
name|args
operator|->
name|nelts
operator|-
literal|1
expr_stmt|;
name|valid
operator|=
name|ngx_parse_time
argument_list|(
operator|&
name|value
index|[
name|n
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|valid
operator|<
literal|0
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid time value \"%V\""
argument_list|,
operator|&
name|value
index|[
name|n
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
if|if
condition|(
name|n
operator|==
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|*
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|v
operator|->
name|status
operator|=
name|statuses
index|[
name|i
index|]
expr_stmt|;
name|v
operator|->
name|valid
operator|=
name|valid
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_strcmp
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
literal|"any"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|status
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|ngx_atoi
argument_list|(
name|value
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|value
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<
literal|100
condition|)
block|{
name|ngx_conf_log_error
argument_list|(
name|NGX_LOG_EMERG
argument_list|,
name|cf
argument_list|,
literal|0
argument_list|,
literal|"invalid status \"%V\""
argument_list|,
operator|&
name|value
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|v
operator|=
name|ngx_array_push
argument_list|(
operator|*
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|v
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|v
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|v
operator|->
name|valid
operator|=
name|valid
expr_stmt|;
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

begin_function
name|ngx_int_t
DECL|function|ngx_http_cache (ngx_http_request_t * r,ngx_array_t * no_cache)
name|ngx_http_cache
parameter_list|(
name|ngx_http_request_t
modifier|*
name|r
parameter_list|,
name|ngx_array_t
modifier|*
name|no_cache
parameter_list|)
block|{
name|ngx_str_t
name|val
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_http_complex_value_t
modifier|*
name|cv
decl_stmt|;
name|cv
operator|=
name|no_cache
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|no_cache
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_http_complex_value
argument_list|(
name|r
argument_list|,
operator|&
name|cv
index|[
name|i
index|]
argument_list|,
operator|&
name|val
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_ERROR
return|;
block|}
if|if
condition|(
name|val
operator|.
name|len
operator|&&
name|val
operator|.
name|data
index|[
literal|0
index|]
operator|!=
literal|'0'
condition|)
block|{
return|return
name|NGX_DECLINED
return|;
block|}
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
name|char
modifier|*
DECL|function|ngx_http_no_cache_set_slot (ngx_conf_t * cf,ngx_command_t * cmd,void * conf)
name|ngx_http_no_cache_set_slot
parameter_list|(
name|ngx_conf_t
modifier|*
name|cf
parameter_list|,
name|ngx_command_t
modifier|*
name|cmd
parameter_list|,
name|void
modifier|*
name|conf
parameter_list|)
block|{
name|char
modifier|*
name|p
init|=
name|conf
decl_stmt|;
name|ngx_str_t
modifier|*
name|value
decl_stmt|;
name|ngx_uint_t
name|i
decl_stmt|;
name|ngx_array_t
modifier|*
modifier|*
name|a
decl_stmt|;
name|ngx_http_complex_value_t
modifier|*
name|cv
decl_stmt|;
name|ngx_http_compile_complex_value_t
name|ccv
decl_stmt|;
name|a
operator|=
operator|(
name|ngx_array_t
operator|*
operator|*
operator|)
operator|(
name|p
operator|+
name|cmd
operator|->
name|offset
operator|)
expr_stmt|;
if|if
condition|(
operator|*
name|a
operator|==
name|NGX_CONF_UNSET_PTR
condition|)
block|{
operator|*
name|a
operator|=
name|ngx_array_create
argument_list|(
name|cf
operator|->
name|pool
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_complex_value_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|a
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
name|value
operator|=
name|cf
operator|->
name|args
operator|->
name|elts
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|cf
operator|->
name|args
operator|->
name|nelts
condition|;
name|i
operator|++
control|)
block|{
name|cv
operator|=
name|ngx_array_push
argument_list|(
operator|*
name|a
argument_list|)
expr_stmt|;
if|if
condition|(
name|cv
operator|==
name|NULL
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
name|ngx_memzero
argument_list|(
operator|&
name|ccv
argument_list|,
sizeof|sizeof
argument_list|(
name|ngx_http_compile_complex_value_t
argument_list|)
argument_list|)
expr_stmt|;
name|ccv
operator|.
name|cf
operator|=
name|cf
expr_stmt|;
name|ccv
operator|.
name|value
operator|=
operator|&
name|value
index|[
name|i
index|]
expr_stmt|;
name|ccv
operator|.
name|complex_value
operator|=
name|cv
expr_stmt|;
if|if
condition|(
name|ngx_http_compile_complex_value
argument_list|(
operator|&
name|ccv
argument_list|)
operator|!=
name|NGX_OK
condition|)
block|{
return|return
name|NGX_CONF_ERROR
return|;
block|}
block|}
return|return
name|NGX_CONF_OK
return|;
block|}
end_function

end_unit

