begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Igor Sysoev  */
end_comment

begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_event.h>
end_include

begin_include
include|#
directive|include
file|<ngx_mysql.h>
end_include

begin_comment
comment|/* the library supports the subset of the MySQL 4.1+ protocol (version 10) */
end_comment

begin_function
name|ngx_int_t
DECL|function|ngx_mysql_connect (ngx_mysql_t * m)
name|ngx_mysql_connect
parameter_list|(
name|ngx_mysql_t
modifier|*
name|m
parameter_list|)
block|{
name|ngx_int_t
name|rc
decl_stmt|;
if|#
directive|if
literal|0
block_content|if (cached) {         return NGX_OK;     }
endif|#
directive|endif
name|m
operator|->
name|peer
operator|.
name|log
operator|->
name|action
operator|=
literal|"connecting to mysql server"
expr_stmt|;
name|rc
operator|=
name|ngx_event_connect_peer
argument_list|(
operator|&
name|m
operator|->
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
operator|||
name|rc
operator|==
name|NGX_BUSY
operator|||
name|rc
operator|==
name|NGX_DECLINED
condition|)
block|{
return|return
name|rc
return|;
block|}
name|m
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
operator|->
name|handler
operator|=
name|ngx_mysql_read_server_greeting
expr_stmt|;
name|m
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
operator|->
name|handler
operator|=
name|ngx_mysql_emtpy_handler
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|m
operator|->
name|peer
operator|.
name|connection
operator|->
name|read
argument_list|,
comment|/* STUB */
literal|5000
argument_list|)
expr_stmt|;
name|ngx_add_timer
argument_list|(
name|m
operator|->
name|peer
operator|.
name|connection
operator|->
name|write
argument_list|,
comment|/* STUB */
literal|5000
argument_list|)
expr_stmt|;
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
DECL|function|ngx_mysql_read_server_greeting (ngx_event_t * rev)
name|ngx_mysql_read_server_greeting
parameter_list|(
name|ngx_event_t
modifier|*
name|rev
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|u_char
modifier|*
name|p
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|ngx_mysql_t
modifier|*
name|m
decl_stmt|;
name|ngx_connection_t
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|rev
operator|->
name|data
expr_stmt|;
name|m
operator|=
name|c
operator|->
name|data
expr_stmt|;
if|if
condition|(
name|rev
operator|->
name|timedout
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|rev
operator|->
name|log
argument_list|,
name|NGX_ETIMEDOUT
argument_list|,
literal|"mysql server %V timed out"
argument_list|,
operator|&
name|ctx
operator|->
name|peer
operator|.
name|peers
operator|->
name|peer
index|[
literal|0
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|ngx_mysql_close
argument_list|(
name|m
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|m
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
name|m
operator|->
name|peer
operator|.
name|log
operator|->
name|action
operator|=
literal|"reading to mysql server greeting"
expr_stmt|;
name|m
operator|->
name|buf
operator|=
name|ngx_create_temp
argument_list|(
name|m
operator|->
name|pool
argument_list|,
comment|/* STUB */
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|buf
operator|==
name|NULL
condition|)
block|{
name|ngx_mysql_close
argument_list|(
name|m
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|n
operator|=
name|ngx_recv
argument_list|(
name|m
operator|->
name|peer
operator|.
name|connection
argument_list|,
name|m
operator|->
name|buf
operator|->
name|pos
argument_list|,
comment|/* STUB */
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NGX_AGAIN
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|n
operator|<
literal|5
condition|)
block|{
name|ngx_mysql_close
argument_list|(
name|m
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|=
name|m
operator|->
name|buf
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|ngx_m24toh
argument_list|(
name|p
argument_list|)
operator|>
name|n
operator|-
literal|4
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mysql server %V sent incomplete greeting packet"
argument_list|,
operator|&
name|ctx
operator|->
name|peer
operator|.
name|peers
operator|->
name|peer
index|[
literal|0
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|ngx_mysql_close
argument_list|(
name|m
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p
index|[
literal|4
index|]
condition|)
operator|<
literal|10
block_content|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ERR
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mysql server %V sent unsupported protocol version %ud"
argument_list|,
operator|&
name|ctx
operator|->
name|peer
operator|.
name|peers
operator|->
name|peer
index|[
literal|0
index|]
operator|.
name|name
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|ngx_mysql_close
argument_list|(
name|m
argument_list|,
name|NGX_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
block|len = ngx_strlen(&p[5]
end_function

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_expr_stmt
name|t
operator|=
name|p
operator|+
literal|5
operator|+
name|len
operator|+
literal|1
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|capacity
operator|=
name|ngx_m16toh
argument_list|(
operator|(
operator|&
name|t
index|[
literal|4
operator|+
literal|9
index|]
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ngx_log_debug8
argument_list|(
name|NGX_LOG_DEBUG_MYSQL
argument_list|,
name|rev
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"mysql version: %ud, \"%s\", thread: %ud, salt: \"%s\", "
argument_list|,
literal|"capacity: %Xd, charset: %ud, status: %ud, salt rest \"%s\""
argument_list|,
name|p
index|[
literal|4
index|]
argument_list|,
operator|&
name|p
index|[
literal|5
index|]
argument_list|,
name|ngx_m32toh
argument_list|(
name|t
argument_list|)
argument_list|,
operator|&
name|t
index|[
literal|4
index|]
argument_list|,
name|capacity
argument_list|,
name|t
index|[
literal|4
operator|+
literal|9
operator|+
literal|2
index|]
argument_list|,
name|ngx_m16toh
argument_list|(
operator|(
operator|&
name|t
index|[
literal|4
operator|+
literal|9
operator|+
literal|2
operator|+
literal|1
index|]
operator|)
argument_list|)
argument_list|,
name|t
index|[
literal|4
operator|+
literal|9
operator|+
literal|2
operator|+
literal|1
operator|+
literal|2
operator|+
literal|13
index|]
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|capacity
operator|&=
name|NGX_MYSQL_LONG_PASSWORD
operator||
name|NGX_MYSQL_CONNECT_WITH_DB
operator||
name|NGX_MYSQL_PROTOCOL_41
expr_stmt|;
end_expr_stmt

begin_function
unit|}   static
name|void
DECL|function|ngx_mysql_close (ngx_mysql_t * m,ngx_int_t rc)
name|ngx_mysql_close
parameter_list|(
name|ngx_mysql_t
modifier|*
name|m
parameter_list|,
name|ngx_int_t
name|rc
parameter_list|)
block|{
if|if
condition|(
name|rc
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_close_connection
argument_list|(
name|m
operator|->
name|peer
operator|.
name|connection
argument_list|)
expr_stmt|;
block|}
name|m
operator|->
name|state
operator|=
name|rc
expr_stmt|;
name|m
operator|->
name|handler
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

end_unit

