begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_function
DECL|function|ngx_posix_master_cycle (ngx_cycle_t * cycle)
name|void
name|ngx_posix_master_cycle
parameter_list|(
name|ngx_cycle_t
modifier|*
name|cycle
parameter_list|)
block|{
specifier|static
name|ngx_int_t
name|sent
decl_stmt|;
specifier|static
name|ngx_msec_t
name|delay
init|=
literal|125
decl_stmt|;
if|if
condition|(
name|ngx_process
operator|==
name|NGX_PROCESS_MASTER
condition|)
block|{
if|if
condition|(
name|sent
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"sent signal cycle"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sigprocmask
argument_list|(
name|SIG_UNBLOCK
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"sigprocmask() failed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/*              * there is very big chance that the pending signals              * would be delivered right on the sigprocmask() return              */
if|if
condition|(
operator|!
name|ngx_signal
condition|)
block|{
if|if
condition|(
name|delay
operator|<
literal|15000
condition|)
block|{
name|delay
operator|*=
literal|2
expr_stmt|;
block|}
name|ngx_log_debug1
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"msleep %d"
argument_list|,
name|delay
argument_list|)
expr_stmt|;
name|ngx_msleep
argument_list|(
name|delay
argument_list|)
expr_stmt|;
name|ngx_gettimeofday
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|ngx_time_update
argument_list|(
name|tv
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"wake up"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sigprocmask
argument_list|(
name|SIG_BLOCK
argument_list|,
operator|&
name|set
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"sigprocmask() failed"
argument_list|)
expr_stmt|;
block|}
name|ngx_signal
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"sigsuspend"
argument_list|)
expr_stmt|;
name|sigsuspend
argument_list|(
operator|&
name|wset
argument_list|)
expr_stmt|;
name|ngx_gettimeofday
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|ngx_time_update
argument_list|(
name|tv
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"wake up"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* NGX_PROCESS_SINGLE */
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"worker cycle"
argument_list|)
expr_stmt|;
name|ngx_process_events
argument_list|(
name|cycle
operator|->
name|log
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ngx_reap
condition|)
block|{
name|ngx_log_debug0
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"reap childs"
argument_list|)
expr_stmt|;
name|live
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ngx_last_process
condition|;
name|i
operator|++
control|)
block|{
name|ngx_log_debug6
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"child: "
name|PID_T_FMT
literal|" s:%d e:%d t:%d d:%d r:%d"
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|pid
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|signal
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|exiting
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|exited
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|detached
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|respawn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_processes
index|[
name|i
index|]
operator|.
name|exited
condition|)
block|{
if|if
condition|(
name|ngx_processes
index|[
name|i
index|]
operator|.
name|respawn
operator|&&
operator|!
name|ngx_processes
index|[
name|i
index|]
operator|.
name|exiting
operator|&&
operator|!
name|ngx_terminate
operator|&&
operator|!
name|ngx_quit
condition|)
block|{
if|if
condition|(
name|ngx_spawn_process
argument_list|(
name|cycle
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|proc
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|i
argument_list|)
operator|==
name|NGX_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"can not respawn %s"
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ngx_processes
index|[
name|i
index|]
operator|.
name|pid
operator|==
name|ngx_new_binary
condition|)
block|{
name|ngx_new_binary
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
operator|--
name|ngx_last_process
condition|)
block|{
name|ngx_processes
index|[
name|i
operator|--
index|]
operator|=
name|ngx_processes
index|[
name|ngx_last_process
index|]
expr_stmt|;
block|}
block|}
if|else if
condition|(
operator|!
name|ngx_processes
index|[
name|i
index|]
operator|.
name|detached
operator|&&
operator|(
name|ngx_terminate
operator|||
name|ngx_quit
operator|)
condition|)
block|{
name|live
operator|=
literal|1
expr_stmt|;
block|}
if|else if
condition|(
name|ngx_processes
index|[
name|i
index|]
operator|.
name|exiting
condition|)
block|{
name|live
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|live
condition|)
block|{
if|if
condition|(
name|ngx_terminate
operator|||
name|ngx_quit
condition|)
block|{
if|if
condition|(
name|ngx_inherited
operator|&&
name|getppid
argument_list|()
operator|>
literal|1
condition|)
block|{
name|name
operator|=
name|ctx
operator|->
name|pid
operator|.
name|name
operator|.
name|data
expr_stmt|;
block|}
else|else
block|{
name|name
operator|=
name|ctx
operator|->
name|name
expr_stmt|;
block|}
if|if
condition|(
name|ngx_delete_file
argument_list|(
name|name
argument_list|)
operator|==
name|NGX_FILE_ERROR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
name|ngx_delete_file_n
literal|" \"%s\" failed"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"exit"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sent
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ngx_terminate
condition|)
block|{
if|if
condition|(
name|delay
operator|>
literal|10000
condition|)
block|{
name|signo
operator|=
name|SIGKILL
expr_stmt|;
block|}
else|else
block|{
name|signo
operator|=
name|ngx_signal_value
argument_list|(
name|NGX_TERMINATE_SIGNAL
argument_list|)
expr_stmt|;
block|}
block|}
if|else if
condition|(
name|ngx_quit
condition|)
block|{
name|signo
operator|=
name|ngx_signal_value
argument_list|(
name|NGX_SHUTDOWN_SIGNAL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ngx_noaccept
condition|)
block|{
name|signo
operator|=
name|ngx_signal_value
argument_list|(
name|NGX_SHUTDOWN_SIGNAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ngx_change_binary
condition|)
block|{
name|ngx_change_binary
operator|=
literal|0
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"changing binary"
argument_list|)
expr_stmt|;
name|ngx_new_binary
operator|=
name|ngx_exec_new_binary
argument_list|(
name|cycle
argument_list|,
name|ctx
operator|->
name|argv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ngx_reconfigure
condition|)
block|{
name|signo
operator|=
name|ngx_signal_value
argument_list|(
name|NGX_SHUTDOWN_SIGNAL
argument_list|)
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"reconfiguring"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ngx_reopen
condition|)
block|{
comment|/* STUB */
name|signo
operator|=
name|ngx_signal_value
argument_list|(
name|NGX_SHUTDOWN_SIGNAL
argument_list|)
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"reopening logs"
argument_list|)
expr_stmt|;
name|ngx_reopen_files
argument_list|(
name|cycle
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|signo
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ngx_last_process
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|ngx_processes
index|[
name|i
index|]
operator|.
name|detached
condition|)
block|{
name|ngx_processes
index|[
name|i
index|]
operator|.
name|signal
operator|=
name|signo
expr_stmt|;
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_EVENT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"signal "
name|PID_T_FMT
literal|" %d"
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|pid
argument_list|,
name|signo
argument_list|)
expr_stmt|;
block|}
block|}
name|delay
operator|=
literal|125
expr_stmt|;
name|signo
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ngx_last_process
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ngx_processes
index|[
name|i
index|]
operator|.
name|signal
operator|==
literal|0
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|ccf
operator|->
name|kqueue_signal
operator|!=
literal|1
condition|)
block|{
name|sent
operator|=
literal|1
expr_stmt|;
block|}
name|ngx_log_debug2
argument_list|(
name|NGX_LOG_DEBUG_CORE
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"kill ("
name|PID_T_FMT
literal|", %d)"
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|pid
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|signal
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill
argument_list|(
name|ngx_processes
index|[
name|i
index|]
operator|.
name|pid
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|signal
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|cycle
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"kill(%d, %d) failed"
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|pid
argument_list|,
name|ngx_processes
index|[
name|i
index|]
operator|.
name|signal
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ngx_processes
index|[
name|i
index|]
operator|.
name|signal
operator|!=
name|ngx_signal_value
argument_list|(
name|NGX_REOPEN_SIGNAL
argument_list|)
condition|)
block|{
name|ngx_processes
index|[
name|i
index|]
operator|.
name|exiting
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
end_function

end_unit

