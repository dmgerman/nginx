begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_include
include|#
directive|include
file|<ngx_freebsd_init.h>
end_include

begin_comment
comment|/*    sendfile() often sends 4K pages over ethernet in 3 packets: 2x1460 and 1176    or in 6 packets: 5x1460 and 892.  Besides although sendfile() allows    to pass the header and the trailer it never sends the header or the trailer    with the part of the file in one packet.  So we use TCP_NOPUSH (similar    to Linux's TCP_CORK) to postpone the sending - it not only sends the header    and the first part of the file in one packet but also sends 4K pages    in the full packets.     Until FreeBSD 4.5 the turning TCP_NOPUSH off does not not flush    the pending data that less than MSS and the data sent with 5 second delay.    So we use TCP_NOPUSH on FreeBSD 4.5+ only. */
end_comment

begin_function
DECL|function|ngx_freebsd_sendfile_chain (ngx_connection_t * c,ngx_chain_t * in)
name|ngx_chain_t
modifier|*
name|ngx_freebsd_sendfile_chain
parameter_list|(
name|ngx_connection_t
modifier|*
name|c
parameter_list|,
name|ngx_chain_t
modifier|*
name|in
parameter_list|)
block|{
name|int
name|rc
decl_stmt|,
name|eintr
decl_stmt|,
name|tcp_nopush
decl_stmt|;
name|char
modifier|*
name|prev
decl_stmt|;
name|size_t
name|hsize
decl_stmt|,
name|size
decl_stmt|;
name|off_t
name|sent
decl_stmt|;
name|struct
name|iovec
modifier|*
name|iov
decl_stmt|;
name|struct
name|sf_hdtr
name|hdtr
decl_stmt|;
name|ngx_err_t
name|err
decl_stmt|;
name|ngx_array_t
name|header
decl_stmt|,
name|trailer
decl_stmt|;
name|ngx_hunk_t
modifier|*
name|file
decl_stmt|;
name|ngx_chain_t
modifier|*
name|ce
decl_stmt|,
modifier|*
name|tail
decl_stmt|;
name|tcp_nopush
operator|=
literal|0
expr_stmt|;
do|do
block|{
name|ce
operator|=
name|in
expr_stmt|;
name|file
operator|=
name|NULL
expr_stmt|;
name|hsize
operator|=
literal|0
expr_stmt|;
name|eintr
operator|=
literal|0
expr_stmt|;
name|ngx_init_array
argument_list|(
name|header
argument_list|,
name|c
operator|->
name|pool
argument_list|,
literal|10
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iovec
argument_list|)
argument_list|,
name|NGX_CHAIN_ERROR
argument_list|)
expr_stmt|;
name|ngx_init_array
argument_list|(
name|trailer
argument_list|,
name|c
operator|->
name|pool
argument_list|,
literal|10
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iovec
argument_list|)
argument_list|,
name|NGX_CHAIN_ERROR
argument_list|)
expr_stmt|;
comment|/* create the header iovec */
if|if
condition|(
name|ngx_hunk_in_memory_only
argument_list|(
name|ce
operator|->
name|hunk
argument_list|)
condition|)
block|{
name|prev
operator|=
name|NULL
expr_stmt|;
name|iov
operator|=
name|NULL
expr_stmt|;
comment|/* create the iovec and coalesce the neighbouring chain entries */
while|while
condition|(
name|ce
operator|&&
name|ngx_hunk_in_memory_only
argument_list|(
name|ce
operator|->
name|hunk
argument_list|)
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|ce
operator|->
name|hunk
operator|->
name|pos
condition|)
block|{
name|iov
operator|->
name|iov_len
operator|+=
name|ce
operator|->
name|hunk
operator|->
name|last
operator|-
name|ce
operator|->
name|hunk
operator|->
name|pos
expr_stmt|;
name|prev
operator|=
name|ce
operator|->
name|hunk
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|ngx_test_null
argument_list|(
name|iov
argument_list|,
name|ngx_push_array
argument_list|(
operator|&
name|header
argument_list|)
argument_list|,
name|NGX_CHAIN_ERROR
argument_list|)
expr_stmt|;
name|iov
operator|->
name|iov_base
operator|=
name|ce
operator|->
name|hunk
operator|->
name|pos
expr_stmt|;
name|iov
operator|->
name|iov_len
operator|=
name|ce
operator|->
name|hunk
operator|->
name|last
operator|-
name|ce
operator|->
name|hunk
operator|->
name|pos
expr_stmt|;
name|prev
operator|=
name|ce
operator|->
name|hunk
operator|->
name|last
expr_stmt|;
block|}
name|hsize
operator|+=
name|ce
operator|->
name|hunk
operator|->
name|last
operator|-
name|ce
operator|->
name|hunk
operator|->
name|pos
expr_stmt|;
name|ce
operator|=
name|ce
operator|->
name|next
expr_stmt|;
block|}
block|}
comment|/* TODO: coalesce the neighbouring file hunks */
if|if
condition|(
name|ce
operator|&&
operator|(
name|ce
operator|->
name|hunk
operator|->
name|type
operator|&
name|NGX_HUNK_FILE
operator|)
condition|)
block|{
name|file
operator|=
name|ce
operator|->
name|hunk
expr_stmt|;
name|ce
operator|=
name|ce
operator|->
name|next
expr_stmt|;
block|}
comment|/* create the trailer iovec */
if|if
condition|(
name|ce
operator|&&
name|ngx_hunk_in_memory_only
argument_list|(
name|ce
operator|->
name|hunk
argument_list|)
condition|)
block|{
name|prev
operator|=
name|NULL
expr_stmt|;
name|iov
operator|=
name|NULL
expr_stmt|;
comment|/* create the iovec and coalesce the neighbouring chain entries */
while|while
condition|(
name|ce
operator|&&
name|ngx_hunk_in_memory_only
argument_list|(
name|ce
operator|->
name|hunk
argument_list|)
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|ce
operator|->
name|hunk
operator|->
name|pos
condition|)
block|{
name|iov
operator|->
name|iov_len
operator|+=
name|ce
operator|->
name|hunk
operator|->
name|last
operator|-
name|ce
operator|->
name|hunk
operator|->
name|pos
expr_stmt|;
name|prev
operator|=
name|ce
operator|->
name|hunk
operator|->
name|last
expr_stmt|;
block|}
else|else
block|{
name|ngx_test_null
argument_list|(
name|iov
argument_list|,
name|ngx_push_array
argument_list|(
operator|&
name|trailer
argument_list|)
argument_list|,
name|NGX_CHAIN_ERROR
argument_list|)
expr_stmt|;
name|iov
operator|->
name|iov_base
operator|=
name|ce
operator|->
name|hunk
operator|->
name|pos
expr_stmt|;
name|iov
operator|->
name|iov_len
operator|=
name|ce
operator|->
name|hunk
operator|->
name|last
operator|-
name|ce
operator|->
name|hunk
operator|->
name|pos
expr_stmt|;
name|prev
operator|=
name|ce
operator|->
name|hunk
operator|->
name|last
expr_stmt|;
block|}
name|ce
operator|=
name|ce
operator|->
name|next
expr_stmt|;
block|}
block|}
name|tail
operator|=
name|ce
expr_stmt|;
if|if
condition|(
name|file
condition|)
block|{
if|if
condition|(
operator|!
name|c
operator|->
name|tcp_nopush
operator|&&
name|ngx_freebsd_tcp_nopush_flush
condition|)
block|{
name|c
operator|->
name|tcp_nopush
operator|=
literal|1
expr_stmt|;
name|tcp_nopush
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_NOPUSH
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|tcp_nopush
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"setsockopt(TCP_NOPUSH) failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_CHAIN_ERROR
return|;
block|}
block|}
name|hdtr
operator|.
name|headers
operator|=
operator|(
expr|struct
name|iovec
operator|*
operator|)
name|header
operator|.
name|elts
expr_stmt|;
name|hdtr
operator|.
name|hdr_cnt
operator|=
name|header
operator|.
name|nelts
expr_stmt|;
name|hdtr
operator|.
name|trailers
operator|=
operator|(
expr|struct
name|iovec
operator|*
operator|)
name|trailer
operator|.
name|elts
expr_stmt|;
name|hdtr
operator|.
name|trl_cnt
operator|=
name|trailer
operator|.
name|nelts
expr_stmt|;
if|if
condition|(
name|ngx_freebsd_sendfile_nbytes_bug
operator|==
literal|0
condition|)
block|{
name|hsize
operator|=
literal|0
expr_stmt|;
block|}
name|rc
operator|=
name|sendfile
argument_list|(
name|file
operator|->
name|file
operator|->
name|fd
argument_list|,
name|c
operator|->
name|fd
argument_list|,
name|file
operator|->
name|file_pos
argument_list|,
operator|(
name|size_t
operator|)
operator|(
name|file
operator|->
name|file_last
operator|-
name|file
operator|->
name|file_pos
operator|)
operator|+
name|hsize
argument_list|,
operator|&
name|hdtr
argument_list|,
operator|&
name|sent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
name|err
operator|=
name|ngx_errno
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|NGX_EINTR
condition|)
block|{
name|eintr
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|err
operator|==
name|NGX_EAGAIN
operator|||
name|err
operator|==
name|NGX_EINTR
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"sendfile() sent only %qd bytes"
argument_list|,
name|sent
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"sendfile() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_CHAIN_ERROR
return|;
block|}
block|}
if|#
directive|if
operator|(
name|NGX_DEBUG_WRITE_CHAIN
operator|)
name|ngx_log_debug
argument_list|(
argument|c->log
argument_list|,
literal|"sendfile: %d, @%qd %qd:%d"
argument|_                           rc _ file->file_pos _ sent _                           (size_t) (file->file_last - file->file_pos) + hsize
argument_list|)
empty_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|rc
operator|=
name|writev
argument_list|(
name|c
operator|->
name|fd
argument_list|,
operator|(
expr|struct
name|iovec
operator|*
operator|)
name|header
operator|.
name|elts
argument_list|,
name|header
operator|.
name|nelts
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
operator|-
literal|1
condition|)
block|{
name|err
operator|=
name|ngx_errno
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|NGX_EAGAIN
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"writev() EAGAIN"
argument_list|)
expr_stmt|;
block|}
if|else if
condition|(
name|err
operator|==
name|NGX_EINTR
condition|)
block|{
name|eintr
operator|=
literal|1
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"writev() EINTR"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|err
argument_list|,
literal|"writev() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_CHAIN_ERROR
return|;
block|}
block|}
name|sent
operator|=
name|rc
operator|>
literal|0
condition|?
name|rc
else|:
literal|0
expr_stmt|;
if|#
directive|if
operator|(
name|NGX_DEBUG_WRITE_CHAIN
operator|)
name|ngx_log_debug
argument_list|(
argument|c->log
argument_list|,
literal|"writev: %qd"
argument|_ sent
argument_list|)
empty_stmt|;
endif|#
directive|endif
block|}
name|c
operator|->
name|sent
operator|+=
name|sent
expr_stmt|;
for|for
control|(
name|ce
operator|=
name|in
init|;
name|ce
operator|&&
name|sent
operator|>
literal|0
condition|;
name|ce
operator|=
name|ce
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ce
operator|->
name|hunk
operator|->
name|type
operator|&
name|NGX_HUNK_IN_MEMORY
condition|)
block|{
name|size
operator|=
name|ce
operator|->
name|hunk
operator|->
name|last
operator|-
name|ce
operator|->
name|hunk
operator|->
name|pos
expr_stmt|;
block|}
else|else
block|{
name|size
operator|=
name|ce
operator|->
name|hunk
operator|->
name|file_last
operator|-
name|ce
operator|->
name|hunk
operator|->
name|file_pos
expr_stmt|;
block|}
if|if
condition|(
name|sent
operator|>=
name|size
condition|)
block|{
name|sent
operator|-=
name|size
expr_stmt|;
if|if
condition|(
name|ce
operator|->
name|hunk
operator|->
name|type
operator|&
name|NGX_HUNK_IN_MEMORY
condition|)
block|{
name|ce
operator|->
name|hunk
operator|->
name|pos
operator|=
name|ce
operator|->
name|hunk
operator|->
name|last
expr_stmt|;
block|}
if|if
condition|(
name|ce
operator|->
name|hunk
operator|->
name|type
operator|&
name|NGX_HUNK_FILE
condition|)
block|{
name|ce
operator|->
name|hunk
operator|->
name|file_pos
operator|=
name|ce
operator|->
name|hunk
operator|->
name|file_last
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
name|ce
operator|->
name|hunk
operator|->
name|type
operator|&
name|NGX_HUNK_IN_MEMORY
condition|)
block|{
name|ce
operator|->
name|hunk
operator|->
name|pos
operator|+=
name|sent
expr_stmt|;
block|}
if|if
condition|(
name|ce
operator|->
name|hunk
operator|->
name|type
operator|&
name|NGX_HUNK_FILE
condition|)
block|{
name|ce
operator|->
name|hunk
operator|->
name|file_pos
operator|+=
name|sent
expr_stmt|;
block|}
break|break;
block|}
name|ngx_destroy_array
argument_list|(
operator|&
name|trailer
argument_list|)
expr_stmt|;
name|ngx_destroy_array
argument_list|(
operator|&
name|header
argument_list|)
expr_stmt|;
name|in
operator|=
name|ce
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|tail
operator|&&
name|tail
operator|==
name|ce
operator|)
operator|||
name|eintr
condition|)
do|;
comment|/* STUB: should be in app code, no need to clear TCP_NOPUSH              if the conneciton close()d or shutdown()ed */
if|if
condition|(
name|c
operator|->
name|tcp_nopush
condition|)
block|{
name|c
operator|->
name|tcp_nopush
operator|=
literal|0
expr_stmt|;
name|tcp_nopush
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|c
operator|->
name|fd
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|TCP_NOPUSH
argument_list|,
operator|(
specifier|const
name|void
operator|*
operator|)
operator|&
name|tcp_nopush
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_CRIT
argument_list|,
name|c
operator|->
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"setsockopt(!TCP_NOPUSH) failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_CHAIN_ERROR
return|;
block|}
block|}
return|return
name|ce
return|;
block|}
end_function

end_unit

