begin_unit|revision:1.0.0;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ngx_config.h>
end_include

begin_include
include|#
directive|include
file|<ngx_core.h>
end_include

begin_function
DECL|function|testone (ngx_log_t * log)
name|void
name|testone
parameter_list|(
name|ngx_log_t
modifier|*
name|log
parameter_list|)
block|{
name|ngx_log_debug
argument_list|(
name|log
argument_list|,
literal|"child process"
argument_list|)
expr_stmt|;
name|ngx_msleep
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|function|ngx_spawn_process (ngx_log_t * log)
name|int
name|ngx_spawn_process
parameter_list|(
name|ngx_log_t
modifier|*
name|log
parameter_list|)
block|{
name|pid_t
name|pid
decl_stmt|;
name|sigset_t
name|set
decl_stmt|,
name|oset
decl_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|set
argument_list|)
expr_stmt|;
name|sigaddset
argument_list|(
operator|&
name|set
argument_list|,
name|SIGCHLD
argument_list|)
expr_stmt|;
if|if
condition|(
name|sigprocmask
argument_list|(
name|SIG_BLOCK
argument_list|,
operator|&
name|set
argument_list|,
operator|&
name|oset
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"sigprocmask() failed"
argument_list|)
expr_stmt|;
block|}
name|pid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|pid
operator|==
operator|-
literal|1
operator|||
name|pid
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|sigprocmask
argument_list|(
name|SIG_SETMASK
argument_list|,
operator|&
name|oset
argument_list|,
operator|&
name|set
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"sigprocmask() failed"
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|pid
condition|)
block|{
case|case
operator|-
literal|1
case|:
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"fork() failed"
argument_list|)
expr_stmt|;
return|return
name|NGX_ERROR
return|;
case|case
literal|0
case|:
name|testone
argument_list|(
name|log
argument_list|)
expr_stmt|;
break|break;
default|default:
block|}
name|ngx_log_debug
argument_list|(
argument|log
argument_list|,
literal|"parent process, child: "
argument|PID_FMT _ pid
argument_list|)
empty_stmt|;
comment|/* book keeping */
if|if
condition|(
name|sigprocmask
argument_list|(
name|SIG_SETMASK
argument_list|,
operator|&
name|oset
argument_list|,
operator|&
name|set
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|log
argument_list|,
name|ngx_errno
argument_list|,
literal|"sigprocmask() failed"
argument_list|)
expr_stmt|;
block|}
return|return
name|NGX_OK
return|;
block|}
end_function

begin_function
DECL|function|ngx_sigchld_handler (int signo)
name|void
name|ngx_sigchld_handler
parameter_list|(
name|int
name|signo
parameter_list|)
block|{
name|int
name|status
decl_stmt|,
name|one
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|ngx_err_t
name|err
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|ngx_gettimeofday
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ngx_cached_time
operator|!=
name|tv
operator|.
name|tv_sec
condition|)
block|{
name|ngx_cached_time
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
name|ngx_time_update
argument_list|()
expr_stmt|;
block|}
name|one
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|pid
operator|=
name|waitpid
argument_list|(
operator|-
literal|1
argument_list|,
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|pid
operator|==
operator|-
literal|1
condition|)
block|{
name|err
operator|=
name|ngx_errno
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|NGX_EINTR
condition|)
block|{
continue|continue;
block|}
if|if
condition|(
name|err
operator|==
name|NGX_ECHILD
operator|&&
name|one
condition|)
block|{
return|return;
block|}
name|ngx_log_error
argument_list|(
name|NGX_LOG_ALERT
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
name|errno
argument_list|,
literal|"waitpid() failed"
argument_list|)
expr_stmt|;
return|return;
block|}
name|one
operator|=
literal|1
expr_stmt|;
name|ngx_log_error
argument_list|(
name|NGX_LOG_INFO
argument_list|,
name|ngx_cycle
operator|->
name|log
argument_list|,
literal|0
argument_list|,
literal|"process "
name|PID_FMT
literal|" exited with code %d"
argument_list|,
name|pid
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* TODO: restart handler */
if|#
directive|if
literal|0
block_content|ngx_msleep(2000);
endif|#
directive|endif
if|#
directive|if
literal|0
block_content|ngx_spawn_process(ngx_cycle->log);
endif|#
directive|endif
block|}
block|}
end_function

end_unit

